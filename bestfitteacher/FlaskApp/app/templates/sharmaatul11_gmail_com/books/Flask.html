<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Flask Web Development</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta name="generator" content="pdftohtml 0.36"/>
<meta name="author" content="Miguel Grinberg"/>
<meta name="date" content="2014-04-25T10:44:48+00:00"/>
<style type="text/css">
<!--
.xflip {
    -moz-transform: scaleX(-1);
    -webkit-transform: scaleX(-1);
    -o-transform: scaleX(-1);
    transform: scaleX(-1);
    filter: fliph;
}
.yflip {
    -moz-transform: scaleY(-1);
    -webkit-transform: scaleY(-1);
    -o-transform: scaleY(-1);
    transform: scaleY(-1);
    filter: flipv;
}
.xyflip {
    -moz-transform: scaleX(-1) scaleY(-1);
    -webkit-transform: scaleX(-1) scaleY(-1);
    -o-transform: scaleX(-1) scaleY(-1);
    transform: scaleX(-1) scaleY(-1);
    filter: fliph + flipv;
}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<!-- Page 1 -->
<a name="1"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page1-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask001.png" alt="background image"/>
</div>
<!-- Page 2 -->
<a name="2"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page2-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask002.png" alt="background image"/>
</div>
<!-- Page 3 -->
<a name="3"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft30{font-size:22px;font-family:Times;color:#231f20;}
	.ft31{font-size:45px;font-family:Times;color:#231f20;}
-->
</style>
<div id="page3-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask003.png" alt="background image"/>
<p style="position:absolute;top:520px;left:483px;white-space:nowrap" class="ft30"><i><b>Miguel Grinberg</b></i></p>
<p style="position:absolute;top:221px;left:269px;white-space:nowrap" class="ft31"><b>Flask Web Development</b></p>
</div>
<!-- Page 4 -->
<a name="4"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft42{font-size:13px;font-family:Times;color:#231f20;}
	.ft43{font-size:10px;font-family:Times;color:#231f20;}
	.ft44{font-size:10px;font-family:Times;color:#231f20;}
	.ft45{font-size:11px;font-family:Times;color:#231f20;}
	.ft46{font-size:13px;line-height:20px;font-family:Times;color:#231f20;}
	.ft47{font-size:10px;line-height:24px;font-family:Times;color:#231f20;}
	.ft48{font-size:10px;line-height:25px;font-family:Times;color:#231f20;}
	.ft49{font-size:11px;line-height:22px;font-family:Times;color:#231f20;}
-->
</style>
<div id="page4-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask004.png" alt="background image"/>
<p style="position:absolute;top:90px;left:108px;white-space:nowrap" class="ft47"><b>Flask Web Development<br/></b>by Miguel Grinberg<br/>Copyright © 2014 Miguel Grinberg. All rights reserved.<br/>Printed in the United States of America.<br/>Published by O’Reilly Media, Inc., 1005 Gravenstein Highway North, Sebastopol, CA 95472.<br/>O’Reilly books may be purchased for educational, business, or sales promotional use. Online editions are</p>
<p style="position:absolute;top:222px;left:108px;white-space:nowrap" class="ft43">also available for most titles (<a href="http://my.safaribooksonline.com/?portal=oreilly"><i>http://my.safaribooksonline.com</i></a>). For more information, contact our corporate/</p>
<p style="position:absolute;top:238px;left:108px;white-space:nowrap" class="ft48">institutional sales department: 800-998-9938 or&#160;<a href="mailto:corporate@oreilly.com"><i>corporate@oreilly.com</i>.<br/></a><b>Editors:&#160;</b>Meghan Blanchette and Rachel Roumeliotis</p>
<p style="position:absolute;top:279px;left:108px;white-space:nowrap" class="ft45"><b>Production Editor:&#160;</b>Nicole Shelby</p>
<p style="position:absolute;top:295px;left:108px;white-space:nowrap" class="ft45"><b>Copyeditor:&#160;</b>Nancy Kotary</p>
<p style="position:absolute;top:312px;left:108px;white-space:nowrap" class="ft45"><b>Proofreader:&#160;</b>Charles Roumeliotis</p>
<p style="position:absolute;top:263px;left:386px;white-space:nowrap" class="ft45"><b>Cover Designer:&#160;</b>Randy Comer</p>
<p style="position:absolute;top:279px;left:386px;white-space:nowrap" class="ft45"><b>Interior Designer:&#160;</b>David Futato</p>
<p style="position:absolute;top:295px;left:386px;white-space:nowrap" class="ft45"><b>Illustrator:&#160;</b>Rebecca Demarest</p>
<p style="position:absolute;top:342px;left:108px;white-space:nowrap" class="ft43">May 2014:</p>
<p style="position:absolute;top:342px;left:216px;white-space:nowrap" class="ft43">First Edition</p>
<p style="position:absolute;top:373px;left:108px;white-space:nowrap" class="ft49"><b>Revision History for the First Edition:<br/></b>2014-04-25:&#160;&#160;First release</p>
<p style="position:absolute;top:427px;left:108px;white-space:nowrap" class="ft43">See&#160;<a href="http://oreilly.com/catalog/errata.csp?isbn=9781449372620"><i>http://oreilly.com/catalog/errata.csp?isbn=9781449372620</i>&#160;for release details.</a></p>
<p style="position:absolute;top:457px;left:108px;white-space:nowrap" class="ft43">Nutshell Handbook, the Nutshell Handbook logo, and the O’Reilly logo are registered trademarks of O’Reilly</p>
<p style="position:absolute;top:473px;left:108px;white-space:nowrap" class="ft43">Media, Inc.&#160;<i>Flask Web Development</i>, the picture of a Pyrenean Mastiff, and related trade dress are trademarks</p>
<p style="position:absolute;top:488px;left:108px;white-space:nowrap" class="ft47">of O’Reilly Media, Inc.<br/>Many of the designations used by manufacturers and sellers to distinguish their products are claimed as</p>
<p style="position:absolute;top:527px;left:108px;white-space:nowrap" class="ft43">trademarks. Where those designations appear in this book, and O’Reilly Media, Inc. was aware of a trademark</p>
<p style="position:absolute;top:543px;left:108px;white-space:nowrap" class="ft47">claim, the designations have been printed in caps or initial caps.<br/>While every precaution has been taken in the preparation of this book, the publisher and authors assume</p>
<p style="position:absolute;top:582px;left:108px;white-space:nowrap" class="ft43">no responsibility for errors or omissions, or for damages resulting from the use of the information contained</p>
<p style="position:absolute;top:598px;left:108px;white-space:nowrap" class="ft43">herein.</p>
<p style="position:absolute;top:839px;left:108px;white-space:nowrap" class="ft47">ISBN: 978-1-449-37262-0<br/>[LSI]</p>
</div>
<!-- Page 5 -->
<a name="5"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft510{font-size:13px;font-family:Times;color:#231f20;}
-->
</style>
<div id="page5-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask005.png" alt="background image"/>
<p style="position:absolute;top:133px;left:345px;white-space:nowrap" class="ft510"><i>For Alicia.</i></p>
</div>
<!-- Page 6 -->
<a name="6"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page6-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask006.png" alt="background image"/>
</div>
<!-- Page 7 -->
<a name="7"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft711{font-size:35px;font-family:Times;color:#231f20;}
	.ft712{font-size:16px;font-family:Times;color:#231f20;}
	.ft713{font-size:19px;font-family:Times;color:#231f20;}
	.ft714{font-size:13px;font-family:Times;color:#231f20;}
-->
</style>
<div id="page7-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask007.png" alt="background image"/>
<p style="position:absolute;top:105px;left:434px;white-space:nowrap" class="ft711"><b>Table of Contents</b></p>
<p style="position:absolute;top:321px;left:108px;white-space:nowrap" class="ft712"><a href="Flask.html#13"><b>Preface. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .&#160;&#160;&#160;xi</b></a></p>
<p style="position:absolute;top:364px;left:108px;white-space:nowrap" class="ft713"><b>Part I.&#160;&#160;<a href="Flask.html#21">Introduction to Flask</a></b></p>
<p style="position:absolute;top:406px;left:109px;white-space:nowrap" class="ft712"><b>1.&#160;<a href="Flask.html#23">Installation. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .&#160;&#160;&#160;3</a></b></p>
<p style="position:absolute;top:427px;left:130px;white-space:nowrap" class="ft714"><a href="Flask.html#24">Using Virtual Environments &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>4</p>
<p style="position:absolute;top:445px;left:130px;white-space:nowrap" class="ft714"><a href="Flask.html#26">Installing Python Packages with pip &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;&#160;</a>6</p>
<p style="position:absolute;top:481px;left:109px;white-space:nowrap" class="ft712"><b>2.&#160;<a href="Flask.html#27">Basic Application Structure. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .&#160;&#160;&#160;7</a></b></p>
<p style="position:absolute;top:502px;left:130px;white-space:nowrap" class="ft714"><a href="Flask.html#27">Initialization &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>7</p>
<p style="position:absolute;top:521px;left:130px;white-space:nowrap" class="ft714"><a href="Flask.html#28">Routes and View Functions &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>8</p>
<p style="position:absolute;top:540px;left:130px;white-space:nowrap" class="ft714"><a href="Flask.html#29">Server Startup &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;&#160;</a>9</p>
<p style="position:absolute;top:559px;left:130px;white-space:nowrap" class="ft714"><a href="Flask.html#29">A Complete Application &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;&#160;</a>9</p>
<p style="position:absolute;top:578px;left:130px;white-space:nowrap" class="ft714"><a href="Flask.html#32">The Request-Response Cycle &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;&#160;</a>12</p>
<p style="position:absolute;top:597px;left:143px;white-space:nowrap" class="ft714"><a href="Flask.html#32">Application and Request Contexts &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>12</p>
<p style="position:absolute;top:616px;left:143px;white-space:nowrap" class="ft714"><a href="Flask.html#34">Request Dispatching &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>14</p>
<p style="position:absolute;top:634px;left:143px;white-space:nowrap" class="ft714"><a href="Flask.html#34">Request Hooks &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>14</p>
<p style="position:absolute;top:653px;left:143px;white-space:nowrap" class="ft714"><a href="Flask.html#35">Responses &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>15</p>
<p style="position:absolute;top:672px;left:130px;white-space:nowrap" class="ft714"><a href="Flask.html#36">Flask Extensions &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>16</p>
<p style="position:absolute;top:691px;left:143px;white-space:nowrap" class="ft714"><a href="Flask.html#37">Command-Line Options with Flask-Script &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>17</p>
<p style="position:absolute;top:727px;left:109px;white-space:nowrap" class="ft712"><b>3.&#160;<a href="Flask.html#41">Templates. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .&#160;&#160;&#160;21</a></b></p>
<p style="position:absolute;top:748px;left:130px;white-space:nowrap" class="ft714"><a href="Flask.html#42">The Jinja2 Template Engine &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>22</p>
<p style="position:absolute;top:767px;left:143px;white-space:nowrap" class="ft714"><a href="Flask.html#42">Rendering Templates &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;&#160;</a>22</p>
<p style="position:absolute;top:786px;left:143px;white-space:nowrap" class="ft714"><a href="Flask.html#43">Variables &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>23</p>
<p style="position:absolute;top:805px;left:143px;white-space:nowrap" class="ft714"><a href="Flask.html#44">Control Structures &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>24</p>
<p style="position:absolute;top:823px;left:130px;white-space:nowrap" class="ft714"><a href="Flask.html#46">Twitter Bootstrap Integration with Flask-Bootstrap &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>26</p>
<p style="position:absolute;top:842px;left:130px;white-space:nowrap" class="ft714"><a href="Flask.html#49">Custom Error Pages &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>29</p>
<p style="position:absolute;top:861px;left:130px;white-space:nowrap" class="ft714"><a href="Flask.html#51">Links &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>31</p>
<p style="position:absolute;top:915px;left:643px;white-space:nowrap" class="ft75"><b>v</b></p>
</div>
<!-- Page 8 -->
<a name="8"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page8-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask008.png" alt="background image"/>
<p style="position:absolute;top:78px;left:130px;white-space:nowrap" class="ft814"><a href="Flask.html#52">Static Files &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;&#160;</a>32</p>
<p style="position:absolute;top:97px;left:130px;white-space:nowrap" class="ft814"><a href="Flask.html#53">Localization of Dates and Times with Flask-Moment &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>33</p>
<p style="position:absolute;top:133px;left:109px;white-space:nowrap" class="ft812"><b>4.&#160;<a href="Flask.html#57">Web Forms. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .&#160;&#160;&#160;37</a></b></p>
<p style="position:absolute;top:154px;left:130px;white-space:nowrap" class="ft814"><a href="Flask.html#57">Cross-Site Request Forgery (CSRF) Protection &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>37</p>
<p style="position:absolute;top:173px;left:130px;white-space:nowrap" class="ft814"><a href="Flask.html#58">Form Classes &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>38</p>
<p style="position:absolute;top:192px;left:130px;white-space:nowrap" class="ft814"><a href="Flask.html#60">HTML Rendering of Forms &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;&#160;</a>40</p>
<p style="position:absolute;top:211px;left:130px;white-space:nowrap" class="ft814"><a href="Flask.html#61">Form Handling in View Functions &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>41</p>
<p style="position:absolute;top:230px;left:130px;white-space:nowrap" class="ft814"><a href="Flask.html#64">Redirects and User Sessions &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;&#160;</a>44</p>
<p style="position:absolute;top:249px;left:130px;white-space:nowrap" class="ft814"><a href="Flask.html#66">Message Flashing &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;&#160;</a>46</p>
<p style="position:absolute;top:284px;left:109px;white-space:nowrap" class="ft812"><b>5.&#160;<a href="Flask.html#69">Databases. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .&#160;&#160;&#160;49</a></b></p>
<p style="position:absolute;top:305px;left:130px;white-space:nowrap" class="ft814"><a href="Flask.html#69">SQL Databases &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>49</p>
<p style="position:absolute;top:324px;left:130px;white-space:nowrap" class="ft814"><a href="Flask.html#70">NoSQL Databases &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>50</p>
<p style="position:absolute;top:343px;left:130px;white-space:nowrap" class="ft814"><a href="Flask.html#71">SQL or NoSQL? &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>51</p>
<p style="position:absolute;top:362px;left:130px;white-space:nowrap" class="ft814"><a href="Flask.html#71">Python Database Frameworks &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;&#160;</a>51</p>
<p style="position:absolute;top:381px;left:130px;white-space:nowrap" class="ft814"><a href="Flask.html#72">Database Management with Flask-SQLAlchemy &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>52</p>
<p style="position:absolute;top:400px;left:130px;white-space:nowrap" class="ft814"><a href="Flask.html#74">Model Definition &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>54</p>
<p style="position:absolute;top:419px;left:130px;white-space:nowrap" class="ft814"><a href="Flask.html#76">Relationships &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>56</p>
<p style="position:absolute;top:438px;left:130px;white-space:nowrap" class="ft814"><a href="Flask.html#77">Database Operations &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;&#160;</a>57</p>
<p style="position:absolute;top:456px;left:143px;white-space:nowrap" class="ft814"><a href="Flask.html#78">Creating the Tables &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>58</p>
<p style="position:absolute;top:475px;left:143px;white-space:nowrap" class="ft814"><a href="Flask.html#78">Inserting Rows &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>58</p>
<p style="position:absolute;top:494px;left:143px;white-space:nowrap" class="ft814"><a href="Flask.html#80">Modifying Rows &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;&#160;</a>60</p>
<p style="position:absolute;top:513px;left:143px;white-space:nowrap" class="ft814"><a href="Flask.html#80">Deleting Rows &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>60</p>
<p style="position:absolute;top:532px;left:143px;white-space:nowrap" class="ft814"><a href="Flask.html#80">Querying Rows &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;&#160;</a>60</p>
<p style="position:absolute;top:551px;left:130px;white-space:nowrap" class="ft814"><a href="Flask.html#82">Database Use in View Functions &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>62</p>
<p style="position:absolute;top:570px;left:130px;white-space:nowrap" class="ft814"><a href="Flask.html#83">Integration with the Python Shell &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>63</p>
<p style="position:absolute;top:589px;left:130px;white-space:nowrap" class="ft814"><a href="Flask.html#84">Database Migrations with Flask-Migrate &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;&#160;</a>64</p>
<p style="position:absolute;top:608px;left:143px;white-space:nowrap" class="ft814"><a href="Flask.html#84">Creating a Migration Repository &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;&#160;</a>64</p>
<p style="position:absolute;top:627px;left:143px;white-space:nowrap" class="ft814"><a href="Flask.html#85">Creating a Migration Script &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>65</p>
<p style="position:absolute;top:645px;left:143px;white-space:nowrap" class="ft814"><a href="Flask.html#86">Upgrading the Database &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>66</p>
<p style="position:absolute;top:681px;left:109px;white-space:nowrap" class="ft812"><b>6.&#160;<a href="Flask.html#89">Email. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .&#160;&#160;&#160;69</a></b></p>
<p style="position:absolute;top:702px;left:130px;white-space:nowrap" class="ft814"><a href="Flask.html#89">Email Support with Flask-Mail &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>69</p>
<p style="position:absolute;top:721px;left:143px;white-space:nowrap" class="ft814"><a href="Flask.html#90">Sending Email from the Python Shell &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;&#160;</a>70</p>
<p style="position:absolute;top:740px;left:143px;white-space:nowrap" class="ft814"><a href="Flask.html#91">Integrating Emails with the Application &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>71</p>
<p style="position:absolute;top:759px;left:143px;white-space:nowrap" class="ft814"><a href="Flask.html#92">Sending Asynchronous Email &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>72</p>
<p style="position:absolute;top:795px;left:109px;white-space:nowrap" class="ft812"><b>7.&#160;<a href="Flask.html#95">Large Application Structure. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .&#160;&#160;&#160;75</a></b></p>
<p style="position:absolute;top:816px;left:130px;white-space:nowrap" class="ft814"><a href="Flask.html#95">Project Structure &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>75</p>
<p style="position:absolute;top:834px;left:130px;white-space:nowrap" class="ft814"><a href="Flask.html#96">Configuration Options &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>76</p>
<p style="position:absolute;top:853px;left:130px;white-space:nowrap" class="ft814"><a href="Flask.html#98">Application Package &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>78</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft85"><b>vi&#160;&#160;|&#160;&#160;Table of Contents</b></p>
</div>
<!-- Page 9 -->
<a name="9"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page9-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask009.png" alt="background image"/>
<p style="position:absolute;top:78px;left:143px;white-space:nowrap" class="ft914"><a href="Flask.html#98">Using an Application Factory &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>78</p>
<p style="position:absolute;top:97px;left:143px;white-space:nowrap" class="ft914"><a href="Flask.html#99">Implementing Application Functionality in a Blueprint &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>79</p>
<p style="position:absolute;top:116px;left:130px;white-space:nowrap" class="ft914"><a href="Flask.html#101">Launch Script &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>81</p>
<p style="position:absolute;top:135px;left:130px;white-space:nowrap" class="ft914"><a href="Flask.html#102">Requirements File &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>82</p>
<p style="position:absolute;top:154px;left:130px;white-space:nowrap" class="ft914"><a href="Flask.html#103">Unit Tests &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>83</p>
<p style="position:absolute;top:173px;left:130px;white-space:nowrap" class="ft914"><a href="Flask.html#105">Database Setup &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;&#160;</a>85</p>
<p style="position:absolute;top:220px;left:108px;white-space:nowrap" class="ft913"><b>Part II.&#160;&#160;<a href="Flask.html#107">Example: A Social Blogging Application</a></b></p>
<p style="position:absolute;top:261px;left:109px;white-space:nowrap" class="ft912"><b>8.&#160;<a href="Flask.html#109">User Authentication. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .&#160;&#160;&#160;89</a></b></p>
<p style="position:absolute;top:282px;left:130px;white-space:nowrap" class="ft914"><a href="Flask.html#109">Authentication Extensions for Flask &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;&#160;</a>89</p>
<p style="position:absolute;top:301px;left:130px;white-space:nowrap" class="ft914"><a href="Flask.html#110">Password Security &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>90</p>
<p style="position:absolute;top:320px;left:143px;white-space:nowrap" class="ft914"><a href="Flask.html#110">Hashing Passwords with Werkzeug &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>90</p>
<p style="position:absolute;top:339px;left:130px;white-space:nowrap" class="ft914"><a href="Flask.html#112">Creating an Authentication Blueprint &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>92</p>
<p style="position:absolute;top:358px;left:130px;white-space:nowrap" class="ft914"><a href="Flask.html#114">User Authentication with Flask-Login &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>94</p>
<p style="position:absolute;top:377px;left:143px;white-space:nowrap" class="ft914"><a href="Flask.html#114">Preparing the User Model for Logins &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>94</p>
<p style="position:absolute;top:396px;left:143px;white-space:nowrap" class="ft914"><a href="Flask.html#115">Protecting Routes &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>95</p>
<p style="position:absolute;top:415px;left:143px;white-space:nowrap" class="ft914"><a href="Flask.html#116">Adding a Login Form &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>96</p>
<p style="position:absolute;top:433px;left:143px;white-space:nowrap" class="ft914"><a href="Flask.html#117">Signing Users In &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>97</p>
<p style="position:absolute;top:452px;left:143px;white-space:nowrap" class="ft914"><a href="Flask.html#119">Signing Users Out &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>99</p>
<p style="position:absolute;top:471px;left:143px;white-space:nowrap" class="ft914"><a href="Flask.html#119">Testing Logins &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>99</p>
<p style="position:absolute;top:490px;left:130px;white-space:nowrap" class="ft914"><a href="Flask.html#120">New User Registration &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>100</p>
<p style="position:absolute;top:509px;left:143px;white-space:nowrap" class="ft914"><a href="Flask.html#120">Adding a User Registration Form &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>100</p>
<p style="position:absolute;top:528px;left:143px;white-space:nowrap" class="ft914"><a href="Flask.html#122">Registering New Users &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>102</p>
<p style="position:absolute;top:547px;left:130px;white-space:nowrap" class="ft914"><a href="Flask.html#123">Account Confirmation &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>103</p>
<p style="position:absolute;top:566px;left:143px;white-space:nowrap" class="ft914"><a href="Flask.html#123">Generating Confirmation Tokens with itsdangerous &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;&#160;</a>103</p>
<p style="position:absolute;top:585px;left:143px;white-space:nowrap" class="ft914"><a href="Flask.html#125">Sending Confirmation Emails &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>105</p>
<p style="position:absolute;top:604px;left:130px;white-space:nowrap" class="ft914"><a href="Flask.html#129">Account Management &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>109</p>
<p style="position:absolute;top:639px;left:109px;white-space:nowrap" class="ft912"><b>9.&#160;<a href="Flask.html#131">User Roles. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .&#160;&#160;111</a></b></p>
<p style="position:absolute;top:660px;left:130px;white-space:nowrap" class="ft914"><a href="Flask.html#131">Database Representation of Roles &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;&#160;</a>111</p>
<p style="position:absolute;top:679px;left:130px;white-space:nowrap" class="ft914"><a href="Flask.html#133">Role Assignment &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>113</p>
<p style="position:absolute;top:698px;left:130px;white-space:nowrap" class="ft914"><a href="Flask.html#134">Role Verification &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>114</p>
<p style="position:absolute;top:734px;left:102px;white-space:nowrap" class="ft912"><b>10.&#160;<a href="Flask.html#139">User Profiles. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .&#160;&#160;&#160;119</a></b></p>
<p style="position:absolute;top:755px;left:130px;white-space:nowrap" class="ft914"><a href="Flask.html#139">Profile Information &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>119</p>
<p style="position:absolute;top:774px;left:130px;white-space:nowrap" class="ft914"><a href="Flask.html#140">User Profile Page &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>120</p>
<p style="position:absolute;top:793px;left:130px;white-space:nowrap" class="ft914"><a href="Flask.html#142">Profile Editor &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>122</p>
<p style="position:absolute;top:811px;left:143px;white-space:nowrap" class="ft914"><a href="Flask.html#142">User-Level Profile Editor &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>122</p>
<p style="position:absolute;top:830px;left:143px;white-space:nowrap" class="ft914"><a href="Flask.html#144">Administrator-Level Profile Editor &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;&#160;</a>124</p>
<p style="position:absolute;top:915px;left:530px;white-space:nowrap" class="ft95"><b>Table of Contents&#160;&#160;|&#160;&#160;vii</b></p>
</div>
<!-- Page 10 -->
<a name="10"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page10-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask010.png" alt="background image"/>
<p style="position:absolute;top:78px;left:130px;white-space:nowrap" class="ft1014"><a href="Flask.html#147">User Avatars &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>127</p>
<p style="position:absolute;top:114px;left:102px;white-space:nowrap" class="ft1012"><b>11.&#160;<a href="Flask.html#151">Blog Posts. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .&#160;&#160;131</a></b></p>
<p style="position:absolute;top:135px;left:130px;white-space:nowrap" class="ft1014"><a href="Flask.html#151">Blog Post Submission and Display &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>131</p>
<p style="position:absolute;top:154px;left:130px;white-space:nowrap" class="ft1014"><a href="Flask.html#154">Blog Posts on Profile Pages &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>134</p>
<p style="position:absolute;top:173px;left:130px;white-space:nowrap" class="ft1014"><a href="Flask.html#155">Paginating Long Blog Post Lists &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>135</p>
<p style="position:absolute;top:192px;left:143px;white-space:nowrap" class="ft1014"><a href="Flask.html#155">Creating Fake Blog Post Data &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>135</p>
<p style="position:absolute;top:211px;left:143px;white-space:nowrap" class="ft1014"><a href="Flask.html#157">Rendering Data on Pages &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>137</p>
<p style="position:absolute;top:230px;left:143px;white-space:nowrap" class="ft1014"><a href="Flask.html#158">Adding a Pagination Widget &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>138</p>
<p style="position:absolute;top:249px;left:130px;white-space:nowrap" class="ft1014"><a href="Flask.html#161">Rich-Text Posts with Markdown and Flask-PageDown &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>141</p>
<p style="position:absolute;top:267px;left:143px;white-space:nowrap" class="ft1014"><a href="Flask.html#161">Using Flask-PageDown &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;&#160;</a>141</p>
<p style="position:absolute;top:286px;left:143px;white-space:nowrap" class="ft1014"><a href="Flask.html#163">Handling Rich Text on the Server &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>143</p>
<p style="position:absolute;top:305px;left:130px;white-space:nowrap" class="ft1014"><a href="Flask.html#165">Permanent Links to Blog Posts &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>145</p>
<p style="position:absolute;top:324px;left:130px;white-space:nowrap" class="ft1014"><a href="Flask.html#166">Blog Post Editor &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;&#160;</a>146</p>
<p style="position:absolute;top:360px;left:102px;white-space:nowrap" class="ft1012"><b>12.&#160;<a href="Flask.html#169">Followers. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .&#160;&#160;&#160;149</a></b></p>
<p style="position:absolute;top:381px;left:130px;white-space:nowrap" class="ft1014"><a href="Flask.html#169">Database Relationships Revisited &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>149</p>
<p style="position:absolute;top:400px;left:143px;white-space:nowrap" class="ft1014"><a href="Flask.html#170">Many-to-Many Relationships &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>150</p>
<p style="position:absolute;top:419px;left:143px;white-space:nowrap" class="ft1014"><a href="Flask.html#171">Self-Referential Relationships &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>151</p>
<p style="position:absolute;top:438px;left:143px;white-space:nowrap" class="ft1014"><a href="Flask.html#172">Advanced Many-to-Many Relationships &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>152</p>
<p style="position:absolute;top:456px;left:130px;white-space:nowrap" class="ft1014"><a href="Flask.html#175">Followers on the Profile Page &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>155</p>
<p style="position:absolute;top:475px;left:130px;white-space:nowrap" class="ft1014"><a href="Flask.html#178">Query Followed Posts Using a Database Join &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>158</p>
<p style="position:absolute;top:494px;left:130px;white-space:nowrap" class="ft1014"><a href="Flask.html#180">Show Followed Posts on the Home Page &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>160</p>
<p style="position:absolute;top:530px;left:102px;white-space:nowrap" class="ft1012"><b>13.&#160;<a href="Flask.html#185">User Comments. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .&#160;&#160;&#160;165</a></b></p>
<p style="position:absolute;top:551px;left:130px;white-space:nowrap" class="ft1014"><a href="Flask.html#185">Database Representation of Comments &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;&#160;</a>165</p>
<p style="position:absolute;top:570px;left:130px;white-space:nowrap" class="ft1014"><a href="Flask.html#187">Comment Submission and Display &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>167</p>
<p style="position:absolute;top:589px;left:130px;white-space:nowrap" class="ft1014"><a href="Flask.html#189">Comment Moderation &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>169</p>
<p style="position:absolute;top:625px;left:102px;white-space:nowrap" class="ft1012"><b>14.&#160;<a href="Flask.html#195">Application Programming Interfaces . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .&#160;&#160;&#160;175</a></b></p>
<p style="position:absolute;top:645px;left:130px;white-space:nowrap" class="ft1014"><a href="Flask.html#195">Introduction to REST &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>175</p>
<p style="position:absolute;top:664px;left:143px;white-space:nowrap" class="ft1014"><a href="Flask.html#196">Resources Are Everything &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>176</p>
<p style="position:absolute;top:683px;left:143px;white-space:nowrap" class="ft1014"><a href="Flask.html#197">Request Methods &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>177</p>
<p style="position:absolute;top:702px;left:143px;white-space:nowrap" class="ft1014"><a href="Flask.html#197">Request and Response Bodies &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>177</p>
<p style="position:absolute;top:721px;left:143px;white-space:nowrap" class="ft1014"><a href="Flask.html#198">Versioning &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;&#160;</a>178</p>
<p style="position:absolute;top:740px;left:130px;white-space:nowrap" class="ft1014"><a href="Flask.html#199">RESTful Web Services with Flask &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>179</p>
<p style="position:absolute;top:759px;left:143px;white-space:nowrap" class="ft1014"><a href="Flask.html#199">Creating an API Blueprint &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>179</p>
<p style="position:absolute;top:778px;left:143px;white-space:nowrap" class="ft1014"><a href="Flask.html#200">Error Handling &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;&#160;</a>180</p>
<p style="position:absolute;top:797px;left:143px;white-space:nowrap" class="ft1014"><a href="Flask.html#201">User Authentication with Flask-HTTPAuth &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>181</p>
<p style="position:absolute;top:816px;left:143px;white-space:nowrap" class="ft1014"><a href="Flask.html#204">Token-Based Authentication &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>184</p>
<p style="position:absolute;top:834px;left:143px;white-space:nowrap" class="ft1014"><a href="Flask.html#206">Serializing Resources to and from JSON &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>186</p>
<p style="position:absolute;top:853px;left:143px;white-space:nowrap" class="ft1014"><a href="Flask.html#208">Implementing Resource Endpoints &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>188</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft105"><b>viii&#160;&#160;|&#160;&#160;Table of Contents</b></p>
</div>
<!-- Page 11 -->
<a name="11"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page11-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask011.png" alt="background image"/>
<p style="position:absolute;top:78px;left:143px;white-space:nowrap" class="ft1114"><a href="Flask.html#211">Pagination of Large Resource Collections &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>191</p>
<p style="position:absolute;top:97px;left:143px;white-space:nowrap" class="ft1114"><a href="Flask.html#212">Testing Web Services with HTTPie &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;&#160;</a>192</p>
<p style="position:absolute;top:144px;left:108px;white-space:nowrap" class="ft1113"><b>Part III.&#160;&#160;<a href="Flask.html#215">The Last Mile</a></b></p>
<p style="position:absolute;top:186px;left:102px;white-space:nowrap" class="ft1112"><b>15.&#160;<a href="Flask.html#217">Testing. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .&#160;&#160;&#160;197</a></b></p>
<p style="position:absolute;top:207px;left:130px;white-space:nowrap" class="ft1114"><a href="Flask.html#217">Obtaining Code Coverage Reports &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;&#160;</a>197</p>
<p style="position:absolute;top:226px;left:130px;white-space:nowrap" class="ft1114"><a href="Flask.html#220">The Flask Test Client &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;&#160;</a>200</p>
<p style="position:absolute;top:244px;left:143px;white-space:nowrap" class="ft1114"><a href="Flask.html#220">Testing Web Applications &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>200</p>
<p style="position:absolute;top:263px;left:143px;white-space:nowrap" class="ft1114"><a href="Flask.html#224">Testing Web Services &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;204</a></p>
<p style="position:absolute;top:282px;left:130px;white-space:nowrap" class="ft1114"><a href="Flask.html#225">End-to-End Testing with Selenium &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>205</p>
<p style="position:absolute;top:301px;left:130px;white-space:nowrap" class="ft1114"><a href="Flask.html#229">Is It Worth It? &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>209</p>
<p style="position:absolute;top:337px;left:102px;white-space:nowrap" class="ft1112"><b>16.&#160;<a href="Flask.html#231">Performance. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .&#160;&#160;211</a></b></p>
<p style="position:absolute;top:358px;left:130px;white-space:nowrap" class="ft1114"><a href="Flask.html#231">Logging Slow Database Performance &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>211</p>
<p style="position:absolute;top:377px;left:130px;white-space:nowrap" class="ft1114"><a href="Flask.html#233">Source Code Profiling &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;&#160;</a>213</p>
<p style="position:absolute;top:413px;left:102px;white-space:nowrap" class="ft1112"><b>17.&#160;<a href="Flask.html#235">Deployment. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .&#160;&#160;&#160;215</a></b></p>
<p style="position:absolute;top:433px;left:130px;white-space:nowrap" class="ft1114"><a href="Flask.html#235">Deployment Workflow &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>215</p>
<p style="position:absolute;top:452px;left:130px;white-space:nowrap" class="ft1114"><a href="Flask.html#236">Logging of Errors During Production &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>216</p>
<p style="position:absolute;top:471px;left:130px;white-space:nowrap" class="ft1114"><a href="Flask.html#237">Cloud Deployment &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>217</p>
<p style="position:absolute;top:490px;left:130px;white-space:nowrap" class="ft1114"><a href="Flask.html#238">The Heroku Platform &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>218</p>
<p style="position:absolute;top:509px;left:143px;white-space:nowrap" class="ft1114"><a href="Flask.html#238">Preparing the Application &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>218</p>
<p style="position:absolute;top:528px;left:143px;white-space:nowrap" class="ft1114"><a href="Flask.html#242">Testing with Foreman &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>222</p>
<p style="position:absolute;top:547px;left:143px;white-space:nowrap" class="ft1114"><a href="Flask.html#243">Enabling Secure HTTP with Flask-SSLify &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>223</p>
<p style="position:absolute;top:566px;left:143px;white-space:nowrap" class="ft1114"><a href="Flask.html#245">Deploying with git push &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>225</p>
<p style="position:absolute;top:585px;left:143px;white-space:nowrap" class="ft1114"><a href="Flask.html#246">Reviewing Logs &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>226</p>
<p style="position:absolute;top:604px;left:143px;white-space:nowrap" class="ft1114"><a href="Flask.html#247">Deploying an Upgrade &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>227</p>
<p style="position:absolute;top:622px;left:130px;white-space:nowrap" class="ft1114"><a href="Flask.html#247">Traditional Hosting &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;&#160;</a>227</p>
<p style="position:absolute;top:641px;left:143px;white-space:nowrap" class="ft1114"><a href="Flask.html#247">Server Setup &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>227</p>
<p style="position:absolute;top:660px;left:143px;white-space:nowrap" class="ft1114"><a href="Flask.html#248">Importing Environment Variables &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>228</p>
<p style="position:absolute;top:679px;left:143px;white-space:nowrap" class="ft1114"><a href="Flask.html#248">Setting Up Logging &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>228</p>
<p style="position:absolute;top:715px;left:102px;white-space:nowrap" class="ft1112"><b>18.&#160;<a href="Flask.html#251">Additional Resources. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .&#160;&#160;&#160;231</a></b></p>
<p style="position:absolute;top:736px;left:130px;white-space:nowrap" class="ft1114"><a href="Flask.html#251">Using an Integrated Development Environment (IDE) &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;</a>231</p>
<p style="position:absolute;top:755px;left:130px;white-space:nowrap" class="ft1114"><a href="Flask.html#252">Finding Flask Extensions &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;</a>232</p>
<p style="position:absolute;top:774px;left:130px;white-space:nowrap" class="ft1114"><a href="Flask.html#252">Getting Involved with Flask &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;&#160;</a>232</p>
<p style="position:absolute;top:810px;left:108px;white-space:nowrap" class="ft1112"><a href="Flask.html#255"><b>Index. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .&#160;&#160;&#160;235</b></a></p>
<p style="position:absolute;top:915px;left:533px;white-space:nowrap" class="ft115"><b>Table of Contents&#160;&#160;|&#160;&#160;ix</b></p>
</div>
<!-- Page 12 -->
<a name="12"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page12-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask012.png" alt="background image"/>
</div>
<!-- Page 13 -->
<a name="13"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft1315{font-size:13px;line-height:27px;font-family:Times;color:#231f20;}
-->
</style>
<div id="page13-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask013.png" alt="background image"/>
<p style="position:absolute;top:107px;left:556px;white-space:nowrap" class="ft1311"><b>Preface</b></p>
<p style="position:absolute;top:321px;left:108px;white-space:nowrap" class="ft1314">Flask stands out from other frameworks because it lets developers take the driver’s seat</p>
<p style="position:absolute;top:340px;left:108px;white-space:nowrap" class="ft1314">and have full creative control of their applications. Maybe you have heard the phrase</p>
<p style="position:absolute;top:359px;left:108px;white-space:nowrap" class="ft1314">“fighting the framework” before. This happens with most frameworks when you decide</p>
<p style="position:absolute;top:378px;left:108px;white-space:nowrap" class="ft1314">to solve a problem with a solution that isn’t the official one. It could be that you want to</p>
<p style="position:absolute;top:397px;left:108px;white-space:nowrap" class="ft1314">use a different database engine, or maybe a different method of authenticating users.</p>
<p style="position:absolute;top:416px;left:108px;white-space:nowrap" class="ft1314">Deviating from the path set by the framework’s developers will give you lots of</p>
<p style="position:absolute;top:435px;left:108px;white-space:nowrap" class="ft1315">headaches.<br/>Flask is not like that. Do you like relational databases? Great. Flask supports them all.</p>
<p style="position:absolute;top:482px;left:108px;white-space:nowrap" class="ft1314">Maybe you prefer a NoSQL database? No problem at all. Flask works with them too.</p>
<p style="position:absolute;top:500px;left:108px;white-space:nowrap" class="ft1314">Want to use your own homegrown database engine? Don’t need a database at all? Still</p>
<p style="position:absolute;top:519px;left:108px;white-space:nowrap" class="ft1314">fine. With Flask you can choose the components of your application or even write your</p>
<p style="position:absolute;top:538px;left:108px;white-space:nowrap" class="ft1315">own if that is what you want. No questions asked!<br/>The key to this freedom is that Flask was designed from the start to be extended. It comes</p>
<p style="position:absolute;top:585px;left:108px;white-space:nowrap" class="ft1314">with a robust core that includes the basic functionality that all web applications need</p>
<p style="position:absolute;top:604px;left:108px;white-space:nowrap" class="ft1314">and expects the rest to be provided by some of the many third-party extensions in the</p>
<p style="position:absolute;top:623px;left:108px;white-space:nowrap" class="ft1315">ecosystem and, of course, by you.<br/>In this book I present my workflow for developing web applications with Flask. I don’t</p>
<p style="position:absolute;top:670px;left:108px;white-space:nowrap" class="ft1314">claim to have the only true way to build applications with this framework. You should</p>
<p style="position:absolute;top:689px;left:108px;white-space:nowrap" class="ft1315">take my choices as recommendations and not as gospel.<br/>Most software development books provide small and focused code examples that</p>
<p style="position:absolute;top:735px;left:108px;white-space:nowrap" class="ft1314">demonstrate the different features of the target technology in isolation, leaving the “glue”</p>
<p style="position:absolute;top:754px;left:108px;white-space:nowrap" class="ft1314">code that is necessary to transform these different features into a fully working appli‐</p>
<p style="position:absolute;top:773px;left:108px;white-space:nowrap" class="ft1314">cations to be figured out by the reader. I take a completely different approach. All the</p>
<p style="position:absolute;top:792px;left:108px;white-space:nowrap" class="ft1314">examples I present are part of a single application that starts out very simple and is</p>
<p style="position:absolute;top:811px;left:108px;white-space:nowrap" class="ft1314">expanded in each successive chapter. This application begins life with just a few lines of</p>
<p style="position:absolute;top:830px;left:108px;white-space:nowrap" class="ft1314">code and ends as a nicely featured blogging and social networking application.</p>
<p style="position:absolute;top:915px;left:640px;white-space:nowrap" class="ft135"><b>xi</b></p>
</div>
<!-- Page 14 -->
<a name="14"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft1416{font-size:26px;font-family:Times;color:#231f20;}
	.ft1417{font-size:13px;font-family:Times;color:#990000;}
	.ft1418{font-size:26px;line-height:40px;font-family:Times;color:#231f20;}
	.ft1419{font-size:13px;line-height:24px;font-family:Times;color:#231f20;}
-->
</style>
<div id="page14-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask014.png" alt="background image"/>
<p style="position:absolute;top:74px;left:108px;white-space:nowrap" class="ft1418"><b>Who This Book Is For<br/></b>You should have some level of Python coding experience to make the most of this book.</p>
<p style="position:absolute;top:134px;left:108px;white-space:nowrap" class="ft1414">Although the book assumes no previous Flask knowledge, Python concepts such as</p>
<p style="position:absolute;top:152px;left:108px;white-space:nowrap" class="ft1414">packages, modules, functions, decorators, and object-oriented programming are as‐</p>
<p style="position:absolute;top:171px;left:108px;white-space:nowrap" class="ft1414">sumed to be well understood. Some familiarity with exceptions and diagnosing issues</p>
<p style="position:absolute;top:190px;left:108px;white-space:nowrap" class="ft1415">from stack traces will be very useful.<br/>While working through the examples in this book, you will spend a great deal of time</p>
<p style="position:absolute;top:237px;left:108px;white-space:nowrap" class="ft1414">in the command line. You should feel comfortable using the command line of your</p>
<p style="position:absolute;top:256px;left:108px;white-space:nowrap" class="ft1415">operating system.<br/>Modern web applications cannot avoid the use of HTML, CSS, and JavaScript. The</p>
<p style="position:absolute;top:303px;left:108px;white-space:nowrap" class="ft1414">example application that is developed throughout the book obviously makes use of</p>
<p style="position:absolute;top:322px;left:108px;white-space:nowrap" class="ft1414">these, but the book itself does not go into a lot of detail regarding these technologies</p>
<p style="position:absolute;top:341px;left:108px;white-space:nowrap" class="ft1414">and how they are used. Some degree of familiarity with these languages is recommended</p>
<p style="position:absolute;top:359px;left:108px;white-space:nowrap" class="ft1414">if you intend to develop complete applications without the help of a developer versed</p>
<p style="position:absolute;top:378px;left:108px;white-space:nowrap" class="ft1415">in client-side techniques.<br/>I released the companion application to this book as open source on GitHub. Although</p>
<p style="position:absolute;top:425px;left:108px;white-space:nowrap" class="ft1414">GitHub makes it possible to download applications as regular ZIP or TAR files, I strongly</p>
<p style="position:absolute;top:444px;left:108px;white-space:nowrap" class="ft1414">recommend that you install a Git client and familiarize yourself with source code version</p>
<p style="position:absolute;top:463px;left:108px;white-space:nowrap" class="ft1414">control, at least with the basic commands to clone and check out the different versions</p>
<p style="position:absolute;top:482px;left:108px;white-space:nowrap" class="ft1414">of the application directly from the repository. The short list of commands that you’ll</p>
<p style="position:absolute;top:501px;left:108px;white-space:nowrap" class="ft1414"><a href="Flask.html#15">need is shown in&#160;“How to Work with the Example Code ”&#160;on page&#160;xiii. Y</a>ou will want to</p>
<p style="position:absolute;top:520px;left:108px;white-space:nowrap" class="ft1414">use version control for your own projects as well, so use this book as an excuse to learn</p>
<p style="position:absolute;top:539px;left:108px;white-space:nowrap" class="ft1415">Git!<br/>Finally, this book is not a complete and exhaustive reference on the Flask framework.</p>
<p style="position:absolute;top:585px;left:108px;white-space:nowrap" class="ft1414">Most features are covered, but you should complement this book with the&#160;<a href="http://flask.pocoo.org">official Flask</a></p>
<p style="position:absolute;top:604px;left:108px;white-space:nowrap" class="ft1417"><a href="http://flask.pocoo.org">documentation</a>.</p>
<p style="position:absolute;top:640px;left:108px;white-space:nowrap" class="ft1415"><b>How This Book Is Organized<br/></b>This book is divided into three parts:<br/><a href="Flask.html#21">Part I, Introduction to Flask</a>, explores the basics of web application development with</p>
<p style="position:absolute;top:728px;left:108px;white-space:nowrap" class="ft1414">the Flask framework and some of its extensions:</p>
<p style="position:absolute;top:761px;left:121px;white-space:nowrap" class="ft1419">•&#160;<a href="Flask.html#23">Chapter 1</a>&#160;describes the installation and setup of the Flask framework.<br/>•&#160;<a href="Flask.html#27">Chapter 2</a>&#160;dives straight into Flask with a basic application.<br/>•&#160;<a href="Flask.html#41">Chapter 3</a>&#160;introduces the use of templates in Flask applications.<br/>•&#160;<a href="Flask.html#57">Chapter 4</a>&#160;introduces web forms.<br/>•&#160;<a href="Flask.html#69">Chapter 5</a>&#160;introduces databases.</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft145"><b>xii&#160;&#160;|&#160;&#160;Preface</b></p>
</div>
<!-- Page 15 -->
<a name="15"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft1520{font-size:13px;font-family:Times;color:#990000;}
	.ft1521{font-size:10px;font-family:Times;color:#003333;}
	.ft1522{font-size:26px;line-height:41px;font-family:Times;color:#231f20;}
-->
</style>
<div id="page15-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask015.png" alt="background image"/>
<p style="position:absolute;top:78px;left:121px;white-space:nowrap" class="ft1519">•&#160;<a href="Flask.html#89">Chapter 6</a>&#160;introduces email support.<br/>•&#160;<a href="Flask.html#95">Chapter 7&#160;presen</a>ts an application structure that is appropriate for medium and</p>
<p style="position:absolute;top:122px;left:135px;white-space:nowrap" class="ft1514">large applications.</p>
<p style="position:absolute;top:156px;left:108px;white-space:nowrap" class="ft1517"><a href="Flask.html#107">Part II, Example: A Social Blogging Application</a>, builds Flasky, the open source blogging</p>
<p style="position:absolute;top:175px;left:108px;white-space:nowrap" class="ft1514">and social networking application that I developed for this book:</p>
<p style="position:absolute;top:209px;left:121px;white-space:nowrap" class="ft1519">•&#160;<a href="Flask.html#109">Chapter 8</a>&#160;implements a user authentication system.<br/>•&#160;<a href="Flask.html#131">Chapter 9</a>&#160;implements user roles and permissions.<br/>•&#160;<a href="Flask.html#139">Chapter 10&#160;im</a>plements user profile pages.<br/>•&#160;<a href="Flask.html#151">Chapter 11&#160;crea</a>tes the blogging interface.<br/>•&#160;<a href="Flask.html#169">Chapter 12&#160;im</a>plements followers.<br/>•&#160;<a href="Flask.html#185">Chapter 13&#160;im</a>plements user comments for blog posts.<br/>•&#160;<a href="Flask.html#195">Chapter 14&#160;im</a>plements an Application Programming Interface (API).</p>
<p style="position:absolute;top:392px;left:108px;white-space:nowrap" class="ft1517"><a href="Flask.html#215">Part III, The Last Mile, describes some im</a>portant tasks not directly related to application</p>
<p style="position:absolute;top:411px;left:108px;white-space:nowrap" class="ft1514">coding that need to be considered before publishing an application:</p>
<p style="position:absolute;top:445px;left:121px;white-space:nowrap" class="ft1519">•&#160;<a href="Flask.html#217">Chapter 15&#160;describes differen</a>t unit testing strategies in detail.<br/>•&#160;<a href="Flask.html#231">Chapter 16&#160;gives an over</a>view of performance analysis techniques.<br/>•&#160;<a href="Flask.html#235">Chapter 17&#160;describes deploymen</a>t options for Flask applications, both traditional</p>
<p style="position:absolute;top:514px;left:135px;white-space:nowrap" class="ft1514">and cloud based.</p>
<p style="position:absolute;top:539px;left:121px;white-space:nowrap" class="ft1514">•&#160;<a href="Flask.html#251">Chapter 18&#160;lists additional resources.</a></p>
<p style="position:absolute;top:591px;left:108px;white-space:nowrap" class="ft1522"><b>How to Work with the Example Code&#160;<br/></b>The code examples presented in this book are available from GitHub a<a href="https://github.com/miguelgrinberg/flasky">t&#160;<i>https://</i></a></p>
<p style="position:absolute;top:652px;left:108px;white-space:nowrap" class="ft1520"><a href="https://github.com/miguelgrinberg/flasky"><i>github.com/miguelgrinberg/flasky</i></a></p>
<p style="position:absolute;top:651px;left:316px;white-space:nowrap" class="ft1514">.</p>
<p style="position:absolute;top:679px;left:108px;white-space:nowrap" class="ft1514">The commit history in this repository was carefully created to match the order in which</p>
<p style="position:absolute;top:698px;left:108px;white-space:nowrap" class="ft1514">concepts are presented in the book. The recommended way to work with the code is to</p>
<p style="position:absolute;top:717px;left:108px;white-space:nowrap" class="ft1514">check out the commits starting from the oldest, then move forward through the commit</p>
<p style="position:absolute;top:736px;left:108px;white-space:nowrap" class="ft1514">list as you make progress with the book. As an alternative, GitHub will also let you</p>
<p style="position:absolute;top:755px;left:108px;white-space:nowrap" class="ft1515">download each commit as a ZIP or TAR file.<br/>If you decide to use Git to work with the source code, then you need to install the Git</p>
<p style="position:absolute;top:802px;left:108px;white-space:nowrap" class="ft1514">clien<a href="http://git-scm.com">t, which you can download from&#160;<i>http://git-scm.com</i>. The following command</a></p>
<p style="position:absolute;top:820px;left:108px;white-space:nowrap" class="ft1514">downloads the example code using Git:</p>
<p style="position:absolute;top:852px;left:134px;white-space:nowrap" class="ft1521">$&#160;git clone https://github.com/miguelgrinberg/flasky.git</p>
<p style="position:absolute;top:915px;left:572px;white-space:nowrap" class="ft155"><b>Preface&#160;&#160;|&#160;&#160;xiii</b></p>
</div>
<!-- Page 16 -->
<a name="16"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft1623{font-size:10px;line-height:15px;font-family:Times;color:#231f20;}
-->
</style>
<div id="page16-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask016.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft1614">The&#160;git clone&#160;command installs the source code from GitHub into a&#160;<i>flasky</i>&#160;folder that</p>
<p style="position:absolute;top:98px;left:108px;white-space:nowrap" class="ft1614">is created in the current directory. This folder does not contain just source code; a copy</p>
<p style="position:absolute;top:117px;left:108px;white-space:nowrap" class="ft1614">of the Git repository with the entire history of changes made to the application is also</p>
<p style="position:absolute;top:136px;left:108px;white-space:nowrap" class="ft1615">included.<br/>In the first chapter you will be asked to&#160;<i>check out</i>&#160;the initial release of the application,</p>
<p style="position:absolute;top:183px;left:108px;white-space:nowrap" class="ft1614">and then, at the proper places you will be instructed to move forward in the history.</p>
<p style="position:absolute;top:203px;left:108px;white-space:nowrap" class="ft1614">The Git command that lets you move through the change history is&#160;git checkout. Here</p>
<p style="position:absolute;top:222px;left:108px;white-space:nowrap" class="ft1614">is an example:</p>
<p style="position:absolute;top:253px;left:133px;white-space:nowrap" class="ft1621">$&#160;git checkout 1a</p>
<p style="position:absolute;top:275px;left:108px;white-space:nowrap" class="ft1614">The&#160;1a&#160;referenced in the command is a&#160;<i>tag</i>, a named point in the history of the project.</p>
<p style="position:absolute;top:295px;left:108px;white-space:nowrap" class="ft1614">This repository is tagged according to the chapters of the book, so the&#160;1a&#160;tag used in</p>
<p style="position:absolute;top:313px;left:108px;white-space:nowrap" class="ft1614">the example sets the application files to the initial version used in&#160;<a href="Flask.html#23">Chapter 1. M</a>ost</p>
<p style="position:absolute;top:333px;left:108px;white-space:nowrap" class="ft1614">chapters have more than one tag associated with them, so, for example, tags&#160;5a,&#160;5b, and</p>
<p style="position:absolute;top:352px;left:108px;white-space:nowrap" class="ft1615">so on are incremental versions presen<a href="Flask.html#69">ted in&#160;Chapter 5</a>.<br/>In addition to checking out the source files for a version of the application, you may</p>
<p style="position:absolute;top:399px;left:108px;white-space:nowrap" class="ft1614">need to perform some setup. For example, in some cases you will need to install addi‐</p>
<p style="position:absolute;top:418px;left:108px;white-space:nowrap" class="ft1614">tional Python packages or apply updates to the database. You will be told when these</p>
<p style="position:absolute;top:437px;left:108px;white-space:nowrap" class="ft1615">are necessary.<br/>You will normally not modify the source files of the application, but if you do, then Git</p>
<p style="position:absolute;top:484px;left:108px;white-space:nowrap" class="ft1614">will not let you check out a different revision, as that would cause your local changes to</p>
<p style="position:absolute;top:502px;left:108px;white-space:nowrap" class="ft1614">be lost. Before you can check out a different revision, you will need to revert the files to</p>
<p style="position:absolute;top:522px;left:108px;white-space:nowrap" class="ft1614">their original state. The easiest way to do this is with the&#160;git reset&#160;command:</p>
<p style="position:absolute;top:554px;left:134px;white-space:nowrap" class="ft1621">$&#160;git reset --hard</p>
<p style="position:absolute;top:574px;left:108px;white-space:nowrap" class="ft1614">This command will destroy your local changes, so you should save anything you don’t</p>
<p style="position:absolute;top:593px;left:108px;white-space:nowrap" class="ft1615">want to lose before you use this command.<br/>From time to time, you may want to refresh your local repository from the one on</p>
<p style="position:absolute;top:640px;left:108px;white-space:nowrap" class="ft1614">GitHub, where bug fixes and improvements may have been applied. The commands</p>
<p style="position:absolute;top:659px;left:108px;white-space:nowrap" class="ft1614">that achieve this are:</p>
<p style="position:absolute;top:691px;left:134px;white-space:nowrap" class="ft1623">$&#160;git fetch --all<br/>$&#160;git fetch --tags<br/>$&#160;git reset --hard origin/master</p>
<p style="position:absolute;top:743px;left:108px;white-space:nowrap" class="ft1614">The&#160;git fetch&#160;commands are used to update the commit history and the tags in your</p>
<p style="position:absolute;top:762px;left:108px;white-space:nowrap" class="ft1614">local repository from the remote one on GitHub, but none of this affects the actual</p>
<p style="position:absolute;top:782px;left:108px;white-space:nowrap" class="ft1614">source files, which are updated with the&#160;git reset&#160;command that follows. Once again,</p>
<p style="position:absolute;top:801px;left:108px;white-space:nowrap" class="ft1615">be aware that any time&#160;git reset&#160;is used you will lose any local changes you have made.<br/>Another useful operation is to view all the differences between two versions of the</p>
<p style="position:absolute;top:848px;left:108px;white-space:nowrap" class="ft1614">application. This can be very useful to understand a change in detail. From the command</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft165"><b>xiv&#160;&#160;|&#160;&#160;Preface</b></p>
</div>
<!-- Page 17 -->
<a name="17"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft1724{font-size:13px;line-height:26px;font-family:Times;color:#231f20;}
-->
</style>
<div id="page17-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask017.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft1714">line, the&#160;git diff&#160;command can do this. For example, to see the difference between</p>
<p style="position:absolute;top:99px;left:108px;white-space:nowrap" class="ft1714">revisions&#160;2a&#160;and&#160;2b, use:</p>
<p style="position:absolute;top:131px;left:133px;white-space:nowrap" class="ft1721">$&#160;git diff &#160;2a 2b</p>
<p style="position:absolute;top:151px;left:108px;white-space:nowrap" class="ft1714">The differences are shown as a&#160;<i>patch</i>, which is not a very intuitive format to review</p>
<p style="position:absolute;top:170px;left:108px;white-space:nowrap" class="ft1714">changes if you are not used to working with patch files. You may find that the graphical</p>
<p style="position:absolute;top:189px;left:108px;white-space:nowrap" class="ft1714">comparisons shown by GitHub are much easier to read. For example, the differences</p>
<p style="position:absolute;top:209px;left:108px;white-space:nowrap" class="ft1714">between revisions&#160;2a&#160;and&#160;2b&#160;can be viewed on GitHub a<a href="https://github.com/miguelgrinberg/flasky/compare/2a...2b">t&#160;<i>https://github.com/miguelgrin</i></a></p>
<p style="position:absolute;top:229px;left:108px;white-space:nowrap" class="ft1720"><a href="https://github.com/miguelgrinberg/flasky/compare/2a...2b"><i>berg/flasky/compare/2a...2b</i></a></p>
<p style="position:absolute;top:264px;left:108px;white-space:nowrap" class="ft1718"><b>Using Code Examples<br/></b>This book is here to help you get your job done. In general, if example code is offered</p>
<p style="position:absolute;top:323px;left:108px;white-space:nowrap" class="ft1714">with this book, you may use it in your programs and documentation. You do not need</p>
<p style="position:absolute;top:342px;left:108px;white-space:nowrap" class="ft1714">to contact us for permission unless you’re reproducing a significant portion of the code.</p>
<p style="position:absolute;top:361px;left:108px;white-space:nowrap" class="ft1714">For example, writing a program that uses several chunks of code from this book does</p>
<p style="position:absolute;top:380px;left:108px;white-space:nowrap" class="ft1714">not require permission. Selling or distributing a CD-ROM of examples from O’Reilly</p>
<p style="position:absolute;top:399px;left:108px;white-space:nowrap" class="ft1714">books does require permission. Answering a question by citing this book and quoting</p>
<p style="position:absolute;top:418px;left:108px;white-space:nowrap" class="ft1714">example code does not require permission. Incorporating a significant amount of ex‐</p>
<p style="position:absolute;top:437px;left:108px;white-space:nowrap" class="ft1715">ample code from this book into your product’s documentation does require permission.<br/>We appreciate, but do not require, attribution. An attribution usually includes the title,</p>
<p style="position:absolute;top:483px;left:108px;white-space:nowrap" class="ft1714">author, publisher, and ISBN. For example: “<i>Flask Web Development</i>&#160;by Miguel Grinberg</p>
<p style="position:absolute;top:502px;left:108px;white-space:nowrap" class="ft1715">(O’Reilly). Copyright 2014 Miguel Grinberg, 978-1-449-3726-2.”<br/>If you feel your use of code examples falls outside fair use or the permission given above,</p>
<p style="position:absolute;top:549px;left:108px;white-space:nowrap" class="ft1714">feel free to contact us at&#160;<a href="mailto:permissions@oreilly.com"><i>permissions@oreilly.com</i></a>.</p>
<p style="position:absolute;top:585px;left:108px;white-space:nowrap" class="ft1724"><b>Conventions Used in This Book<br/></b>The following typographical conventions are used in this book:<br/><i>Italic</i></p>
<p style="position:absolute;top:670px;left:135px;white-space:nowrap" class="ft1714">Indicates new terms, URLs, email addresses, filenames, and file extensions.</p>
<p style="position:absolute;top:703px;left:108px;white-space:nowrap" class="ft1714">Constant width</p>
<p style="position:absolute;top:718px;left:135px;white-space:nowrap" class="ft1714">Used for program listings, as well as within paragraphs to refer to program elements</p>
<p style="position:absolute;top:737px;left:135px;white-space:nowrap" class="ft1714">such as variable or function names, databases, data types, environment variables,</p>
<p style="position:absolute;top:756px;left:135px;white-space:nowrap" class="ft1714">statements, and keywords.</p>
<p style="position:absolute;top:788px;left:108px;white-space:nowrap" class="ft172"><b>Constant width bold</b></p>
<p style="position:absolute;top:804px;left:135px;white-space:nowrap" class="ft1714">Shows commands or other text that should be typed literally by the user.</p>
<p style="position:absolute;top:915px;left:575px;white-space:nowrap" class="ft175"><b>Preface&#160;&#160;|&#160;&#160;xv</b></p>
</div>
<!-- Page 18 -->
<a name="18"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft1825{font-size:12px;font-family:Times;color:#231f20;}
-->
</style>
<div id="page18-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask018.png" alt="background image"/>
<p style="position:absolute;top:83px;left:108px;white-space:nowrap" class="ft1810"><i>Constant width italic</i></p>
<p style="position:absolute;top:98px;left:135px;white-space:nowrap" class="ft1814">Shows text that should be replaced with user-supplied values or by values deter‐</p>
<p style="position:absolute;top:117px;left:135px;white-space:nowrap" class="ft1814">mined by context.</p>
<p style="position:absolute;top:159px;left:198px;white-space:nowrap" class="ft1825">This&#160;element&#160;signifies&#160;a&#160;tip&#160;or&#160;suggestion.</p>
<p style="position:absolute;top:270px;left:198px;white-space:nowrap" class="ft1825">This&#160;element&#160;signifies&#160;a&#160;general&#160;note.</p>
<p style="position:absolute;top:379px;left:204px;white-space:nowrap" class="ft1825">This&#160;element&#160;indicates&#160;a&#160;warning&#160;or&#160;caution.</p>
<p style="position:absolute;top:476px;left:108px;white-space:nowrap" class="ft1816"><b>Safari® Books Online</b></p>
<p style="position:absolute;top:517px;left:222px;white-space:nowrap" class="ft1820"><a href="http://my.safaribooksonline.com/?portal=oreilly"><i>Safari&#160;Books&#160;Online</i></a></p>
<p style="position:absolute;top:516px;left:351px;white-space:nowrap" class="ft1814"><a href="http://my.safaribooksonline.com/?portal=oreilly">&#160;</a>is&#160;an&#160;on-demand&#160;digital&#160;library&#160;that</p>
<p style="position:absolute;top:535px;left:222px;white-space:nowrap" class="ft1814">delivers&#160;expert&#160;<a href="http://www.safaribooksonline.com/content">content</a>&#160;in&#160;both&#160;book&#160;and&#160;video&#160;form&#160;from</p>
<p style="position:absolute;top:554px;left:222px;white-space:nowrap" class="ft1814">the&#160;world’s&#160;leading&#160;authors&#160;in&#160;technology&#160;and&#160;business.</p>
<p style="position:absolute;top:582px;left:108px;white-space:nowrap" class="ft1814">Technology professionals, software developers, web designers, and business and crea‐</p>
<p style="position:absolute;top:601px;left:108px;white-space:nowrap" class="ft1814">tive professionals use Safari Books Online as their primary resource for research, prob‐</p>
<p style="position:absolute;top:620px;left:108px;white-space:nowrap" class="ft1815">lem solving, learning, and certification training.<br/>Safari Books Online offers a range of&#160;<a href="http://www.safaribooksonline.com/subscriptions">product mixes&#160;</a><a href="http://www.safaribooksonline.com/organizations-teams">and pricing programs for&#160;organi‐</a></p>
<p style="position:absolute;top:667px;left:108px;white-space:nowrap" class="ft1817"><a href="http://www.safaribooksonline.com/organizations-teams">zations,&#160;</a><a href="http://www.safaribooksonline.com/government">government agencies, and&#160;</a><a href="http://www.safaribooksonline.com/individuals">individuals. Subscribers ha</a>ve access to thousands of</p>
<p style="position:absolute;top:686px;left:108px;white-space:nowrap" class="ft1814">books, training videos, and prepublication manuscripts in one fully searchable database</p>
<p style="position:absolute;top:705px;left:108px;white-space:nowrap" class="ft1814">from publishers like O’Reilly Media, Prentice Hall Professional, Addison-Wesley Pro‐</p>
<p style="position:absolute;top:723px;left:108px;white-space:nowrap" class="ft1814">fessional, Microsoft Press, Sams, Que, Peachpit Press, Focal Press, Cisco Press, John</p>
<p style="position:absolute;top:742px;left:108px;white-space:nowrap" class="ft1814">Wiley &amp; Sons, Syngress, Morgan Kaufmann, IBM Redbooks, Packt, Adobe Press, FT</p>
<p style="position:absolute;top:761px;left:108px;white-space:nowrap" class="ft1814">Press, Apress, Manning, New Riders, McGraw-Hill, Jones &amp; Bartlett, Course Technol‐</p>
<p style="position:absolute;top:780px;left:108px;white-space:nowrap" class="ft1814">ogy, and dozens&#160;<a href="http://www.safaribooksonline.com/publishers">more</a>. For more information about Safari Books Online, please visit us</p>
<p style="position:absolute;top:799px;left:108px;white-space:nowrap" class="ft1817"><a href="http://www.safaribooksonline.com/">online</a>.</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft185"><b>xvi&#160;&#160;|&#160;&#160;Preface</b></p>
</div>
<!-- Page 19 -->
<a name="19"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft1926{font-size:13px;line-height:27px;font-family:Times;color:#990000;}
-->
</style>
<div id="page19-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask019.png" alt="background image"/>
<p style="position:absolute;top:74px;left:108px;white-space:nowrap" class="ft1918"><b>How to Contact Us<br/></b>Please address comments and questions concerning this book to the publisher:</p>
<p style="position:absolute;top:149px;left:135px;white-space:nowrap" class="ft1914">O’Reilly&#160;Media,&#160;Inc.</p>
<p style="position:absolute;top:167px;left:135px;white-space:nowrap" class="ft1914">1005&#160;Gravenstein&#160;Highway&#160;North</p>
<p style="position:absolute;top:186px;left:135px;white-space:nowrap" class="ft1914">Sebastopol,&#160;CA&#160;95472</p>
<p style="position:absolute;top:205px;left:135px;white-space:nowrap" class="ft1914">800-998-9938&#160;(in&#160;the&#160;United&#160;States&#160;or&#160;Canada)</p>
<p style="position:absolute;top:224px;left:135px;white-space:nowrap" class="ft1914">707-829-0515&#160;(international&#160;or&#160;local)</p>
<p style="position:absolute;top:243px;left:135px;white-space:nowrap" class="ft1914">707-829-0104&#160;(fax)</p>
<p style="position:absolute;top:277px;left:108px;white-space:nowrap" class="ft1914">We have a web page for this book, where we list errata, examples, and any additional</p>
<p style="position:absolute;top:296px;left:108px;white-space:nowrap" class="ft1915">information. You can access this page a<a href="http://www.bit.ly/flask-web-dev">t&#160;<i>http://www.bit.ly/flask-web-dev</i></a>.<br/>To commen<a href="mailto:bookquestions@oreilly.com">t or ask technical questions about this book, send email to&#160;<i>bookques</i></a></p>
<p style="position:absolute;top:344px;left:108px;white-space:nowrap" class="ft1920"><a href="mailto:bookquestions@oreilly.com"><i>tions@oreilly.com</i></a></p>
<p style="position:absolute;top:343px;left:218px;white-space:nowrap" class="ft1914"><a href="mailto:bookquestions@oreilly.com">.</a></p>
<p style="position:absolute;top:371px;left:108px;white-space:nowrap" class="ft1914">For more information about our books, courses, conferences, and news, see our website</p>
<p style="position:absolute;top:389px;left:108px;white-space:nowrap" class="ft1926">at&#160;<a href="http://www.oreilly.com"><i>http://www.oreilly.com</i>.<br/></a>Find us on F<a href="http://facebook.com/oreilly">acebook:&#160;<i>http://facebook.com/oreilly<br/></i></a>Follow us on Twitter:&#160;<a href="http://twitter.com/oreillymedia"><i>http://twitter.com/oreillymedia<br/></i></a>Watch us on YouTube:&#160;<a href="http://www.youtube.com/oreillymedia"><i>http://www.youtube.com/oreillymedia</i></a></p>
<p style="position:absolute;top:509px;left:108px;white-space:nowrap" class="ft1918"><b>Acknowledgments<br/></b>I could not have written this book alone. I have received a lot of help from family, co-</p>
<p style="position:absolute;top:569px;left:108px;white-space:nowrap" class="ft1915">workers, old friends, and new friends I’ve made along the way.<br/>I’d like to thank Brendan Kohler for his detailed technical review and for his help in</p>
<p style="position:absolute;top:615px;left:108px;white-space:nowrap" class="ft1914">giving shape to the chapter on Application Programming Interfaces. I’m also in debt to</p>
<p style="position:absolute;top:634px;left:108px;white-space:nowrap" class="ft1914">David Baumgold, Todd Brunhoff, Cecil Rock, and Matthew Hugues, who reviewed the</p>
<p style="position:absolute;top:653px;left:108px;white-space:nowrap" class="ft1914">manuscript at different stages of completion and gave me very useful advice regarding</p>
<p style="position:absolute;top:672px;left:108px;white-space:nowrap" class="ft1915">what to cover and how to organize the material.<br/>Writing the code examples for this book was a considerable effort. I appreciate the help</p>
<p style="position:absolute;top:719px;left:108px;white-space:nowrap" class="ft1914">of Daniel Hofmann, who did a thorough code review of the application and pointed out</p>
<p style="position:absolute;top:738px;left:108px;white-space:nowrap" class="ft1914">several improvements. I’m also thankful to my teenage son, Dylan Grinberg, who sus‐</p>
<p style="position:absolute;top:757px;left:108px;white-space:nowrap" class="ft1914">pended his Minecraft addiction for a few weekends and helped me test the code under</p>
<p style="position:absolute;top:776px;left:108px;white-space:nowrap" class="ft1915">several platforms.<br/>O’Reilly has a wonderful program called Early Release that allows impatient readers to</p>
<p style="position:absolute;top:822px;left:108px;white-space:nowrap" class="ft1914">have access to books while they are being written. Some of my Early Release readers</p>
<p style="position:absolute;top:841px;left:108px;white-space:nowrap" class="ft1914">went the extra mile and engaged in useful conversations regarding their experience</p>
<p style="position:absolute;top:860px;left:108px;white-space:nowrap" class="ft1914">working through the book, leading to significant improvements. I’d like to acknowledge</p>
<p style="position:absolute;top:915px;left:569px;white-space:nowrap" class="ft195"><b>Preface&#160;&#160;|&#160;&#160;xvii</b></p>
</div>
<!-- Page 20 -->
<a name="20"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page20-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask020.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft2014">Sundeep Gupta, Dan Caron, Brian Wisti and Cody Scott in particular for the contri‐</p>
<p style="position:absolute;top:97px;left:108px;white-space:nowrap" class="ft2015">butions they’ve made to this book.<br/>The staff at O’Reilly Media has always been there for me. Above all I’d like to recognize</p>
<p style="position:absolute;top:144px;left:108px;white-space:nowrap" class="ft2014">my wonderful editor, Meghan Blanchette, for her support, advice, and assistance from</p>
<p style="position:absolute;top:163px;left:108px;white-space:nowrap" class="ft2014">the very first day we met. Meg has made the experience of writing my first book a</p>
<p style="position:absolute;top:182px;left:108px;white-space:nowrap" class="ft2015">memorable one.<br/>To conclude, I would like to give a big thank you to the awesome Flask community.</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft205"><b>xviii&#160;&#160;|&#160;&#160;Preface</b></p>
</div>
<!-- Page 21 -->
<a name="21"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft2127{font-size:40px;font-family:Times;color:#231f20;}
-->
</style>
<div id="page21-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask021.png" alt="background image"/>
<p style="position:absolute;top:103px;left:590px;white-space:nowrap" class="ft2116"><b>PART I</b></p>
<p style="position:absolute;top:133px;left:358px;white-space:nowrap" class="ft2127"><b>Introduction to Flask</b></p>
</div>
<!-- Page 22 -->
<a name="22"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page22-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask022.png" alt="background image"/>
</div>
<!-- Page 23 -->
<a name="23"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft2328{font-size:23px;font-family:Times;color:#231f20;}
-->
</style>
<div id="page23-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask023.png" alt="background image"/>
<p style="position:absolute;top:104px;left:559px;white-space:nowrap" class="ft2328"><b>CHAPTER 1</b></p>
<p style="position:absolute;top:131px;left:504px;white-space:nowrap" class="ft2311"><b>Installation</b></p>
<p style="position:absolute;top:345px;left:108px;white-space:nowrap" class="ft2317"><a href="http://flask.pocoo.org/">Flask&#160;is a small framework by most standards, small enough to be called a “</a>micro-</p>
<p style="position:absolute;top:364px;left:108px;white-space:nowrap" class="ft2314">framework.” It is small enough that once you become familiar with it, you will likely be</p>
<p style="position:absolute;top:383px;left:108px;white-space:nowrap" class="ft2315">able to read and understand all of its source code.<br/>But being small does not mean that it does less than other frameworks. Flask was de‐</p>
<p style="position:absolute;top:430px;left:108px;white-space:nowrap" class="ft2314">signed as an extensible framework from the ground up; it provides a solid core with the</p>
<p style="position:absolute;top:449px;left:108px;white-space:nowrap" class="ft2314">basic services, while&#160;<i>extensions</i>&#160;provide the rest. Because you can pick and choose the</p>
<p style="position:absolute;top:468px;left:108px;white-space:nowrap" class="ft2314">extension packages that you want, you end up with a lean stack that has no bloat and</p>
<p style="position:absolute;top:487px;left:108px;white-space:nowrap" class="ft2315">does exactly what you need.<br/>Flask has two main dependencies. The routing, debugging, and Web Server Gateway</p>
<p style="position:absolute;top:533px;left:108px;white-space:nowrap" class="ft2314">Interface (W<a href="http://werkzeug.pocoo.org/">SGI) subsystems come from&#160;Werkzeug, while tem</a>plate support is provided</p>
<p style="position:absolute;top:552px;left:108px;white-space:nowrap" class="ft2315">by&#160;<a href="http://jinja.pocoo.org/">Jinja2. W</a>erkzeug and Jinja2 are authored by the core developer of Flask.&#160;<br/>There is no native support in Flask for accessing databases, validating web forms, au‐</p>
<p style="position:absolute;top:599px;left:108px;white-space:nowrap" class="ft2314">thenticating users, or other high-level tasks. These and many other key services most</p>
<p style="position:absolute;top:618px;left:108px;white-space:nowrap" class="ft2314">web applications need are available through extensions that integrate with the core</p>
<p style="position:absolute;top:637px;left:108px;white-space:nowrap" class="ft2314">packages. As a developer, you have the power to cherry-pick the extensions that work</p>
<p style="position:absolute;top:656px;left:108px;white-space:nowrap" class="ft2314">best for your project or even write your own if you feel inclined to. This is in contrast</p>
<p style="position:absolute;top:675px;left:108px;white-space:nowrap" class="ft2314">with a larger framework, where most choices have been made for you and are hard or</p>
<p style="position:absolute;top:694px;left:108px;white-space:nowrap" class="ft2315">sometimes impossible to change.<br/>In this chapter, you will learn how to install Flask. The only requirement you need is a</p>
<p style="position:absolute;top:740px;left:108px;white-space:nowrap" class="ft2314">computer with Python installed.</p>
<p style="position:absolute;top:780px;left:198px;white-space:nowrap" class="ft2325">The&#160;code&#160;examples&#160;in&#160;this&#160;book&#160;have&#160;been&#160;verified&#160;to&#160;work&#160;with</p>
<p style="position:absolute;top:797px;left:198px;white-space:nowrap" class="ft2325">Python&#160;2.7&#160;and&#160;Python&#160;3.3,&#160;so&#160;using&#160;one&#160;of&#160;these&#160;two&#160;versions&#160;is</p>
<p style="position:absolute;top:814px;left:198px;white-space:nowrap" class="ft2325">strongly&#160;recommended.</p>
<p style="position:absolute;top:915px;left:642px;white-space:nowrap" class="ft235"><b>3</b></p>
</div>
<!-- Page 24 -->
<a name="24"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft2429{font-size:10px;font-family:Times;color:#000099;}
	.ft2430{font-size:11px;font-family:Times;color:#231f20;}
	.ft2431{font-size:12px;line-height:20px;font-family:Times;color:#231f20;}
-->
</style>
<div id="page24-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask024.png" alt="background image"/>
<p style="position:absolute;top:74px;left:108px;white-space:nowrap" class="ft2418"><b>Using Virtual Environments<br/></b>The most convenient way to install Flask is to use a virtual environment. A virtual</p>
<p style="position:absolute;top:134px;left:108px;white-space:nowrap" class="ft2414">environment is a private copy of the Python interpreter onto which you can install</p>
<p style="position:absolute;top:152px;left:108px;white-space:nowrap" class="ft2414">packages privately, without affecting the global Python interpreter installed in your</p>
<p style="position:absolute;top:171px;left:108px;white-space:nowrap" class="ft2415">system.<br/>Virtual environments are very useful because they prevent package clutter and version</p>
<p style="position:absolute;top:218px;left:108px;white-space:nowrap" class="ft2414">conflicts in the system’s Python interpreter. Creating a virtual environment for each</p>
<p style="position:absolute;top:237px;left:108px;white-space:nowrap" class="ft2414">application ensures that applications have access to only the packages that they use,</p>
<p style="position:absolute;top:256px;left:108px;white-space:nowrap" class="ft2414">while the global interpreter remains neat and clean and serves only as a source from</p>
<p style="position:absolute;top:275px;left:108px;white-space:nowrap" class="ft2414">which more virtual environments can be created. As an added benefit, virtual environ‐</p>
<p style="position:absolute;top:294px;left:108px;white-space:nowrap" class="ft2415">ments don’t require administrator rights.<br/>Virtual environments are created with the third-party&#160;<i>virtualenv</i>&#160;utility. To check</p>
<p style="position:absolute;top:341px;left:108px;white-space:nowrap" class="ft2414">whether you have it installed in your system, type the following command:</p>
<p style="position:absolute;top:372px;left:134px;white-space:nowrap" class="ft2429"><b>$</b>&#160;virtualenv --version</p>
<p style="position:absolute;top:393px;left:108px;white-space:nowrap" class="ft2414">If you get an error, you will have to install the utility.</p>
<p style="position:absolute;top:432px;left:198px;white-space:nowrap" class="ft2425">Python&#160;3.3&#160;adds&#160;native&#160;support&#160;of&#160;virtual&#160;environments&#160;through&#160;the</p>
<p style="position:absolute;top:450px;left:198px;white-space:nowrap" class="ft2425">venv&#160;module&#160;and&#160;the&#160;pyvenv&#160;command.&#160;pyvenv&#160;can&#160;be&#160;used&#160;instead</p>
<p style="position:absolute;top:467px;left:198px;white-space:nowrap" class="ft2425">of&#160;virtualenv,&#160;but&#160;note&#160;that&#160;virtual&#160;environments&#160;created&#160;with&#160;py‐</p>
<p style="position:absolute;top:485px;left:198px;white-space:nowrap" class="ft2425">venv&#160;on&#160;Python&#160;3.3&#160;do&#160;not&#160;include&#160;pip,&#160;which&#160;needs&#160;to&#160;be&#160;installed</p>
<p style="position:absolute;top:502px;left:198px;white-space:nowrap" class="ft2431">manually.&#160;This&#160;limitation&#160;has&#160;been&#160;removed&#160;in&#160;Python&#160;3.4,&#160;where<br/>pyvenv</p>
<p style="position:absolute;top:520px;left:239px;white-space:nowrap" class="ft2425">&#160;can&#160;be&#160;used&#160;as&#160;a&#160;complete&#160;virtualenv&#160;replacement.</p>
<p style="position:absolute;top:566px;left:108px;white-space:nowrap" class="ft2414">Most Linux distributions provide a package for virtualenv. For example, Ubuntu users</p>
<p style="position:absolute;top:585px;left:108px;white-space:nowrap" class="ft2414">can install it with this command:</p>
<p style="position:absolute;top:616px;left:134px;white-space:nowrap" class="ft2421">$&#160;sudo apt-get install python-virtualenv</p>
<p style="position:absolute;top:637px;left:108px;white-space:nowrap" class="ft2414">If you are using Mac OS X, then you can install virtualenv using easy_install:</p>
<p style="position:absolute;top:669px;left:134px;white-space:nowrap" class="ft2421">$&#160;sudo easy_install virtualenv</p>
<p style="position:absolute;top:689px;left:108px;white-space:nowrap" class="ft2414">If you are using Microsoft Windows or any operating system that does not provide an</p>
<p style="position:absolute;top:708px;left:108px;white-space:nowrap" class="ft2415">official virtualenv package, then you have a slightly more complicated install procedure.<br/>Using your web browser, navigate to&#160;<i>https://bitbucket.org/pypa/setuptools</i>, the home of</p>
<p style="position:absolute;top:756px;left:108px;white-space:nowrap" class="ft2414">the&#160;setuptools&#160;installer. In that page, look for a link to download the installer script.</p>
<p style="position:absolute;top:775px;left:108px;white-space:nowrap" class="ft2414">This is a script called&#160;<i>ez_setup.py</i>. Save this file to a temporary folder on your computer,</p>
<p style="position:absolute;top:793px;left:108px;white-space:nowrap" class="ft2414">then run the following commands in that folder:</p>
<p style="position:absolute;top:825px;left:133px;white-space:nowrap" class="ft2423">$&#160;python ez_setup.py<br/>$&#160;easy_install virtualenv</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft245"><b>4&#160;&#160;|&#160;&#160;Chapter 1: Installation</b></p>
</div>
<!-- Page 25 -->
<a name="25"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft2532{font-size:10px;font-family:Times;color:#336666;}
	.ft2533{font-size:10px;font-family:Times;color:#555555;}
	.ft2534{font-size:10px;font-family:Times;color:#aa0000;}
-->
</style>
<div id="page25-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask025.png" alt="background image"/>
<p style="position:absolute;top:83px;left:198px;white-space:nowrap" class="ft2525">The&#160;previous&#160;commands&#160;must&#160;be&#160;issued&#160;from&#160;an&#160;account&#160;with&#160;ad‐</p>
<p style="position:absolute;top:100px;left:198px;white-space:nowrap" class="ft2525">ministrator&#160;rights.&#160;On&#160;Microsoft&#160;Windows,&#160;start&#160;the&#160;command</p>
<p style="position:absolute;top:118px;left:198px;white-space:nowrap" class="ft2525">prompt&#160;window&#160;using&#160;the&#160;“Run&#160;as&#160;Administrator”&#160;option.&#160;On&#160;Unix-</p>
<p style="position:absolute;top:135px;left:198px;white-space:nowrap" class="ft2531">based&#160;systems,&#160;the&#160;two&#160;installation&#160;commands&#160;must&#160;be&#160;preceded&#160;with<br/>sudo</p>
<p style="position:absolute;top:153px;left:225px;white-space:nowrap" class="ft2525">&#160;or&#160;executed&#160;as&#160;the&#160;root&#160;user.&#160;Once&#160;installed,&#160;the&#160;virtualenv&#160;util‐</p>
<p style="position:absolute;top:170px;left:198px;white-space:nowrap" class="ft2525">ity&#160;can&#160;be&#160;invoked&#160;from&#160;regular&#160;accounts.</p>
<p style="position:absolute;top:216px;left:108px;white-space:nowrap" class="ft2514">Now you need to create the folder that will host the example code, which is available</p>
<p style="position:absolute;top:235px;left:108px;white-space:nowrap" class="ft2514">from a GitHub repository. As discussed in&#160;<a href="Flask.html#15">“How to Work with the Example Code ”&#160;on</a></p>
<p style="position:absolute;top:254px;left:108px;white-space:nowrap" class="ft2517"><a href="Flask.html#15">page xiii, the most con</a>venient way to do this is by checking out the code directly from</p>
<p style="position:absolute;top:273px;left:108px;white-space:nowrap" class="ft2514">GitHub using a Git client. The following commands download the example code from</p>
<p style="position:absolute;top:292px;left:108px;white-space:nowrap" class="ft2514">GitHub and initialize the application folder to version “1a,” the initial version of the</p>
<p style="position:absolute;top:310px;left:108px;white-space:nowrap" class="ft2514">application:</p>
<p style="position:absolute;top:342px;left:134px;white-space:nowrap" class="ft2523">$&#160;git clone https://github.com/miguelgrinberg/flasky.git<br/>$&#160;cd&#160;flasky<br/>$&#160;git checkout 1a</p>
<p style="position:absolute;top:393px;left:108px;white-space:nowrap" class="ft2514">The next step is to create the Python virtual environment inside the&#160;<i>flasky</i>&#160;folder using</p>
<p style="position:absolute;top:412px;left:108px;white-space:nowrap" class="ft2514">the virtualenv command. This command has a single required argument: the name of</p>
<p style="position:absolute;top:431px;left:108px;white-space:nowrap" class="ft2514">the virtual environment. A folder with the chosen name will be created in the current</p>
<p style="position:absolute;top:450px;left:108px;white-space:nowrap" class="ft2514">directory and all files associated with the virtual environment will be inside. A com‐</p>
<p style="position:absolute;top:469px;left:108px;white-space:nowrap" class="ft2514">monly used naming convention for virtual environments is to call them&#160;<i>venv</i>:</p>
<p style="position:absolute;top:501px;left:134px;white-space:nowrap" class="ft2523">$&#160;virtualenv venv<br/>New python executable in venv/bin/python2.7<br/>Also creating executable in venv/bin/python<br/>Installing setuptools............done.<br/>Installing pip...............done.</p>
<p style="position:absolute;top:582px;left:108px;white-space:nowrap" class="ft2514">Now you have a&#160;<i>venv</i>&#160;folder inside the&#160;<i>flasky</i>&#160;folder with a brand-new virtual environ‐</p>
<p style="position:absolute;top:601px;left:108px;white-space:nowrap" class="ft2514">ment that contains a private Python interpreter. To start using the virtual environment,</p>
<p style="position:absolute;top:620px;left:108px;white-space:nowrap" class="ft2514">you have to “activate” it. If you are using a bash command line (Linux and Mac OS X</p>
<p style="position:absolute;top:639px;left:108px;white-space:nowrap" class="ft2514">users), you can activate the virtual environment with this command:</p>
<p style="position:absolute;top:671px;left:133px;white-space:nowrap" class="ft2521">$&#160;source&#160;venv/bin/activate</p>
<p style="position:absolute;top:691px;left:108px;white-space:nowrap" class="ft2514">If you are using Microsoft Windows, the activation command is:</p>
<p style="position:absolute;top:723px;left:134px;white-space:nowrap" class="ft253">$ venv\Scripts\activate</p>
<p style="position:absolute;top:743px;left:108px;white-space:nowrap" class="ft2514">When a virtual environment is activated, the location of its Python interpreter is added</p>
<p style="position:absolute;top:763px;left:108px;white-space:nowrap" class="ft2514">to the&#160;PATH, but this change is not permanent; it affects only your current command</p>
<p style="position:absolute;top:782px;left:108px;white-space:nowrap" class="ft2514">session. To remind you that you have activated a virtual environment, the activation</p>
<p style="position:absolute;top:801px;left:108px;white-space:nowrap" class="ft2514">command modifies the command prompt to include the name of the environment:</p>
<p style="position:absolute;top:833px;left:134px;white-space:nowrap" class="ft2533">(venv)&#160;$</p>
<p style="position:absolute;top:915px;left:491px;white-space:nowrap" class="ft255"><b>Using Virtual Environments&#160;&#160;|&#160;&#160;5</b></p>
</div>
<!-- Page 26 -->
<a name="26"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft2635{font-size:12px;font-family:Times;color:#990000;}
	.ft2636{font-size:10px;font-family:Times;color:#000000;}
	.ft2637{font-size:10px;font-family:Times;color:#000088;}
	.ft2638{font-size:10px;font-family:Times;color:#006699;}
	.ft2639{font-size:10px;font-family:Times;color:#00ccff;}
	.ft2640{font-size:10px;line-height:15px;font-family:Times;color:#000088;}
	.ft2641{font-size:10px;line-height:15px;font-family:Times;color:#00ccff;}
-->
</style>
<div id="page26-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask026.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft2614">When you are done working with the virtual environment and want to return to the</p>
<p style="position:absolute;top:98px;left:108px;white-space:nowrap" class="ft2614">global Python interpreter, type&#160;deactivate&#160;at the command prompt.</p>
<p style="position:absolute;top:135px;left:108px;white-space:nowrap" class="ft2622"><b>Installing Python Packages with pip&#160;<br/></b>Most Python packages are installed with the&#160;<i>pip</i>&#160;utility, which virtualenv automatically</p>
<p style="position:absolute;top:196px;left:108px;white-space:nowrap" class="ft2614">adds to all virtual environments upon creation. When a virtual environment is activated,</p>
<p style="position:absolute;top:216px;left:108px;white-space:nowrap" class="ft2614">the location of the pip utility is added to the&#160;PATH.</p>
<p style="position:absolute;top:255px;left:198px;white-space:nowrap" class="ft2625">If&#160;you&#160;created&#160;the&#160;virtual&#160;environment&#160;with&#160;pyvenv&#160;under&#160;Python&#160;3.3,</p>
<p style="position:absolute;top:272px;left:198px;white-space:nowrap" class="ft2625">then&#160;pip&#160;must&#160;be&#160;installed&#160;manually.&#160;Installation&#160;instructions&#160;are</p>
<p style="position:absolute;top:290px;left:198px;white-space:nowrap" class="ft2625">available&#160;on&#160;the&#160;<a href="http://bit.ly/pip-install">pip&#160;website</a>.&#160;Under&#160;Python&#160;3.4,&#160;pyvenv&#160;installs&#160;pip</p>
<p style="position:absolute;top:307px;left:198px;white-space:nowrap" class="ft2625">automatically.</p>
<p style="position:absolute;top:360px;left:108px;white-space:nowrap" class="ft2614">To install Flask into the virtual environment, use the following command:</p>
<p style="position:absolute;top:392px;left:133px;white-space:nowrap" class="ft2633">(venv)&#160;$&#160;pip install flask</p>
<p style="position:absolute;top:412px;left:108px;white-space:nowrap" class="ft2614">With this command, Flask and its dependencies are installed in the virtual environment.</p>
<p style="position:absolute;top:431px;left:108px;white-space:nowrap" class="ft2614">You can verify that Flask was installed correctly by starting the Python interpreter and</p>
<p style="position:absolute;top:450px;left:108px;white-space:nowrap" class="ft2614">trying to import it:</p>
<p style="position:absolute;top:482px;left:133px;white-space:nowrap" class="ft2641">(venv)&#160;$&#160;python<br/>&gt;&gt;&gt;&#160;<b>import</b>&#160;<b>flask<br/></b>&gt;&gt;&gt;</p>
<p style="position:absolute;top:533px;left:108px;white-space:nowrap" class="ft2614">If no errors appear, you can congratulate yourself: you are ready for the next chapter,</p>
<p style="position:absolute;top:552px;left:108px;white-space:nowrap" class="ft2614">where you will write your first web application.</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft265"><b>6&#160;&#160;|&#160;&#160;Chapter 1: Installation</b></p>
</div>
<!-- Page 27 -->
<a name="27"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft2742{font-size:12px;font-family:Times;color:#231f20;}
-->
</style>
<div id="page27-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask027.png" alt="background image"/>
<p style="position:absolute;top:104px;left:559px;white-space:nowrap" class="ft2728"><b>CHAPTER 2</b></p>
<p style="position:absolute;top:131px;left:314px;white-space:nowrap" class="ft2711"><b>Basic Application Structure</b></p>
<p style="position:absolute;top:345px;left:108px;white-space:nowrap" class="ft2714">In this chapter, you will learn about the different parts of a Flask application. You will</p>
<p style="position:absolute;top:364px;left:108px;white-space:nowrap" class="ft2714">also write and run your first Flask web application.</p>
<p style="position:absolute;top:401px;left:108px;white-space:nowrap" class="ft2722"><b>Initialization&#160;<br/></b>All Flask applications must create an&#160;<i>application instance</i>. The web server passes all</p>
<p style="position:absolute;top:462px;left:108px;white-space:nowrap" class="ft2714">requests it receives from clients to this object for handling, using a protocol called Web</p>
<p style="position:absolute;top:482px;left:108px;white-space:nowrap" class="ft2714">Server Gateway Interface (WSGI). The application instance is an object of class&#160;Flask,</p>
<p style="position:absolute;top:501px;left:108px;white-space:nowrap" class="ft2714">usually created as follows:</p>
<p style="position:absolute;top:532px;left:134px;white-space:nowrap" class="ft2740"><b>from</b>&#160;<b>flask</b>&#160;<b>import</b>&#160;Flask<br/>app&#160;=&#160;Flask(__name__)</p>
<p style="position:absolute;top:569px;left:108px;white-space:nowrap" class="ft2714">The only required argument to the&#160;Flask&#160;class constructor is the name of the main</p>
<p style="position:absolute;top:589px;left:108px;white-space:nowrap" class="ft2714">module or package of the application. For most applications, Python’s&#160;__name__&#160;variable</p>
<p style="position:absolute;top:608px;left:108px;white-space:nowrap" class="ft2714">is the correct value.</p>
<p style="position:absolute;top:649px;left:198px;white-space:nowrap" class="ft2725">The&#160;<i>name</i>&#160;argument&#160;that&#160;is&#160;passed&#160;to&#160;the&#160;Flask&#160;application&#160;construc‐</p>
<p style="position:absolute;top:667px;left:198px;white-space:nowrap" class="ft2725">tor&#160;is&#160;a&#160;source&#160;of&#160;confusion&#160;among&#160;new&#160;Flask&#160;developers.&#160;Flask&#160;uses</p>
<p style="position:absolute;top:684px;left:198px;white-space:nowrap" class="ft2725">this&#160;argument&#160;to&#160;determine&#160;the&#160;root&#160;path&#160;of&#160;the&#160;application&#160;so&#160;that&#160;it</p>
<p style="position:absolute;top:701px;left:198px;white-space:nowrap" class="ft2725">later&#160;can&#160;find&#160;resource&#160;files&#160;relative&#160;to&#160;the&#160;location&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:756px;left:108px;white-space:nowrap" class="ft2714">Later you will see more complex examples of application initialization, but for simple</p>
<p style="position:absolute;top:774px;left:108px;white-space:nowrap" class="ft2714">applications this is all that is needed.</p>
<p style="position:absolute;top:915px;left:642px;white-space:nowrap" class="ft275"><b>7</b></p>
</div>
<!-- Page 28 -->
<a name="28"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft2843{font-size:10px;font-family:Times;color:#9999ff;}
	.ft2844{font-size:10px;font-family:Times;color:#cc3300;}
	.ft2845{font-size:10px;font-family:Times;color:#cc00ff;}
	.ft2846{font-size:13px;line-height:22px;font-family:Times;color:#231f20;}
	.ft2847{font-size:10px;line-height:15px;font-family:Times;color:#000000;}
	.ft2848{font-size:13px;line-height:28px;font-family:Times;color:#231f20;}
-->
</style>
<div id="page28-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask028.png" alt="background image"/>
<p style="position:absolute;top:75px;left:108px;white-space:nowrap" class="ft2822"><b>Routes and View Functions<br/></b>Clients such as web browsers send&#160;<i>requests</i>&#160;to the web server, which in turn sends them</p>
<p style="position:absolute;top:136px;left:108px;white-space:nowrap" class="ft2814">to the Flask application instance. The application instance needs to know what code</p>
<p style="position:absolute;top:155px;left:108px;white-space:nowrap" class="ft2814">needs to run for each URL requested, so it keeps a mapping of URLs to Python functions.</p>
<p style="position:absolute;top:174px;left:108px;white-space:nowrap" class="ft2846">The association between a URL and the function that handles it is called a&#160;<i>route</i>.<br/>The most convenient way to define a route in a Flask application is through the<br/>app.route</p>
<p style="position:absolute;top:221px;left:176px;white-space:nowrap" class="ft2814">&#160;decorator exposed by the application instance, which registers the decorated</p>
<p style="position:absolute;top:240px;left:108px;white-space:nowrap" class="ft2814">function as a route. The following example shows how a route is declared using this</p>
<p style="position:absolute;top:259px;left:108px;white-space:nowrap" class="ft2814">decorator:</p>
<p style="position:absolute;top:291px;left:133px;white-space:nowrap" class="ft2847">@app.route('/')<br/><b>def</b>&#160;index():<br/>&#160; &#160;&#160;<b>return</b>&#160;'&lt;h1&gt;Hello World!&lt;/h1&gt;'</p>
<p style="position:absolute;top:353px;left:198px;white-space:nowrap" class="ft2825">Decorators&#160;are&#160;a&#160;standard&#160;feature&#160;of&#160;the&#160;Python&#160;language;&#160;they&#160;can</p>
<p style="position:absolute;top:371px;left:198px;white-space:nowrap" class="ft2825">modify&#160;the&#160;behavior&#160;of&#160;a&#160;function&#160;in&#160;different&#160;ways.&#160;A&#160;common&#160;pat‐</p>
<p style="position:absolute;top:388px;left:198px;white-space:nowrap" class="ft2825">tern&#160;is&#160;to&#160;use&#160;decorators&#160;to&#160;register&#160;functions&#160;as&#160;handlers&#160;for&#160;an&#160;event.</p>
<p style="position:absolute;top:459px;left:108px;white-space:nowrap" class="ft2814">The previous example registers the function&#160;index()&#160;as the handler for the application’s</p>
<p style="position:absolute;top:478px;left:108px;white-space:nowrap" class="ft2814">root URL. If this application were deployed on a server associated with the&#160;<i>www.ex‐</i></p>
<p style="position:absolute;top:498px;left:108px;white-space:nowrap" class="ft2810"><i>ample.com</i></p>
<p style="position:absolute;top:497px;left:176px;white-space:nowrap" class="ft2814">&#160;domain name, then navigating to&#160;<i>http://www.example.com</i>&#160;on your browser</p>
<p style="position:absolute;top:517px;left:108px;white-space:nowrap" class="ft2814">would trigger&#160;index()&#160;to run on the server. The return value of this function, called the</p>
<p style="position:absolute;top:537px;left:108px;white-space:nowrap" class="ft2810"><i>response</i></p>
<p style="position:absolute;top:536px;left:160px;white-space:nowrap" class="ft2814">, is what the client receives. If the client is a web browser, the response is the</p>
<p style="position:absolute;top:555px;left:108px;white-space:nowrap" class="ft2848">document that is displayed to the user.<br/>Functions like&#160;index()&#160;are called&#160;<i>view functions</i>. A response returned by a view function</p>
<p style="position:absolute;top:602px;left:108px;white-space:nowrap" class="ft2814">can be a simple string with HTML content, but it can also take more complex forms, as</p>
<p style="position:absolute;top:621px;left:108px;white-space:nowrap" class="ft2814">you will see later.</p>
<p style="position:absolute;top:661px;left:198px;white-space:nowrap" class="ft2825">Response&#160;strings&#160;embedded&#160;in&#160;Python&#160;code&#160;lead&#160;to&#160;code&#160;that&#160;is&#160;dif‐</p>
<p style="position:absolute;top:678px;left:198px;white-space:nowrap" class="ft2825">ficult&#160;to&#160;maintain,&#160;and&#160;it&#160;is&#160;done&#160;here&#160;only&#160;to&#160;introduce&#160;the&#160;concept</p>
<p style="position:absolute;top:695px;left:198px;white-space:nowrap" class="ft2825">of&#160;responses.&#160;You&#160;will&#160;learn&#160;the&#160;proper&#160;way&#160;to&#160;generate&#160;responses&#160;in</p>
<p style="position:absolute;top:712px;left:198px;white-space:nowrap" class="ft2835"><a href="Flask.html#41">Chapter&#160;3</a>.</p>
<p style="position:absolute;top:765px;left:108px;white-space:nowrap" class="ft2814">If you pay attention to how some URLs for services that you use every day are formed,</p>
<p style="position:absolute;top:784px;left:108px;white-space:nowrap" class="ft2814">you will notice that many have variable sections. For example, the URL for your Face‐</p>
<p style="position:absolute;top:803px;left:108px;white-space:nowrap" class="ft2814">book profile page is&#160;<i>http://www.facebook.com/&lt;your-name&gt;</i>, so your username is part</p>
<p style="position:absolute;top:823px;left:108px;white-space:nowrap" class="ft2814">of it. Flask supports these types of URLs using a special syntax in the&#160;route&#160;decorator.</p>
<p style="position:absolute;top:842px;left:108px;white-space:nowrap" class="ft2814">The following example defines a route that has a dynamic name component:&#160;</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft285"><b>8&#160;&#160;|&#160;&#160;Chapter 2: Basic Application Structure</b></p>
</div>
<!-- Page 29 -->
<a name="29"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft2949{font-size:26px;line-height:42px;font-family:Times;color:#231f20;}
-->
</style>
<div id="page29-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask029.png" alt="background image"/>
<p style="position:absolute;top:82px;left:134px;white-space:nowrap" class="ft2947">@app.route('/user/&lt;name&gt;')<br/><b>def</b>&#160;user(name):<br/>&#160; &#160;&#160;<b>return</b>&#160;'&lt;h1&gt;Hello,&#160;%s!&lt;/h1&gt;'&#160;%&#160;name</p>
<p style="position:absolute;top:133px;left:108px;white-space:nowrap" class="ft2914">The portion enclosed in angle brackets is the dynamic part, so any URLs that match the</p>
<p style="position:absolute;top:152px;left:108px;white-space:nowrap" class="ft2914">static portions will be mapped to this route. When the view function is invoked, Flask</p>
<p style="position:absolute;top:171px;left:108px;white-space:nowrap" class="ft2914">sends the dynamic component as an argument. In the earlier example view function,</p>
<p style="position:absolute;top:190px;left:108px;white-space:nowrap" class="ft2915">this argument is used to generate a personalized greeting as a response.<br/>The dynamic components in routes are strings by default but can also be defined with</p>
<p style="position:absolute;top:238px;left:108px;white-space:nowrap" class="ft2914">a type. For example, route&#160;/user/&lt;int:id&gt;&#160;would match only URLs that have an integer</p>
<p style="position:absolute;top:258px;left:108px;white-space:nowrap" class="ft2946">in the&#160;id&#160;dynamic segment. Flask supports types&#160;int,&#160;float, and&#160;path&#160;for routes. The<br/>path</p>
<p style="position:absolute;top:277px;left:138px;white-space:nowrap" class="ft2914">&#160;type also represents a string but does not consider slashes as separators and instead</p>
<p style="position:absolute;top:296px;left:108px;white-space:nowrap" class="ft2914">considers them part of the dynamic component.</p>
<p style="position:absolute;top:333px;left:108px;white-space:nowrap" class="ft2949"><b>Server Startup<br/></b>The application instance has a&#160;run&#160;method that launches Flask’s integrated development</p>
<p style="position:absolute;top:395px;left:108px;white-space:nowrap" class="ft2914">web server:</p>
<p style="position:absolute;top:427px;left:133px;white-space:nowrap" class="ft2947"><b>if</b>&#160;__name__&#160;==&#160;'__main__':<br/>&#160; &#160;&#160;app.run(debug=True)</p>
<p style="position:absolute;top:463px;left:108px;white-space:nowrap" class="ft2914">The&#160;__name__ == '__main__'&#160;Python idiom is used here to ensure that the develop‐</p>
<p style="position:absolute;top:482px;left:108px;white-space:nowrap" class="ft2914">ment web server is started only when the script is executed directly. When the script is</p>
<p style="position:absolute;top:501px;left:108px;white-space:nowrap" class="ft2914">imported by another script, it is assumed that the parent script will launch a different</p>
<p style="position:absolute;top:521px;left:108px;white-space:nowrap" class="ft2915">server, so the&#160;app.run()&#160;call is skipped.<br/>Once the server starts up, it goes into a loop that waits for requests and services them.</p>
<p style="position:absolute;top:568px;left:108px;white-space:nowrap" class="ft2948">This loop continues until the application is stopped, for example by hitting Ctrl-C.<br/>There are several option arguments that can be given to&#160;app.run()&#160;to configure the</p>
<p style="position:absolute;top:615px;left:108px;white-space:nowrap" class="ft2914">mode of operation of the web server. During development, it is convenient to enable</p>
<p style="position:absolute;top:634px;left:108px;white-space:nowrap" class="ft2914">debug mode, which among other things activates the&#160;<i>debugger</i>&#160;and the&#160;<i>reloader</i>. This is</p>
<p style="position:absolute;top:654px;left:108px;white-space:nowrap" class="ft2914">done by passing the argument&#160;debug&#160;set to&#160;True.</p>
<p style="position:absolute;top:694px;left:198px;white-space:nowrap" class="ft2925">The&#160;web&#160;server&#160;provided&#160;by&#160;Flask&#160;is&#160;not&#160;intended&#160;for&#160;production&#160;use.</p>
<p style="position:absolute;top:711px;left:198px;white-space:nowrap" class="ft2925">You&#160;will&#160;learn&#160;about&#160;production&#160;web&#160;servers&#160;in&#160;<a href="Flask.html#235">Chapter&#160;17</a>.</p>
<p style="position:absolute;top:794px;left:108px;white-space:nowrap" class="ft2918"><b>A Complete Application<br/></b>In the previous sections, you learned about the different parts of a Flask web application,</p>
<p style="position:absolute;top:853px;left:108px;white-space:nowrap" class="ft2914">and now it is time to write one. The entire&#160;<i>hello.py</i>&#160;application script is nothing more</p>
<p style="position:absolute;top:915px;left:549px;white-space:nowrap" class="ft295"><b>Server Startup&#160;&#160;|&#160;&#160;9</b></p>
</div>
<!-- Page 30 -->
<a name="30"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft3050{font-size:13px;line-height:27px;font-family:Times;color:#231f20;}
-->
</style>
<div id="page30-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask030.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft3014">than the three parts described earlier combined in a single file. The application is shown</p>
<p style="position:absolute;top:97px;left:108px;white-space:nowrap" class="ft3014"><a href="Flask.html#30">in&#160;Example 2-1.</a></p>
<p style="position:absolute;top:129px;left:108px;white-space:nowrap" class="ft3040"><i>Example 2-1. hello.py: A complete Flask application<br/></i><b>from</b>&#160;<b>flask</b>&#160;<b>import</b>&#160;Flask<br/>app&#160;=&#160;Flask(__name__)</p>
<p style="position:absolute;top:203px;left:108px;white-space:nowrap" class="ft3047">@app.route('/')<br/><b>def</b>&#160;index():<br/>&#160; &#160;&#160;<b>return</b>&#160;'&lt;h1&gt;Hello World!&lt;/h1&gt;'</p>
<p style="position:absolute;top:264px;left:108px;white-space:nowrap" class="ft3047"><b>if</b>&#160;__name__&#160;==&#160;'__main__':<br/>&#160; &#160;&#160;app.run(debug=True)</p>
<p style="position:absolute;top:314px;left:198px;white-space:nowrap" class="ft3025">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:332px;left:198px;white-space:nowrap" class="ft3025">now&#160;run&#160;git&#160;checkout&#160;2a&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:420px;left:108px;white-space:nowrap" class="ft3014">To run the application, make sure that the virtual environment you created earlier is</p>
<p style="position:absolute;top:439px;left:108px;white-space:nowrap" class="ft3014">activated and has Flask installed. Now open your web browser and type&#160;<i>http://</i></p>
<p style="position:absolute;top:459px;left:108px;white-space:nowrap" class="ft3010"><i>127.0.0.1:5000/</i></p>
<p style="position:absolute;top:458px;left:203px;white-space:nowrap" class="ft3014">&#160;in the address bar.&#160;<a href="Flask.html#30">Figure 2-1&#160;</a>shows the web browser after connecting</p>
<p style="position:absolute;top:476px;left:108px;white-space:nowrap" class="ft3014">to the application.</p>
<p style="position:absolute;top:817px;left:108px;white-space:nowrap" class="ft3010"><i>Figure 2-1. hello.py Flask application</i></p>
<p style="position:absolute;top:853px;left:108px;white-space:nowrap" class="ft3014">Then launch the application with the following command:</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft305"><b>10&#160;&#160;|&#160;&#160;Chapter 2: Basic Application Structure</b></p>
</div>
<!-- Page 31 -->
<a name="31"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page31-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask031.png" alt="background image"/>
<p style="position:absolute;top:82px;left:134px;white-space:nowrap" class="ft3123">(venv)&#160;$&#160;python hello.py<br/>&#160;* Running on http://127.0.0.1:5000/<br/>&#160;* Restarting with reloader</p>
<p style="position:absolute;top:133px;left:108px;white-space:nowrap" class="ft3114">If you type any other URL, the application will not know how to handle it and will return</p>
<p style="position:absolute;top:152px;left:108px;white-space:nowrap" class="ft3114">an error code 404 to the browser—the familiar error that you get when you navigate to</p>
<p style="position:absolute;top:171px;left:108px;white-space:nowrap" class="ft3115">a web page that does not exist.<br/>The enhanced version of the applica<a href="Flask.html#31">tion shown in&#160;Example 2-2</a>&#160;adds a second route that</p>
<p style="position:absolute;top:218px;left:108px;white-space:nowrap" class="ft3114">is dynamic. When you visit this URL, you are presented with a personalized greeting.</p>
<p style="position:absolute;top:250px;left:108px;white-space:nowrap" class="ft3140"><i>Example 2-2. hello.py: Flask application with a dynamic route<br/></i><b>from</b>&#160;<b>flask</b>&#160;<b>import</b>&#160;Flask<br/>app&#160;=&#160;Flask(__name__)</p>
<p style="position:absolute;top:323px;left:108px;white-space:nowrap" class="ft3147">@app.route('/')<br/><b>def</b>&#160;index():<br/>&#160; &#160;&#160;<b>return</b>&#160;'&lt;h1&gt;Hello World!&lt;/h1&gt;'</p>
<p style="position:absolute;top:385px;left:108px;white-space:nowrap" class="ft3147">@app.route('/user/&lt;name&gt;')<br/><b>def</b>&#160;user(name):<br/>&#160; &#160;&#160;<b>return</b>&#160;'&lt;h1&gt;Hello,&#160;%s!&lt;/h1&gt;'&#160;%&#160;name</p>
<p style="position:absolute;top:446px;left:108px;white-space:nowrap" class="ft3147"><b>if</b>&#160;__name__&#160;==&#160;'__main__':<br/>&#160; &#160;&#160;app.run(debug=True)</p>
<p style="position:absolute;top:495px;left:198px;white-space:nowrap" class="ft3125">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:513px;left:198px;white-space:nowrap" class="ft3125">now&#160;run&#160;git&#160;checkout&#160;2b&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:603px;left:108px;white-space:nowrap" class="ft3146">To test the dynamic route, make sure the server is running and then navigate to&#160;http://<br/>localhost:5000/user/Dave</p>
<p style="position:absolute;top:622px;left:288px;white-space:nowrap" class="ft3114">. The application will respond with a customized greeting,</p>
<p style="position:absolute;top:642px;left:108px;white-space:nowrap" class="ft3114">generated using the&#160;name&#160;dynamic argument. Try different names to see how the view</p>
<p style="position:absolute;top:661px;left:108px;white-space:nowrap" class="ft3114">function always generates the response based on the name given. An example is shown</p>
<p style="position:absolute;top:680px;left:108px;white-space:nowrap" class="ft3114"><a href="Flask.html#31">in&#160;Figure 2-2.</a></p>
<p style="position:absolute;top:915px;left:504px;white-space:nowrap" class="ft315"><b>A Complete Application&#160;&#160;|&#160;&#160;11</b></p>
</div>
<!-- Page 32 -->
<a name="32"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft3251{font-size:21px;font-family:Times;color:#231f20;}
	.ft3252{font-size:21px;line-height:34px;font-family:Times;color:#231f20;}
-->
</style>
<div id="page32-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask032.png" alt="background image"/>
<p style="position:absolute;top:376px;left:108px;white-space:nowrap" class="ft3210"><i>Figure 2-2. Dynamic route</i></p>
<p style="position:absolute;top:411px;left:108px;white-space:nowrap" class="ft3218"><b>The Request-Response Cycle<br/></b>Now that you have played with a basic Flask application, you might want to know more</p>
<p style="position:absolute;top:470px;left:108px;white-space:nowrap" class="ft3214">about how Flask works its magic. The following sections describe some of the design</p>
<p style="position:absolute;top:489px;left:108px;white-space:nowrap" class="ft3214">aspects of the framework.</p>
<p style="position:absolute;top:526px;left:108px;white-space:nowrap" class="ft3252"><b>Application and Request Contexts<br/></b>When Flask receives a request from a client, it needs to make a few objects available to</p>
<p style="position:absolute;top:579px;left:108px;white-space:nowrap" class="ft3214">the view function that will handle it. A good example is the&#160;<i>request object</i>, which en‐</p>
<p style="position:absolute;top:598px;left:108px;white-space:nowrap" class="ft3215">capsulates the HTTP request sent by the client.<br/>The obvious way in which Flask could give a view function access to the request object</p>
<p style="position:absolute;top:645px;left:108px;white-space:nowrap" class="ft3214">is by sending it as an argument, but that would require every single view function in the</p>
<p style="position:absolute;top:664px;left:108px;white-space:nowrap" class="ft3214">application to have an extra argument. Things get more complicated if you consider</p>
<p style="position:absolute;top:683px;left:108px;white-space:nowrap" class="ft3214">that the request object is not the only object that view functions might need to access</p>
<p style="position:absolute;top:702px;left:108px;white-space:nowrap" class="ft3215">to fulfill a request.<br/>To avoid cluttering view functions with lots of arguments that may or may not be needed,</p>
<p style="position:absolute;top:749px;left:108px;white-space:nowrap" class="ft3214">Flask uses&#160;<i>contexts</i>&#160;to temporarily make certain objects globally accessible. Thanks to</p>
<p style="position:absolute;top:767px;left:108px;white-space:nowrap" class="ft3214">contexts, view functions like the following one can be written:</p>
<p style="position:absolute;top:799px;left:134px;white-space:nowrap" class="ft3238"><b>from</b>&#160;<b>flask</b>&#160;<b>import</b>&#160;request</p>
<p style="position:absolute;top:830px;left:134px;white-space:nowrap" class="ft3247">@app.route('/')<br/><b>def</b>&#160;index():</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft325"><b>12&#160;&#160;|&#160;&#160;Chapter 2: Basic Application Structure</b></p>
</div>
<!-- Page 33 -->
<a name="33"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft3353{font-size:11px;font-family:Times;color:#ffffff;}
	.ft3354{font-size:10px;font-family:Times;color:#cc0000;}
	.ft3355{font-size:11px;line-height:16px;font-family:Times;color:#231f20;}
	.ft3356{font-size:10px;line-height:15px;font-family:Times;color:#555555;}
-->
</style>
<div id="page33-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask033.png" alt="background image"/>
<p style="position:absolute;top:82px;left:134px;white-space:nowrap" class="ft3347">&#160; &#160;&#160;user_agent&#160;=&#160;request.headers.get('User-Agent')<br/>&#160; &#160;&#160;<b>return</b>&#160;'&lt;p&gt;Your browser is&#160;%s&lt;/p&gt;'&#160;%&#160;user_agent</p>
<p style="position:absolute;top:119px;left:108px;white-space:nowrap" class="ft3346">Note how in this view function&#160;request&#160;is used as if it was a global variable. In reality,<br/>request</p>
<p style="position:absolute;top:139px;left:160px;white-space:nowrap" class="ft3314">&#160;cannot be a global variable if you consider that in a multithreaded server the</p>
<p style="position:absolute;top:158px;left:108px;white-space:nowrap" class="ft3314">threads are working on different requests from different clients at the same time, so</p>
<p style="position:absolute;top:178px;left:108px;white-space:nowrap" class="ft3314">each thread needs to see a different object in&#160;request. Contexts enable Flask to make</p>
<p style="position:absolute;top:196px;left:108px;white-space:nowrap" class="ft3314">certain variables globally accessible to a thread without interfering with the other</p>
<p style="position:absolute;top:215px;left:108px;white-space:nowrap" class="ft3314">threads.</p>
<p style="position:absolute;top:255px;left:198px;white-space:nowrap" class="ft3325">A&#160;thread&#160;is&#160;the&#160;smallest&#160;sequence&#160;of&#160;instructions&#160;that&#160;can&#160;be&#160;man‐</p>
<p style="position:absolute;top:272px;left:198px;white-space:nowrap" class="ft3325">aged&#160;independently.&#160;It&#160;is&#160;common&#160;for&#160;a&#160;process&#160;to&#160;have&#160;multiple&#160;ac‐</p>
<p style="position:absolute;top:289px;left:198px;white-space:nowrap" class="ft3325">tive&#160;threads,&#160;sometimes&#160;sharing&#160;resources&#160;such&#160;as&#160;memory&#160;or&#160;file</p>
<p style="position:absolute;top:307px;left:198px;white-space:nowrap" class="ft3325">handles.&#160;Multithreaded&#160;web&#160;servers&#160;start&#160;a&#160;pool&#160;of&#160;threads&#160;and&#160;se‐</p>
<p style="position:absolute;top:324px;left:198px;white-space:nowrap" class="ft3325">lect&#160;a&#160;thread&#160;from&#160;the&#160;pool&#160;to&#160;handle&#160;each&#160;incoming&#160;request.</p>
<p style="position:absolute;top:369px;left:108px;white-space:nowrap" class="ft3314">There are two contexts in Flask: the&#160;<i>application context</i>&#160;and the&#160;<i>request context</i><a href="Flask.html#33">.&#160;Table 2-1</a></p>
<p style="position:absolute;top:388px;left:108px;white-space:nowrap" class="ft3348">shows the variables exposed by each of these contexts.&#160;<br/><i>Table 2-1. Flask context globals</i></p>
<p style="position:absolute;top:445px;left:113px;white-space:nowrap" class="ft3353"><b>Variable&#160;name</b></p>
<p style="position:absolute;top:445px;left:207px;white-space:nowrap" class="ft3353"><b>Context</b></p>
<p style="position:absolute;top:445px;left:298px;white-space:nowrap" class="ft3353"><b>Description</b></p>
<p style="position:absolute;top:469px;left:113px;white-space:nowrap" class="ft3314">current_app&#160;Application&#160;context&#160;The&#160;application&#160;instance&#160;for&#160;the&#160;active&#160;application.</p>
<p style="position:absolute;top:493px;left:113px;white-space:nowrap" class="ft3314">g</p>
<p style="position:absolute;top:491px;left:207px;white-space:nowrap" class="ft3330">Application&#160;context&#160;An&#160;object&#160;that&#160;the&#160;application&#160;can&#160;use&#160;for&#160;temporary&#160;storage&#160;during&#160;the&#160;handling&#160;of</p>
<p style="position:absolute;top:507px;left:298px;white-space:nowrap" class="ft3330">a&#160;request.&#160;This&#160;variable&#160;is&#160;reset&#160;with&#160;each&#160;request.</p>
<p style="position:absolute;top:531px;left:113px;white-space:nowrap" class="ft3314">request</p>
<p style="position:absolute;top:529px;left:207px;white-space:nowrap" class="ft3330">Request&#160;context</p>
<p style="position:absolute;top:529px;left:298px;white-space:nowrap" class="ft3355">The&#160;request&#160;object,&#160;which&#160;encapsulates&#160;the&#160;contents&#160;of&#160;a&#160;HTTP&#160;request&#160;sent&#160;by&#160;the<br/>client.</p>
<p style="position:absolute;top:569px;left:113px;white-space:nowrap" class="ft3314">session</p>
<p style="position:absolute;top:566px;left:207px;white-space:nowrap" class="ft3330">Request&#160;context</p>
<p style="position:absolute;top:566px;left:298px;white-space:nowrap" class="ft3355">The&#160;user&#160;session,&#160;a&#160;dictionary&#160;that&#160;the&#160;application&#160;can&#160;use&#160;to&#160;store&#160;values&#160;that&#160;are<br/>“remembered”&#160;between&#160;requests.</p>
<p style="position:absolute;top:616px;left:108px;white-space:nowrap" class="ft3314">Flask activates (or&#160;<i>pushes</i>) the application and request contexts before dispatching a</p>
<p style="position:absolute;top:634px;left:108px;white-space:nowrap" class="ft3314">request and then removes them when the request is handled. When the application</p>
<p style="position:absolute;top:654px;left:108px;white-space:nowrap" class="ft3314">context is pushed, the&#160;current_app&#160;and&#160;g&#160;variables become available to the thread;</p>
<p style="position:absolute;top:674px;left:108px;white-space:nowrap" class="ft3314">likewise, when the request context is pushed,&#160;request&#160;and&#160;session&#160;become available</p>
<p style="position:absolute;top:693px;left:108px;white-space:nowrap" class="ft3314">as well. If any of these variables are accessed without an active application or request</p>
<p style="position:absolute;top:712px;left:108px;white-space:nowrap" class="ft3314">context, an error is generated. The four context variables will be revisited in later chap‐</p>
<p style="position:absolute;top:731px;left:108px;white-space:nowrap" class="ft3315">ters in detail, so don’t worry if you don’t understand why they are useful yet.<br/>The following Python shell session demonstrates how the application context works:</p>
<p style="position:absolute;top:790px;left:133px;white-space:nowrap" class="ft3356">&gt;&gt;&gt;&#160;<b>from</b>&#160;<b>hello</b>&#160;<b>import</b>&#160;app<br/>&gt;&gt;&gt;&#160;<b>from</b>&#160;<b>flask</b>&#160;<b>import</b>&#160;current_app<br/>&gt;&gt;&gt;&#160;current_app.name<br/>Traceback&#160;(most&#160;recent&#160;call&#160;last):<br/>...<br/><b>RuntimeError</b>:&#160;working&#160;outside&#160;of&#160;application&#160;context</p>
<p style="position:absolute;top:915px;left:482px;white-space:nowrap" class="ft335"><b>The Request-Response Cycle&#160;&#160;|&#160;&#160;13</b></p>
</div>
<!-- Page 34 -->
<a name="34"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft3457{font-size:10px;line-height:15px;font-family:Times;color:#cc3300;}
	.ft3458{font-size:21px;line-height:33px;font-family:Times;color:#231f20;}
-->
</style>
<div id="page34-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask034.png" alt="background image"/>
<p style="position:absolute;top:82px;left:134px;white-space:nowrap" class="ft3457">&gt;&gt;&gt;&#160;app_ctx&#160;=&#160;app.app_context()<br/>&gt;&gt;&gt;&#160;app_ctx.push()<br/>&gt;&gt;&gt;&#160;current_app.name<br/>'hello'<br/>&gt;&gt;&gt;&#160;app_ctx.pop()</p>
<p style="position:absolute;top:165px;left:108px;white-space:nowrap" class="ft3414">In this example,&#160;current_app.name&#160;fails when there is no application context active but</p>
<p style="position:absolute;top:184px;left:108px;white-space:nowrap" class="ft3414">becomes valid once a context is pushed. Note how an application context is obtained</p>
<p style="position:absolute;top:204px;left:108px;white-space:nowrap" class="ft3414">by invoking&#160;app.app_context()&#160;on the application instance.</p>
<p style="position:absolute;top:240px;left:108px;white-space:nowrap" class="ft3452"><b>Request Dispatching&#160;<br/></b>When the application receives a request from a client, it needs to find what view function</p>
<p style="position:absolute;top:294px;left:108px;white-space:nowrap" class="ft3414">to invoke to service it. For this task, Flask looks up the URL given in the request in the</p>
<p style="position:absolute;top:313px;left:108px;white-space:nowrap" class="ft3414">application’s&#160;<i>URL map</i>, which contains a mapping of URLs to the view functions that</p>
<p style="position:absolute;top:332px;left:108px;white-space:nowrap" class="ft3414">handle them. Flask builds this map using the&#160;app.route&#160;decorators or the equivalent</p>
<p style="position:absolute;top:352px;left:108px;white-space:nowrap" class="ft3415">nondecorator version&#160;app.add_url_rule().<br/>To see what the URL map in a Flask application looks like, you can inspect the map</p>
<p style="position:absolute;top:399px;left:108px;white-space:nowrap" class="ft3414">created for&#160;<i>hello.py</i>&#160;in the Python shell. For this test, make sure that your virtual envi‐</p>
<p style="position:absolute;top:418px;left:108px;white-space:nowrap" class="ft3414">ronment is activated:</p>
<p style="position:absolute;top:450px;left:133px;white-space:nowrap" class="ft3447">(venv)&#160;$&#160;python<br/>&gt;&gt;&gt;&#160;<b>from</b>&#160;<b>hello</b>&#160;<b>import</b>&#160;app<br/>&gt;&gt;&gt;&#160;app.url_map<br/>Map([&lt;Rule&#160;'/'&#160;(HEAD,&#160;OPTIONS,&#160;GET)&#160;-&gt;&#160;index&gt;,<br/>&#160;&lt;Rule&#160;'/static/&lt;filename&gt;'&#160;(HEAD,&#160;OPTIONS,&#160;GET)&#160;-&gt;&#160;static&gt;,<br/>&#160;&lt;Rule&#160;'/user/&lt;name&gt;'&#160;(HEAD,&#160;OPTIONS,&#160;GET)&#160;-&gt;&#160;user&gt;])</p>
<p style="position:absolute;top:548px;left:108px;white-space:nowrap" class="ft3414">The&#160;<i>/</i>&#160;and&#160;<i>/user/&lt;name&gt;</i>&#160;routes were defined by the&#160;app.route&#160;decorators in the ap‐</p>
<p style="position:absolute;top:566px;left:108px;white-space:nowrap" class="ft3414">plication. The&#160;<i>/static/&lt;filename&gt;</i>&#160;route is a special route added by Flask to give access</p>
<p style="position:absolute;top:585px;left:108px;white-space:nowrap" class="ft3448">to static files. You will learn more about sta<a href="Flask.html#41">tic files in&#160;Chapter 3</a>.<br/>The&#160;HEAD, OPTIONS, GET&#160;elements shown in the URL map are the&#160;<i>request methods</i>&#160;that</p>
<p style="position:absolute;top:633px;left:108px;white-space:nowrap" class="ft3414">are handled by the route. Flask attaches methods to each route so that different request</p>
<p style="position:absolute;top:653px;left:108px;white-space:nowrap" class="ft3414">methods sent to the same URL can be handled by different view functions. The&#160;HEAD</p>
<p style="position:absolute;top:673px;left:108px;white-space:nowrap" class="ft3414">and&#160;OPTIONS&#160;methods are managed automatically by Flask, so in practice it can be said</p>
<p style="position:absolute;top:693px;left:108px;white-space:nowrap" class="ft3414">that in this application the three routes in the URL map are attached to the&#160;GET&#160;method.</p>
<p style="position:absolute;top:711px;left:108px;white-space:nowrap" class="ft3414">You will learn about specifying differen<a href="Flask.html#57">t request methods for routes in&#160;Chapter 4</a>.</p>
<p style="position:absolute;top:747px;left:108px;white-space:nowrap" class="ft3458"><b>Request Hooks<br/></b>Sometimes it is useful to execute code before or after each request is processed. For</p>
<p style="position:absolute;top:800px;left:108px;white-space:nowrap" class="ft3414">example, at the start of each request it may be necessary to create a database connection,</p>
<p style="position:absolute;top:819px;left:108px;white-space:nowrap" class="ft3414">or authenticate the user making the request. Instead of duplicating the code that does</p>
<p style="position:absolute;top:837px;left:108px;white-space:nowrap" class="ft3414">this in every view function, Flask gives you the option to register common functions to</p>
<p style="position:absolute;top:856px;left:108px;white-space:nowrap" class="ft3414">be invoked before or after a request is dispatched to a view function.</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft345"><b>14&#160;&#160;|&#160;&#160;Chapter 2: Basic Application Structure</b></p>
</div>
<!-- Page 35 -->
<a name="35"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft3559{font-size:10px;font-family:Times;color:#ff6600;}
	.ft3560{font-size:13px;line-height:25px;font-family:Times;color:#231f20;}
-->
</style>
<div id="page35-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask035.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft3514">Request hooks are implemented as decorators. These are the four hooks supported by</p>
<p style="position:absolute;top:97px;left:108px;white-space:nowrap" class="ft3514">Flask:</p>
<p style="position:absolute;top:132px;left:121px;white-space:nowrap" class="ft3514">•&#160;before_first_request: Register a function to run before the first request is</p>
<p style="position:absolute;top:151px;left:135px;white-space:nowrap" class="ft3514">handled.</p>
<p style="position:absolute;top:177px;left:121px;white-space:nowrap" class="ft3560">•&#160;before_request: Register a function to run before each request.<br/>•&#160;after_request: Register a function to run after each request, if no unhandled ex‐</p>
<p style="position:absolute;top:222px;left:135px;white-space:nowrap" class="ft3514">ceptions occurred.</p>
<p style="position:absolute;top:247px;left:121px;white-space:nowrap" class="ft3514">•&#160;teardown_request: Register a function to run after each request, even if unhandled</p>
<p style="position:absolute;top:266px;left:135px;white-space:nowrap" class="ft3514">exceptions occurred.</p>
<p style="position:absolute;top:300px;left:108px;white-space:nowrap" class="ft3514">A common pattern to share data between request hook functions and view functions is</p>
<p style="position:absolute;top:320px;left:108px;white-space:nowrap" class="ft3514">to use the&#160;g&#160;context global. For example, a&#160;before_request&#160;handler can load the logged-</p>
<p style="position:absolute;top:340px;left:108px;white-space:nowrap" class="ft3514">in user from the database and store it in&#160;g.user. Later, when the view function is invoked,</p>
<p style="position:absolute;top:359px;left:108px;white-space:nowrap" class="ft3515">it can access the user from there.&#160;<br/>Examples of request hooks will be shown in future chapters, so don’t worry if this does</p>
<p style="position:absolute;top:406px;left:108px;white-space:nowrap" class="ft3514">not quite make sense yet.</p>
<p style="position:absolute;top:441px;left:108px;white-space:nowrap" class="ft3558"><b>Responses<br/></b>When Flask invokes a view function, it expects its return value to be the response to the</p>
<p style="position:absolute;top:494px;left:108px;white-space:nowrap" class="ft3514">request. In most cases the response is a simple string that is sent back to the client as an</p>
<p style="position:absolute;top:513px;left:108px;white-space:nowrap" class="ft3515">HTML page.<br/>But the HTTP protocol requires more than a string as a response to a request. A very</p>
<p style="position:absolute;top:559px;left:108px;white-space:nowrap" class="ft3514">important part of the HTTP response is the&#160;<i>status code</i>, which Flask by default sets to</p>
<p style="position:absolute;top:578px;left:108px;white-space:nowrap" class="ft3515">200, the code that indicates that the request was carried out successfully.<br/>When a view function needs to respond with a different status code, it can add the</p>
<p style="position:absolute;top:625px;left:108px;white-space:nowrap" class="ft3514">numeric code as a second return value after the response text. For example, the following</p>
<p style="position:absolute;top:644px;left:108px;white-space:nowrap" class="ft3514">view function returns a 400 status code, the code for a bad request error:</p>
<p style="position:absolute;top:676px;left:133px;white-space:nowrap" class="ft3547">@app.route('/')<br/><b>def</b>&#160;index():<br/>&#160; &#160;&#160;<b>return</b>&#160;'&lt;h1&gt;Bad Request&lt;/h1&gt;',&#160;400</p>
<p style="position:absolute;top:727px;left:108px;white-space:nowrap" class="ft3514">Responses returned by view functions can also take a third argument, a dictionary of</p>
<p style="position:absolute;top:746px;left:108px;white-space:nowrap" class="ft3514">headers that are added to the HTTP response. This is rarely needed, but you will see an</p>
<p style="position:absolute;top:765px;left:108px;white-space:nowrap" class="ft3515">example in&#160;<a href="Flask.html#195">Chapter 14</a>.<br/>Instead of returning one, two, or three values as a tuple, Flask view functions have the</p>
<p style="position:absolute;top:812px;left:108px;white-space:nowrap" class="ft3514">option of returning a&#160;Response&#160;object. The&#160;make_response()&#160;function takes one, two,</p>
<p style="position:absolute;top:831px;left:108px;white-space:nowrap" class="ft3514">or three arguments, the same values that can be returned from a view function, and</p>
<p style="position:absolute;top:851px;left:108px;white-space:nowrap" class="ft3514">returns a&#160;Response&#160;object. Sometimes it is useful to perform this conversion inside the</p>
<p style="position:absolute;top:915px;left:482px;white-space:nowrap" class="ft355"><b>The Request-Response Cycle&#160;&#160;|&#160;&#160;15</b></p>
</div>
<!-- Page 36 -->
<a name="36"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft3661{font-size:10px;font-family:Times;color:#000000;}
-->
</style>
<div id="page36-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask036.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft3614">view function and then use the methods of the response object to further configure the</p>
<p style="position:absolute;top:97px;left:108px;white-space:nowrap" class="ft3614">response. The following example creates a response object and then sets a cookie in it:&#160;</p>
<p style="position:absolute;top:145px;left:133px;white-space:nowrap" class="ft3638"><b>from</b>&#160;<b>flask</b>&#160;<b>import</b>&#160;make_response</p>
<p style="position:absolute;top:175px;left:133px;white-space:nowrap" class="ft3647">@app.route('/')<br/><b>def</b>&#160;index():<br/>&#160; &#160;&#160;response&#160;=&#160;make_response('&lt;h1&gt;This document carries a cookie!&lt;/h1&gt;')<br/>&#160; &#160;&#160;response.set_cookie('answer',&#160;'42')<br/>&#160; &#160;&#160;<b>return</b>&#160;response</p>
<p style="position:absolute;top:257px;left:108px;white-space:nowrap" class="ft3614">There is a special type of response called a&#160;<i>redirect</i>. This response does not include a</p>
<p style="position:absolute;top:276px;left:108px;white-space:nowrap" class="ft3614">page document; it just gives the browser a new URL from which to load a new page.</p>
<p style="position:absolute;top:295px;left:108px;white-space:nowrap" class="ft3615"><a href="Flask.html#57">Redirects are commonly used with web forms, as you will learn in&#160;Chapter 4.&#160;<br/></a>A redirect is typically indicated with a 302 response status code and the URL to redirect</p>
<p style="position:absolute;top:343px;left:108px;white-space:nowrap" class="ft3614">to given in a&#160;Location&#160;header. A redirect response can be generated using a three-value</p>
<p style="position:absolute;top:362px;left:108px;white-space:nowrap" class="ft3646">return, or also with a&#160;Response&#160;object, but given its frequent use, Flask provides a<br/>redirect()</p>
<p style="position:absolute;top:382px;left:183px;white-space:nowrap" class="ft3614">&#160;helper function that creates this response:</p>
<p style="position:absolute;top:414px;left:134px;white-space:nowrap" class="ft3638"><b>from</b>&#160;<b>flask</b>&#160;<b>import</b>&#160;redirect</p>
<p style="position:absolute;top:445px;left:134px;white-space:nowrap" class="ft3647">@app.route('/')<br/><b>def</b>&#160;index():<br/>&#160; &#160;&#160;<b>return</b>&#160;redirect('http://www.example.com')</p>
<p style="position:absolute;top:497px;left:108px;white-space:nowrap" class="ft3614">Another special response is issued with the&#160;abort&#160;function, which is used for error</p>
<p style="position:absolute;top:516px;left:108px;white-space:nowrap" class="ft3614">handling. The following example returns status code 404 if the&#160;id&#160;dynamic argument</p>
<p style="position:absolute;top:535px;left:108px;white-space:nowrap" class="ft3614">given in the URL does not represent a valid user:&#160;</p>
<p style="position:absolute;top:567px;left:133px;white-space:nowrap" class="ft3638"><b>from</b>&#160;<b>flask</b>&#160;<b>import</b>&#160;abort</p>
<p style="position:absolute;top:598px;left:133px;white-space:nowrap" class="ft3647">@app.route('/user/&lt;id&gt;')<br/><b>def</b>&#160;get_user(id):<br/>&#160; &#160;&#160;user&#160;=&#160;load_user(id)<br/>&#160; &#160;&#160;<b>if</b>&#160;<b>not</b>&#160;user:<br/>&#160; &#160; &#160; &#160;&#160;abort(404)<br/>&#160; &#160;&#160;<b>return</b>&#160;'&lt;h1&gt;Hello,&#160;%s&lt;/h1&gt;'&#160;%&#160;user.name</p>
<p style="position:absolute;top:696px;left:108px;white-space:nowrap" class="ft3614">Note that&#160;abort&#160;does not return control back to the function that calls it but gives control</p>
<p style="position:absolute;top:714px;left:108px;white-space:nowrap" class="ft3614">back to the web server by raising an exception.</p>
<p style="position:absolute;top:750px;left:108px;white-space:nowrap" class="ft3618"><b>Flask Extensions<br/></b>Flask is designed to be extended. It intentionally stays out of areas of important func‐</p>
<p style="position:absolute;top:810px;left:108px;white-space:nowrap" class="ft3614">tionality such as database and user authentication, giving you the freedom to select the</p>
<p style="position:absolute;top:829px;left:108px;white-space:nowrap" class="ft3614">packages that fit your application the best, or to write your own if you so desire.</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft365"><b>16&#160;&#160;|&#160;&#160;Chapter 2: Basic Application Structure</b></p>
</div>
<!-- Page 37 -->
<a name="37"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft3762{font-size:10px;font-family:Times;color:#0099ff;}
-->
</style>
<div id="page37-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask037.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft3714">There is a large variety of&#160;<i>extensions</i>&#160;for many different purposes that were created by</p>
<p style="position:absolute;top:97px;left:108px;white-space:nowrap" class="ft3714">the community, and if that is not enough, any standard Python package or library can</p>
<p style="position:absolute;top:116px;left:108px;white-space:nowrap" class="ft3714">be used as well. To give you an idea of how an extension is incorporated into an appli‐</p>
<p style="position:absolute;top:135px;left:108px;white-space:nowrap" class="ft3714">cation, the following section adds an extension to&#160;<i>hello.py</i>&#160;that enhances the application</p>
<p style="position:absolute;top:154px;left:108px;white-space:nowrap" class="ft3714">with command-line arguments.</p>
<p style="position:absolute;top:190px;left:108px;white-space:nowrap" class="ft3752"><b>Command-Line Options with Flask-Script&#160;<br/></b>Flask’s development web server supports a number of startup configuration options,</p>
<p style="position:absolute;top:245px;left:108px;white-space:nowrap" class="ft3714">but the only way to specify them is by passing them as arguments to the&#160;app.run()&#160;call</p>
<p style="position:absolute;top:264px;left:108px;white-space:nowrap" class="ft3714">in the script. This is not very convenient; the ideal way to pass configuration options is</p>
<p style="position:absolute;top:283px;left:108px;white-space:nowrap" class="ft3715">through command-line arguments.<br/>Flask-Script is an extension for Flask that adds a command-line parser to your Flask</p>
<p style="position:absolute;top:330px;left:108px;white-space:nowrap" class="ft3714">application. It comes packaged with a set of general-purpose options and also supports</p>
<p style="position:absolute;top:349px;left:108px;white-space:nowrap" class="ft3715">custom commands.<br/>The extension is installed with pip:</p>
<p style="position:absolute;top:408px;left:133px;white-space:nowrap" class="ft3733">(venv)&#160;$&#160;pip install flask-script</p>
<p style="position:absolute;top:429px;left:108px;white-space:nowrap" class="ft3717"><a href="Flask.html#37">Example 2-3&#160;shows the changes needed to add command-line parsing to the&#160;</a><i>hello.py</i></p>
<p style="position:absolute;top:448px;left:108px;white-space:nowrap" class="ft3714">application.</p>
<p style="position:absolute;top:479px;left:108px;white-space:nowrap" class="ft3740"><i>Example 2-3. hello.py: Using Flask-Script<br/></i><b>from</b>&#160;<b>flask.ext.script</b>&#160;<b>import</b>&#160;Manager<br/>manager&#160;=&#160;Manager(app)</p>
<p style="position:absolute;top:553px;left:108px;white-space:nowrap" class="ft3762"><i># ...</i></p>
<p style="position:absolute;top:584px;left:108px;white-space:nowrap" class="ft3747"><b>if</b>&#160;__name__&#160;==&#160;'__main__':<br/>&#160; &#160;&#160;manager.run()</p>
<p style="position:absolute;top:626px;left:108px;white-space:nowrap" class="ft3714">Extensions developed specifically for Flask are exposed under the&#160;flask.ext&#160;name‐</p>
<p style="position:absolute;top:646px;left:108px;white-space:nowrap" class="ft3746">space. Flask-Script exports a class named&#160;Manager, which is imported from<br/>flask.ext.script</p>
<p style="position:absolute;top:666px;left:228px;white-space:nowrap" class="ft3714">.</p>
<p style="position:absolute;top:694px;left:108px;white-space:nowrap" class="ft3714">The method of initialization of this extension is common to many extensions: an in‐</p>
<p style="position:absolute;top:713px;left:108px;white-space:nowrap" class="ft3714">stance of the main class is initialized by passing the application instance as an argument</p>
<p style="position:absolute;top:732px;left:108px;white-space:nowrap" class="ft3714">to the constructor. The created object is then used as appropriate for each extension. In</p>
<p style="position:absolute;top:752px;left:108px;white-space:nowrap" class="ft3714">this case, the server startup is routed through&#160;manager.run(), where the command line</p>
<p style="position:absolute;top:770px;left:108px;white-space:nowrap" class="ft3714">is parsed.</p>
<p style="position:absolute;top:915px;left:535px;white-space:nowrap" class="ft375"><b>Flask Extensions&#160;&#160;|&#160;&#160;17</b></p>
</div>
<!-- Page 38 -->
<a name="38"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft3863{font-size:10px;line-height:15px;font-family:Times;color:#336666;}
-->
</style>
<div id="page38-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask038.png" alt="background image"/>
<p style="position:absolute;top:85px;left:198px;white-space:nowrap" class="ft3825">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:103px;left:198px;white-space:nowrap" class="ft3825">run&#160;git&#160;checkout&#160;2c&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:192px;left:108px;white-space:nowrap" class="ft3814">With these changes, the application acquires a basic set of command-line options. Run‐</p>
<p style="position:absolute;top:211px;left:108px;white-space:nowrap" class="ft3814">ning&#160;<i>hello.py</i>&#160;now shows a usage message:</p>
<p style="position:absolute;top:242px;left:134px;white-space:nowrap" class="ft3823">$&#160;python hello.py<br/>usage: hello.py&#160;[-h]&#160;{shell,runserver}&#160;...</p>
<p style="position:absolute;top:288px;left:134px;white-space:nowrap" class="ft3823">positional arguments:<br/>&#160;&#160;{shell,runserver}<br/>&#160; &#160; shell &#160; &#160; &#160; &#160; &#160; &#160;Runs a Python shell inside Flask application context.<br/>&#160; &#160; runserver &#160; &#160; &#160; &#160;Runs the Flask development server i.e. app.run()</p>
<p style="position:absolute;top:365px;left:134px;white-space:nowrap" class="ft3823">optional arguments:<br/>&#160; -h, --help &#160; &#160; &#160; &#160; show this&#160;help&#160;message and&#160;exit</p>
<p style="position:absolute;top:401px;left:108px;white-space:nowrap" class="ft3814">The&#160;shell&#160;command is used to start a Python shell session in the context of the appli‐</p>
<p style="position:absolute;top:420px;left:108px;white-space:nowrap" class="ft3846">cation. You can use this session to run maintenance tasks or tests, or to debug issues.&#160;<br/>The&#160;runserver&#160;command, as its name implies, starts the web server. Running&#160;python<br/>hello.py runserver</p>
<p style="position:absolute;top:469px;left:242px;white-space:nowrap" class="ft3814">&#160;starts the web server in debug mode, but there many more options</p>
<p style="position:absolute;top:488px;left:108px;white-space:nowrap" class="ft3814">available:</p>
<p style="position:absolute;top:520px;left:133px;white-space:nowrap" class="ft3856">(venv)&#160;$&#160;python hello.py runserver --help<br/>usage: hello.py runserver&#160;[-h]&#160;[-t HOST]&#160;[-p PORT]&#160;[--threaded]<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;[--processes PROCESSES]&#160;[--passthrough-errors]&#160;[-d]<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;[-r]</p>
<p style="position:absolute;top:596px;left:133px;white-space:nowrap" class="ft383">Runs the Flask development server i.e. app.run()</p>
<p style="position:absolute;top:627px;left:133px;white-space:nowrap" class="ft3823">optional arguments:<br/>&#160; -h, --help &#160; &#160; &#160; &#160; &#160; &#160;show this&#160;help&#160;message and&#160;exit<br/>&#160; -t HOST, --host HOST<br/>&#160; -p PORT, --port PORT<br/>&#160; --threaded<br/>&#160; --processes PROCESSES<br/>&#160; --passthrough-errors<br/>&#160; -d, --no-debug<br/>&#160; -r, --no-reload</p>
<p style="position:absolute;top:770px;left:108px;white-space:nowrap" class="ft3814">The&#160;--host&#160;argument is a useful option because it tells the web server what network</p>
<p style="position:absolute;top:789px;left:108px;white-space:nowrap" class="ft3814">interface to listen to for connections from clients. By default, Flask’s development web</p>
<p style="position:absolute;top:809px;left:108px;white-space:nowrap" class="ft3814">server listens for connections on&#160;localhost, so only connections originating from</p>
<p style="position:absolute;top:828px;left:108px;white-space:nowrap" class="ft3814">within the computer running the server are accepted. The following command makes</p>
<p style="position:absolute;top:847px;left:108px;white-space:nowrap" class="ft3814">the web server listen for connections on the public network interface, enabling other</p>
<p style="position:absolute;top:866px;left:108px;white-space:nowrap" class="ft3814">computers in the network to connect as well:</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft385"><b>18&#160;&#160;|&#160;&#160;Chapter 2: Basic Application Structure</b></p>
</div>
<!-- Page 39 -->
<a name="39"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page39-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask039.png" alt="background image"/>
<p style="position:absolute;top:82px;left:134px;white-space:nowrap" class="ft3923">(venv)&#160;$&#160;python hello.py runserver --host 0.0.0.0<br/>&#160;* Running on http://0.0.0.0:5000/<br/>&#160;* Restarting with reloader</p>
<p style="position:absolute;top:133px;left:108px;white-space:nowrap" class="ft3914">The web server should now be accessible from any computer in the network at&#160;<a href="http://a.b.c.d:5000"><i>http://</i></a></p>
<p style="position:absolute;top:153px;left:108px;white-space:nowrap" class="ft3920"><a href="http://a.b.c.d:5000"><i>a.b.c.d:5000</i></a></p>
<p style="position:absolute;top:152px;left:182px;white-space:nowrap" class="ft3914">, where “a.b.c.d” is the external IP address of the computer running the</p>
<p style="position:absolute;top:171px;left:108px;white-space:nowrap" class="ft3915">server.<br/>This chapter introduced the concept of responses to requests, but there is a lot more to</p>
<p style="position:absolute;top:218px;left:108px;white-space:nowrap" class="ft3914">say about responses. Flask provides very good support for generating responses using</p>
<p style="position:absolute;top:238px;left:108px;white-space:nowrap" class="ft3910"><i>templates</i></p>
<p style="position:absolute;top:237px;left:167px;white-space:nowrap" class="ft3914">, and this is such an important topic that the next chapter is dedicated to it.</p>
<p style="position:absolute;top:915px;left:535px;white-space:nowrap" class="ft395"><b>Flask Extensions&#160;&#160;|&#160;&#160;19</b></p>
</div>
<!-- Page 40 -->
<a name="40"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page40-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask040.png" alt="background image"/>
</div>
<!-- Page 41 -->
<a name="41"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page41-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask041.png" alt="background image"/>
<p style="position:absolute;top:104px;left:559px;white-space:nowrap" class="ft4128"><b>CHAPTER 3</b></p>
<p style="position:absolute;top:131px;left:520px;white-space:nowrap" class="ft4111"><b>Templates</b></p>
<p style="position:absolute;top:345px;left:108px;white-space:nowrap" class="ft4114">The key to writing applications that are easy to maintain is to write clean and well-</p>
<p style="position:absolute;top:364px;left:108px;white-space:nowrap" class="ft4114">structured code. The examples that you have seen so far are too simple to demonstrate</p>
<p style="position:absolute;top:383px;left:108px;white-space:nowrap" class="ft4114">this, but Flask view functions have two completely independent purposes disguised as</p>
<p style="position:absolute;top:402px;left:108px;white-space:nowrap" class="ft4115">one, which creates a problem.<br/>The obvious task of a view function is to generate a response to a request, as you have</p>
<p style="position:absolute;top:449px;left:108px;white-space:nowrap" class="ft4114">seen in the examples shown in&#160;<a href="Flask.html#27">Chapter 2. F</a>or the simplest requests this is enough, but</p>
<p style="position:absolute;top:468px;left:108px;white-space:nowrap" class="ft4114">in general a request triggers a change in the state of the application, and the view function</p>
<p style="position:absolute;top:487px;left:108px;white-space:nowrap" class="ft4115">is also where this change is generated.<br/>For example, consider a user who is registering a new account on a website. The user</p>
<p style="position:absolute;top:533px;left:108px;white-space:nowrap" class="ft4114">types an email address and a password in a web form and clicks the Submit button. On</p>
<p style="position:absolute;top:552px;left:108px;white-space:nowrap" class="ft4114">the server, a request that includes the data from the user arrives and Flask dispatches it</p>
<p style="position:absolute;top:571px;left:108px;white-space:nowrap" class="ft4114">to the view function that handles registration requests. This view function needs to talk</p>
<p style="position:absolute;top:590px;left:108px;white-space:nowrap" class="ft4114">to the database to get the new user added and then generate a response to send back to</p>
<p style="position:absolute;top:609px;left:108px;white-space:nowrap" class="ft4114">the browser. These two types of tasks are formally called&#160;<i>business logic</i>&#160;and&#160;<i>presentation</i></p>
<p style="position:absolute;top:629px;left:108px;white-space:nowrap" class="ft4110"><i>logic</i></p>
<p style="position:absolute;top:628px;left:136px;white-space:nowrap" class="ft4114">, respectively.</p>
<p style="position:absolute;top:656px;left:108px;white-space:nowrap" class="ft4114">Mixing business and presentation logic leads to code that is hard to understand and</p>
<p style="position:absolute;top:675px;left:108px;white-space:nowrap" class="ft4114">maintain. Imagine having to build the HTML code for a large table by concatenating</p>
<p style="position:absolute;top:694px;left:108px;white-space:nowrap" class="ft4114">data obtained from the database with the necessary HTML string literals. Moving the</p>
<p style="position:absolute;top:713px;left:108px;white-space:nowrap" class="ft4115">presentation logic into&#160;<i>templates</i>&#160;helps improve the maintainability of the application.<br/>A template is a file that contains the text of a response, with placeholder variables for</p>
<p style="position:absolute;top:759px;left:108px;white-space:nowrap" class="ft4114">the dynamic parts that will be known only in the context of a request. The process that</p>
<p style="position:absolute;top:778px;left:108px;white-space:nowrap" class="ft4114">replaces the variables with actual values and returns a final response string is called</p>
<p style="position:absolute;top:798px;left:108px;white-space:nowrap" class="ft4110"><i>rendering</i></p>
<p style="position:absolute;top:797px;left:168px;white-space:nowrap" class="ft4114">. For the task of rendering templates, Flask uses a powerful template engine</p>
<p style="position:absolute;top:816px;left:108px;white-space:nowrap" class="ft4114">called&#160;<i>Jinja2</i>.</p>
<p style="position:absolute;top:915px;left:637px;white-space:nowrap" class="ft415"><b>21</b></p>
</div>
<!-- Page 42 -->
<a name="42"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft4264{font-size:10px;font-family:Times;color:#330099;}
-->
</style>
<div id="page42-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask042.png" alt="background image"/>
<p style="position:absolute;top:75px;left:108px;white-space:nowrap" class="ft4222"><b>The Jinja2 Template Engine&#160;<br/></b>In its simplest form, a Jinja2 template is a file that contains the text of a response.</p>
<p style="position:absolute;top:137px;left:108px;white-space:nowrap" class="ft4217"><a href="Flask.html#42">Example 3-1</a>&#160;shows a Jinja2 template that matches the response of the&#160;index()&#160;view</p>
<p style="position:absolute;top:156px;left:108px;white-space:nowrap" class="ft4214">function of&#160;<a href="Flask.html#30">Example 2-1.</a></p>
<p style="position:absolute;top:188px;left:108px;white-space:nowrap" class="ft4250"><i>Example 3-1. templates/index.html: Jinja2 template<br/></i><b>&lt;h1&gt;</b>Hello World!<b>&lt;/h1&gt;</b></p>
<p style="position:absolute;top:243px;left:108px;white-space:nowrap" class="ft4214">The response returned by view function&#160;user()&#160;of&#160;<a href="Flask.html#31">Example 2-2</a>&#160;has a dynamic com‐</p>
<p style="position:absolute;top:262px;left:108px;white-space:nowrap" class="ft4214">ponent, which is represented by a&#160;<i>variable</i>.&#160;<a href="Flask.html#42">Example 3-2&#160;shows the tem</a>plate that im‐</p>
<p style="position:absolute;top:281px;left:108px;white-space:nowrap" class="ft4214">plements this response.</p>
<p style="position:absolute;top:312px;left:108px;white-space:nowrap" class="ft4250"><i>Example 3-2. templates/user.html: Jinja2 template<br/></i><b>&lt;h1&gt;</b>Hello, {{ name }}!<b>&lt;/h1&gt;</b></p>
<p style="position:absolute;top:369px;left:108px;white-space:nowrap" class="ft4252"><b>Rendering Templates&#160;<br/></b>By default Flask looks for templates in a&#160;<i>templates</i>&#160;subfolder located inside the applica‐</p>
<p style="position:absolute;top:423px;left:108px;white-space:nowrap" class="ft4214">tion folder. For the next version of&#160;<i>hello.py</i>, you need to store the templates defined</p>
<p style="position:absolute;top:442px;left:108px;white-space:nowrap" class="ft4215">earlier in a new&#160;<i>templates</i>&#160;folder as&#160;<i>index.html</i>&#160;and&#160;<i>user.html</i>.<br/>The view functions in the application need to be modified to render these templates.</p>
<p style="position:absolute;top:488px;left:108px;white-space:nowrap" class="ft4217"><a href="Flask.html#42">Example 3-3</a>&#160;shows these changes.</p>
<p style="position:absolute;top:520px;left:108px;white-space:nowrap" class="ft4250"><i>Example 3-3. hello.py: Rendering a template<br/></i><b>from</b>&#160;<b>flask</b>&#160;<b>import</b>&#160;Flask,&#160;render_template</p>
<p style="position:absolute;top:579px;left:108px;white-space:nowrap" class="ft4262"><i># ...</i></p>
<p style="position:absolute;top:609px;left:108px;white-space:nowrap" class="ft4247">@app.route('/index')<br/><b>def</b>&#160;index():<br/>&#160; &#160;&#160;<b>return</b>&#160;render_template('index.html')</p>
<p style="position:absolute;top:671px;left:108px;white-space:nowrap" class="ft4247">@app.route('/user/&lt;name&gt;')<br/><b>def</b>&#160;user(name):<br/>&#160; &#160;&#160;<b>return</b>&#160;render_template('user.html',&#160;name=name)</p>
<p style="position:absolute;top:729px;left:108px;white-space:nowrap" class="ft4214">The function&#160;render_template&#160;provided by Flask integrates the Jinja2 template engine</p>
<p style="position:absolute;top:747px;left:108px;white-space:nowrap" class="ft4214">with the application. This function takes the filename of the template as its first argu‐</p>
<p style="position:absolute;top:766px;left:108px;white-space:nowrap" class="ft4214">ment. Any additional arguments are key/value pairs that represent actual values for</p>
<p style="position:absolute;top:785px;left:108px;white-space:nowrap" class="ft4214">variables referenced in the template. In this example, the second template is receiving</p>
<p style="position:absolute;top:805px;left:108px;white-space:nowrap" class="ft4248">a&#160;name&#160;variable.&#160;<br/>Keyword arguments like&#160;name=name&#160;in the previous example are fairly common but may</p>
<p style="position:absolute;top:853px;left:108px;white-space:nowrap" class="ft4214">seem confusing and hard to understand if you are not used to them. The “name” on the</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft425"><b>22&#160;&#160;|&#160;&#160;Chapter 3: Templates</b></p>
</div>
<!-- Page 43 -->
<a name="43"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft4365{font-size:21px;line-height:35px;font-family:Times;color:#231f20;}
	.ft4366{font-size:10px;line-height:15px;font-family:Times;color:#330099;}
-->
</style>
<div id="page43-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask043.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft4314">left side represents the argument name, which is used in the placeholder written in the</p>
<p style="position:absolute;top:97px;left:108px;white-space:nowrap" class="ft4314">template. The “name” on the right side is a variable in the current scope that provides</p>
<p style="position:absolute;top:116px;left:108px;white-space:nowrap" class="ft4314">the value for the argument of the same name.</p>
<p style="position:absolute;top:158px;left:198px;white-space:nowrap" class="ft4325">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:176px;left:198px;white-space:nowrap" class="ft4325">run&#160;git&#160;checkout&#160;3a&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:262px;left:108px;white-space:nowrap" class="ft4365"><b>Variables&#160;<br/></b>The&#160;{{ name }}&#160;construct used in the templa<a href="Flask.html#42">te shown in&#160;Example 3-2&#160;references a</a></p>
<p style="position:absolute;top:317px;left:108px;white-space:nowrap" class="ft4314">variable, a special placeholder that tells the template engine that the value that goes in</p>
<p style="position:absolute;top:335px;left:108px;white-space:nowrap" class="ft4315">that place should be obtained from data provided at the time the template is rendered.<br/>Jinja2 recognizes variables of any type, even complex types such as lists, dictionaries</p>
<p style="position:absolute;top:382px;left:108px;white-space:nowrap" class="ft4314">and objects. The following are some more examples of variables used in templates:</p>
<p style="position:absolute;top:414px;left:134px;white-space:nowrap" class="ft4366"><b>&lt;p&gt;</b>A value from a dictionary: {{ mydict['key'] }}.<b>&lt;/p&gt;<br/>&lt;p&gt;</b>A value from a list: {{ mylist[3] }}.<b>&lt;/p&gt;<br/>&lt;p&gt;</b>A value from a list, with a variable index: {{ mylist[myintvar] }}.<b>&lt;/p&gt;<br/>&lt;p&gt;</b>A value from an object's method: {{ myobj.somemethod() }}.<b>&lt;/p&gt;</b></p>
<p style="position:absolute;top:480px;left:108px;white-space:nowrap" class="ft4314">Variables can be modified with&#160;<i>filters</i>, which are added after the variable name with a</p>
<p style="position:absolute;top:500px;left:108px;white-space:nowrap" class="ft4314">pipe character as separator. For example, the following template shows the&#160;name&#160;variable</p>
<p style="position:absolute;top:519px;left:108px;white-space:nowrap" class="ft4314">capitalized:</p>
<p style="position:absolute;top:551px;left:134px;white-space:nowrap" class="ft433">Hello, {{ name|capitalize }}</p>
<p style="position:absolute;top:571px;left:108px;white-space:nowrap" class="ft4348"><a href="Flask.html#43">Table 3-1</a>&#160;lists some of the commonly used filters that come with Jinja2.<br/><i>Table 3-1. Jinja2 variable filters</i></p>
<p style="position:absolute;top:628px;left:113px;white-space:nowrap" class="ft4353"><b>Filter&#160;name</b></p>
<p style="position:absolute;top:628px;left:199px;white-space:nowrap" class="ft4353"><b>Description</b></p>
<p style="position:absolute;top:652px;left:113px;white-space:nowrap" class="ft4314">safe</p>
<p style="position:absolute;top:650px;left:199px;white-space:nowrap" class="ft4330">Renders&#160;the&#160;value&#160;without&#160;applying&#160;escaping</p>
<p style="position:absolute;top:677px;left:113px;white-space:nowrap" class="ft4314">capitalize&#160;Converts&#160;the&#160;first&#160;character&#160;of&#160;the&#160;value&#160;to&#160;uppercase&#160;and&#160;the&#160;rest&#160;to&#160;lowercase</p>
<p style="position:absolute;top:701px;left:113px;white-space:nowrap" class="ft4314">lower</p>
<p style="position:absolute;top:698px;left:199px;white-space:nowrap" class="ft4330">Converts&#160;the&#160;value&#160;to&#160;lowercase&#160;characters</p>
<p style="position:absolute;top:725px;left:113px;white-space:nowrap" class="ft4314">upper</p>
<p style="position:absolute;top:722px;left:199px;white-space:nowrap" class="ft4330">Converts&#160;the&#160;value&#160;to&#160;uppercase&#160;characters</p>
<p style="position:absolute;top:749px;left:113px;white-space:nowrap" class="ft4314">title</p>
<p style="position:absolute;top:746px;left:199px;white-space:nowrap" class="ft4330">Capitalizes&#160;each&#160;word&#160;in&#160;the&#160;value</p>
<p style="position:absolute;top:773px;left:113px;white-space:nowrap" class="ft4314">trim</p>
<p style="position:absolute;top:770px;left:199px;white-space:nowrap" class="ft4330">Removes&#160;leading&#160;and&#160;trailing&#160;whitespace&#160;from&#160;the&#160;value</p>
<p style="position:absolute;top:797px;left:113px;white-space:nowrap" class="ft4314">striptags</p>
<p style="position:absolute;top:794px;left:199px;white-space:nowrap" class="ft4330">Removes&#160;any&#160;HTML&#160;tags&#160;from&#160;the&#160;value&#160;before&#160;rendering</p>
<p style="position:absolute;top:831px;left:108px;white-space:nowrap" class="ft4314">The&#160;safe&#160;filter is interesting to highlight. By default Jinja2&#160;<i>escapes</i>&#160;all variables for se‐</p>
<p style="position:absolute;top:850px;left:108px;white-space:nowrap" class="ft4314">curity purposes. For example, if a variable is set to the value&#160;'&lt;h1&gt;Hello&lt;/h1&gt;', Jinja2</p>
<p style="position:absolute;top:915px;left:483px;white-space:nowrap" class="ft435"><b>The Jinja2 Template Engine &#160;&#160;|&#160;&#160;23</b></p>
</div>
<!-- Page 44 -->
<a name="44"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page44-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask044.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft4414">will render the string as&#160;'&amp;lt;h1&amp;gt;Hello&amp;lt;/h1&amp;gt;', which will cause the&#160;h1&#160;ele‐</p>
<p style="position:absolute;top:98px;left:108px;white-space:nowrap" class="ft4414">ment to be displayed and not interpreted by the browser.&#160;Many times it is necessary to</p>
<p style="position:absolute;top:118px;left:108px;white-space:nowrap" class="ft4414">display HTML code stored in variables, and for those cases the&#160;safe&#160;filter is used.</p>
<p style="position:absolute;top:158px;left:204px;white-space:nowrap" class="ft4425">Never&#160;use&#160;the&#160;safe&#160;filter&#160;on&#160;values&#160;that&#160;aren’t&#160;trusted,&#160;such&#160;as&#160;text</p>
<p style="position:absolute;top:176px;left:204px;white-space:nowrap" class="ft4425">entered&#160;by&#160;users&#160;on&#160;web&#160;forms.</p>
<p style="position:absolute;top:258px;left:108px;white-space:nowrap" class="ft4414">The complete list of filters can be obtained from the official&#160;<a href="http://bit.ly/jinja-filters">Jinja2 documentation</a>.</p>
<p style="position:absolute;top:294px;left:108px;white-space:nowrap" class="ft4458"><b>Control Structures<br/></b>Jinja2 offers several control structures that can be used to alter the flow of the template.</p>
<p style="position:absolute;top:346px;left:108px;white-space:nowrap" class="ft4415">This section introduces some of the most useful ones with simple examples.<br/>The following example shows how conditional statements can be entered in a template:</p>
<p style="position:absolute;top:406px;left:134px;white-space:nowrap" class="ft4423">{% if user %}<br/>&#160; &#160; Hello, {{ user }}!<br/>{% else %}<br/>&#160; &#160; Hello, Stranger!<br/>{% endif %}</p>
<p style="position:absolute;top:488px;left:108px;white-space:nowrap" class="ft4414">Another common need in templates is to render a list of elements. This example shows</p>
<p style="position:absolute;top:508px;left:108px;white-space:nowrap" class="ft4414">how this can be done with a&#160;for&#160;loop:</p>
<p style="position:absolute;top:539px;left:133px;white-space:nowrap" class="ft4423"><b>&lt;ul&gt;<br/></b>&#160; &#160; {% for comment in comments %}<br/>&#160; &#160; &#160; &#160;&#160;<b>&lt;li&gt;</b>{{ comment }}<b>&lt;/li&gt;<br/></b>&#160; &#160; {% endfor %}<br/><b>&lt;/ul&gt;</b></p>
<p style="position:absolute;top:621px;left:108px;white-space:nowrap" class="ft4414">Jinja2 also supports&#160;<i>macros</i>, which are similar to functions in Python code. For example:</p>
<p style="position:absolute;top:653px;left:133px;white-space:nowrap" class="ft4466">{% macro render_comment(comment) %}<br/>&#160; &#160;&#160;<b>&lt;li&gt;</b>{{ comment }}<b>&lt;/li&gt;<br/></b>{% endmacro %}</p>
<p style="position:absolute;top:714px;left:133px;white-space:nowrap" class="ft4423"><b>&lt;ul&gt;<br/></b>&#160; &#160; {% for comment in comments %}<br/>&#160; &#160; &#160; &#160; {{ render_comment(comment) }}<br/>&#160; &#160; {% endfor %}<br/><b>&lt;/ul&gt;</b></p>
<p style="position:absolute;top:796px;left:108px;white-space:nowrap" class="ft4414">To make macros more reusable, they can be stored in standalone files that are then</p>
<p style="position:absolute;top:815px;left:108px;white-space:nowrap" class="ft4410"><i>imported</i></p>
<p style="position:absolute;top:814px;left:165px;white-space:nowrap" class="ft4414">&#160;from all the templates that need them:</p>
<p style="position:absolute;top:846px;left:134px;white-space:nowrap" class="ft4423">{% import 'macros.html' as macros %}<br/><b>&lt;ul&gt;</b></p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft445"><b>24&#160;&#160;|&#160;&#160;Chapter 3: Templates</b></p>
</div>
<!-- Page 45 -->
<a name="45"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page45-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask045.png" alt="background image"/>
<p style="position:absolute;top:82px;left:134px;white-space:nowrap" class="ft4523">&#160; &#160; {% for comment in comments %}<br/>&#160; &#160; &#160; &#160; {{ macros.render_comment(comment) }}<br/>&#160; &#160; {% endfor %}<br/><b>&lt;/ul&gt;</b></p>
<p style="position:absolute;top:149px;left:108px;white-space:nowrap" class="ft4514">Portions of template code that need to be repeated in several places can be stored in a</p>
<p style="position:absolute;top:168px;left:108px;white-space:nowrap" class="ft4514">separate file and&#160;<i>included</i>&#160;from all the templates to avoid repetition:</p>
<p style="position:absolute;top:199px;left:134px;white-space:nowrap" class="ft453">{% include 'common.html' %}</p>
<p style="position:absolute;top:220px;left:108px;white-space:nowrap" class="ft4514">Yet another powerful way to reuse is through template inheritance, which is similar to</p>
<p style="position:absolute;top:239px;left:108px;white-space:nowrap" class="ft4514">class inheritance in Python code. First, a base template is created with the name</p>
<p style="position:absolute;top:259px;left:108px;white-space:nowrap" class="ft4510"><i>base.html</i></p>
<p style="position:absolute;top:258px;left:168px;white-space:nowrap" class="ft4514">:</p>
<p style="position:absolute;top:289px;left:134px;white-space:nowrap" class="ft4566"><b>&lt;html&gt;<br/>&lt;head&gt;<br/></b>&#160; &#160; {% block head %}<br/>&#160; &#160;&#160;<b>&lt;title&gt;</b>{% block title %}{% endblock %} - My Application<b>&lt;/title&gt;<br/></b>&#160; &#160; {% endblock %}<br/><b>&lt;/head&gt;<br/>&lt;body&gt;<br/></b>&#160; &#160; {% block body %}<br/>&#160; &#160; {% endblock %}<br/><b>&lt;/body&gt;<br/>&lt;/html&gt;</b></p>
<p style="position:absolute;top:464px;left:108px;white-space:nowrap" class="ft4514">Here the&#160;block&#160;tags define elements that a derived template can change. In this example,</p>
<p style="position:absolute;top:483px;left:108px;white-space:nowrap" class="ft4514">there are blocks called&#160;head,&#160;title, and&#160;body; note that&#160;title&#160;is contained by&#160;head. The</p>
<p style="position:absolute;top:502px;left:108px;white-space:nowrap" class="ft4514">following example is a derived template of the base template:</p>
<p style="position:absolute;top:534px;left:134px;white-space:nowrap" class="ft4566">{% extends &#34;base.html&#34; %}<br/>{% block title %}Index{% endblock %}<br/>{% block head %}<br/>&#160; &#160; {{ super() }}<br/>&#160; &#160;&#160;<b>&lt;style&gt;<br/></b>&#160; &#160;&#160;<b>&lt;/style&gt;<br/></b>{% endblock %}<br/>{% block body %}<br/><b>&lt;h1&gt;</b>Hello, World!<b>&lt;/h1&gt;<br/></b>{% endblock %}</p>
<p style="position:absolute;top:693px;left:108px;white-space:nowrap" class="ft4514">The&#160;extends&#160;directive declares that this template derives from&#160;<i>base.html</i>. This directive</p>
<p style="position:absolute;top:712px;left:108px;white-space:nowrap" class="ft4514">is followed by new definitions for the three blocks defined in the base template, which</p>
<p style="position:absolute;top:732px;left:108px;white-space:nowrap" class="ft4514">are inserted in the proper places. Note that the new definition of the&#160;head&#160;block, which</p>
<p style="position:absolute;top:752px;left:108px;white-space:nowrap" class="ft4515">is not empty in the base template, uses&#160;super()&#160;to retain the original contents.&#160;<br/>Real-world usage of all the control structures presented in this section will be shown</p>
<p style="position:absolute;top:799px;left:108px;white-space:nowrap" class="ft4514">later, so you will have the opportunity to see how they work.</p>
<p style="position:absolute;top:915px;left:483px;white-space:nowrap" class="ft455"><b>The Jinja2 Template Engine &#160;&#160;|&#160;&#160;25</b></p>
</div>
<!-- Page 46 -->
<a name="46"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft4667{font-size:10px;font-family:Times;color:#330099;}
	.ft4668{font-size:10px;line-height:15px;font-family:Times;color:#0099ff;}
-->
</style>
<div id="page46-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask046.png" alt="background image"/>
<p style="position:absolute;top:75px;left:108px;white-space:nowrap" class="ft4622"><b>Twitter Bootstrap Integration with Flask-Bootstrap&#160;<br/></b><a href="http://getbootstrap.com">Bootstrap&#160;</a>is an open source framework from Twitter that provides user interface com‐</p>
<p style="position:absolute;top:136px;left:108px;white-space:nowrap" class="ft4614">ponents to create clean and attractive web pages that are compatible with all modern</p>
<p style="position:absolute;top:155px;left:108px;white-space:nowrap" class="ft4615">web browsers.<br/>Bootstrap is a client-side framework, so the server is not directly involved with it. All</p>
<p style="position:absolute;top:202px;left:108px;white-space:nowrap" class="ft4614">the server needs to do is provide HTML responses that reference Bootstrap’s cascading</p>
<p style="position:absolute;top:220px;left:108px;white-space:nowrap" class="ft4614">style sheets (CSS) and JavaScript files and instantiate the desired components through</p>
<p style="position:absolute;top:239px;left:108px;white-space:nowrap" class="ft4615">HTML, CSS, and JavaScript code. The ideal place to do all this is in templates.<br/>The obvious way to integrate Bootstrap with the application is to make all the necessary</p>
<p style="position:absolute;top:286px;left:108px;white-space:nowrap" class="ft4614">changes to the templates. A simpler approach is to use a Flask&#160;<i>extension</i>&#160;called Flask-</p>
<p style="position:absolute;top:305px;left:108px;white-space:nowrap" class="ft4614">Bootstrap to simplify the integration effort. Flask-Bootstrap can be installed with pip:</p>
<p style="position:absolute;top:337px;left:133px;white-space:nowrap" class="ft4633">(venv)&#160;$&#160;pip install flask-bootstrap</p>
<p style="position:absolute;top:357px;left:108px;white-space:nowrap" class="ft4614">Flask extensions are usually initialized at the same time the application instance is cre‐</p>
<p style="position:absolute;top:376px;left:108px;white-space:nowrap" class="ft4614">ated.&#160;<a href="Flask.html#46">Example 3-4&#160;shows the initializa</a>tion of Flask-Bootstrap.</p>
<p style="position:absolute;top:408px;left:108px;white-space:nowrap" class="ft4668"><i>Example 3-4. hello.py: Flask-Bootstrap initialization<br/></i><b>from</b>&#160;<b>flask.ext.bootstrap</b>&#160;<b>import</b>&#160;Bootstrap<br/><i># ...<br/></i>bootstrap&#160;=&#160;Bootstrap(app)</p>
<p style="position:absolute;top:494px;left:108px;white-space:nowrap" class="ft4614">Like Flask-Script in&#160;<a href="Flask.html#27">Chapter 2, Flask-B</a>ootstrap is imported from the&#160;flask.ext&#160;name‐</p>
<p style="position:absolute;top:513px;left:108px;white-space:nowrap" class="ft4615">space and initialized by passing the application instance in the constructor.<br/>Once Flask-Bootstrap is initialized, a base template that includes all the Bootstrap files</p>
<p style="position:absolute;top:559px;left:108px;white-space:nowrap" class="ft4614">is available to the application. This template takes advantage of Jinja2’s template inher‐</p>
<p style="position:absolute;top:578px;left:108px;white-space:nowrap" class="ft4614">itance; the application extends a base template that has the general structure of the page</p>
<p style="position:absolute;top:597px;left:108px;white-space:nowrap" class="ft4614">including the elements that import Bootstrap<a href="Flask.html#46">.&#160;Example 3-5</a>&#160;shows a new version of</p>
<p style="position:absolute;top:617px;left:108px;white-space:nowrap" class="ft4610"><i>user.html</i></p>
<p style="position:absolute;top:616px;left:167px;white-space:nowrap" class="ft4614">&#160;as a derived template.</p>
<p style="position:absolute;top:648px;left:108px;white-space:nowrap" class="ft4650"><i>Example 3-5. templates/user.html: Template that uses Flask-Bootstrap<br/></i>{% extends &#34;bootstrap/base.html&#34; %}</p>
<p style="position:absolute;top:706px;left:108px;white-space:nowrap" class="ft463">{% block title %}Flasky{% endblock %}</p>
<p style="position:absolute;top:737px;left:108px;white-space:nowrap" class="ft4666">{% block navbar %}<br/><b>&lt;div</b>&#160;class=&#34;navbar navbar-inverse&#34;&#160;role=&#34;navigation&#34;<b>&gt;<br/></b>&#160; &#160;&#160;<b>&lt;div</b>&#160;class=&#34;container&#34;<b>&gt;<br/></b>&#160; &#160; &#160; &#160;&#160;<b>&lt;div</b>&#160;class=&#34;navbar-header&#34;<b>&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;button</b>&#160;type=&#34;button&#34;&#160;class=&#34;navbar-toggle&#34;<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160;data-toggle=&#34;collapse&#34;&#160;data-target=&#34;.navbar-collapse&#34;<b>&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;span</b>&#160;class=&#34;sr-only&#34;<b>&gt;</b>Toggle navigation<b>&lt;/span&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;span</b>&#160;class=&#34;icon-bar&#34;<b>&gt;&lt;/span&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;span</b>&#160;class=&#34;icon-bar&#34;<b>&gt;&lt;/span&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;span</b>&#160;class=&#34;icon-bar&#34;<b>&gt;&lt;/span&gt;</b></p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft465"><b>26&#160;&#160;|&#160;&#160;Chapter 3: Templates</b></p>
</div>
<!-- Page 47 -->
<a name="47"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page47-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask047.png" alt="background image"/>
<p style="position:absolute;top:82px;left:108px;white-space:nowrap" class="ft4766">&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;/button&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;a</b>&#160;class=&#34;navbar-brand&#34;&#160;href=&#34;/&#34;<b>&gt;</b>Flasky<b>&lt;/a&gt;<br/></b>&#160; &#160; &#160; &#160;&#160;<b>&lt;/div&gt;<br/></b>&#160; &#160; &#160; &#160;&#160;<b>&lt;div</b>&#160;class=&#34;navbar-collapse collapse&#34;<b>&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;ul</b>&#160;class=&#34;nav navbar-nav&#34;<b>&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;li&gt;&lt;a</b>&#160;href=&#34;/&#34;<b>&gt;</b>Home<b>&lt;/a&gt;&lt;/li&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;/ul&gt;<br/></b>&#160; &#160; &#160; &#160;&#160;<b>&lt;/div&gt;<br/></b>&#160; &#160;&#160;<b>&lt;/div&gt;<br/>&lt;/div&gt;<br/></b>{% endblock %}</p>
<p style="position:absolute;top:266px;left:108px;white-space:nowrap" class="ft4766">{% block content %}<br/><b>&lt;div</b>&#160;class=&#34;container&#34;<b>&gt;<br/></b>&#160; &#160;&#160;<b>&lt;div</b>&#160;class=&#34;page-header&#34;<b>&gt;<br/></b>&#160; &#160; &#160; &#160;&#160;<b>&lt;h1&gt;</b>Hello, {{ name }}!<b>&lt;/h1&gt;<br/></b>&#160; &#160;&#160;<b>&lt;/div&gt;<br/>&lt;/div&gt;<br/></b>{% endblock %}</p>
<p style="position:absolute;top:385px;left:108px;white-space:nowrap" class="ft4714">The Jinja2&#160;extends&#160;directive implements the template inheritance by referencing&#160;<i>boot‐</i></p>
<p style="position:absolute;top:405px;left:108px;white-space:nowrap" class="ft4710"><i>strap/base.html</i></p>
<p style="position:absolute;top:404px;left:204px;white-space:nowrap" class="ft4714">&#160;from Flask-Bootstrap. The base template from Flask-Bootstrap provides</p>
<p style="position:absolute;top:423px;left:108px;white-space:nowrap" class="ft4746">a skeleton web page that includes all the Bootstrap CSS and JavaScript files.<br/>Base templates define&#160;<i>blocks</i>&#160;that can be overriden by derived templates. The&#160;block&#160;and<br/>endblock</p>
<p style="position:absolute;top:472px;left:168px;white-space:nowrap" class="ft4714">&#160;directives define blocks of content that are added to the base template.</p>
<p style="position:absolute;top:500px;left:108px;white-space:nowrap" class="ft4714">The&#160;<i>user.html</i>&#160;template above defines three blocks called&#160;title,&#160;navbar, and&#160;content.</p>
<p style="position:absolute;top:519px;left:108px;white-space:nowrap" class="ft4746">These are all blocks that the base template exports for derived templates to define. The<br/>title</p>
<p style="position:absolute;top:539px;left:145px;white-space:nowrap" class="ft4714">&#160;block is straightforward; its contents will appear between&#160;&lt;title&gt;&#160;tags in the</p>
<p style="position:absolute;top:559px;left:108px;white-space:nowrap" class="ft4714">header of the rendered HTML document. The&#160;navbar&#160;and&#160;content&#160;blocks are reserved</p>
<p style="position:absolute;top:578px;left:108px;white-space:nowrap" class="ft4748">for the page navigation bar and main content.<br/>In this template, the&#160;navbar&#160;block defines a simple navigation bar using Bootstrap com‐</p>
<p style="position:absolute;top:626px;left:108px;white-space:nowrap" class="ft4714">ponents. The&#160;content&#160;block has a container&#160;&lt;div&gt;&#160;with a page header inside. The greet‐</p>
<p style="position:absolute;top:645px;left:108px;white-space:nowrap" class="ft4714">ing line that was in the previous version of the template is now inside the page header.</p>
<p style="position:absolute;top:664px;left:108px;white-space:nowrap" class="ft4717"><a href="Flask.html#47">Figure 3-1</a>&#160;shows how the application looks with these changes.</p>
<p style="position:absolute;top:706px;left:198px;white-space:nowrap" class="ft4725">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:724px;left:198px;white-space:nowrap" class="ft4725">run&#160;git&#160;checkout&#160;3b&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:741px;left:198px;white-space:nowrap" class="ft4725">The&#160;<a href="http://getbootstrap.com/">Bootstrap&#160;official&#160;documentation</a>&#160;is&#160;a&#160;great&#160;learning&#160;resource&#160;full</p>
<p style="position:absolute;top:758px;left:198px;white-space:nowrap" class="ft4725">of&#160;copy/paste-ready&#160;examples.</p>
<p style="position:absolute;top:915px;left:379px;white-space:nowrap" class="ft475"><b>Twitter Bootstrap Integration with Flask-Bootstrap &#160;&#160;|&#160;&#160;27</b></p>
</div>
<!-- Page 48 -->
<a name="48"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page48-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask048.png" alt="background image"/>
<p style="position:absolute;top:345px;left:108px;white-space:nowrap" class="ft4810"><i>Figure 3-1. Twitter Bootstrap templates</i></p>
<p style="position:absolute;top:381px;left:108px;white-space:nowrap" class="ft4814">Flask-Bootstrap’s&#160;<i>base.html</i>&#160;template defines several other blocks that can be used in</p>
<p style="position:absolute;top:399px;left:108px;white-space:nowrap" class="ft4848">derived templa<a href="Flask.html#48">tes.&#160;Table 3-2&#160;shows the com</a>plete list of available blocks.<br/><i>Table 3-2. Flask-Bootstrap’s base template blocks</i></p>
<p style="position:absolute;top:456px;left:113px;white-space:nowrap" class="ft4853"><b>Block&#160;name</b></p>
<p style="position:absolute;top:456px;left:214px;white-space:nowrap" class="ft4853"><b>Description</b></p>
<p style="position:absolute;top:481px;left:113px;white-space:nowrap" class="ft4814">doc</p>
<p style="position:absolute;top:478px;left:214px;white-space:nowrap" class="ft4830">The&#160;entire&#160;HTML&#160;document</p>
<p style="position:absolute;top:505px;left:113px;white-space:nowrap" class="ft4814">html_attribs&#160;Attributes&#160;inside&#160;the&#160;&lt;html&gt;&#160;tag</p>
<p style="position:absolute;top:529px;left:113px;white-space:nowrap" class="ft4814">html</p>
<p style="position:absolute;top:526px;left:214px;white-space:nowrap" class="ft4830">The&#160;contents&#160;of&#160;the&#160;&lt;html&gt;&#160;tag</p>
<p style="position:absolute;top:553px;left:113px;white-space:nowrap" class="ft4814">head</p>
<p style="position:absolute;top:550px;left:214px;white-space:nowrap" class="ft4830">The&#160;contents&#160;of&#160;the&#160;&lt;head&gt;&#160;tag</p>
<p style="position:absolute;top:577px;left:113px;white-space:nowrap" class="ft4814">title</p>
<p style="position:absolute;top:574px;left:214px;white-space:nowrap" class="ft4830">The&#160;contents&#160;of&#160;the&#160;&lt;title&gt;&#160;tag</p>
<p style="position:absolute;top:601px;left:113px;white-space:nowrap" class="ft4814">metas</p>
<p style="position:absolute;top:598px;left:214px;white-space:nowrap" class="ft4830">The&#160;list&#160;of&#160;&lt;meta&gt;&#160;tags</p>
<p style="position:absolute;top:625px;left:113px;white-space:nowrap" class="ft4814">styles</p>
<p style="position:absolute;top:622px;left:214px;white-space:nowrap" class="ft4830">Cascading&#160;stylesheet&#160;definitions</p>
<p style="position:absolute;top:649px;left:113px;white-space:nowrap" class="ft4814">body_attribs&#160;Attributes&#160;inside&#160;the&#160;&lt;body&gt;&#160;tag</p>
<p style="position:absolute;top:673px;left:113px;white-space:nowrap" class="ft4814">body</p>
<p style="position:absolute;top:671px;left:214px;white-space:nowrap" class="ft4830">The&#160;contents&#160;of&#160;the&#160;&lt;body&gt;&#160;tag</p>
<p style="position:absolute;top:697px;left:113px;white-space:nowrap" class="ft4814">navbar</p>
<p style="position:absolute;top:695px;left:214px;white-space:nowrap" class="ft4830">User-defined&#160;navigation&#160;bar</p>
<p style="position:absolute;top:721px;left:113px;white-space:nowrap" class="ft4814">content</p>
<p style="position:absolute;top:719px;left:214px;white-space:nowrap" class="ft4830">User-defined&#160;page&#160;content</p>
<p style="position:absolute;top:745px;left:113px;white-space:nowrap" class="ft4814">scripts</p>
<p style="position:absolute;top:743px;left:214px;white-space:nowrap" class="ft4830">JavaScript&#160;declarations&#160;at&#160;the&#160;bottom&#160;of&#160;the&#160;document</p>
<p style="position:absolute;top:778px;left:108px;white-space:nowrap" class="ft4814">Many of the blocks in&#160;<a href="Flask.html#48">Table 3-2</a>&#160;are used by Flask-Bootstrap itself, so overriding them</p>
<p style="position:absolute;top:798px;left:108px;white-space:nowrap" class="ft4814">directly would cause problems. For example, the&#160;styles&#160;and&#160;scripts&#160;blocks are where</p>
<p style="position:absolute;top:817px;left:108px;white-space:nowrap" class="ft4814">the Bootstrap files are declared. If the application needs to add its own content to a block</p>
<p style="position:absolute;top:837px;left:108px;white-space:nowrap" class="ft4814">that already has some content, then Jinja2’s&#160;super()&#160;function must be used. For example,</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft485"><b>28&#160;&#160;|&#160;&#160;Chapter 3: Templates</b></p>
</div>
<!-- Page 49 -->
<a name="49"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page49-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask049.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft4914">this is how the&#160;scripts&#160;block would need to be written in the derived template to add</p>
<p style="position:absolute;top:98px;left:108px;white-space:nowrap" class="ft4914">a new JavaScript file to the document:</p>
<p style="position:absolute;top:130px;left:133px;white-space:nowrap" class="ft4966">{% block scripts %}<br/>{{ super() }}<br/><b>&lt;script&#160;</b>type=&#34;text/javascript&#34;&#160;src=&#34;my-script.js&#34;<b>&gt;&lt;/script&gt;<br/></b>{% endblock %}</p>
<p style="position:absolute;top:204px;left:108px;white-space:nowrap" class="ft4918"><b>Custom Error Pages<br/></b>When you enter an invalid route in your browser’s address bar, you get a code 404 error</p>
<p style="position:absolute;top:264px;left:108px;white-space:nowrap" class="ft4914">page. The error page is now too plain and unattractive, and it has no consistency with</p>
<p style="position:absolute;top:283px;left:108px;white-space:nowrap" class="ft4915">the page that uses Bootstrap.<br/>Flask allows an application to define custom error pages that can be based on templates,</p>
<p style="position:absolute;top:329px;left:108px;white-space:nowrap" class="ft4914">like regular routes. The two most common error codes are 404, triggered when the client</p>
<p style="position:absolute;top:348px;left:108px;white-space:nowrap" class="ft4914">requests a page or route that is not known, and 500, triggered when there is an unhandled</p>
<p style="position:absolute;top:367px;left:108px;white-space:nowrap" class="ft4914">exception.&#160;<a href="Flask.html#49">Example 3-6&#160;shows how to provide custom handlers for these two errors.</a></p>
<p style="position:absolute;top:399px;left:108px;white-space:nowrap" class="ft4947"><i>Example 3-6. hello.py: Custom error pages<br/></i>@app.errorhandler(404)<br/><b>def</b>&#160;page_not_found(e):<br/>&#160; &#160;&#160;<b>return</b>&#160;render_template('404.html'),&#160;404</p>
<p style="position:absolute;top:488px;left:108px;white-space:nowrap" class="ft4947">@app.errorhandler(500)<br/><b>def</b>&#160;internal_server_error(e):<br/>&#160; &#160;&#160;<b>return</b>&#160;render_template('500.html'),&#160;500</p>
<p style="position:absolute;top:545px;left:108px;white-space:nowrap" class="ft4914">Error handlers return a response, like view functions. They also return the numeric</p>
<p style="position:absolute;top:564px;left:108px;white-space:nowrap" class="ft4915">status code that corresponds to the error.<br/>The templates referenced in the error handlers need to be written. These templates</p>
<p style="position:absolute;top:611px;left:108px;white-space:nowrap" class="ft4914">should follow the same layout of the regular pages, so in this case they will have a</p>
<p style="position:absolute;top:630px;left:108px;white-space:nowrap" class="ft4915">navigation bar and a page header that shows the error message.<br/>The straightforward way to write these templates is to copy&#160;<i>templates/user.html</i>&#160;to</p>
<p style="position:absolute;top:678px;left:108px;white-space:nowrap" class="ft4910"><i>templates/404.html</i></p>
<p style="position:absolute;top:677px;left:228px;white-space:nowrap" class="ft4914">&#160;and&#160;<i>templates/500.html</i>&#160;and then change the page header element</p>
<p style="position:absolute;top:695px;left:108px;white-space:nowrap" class="ft4914">in these two new files to the appropriate error message, but this will generate a lot of</p>
<p style="position:absolute;top:714px;left:108px;white-space:nowrap" class="ft4915">duplication.<br/>Jinja2’s template inheritance can help with this. In the same way Flask-Bootstrap pro‐</p>
<p style="position:absolute;top:761px;left:108px;white-space:nowrap" class="ft4914">vides a base template with the basic layout of the page, the application can define its</p>
<p style="position:absolute;top:780px;left:108px;white-space:nowrap" class="ft4914">own base template with a more complete page layout that includes the navigation bar</p>
<p style="position:absolute;top:799px;left:108px;white-space:nowrap" class="ft4914">and leaves the page content to be defined in derived templa<a href="Flask.html#49">tes.&#160;Example 3-7&#160;</a>shows</p>
<p style="position:absolute;top:819px;left:108px;white-space:nowrap" class="ft4910"><i>templates/base.html</i></p>
<p style="position:absolute;top:818px;left:232px;white-space:nowrap" class="ft4914">, a new template that inherits from&#160;<i>bootstrap/base.html</i>&#160;and defines</p>
<p style="position:absolute;top:837px;left:108px;white-space:nowrap" class="ft4914">the navigation bar, but is itself a base template to other templates such as&#160;<i>templates/</i></p>
<p style="position:absolute;top:857px;left:108px;white-space:nowrap" class="ft4910"><i>user.html</i></p>
<p style="position:absolute;top:856px;left:167px;white-space:nowrap" class="ft4914">,&#160;<i>templates/404.html</i>, and&#160;<i>templates/500.html</i>.</p>
<p style="position:absolute;top:915px;left:521px;white-space:nowrap" class="ft495"><b>Custom Error Pages&#160;&#160;|&#160;&#160;29</b></p>
</div>
<!-- Page 50 -->
<a name="50"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft5069{font-size:13px;line-height:18px;font-family:Times;color:#231f20;}
-->
</style>
<div id="page50-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask050.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft5050"><i>Example 3-7. templates/base.html: Base application template with navigation bar<br/></i>{% extends &#34;bootstrap/base.html&#34; %}</p>
<p style="position:absolute;top:138px;left:108px;white-space:nowrap" class="ft503">{% block title %}Flasky{% endblock %}</p>
<p style="position:absolute;top:168px;left:108px;white-space:nowrap" class="ft5066">{% block navbar %}<br/><b>&lt;div</b>&#160;class=&#34;navbar navbar-inverse&#34;&#160;role=&#34;navigation&#34;<b>&gt;<br/></b>&#160; &#160;&#160;<b>&lt;div</b>&#160;class=&#34;container&#34;<b>&gt;<br/></b>&#160; &#160; &#160; &#160;&#160;<b>&lt;div</b>&#160;class=&#34;navbar-header&#34;<b>&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;button</b>&#160;type=&#34;button&#34;&#160;class=&#34;navbar-toggle&#34;<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160;data-toggle=&#34;collapse&#34;&#160;data-target=&#34;.navbar-collapse&#34;<b>&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;span</b>&#160;class=&#34;sr-only&#34;<b>&gt;</b>Toggle navigation<b>&lt;/span&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;span</b>&#160;class=&#34;icon-bar&#34;<b>&gt;&lt;/span&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;span</b>&#160;class=&#34;icon-bar&#34;<b>&gt;&lt;/span&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;span</b>&#160;class=&#34;icon-bar&#34;<b>&gt;&lt;/span&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;/button&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;a</b>&#160;class=&#34;navbar-brand&#34;&#160;href=&#34;/&#34;<b>&gt;</b>Flasky<b>&lt;/a&gt;<br/></b>&#160; &#160; &#160; &#160;&#160;<b>&lt;/div&gt;<br/></b>&#160; &#160; &#160; &#160;&#160;<b>&lt;div</b>&#160;class=&#34;navbar-collapse collapse&#34;<b>&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;ul</b>&#160;class=&#34;nav navbar-nav&#34;<b>&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;li&gt;&lt;a</b>&#160;href=&#34;/&#34;<b>&gt;</b>Home<b>&lt;/a&gt;&lt;/li&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;/ul&gt;<br/></b>&#160; &#160; &#160; &#160;&#160;<b>&lt;/div&gt;<br/></b>&#160; &#160;&#160;<b>&lt;/div&gt;<br/>&lt;/div&gt;<br/></b>{% endblock %}</p>
<p style="position:absolute;top:505px;left:108px;white-space:nowrap" class="ft5066">{% block content %}<br/><b>&lt;div</b>&#160;class=&#34;container&#34;<b>&gt;<br/></b>&#160; &#160; {% block page_content %}{% endblock %}<br/><b>&lt;/div&gt;<br/></b>{% endblock %}</p>
<p style="position:absolute;top:594px;left:108px;white-space:nowrap" class="ft5014">In the&#160;content&#160;block of this template is just a container&#160;&lt;div&gt;&#160;element that wraps a new</p>
<p style="position:absolute;top:613px;left:108px;white-space:nowrap" class="ft5015">empty block called&#160;page_content, which derived templates can define.<br/>The templates of the application will now inherit from this template instead of directly</p>
<p style="position:absolute;top:660px;left:108px;white-space:nowrap" class="ft5014">from Flask-Bootstrap.&#160;<a href="Flask.html#50">Example 3-8</a>&#160;shows how simple it is to construct a custom code</p>
<p style="position:absolute;top:679px;left:108px;white-space:nowrap" class="ft5014">404 error page that inherits from&#160;<i>templates/base.html</i>.</p>
<p style="position:absolute;top:711px;left:108px;white-space:nowrap" class="ft5050"><i>Example 3-8.&#160;templates/404.html: Custom code 404 error page using template inheri‐<br/>tance<br/></i>{% extends &#34;base.html&#34; %}</p>
<p style="position:absolute;top:788px;left:108px;white-space:nowrap" class="ft503">{% block title %}Flasky - Page Not Found{% endblock %}</p>
<p style="position:absolute;top:819px;left:108px;white-space:nowrap" class="ft5066">{% block page_content %}<br/><b>&lt;div</b>&#160;class=&#34;page-header&#34;<b>&gt;<br/></b>&#160; &#160;&#160;<b>&lt;h1&gt;</b>Not Found<b>&lt;/h1&gt;</b></p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft505"><b>30&#160;&#160;|&#160;&#160;Chapter 3: Templates</b></p>
</div>
<!-- Page 51 -->
<a name="51"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page51-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask051.png" alt="background image"/>
<p style="position:absolute;top:82px;left:108px;white-space:nowrap" class="ft5166"><b>&lt;/div&gt;<br/></b>{% endblock %}</p>
<p style="position:absolute;top:124px;left:108px;white-space:nowrap" class="ft5117"><a href="Flask.html#51">Figure 3-2</a>&#160;shows how the error page looks in the browser.</p>
<p style="position:absolute;top:433px;left:108px;white-space:nowrap" class="ft5110"><i>Figure 3-2. Custom code 404 error page</i></p>
<p style="position:absolute;top:469px;left:108px;white-space:nowrap" class="ft5114">The&#160;<i>templates/user.html</i>&#160;template can now be simplified by making it inherit from the</p>
<p style="position:absolute;top:488px;left:108px;white-space:nowrap" class="ft5114">base templa<a href="Flask.html#51">te, as shown in&#160;Example 3-9.</a></p>
<p style="position:absolute;top:520px;left:108px;white-space:nowrap" class="ft5150"><i>Example 3-9. templates/user.html: Simplified page template using template inheritance<br/></i>{% extends &#34;base.html&#34; %}</p>
<p style="position:absolute;top:578px;left:108px;white-space:nowrap" class="ft513">{% block title %}Flasky{% endblock %}</p>
<p style="position:absolute;top:609px;left:108px;white-space:nowrap" class="ft5166">{% block page_content %}<br/><b>&lt;div</b>&#160;class=&#34;page-header&#34;<b>&gt;<br/></b>&#160; &#160;&#160;<b>&lt;h1&gt;</b>Hello, {{ name }}!<b>&lt;/h1&gt;<br/>&lt;/div&gt;<br/></b>{% endblock %}</p>
<p style="position:absolute;top:704px;left:198px;white-space:nowrap" class="ft5125">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:722px;left:198px;white-space:nowrap" class="ft5125">run&#160;git&#160;checkout&#160;3c&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:806px;left:108px;white-space:nowrap" class="ft5118"><b>Links<br/></b>Any application that has more than one route will invariably need to include links that</p>
<p style="position:absolute;top:866px;left:108px;white-space:nowrap" class="ft5114">connect the different pages, such as in a navigation bar.</p>
<p style="position:absolute;top:915px;left:584px;white-space:nowrap" class="ft515"><b>Links&#160;&#160;|&#160;&#160;31</b></p>
</div>
<!-- Page 52 -->
<a name="52"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page52-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask052.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft5214">Writing the URLs as links directly in the template is trivial for simple routes, but for</p>
<p style="position:absolute;top:97px;left:108px;white-space:nowrap" class="ft5214">dynamic routes with variable portions it can get more complicated to build the URLs</p>
<p style="position:absolute;top:116px;left:108px;white-space:nowrap" class="ft5214">right in the template. Also, URLs written explicitly create an unwanted dependency on</p>
<p style="position:absolute;top:135px;left:108px;white-space:nowrap" class="ft5214">the routes defined in the code. If the routes are reorganized, links in templates may</p>
<p style="position:absolute;top:154px;left:108px;white-space:nowrap" class="ft5248">break.<br/>To avoid these problems, Flask provides the&#160;url_for()&#160;helper function, which generates</p>
<p style="position:absolute;top:202px;left:108px;white-space:nowrap" class="ft5215">URLs from the information stored in the application’s URL map.<br/>In its simplest usage, this function takes the view function name (or&#160;<i>endpoint</i>&#160;name for</p>
<p style="position:absolute;top:249px;left:108px;white-space:nowrap" class="ft5214">routes defined with&#160;app.add_url_route()) as its single argument and returns its URL.</p>
<p style="position:absolute;top:269px;left:108px;white-space:nowrap" class="ft5214">For example, in the current version of&#160;<i>hello.py</i>&#160;the call&#160;url_for('index')&#160;would re‐</p>
<p style="position:absolute;top:289px;left:108px;white-space:nowrap" class="ft5214">turn&#160;<i>/</i>. Calling&#160;url_for('index', _external=True)&#160;would instead return an absolute</p>
<p style="position:absolute;top:308px;left:108px;white-space:nowrap" class="ft5214">URL, which in this example is&#160;<i>http://localhost:5000/</i>.</p>
<p style="position:absolute;top:347px;left:198px;white-space:nowrap" class="ft5225">Relative&#160;URLs&#160;are&#160;sufficient&#160;when&#160;generating&#160;links&#160;that&#160;connect&#160;the</p>
<p style="position:absolute;top:365px;left:198px;white-space:nowrap" class="ft5225">different&#160;routes&#160;of&#160;the&#160;application.&#160;Absolute&#160;URLs&#160;are&#160;necessary&#160;on‐</p>
<p style="position:absolute;top:382px;left:198px;white-space:nowrap" class="ft5225">ly&#160;for&#160;links&#160;that&#160;will&#160;be&#160;used&#160;outside&#160;of&#160;the&#160;web&#160;browser,&#160;such&#160;as&#160;when</p>
<p style="position:absolute;top:399px;left:198px;white-space:nowrap" class="ft5225">sending&#160;links&#160;by&#160;email.</p>
<p style="position:absolute;top:453px;left:108px;white-space:nowrap" class="ft5214">Dynamic URLs can be generated with&#160;url_for()&#160;by passing the dynamic parts as key‐</p>
<p style="position:absolute;top:473px;left:108px;white-space:nowrap" class="ft5214">word arguments. For example,&#160;url_for('user', name='john', _external=True)</p>
<p style="position:absolute;top:492px;left:108px;white-space:nowrap" class="ft5248">would return&#160;<i>http://localhost:5000/user/john</i>.<br/>The keyword arguments sent to&#160;url_for()&#160;are not limited to arguments used by dy‐</p>
<p style="position:absolute;top:540px;left:108px;white-space:nowrap" class="ft5214">namic routes. The function will add any extra arguments to the query string. For ex‐</p>
<p style="position:absolute;top:559px;left:108px;white-space:nowrap" class="ft5214">ample,&#160;url_for('index', page=2)&#160;would return&#160;<i>/?page=2</i>.</p>
<p style="position:absolute;top:597px;left:108px;white-space:nowrap" class="ft5222"><b>Static Files&#160;<br/></b>Web applications are not made of Python code and templates alone. Most applications</p>
<p style="position:absolute;top:657px;left:108px;white-space:nowrap" class="ft5214">also use static files such as images, JavaScript source files, and CSS that are referenced</p>
<p style="position:absolute;top:676px;left:108px;white-space:nowrap" class="ft5215">from the HTML code.<br/>You may recall that when the&#160;<i>hello.py</i>&#160;application’s URL map was inspected in&#160;<a href="Flask.html#27">Chap‐</a></p>
<p style="position:absolute;top:724px;left:108px;white-space:nowrap" class="ft5217"><a href="Flask.html#27">ter 2</a>, a&#160;static&#160;entry appeared in it. This is so because references to static files are treated</p>
<p style="position:absolute;top:743px;left:108px;white-space:nowrap" class="ft5246">as a special route defined as&#160;<i>/static/&lt;filename&gt;</i>. For example, a call to<br/>url_for('static', filename='css/styles.css', _external=True)</p>
<p style="position:absolute;top:762px;left:560px;white-space:nowrap" class="ft5214">&#160;would return</p>
<p style="position:absolute;top:782px;left:108px;white-space:nowrap" class="ft5210"><i>http://localhost:5000/static/css/styles.css</i></p>
<p style="position:absolute;top:781px;left:353px;white-space:nowrap" class="ft5214">.</p>
<p style="position:absolute;top:809px;left:108px;white-space:nowrap" class="ft5214">In its default configuration, Flask looks for static files in a subdirectory called&#160;<i>static</i></p>
<p style="position:absolute;top:828px;left:108px;white-space:nowrap" class="ft5214">located in the application’s root folder. Files can be organized in subdirectories inside</p>
<p style="position:absolute;top:847px;left:108px;white-space:nowrap" class="ft5214">this folder if desired. When the server receives the URL from the previous example, it</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft525"><b>32&#160;&#160;|&#160;&#160;Chapter 3: Templates</b></p>
</div>
<!-- Page 53 -->
<a name="53"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page53-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask053.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft5314">generates a response that includes the contents of a file in the filesystem located at&#160;<i>static/</i></p>
<p style="position:absolute;top:98px;left:108px;white-space:nowrap" class="ft5310"><i>css/styles.css</i></p>
<p style="position:absolute;top:97px;left:183px;white-space:nowrap" class="ft5314">.</p>
<p style="position:absolute;top:125px;left:108px;white-space:nowrap" class="ft5317"><a href="Flask.html#53">Example 3-10&#160;shows how the a</a>pplication can include a&#160;<i>favicon.ico</i>&#160;icon in the base</p>
<p style="position:absolute;top:144px;left:108px;white-space:nowrap" class="ft5314">template for browsers to show in the address bar.</p>
<p style="position:absolute;top:176px;left:108px;white-space:nowrap" class="ft5366"><i>Example 3-10. templates/base.html: favicon definition<br/></i>{% block head %}<br/>{{ super() }}<br/><b>&lt;link</b>&#160;rel=&#34;shortcut icon&#34;&#160;href=&#34;{{ url_for('static', filename = 'favicon.ico') }}&#34;<br/>&#160; &#160;&#160;type=&#34;image/x-icon&#34;<b>&gt;<br/>&lt;link</b>&#160;rel=&#34;icon&#34;&#160;href=&#34;{{ url_for('static', filename = 'favicon.ico') }}&#34;<br/>&#160; &#160;&#160;type=&#34;image/x-icon&#34;<b>&gt;<br/></b>{% endblock %}</p>
<p style="position:absolute;top:323px;left:108px;white-space:nowrap" class="ft5314">The icon declaration is inserted at the end of the&#160;head&#160;block. Note how&#160;super()&#160;is used</p>
<p style="position:absolute;top:342px;left:108px;white-space:nowrap" class="ft5314">to preserve the original contents of the block defined in the base templates.</p>
<p style="position:absolute;top:383px;left:198px;white-space:nowrap" class="ft5325">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:402px;left:198px;white-space:nowrap" class="ft5325">run&#160;git&#160;checkout&#160;3d&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:486px;left:108px;white-space:nowrap" class="ft5318"><b>Localization of Dates and Times with Flask-Moment<br/></b>Handling of dates and times in a web application is not a trivial problem when users</p>
<p style="position:absolute;top:545px;left:108px;white-space:nowrap" class="ft5315">work in different parts of the world.<br/>The server needs uniform time units that are independent of the location of each user,</p>
<p style="position:absolute;top:592px;left:108px;white-space:nowrap" class="ft5314">so typically Coordinated Universal Time (UTC) is used. For users, however, seeing times</p>
<p style="position:absolute;top:611px;left:108px;white-space:nowrap" class="ft5314">expressed in UTC can be confusing, as users always expect to see dates and times pre‐</p>
<p style="position:absolute;top:629px;left:108px;white-space:nowrap" class="ft5315">sented in their local time and formatted according to the local customs of their region.<br/>An elegant solution that allows the server to work exclusively in UTC is to send these</p>
<p style="position:absolute;top:676px;left:108px;white-space:nowrap" class="ft5314">time units to the web browser, where they are converted to local time and rendered.</p>
<p style="position:absolute;top:695px;left:108px;white-space:nowrap" class="ft5314">Web browsers can do a much better job at this task because they have access to time</p>
<p style="position:absolute;top:714px;left:108px;white-space:nowrap" class="ft5315">zone and locale settings on the user’s computer.<br/>There is an excellent client-side open source library written in JavaScript that renders</p>
<p style="position:absolute;top:761px;left:108px;white-space:nowrap" class="ft5314">da<a href="http://momentjs.com">tes and times in the browser called&#160;moment.js</a>. Flask-Moment is an extension for</p>
<p style="position:absolute;top:780px;left:108px;white-space:nowrap" class="ft5314">Flask applications that integrates&#160;<i>moment.js</i>&#160;into Jinja2 templates. Flask-Moment is in‐</p>
<p style="position:absolute;top:799px;left:108px;white-space:nowrap" class="ft5314">stalled with pip:</p>
<p style="position:absolute;top:830px;left:133px;white-space:nowrap" class="ft5333">(venv)&#160;$&#160;pip install flask-moment</p>
<p style="position:absolute;top:851px;left:108px;white-space:nowrap" class="ft5314">The extension is initialized as shown in&#160;<a href="Flask.html#53">Example 3-11</a>.</p>
<p style="position:absolute;top:915px;left:379px;white-space:nowrap" class="ft535"><b>Localization of Dates and Times with Flask-Moment&#160;&#160;|&#160;&#160;33</b></p>
</div>
<!-- Page 54 -->
<a name="54"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page54-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask054.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft5440"><i>Example 3-11. hello.py: Initialize Flask-Moment<br/></i><b>from</b>&#160;<b>flask.ext.moment</b>&#160;<b>import</b>&#160;Moment<br/>moment&#160;=&#160;Moment(app)</p>
<p style="position:absolute;top:149px;left:108px;white-space:nowrap" class="ft5414">Flask-Moment depends on&#160;<i>jquery.js</i>&#160;in addition to&#160;<i>moment.js</i>. These two libraries need</p>
<p style="position:absolute;top:168px;left:108px;white-space:nowrap" class="ft5414">to be included somewhere in the HTML document—either directly, in which case you</p>
<p style="position:absolute;top:187px;left:108px;white-space:nowrap" class="ft5414">can choose what versions to use, or through the helper functions provided by the ex‐</p>
<p style="position:absolute;top:206px;left:108px;white-space:nowrap" class="ft5414">tension, which reference tested versions of these libraries from a Content Delivery Net‐</p>
<p style="position:absolute;top:225px;left:108px;white-space:nowrap" class="ft5414">work (CDN). Because Bootstrap already includes&#160;<i>jquery.js</i>, only&#160;<i>moment.js</i>&#160;needs to be</p>
<p style="position:absolute;top:244px;left:108px;white-space:nowrap" class="ft5414">added in this case.&#160;<a href="Flask.html#54">Example 3-12</a>&#160;shows how this library is loaded in the&#160;scripts&#160;of the</p>
<p style="position:absolute;top:263px;left:108px;white-space:nowrap" class="ft5414">base template.</p>
<p style="position:absolute;top:295px;left:108px;white-space:nowrap" class="ft5423"><i>Example 3-12. templates/base.html: Import moment.js library<br/></i>{% block scripts %}<br/>{{ super() }}<br/>{{ moment.include_moment() }}<br/>{% endblock %}</p>
<p style="position:absolute;top:396px;left:108px;white-space:nowrap" class="ft5414">To work with timestamps Flask-Moment makes a&#160;moment&#160;class available to templates.</p>
<p style="position:absolute;top:416px;left:108px;white-space:nowrap" class="ft5414">The exam<a href="Flask.html#54">ple in&#160;Example 3-13</a>&#160;passes a variable called&#160;current_time&#160;to the template for</p>
<p style="position:absolute;top:435px;left:108px;white-space:nowrap" class="ft5414">rendering.</p>
<p style="position:absolute;top:467px;left:108px;white-space:nowrap" class="ft5450"><i>Example 3-13. hello.py: Add a datetime variable<br/></i><b>from</b>&#160;<b>datetime</b>&#160;<b>import</b>&#160;datetime</p>
<p style="position:absolute;top:525px;left:108px;white-space:nowrap" class="ft5447">@app.route('/')<br/><b>def</b>&#160;index():<br/>&#160; &#160;&#160;<b>return</b>&#160;render_template('index.html',<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;current_time=datetime.utcnow())</p>
<p style="position:absolute;top:598px;left:108px;white-space:nowrap" class="ft5417"><a href="Flask.html#54">Example 3-14&#160;shows how&#160;</a>current_time&#160;is rendered in the template.&#160;</p>
<p style="position:absolute;top:630px;left:108px;white-space:nowrap" class="ft5466"><i>Example 3-14. templates/index.html: Timestamp rendering with Flask-Moment<br/></i><b>&lt;p&gt;</b>The local date and time is {{ moment(current_time).format('LLL') }}.<b>&lt;/p&gt;<br/>&lt;p&gt;</b>That was {{ moment(current_time).fromNow(refresh=True) }}<b>&lt;/p&gt;</b></p>
<p style="position:absolute;top:701px;left:108px;white-space:nowrap" class="ft5414">The&#160;format('LLL')&#160;format renders the date and time according to the time zone and</p>
<p style="position:absolute;top:720px;left:108px;white-space:nowrap" class="ft5414">locale settings in the client computer. The argument determines the rendering style,</p>
<p style="position:absolute;top:739px;left:108px;white-space:nowrap" class="ft5414">from&#160;'L'&#160;to&#160;'LLLL'&#160;for different levels of verbosity. The&#160;format()&#160;function can also</p>
<p style="position:absolute;top:758px;left:108px;white-space:nowrap" class="ft5448">accept custom format specifiers.<br/>The&#160;fromNow()&#160;render style shown in the second line renders a relative timestamp and</p>
<p style="position:absolute;top:806px;left:108px;white-space:nowrap" class="ft5414">automatically refreshes it as time passes. Initially this timestamp will be shown as “a few</p>
<p style="position:absolute;top:825px;left:108px;white-space:nowrap" class="ft5414">seconds ago,” but the refresh option will keep it updated as time passes, so if you leave</p>
<p style="position:absolute;top:844px;left:108px;white-space:nowrap" class="ft5414">the page open for a few minutes you will see the text changing to “a minute ago,” then</p>
<p style="position:absolute;top:863px;left:108px;white-space:nowrap" class="ft5414">“2 minutes ago,” and so on.</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft545"><b>34&#160;&#160;|&#160;&#160;Chapter 3: Templates</b></p>
</div>
<!-- Page 55 -->
<a name="55"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft5570{font-size:11px;font-family:Times;color:#990000;}
-->
</style>
<div id="page55-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask055.png" alt="background image"/>
<p style="position:absolute;top:85px;left:198px;white-space:nowrap" class="ft5525">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:103px;left:198px;white-space:nowrap" class="ft5525">run&#160;git&#160;checkout&#160;3e&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:193px;left:108px;white-space:nowrap" class="ft5546">Flask-Moment implements the&#160;format(),&#160;fromNow(),&#160;fromTime(),&#160;calendar(),<br/>valueOf()</p>
<p style="position:absolute;top:212px;left:175px;white-space:nowrap" class="ft5514">, and&#160;unix()&#160;methods from&#160;<i>moment.js</i>. Consult the&#160;<a href="http://momentjs.com/docs/#/displaying/">documentation</a>&#160;to learn</p>
<p style="position:absolute;top:231px;left:108px;white-space:nowrap" class="ft5514">about all the formatting options offered.</p>
<p style="position:absolute;top:271px;left:198px;white-space:nowrap" class="ft5525">Flask-Moment&#160;assumes&#160;that&#160;timestamps&#160;handled&#160;by&#160;the&#160;server-side</p>
<p style="position:absolute;top:289px;left:198px;white-space:nowrap" class="ft5525">application&#160;are&#160;“naive”&#160;datetime&#160;objects&#160;expressed&#160;in&#160;UTC.&#160;See&#160;the</p>
<p style="position:absolute;top:307px;left:198px;white-space:nowrap" class="ft5525">documentation&#160;for&#160;the&#160;<a href="http://bit.ly/datepack">datetime&#160;</a>package&#160;in&#160;the&#160;standard&#160;library&#160;for</p>
<p style="position:absolute;top:324px;left:198px;white-space:nowrap" class="ft5525">information&#160;on&#160;naive&#160;and&#160;aware&#160;date&#160;and&#160;time&#160;objects.</p>
<p style="position:absolute;top:375px;left:108px;white-space:nowrap" class="ft5514">The timestamps rendered by Flask-Moment can be localized to many languages. A</p>
<p style="position:absolute;top:394px;left:108px;white-space:nowrap" class="ft5546">language can be selected in the template by passing the language code to function<br/>lang()</p>
<p style="position:absolute;top:414px;left:153px;white-space:nowrap" class="ft5514">:</p>
<p style="position:absolute;top:446px;left:133px;white-space:nowrap" class="ft553">{{ moment.lang('es') }}</p>
<p style="position:absolute;top:466px;left:108px;white-space:nowrap" class="ft5514">With all the techniques discussed in this chapter, you should be able to build modern</p>
<p style="position:absolute;top:485px;left:108px;white-space:nowrap" class="ft5514">and user-friendly web pages for your application. The next chapter touches on an aspect</p>
<p style="position:absolute;top:504px;left:108px;white-space:nowrap" class="ft5514">of templates not yet discussed: how to interact with the user through web forms.</p>
<p style="position:absolute;top:915px;left:379px;white-space:nowrap" class="ft555"><b>Localization of Dates and Times with Flask-Moment&#160;&#160;|&#160;&#160;35</b></p>
</div>
<!-- Page 56 -->
<a name="56"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page56-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask056.png" alt="background image"/>
</div>
<!-- Page 57 -->
<a name="57"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page57-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask057.png" alt="background image"/>
<p style="position:absolute;top:104px;left:559px;white-space:nowrap" class="ft5728"><b>CHAPTER 4</b></p>
<p style="position:absolute;top:131px;left:511px;white-space:nowrap" class="ft5711"><b>Web Forms</b></p>
<p style="position:absolute;top:345px;left:108px;white-space:nowrap" class="ft5714">The request object, in<a href="Flask.html#27">troduced in&#160;Chapter 2</a>, exposes all the information sent by the</p>
<p style="position:absolute;top:365px;left:108px;white-space:nowrap" class="ft5714">client with a request. In particular,&#160;request.form&#160;provides access to form data submitted</p>
<p style="position:absolute;top:385px;left:108px;white-space:nowrap" class="ft5715">in&#160;POST&#160;requests.<br/>Although the support provided in Flask’s request object is sufficient for the handling of</p>
<p style="position:absolute;top:432px;left:108px;white-space:nowrap" class="ft5714">web forms, there are a number of tasks that can become tedious and repetitive. Two</p>
<p style="position:absolute;top:451px;left:108px;white-space:nowrap" class="ft5714">good examples are the generation of HTML code for forms and the validation of the</p>
<p style="position:absolute;top:470px;left:108px;white-space:nowrap" class="ft5715">submitted form data.<br/><a href="http://pythonhosted.org/Flask-WTF/">The&#160;Flask-WTF&#160;extension makes working with web forms a m</a>uch more pleasant ex‐</p>
<p style="position:absolute;top:516px;left:108px;white-space:nowrap" class="ft5714">perience. This extension is a Flask integration wrapper around the framework-agnostic</p>
<p style="position:absolute;top:535px;left:108px;white-space:nowrap" class="ft5748"><a href="http://wtforms.simplecodes.com/">WTForms&#160;package.<br/></a>Flask-WTF and its dependencies can be installed with&#160;pip:</p>
<p style="position:absolute;top:596px;left:134px;white-space:nowrap" class="ft5733">(venv)&#160;$&#160;pip install flask-wtf</p>
<p style="position:absolute;top:625px;left:108px;white-space:nowrap" class="ft5722"><b>Cross-Site Request Forgery (CSRF) Protection&#160;<br/></b>By default, Flask-WTF protects all forms against Cross-Site Request Forgery (CSRF)</p>
<p style="position:absolute;top:686px;left:108px;white-space:nowrap" class="ft5714">attacks. A CSRF attack occurs when a malicious website sends requests to a different</p>
<p style="position:absolute;top:705px;left:108px;white-space:nowrap" class="ft5715">website on which the victim is logged in.<br/>To implement CSRF protection, Flask-WTF needs the application to configure an en‐</p>
<p style="position:absolute;top:752px;left:108px;white-space:nowrap" class="ft5714">cryption key. Flask-WTF uses this key to generate encrypted tokens that are used to</p>
<p style="position:absolute;top:771px;left:108px;white-space:nowrap" class="ft5714">verify the authenticity of requests with form da<a href="Flask.html#57">ta.&#160;Example 4-1&#160;shows how to configure</a></p>
<p style="position:absolute;top:789px;left:108px;white-space:nowrap" class="ft5714">an encryption key.</p>
<p style="position:absolute;top:821px;left:108px;white-space:nowrap" class="ft5747"><i>Example 4-1. hello.py: Flask-WTF configuration<br/></i>app&#160;=&#160;Flask(__name__)<br/>app.config['SECRET_KEY']&#160;=&#160;'hard to guess string'</p>
<p style="position:absolute;top:915px;left:637px;white-space:nowrap" class="ft575"><b>37</b></p>
</div>
<!-- Page 58 -->
<a name="58"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft5871{font-size:10px;font-family:Times;color:#00aa88;}
-->
</style>
<div id="page58-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask058.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft5814">The&#160;app.config&#160;dictionary is a general-purpose place to store configuration variables</p>
<p style="position:absolute;top:98px;left:108px;white-space:nowrap" class="ft5814">used by the framework, the extensions, or the application itself. Configuration values</p>
<p style="position:absolute;top:118px;left:108px;white-space:nowrap" class="ft5814">can be added to the&#160;app.config&#160;object using standard dictionary syntax. The configu‐</p>
<p style="position:absolute;top:137px;left:108px;white-space:nowrap" class="ft5814">ration object also has methods to import configuration values from files or the envi‐</p>
<p style="position:absolute;top:156px;left:108px;white-space:nowrap" class="ft5848">ronment.<br/>The&#160;SECRET_KEY&#160;configuration variable is used as a general-purpose encryption key by</p>
<p style="position:absolute;top:204px;left:108px;white-space:nowrap" class="ft5814">Flask and several third-party extensions. As its name implies, the strength of the en‐</p>
<p style="position:absolute;top:223px;left:108px;white-space:nowrap" class="ft5814">cryption depends on the value of this variable being secret. Pick a different secret key</p>
<p style="position:absolute;top:241px;left:108px;white-space:nowrap" class="ft5814">in each application that you build and make sure that this string is not known by anyone.</p>
<p style="position:absolute;top:281px;left:198px;white-space:nowrap" class="ft5825">For&#160;added&#160;security,&#160;the&#160;secret&#160;key&#160;should&#160;be&#160;stored&#160;in&#160;an&#160;environ‐</p>
<p style="position:absolute;top:298px;left:198px;white-space:nowrap" class="ft5825">ment&#160;variable&#160;instead&#160;of&#160;being&#160;embedded&#160;in&#160;the&#160;code.&#160;This&#160;techni‐</p>
<p style="position:absolute;top:315px;left:198px;white-space:nowrap" class="ft5825">que&#160;is&#160;described&#160;in&#160;<a href="Flask.html#95">Chapter&#160;7</a>.</p>
<p style="position:absolute;top:381px;left:108px;white-space:nowrap" class="ft5846"><b>Form Classes<br/></b>When using Flask-WTF, each web form is represented by a class that inherits from class<br/>Form</p>
<p style="position:absolute;top:442px;left:138px;white-space:nowrap" class="ft5814">. The class defines the list of fields in the form, each represented by an object. Each</p>
<p style="position:absolute;top:461px;left:108px;white-space:nowrap" class="ft5814">field object can have one or more&#160;<i>validators</i>&#160;attached; validators are functions that check</p>
<p style="position:absolute;top:479px;left:108px;white-space:nowrap" class="ft5815">whether the input submitted by the user is valid.<br/><a href="Flask.html#58">Example 4-2</a>&#160;shows a simple web form that has a text field and a submit button.&#160;</p>
<p style="position:absolute;top:539px;left:108px;white-space:nowrap" class="ft5840"><i>Example 4-2. hello.py: Form class definition<br/></i><b>from</b>&#160;<b>flask.ext.wtf</b>&#160;<b>import</b>&#160;Form<br/><b>from</b>&#160;<b>wtforms</b>&#160;<b>import</b>&#160;StringField,&#160;SubmitField<br/><b>from</b>&#160;<b>wtforms.validators</b>&#160;<b>import</b>&#160;Required</p>
<p style="position:absolute;top:628px;left:108px;white-space:nowrap" class="ft5847"><b>class</b>&#160;<b>NameForm</b>(Form):<br/>&#160; &#160;&#160;name&#160;=&#160;StringField('What is your name?',&#160;validators=[Required()])<br/>&#160; &#160;&#160;submit&#160;=&#160;SubmitField('Submit')</p>
<p style="position:absolute;top:685px;left:108px;white-space:nowrap" class="ft5814">The fields in the form are defined as class variables, and each class variable is assigned</p>
<p style="position:absolute;top:705px;left:108px;white-space:nowrap" class="ft5814">an object associated with the field type. In the previous example, the&#160;NameForm&#160;form has</p>
<p style="position:absolute;top:725px;left:108px;white-space:nowrap" class="ft5814">a text field called&#160;name&#160;and a submit button called&#160;submit. The&#160;StringField&#160;class rep‐</p>
<p style="position:absolute;top:745px;left:108px;white-space:nowrap" class="ft5814">resents an&#160;&lt;input&gt;&#160;element with a&#160;type=&#34;text&#34;&#160;attribute. The&#160;SubmitField&#160;class rep‐</p>
<p style="position:absolute;top:765px;left:108px;white-space:nowrap" class="ft5814">resents an&#160;&lt;input&gt;&#160;element with a&#160;type=&#34;submit&#34;&#160;attribute. The first argument to the</p>
<p style="position:absolute;top:783px;left:108px;white-space:nowrap" class="ft5848">field constructors is the label that will be used when rendering the form to HTML.<br/>The optional&#160;validators&#160;argument included in the&#160;StringField&#160;constructor defines</p>
<p style="position:absolute;top:831px;left:108px;white-space:nowrap" class="ft5814">a list of checkers that will be applied to the data submitted by the user before it is ac‐</p>
<p style="position:absolute;top:851px;left:108px;white-space:nowrap" class="ft5814">cepted. The&#160;Required()&#160;validator ensures that the field is not submitted empty.&#160;</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft585"><b>38&#160;&#160;|&#160;&#160;Chapter 4: Web Forms</b></p>
</div>
<!-- Page 59 -->
<a name="59"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page59-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask059.png" alt="background image"/>
<p style="position:absolute;top:84px;left:198px;white-space:nowrap" class="ft5925">The&#160;Form&#160;base&#160;class&#160;is&#160;defined&#160;by&#160;the&#160;Flask-WTF&#160;extension,&#160;so&#160;it&#160;is</p>
<p style="position:absolute;top:102px;left:198px;white-space:nowrap" class="ft5925">imported&#160;from&#160;flask.ext.wtf.&#160;The&#160;fields&#160;and&#160;validators,&#160;however,</p>
<p style="position:absolute;top:119px;left:198px;white-space:nowrap" class="ft5925">are&#160;imported&#160;directly&#160;from&#160;the&#160;WTForms&#160;package.</p>
<p style="position:absolute;top:188px;left:108px;white-space:nowrap" class="ft5948">The list of standard HTML fields supported by WTF<a href="Flask.html#59">orms is shown in&#160;Table 4-1</a>.<br/><i>Table 4-1. WTForms standard HTML fields</i></p>
<p style="position:absolute;top:245px;left:113px;white-space:nowrap" class="ft5953"><b>Field&#160;type</b></p>
<p style="position:absolute;top:245px;left:267px;white-space:nowrap" class="ft5953"><b>Description</b></p>
<p style="position:absolute;top:269px;left:113px;white-space:nowrap" class="ft5914">StringField</p>
<p style="position:absolute;top:266px;left:267px;white-space:nowrap" class="ft5930">Text&#160;field</p>
<p style="position:absolute;top:293px;left:113px;white-space:nowrap" class="ft5914">TextAreaField</p>
<p style="position:absolute;top:291px;left:267px;white-space:nowrap" class="ft5930">Multiple-line&#160;text&#160;field</p>
<p style="position:absolute;top:317px;left:113px;white-space:nowrap" class="ft5914">PasswordField</p>
<p style="position:absolute;top:315px;left:267px;white-space:nowrap" class="ft5930">Password&#160;text&#160;field</p>
<p style="position:absolute;top:341px;left:113px;white-space:nowrap" class="ft5914">HiddenField</p>
<p style="position:absolute;top:339px;left:267px;white-space:nowrap" class="ft5930">Hidden&#160;text&#160;field</p>
<p style="position:absolute;top:365px;left:113px;white-space:nowrap" class="ft5914">DateField</p>
<p style="position:absolute;top:365px;left:267px;white-space:nowrap" class="ft5930">Text&#160;field&#160;that&#160;accepts&#160;a&#160;datetime.date&#160;value&#160;in&#160;a&#160;given&#160;format</p>
<p style="position:absolute;top:390px;left:113px;white-space:nowrap" class="ft5914">DateTimeField</p>
<p style="position:absolute;top:389px;left:267px;white-space:nowrap" class="ft5930">Text&#160;field&#160;that&#160;accepts&#160;a&#160;datetime.datetime&#160;value&#160;in&#160;a&#160;given&#160;format</p>
<p style="position:absolute;top:414px;left:113px;white-space:nowrap" class="ft5914">IntegerField</p>
<p style="position:absolute;top:411px;left:267px;white-space:nowrap" class="ft5930">Text&#160;field&#160;that&#160;accepts&#160;an&#160;integer&#160;value</p>
<p style="position:absolute;top:438px;left:113px;white-space:nowrap" class="ft5914">DecimalField</p>
<p style="position:absolute;top:437px;left:267px;white-space:nowrap" class="ft5930">Text&#160;field&#160;that&#160;accepts&#160;a&#160;decimal.Decimal&#160;value</p>
<p style="position:absolute;top:462px;left:113px;white-space:nowrap" class="ft5914">FloatField</p>
<p style="position:absolute;top:459px;left:267px;white-space:nowrap" class="ft5930">Text&#160;field&#160;that&#160;accepts&#160;a&#160;floating-point&#160;value</p>
<p style="position:absolute;top:486px;left:113px;white-space:nowrap" class="ft5914">BooleanField</p>
<p style="position:absolute;top:486px;left:267px;white-space:nowrap" class="ft5930">Checkbox&#160;with&#160;True&#160;and&#160;False&#160;values</p>
<p style="position:absolute;top:510px;left:113px;white-space:nowrap" class="ft5914">RadioField</p>
<p style="position:absolute;top:507px;left:267px;white-space:nowrap" class="ft5930">List&#160;of&#160;radio&#160;buttons</p>
<p style="position:absolute;top:534px;left:113px;white-space:nowrap" class="ft5914">SelectField</p>
<p style="position:absolute;top:531px;left:267px;white-space:nowrap" class="ft5930">Drop-down&#160;list&#160;of&#160;choices</p>
<p style="position:absolute;top:558px;left:113px;white-space:nowrap" class="ft5914">SelectMultipleField&#160;Drop-down&#160;list&#160;of&#160;choices&#160;with&#160;multiple&#160;selection</p>
<p style="position:absolute;top:582px;left:113px;white-space:nowrap" class="ft5914">FileField</p>
<p style="position:absolute;top:579px;left:267px;white-space:nowrap" class="ft5930">File&#160;upload&#160;field</p>
<p style="position:absolute;top:606px;left:113px;white-space:nowrap" class="ft5914">SubmitField</p>
<p style="position:absolute;top:604px;left:267px;white-space:nowrap" class="ft5930">Form&#160;submission&#160;button</p>
<p style="position:absolute;top:630px;left:113px;white-space:nowrap" class="ft5914">FormField</p>
<p style="position:absolute;top:628px;left:267px;white-space:nowrap" class="ft5930">Embed&#160;a&#160;form&#160;as&#160;a&#160;field&#160;in&#160;a&#160;container&#160;form</p>
<p style="position:absolute;top:654px;left:113px;white-space:nowrap" class="ft5914">FieldList</p>
<p style="position:absolute;top:652px;left:267px;white-space:nowrap" class="ft5930">List&#160;of&#160;fields&#160;of&#160;a&#160;given&#160;type</p>
<p style="position:absolute;top:687px;left:108px;white-space:nowrap" class="ft5914">The list of WTForms built-in valida<a href="Flask.html#60">tors is shown in&#160;Table 4-2</a>.</p>
<p style="position:absolute;top:915px;left:551px;white-space:nowrap" class="ft595"><b>Form Classes&#160;&#160;|&#160;&#160;39</b></p>
</div>
<!-- Page 60 -->
<a name="60"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page60-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask060.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft6010"><i>Table 4-2. WTForms validators</i></p>
<p style="position:absolute;top:107px;left:113px;white-space:nowrap" class="ft6053"><b>Validator</b></p>
<p style="position:absolute;top:107px;left:207px;white-space:nowrap" class="ft6053"><b>Description</b></p>
<p style="position:absolute;top:132px;left:113px;white-space:nowrap" class="ft6014">Email</p>
<p style="position:absolute;top:129px;left:207px;white-space:nowrap" class="ft6030">Validates&#160;an&#160;email&#160;address</p>
<p style="position:absolute;top:156px;left:113px;white-space:nowrap" class="ft6014">EqualTo</p>
<p style="position:absolute;top:153px;left:207px;white-space:nowrap" class="ft6030">Compares&#160;the&#160;values&#160;of&#160;two&#160;fields;&#160;useful&#160;when&#160;requesting&#160;a&#160;password&#160;to&#160;be&#160;entered&#160;twice&#160;for&#160;confirmation</p>
<p style="position:absolute;top:180px;left:113px;white-space:nowrap" class="ft6014">IPAddress</p>
<p style="position:absolute;top:177px;left:207px;white-space:nowrap" class="ft6030">Validates&#160;an&#160;IPv4&#160;network&#160;address</p>
<p style="position:absolute;top:204px;left:113px;white-space:nowrap" class="ft6014">Length</p>
<p style="position:absolute;top:201px;left:207px;white-space:nowrap" class="ft6030">Validates&#160;the&#160;length&#160;of&#160;the&#160;string&#160;entered</p>
<p style="position:absolute;top:228px;left:113px;white-space:nowrap" class="ft6014">NumberRange&#160;Validates&#160;that&#160;the&#160;value&#160;entered&#160;is&#160;within&#160;a&#160;numeric&#160;range</p>
<p style="position:absolute;top:252px;left:113px;white-space:nowrap" class="ft6014">Optional</p>
<p style="position:absolute;top:249px;left:207px;white-space:nowrap" class="ft6030">Allows&#160;empty&#160;input&#160;on&#160;the&#160;field,&#160;skipping&#160;additional&#160;validators</p>
<p style="position:absolute;top:276px;left:113px;white-space:nowrap" class="ft6014">Required</p>
<p style="position:absolute;top:274px;left:207px;white-space:nowrap" class="ft6030">Validates&#160;that&#160;the&#160;field&#160;contains&#160;data</p>
<p style="position:absolute;top:300px;left:113px;white-space:nowrap" class="ft6014">Regexp</p>
<p style="position:absolute;top:298px;left:207px;white-space:nowrap" class="ft6030">Validates&#160;the&#160;input&#160;against&#160;a&#160;regular&#160;expression</p>
<p style="position:absolute;top:324px;left:113px;white-space:nowrap" class="ft6014">URL</p>
<p style="position:absolute;top:322px;left:207px;white-space:nowrap" class="ft6030">Validates&#160;a&#160;URL</p>
<p style="position:absolute;top:348px;left:113px;white-space:nowrap" class="ft6014">AnyOf</p>
<p style="position:absolute;top:346px;left:207px;white-space:nowrap" class="ft6030">Validates&#160;that&#160;the&#160;input&#160;is&#160;one&#160;of&#160;a&#160;list&#160;of&#160;possible&#160;values</p>
<p style="position:absolute;top:372px;left:113px;white-space:nowrap" class="ft6014">NoneOf</p>
<p style="position:absolute;top:370px;left:207px;white-space:nowrap" class="ft6030">Validates&#160;that&#160;the&#160;input&#160;is&#160;none&#160;of&#160;a&#160;list&#160;of&#160;possible&#160;values</p>
<p style="position:absolute;top:408px;left:108px;white-space:nowrap" class="ft6022"><b>HTML Rendering of Forms&#160;<br/></b>Form fields are callables that, when invoked, from a template render themselves to</p>
<p style="position:absolute;top:470px;left:108px;white-space:nowrap" class="ft6014">HTML. Assuming that the view function passes a&#160;NameForm&#160;instance to the template as</p>
<p style="position:absolute;top:490px;left:108px;white-space:nowrap" class="ft6014">an argument named&#160;form, the template can generate a simple HTML form as follows:</p>
<p style="position:absolute;top:521px;left:134px;white-space:nowrap" class="ft6023"><b>&lt;form</b>&#160;method=&#34;POST&#34;<b>&gt;<br/></b>&#160; &#160; {{ form.name.label }} {{ form.name() }}<br/>&#160; &#160; {{ form.submit() }}<br/><b>&lt;/form&gt;</b></p>
<p style="position:absolute;top:588px;left:108px;white-space:nowrap" class="ft6014">Of course, the result is extremely bare. To improve the look of the form, any arguments</p>
<p style="position:absolute;top:607px;left:108px;white-space:nowrap" class="ft6014">sent into the calls that render the fields are converted into HTML attributes for the field;</p>
<p style="position:absolute;top:626px;left:108px;white-space:nowrap" class="ft6014">so, for example, you can give the field&#160;id&#160;or&#160;class&#160;attributes and then define CSS styles:</p>
<p style="position:absolute;top:658px;left:133px;white-space:nowrap" class="ft6023"><b>&lt;form</b>&#160;method=&#34;POST&#34;<b>&gt;<br/></b>&#160; &#160; {{ form.name.label }} {{ form.name(id='my-text-field') }}<br/>&#160; &#160; {{ form.submit() }}<br/><b>&lt;/form&gt;</b></p>
<p style="position:absolute;top:725px;left:108px;white-space:nowrap" class="ft6014">But even with HTML attributes, the effort required to render a form in this way is</p>
<p style="position:absolute;top:743px;left:108px;white-space:nowrap" class="ft6014">significant, so it is best to leverage Bootstrap’s own set of form styles whenever possible.</p>
<p style="position:absolute;top:762px;left:108px;white-space:nowrap" class="ft6014">Flask-Bootstrap provides a very high-level helper function that renders an entire Flask-</p>
<p style="position:absolute;top:781px;left:108px;white-space:nowrap" class="ft6014">WTF form using Bootstrap’s predefined form styles, all with a single call. Using Flask-</p>
<p style="position:absolute;top:800px;left:108px;white-space:nowrap" class="ft6014">Bootstrap, the previous form can be rendered as follows:</p>
<p style="position:absolute;top:832px;left:133px;white-space:nowrap" class="ft6023">{% import &#34;bootstrap/wtf.html&#34; as wtf %}<br/>{{ wtf.quick_form(form) }}</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft605"><b>40&#160;&#160;|&#160;&#160;Chapter 4: Web Forms</b></p>
</div>
<!-- Page 61 -->
<a name="61"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page61-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask061.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft6114">The&#160;import&#160;directive works in the same way as regular Python scripts do and allows</p>
<p style="position:absolute;top:98px;left:108px;white-space:nowrap" class="ft6114">template elements to be imported and used in many templates. The imported&#160;<i>bootstrap/</i></p>
<p style="position:absolute;top:118px;left:108px;white-space:nowrap" class="ft6110"><i>wtf.html</i></p>
<p style="position:absolute;top:117px;left:161px;white-space:nowrap" class="ft6114">&#160;file defines helper functions that render Flask-WTF forms using Bootstrap.</p>
<p style="position:absolute;top:137px;left:108px;white-space:nowrap" class="ft6114">The&#160;wtf.quick_form()&#160;function takes a Flask-WTF form object and renders it using</p>
<p style="position:absolute;top:156px;left:108px;white-space:nowrap" class="ft6114">default Bootstrap styles. The complete template for&#160;<i>hello.py</i><a href="Flask.html#61">&#160;is shown in&#160;Example 4-3</a>.&#160;</p>
<p style="position:absolute;top:188px;left:108px;white-space:nowrap" class="ft6123"><i>Example 4-3.&#160;templates/index.html: Using Flask-WTF and Flask-Bootstrap to render a<br/>form<br/></i>{% extends &#34;base.html&#34; %}<br/>{% import &#34;bootstrap/wtf.html&#34; as wtf %}</p>
<p style="position:absolute;top:280px;left:108px;white-space:nowrap" class="ft613">{% block title %}Flasky{% endblock %}</p>
<p style="position:absolute;top:311px;left:108px;white-space:nowrap" class="ft6123">{% block page_content %}<br/><b>&lt;div</b>&#160;class=&#34;page-header&#34;<b>&gt;<br/></b>&#160; &#160;&#160;<b>&lt;h1&gt;</b>Hello, {% if name %}{{ name }}{% else %}Stranger{% endif %}!<b>&lt;/h1&gt;<br/>&lt;/div&gt;<br/></b>{{ wtf.quick_form(form) }}<br/>{% endblock %}</p>
<p style="position:absolute;top:414px;left:108px;white-space:nowrap" class="ft6114">The content area of the template now has two sections. The first section is a page header</p>
<p style="position:absolute;top:433px;left:108px;white-space:nowrap" class="ft6114">that shows a greeting. Here a template conditional is used. Conditionals in Jinja2 have</p>
<p style="position:absolute;top:453px;left:108px;white-space:nowrap" class="ft6114">the format&#160;{% if variable %}...{% else %}...{% endif %}. If the condition eval‐</p>
<p style="position:absolute;top:472px;left:108px;white-space:nowrap" class="ft6114">uates to&#160;True, then what appears between the&#160;if&#160;and&#160;else&#160;directives is rendered to the</p>
<p style="position:absolute;top:492px;left:108px;white-space:nowrap" class="ft6114">template. If the condition evaluates to&#160;False, then what’s between the&#160;else&#160;and&#160;endif</p>
<p style="position:absolute;top:511px;left:108px;white-space:nowrap" class="ft6146">is rendered. The example template will render the string “Hello, Stranger!” when the<br/>name</p>
<p style="position:absolute;top:531px;left:138px;white-space:nowrap" class="ft6114">&#160;template argument is undefined. The second section of the content renders the</p>
<p style="position:absolute;top:554px;left:108px;white-space:nowrap" class="ft6114">NameForm</p>
<p style="position:absolute;top:551px;left:168px;white-space:nowrap" class="ft6114">&#160;object using the&#160;wtf.quick_form()&#160;function.</p>
<p style="position:absolute;top:587px;left:108px;white-space:nowrap" class="ft6122"><b>Form Handling in View Functions<br/></b>In the new version of&#160;<i>hello.py</i>, the&#160;index()&#160;view function will be rendering the form</p>
<p style="position:absolute;top:648px;left:108px;white-space:nowrap" class="ft6114">and also receiving its da<a href="Flask.html#61">ta.&#160;Example 4-4</a>&#160;shows the updated&#160;index()&#160;view function.</p>
<p style="position:absolute;top:680px;left:108px;white-space:nowrap" class="ft6157"><i>Example 4-4. hello.py: Route methods<br/></i>@app.route('/',&#160;methods=['GET',&#160;'POST'])<br/><b>def</b>&#160;index():<br/>&#160; &#160;&#160;name&#160;=&#160;None<br/>&#160; &#160;&#160;form&#160;=&#160;NameForm()<br/>&#160; &#160;&#160;<b>if</b>&#160;form.validate_on_submit():<br/>&#160; &#160; &#160; &#160;&#160;name&#160;=&#160;form.name.data<br/>&#160; &#160; &#160; &#160;&#160;form.name.data&#160;=&#160;''<br/>&#160; &#160;&#160;<b>return</b>&#160;render_template('index.html',&#160;form=form,&#160;name=name)</p>
<p style="position:absolute;top:915px;left:461px;white-space:nowrap" class="ft615"><b>Form Handling in View Functions&#160;&#160;|&#160;&#160;41</b></p>
</div>
<!-- Page 62 -->
<a name="62"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page62-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask062.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft6214">The&#160;methods&#160;argument added to the&#160;app.route&#160;decorator tells Flask to register the view</p>
<p style="position:absolute;top:99px;left:108px;white-space:nowrap" class="ft6214">function as a handler for&#160;GET&#160;and&#160;POST&#160;requests in the URL map. When&#160;methods&#160;is not</p>
<p style="position:absolute;top:119px;left:108px;white-space:nowrap" class="ft6248">given, the view function is registered to handle&#160;GET&#160;requests only.<br/>Adding&#160;POST&#160;to the method list is necessary because form submissions are much more</p>
<p style="position:absolute;top:168px;left:108px;white-space:nowrap" class="ft6214">conveniently handled as&#160;POST&#160;requests. It is possible to submit a form as a&#160;GET&#160;request,</p>
<p style="position:absolute;top:187px;left:108px;white-space:nowrap" class="ft6214">but as&#160;GET&#160;requests have no body, the data is appended to the URL as a query string and</p>
<p style="position:absolute;top:206px;left:108px;white-space:nowrap" class="ft6214">becomes visible in the browser’s address bar. For this and several other reasons, form</p>
<p style="position:absolute;top:226px;left:108px;white-space:nowrap" class="ft6248">submissions are almost universally done as&#160;POST&#160;requests.<br/>The local&#160;name&#160;variable is used to hold the name received from the form when available;</p>
<p style="position:absolute;top:275px;left:108px;white-space:nowrap" class="ft6214">when the name is not known the variable is initialized to&#160;None. The view function creates</p>
<p style="position:absolute;top:295px;left:108px;white-space:nowrap" class="ft6246">an instance of the&#160;NameForm&#160;class shown previously to represent the form. The<br/>validate_on_submit()</p>
<p style="position:absolute;top:315px;left:258px;white-space:nowrap" class="ft6214">&#160;method of the form returns&#160;True&#160;when the form was submitted</p>
<p style="position:absolute;top:333px;left:108px;white-space:nowrap" class="ft6246">and the data has been accepted by all the field validators. In all other cases,<br/>validate_on_submit()</p>
<p style="position:absolute;top:353px;left:258px;white-space:nowrap" class="ft6214">&#160;returns&#160;False. The return value of this method effectively</p>
<p style="position:absolute;top:372px;left:108px;white-space:nowrap" class="ft6248">serves to decide whether the form needs to be rendered or processed.<br/>When a user navigates to the application for the first time, the server will receive a&#160;GET</p>
<p style="position:absolute;top:421px;left:108px;white-space:nowrap" class="ft6214">request with no form data, so&#160;validate_on_submit()&#160;will return&#160;False. The body of</p>
<p style="position:absolute;top:441px;left:108px;white-space:nowrap" class="ft6214">the&#160;if&#160;statement will be skipped and the request will be handled by rendering the tem‐</p>
<p style="position:absolute;top:460px;left:108px;white-space:nowrap" class="ft6214">plate, which gets the form object and the&#160;name&#160;variable set to&#160;None&#160;as arguments. Users</p>
<p style="position:absolute;top:479px;left:108px;white-space:nowrap" class="ft6248">will now see the form displayed in the browser.<br/>When the form is submitted by the user, the server receives a&#160;POST&#160;request with the data.</p>
<p style="position:absolute;top:528px;left:108px;white-space:nowrap" class="ft6214">The call to&#160;validate_on_submit()&#160;invokes the&#160;Required()&#160;validator attached to the</p>
<p style="position:absolute;top:547px;left:108px;white-space:nowrap" class="ft6246">name field. If the name is not empty, then the validator accepts it and<br/>validate_on_submit()</p>
<p style="position:absolute;top:567px;left:258px;white-space:nowrap" class="ft6214">&#160;returns&#160;True. Now the name entered by the user is accessible</p>
<p style="position:absolute;top:587px;left:108px;white-space:nowrap" class="ft6214">as the&#160;data&#160;attribute of the field. Inside the body of the&#160;if&#160;statement, this name is assigned</p>
<p style="position:absolute;top:606px;left:108px;white-space:nowrap" class="ft6214">to the local&#160;name&#160;variable and the form field is cleared by setting that&#160;data&#160;attribute to</p>
<p style="position:absolute;top:626px;left:108px;white-space:nowrap" class="ft6214">an empty string. The&#160;render_template()&#160;call in the last line renders the template, but</p>
<p style="position:absolute;top:646px;left:108px;white-space:nowrap" class="ft6214">this time the&#160;name&#160;argument contains the name from the form, so the greeting will be</p>
<p style="position:absolute;top:665px;left:108px;white-space:nowrap" class="ft6214">personalized.</p>
<p style="position:absolute;top:707px;left:198px;white-space:nowrap" class="ft6225">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:725px;left:198px;white-space:nowrap" class="ft6225">run&#160;git&#160;checkout&#160;4a&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:813px;left:108px;white-space:nowrap" class="ft6217"><a href="Flask.html#63">Figure 4-1</a>&#160;shows how the form looks in the browser window when a user initially enters</p>
<p style="position:absolute;top:832px;left:108px;white-space:nowrap" class="ft6214">the site. When the user submits a name, the application responds with a personalized</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft625"><b>42&#160;&#160;|&#160;&#160;Chapter 4: Web Forms</b></p>
</div>
<!-- Page 63 -->
<a name="63"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page63-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask063.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft6314">greeting. The form still appears below it, so a user can submit it with a new name if</p>
<p style="position:absolute;top:97px;left:108px;white-space:nowrap" class="ft6314"><a href="Flask.html#63">desired.&#160;Figure 4-2</a>&#160;shows the application in this state.</p>
<p style="position:absolute;top:431px;left:108px;white-space:nowrap" class="ft6310"><i>Figure 4-1. Flask-WTF web form</i></p>
<p style="position:absolute;top:468px;left:108px;white-space:nowrap" class="ft6314">If the user submits the form with an empty name, the&#160;Required()&#160;validatior catches the</p>
<p style="position:absolute;top:487px;left:108px;white-space:nowrap" class="ft6314">error, as seen in&#160;<a href="Flask.html#64">Figure 4-3</a>. Note how much functionality is being provided automati‐</p>
<p style="position:absolute;top:505px;left:108px;white-space:nowrap" class="ft6314">cally. This is a great example of the power that well-designed extensions like Flask-WTF</p>
<p style="position:absolute;top:524px;left:108px;white-space:nowrap" class="ft6314">and Flask-Bootstrap can give to your application.</p>
<p style="position:absolute;top:858px;left:108px;white-space:nowrap" class="ft6310"><i>Figure 4-2. Web form after submission</i></p>
<p style="position:absolute;top:915px;left:461px;white-space:nowrap" class="ft635"><b>Form Handling in View Functions&#160;&#160;|&#160;&#160;43</b></p>
</div>
<!-- Page 64 -->
<a name="64"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page64-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask064.png" alt="background image"/>
<p style="position:absolute;top:394px;left:108px;white-space:nowrap" class="ft6410"><i>Figure 4-3. Web form after failed validator</i></p>
<p style="position:absolute;top:429px;left:108px;white-space:nowrap" class="ft6418"><b>Redirects and User Sessions<br/></b>The last version of&#160;<i>hello.py</i>&#160;has a usability problem. If you enter your name and submit</p>
<p style="position:absolute;top:488px;left:108px;white-space:nowrap" class="ft6414">it and then click the refresh button on your browser, you will likely get an obscure</p>
<p style="position:absolute;top:507px;left:108px;white-space:nowrap" class="ft6414">warning that asks for confirmation before submitting the form again. This happens</p>
<p style="position:absolute;top:526px;left:108px;white-space:nowrap" class="ft6414">because browsers repeat the last request they have sent when they are asked to refresh</p>
<p style="position:absolute;top:546px;left:108px;white-space:nowrap" class="ft6414">the page. When the last request sent is a&#160;POST&#160;request with form data, a refresh would</p>
<p style="position:absolute;top:565px;left:108px;white-space:nowrap" class="ft6415">cause a duplicate form submission, which in almost all cases is not the desired action.<br/>Many users do not understand the warning from the browser. For this reason, it is</p>
<p style="position:absolute;top:613px;left:108px;white-space:nowrap" class="ft6414">considered good practice for web applications to never leave a&#160;POST&#160;request as a last</p>
<p style="position:absolute;top:631px;left:108px;white-space:nowrap" class="ft6448">request sent by the browser.<br/>This practice can be achieved by responding to&#160;POST&#160;requests with a&#160;<i>redirect</i>&#160;instead of</p>
<p style="position:absolute;top:679px;left:108px;white-space:nowrap" class="ft6414">a normal response. A redirect is a special type of response that has a URL instead of a</p>
<p style="position:absolute;top:699px;left:108px;white-space:nowrap" class="ft6414">string with HTML code. When the browser receives this response, it issues a&#160;GET&#160;request</p>
<p style="position:absolute;top:718px;left:108px;white-space:nowrap" class="ft6414">for the redirect URL, and that is the page that is displayed. The page may take a few</p>
<p style="position:absolute;top:737px;left:108px;white-space:nowrap" class="ft6414">more milliseconds to load because of the second request that has to be sent to the server,</p>
<p style="position:absolute;top:757px;left:108px;white-space:nowrap" class="ft6414">but other than that, the user will not see any difference. Now the last request is a&#160;GET,</p>
<p style="position:absolute;top:775px;left:108px;white-space:nowrap" class="ft6414">so the refresh command works as expected. This trick is known as the&#160;<i>Post/</i></p>
<p style="position:absolute;top:795px;left:108px;white-space:nowrap" class="ft6410"><i>Redirect/Get pattern</i></p>
<p style="position:absolute;top:794px;left:235px;white-space:nowrap" class="ft6414">.</p>
<p style="position:absolute;top:823px;left:108px;white-space:nowrap" class="ft6414">But this approach brings a second problem. When the application handles the&#160;POST</p>
<p style="position:absolute;top:843px;left:108px;white-space:nowrap" class="ft6414">request, it has access to the name entered by the user in&#160;form.name.data, but as soon</p>
<p style="position:absolute;top:863px;left:108px;white-space:nowrap" class="ft6414">as that request ends the form data is lost. Because the&#160;POST&#160;request is handled with a</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft645"><b>44&#160;&#160;|&#160;&#160;Chapter 4: Web Forms</b></p>
</div>
<!-- Page 65 -->
<a name="65"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page65-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask065.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft6514">redirect, the application needs to store the name so that the redirected request can have</p>
<p style="position:absolute;top:97px;left:108px;white-space:nowrap" class="ft6515">it and use it to build the actual response.<br/>Applications can “remember” things from one request to the next by storing them in</p>
<p style="position:absolute;top:144px;left:108px;white-space:nowrap" class="ft6514">the&#160;<i>user session</i>, private storage that is available to each connected client. The user session</p>
<p style="position:absolute;top:163px;left:108px;white-space:nowrap" class="ft6514">was in<a href="Flask.html#27">troduced in&#160;Chapter 2&#160;as one of the variables associa</a>ted with the request context.</p>
<p style="position:absolute;top:183px;left:108px;white-space:nowrap" class="ft6514">It’s called&#160;session&#160;and is accessed like a standard Python dictionary.</p>
<p style="position:absolute;top:222px;left:198px;white-space:nowrap" class="ft6525">By&#160;default,&#160;user&#160;sessions&#160;are&#160;stored&#160;in&#160;client-side&#160;cookies&#160;that&#160;are</p>
<p style="position:absolute;top:240px;left:198px;white-space:nowrap" class="ft6525">cryptographically&#160;signed&#160;using&#160;the&#160;configured&#160;SECRET_KEY.&#160;Any&#160;tam‐</p>
<p style="position:absolute;top:258px;left:198px;white-space:nowrap" class="ft6525">pering&#160;with&#160;the&#160;cookie&#160;content&#160;would&#160;render&#160;the&#160;signature&#160;invalid,</p>
<p style="position:absolute;top:275px;left:198px;white-space:nowrap" class="ft6525">thus&#160;invalidating&#160;the&#160;session.</p>
<p style="position:absolute;top:328px;left:108px;white-space:nowrap" class="ft6517"><a href="Flask.html#65">Example 4-5</a>&#160;shows a new version of the&#160;index()&#160;view function that implements redi‐</p>
<p style="position:absolute;top:347px;left:108px;white-space:nowrap" class="ft6514">rects and user sessions.</p>
<p style="position:absolute;top:379px;left:108px;white-space:nowrap" class="ft6550"><i>Example 4-5. hello.py: Redirects and user sessions<br/></i><b>from</b>&#160;<b>flask</b>&#160;<b>import</b>&#160;Flask,&#160;render_template,&#160;session,&#160;redirect,&#160;url_for</p>
<p style="position:absolute;top:437px;left:108px;white-space:nowrap" class="ft6547">@app.route('/',&#160;methods=['GET',&#160;'POST'])<br/><b>def</b>&#160;index():<br/>&#160; &#160;&#160;form&#160;=&#160;NameForm()<br/>&#160; &#160;&#160;<b>if</b>&#160;form.validate_on_submit():<br/>&#160; &#160; &#160; &#160;&#160;session['name']&#160;=&#160;form.name.data<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;redirect(url_for('index'))<br/>&#160; &#160;&#160;<b>return</b>&#160;render_template('index.html',&#160;form=form,&#160;name=session.get('name'))</p>
<p style="position:absolute;top:556px;left:108px;white-space:nowrap" class="ft6514">In the previous version of the application, a local&#160;name&#160;variable was used to store the</p>
<p style="position:absolute;top:575px;left:108px;white-space:nowrap" class="ft6546">name entered by the user in the form. That variable is now placed in the user session as<br/>session['name']</p>
<p style="position:absolute;top:595px;left:221px;white-space:nowrap" class="ft6514">&#160;so that it is remembered beyond the request.</p>
<p style="position:absolute;top:624px;left:108px;white-space:nowrap" class="ft6514">Requests that come with valid form data will now end with a call to&#160;redirect(), a helper</p>
<p style="position:absolute;top:644px;left:108px;white-space:nowrap" class="ft6514">function that generates the HTTP redirect response. The&#160;redirect()&#160;function takes</p>
<p style="position:absolute;top:663px;left:108px;white-space:nowrap" class="ft6514">the URL to redirect to as an argument. The redirect URL used in this case is the root</p>
<p style="position:absolute;top:682px;left:108px;white-space:nowrap" class="ft6514">URL, so the response could have been written more concisely as&#160;redirect('/'), but</p>
<p style="position:absolute;top:702px;left:108px;white-space:nowrap" class="ft6514">instead Flask’s URL generator function&#160;url_for()&#160;is used. The use of&#160;url_for()&#160;to</p>
<p style="position:absolute;top:721px;left:108px;white-space:nowrap" class="ft6514">generate URLs is encouraged because this function generates URLs using the URL map,</p>
<p style="position:absolute;top:740px;left:108px;white-space:nowrap" class="ft6514">so URLs are guaranteed to be compatible with defined routes and any changes made to</p>
<p style="position:absolute;top:759px;left:108px;white-space:nowrap" class="ft6548">route names will be automatically available when using this function.&#160;<br/>The first and only required argument to&#160;url_for()&#160;is the&#160;<i>endpoint</i>&#160;name, the internal</p>
<p style="position:absolute;top:807px;left:108px;white-space:nowrap" class="ft6514">name each route has. By default, the endpoint of a route is the name of the view function</p>
<p style="position:absolute;top:826px;left:108px;white-space:nowrap" class="ft6546">attached to it. In this example, the view function that handles the root URL is<br/>index()</p>
<p style="position:absolute;top:845px;left:161px;white-space:nowrap" class="ft6514">, so the name given to&#160;url_for()&#160;is&#160;index.</p>
<p style="position:absolute;top:915px;left:486px;white-space:nowrap" class="ft655"><b>Redirects and User Sessions&#160;&#160;|&#160;&#160;45</b></p>
</div>
<!-- Page 66 -->
<a name="66"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page66-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask066.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft6614">The last change is in the&#160;render_template()&#160;function, which now obtains the&#160;name</p>
<p style="position:absolute;top:99px;left:108px;white-space:nowrap" class="ft6614">argument directly from the session using&#160;session.get('name'). As with regular dic‐</p>
<p style="position:absolute;top:119px;left:108px;white-space:nowrap" class="ft6614">tionaries, using&#160;get()&#160;to request a dictionary key avoids an exception for keys that aren’t</p>
<p style="position:absolute;top:139px;left:108px;white-space:nowrap" class="ft6614">found, because&#160;get()&#160;returns a default value of&#160;None&#160;for a missing key.</p>
<p style="position:absolute;top:180px;left:198px;white-space:nowrap" class="ft6625">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:199px;left:198px;white-space:nowrap" class="ft6625">run&#160;git&#160;checkout&#160;4b&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:287px;left:108px;white-space:nowrap" class="ft6614">With this version of the application, you can see that refreshing the page in your browser</p>
<p style="position:absolute;top:306px;left:108px;white-space:nowrap" class="ft6614">results in the expected behavior.</p>
<p style="position:absolute;top:342px;left:108px;white-space:nowrap" class="ft6618"><b>Message Flashing<br/></b>Sometimes it is useful to give the user a status update after a request is completed. This</p>
<p style="position:absolute;top:401px;left:108px;white-space:nowrap" class="ft6614">could be a confirmation message, a warning, or an error. A typical example is when you</p>
<p style="position:absolute;top:420px;left:108px;white-space:nowrap" class="ft6614">submit a login form to a website with a mistake and the server responds by rendering</p>
<p style="position:absolute;top:439px;left:108px;white-space:nowrap" class="ft6614">the login form again with a message above it that informs you that your username or</p>
<p style="position:absolute;top:458px;left:108px;white-space:nowrap" class="ft6648">password is invalid.<br/>Flask includes this functionality as a core feature.&#160;<a href="Flask.html#66">Example 4-6&#160;</a>shows how the&#160;flash()</p>
<p style="position:absolute;top:505px;left:108px;white-space:nowrap" class="ft6614">function can be used for this purpose.</p>
<p style="position:absolute;top:537px;left:108px;white-space:nowrap" class="ft6650"><i>Example 4-6. hello.py: Flashed messages<br/></i><b>from</b>&#160;<b>flask</b>&#160;<b>import</b>&#160;Flask,&#160;render_template,&#160;session,&#160;redirect,&#160;url_for,&#160;flash</p>
<p style="position:absolute;top:596px;left:108px;white-space:nowrap" class="ft6647">@app.route('/',&#160;methods=['GET',&#160;'POST'])<br/><b>def</b>&#160;index():<br/>&#160; &#160;&#160;form&#160;=&#160;NameForm()<br/>&#160; &#160;&#160;<b>if</b>&#160;form.validate_on_submit():<br/>&#160; &#160; &#160; &#160;&#160;old_name&#160;=&#160;session.get('name')<br/>&#160; &#160; &#160; &#160;&#160;<b>if</b>&#160;old_name&#160;<b>is</b>&#160;<b>not</b>&#160;None&#160;<b>and</b>&#160;old_name&#160;!=&#160;form.name.data:<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;flash('Looks like you have changed your name!')<br/>&#160; &#160; &#160; &#160;&#160;session['name']&#160;=&#160;form.name.data<br/>&#160; &#160; &#160; &#160;&#160;form.name.data&#160;=&#160;''<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;redirect(url_for('index'))<br/>&#160; &#160;&#160;<b>return</b>&#160;render_template('index.html',<br/>&#160; &#160; &#160; &#160;&#160;form&#160;=&#160;form,&#160;name&#160;=&#160;session.get('name'))</p>
<p style="position:absolute;top:790px;left:108px;white-space:nowrap" class="ft6614">In this example, each time a name is submitted it is compared against the name stored</p>
<p style="position:absolute;top:809px;left:108px;white-space:nowrap" class="ft6614">in the user session, which would have been put there during a previous submission of</p>
<p style="position:absolute;top:829px;left:108px;white-space:nowrap" class="ft6614">the same form. If the two names are different, the&#160;flash()&#160;function is invoked with a</p>
<p style="position:absolute;top:848px;left:108px;white-space:nowrap" class="ft6614">message to be displayed on the next response sent back to the client.</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft665"><b>46&#160;&#160;|&#160;&#160;Chapter 4: Web Forms</b></p>
</div>
<!-- Page 67 -->
<a name="67"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft6772{font-size:10px;font-family:Times;color:#999999;}
-->
</style>
<div id="page67-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask067.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft6714">Calling&#160;flash()&#160;is not enough to get messages displayed; the templates used by the</p>
<p style="position:absolute;top:98px;left:108px;white-space:nowrap" class="ft6714">application need to render these messages. The best place to render flashed messages is</p>
<p style="position:absolute;top:117px;left:108px;white-space:nowrap" class="ft6746">the base template, because that will enable these messages in all pages. Flask makes a<br/>get_flashed_messages()</p>
<p style="position:absolute;top:137px;left:273px;white-space:nowrap" class="ft6714">&#160;function available to templates to retrieve the messages and</p>
<p style="position:absolute;top:156px;left:108px;white-space:nowrap" class="ft6714"><a href="Flask.html#67">render them, as shown in&#160;Example 4-7.</a></p>
<p style="position:absolute;top:188px;left:108px;white-space:nowrap" class="ft6766"><i>Example 4-7. templates/base.html: Flash message rendering<br/></i>{% block content %}<br/><b>&lt;div</b>&#160;class=&#34;container&#34;<b>&gt;<br/></b>&#160; &#160; {% for message in get_flashed_messages() %}<br/>&#160; &#160;&#160;<b>&lt;div</b>&#160;class=&#34;alert alert-warning&#34;<b>&gt;<br/></b>&#160; &#160; &#160; &#160;&#160;<b>&lt;button</b>&#160;type=&#34;button&#34;&#160;class=&#34;close&#34;&#160;data-dismiss=&#34;alert&#34;<b>&gt;&amp;times;&lt;/button&gt;<br/></b>&#160; &#160; &#160; &#160; {{ message }}<br/>&#160; &#160;&#160;<b>&lt;/div&gt;<br/></b>&#160; &#160; {% endfor %}</p>
<p style="position:absolute;top:353px;left:108px;white-space:nowrap" class="ft6766">&#160; &#160; {% block page_content %}{% endblock %}<br/><b>&lt;/div&gt;<br/></b>{% endblock %}</p>
<p style="position:absolute;top:410px;left:108px;white-space:nowrap" class="ft6714">In this example, messages are rendered using Bootstrap’s alert CSS styles for warning</p>
<p style="position:absolute;top:429px;left:108px;white-space:nowrap" class="ft6714"><a href="Flask.html#67">messages (one is shown in&#160;Figure 4-4</a>).</p>
<p style="position:absolute;top:777px;left:108px;white-space:nowrap" class="ft6710"><i>Figure 4-4. Flashed message</i></p>
<p style="position:absolute;top:813px;left:108px;white-space:nowrap" class="ft6714">A loop is used because there could be multiple messages queued for display, one for</p>
<p style="position:absolute;top:833px;left:108px;white-space:nowrap" class="ft6714">each time&#160;flash()&#160;was called in the previous request cycle. Messages that are retrieved</p>
<p style="position:absolute;top:915px;left:529px;white-space:nowrap" class="ft675"><b>Message Flashing&#160;&#160;|&#160;&#160;47</b></p>
</div>
<!-- Page 68 -->
<a name="68"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page68-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask068.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft6814">from&#160;get_flashed_messages()&#160;will not be returned the next time this function is called,</p>
<p style="position:absolute;top:98px;left:108px;white-space:nowrap" class="ft6814">so flashed messages appear only once and are then discarded.</p>
<p style="position:absolute;top:140px;left:198px;white-space:nowrap" class="ft6825">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:158px;left:198px;white-space:nowrap" class="ft6825">run&#160;git&#160;checkout&#160;4c&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:246px;left:108px;white-space:nowrap" class="ft6814">Being able to accept data from the user through web forms is a feature required by most</p>
<p style="position:absolute;top:265px;left:108px;white-space:nowrap" class="ft6814">applications, and so is the ability to store that data in permanent storage. Using databases</p>
<p style="position:absolute;top:284px;left:108px;white-space:nowrap" class="ft6814">with Flask is the topic of the next chapter.</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft685"><b>48&#160;&#160;|&#160;&#160;Chapter 4: Web Forms</b></p>
</div>
<!-- Page 69 -->
<a name="69"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page69-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask069.png" alt="background image"/>
<p style="position:absolute;top:104px;left:559px;white-space:nowrap" class="ft6928"><b>CHAPTER 5</b></p>
<p style="position:absolute;top:131px;left:520px;white-space:nowrap" class="ft6911"><b>Databases</b></p>
<p style="position:absolute;top:345px;left:108px;white-space:nowrap" class="ft6914">A&#160;<i>database</i>&#160;stores application data in an organized way. The application then issues</p>
<p style="position:absolute;top:365px;left:108px;white-space:nowrap" class="ft6910"><i>queries</i></p>
<p style="position:absolute;top:364px;left:152px;white-space:nowrap" class="ft6914">&#160;to retrieve specific portions as they are needed. The most commonly used da‐</p>
<p style="position:absolute;top:383px;left:108px;white-space:nowrap" class="ft6914">tabases for web applications are those based on the&#160;<i>relational</i>&#160;model, also called SQL</p>
<p style="position:absolute;top:402px;left:108px;white-space:nowrap" class="ft6914">databases in reference to the Structured Query Language they use. But in recent years</p>
<p style="position:absolute;top:422px;left:108px;white-space:nowrap" class="ft6910"><i>document-oriented</i></p>
<p style="position:absolute;top:421px;left:226px;white-space:nowrap" class="ft6914">&#160;and&#160;<i>key-value</i>&#160;databases, informally known together as NoSQL da‐</p>
<p style="position:absolute;top:440px;left:108px;white-space:nowrap" class="ft6914">tabases, have become popular alternatives.</p>
<p style="position:absolute;top:477px;left:108px;white-space:nowrap" class="ft6922"><b>SQL Databases&#160;<br/></b>Relational databases store data in&#160;<i>tables</i>, which model the different entities in the ap‐</p>
<p style="position:absolute;top:537px;left:108px;white-space:nowrap" class="ft6914">plication’s domain. For example, a database for an order management application will</p>
<p style="position:absolute;top:557px;left:108px;white-space:nowrap" class="ft6915">likely have&#160;customers,&#160;products, and&#160;orders&#160;tables.<br/>A table has a fixed number of&#160;<i>columns</i>&#160;and a variable number of&#160;<i>rows</i>. The columns</p>
<p style="position:absolute;top:605px;left:108px;white-space:nowrap" class="ft6914">define the data attributes of the entity represented by the table. For example, a&#160;customers</p>
<p style="position:absolute;top:625px;left:108px;white-space:nowrap" class="ft6914">table will have columns such as&#160;name,&#160;address,&#160;phone, and so on. Each row in a table</p>
<p style="position:absolute;top:644px;left:108px;white-space:nowrap" class="ft6915">defines an actual data element that consists of values for all the columns.<br/>Tables have a special column called the&#160;<i>primary key</i>, which holds a unique identifier for</p>
<p style="position:absolute;top:690px;left:108px;white-space:nowrap" class="ft6914">each row stored in the table. Tables can also have columns called&#160;<i>foreign keys</i>, which</p>
<p style="position:absolute;top:709px;left:108px;white-space:nowrap" class="ft6914">reference the primary key of another row from the same or another table. These links</p>
<p style="position:absolute;top:728px;left:108px;white-space:nowrap" class="ft6914">between rows are called&#160;<i>relationships</i>&#160;and are the foundation of the relational database</p>
<p style="position:absolute;top:747px;left:108px;white-space:nowrap" class="ft6915">model.<br/><a href="Flask.html#69">Figure 5-1&#160;shows a diagram of a sim</a>ple database with two tables that store users and</p>
<p style="position:absolute;top:794px;left:108px;white-space:nowrap" class="ft6914">user roles. The line that connects the two tables represents a relationship between the</p>
<p style="position:absolute;top:813px;left:108px;white-space:nowrap" class="ft6914">tables.</p>
<p style="position:absolute;top:915px;left:637px;white-space:nowrap" class="ft695"><b>49</b></p>
</div>
<!-- Page 70 -->
<a name="70"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page70-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask070.png" alt="background image"/>
<p style="position:absolute;top:217px;left:108px;white-space:nowrap" class="ft7010"><i>Figure 5-1. Relational database example</i></p>
<p style="position:absolute;top:253px;left:108px;white-space:nowrap" class="ft7014">In this database diagram, the&#160;roles&#160;table stores the list of all possible user roles, each</p>
<p style="position:absolute;top:273px;left:108px;white-space:nowrap" class="ft7014">identified by a unique&#160;id&#160;value—the table’s primary key. The&#160;users&#160;table contains the</p>
<p style="position:absolute;top:293px;left:108px;white-space:nowrap" class="ft7014">list of users, each with its own unique&#160;id&#160;as well. Besides the&#160;id&#160;primary keys, the&#160;roles</p>
<p style="position:absolute;top:313px;left:108px;white-space:nowrap" class="ft7046">table has a&#160;name&#160;column and the&#160;users&#160;table has&#160;username&#160;and&#160;password&#160;columns. The<br/>role_id</p>
<p style="position:absolute;top:333px;left:161px;white-space:nowrap" class="ft7014">&#160;column in the&#160;users&#160;table is a foreign key that references the&#160;id&#160;of a role, and</p>
<p style="position:absolute;top:352px;left:108px;white-space:nowrap" class="ft7015">in this way the role assigned to each user is established.<br/>As seen in the example, relational databases store data efficiently and avoid duplication.</p>
<p style="position:absolute;top:398px;left:108px;white-space:nowrap" class="ft7014">Renaming a user role in this database is simple because role names exist in a single place.</p>
<p style="position:absolute;top:418px;left:108px;white-space:nowrap" class="ft7014">Immediately after a role name is changed in the&#160;roles&#160;table, all users that have a&#160;role_id</p>
<p style="position:absolute;top:437px;left:108px;white-space:nowrap" class="ft7015">that references the changed role will see the update.<br/>On the other hand, having the data split into multiple tables can be a complication.</p>
<p style="position:absolute;top:484px;left:108px;white-space:nowrap" class="ft7014">Producing a listing of users with their roles presents a small problem, because users and</p>
<p style="position:absolute;top:503px;left:108px;white-space:nowrap" class="ft7014">user roles need to be read from two tables and&#160;<i>joined</i>&#160;before they can be presented</p>
<p style="position:absolute;top:522px;left:108px;white-space:nowrap" class="ft7014">together. Relational database engines provide the support to perform join operations</p>
<p style="position:absolute;top:541px;left:108px;white-space:nowrap" class="ft7014">between tables when necessary.</p>
<p style="position:absolute;top:578px;left:108px;white-space:nowrap" class="ft7022"><b>NoSQL Databases&#160;<br/></b>Databases that do not follow the relational model described in the previous section are</p>
<p style="position:absolute;top:638px;left:108px;white-space:nowrap" class="ft7014">collectively referred to as&#160;<i>NoSQL</i>&#160;databases. One common organization for NoSQL</p>
<p style="position:absolute;top:657px;left:108px;white-space:nowrap" class="ft7014">databases uses&#160;<i>collections</i>&#160;instead of tables and&#160;<i>documents</i>&#160;instead of records. NoSQL</p>
<p style="position:absolute;top:676px;left:108px;white-space:nowrap" class="ft7014">databases are designed in a way that makes joins difficult, so most of them do not support</p>
<p style="position:absolute;top:695px;left:108px;white-space:nowrap" class="ft7014">this operation at all. For a NoSQL database structured as in&#160;<a href="Flask.html#69">Figure 5-1</a>, listing the users</p>
<p style="position:absolute;top:714px;left:108px;white-space:nowrap" class="ft7014">with their roles requires the application itself to perform the join operation by reading</p>
<p style="position:absolute;top:734px;left:108px;white-space:nowrap" class="ft7015">the&#160;role_id&#160;field of each user and then searching the&#160;roles&#160;table for it.<br/>A more appropriate design for a NoSQL database is shown in&#160;<a href="Flask.html#70">Figure 5-2. This is the</a></p>
<p style="position:absolute;top:780px;left:108px;white-space:nowrap" class="ft7014">result of applying an operation called&#160;<i>denormalization</i>, which reduces the number of</p>
<p style="position:absolute;top:799px;left:108px;white-space:nowrap" class="ft7014">tables at the expense of data duplication.</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft705"><b>50&#160;&#160;|&#160;&#160;Chapter 5: Databases</b></p>
</div>
<!-- Page 71 -->
<a name="71"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page71-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask071.png" alt="background image"/>
<p style="position:absolute;top:217px;left:108px;white-space:nowrap" class="ft7110"><i>Figure 5-2. NoSQL database example</i></p>
<p style="position:absolute;top:252px;left:108px;white-space:nowrap" class="ft7114">A database with this structure has the role name explicitly stored with each user. Re‐</p>
<p style="position:absolute;top:271px;left:108px;white-space:nowrap" class="ft7114">naming a role can then turn out to be an expensive operation that may require updating</p>
<p style="position:absolute;top:290px;left:108px;white-space:nowrap" class="ft7115">a large number of documents.<br/>But it isn’t all bad news with NoSQL databases. Having the data duplicated allows for</p>
<p style="position:absolute;top:337px;left:108px;white-space:nowrap" class="ft7114">faster querying. Listing users and their roles is straightforward because no joins are</p>
<p style="position:absolute;top:356px;left:108px;white-space:nowrap" class="ft7114">needed.</p>
<p style="position:absolute;top:392px;left:108px;white-space:nowrap" class="ft7118"><b>SQL or NoSQL?<br/></b>SQL databases excel at storing structured data in an efficient and compact form. These</p>
<p style="position:absolute;top:451px;left:108px;white-space:nowrap" class="ft7114">databases go to great lengths to preserve consistency. NoSQL databases relax some of</p>
<p style="position:absolute;top:470px;left:108px;white-space:nowrap" class="ft7115">the consistency requirements and as a result can sometimes get a performance edge.<br/>A full analysis and comparison of database types is outside the scope of this book. For</p>
<p style="position:absolute;top:517px;left:108px;white-space:nowrap" class="ft7114">small- to medium-size applications, both SQL and NoSQL databases are perfectly ca‐</p>
<p style="position:absolute;top:536px;left:108px;white-space:nowrap" class="ft7114">pable and have practically equivalent performance.</p>
<p style="position:absolute;top:572px;left:108px;white-space:nowrap" class="ft7118"><b>Python Database Frameworks<br/></b>Python has packages for most database engines, both open source and commercial.</p>
<p style="position:absolute;top:631px;left:108px;white-space:nowrap" class="ft7114">Flask puts no restrictions on what database packages can be used, so you can work with</p>
<p style="position:absolute;top:650px;left:108px;white-space:nowrap" class="ft7115">MySQL, Postgres, SQLite, Redis, MongoDB, or CouchDB if any of these is your favorite.<br/>As if those weren’t enough choices, there are also a number of database abstraction layer</p>
<p style="position:absolute;top:697px;left:108px;white-space:nowrap" class="ft7114">packages such as SQLAlchemy or MongoEngine that allow you to work at a higher level</p>
<p style="position:absolute;top:716px;left:108px;white-space:nowrap" class="ft7114">with regular Python objects instead of database entities such as tables, documents, or</p>
<p style="position:absolute;top:735px;left:108px;white-space:nowrap" class="ft7124">query languages.<br/>There are a number of factors to evaluate when choosing a database framework:<br/><i>Ease of use</i></p>
<p style="position:absolute;top:807px;left:135px;white-space:nowrap" class="ft7114">When comparing straight database engines versus database abstraction layers, the</p>
<p style="position:absolute;top:826px;left:135px;white-space:nowrap" class="ft7114">second group clearly wins. Abstraction layers, also called object-relational mappers</p>
<p style="position:absolute;top:845px;left:135px;white-space:nowrap" class="ft7114">(ORMs) or object-document mappers (ODMs), provide transparent conversion of</p>
<p style="position:absolute;top:864px;left:135px;white-space:nowrap" class="ft7114">high-level object-oriented operations into low-level database instructions.</p>
<p style="position:absolute;top:915px;left:545px;white-space:nowrap" class="ft715"><b>SQL or NoSQL?&#160;&#160;|&#160;&#160;51</b></p>
</div>
<!-- Page 72 -->
<a name="72"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page72-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask072.png" alt="background image"/>
<p style="position:absolute;top:80px;left:108px;white-space:nowrap" class="ft7210"><i>Performance</i></p>
<p style="position:absolute;top:98px;left:135px;white-space:nowrap" class="ft7214">The conversions that ORMs and ODMs have to do to translate from the object</p>
<p style="position:absolute;top:117px;left:135px;white-space:nowrap" class="ft7214">domain into the database domain have an overhead. In most cases, the performance</p>
<p style="position:absolute;top:136px;left:135px;white-space:nowrap" class="ft7214">penalty is negligible, but they may not always be. In general, the productivity gain</p>
<p style="position:absolute;top:155px;left:135px;white-space:nowrap" class="ft7214">obtained with ORMs and ODMs far outweighs a minimal performance degrada‐</p>
<p style="position:absolute;top:174px;left:135px;white-space:nowrap" class="ft7214">tion, so this isn’t a valid argument to drop ORMs and ODMs completely. What</p>
<p style="position:absolute;top:193px;left:135px;white-space:nowrap" class="ft7214">makes sense is to choose a database abstraction layer that provides optional access</p>
<p style="position:absolute;top:212px;left:135px;white-space:nowrap" class="ft7214">to the underlying database in case specific operations need to be optimized by im‐</p>
<p style="position:absolute;top:231px;left:135px;white-space:nowrap" class="ft7214">plementing them directly as native database instructions.</p>
<p style="position:absolute;top:261px;left:108px;white-space:nowrap" class="ft7210"><i>Portability</i></p>
<p style="position:absolute;top:279px;left:135px;white-space:nowrap" class="ft7214">The database choices available on your development and production platforms</p>
<p style="position:absolute;top:297px;left:135px;white-space:nowrap" class="ft7214">must be considered. For example, if you plan to host your application on a cloud</p>
<p style="position:absolute;top:316px;left:135px;white-space:nowrap" class="ft7215">platform, then you should find out what database choices this service offers.<br/>Another portability aspect applies to ORMs and ODMs. Although some of these</p>
<p style="position:absolute;top:363px;left:135px;white-space:nowrap" class="ft7214">frameworks provide an abstraction layer for a single database engine, others ab‐</p>
<p style="position:absolute;top:382px;left:135px;white-space:nowrap" class="ft7214">stract even higher and provide a choice of database engines—all accessible with the</p>
<p style="position:absolute;top:401px;left:135px;white-space:nowrap" class="ft7214">same object-oriented interface. The best example of this is the SQLAlchemy ORM,</p>
<p style="position:absolute;top:420px;left:135px;white-space:nowrap" class="ft7214">which supports a list of relational database engines including the popular MySQL,</p>
<p style="position:absolute;top:439px;left:135px;white-space:nowrap" class="ft7214">Postgres, and SQLite.</p>
<p style="position:absolute;top:469px;left:108px;white-space:nowrap" class="ft7210"><i>Flask integration</i></p>
<p style="position:absolute;top:487px;left:135px;white-space:nowrap" class="ft7214">Choosing a framework that has integration with Flask is not absolutely required,</p>
<p style="position:absolute;top:506px;left:135px;white-space:nowrap" class="ft7214">but it will save you from having to write the integration code yourself. Flask inte‐</p>
<p style="position:absolute;top:524px;left:135px;white-space:nowrap" class="ft7214">gration could simplify configuration and operation, so using a package specifically</p>
<p style="position:absolute;top:543px;left:135px;white-space:nowrap" class="ft7214">designed as a Flask extension should be preferred.</p>
<p style="position:absolute;top:571px;left:108px;white-space:nowrap" class="ft7214">Based on these goals, the chosen database framework for the examples in this book will</p>
<p style="position:absolute;top:590px;left:108px;white-space:nowrap" class="ft7214"><a href="http://pythonhosted.org/Flask-SQLAlchemy/">be&#160;Flask-SQLAlchemy, the Flask extension wra</a><a href="http://www.sqlalchemy.org/">pper for&#160;SQLAlchemy</a>.</p>
<p style="position:absolute;top:627px;left:108px;white-space:nowrap" class="ft7222"><b>Database Management with Flask-SQLAlchemy&#160;<br/></b>Flask-SQLAlchemy is a Flask extension that simplifies the use of SQLAlchemy inside</p>
<p style="position:absolute;top:688px;left:108px;white-space:nowrap" class="ft7214">Flask applications. SQLAlchemy is a powerful relational database framework that sup‐</p>
<p style="position:absolute;top:707px;left:108px;white-space:nowrap" class="ft7214">ports several database backends. It offers a high-level ORM and low level access to the</p>
<p style="position:absolute;top:726px;left:108px;white-space:nowrap" class="ft7215">database’s native SQL functionality.<br/>Like most other extensions, Flask-SQLAlchemy is installed with pip:</p>
<p style="position:absolute;top:785px;left:133px;white-space:nowrap" class="ft7233">(venv)&#160;$&#160;pip install flask-sqlalchemy</p>
<p style="position:absolute;top:806px;left:108px;white-space:nowrap" class="ft7214">In Flask-SQLAlchemy, a da<a href="Flask.html#72">tabase is specified as a URL.&#160;Table 5-1&#160;</a>lists the format of</p>
<p style="position:absolute;top:825px;left:108px;white-space:nowrap" class="ft7214">database URLs for the three most popular database engines.&#160;</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft725"><b>52&#160;&#160;|&#160;&#160;Chapter 5: Databases</b></p>
</div>
<!-- Page 73 -->
<a name="73"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft7373{font-size:11px;font-family:Times;color:#231f20;}
	.ft7374{font-size:11px;line-height:21px;font-family:Times;color:#ffffff;}
-->
</style>
<div id="page73-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask073.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft7310"><i>Table 5-1. Flask-SQLAlchemy database URLs</i></p>
<p style="position:absolute;top:107px;left:113px;white-space:nowrap" class="ft7374"><b>Database&#160;engine&#160;URL<br/></b>MySQL</p>
<p style="position:absolute;top:129px;left:199px;white-space:nowrap" class="ft7373"><i>mysql://username:password@hostname/database</i></p>
<p style="position:absolute;top:151px;left:113px;white-space:nowrap" class="ft7330">Postgres</p>
<p style="position:absolute;top:151px;left:199px;white-space:nowrap" class="ft7373"><i>postgresql://username:password@hostname/database</i></p>
<p style="position:absolute;top:172px;left:113px;white-space:nowrap" class="ft7330">SQLite&#160;(Unix)</p>
<p style="position:absolute;top:172px;left:199px;white-space:nowrap" class="ft7373"><i>sqlite:////absolute/path/to/database</i></p>
<p style="position:absolute;top:194px;left:113px;white-space:nowrap" class="ft7330">SQLite&#160;(Windows)&#160;<i>sqlite:///c:/absolute/path/to/database</i></p>
<p style="position:absolute;top:227px;left:108px;white-space:nowrap" class="ft7314">In these URLs,&#160;<i>hostname</i>&#160;refers to the server that hosts the MySQL service, which could</p>
<p style="position:absolute;top:246px;left:108px;white-space:nowrap" class="ft7314">be&#160;<i>localhost</i>&#160;or a remote server. Database servers can host several databases, so&#160;<i>data‐</i></p>
<p style="position:absolute;top:265px;left:108px;white-space:nowrap" class="ft7310"><i>base</i></p>
<p style="position:absolute;top:265px;left:135px;white-space:nowrap" class="ft7314">&#160;indicates the name of the database to use. For databases that need authentication,</p>
<p style="position:absolute;top:284px;left:108px;white-space:nowrap" class="ft7310"><i>username</i></p>
<p style="position:absolute;top:283px;left:169px;white-space:nowrap" class="ft7314">&#160;and&#160;<i>password</i>&#160;are the database user credentials.</p>
<p style="position:absolute;top:323px;left:198px;white-space:nowrap" class="ft7325">SQLite&#160;databases&#160;do&#160;not&#160;have&#160;a&#160;server,&#160;so&#160;<i>hostname</i>,&#160;<i>username</i>,&#160;and</p>
<p style="position:absolute;top:341px;left:198px;white-space:nowrap" class="ft7342"><i>password</i></p>
<p style="position:absolute;top:340px;left:251px;white-space:nowrap" class="ft7325">&#160;are&#160;omitted&#160;and&#160;<i>database</i>&#160;is&#160;the&#160;filename&#160;of&#160;a&#160;disk&#160;file.</p>
<p style="position:absolute;top:428px;left:108px;white-space:nowrap" class="ft7346">The URL of the application database must be configured as the key<br/>SQLALCHEMY_DATABASE_URI</p>
<p style="position:absolute;top:447px;left:280px;white-space:nowrap" class="ft7314">&#160;in the Flask configuration object. Another useful option is</p>
<p style="position:absolute;top:467px;left:108px;white-space:nowrap" class="ft7314">the configuration key&#160;SQLALCHEMY_COMMIT_ON_TEARDOWN, which can be set to&#160;True&#160;to</p>
<p style="position:absolute;top:486px;left:108px;white-space:nowrap" class="ft7314">enable automatic commits of database changes at the end of each request. Consult the</p>
<p style="position:absolute;top:505px;left:108px;white-space:nowrap" class="ft7314">Flask-SQLAlchemy documentation for information on other configuration options.</p>
<p style="position:absolute;top:524px;left:108px;white-space:nowrap" class="ft7317"><a href="Flask.html#73">Example 5-1</a>&#160;shows how to initialize and configure a simple SQLite database.&#160;</p>
<p style="position:absolute;top:556px;left:108px;white-space:nowrap" class="ft7350"><i>Example 5-1. hello.py: Database configuration<br/></i><b>from</b>&#160;<b>flask.ext.sqlalchemy</b>&#160;<b>import</b>&#160;SQLAlchemy</p>
<p style="position:absolute;top:614px;left:108px;white-space:nowrap" class="ft7337">basedir&#160;=&#160;os.path.abspath(os.path.dirname(__file__))</p>
<p style="position:absolute;top:645px;left:108px;white-space:nowrap" class="ft7347">app&#160;=&#160;Flask(__name__)<br/>app.config['SQLALCHEMY_DATABASE_URI']&#160;=\<br/>&#160; &#160;&#160;'sqlite:///'&#160;+&#160;os.path.join(basedir,&#160;'data.sqlite')<br/>app.config['SQLALCHEMY_COMMIT_ON_TEARDOWN']&#160;=&#160;True</p>
<p style="position:absolute;top:721px;left:108px;white-space:nowrap" class="ft7337">db&#160;=&#160;SQLAlchemy(app)</p>
<p style="position:absolute;top:749px;left:108px;white-space:nowrap" class="ft7314">The&#160;db&#160;object instantiated from class&#160;SQLAlchemy&#160;represents the database and provides</p>
<p style="position:absolute;top:768px;left:108px;white-space:nowrap" class="ft7314">access to all the functionality of Flask-SQLAlchemy.</p>
<p style="position:absolute;top:915px;left:396px;white-space:nowrap" class="ft735"><b>Database Management with Flask-SQLAlchemy &#160;&#160;|&#160;&#160;53</b></p>
</div>
<!-- Page 74 -->
<a name="74"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page74-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask074.png" alt="background image"/>
<p style="position:absolute;top:75px;left:108px;white-space:nowrap" class="ft7422"><b>Model Definition&#160;<br/></b>The term&#160;<i>model</i>&#160;is used to refer to the persistent entities used by the application. In the</p>
<p style="position:absolute;top:136px;left:108px;white-space:nowrap" class="ft7414">context of an ORM, a model is typically a Python class with attributes that match the</p>
<p style="position:absolute;top:155px;left:108px;white-space:nowrap" class="ft7415">columns of a corresponding database table.<br/>The database instance from Flask-SQLAlchemy provides a base class for models as well</p>
<p style="position:absolute;top:202px;left:108px;white-space:nowrap" class="ft7414">as a set of helper classes and functions that are used to define their structure. The&#160;roles</p>
<p style="position:absolute;top:222px;left:108px;white-space:nowrap" class="ft7414">and&#160;users&#160;<a href="Flask.html#69">tables from&#160;Figure 5-1&#160;</a>can be defined as models&#160;Role&#160;and&#160;User&#160;as shown in</p>
<p style="position:absolute;top:241px;left:108px;white-space:nowrap" class="ft7417"><a href="Flask.html#74">Example 5-2</a>.</p>
<p style="position:absolute;top:273px;left:108px;white-space:nowrap" class="ft7447"><i>Example 5-2. hello.py: Role and User model definition<br/></i><b>class</b>&#160;<b>Role</b>(db.Model):<br/>&#160; &#160;&#160;__tablename__&#160;=&#160;'roles'<br/>&#160; &#160;&#160;id&#160;=&#160;db.Column(db.Integer,&#160;primary_key=True)<br/>&#160; &#160;&#160;name&#160;=&#160;db.Column(db.String(64),&#160;unique=True)</p>
<p style="position:absolute;top:377px;left:108px;white-space:nowrap" class="ft7447">&#160; &#160;&#160;<b>def</b>&#160;__repr__(self):<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;'&lt;Role&#160;%r&gt;'&#160;%&#160;self.name</p>
<p style="position:absolute;top:423px;left:108px;white-space:nowrap" class="ft7447"><b>class</b>&#160;<b>User</b>(db.Model):<br/>&#160; &#160;&#160;__tablename__&#160;=&#160;'users'<br/>&#160; &#160;&#160;id&#160;=&#160;db.Column(db.Integer,&#160;primary_key=True)<br/>&#160; &#160;&#160;username&#160;=&#160;db.Column(db.String(64),&#160;unique=True,&#160;index=True)</p>
<p style="position:absolute;top:500px;left:108px;white-space:nowrap" class="ft7447">&#160; &#160;&#160;<b>def</b>&#160;__repr__(self):<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;'&lt;User&#160;%r&gt;'&#160;%&#160;self.username</p>
<p style="position:absolute;top:542px;left:108px;white-space:nowrap" class="ft7414">The&#160;__tablename__&#160;class variable defines the name of the table in the database. Flask-</p>
<p style="position:absolute;top:562px;left:108px;white-space:nowrap" class="ft7414">SQLAlchemy assigns a default table name if&#160;__tablename__&#160;is omitted, but those default</p>
<p style="position:absolute;top:581px;left:108px;white-space:nowrap" class="ft7414">names do not follow the convention of using plurals for table names, so it is best to</p>
<p style="position:absolute;top:600px;left:108px;white-space:nowrap" class="ft7414">name tables explicitly. The remaining class variables are the attributes of the model,</p>
<p style="position:absolute;top:620px;left:108px;white-space:nowrap" class="ft7448">defined as instances of the&#160;db.Column&#160;class.<br/>The first argument given to the&#160;db.Column&#160;constructor is the type of the database column</p>
<p style="position:absolute;top:668px;left:108px;white-space:nowrap" class="ft7414">and model a<a href="Flask.html#74">ttribute.&#160;Table 5-2&#160;</a>lists some of the column types that are available, along</p>
<p style="position:absolute;top:687px;left:108px;white-space:nowrap" class="ft7448">with the Python type used in the model.<br/><i>Table 5-2. Most common SQLAlchemy column types</i></p>
<p style="position:absolute;top:743px;left:113px;white-space:nowrap" class="ft7453"><b>Type&#160;name&#160;Python&#160;type</b></p>
<p style="position:absolute;top:743px;left:323px;white-space:nowrap" class="ft7453"><b>Description</b></p>
<p style="position:absolute;top:765px;left:113px;white-space:nowrap" class="ft7430">Integer</p>
<p style="position:absolute;top:768px;left:178px;white-space:nowrap" class="ft7414">int</p>
<p style="position:absolute;top:765px;left:323px;white-space:nowrap" class="ft7430">Regular&#160;integer,&#160;typically&#160;32&#160;bits</p>
<p style="position:absolute;top:789px;left:113px;white-space:nowrap" class="ft7430">SmallInteger&#160;int</p>
<p style="position:absolute;top:789px;left:323px;white-space:nowrap" class="ft7430">Short-range&#160;integer,&#160;typically&#160;16&#160;bits</p>
<p style="position:absolute;top:813px;left:113px;white-space:nowrap" class="ft7430">BigInteger</p>
<p style="position:absolute;top:816px;left:177px;white-space:nowrap" class="ft7414">int</p>
<p style="position:absolute;top:816px;left:200px;white-space:nowrap" class="ft7430">&#160;or&#160;long</p>
<p style="position:absolute;top:813px;left:323px;white-space:nowrap" class="ft7430">Unlimited&#160;precision&#160;integer</p>
<p style="position:absolute;top:837px;left:113px;white-space:nowrap" class="ft7430">Float</p>
<p style="position:absolute;top:840px;left:177px;white-space:nowrap" class="ft7414">float</p>
<p style="position:absolute;top:837px;left:323px;white-space:nowrap" class="ft7430">Floating-point&#160;number</p>
<p style="position:absolute;top:861px;left:113px;white-space:nowrap" class="ft7430">Numeric</p>
<p style="position:absolute;top:864px;left:177px;white-space:nowrap" class="ft7414">decimal.Decimal</p>
<p style="position:absolute;top:861px;left:323px;white-space:nowrap" class="ft7430">Fixed-point&#160;number</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft745"><b>54&#160;&#160;|&#160;&#160;Chapter 5: Databases</b></p>
</div>
<!-- Page 75 -->
<a name="75"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page75-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask075.png" alt="background image"/>
<p style="position:absolute;top:82px;left:113px;white-space:nowrap" class="ft7553"><b>Type&#160;name&#160;Python&#160;type</b></p>
<p style="position:absolute;top:82px;left:323px;white-space:nowrap" class="ft7553"><b>Description</b></p>
<p style="position:absolute;top:104px;left:113px;white-space:nowrap" class="ft7530">String</p>
<p style="position:absolute;top:107px;left:178px;white-space:nowrap" class="ft7514">str</p>
<p style="position:absolute;top:104px;left:323px;white-space:nowrap" class="ft7530">Variable-length&#160;string</p>
<p style="position:absolute;top:128px;left:113px;white-space:nowrap" class="ft7530">Text</p>
<p style="position:absolute;top:131px;left:177px;white-space:nowrap" class="ft7514">str</p>
<p style="position:absolute;top:128px;left:323px;white-space:nowrap" class="ft7530">Variable-length&#160;string,&#160;optimized&#160;for&#160;large&#160;or&#160;unbound&#160;length</p>
<p style="position:absolute;top:152px;left:113px;white-space:nowrap" class="ft7530">Unicode</p>
<p style="position:absolute;top:155px;left:177px;white-space:nowrap" class="ft7514">unicode</p>
<p style="position:absolute;top:152px;left:323px;white-space:nowrap" class="ft7530">Variable-length&#160;Unicode&#160;string</p>
<p style="position:absolute;top:176px;left:113px;white-space:nowrap" class="ft7530">UnicodeText&#160;unicode</p>
<p style="position:absolute;top:176px;left:323px;white-space:nowrap" class="ft7530">Variable-length&#160;Unicode&#160;string,&#160;optimized&#160;for&#160;large&#160;or&#160;unbound&#160;length</p>
<p style="position:absolute;top:200px;left:113px;white-space:nowrap" class="ft7530">Boolean</p>
<p style="position:absolute;top:203px;left:178px;white-space:nowrap" class="ft7514">bool</p>
<p style="position:absolute;top:200px;left:323px;white-space:nowrap" class="ft7530">Boolean&#160;value</p>
<p style="position:absolute;top:225px;left:113px;white-space:nowrap" class="ft7530">Date</p>
<p style="position:absolute;top:227px;left:177px;white-space:nowrap" class="ft7514">datetime.date</p>
<p style="position:absolute;top:225px;left:323px;white-space:nowrap" class="ft7530">Date&#160;value</p>
<p style="position:absolute;top:249px;left:113px;white-space:nowrap" class="ft7530">Time</p>
<p style="position:absolute;top:251px;left:178px;white-space:nowrap" class="ft7514">datetime.time</p>
<p style="position:absolute;top:249px;left:323px;white-space:nowrap" class="ft7530">Time&#160;value</p>
<p style="position:absolute;top:273px;left:113px;white-space:nowrap" class="ft7530">DateTime</p>
<p style="position:absolute;top:275px;left:177px;white-space:nowrap" class="ft7514">datetime.datetime</p>
<p style="position:absolute;top:273px;left:323px;white-space:nowrap" class="ft7530">Date&#160;and&#160;time&#160;value</p>
<p style="position:absolute;top:297px;left:113px;white-space:nowrap" class="ft7530">Interval</p>
<p style="position:absolute;top:299px;left:178px;white-space:nowrap" class="ft7514">datetime.timedelta&#160;Time&#160;interval</p>
<p style="position:absolute;top:321px;left:113px;white-space:nowrap" class="ft7530">Enum</p>
<p style="position:absolute;top:323px;left:177px;white-space:nowrap" class="ft7514">str</p>
<p style="position:absolute;top:321px;left:323px;white-space:nowrap" class="ft7530">List&#160;of&#160;string&#160;values</p>
<p style="position:absolute;top:345px;left:113px;white-space:nowrap" class="ft7530">PickleType</p>
<p style="position:absolute;top:345px;left:177px;white-space:nowrap" class="ft7530">Any&#160;Python&#160;object</p>
<p style="position:absolute;top:345px;left:323px;white-space:nowrap" class="ft7530">Automatic&#160;Pickle&#160;serialization</p>
<p style="position:absolute;top:367px;left:113px;white-space:nowrap" class="ft7530">LargeBinary&#160;str</p>
<p style="position:absolute;top:367px;left:323px;white-space:nowrap" class="ft7530">Binary&#160;blob</p>
<p style="position:absolute;top:403px;left:108px;white-space:nowrap" class="ft7514">The remaining arguments to&#160;db.Column&#160;specify configuration options for each at‐</p>
<p style="position:absolute;top:422px;left:108px;white-space:nowrap" class="ft7548">tribute.&#160;<a href="Flask.html#75">Table 5-3</a>&#160;lists some of the options available.<br/><i>Table 5-3. Most common SQLAlchemy column options</i></p>
<p style="position:absolute;top:478px;left:113px;white-space:nowrap" class="ft7553"><b>Option&#160;name</b></p>
<p style="position:absolute;top:478px;left:207px;white-space:nowrap" class="ft7553"><b>Description</b></p>
<p style="position:absolute;top:503px;left:113px;white-space:nowrap" class="ft7514">primary_key</p>
<p style="position:absolute;top:503px;left:207px;white-space:nowrap" class="ft7530">If&#160;set&#160;to&#160;True,&#160;the&#160;column&#160;is&#160;the&#160;table’s&#160;primary&#160;key.</p>
<p style="position:absolute;top:527px;left:113px;white-space:nowrap" class="ft7514">unique</p>
<p style="position:absolute;top:527px;left:207px;white-space:nowrap" class="ft7530">If&#160;set&#160;to&#160;True,&#160;do&#160;not&#160;allow&#160;duplicate&#160;values&#160;for&#160;this&#160;column.</p>
<p style="position:absolute;top:551px;left:113px;white-space:nowrap" class="ft7514">index</p>
<p style="position:absolute;top:551px;left:207px;white-space:nowrap" class="ft7530">If&#160;set&#160;to&#160;True,&#160;create&#160;an&#160;index&#160;for&#160;this&#160;column,&#160;so&#160;that&#160;queries&#160;are&#160;more&#160;efficient.</p>
<p style="position:absolute;top:575px;left:113px;white-space:nowrap" class="ft7514">nullable</p>
<p style="position:absolute;top:575px;left:207px;white-space:nowrap" class="ft7555">If&#160;set&#160;to&#160;True,&#160;allow&#160;empty&#160;values&#160;for&#160;this&#160;column.&#160;If&#160;set&#160;to&#160;False,&#160;the&#160;column&#160;will&#160;not&#160;allow&#160;null<br/>values.</p>
<p style="position:absolute;top:615px;left:113px;white-space:nowrap" class="ft7514">default</p>
<p style="position:absolute;top:613px;left:207px;white-space:nowrap" class="ft7530">Define&#160;a&#160;default&#160;value&#160;for&#160;the&#160;column.</p>
<p style="position:absolute;top:653px;left:198px;white-space:nowrap" class="ft7525">Flask-SQLAlchemy&#160;requires&#160;all&#160;models&#160;to&#160;define&#160;a&#160;<i>primary&#160;key</i>&#160;col‐</p>
<p style="position:absolute;top:672px;left:198px;white-space:nowrap" class="ft7525">umn,&#160;which&#160;is&#160;normally&#160;named&#160;id.</p>
<p style="position:absolute;top:759px;left:108px;white-space:nowrap" class="ft7514">Although it’s not strictly necessary, the two models include a&#160;__repr__()&#160;method to</p>
<p style="position:absolute;top:778px;left:108px;white-space:nowrap" class="ft7514">give them a readable string representation that can be used for debugging and testing</p>
<p style="position:absolute;top:797px;left:108px;white-space:nowrap" class="ft7514">purposes.</p>
<p style="position:absolute;top:915px;left:530px;white-space:nowrap" class="ft755"><b>Model Definition &#160;&#160;|&#160;&#160;55</b></p>
</div>
<!-- Page 76 -->
<a name="76"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page76-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask076.png" alt="background image"/>
<p style="position:absolute;top:75px;left:108px;white-space:nowrap" class="ft7622"><b>Relationships&#160;<br/></b>Relational databases establish connections between rows in different tables through the</p>
<p style="position:absolute;top:136px;left:108px;white-space:nowrap" class="ft7614">use of relationships. The rela<a href="Flask.html#69">tional diagram in&#160;Figure 5-1</a>&#160;expresses a simple relationship</p>
<p style="position:absolute;top:155px;left:108px;white-space:nowrap" class="ft7614">between users and their roles. This is a&#160;<i>one-to-many</i>&#160;relationship from roles to users,</p>
<p style="position:absolute;top:174px;left:108px;white-space:nowrap" class="ft7615">because one role belongs to many users and users have only one role.<br/><a href="Flask.html#76">Example 5-3&#160;</a>shows how the one-to-many rela<a href="Flask.html#69">tionship in&#160;Figure 5-1&#160;</a>is represented in</p>
<p style="position:absolute;top:220px;left:108px;white-space:nowrap" class="ft7614">the model classes.</p>
<p style="position:absolute;top:252px;left:108px;white-space:nowrap" class="ft7668"><i>Example 5-3. hello.py: Relationships<br/></i><b>class</b>&#160;<b>Role</b>(db.Model):<br/>&#160; &#160;&#160;<i># ...<br/></i>&#160; &#160;&#160;users&#160;=&#160;db.relationship('User',&#160;backref='role')</p>
<p style="position:absolute;top:341px;left:108px;white-space:nowrap" class="ft7668"><b>class</b>&#160;<b>User</b>(db.Model):<br/>&#160; &#160;&#160;<i># ...<br/></i>&#160; &#160;&#160;role_id&#160;=&#160;db.Column(db.Integer,&#160;db.ForeignKey('roles.id'))</p>
<p style="position:absolute;top:398px;left:108px;white-space:nowrap" class="ft7614">As seen in&#160;<a href="Flask.html#69">Figure 5-1</a>, a relationship connects two rows through the user of a foreign</p>
<p style="position:absolute;top:418px;left:108px;white-space:nowrap" class="ft7614">key. The&#160;role_id&#160;column added to the&#160;User&#160;model is defined as a foreign key, and that</p>
<p style="position:absolute;top:438px;left:108px;white-space:nowrap" class="ft7614">establishes the relationship. The&#160;'roles.id'&#160;argument to&#160;db.ForeignKey()&#160;specifies</p>
<p style="position:absolute;top:458px;left:108px;white-space:nowrap" class="ft7648">that the column should be interpreted as having&#160;id&#160;values from rows in the&#160;roles&#160;table.<br/>The&#160;users&#160;attribute added to model&#160;Role&#160;represents the object-oriented view of the</p>
<p style="position:absolute;top:506px;left:108px;white-space:nowrap" class="ft7614">relationship. Given an instance of class&#160;Role, the&#160;users&#160;attribute will return the list of</p>
<p style="position:absolute;top:526px;left:108px;white-space:nowrap" class="ft7614">users associated with that role. The first argument to&#160;db.relationship()&#160;indicates what</p>
<p style="position:absolute;top:545px;left:108px;white-space:nowrap" class="ft7614">model is on the other side of the relationship. This model can be provided as a string if</p>
<p style="position:absolute;top:564px;left:108px;white-space:nowrap" class="ft7648">the class is not yet defined.<br/>The&#160;backref&#160;argument to&#160;db.relationship()&#160;defines the reverse direction of the re‐</p>
<p style="position:absolute;top:613px;left:108px;white-space:nowrap" class="ft7614">lationship by adding a&#160;role&#160;attribute to the&#160;User&#160;model. This attribute can be used</p>
<p style="position:absolute;top:633px;left:108px;white-space:nowrap" class="ft7648">instead of&#160;role_id&#160;to access the&#160;Role&#160;model as an object instead of as a foreign key.<br/>In most cases&#160;db.relationship()&#160;can locate the relationship’s foreign key on its own,</p>
<p style="position:absolute;top:680px;left:108px;white-space:nowrap" class="ft7614">but sometimes it cannot determine what column to use as a foreign key. For example,</p>
<p style="position:absolute;top:700px;left:108px;white-space:nowrap" class="ft7614">if the&#160;User&#160;model had two or more columns defined as&#160;Role&#160;foreign keys, then</p>
<p style="position:absolute;top:719px;left:108px;white-space:nowrap" class="ft7614">SQLAlchemy&#160;would not know which one of the two to use. Whenever the foreign key</p>
<p style="position:absolute;top:739px;left:108px;white-space:nowrap" class="ft7614">configuration is ambiguous, additional arguments to&#160;db.relationship()&#160;need to be</p>
<p style="position:absolute;top:758px;left:108px;white-space:nowrap" class="ft7614"><a href="Flask.html#77">given.&#160;Table 5-4</a>&#160;lists some of the common configuration options that can be used to</p>
<p style="position:absolute;top:777px;left:108px;white-space:nowrap" class="ft7614">define a relationship.</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft765"><b>56&#160;&#160;|&#160;&#160;Chapter 5: Databases</b></p>
</div>
<!-- Page 77 -->
<a name="77"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft7775{font-size:11px;line-height:18px;font-family:Times;color:#231f20;}
-->
</style>
<div id="page77-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask077.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft7710"><i>Table 5-4. Common SQLAlchemy relationship options</i></p>
<p style="position:absolute;top:107px;left:113px;white-space:nowrap" class="ft7753"><b>Option&#160;name</b></p>
<p style="position:absolute;top:107px;left:222px;white-space:nowrap" class="ft7753"><b>Description</b></p>
<p style="position:absolute;top:132px;left:113px;white-space:nowrap" class="ft7714">backref</p>
<p style="position:absolute;top:129px;left:222px;white-space:nowrap" class="ft7730">Add&#160;a&#160;back&#160;reference&#160;in&#160;the&#160;other&#160;model&#160;in&#160;the&#160;relationship.</p>
<p style="position:absolute;top:156px;left:113px;white-space:nowrap" class="ft7714">primaryjoin</p>
<p style="position:absolute;top:153px;left:222px;white-space:nowrap" class="ft7755">Specify&#160;the&#160;join&#160;condition&#160;between&#160;the&#160;two&#160;models&#160;explicitly.&#160;This&#160;is&#160;necessary&#160;only&#160;for&#160;ambiguous<br/>relationships.</p>
<p style="position:absolute;top:194px;left:113px;white-space:nowrap" class="ft7714">lazy</p>
<p style="position:absolute;top:193px;left:222px;white-space:nowrap" class="ft7755">Specify&#160;how&#160;the&#160;related&#160;items&#160;are&#160;to&#160;be&#160;loaded.&#160;Possible&#160;values&#160;are&#160;select&#160;(items&#160;are&#160;loaded&#160;on<br/>demand&#160;the&#160;first&#160;time&#160;they&#160;are&#160;accessed),&#160;immediate&#160;(items&#160;are&#160;loaded&#160;when&#160;the&#160;source&#160;object<br/>is&#160;loaded),&#160;joined&#160;(items&#160;are&#160;loaded&#160;immediately,&#160;but&#160;as&#160;a&#160;join),&#160;subquery&#160;(items&#160;are&#160;loaded<br/>immediately,&#160;but&#160;as&#160;a&#160;subquery),&#160;noload&#160;(items&#160;are&#160;never&#160;loaded),&#160;and&#160;dynamic&#160;(instead&#160;of<br/>loading&#160;the&#160;items&#160;the&#160;query&#160;that&#160;can&#160;load&#160;them&#160;is&#160;given).</p>
<p style="position:absolute;top:290px;left:113px;white-space:nowrap" class="ft7714">uselist</p>
<p style="position:absolute;top:290px;left:222px;white-space:nowrap" class="ft7730">If&#160;set&#160;to&#160;False,&#160;use&#160;a&#160;scalar&#160;instead&#160;of&#160;a&#160;list.</p>
<p style="position:absolute;top:314px;left:113px;white-space:nowrap" class="ft7714">order_by</p>
<p style="position:absolute;top:311px;left:222px;white-space:nowrap" class="ft7730">Specify&#160;the&#160;ordering&#160;used&#160;for&#160;the&#160;items&#160;in&#160;the&#160;relationship.</p>
<p style="position:absolute;top:338px;left:113px;white-space:nowrap" class="ft7714">secondary</p>
<p style="position:absolute;top:335px;left:222px;white-space:nowrap" class="ft7730">Specify&#160;the&#160;name&#160;of&#160;the&#160;association&#160;table&#160;to&#160;use&#160;in&#160;<i>many-to-many</i>&#160;relationships.</p>
<p style="position:absolute;top:362px;left:113px;white-space:nowrap" class="ft7714">secondaryjoin&#160;Specify&#160;the&#160;secondary&#160;join&#160;condition&#160;for&#160;<i>many-to-many</i>&#160;relationships&#160;when&#160;SQLAlchemy&#160;cannot</p>
<p style="position:absolute;top:376px;left:222px;white-space:nowrap" class="ft7730">determine&#160;it&#160;on&#160;its&#160;own.</p>
<p style="position:absolute;top:416px;left:198px;white-space:nowrap" class="ft7725">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:434px;left:198px;white-space:nowrap" class="ft7725">run&#160;git&#160;checkout&#160;5a&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:522px;left:108px;white-space:nowrap" class="ft7714">There are other relationship types besides the one-to-many. The&#160;<i>one-to-one</i>&#160;relationship</p>
<p style="position:absolute;top:542px;left:108px;white-space:nowrap" class="ft7714">can be expressed as the one-to-many described earlier, but with the&#160;uselist&#160;option set</p>
<p style="position:absolute;top:562px;left:108px;white-space:nowrap" class="ft7714">to&#160;False&#160;within the&#160;db.relationship()&#160;definition so that the “many” side becomes a</p>
<p style="position:absolute;top:581px;left:108px;white-space:nowrap" class="ft7714">“one” side. The&#160;<i>many-to-one</i>&#160;relationship can also be expressed as a one-to-many if the</p>
<p style="position:absolute;top:600px;left:108px;white-space:nowrap" class="ft7746">tables are reversed, or it can be expressed with the foreign key and the<br/>db.relationship()</p>
<p style="position:absolute;top:620px;left:236px;white-space:nowrap" class="ft7714">&#160;definition both on the “many” side. The most complex relationship</p>
<p style="position:absolute;top:639px;left:108px;white-space:nowrap" class="ft7714">type, the&#160;<i>many-to-many</i>, requires an additional table called an&#160;<i>association table</i>. You</p>
<p style="position:absolute;top:658px;left:108px;white-space:nowrap" class="ft7714">will learn about many-to-many rela<a href="Flask.html#169">tionships in&#160;Chapter 12</a>.</p>
<p style="position:absolute;top:694px;left:108px;white-space:nowrap" class="ft7718"><b>Database Operations<br/></b>The models are now fully configured according to the database diagram in&#160;<a href="Flask.html#69">Figure 5-1</a></p>
<p style="position:absolute;top:753px;left:108px;white-space:nowrap" class="ft7714">and are ready to be used. The best way to learn how to work with these models is in a</p>
<p style="position:absolute;top:772px;left:108px;white-space:nowrap" class="ft7714">Python shell. The following sections will walk you through the most common database</p>
<p style="position:absolute;top:791px;left:108px;white-space:nowrap" class="ft7714">operations.</p>
<p style="position:absolute;top:915px;left:515px;white-space:nowrap" class="ft775"><b>Database Operations&#160;&#160;|&#160;&#160;57</b></p>
</div>
<!-- Page 78 -->
<a name="78"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page78-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask078.png" alt="background image"/>
<p style="position:absolute;top:76px;left:108px;white-space:nowrap" class="ft7852"><b>Creating the Tables&#160;<br/></b>The very first thing to do is to instruct Flask-SQLAlchemy to create a database based</p>
<p style="position:absolute;top:131px;left:108px;white-space:nowrap" class="ft7814">on the model classes. The&#160;db.create_all()&#160;function does this:</p>
<p style="position:absolute;top:163px;left:134px;white-space:nowrap" class="ft7840">(venv)&#160;$&#160;python&#160;hello.py&#160;shell<br/>&gt;&gt;&gt;&#160;<b>from</b>&#160;<b>hello</b>&#160;<b>import</b>&#160;db<br/>&gt;&gt;&gt;&#160;db.create_all()</p>
<p style="position:absolute;top:214px;left:108px;white-space:nowrap" class="ft7814">If you check the application directory, you will now see a new file there called&#160;<i>da‐</i></p>
<p style="position:absolute;top:234px;left:108px;white-space:nowrap" class="ft7810"><i>ta.sqlite</i></p>
<p style="position:absolute;top:233px;left:157px;white-space:nowrap" class="ft7814">, the name that was given to the SQLite database in the configuration. The</p>
<p style="position:absolute;top:256px;left:108px;white-space:nowrap" class="ft7814">db.create_all()</p>
<p style="position:absolute;top:252px;left:221px;white-space:nowrap" class="ft7814">&#160;function will not re-create or update a database table if it already</p>
<p style="position:absolute;top:271px;left:108px;white-space:nowrap" class="ft7814">exists in the database. This can be inconvenient when the models are modified and the</p>
<p style="position:absolute;top:290px;left:108px;white-space:nowrap" class="ft7814">changes need to be applied to an existing database. The brute-force solution to update</p>
<p style="position:absolute;top:309px;left:108px;white-space:nowrap" class="ft7814">existing database tables is to remove the old tables first:</p>
<p style="position:absolute;top:341px;left:133px;white-space:nowrap" class="ft7847">&gt;&gt;&gt;&#160;db.drop_all()<br/>&gt;&gt;&gt;&#160;db.create_all()</p>
<p style="position:absolute;top:377px;left:108px;white-space:nowrap" class="ft7814">Unfortunately, this method has the undesired side effect of destroying all the data in the</p>
<p style="position:absolute;top:396px;left:108px;white-space:nowrap" class="ft7814">old database. A better solution to the problem of updating databases is presented near</p>
<p style="position:absolute;top:414px;left:108px;white-space:nowrap" class="ft7814">the end of the chapter.</p>
<p style="position:absolute;top:451px;left:108px;white-space:nowrap" class="ft7852"><b>Inserting Rows&#160;<br/></b>The following example creates a few roles and users:</p>
<p style="position:absolute;top:517px;left:133px;white-space:nowrap" class="ft7847">&gt;&gt;&gt;&#160;<b>from</b>&#160;<b>hello</b>&#160;<b>import</b>&#160;Role,&#160;User<br/>&gt;&gt;&gt;&#160;admin_role&#160;=&#160;Role(name='Admin')<br/>&gt;&gt;&gt;&#160;mod_role&#160;=&#160;Role(name='Moderator')<br/>&gt;&gt;&gt;&#160;user_role&#160;=&#160;Role(name='User')<br/>&gt;&gt;&gt;&#160;user_john&#160;=&#160;User(username='john',&#160;role=admin_role)<br/>&gt;&gt;&gt;&#160;user_susan&#160;=&#160;User(username='susan',&#160;role=user_role)<br/>&gt;&gt;&gt;&#160;user_david&#160;=&#160;User(username='david',&#160;role=user_role)</p>
<p style="position:absolute;top:630px;left:108px;white-space:nowrap" class="ft7814">The constructors for models accept initial values for the model attributes as keyword</p>
<p style="position:absolute;top:649px;left:108px;white-space:nowrap" class="ft7814">arguments. Note that even the&#160;role&#160;attribute can be used, even though it is not a real</p>
<p style="position:absolute;top:668px;left:108px;white-space:nowrap" class="ft7846">database column but a high-level representation of the one-to-many relationship. The<br/>id</p>
<p style="position:absolute;top:688px;left:123px;white-space:nowrap" class="ft7814">&#160;attribute of these new objects is not set explicitly: the primary keys are managed by</p>
<p style="position:absolute;top:707px;left:108px;white-space:nowrap" class="ft7814">Flask-SQLAlchemy. The objects exist only on the Python side so far; they have not been</p>
<p style="position:absolute;top:727px;left:108px;white-space:nowrap" class="ft7814">written to the database yet. Because of that their&#160;id&#160;value has not yet been assigned:</p>
<p style="position:absolute;top:759px;left:134px;white-space:nowrap" class="ft7847">&gt;&gt;&gt;&#160;<b>print</b>(admin_role.id)<br/>None<br/>&gt;&gt;&gt;&#160;<b>print</b>(mod_role.id)<br/>None<br/>&gt;&gt;&gt;&#160;<b>print</b>(user_role.id)<br/>None</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft785"><b>58&#160;&#160;|&#160;&#160;Chapter 5: Databases</b></p>
</div>
<!-- Page 79 -->
<a name="79"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft7976{font-size:10px;line-height:15px;font-family:Times;color:#ff6600;}
-->
</style>
<div id="page79-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask079.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft7914">Changes to the database are managed through a database&#160;<i>session</i>, which Flask-</p>
<p style="position:absolute;top:98px;left:108px;white-space:nowrap" class="ft7914">SQLAlchemy provides as&#160;db.session. To prepare objects to be written to the database,</p>
<p style="position:absolute;top:117px;left:108px;white-space:nowrap" class="ft7914">they must be added to the session:</p>
<p style="position:absolute;top:149px;left:133px;white-space:nowrap" class="ft7947">&gt;&gt;&gt;&#160;db.session.add(admin_role)<br/>&gt;&gt;&gt;&#160;db.session.add(mod_role)<br/>&gt;&gt;&gt;&#160;db.session.add(user_role)<br/>&gt;&gt;&gt;&#160;db.session.add(user_john)<br/>&gt;&gt;&gt;&#160;db.session.add(user_susan)<br/>&gt;&gt;&gt;&#160;db.session.add(user_david)</p>
<p style="position:absolute;top:246px;left:108px;white-space:nowrap" class="ft7914">Or, more concisely:</p>
<p style="position:absolute;top:278px;left:134px;white-space:nowrap" class="ft7947">&gt;&gt;&gt;&#160;db.session.add_all([admin_role,&#160;mod_role,&#160;user_role,<br/>...&#160; &#160; &#160;user_john,&#160;user_susan,&#160;user_david])</p>
<p style="position:absolute;top:313px;left:108px;white-space:nowrap" class="ft7946">To write the objects to the database, the session needs to be&#160;<i>committed</i>&#160;by calling its<br/>commit()</p>
<p style="position:absolute;top:333px;left:168px;white-space:nowrap" class="ft7914">&#160;method:</p>
<p style="position:absolute;top:365px;left:134px;white-space:nowrap" class="ft7933">&gt;&gt;&gt;&#160;db.session.commit()</p>
<p style="position:absolute;top:386px;left:108px;white-space:nowrap" class="ft7914">Check the&#160;id&#160;attributes again; they are now set:</p>
<p style="position:absolute;top:418px;left:134px;white-space:nowrap" class="ft7947">&gt;&gt;&gt;&#160;<b>print</b>(admin_role.id)<br/>1<br/>&gt;&gt;&gt;&#160;<b>print</b>(mod_role.id)<br/>2<br/>&gt;&gt;&gt;&#160;<b>print</b>(user_role.id)<br/>3</p>
<p style="position:absolute;top:527px;left:198px;white-space:nowrap" class="ft7925">The&#160;db.session&#160;database&#160;session&#160;is&#160;not&#160;related&#160;to&#160;the&#160;Flask&#160;session</p>
<p style="position:absolute;top:545px;left:198px;white-space:nowrap" class="ft7925">object&#160;discussed&#160;in&#160;<a href="Flask.html#57">Chapter&#160;4</a>.&#160;Database&#160;sessions&#160;are&#160;also&#160;called&#160;<i>trans‐</i></p>
<p style="position:absolute;top:563px;left:198px;white-space:nowrap" class="ft7942"><i>actions</i></p>
<p style="position:absolute;top:562px;left:238px;white-space:nowrap" class="ft7925">.</p>
<p style="position:absolute;top:631px;left:108px;white-space:nowrap" class="ft7914">Database sessions are extremely useful in keeping the database consistent. The commit</p>
<p style="position:absolute;top:650px;left:108px;white-space:nowrap" class="ft7914">operation writes all the objects that were added to the session atomically. If an error</p>
<p style="position:absolute;top:669px;left:108px;white-space:nowrap" class="ft7914">occurs while the session is being written, the whole session is discarded. If you always</p>
<p style="position:absolute;top:688px;left:108px;white-space:nowrap" class="ft7914">commit related changes together in a session, you are guaranteed to avoid database</p>
<p style="position:absolute;top:707px;left:108px;white-space:nowrap" class="ft7914">inconsistencies due to partial updates.</p>
<p style="position:absolute;top:747px;left:198px;white-space:nowrap" class="ft7925">A&#160;database&#160;session&#160;can&#160;also&#160;be&#160;<i>rolled&#160;back</i>.&#160;If&#160;db.session.rollback()</p>
<p style="position:absolute;top:764px;left:198px;white-space:nowrap" class="ft7925">is&#160;called,&#160;any&#160;objects&#160;that&#160;were&#160;added&#160;to&#160;the&#160;database&#160;session&#160;are</p>
<p style="position:absolute;top:782px;left:198px;white-space:nowrap" class="ft7925">restored&#160;to&#160;the&#160;state&#160;they&#160;have&#160;in&#160;the&#160;database.</p>
<p style="position:absolute;top:915px;left:515px;white-space:nowrap" class="ft795"><b>Database Operations&#160;&#160;|&#160;&#160;59</b></p>
</div>
<!-- Page 80 -->
<a name="80"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page80-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask080.png" alt="background image"/>
<p style="position:absolute;top:76px;left:108px;white-space:nowrap" class="ft8065"><b>Modifying Rows&#160;<br/></b>The&#160;add()&#160;method of the database session can also be used to update models. Continuing</p>
<p style="position:absolute;top:132px;left:108px;white-space:nowrap" class="ft8046">in the same shell session, the following example renames the&#160;&#34;Admin&#34;&#160;role to<br/>&#34;Administrator&#34;</p>
<p style="position:absolute;top:152px;left:220px;white-space:nowrap" class="ft8014">:</p>
<p style="position:absolute;top:183px;left:133px;white-space:nowrap" class="ft8047">&gt;&gt;&gt;&#160;admin_role.name&#160;=&#160;'Administrator'<br/>&gt;&gt;&gt;&#160;db.session.add(admin_role)<br/>&gt;&gt;&gt;&#160;db.session.commit()</p>
<p style="position:absolute;top:243px;left:108px;white-space:nowrap" class="ft8046"><b>Deleting Rows&#160;<br/></b>The database session also has a&#160;delete()&#160;method. The following example deletes the<br/>&#34;Moderator&#34;</p>
<p style="position:absolute;top:299px;left:190px;white-space:nowrap" class="ft8014">&#160;role from the database:</p>
<p style="position:absolute;top:330px;left:133px;white-space:nowrap" class="ft8047">&gt;&gt;&gt;&#160;db.session.delete(mod_role)<br/>&gt;&gt;&gt;&#160;db.session.commit()</p>
<p style="position:absolute;top:366px;left:108px;white-space:nowrap" class="ft8014">Note that deletions, like insertions and updates, are executed only when the database</p>
<p style="position:absolute;top:385px;left:108px;white-space:nowrap" class="ft8014">session is committed.</p>
<p style="position:absolute;top:421px;left:108px;white-space:nowrap" class="ft8065"><b>Querying Rows&#160;<br/></b>Flask-SQLAlchemy makes a&#160;query&#160;object available in each model class. The most basic</p>
<p style="position:absolute;top:476px;left:108px;white-space:nowrap" class="ft8014">query for a model is the one that returns the entire contents of the corresponding table:</p>
<p style="position:absolute;top:508px;left:133px;white-space:nowrap" class="ft8047">&gt;&gt;&gt;&#160;Role.query.all()<br/>[&lt;Role&#160;u'Administrator'&gt;,&#160;&lt;Role&#160;u'User'&gt;]<br/>&gt;&gt;&gt;&#160;User.query.all()<br/>[&lt;User&#160;u'john'&gt;,&#160;&lt;User&#160;u'susan'&gt;,&#160;&lt;User&#160;u'david'&gt;]</p>
<p style="position:absolute;top:574px;left:108px;white-space:nowrap" class="ft8014">A query object can be configured to issue more specific database searches through the</p>
<p style="position:absolute;top:594px;left:108px;white-space:nowrap" class="ft8014">use of&#160;<i>filters</i>. The following example finds all the users that were assigned the&#160;&#34;User&#34;</p>
<p style="position:absolute;top:613px;left:108px;white-space:nowrap" class="ft8014">role:</p>
<p style="position:absolute;top:644px;left:133px;white-space:nowrap" class="ft8047">&gt;&gt;&gt;&#160;User.query.filter_by(role=user_role).all()<br/>[&lt;User&#160;u'susan'&gt;,&#160;&lt;User&#160;u'david'&gt;]</p>
<p style="position:absolute;top:680px;left:108px;white-space:nowrap" class="ft8014">It is also possible to inspect the native SQL query that SQLAlchemy generates for a given</p>
<p style="position:absolute;top:699px;left:108px;white-space:nowrap" class="ft8014">query by converting the query object to a string:</p>
<p style="position:absolute;top:731px;left:134px;white-space:nowrap" class="ft8057">&gt;&gt;&gt;&#160;str(User.query.filter_by(role=user_role))<br/>'SELECT users.id AS users_id, users.username AS users_username,<br/>users.role_id&#160;AS&#160;users_role_id&#160;FROM&#160;users&#160;WHERE&#160;:param_1&#160;=&#160;users.role_id'</p>
<p style="position:absolute;top:782px;left:108px;white-space:nowrap" class="ft8014">If you exit the shell session, the objects created in the previous example will cease to</p>
<p style="position:absolute;top:801px;left:108px;white-space:nowrap" class="ft8014">exist as Python objects but will continue to exist as rows in their respective database</p>
<p style="position:absolute;top:820px;left:108px;white-space:nowrap" class="ft8014">tables. If you then start a brand new shell session, you have to re-create Python objects</p>
<p style="position:absolute;top:839px;left:108px;white-space:nowrap" class="ft8014">from their database rows. The following example issues a query that loads the user role</p>
<p style="position:absolute;top:858px;left:108px;white-space:nowrap" class="ft8014">with name&#160;&#34;User&#34;:</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft805"><b>60&#160;&#160;|&#160;&#160;Chapter 5: Databases</b></p>
</div>
<!-- Page 81 -->
<a name="81"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page81-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask081.png" alt="background image"/>
<p style="position:absolute;top:82px;left:134px;white-space:nowrap" class="ft8133">&gt;&gt;&gt;&#160;user_role&#160;=&#160;Role.query.filter_by(name='User').first()</p>
<p style="position:absolute;top:104px;left:108px;white-space:nowrap" class="ft8114">Filters such as&#160;filter_by()&#160;are invoked on a query object and return a new refined</p>
<p style="position:absolute;top:123px;left:108px;white-space:nowrap" class="ft8115">query. Multiple filters can be called in sequence until the query is configured as needed.<br/><a href="Flask.html#81">Table 5-5&#160;shows some of the most common filters a</a>vailable to queries. The complete</p>
<p style="position:absolute;top:169px;left:108px;white-space:nowrap" class="ft8148">list is in the&#160;<a href="http://docs.sqlalchemy.org">SQLAlchemy documentation.<br/></a><i>Table 5-5. Common SQLAlchemy query filters</i></p>
<p style="position:absolute;top:226px;left:113px;white-space:nowrap" class="ft8153"><b>Option</b></p>
<p style="position:absolute;top:226px;left:207px;white-space:nowrap" class="ft8153"><b>Description</b></p>
<p style="position:absolute;top:251px;left:113px;white-space:nowrap" class="ft8114">filter()</p>
<p style="position:absolute;top:248px;left:207px;white-space:nowrap" class="ft8130">Returns&#160;a&#160;new&#160;query&#160;that&#160;adds&#160;an&#160;additional&#160;filter&#160;to&#160;the&#160;original&#160;query</p>
<p style="position:absolute;top:275px;left:113px;white-space:nowrap" class="ft8114">filter_by()&#160;Returns&#160;a&#160;new&#160;query&#160;that&#160;adds&#160;an&#160;additional&#160;equality&#160;filter&#160;to&#160;the&#160;original&#160;query</p>
<p style="position:absolute;top:299px;left:113px;white-space:nowrap" class="ft8114">limit()</p>
<p style="position:absolute;top:296px;left:207px;white-space:nowrap" class="ft8130">Returns&#160;a&#160;new&#160;query&#160;that&#160;limits&#160;the&#160;number&#160;of&#160;results&#160;of&#160;the&#160;original&#160;query&#160;to&#160;the&#160;given&#160;number</p>
<p style="position:absolute;top:323px;left:113px;white-space:nowrap" class="ft8114">offset()</p>
<p style="position:absolute;top:320px;left:207px;white-space:nowrap" class="ft8130">Returns&#160;a&#160;new&#160;query&#160;that&#160;applies&#160;an&#160;offset&#160;into&#160;the&#160;list&#160;of&#160;results&#160;of&#160;the&#160;original&#160;query</p>
<p style="position:absolute;top:347px;left:113px;white-space:nowrap" class="ft8114">order_by()</p>
<p style="position:absolute;top:344px;left:207px;white-space:nowrap" class="ft8130">Returns&#160;a&#160;new&#160;query&#160;that&#160;sorts&#160;the&#160;results&#160;of&#160;the&#160;original&#160;query&#160;according&#160;to&#160;the&#160;given&#160;criteria</p>
<p style="position:absolute;top:371px;left:113px;white-space:nowrap" class="ft8114">group_by()</p>
<p style="position:absolute;top:368px;left:207px;white-space:nowrap" class="ft8130">Returns&#160;a&#160;new&#160;query&#160;that&#160;groups&#160;the&#160;results&#160;of&#160;the&#160;original&#160;query&#160;according&#160;to&#160;the&#160;given&#160;criteria</p>
<p style="position:absolute;top:405px;left:108px;white-space:nowrap" class="ft8114">After the desired filters have been applied to the query, a call to&#160;all()&#160;will cause the</p>
<p style="position:absolute;top:423px;left:108px;white-space:nowrap" class="ft8114">query to execute and return the results as a list, but there are other ways to trigger the</p>
<p style="position:absolute;top:443px;left:108px;white-space:nowrap" class="ft8148">execution of a query besides&#160;all().&#160;<a href="Flask.html#81">Table 5-6&#160;shows other quer</a>y execution methods.<br/><i>Table 5-6. Most common SQLAlchemy query executors</i></p>
<p style="position:absolute;top:500px;left:113px;white-space:nowrap" class="ft8153"><b>Option</b></p>
<p style="position:absolute;top:500px;left:229px;white-space:nowrap" class="ft8153"><b>Description</b></p>
<p style="position:absolute;top:524px;left:113px;white-space:nowrap" class="ft8114">all()</p>
<p style="position:absolute;top:522px;left:229px;white-space:nowrap" class="ft8130">Returns&#160;all&#160;the&#160;results&#160;of&#160;a&#160;query&#160;as&#160;a&#160;list</p>
<p style="position:absolute;top:548px;left:113px;white-space:nowrap" class="ft8114">first()</p>
<p style="position:absolute;top:548px;left:229px;white-space:nowrap" class="ft8130">Returns&#160;the&#160;first&#160;result&#160;of&#160;a&#160;query,&#160;or&#160;None&#160;if&#160;there&#160;are&#160;no&#160;results</p>
<p style="position:absolute;top:573px;left:113px;white-space:nowrap" class="ft8114">first_or_404()&#160;Returns&#160;the&#160;first&#160;result&#160;of&#160;a&#160;query,&#160;or&#160;aborts&#160;the&#160;request&#160;and&#160;sends&#160;a&#160;404&#160;error&#160;as&#160;response&#160;if&#160;there</p>
<p style="position:absolute;top:586px;left:229px;white-space:nowrap" class="ft8130">are&#160;no&#160;results</p>
<p style="position:absolute;top:610px;left:113px;white-space:nowrap" class="ft8114">get()</p>
<p style="position:absolute;top:610px;left:229px;white-space:nowrap" class="ft8130">Returns&#160;the&#160;row&#160;that&#160;matches&#160;the&#160;given&#160;primary&#160;key,&#160;or&#160;None&#160;if&#160;no&#160;matching&#160;row&#160;is&#160;found</p>
<p style="position:absolute;top:634px;left:113px;white-space:nowrap" class="ft8114">get_or_404()</p>
<p style="position:absolute;top:632px;left:229px;white-space:nowrap" class="ft8155">Returns&#160;the&#160;row&#160;that&#160;matches&#160;the&#160;given&#160;primary&#160;key.&#160;If&#160;the&#160;key&#160;is&#160;not&#160;found&#160;it&#160;aborts&#160;the&#160;request&#160;and<br/>sends&#160;a&#160;404&#160;error&#160;as&#160;response</p>
<p style="position:absolute;top:672px;left:113px;white-space:nowrap" class="ft8114">count()</p>
<p style="position:absolute;top:670px;left:229px;white-space:nowrap" class="ft8130">Returns&#160;the&#160;result&#160;count&#160;of&#160;the&#160;query</p>
<p style="position:absolute;top:696px;left:113px;white-space:nowrap" class="ft8114">paginate()</p>
<p style="position:absolute;top:696px;left:229px;white-space:nowrap" class="ft8130">Returns&#160;a&#160;Pagination&#160;object&#160;that&#160;contains&#160;the&#160;specified&#160;range&#160;of&#160;results</p>
<p style="position:absolute;top:729px;left:108px;white-space:nowrap" class="ft8114">Relationships work similarly to queries. The following example queries the one-to-</p>
<p style="position:absolute;top:748px;left:108px;white-space:nowrap" class="ft8114">many relationship between roles and users from both ends:</p>
<p style="position:absolute;top:780px;left:134px;white-space:nowrap" class="ft8140">&gt;&gt;&gt;&#160;users&#160;=&#160;user_role.users<br/>&gt;&gt;&gt;&#160;users<br/>[&lt;User&#160;u'susan'&gt;,&#160;&lt;User&#160;u'david'&gt;]<br/>&gt;&gt;&gt;&#160;users[0].role<br/>&lt;Role&#160;u'User'&gt;</p>
<p style="position:absolute;top:915px;left:515px;white-space:nowrap" class="ft815"><b>Database Operations&#160;&#160;|&#160;&#160;61</b></p>
</div>
<!-- Page 82 -->
<a name="82"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page82-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask082.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft8214">The&#160;user_role.users&#160;query here has a small problem. The implicit query that runs</p>
<p style="position:absolute;top:99px;left:108px;white-space:nowrap" class="ft8214">when the&#160;user_role.users&#160;expression is issued internally calls&#160;all()&#160;to return the list</p>
<p style="position:absolute;top:118px;left:108px;white-space:nowrap" class="ft8214">of users. Because the query object is hidden, it is not possible to refine it with additional</p>
<p style="position:absolute;top:137px;left:108px;white-space:nowrap" class="ft8214">query filters. In this particular example, it may have been useful to request that the user</p>
<p style="position:absolute;top:156px;left:108px;white-space:nowrap" class="ft8214">list be returned in alphabetical order. In&#160;<a href="Flask.html#82">Example 5-4</a>, the configuration of the relation‐</p>
<p style="position:absolute;top:176px;left:108px;white-space:nowrap" class="ft8214">ship is modified with a&#160;lazy = 'dynamic'&#160;argument to request that the query is not</p>
<p style="position:absolute;top:195px;left:108px;white-space:nowrap" class="ft8214">automatically executed.</p>
<p style="position:absolute;top:226px;left:108px;white-space:nowrap" class="ft8247"><i>Example 5-4. app/models.py: Dynamic relationships<br/></i><b>class</b>&#160;<b>Role</b>(db.Model):<br/>&#160; &#160;&#160;<i># ...<br/></i>&#160; &#160;&#160;users&#160;=&#160;db.relationship('User',&#160;backref='role',&#160;lazy='dynamic')<br/>&#160; &#160;&#160;<i># ...</i></p>
<p style="position:absolute;top:328px;left:108px;white-space:nowrap" class="ft8214">With the relationship configured in this way,&#160;user_role.users&#160;returns a query that</p>
<p style="position:absolute;top:346px;left:108px;white-space:nowrap" class="ft8214">hasn’t executed yet, so filters can be added to it:</p>
<p style="position:absolute;top:378px;left:134px;white-space:nowrap" class="ft8247">&gt;&gt;&gt;&#160;user_role.users.order_by(User.username).all()<br/>[&lt;User&#160;u'david'&gt;,&#160;&lt;User&#160;u'susan'&gt;]<br/>&gt;&gt;&gt;&#160;user_role.users.count()<br/>2</p>
<p style="position:absolute;top:453px;left:108px;white-space:nowrap" class="ft8218"><b>Database Use in View Functions<br/></b>The database operations described in the previous sections can be used directly inside</p>
<p style="position:absolute;top:512px;left:108px;white-space:nowrap" class="ft8214">view functions.&#160;<a href="Flask.html#82">Example 5-5&#160;</a>shows a new version of the home page route that records</p>
<p style="position:absolute;top:531px;left:108px;white-space:nowrap" class="ft8214">names entered by users in the database.</p>
<p style="position:absolute;top:563px;left:108px;white-space:nowrap" class="ft8247"><i>Example 5-5. hello.py: Database use in view functions<br/></i>@app.route('/',&#160;methods=['GET',&#160;'POST'])<br/><b>def</b>&#160;index():<br/>&#160; &#160;&#160;form&#160;=&#160;NameForm()<br/>&#160; &#160;&#160;<b>if</b>&#160;form.validate_on_submit():<br/>&#160; &#160; &#160; &#160;&#160;user&#160;=&#160;User.query.filter_by(username=form.name.data).first()<br/>&#160; &#160; &#160; &#160;&#160;<b>if</b>&#160;user&#160;<b>is</b>&#160;None:<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;user&#160;=&#160;User(username&#160;=&#160;form.name.data)<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;db.session.add(user)<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;session['known']&#160;=&#160;False<br/>&#160; &#160; &#160; &#160;&#160;<b>else</b>:<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;session['known']&#160;=&#160;True<br/>&#160; &#160; &#160; &#160;&#160;session['name']&#160;=&#160;form.name.data<br/>&#160; &#160; &#160; &#160;&#160;form.name.data&#160;=&#160;''<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;redirect(url_for('index'))<br/>&#160; &#160;&#160;<b>return</b>&#160;render_template('index.html',<br/>&#160; &#160; &#160; &#160;&#160;form&#160;=&#160;form,&#160;name&#160;=&#160;session.get('name'),<br/>&#160; &#160; &#160; &#160;&#160;known&#160;=&#160;session.get('known',&#160;False))</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft825"><b>62&#160;&#160;|&#160;&#160;Chapter 5: Databases</b></p>
</div>
<!-- Page 83 -->
<a name="83"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page83-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask083.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft8314">In this modified version of the application, each time a name is submitted the application</p>
<p style="position:absolute;top:98px;left:108px;white-space:nowrap" class="ft8314">checks for it in the database using the&#160;filter_by()&#160;query filter. A&#160;known&#160;variable is</p>
<p style="position:absolute;top:117px;left:108px;white-space:nowrap" class="ft8314">written to the user session so that after the redirect the information can be sent to the</p>
<p style="position:absolute;top:136px;left:108px;white-space:nowrap" class="ft8314">template, where it is used to customize the greeting. Note that for the application to</p>
<p style="position:absolute;top:155px;left:108px;white-space:nowrap" class="ft8315">work, the database tables must be created in a Python shell as shown earlier.<br/>The new version of the associated template is shown in&#160;<a href="Flask.html#83">Example 5-6. This tem</a>plate uses</p>
<p style="position:absolute;top:203px;left:108px;white-space:nowrap" class="ft8314">the&#160;known&#160;argument to add a second line to the greeting that is different for known and</p>
<p style="position:absolute;top:222px;left:108px;white-space:nowrap" class="ft8314">new users.</p>
<p style="position:absolute;top:253px;left:108px;white-space:nowrap" class="ft8323"><i>Example 5-6. templates/index.html<br/></i>{% extends &#34;base.html&#34; %}<br/>{% import &#34;bootstrap/wtf.html&#34; as wtf %}</p>
<p style="position:absolute;top:327px;left:108px;white-space:nowrap" class="ft833">{% block title %}Flasky{% endblock %}</p>
<p style="position:absolute;top:358px;left:108px;white-space:nowrap" class="ft8323">{% block page_content %}<br/><b>&lt;div</b>&#160;class=&#34;page-header&#34;<b>&gt;<br/></b>&#160; &#160;&#160;<b>&lt;h1&gt;</b>Hello, {% if name %}{{ name }}{% else %}Stranger{% endif %}!<b>&lt;/h1&gt;<br/></b>&#160; &#160; {% if not known %}<br/>&#160; &#160;&#160;<b>&lt;p&gt;</b>Pleased to meet you!<b>&lt;/p&gt;<br/></b>&#160; &#160; {% else %}<br/>&#160; &#160;&#160;<b>&lt;p&gt;</b>Happy to see you again!<b>&lt;/p&gt;<br/></b>&#160; &#160; {% endif %}<br/><b>&lt;/div&gt;<br/></b>{{ wtf.quick_form(form) }}<br/>{% endblock %}</p>
<p style="position:absolute;top:545px;left:198px;white-space:nowrap" class="ft8325">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:563px;left:198px;white-space:nowrap" class="ft8325">run&#160;git&#160;checkout&#160;5b&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:648px;left:108px;white-space:nowrap" class="ft8322"><b>Integration with the Python Shell&#160;<br/></b>Having to import the database instance and the models each time a shell session is started</p>
<p style="position:absolute;top:709px;left:108px;white-space:nowrap" class="ft8314">is tedious work. To avoid having to constantly repeat these imports, the Flask-Script’s</p>
<p style="position:absolute;top:727px;left:108px;white-space:nowrap" class="ft8346">shell command can be configured to automatically import certain objects.<br/>To add objects to the import list the shell command needs to be registered with a<br/>make_context</p>
<p style="position:absolute;top:775px;left:198px;white-space:nowrap" class="ft8314"><a href="Flask.html#83">&#160;callback function. This is shown in&#160;Example 5-7</a>.</p>
<p style="position:absolute;top:807px;left:108px;white-space:nowrap" class="ft8350"><i>Example 5-7. hello.py: Adding a shell context<br/></i><b>from</b>&#160;<b>flask.ext.script</b>&#160;<b>import</b>&#160;Shell</p>
<p style="position:absolute;top:865px;left:108px;white-space:nowrap" class="ft8338"><b>def</b>&#160;make_shell_context():</p>
<p style="position:absolute;top:915px;left:456px;white-space:nowrap" class="ft835"><b>Integration with the Python Shell &#160;&#160;|&#160;&#160;63</b></p>
</div>
<!-- Page 84 -->
<a name="84"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page84-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask084.png" alt="background image"/>
<p style="position:absolute;top:82px;left:108px;white-space:nowrap" class="ft8447">&#160; &#160;&#160;<b>return</b>&#160;dict(app=app,&#160;db=db,&#160;User=User,&#160;Role=Role)<br/>manager.add_command(&#34;shell&#34;,&#160;Shell(make_context=make_shell_context))</p>
<p style="position:absolute;top:125px;left:108px;white-space:nowrap" class="ft8414">The&#160;make_shell_context()&#160;function registers the application and database instances</p>
<p style="position:absolute;top:144px;left:108px;white-space:nowrap" class="ft8414">and the models so that they are automatically imported into the shell:</p>
<p style="position:absolute;top:176px;left:134px;white-space:nowrap" class="ft8440">$&#160;python&#160;hello.py&#160;shell<br/>&gt;&gt;&gt;&#160;app<br/>&lt;Flask&#160;'app'&gt;<br/>&gt;&gt;&gt;&#160;db<br/>&lt;SQLAlchemy&#160;engine='sqlite:////home/flask/flasky/data.sqlite'&gt;<br/>&gt;&gt;&gt;&#160;User<br/>&lt;<b>class</b>&#160;'<b>app</b>.User'&gt;</p>
<p style="position:absolute;top:302px;left:198px;white-space:nowrap" class="ft8425">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:320px;left:198px;white-space:nowrap" class="ft8425">run&#160;git&#160;checkout&#160;5c&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:405px;left:108px;white-space:nowrap" class="ft8422"><b>Database Migrations with Flask-Migrate&#160;<br/></b>As you make progress developing an application, you will find that your database models</p>
<p style="position:absolute;top:465px;left:108px;white-space:nowrap" class="ft8415">need to change, and when that happens the database needs to be updated as well.<br/>Flask-SQLAlchemy creates database tables from models only when they do not exist</p>
<p style="position:absolute;top:512px;left:108px;white-space:nowrap" class="ft8414">already, so the only way to make it update tables is by destroying the old tables first, but</p>
<p style="position:absolute;top:531px;left:108px;white-space:nowrap" class="ft8415">of course this causes all the data in the database to be lost.<br/>A better solution is to use a&#160;<i>database migration</i>&#160;framework. In the same way source code</p>
<p style="position:absolute;top:578px;left:108px;white-space:nowrap" class="ft8414">version control tools keep track of changes to source code files, a database migration</p>
<p style="position:absolute;top:597px;left:108px;white-space:nowrap" class="ft8414">framework keeps track of changes to a database&#160;<i>schema</i>, and then incremental changes</p>
<p style="position:absolute;top:616px;left:108px;white-space:nowrap" class="ft8415">can be applied to the database.<br/>The lead developer of SQLAlchemy has written a migration framework called&#160;<a href="http://bit.ly/alembic-doc">Alem‐</a></p>
<p style="position:absolute;top:662px;left:108px;white-space:nowrap" class="ft8417"><a href="http://bit.ly/alembic-doc">bic, but instead of using Alembic directly</a>, Flask applications can use the&#160;<a href="http://bit.ly/fl-migrate">Flask-</a></p>
<p style="position:absolute;top:681px;left:108px;white-space:nowrap" class="ft8417"><a href="http://bit.ly/fl-migrate">Migrate&#160;</a>extension, a lightweight Alembic wrapper that integrates with Flask-Script to</p>
<p style="position:absolute;top:700px;left:108px;white-space:nowrap" class="ft8414">provide all operations through Flask-Script commands.</p>
<p style="position:absolute;top:737px;left:108px;white-space:nowrap" class="ft8452"><b>Creating a Migration Repository&#160;<br/></b>To begin, Flask-Migrate must be installed in the virtual environment:</p>
<p style="position:absolute;top:803px;left:134px;white-space:nowrap" class="ft8433">(venv)&#160;$&#160;pip install flask-migrate</p>
<p style="position:absolute;top:824px;left:108px;white-space:nowrap" class="ft8417"><a href="Flask.html#84">Example 5-8</a>&#160;shows how the extension is initialized.</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft845"><b>64&#160;&#160;|&#160;&#160;Chapter 5: Databases</b></p>
</div>
<!-- Page 85 -->
<a name="85"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page85-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask085.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft8550"><i>Example 5-8. hello.py: Flask-Migrate configuration<br/></i><b>from</b>&#160;<b>flask.ext.migrate</b>&#160;<b>import</b>&#160;Migrate,&#160;MigrateCommand</p>
<p style="position:absolute;top:138px;left:108px;white-space:nowrap" class="ft8562"><i># ...</i></p>
<p style="position:absolute;top:168px;left:108px;white-space:nowrap" class="ft8547">migrate&#160;=&#160;Migrate(app,&#160;db)<br/>manager.add_command('db',&#160;MigrateCommand)</p>
<p style="position:absolute;top:211px;left:108px;white-space:nowrap" class="ft8514">To expose the database migration commands, Flask-Migrate exposes a&#160;MigrateCommand</p>
<p style="position:absolute;top:231px;left:108px;white-space:nowrap" class="ft8514">class that is attached to Flask-Script’s&#160;manager&#160;object. In this example the command is</p>
<p style="position:absolute;top:251px;left:108px;white-space:nowrap" class="ft8515">attached using&#160;db.<br/>Before database migrations can be maintained, it is necessary to create a migration</p>
<p style="position:absolute;top:298px;left:108px;white-space:nowrap" class="ft8514">repository with the&#160;init&#160;subcommand:</p>
<p style="position:absolute;top:330px;left:133px;white-space:nowrap" class="ft8547">(venv) $ python hello.py db init<br/>&#160; Creating directory /home/flask/flasky/migrations...done<br/>&#160; Creating directory /home/flask/flasky/migrations/versions...done<br/>&#160; Generating /home/flask/flasky/migrations/alembic.ini...done<br/>&#160; Generating /home/flask/flasky/migrations/env.py...done<br/>&#160; Generating /home/flask/flasky/migrations/env.pyc...done<br/>&#160; Generating /home/flask/flasky/migrations/README...done<br/>&#160; Generating /home/flask/flasky/migrations/script.py.mako...done<br/>&#160; Please edit configuration/connection/logging settings in<br/>&#160; '/home/flask/flasky/migrations/alembic.ini' before proceeding.</p>
<p style="position:absolute;top:488px;left:108px;white-space:nowrap" class="ft8514">This command creates a&#160;<i>migrations</i>&#160;folder, where all the migration scripts will be stored.</p>
<p style="position:absolute;top:530px;left:198px;white-space:nowrap" class="ft8525">The&#160;files&#160;in&#160;a&#160;database&#160;migration&#160;repository&#160;must&#160;always&#160;be&#160;added&#160;to</p>
<p style="position:absolute;top:547px;left:198px;white-space:nowrap" class="ft8525">version&#160;control&#160;along&#160;with&#160;the&#160;rest&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:633px;left:108px;white-space:nowrap" class="ft8558"><b>Creating a Migration Script<br/></b>In Alembic, a database migration is represented by a&#160;<i>migration script</i>. This script has</p>
<p style="position:absolute;top:687px;left:108px;white-space:nowrap" class="ft8514">two functions called&#160;upgrade()&#160;and&#160;downgrade(). The&#160;upgrade()&#160;function applies the</p>
<p style="position:absolute;top:707px;left:108px;white-space:nowrap" class="ft8514">database changes that are part of the migration, and the&#160;downgrade()&#160;function removes</p>
<p style="position:absolute;top:725px;left:108px;white-space:nowrap" class="ft8514">them. By having the ability to add and remove the changes, Alembic can reconfigure a</p>
<p style="position:absolute;top:744px;left:108px;white-space:nowrap" class="ft8546">database to any point in the change history.<br/>Alembic migrations can be created manually or automatically using the&#160;revision&#160;and<br/>migrate</p>
<p style="position:absolute;top:793px;left:160px;white-space:nowrap" class="ft8514">&#160;commands, respectively. A manual migration creates a migration skeleton</p>
<p style="position:absolute;top:813px;left:108px;white-space:nowrap" class="ft8514">script with empty&#160;upgrade()&#160;and&#160;downgrade()&#160;functions that need to be implemented</p>
<p style="position:absolute;top:833px;left:108px;white-space:nowrap" class="ft8514">by the developer using directives exposed by Alembic’s&#160;Operations&#160;object. An auto‐</p>
<p style="position:absolute;top:853px;left:108px;white-space:nowrap" class="ft8514">matic migration, on the other hand, generates the code for the&#160;upgrade()&#160;and</p>
<p style="position:absolute;top:915px;left:427px;white-space:nowrap" class="ft855"><b>Database Migrations with Flask-Migrate &#160;&#160;|&#160;&#160;65</b></p>
</div>
<!-- Page 86 -->
<a name="86"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page86-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask086.png" alt="background image"/>
<p style="position:absolute;top:83px;left:108px;white-space:nowrap" class="ft8614">downgrade()</p>
<p style="position:absolute;top:79px;left:191px;white-space:nowrap" class="ft8614">&#160;functions by looking for differences between the model definitions and</p>
<p style="position:absolute;top:98px;left:108px;white-space:nowrap" class="ft8614">the current state of the database.</p>
<p style="position:absolute;top:138px;left:204px;white-space:nowrap" class="ft8625">Automatic&#160;migrations&#160;are&#160;not&#160;always&#160;accurate&#160;and&#160;can&#160;miss&#160;some</p>
<p style="position:absolute;top:155px;left:204px;white-space:nowrap" class="ft8625">details.&#160;Migration&#160;scripts&#160;generated&#160;automatically&#160;should&#160;always&#160;be</p>
<p style="position:absolute;top:172px;left:204px;white-space:nowrap" class="ft8625">reviewed.</p>
<p style="position:absolute;top:239px;left:108px;white-space:nowrap" class="ft8614">The&#160;migrate&#160;subcommand creates an automatic migration script:</p>
<p style="position:absolute;top:271px;left:133px;white-space:nowrap" class="ft8623">(venv)&#160;$&#160;python hello.py db migrate -m&#160;&#34;initial migration&#34;<br/>INFO &#160;[alembic.migration]&#160;Context impl SQLiteImpl.<br/>INFO &#160;[alembic.migration]&#160;Will assume non-transactional DDL.<br/>INFO &#160;[alembic.autogenerate]&#160;Detected added table&#160;'roles'<br/>INFO &#160;[alembic.autogenerate]&#160;Detected added table&#160;'users'<br/>INFO &#160;[alembic.autogenerate.compare]&#160;Detected added index<br/>'ix_users_username'&#160;on&#160;'['username']'<br/>&#160; Generating /home/flask/flasky/migrations/versions/1bc<br/>&#160; 594146bb5_initial_migration.py...done</p>
<p style="position:absolute;top:428px;left:198px;white-space:nowrap" class="ft8625">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:446px;left:198px;white-space:nowrap" class="ft8625">run&#160;git&#160;checkout&#160;5d&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:463px;left:198px;white-space:nowrap" class="ft8625">Note&#160;that&#160;you&#160;do&#160;not&#160;need&#160;to&#160;generate&#160;the&#160;migrations&#160;for&#160;this&#160;appli‐</p>
<p style="position:absolute;top:480px;left:198px;white-space:nowrap" class="ft8625">cation&#160;as&#160;all&#160;the&#160;migration&#160;scripts&#160;are&#160;included&#160;in&#160;the&#160;repository.</p>
<p style="position:absolute;top:531px;left:108px;white-space:nowrap" class="ft8658"><b>Upgrading the Database<br/></b>Once a migration script has been reviewed and accepted, it can be applied to the database</p>
<p style="position:absolute;top:584px;left:108px;white-space:nowrap" class="ft8614">using the&#160;db upgrade&#160;command:</p>
<p style="position:absolute;top:616px;left:134px;white-space:nowrap" class="ft8623">(venv)&#160;$&#160;python hello.py db upgrade<br/>INFO &#160;[alembic.migration]&#160;Context impl SQLiteImpl.<br/>INFO &#160;[alembic.migration]&#160;Will assume non-transactional DDL.<br/>INFO &#160;[alembic.migration]&#160;Running upgrade None -&gt; 1bc594146bb5, initial migration</p>
<p style="position:absolute;top:683px;left:108px;white-space:nowrap" class="ft8614">For a first migration, this is effectively equivalent to calling&#160;db.create_all(), but in</p>
<p style="position:absolute;top:703px;left:108px;white-space:nowrap" class="ft8614">successive migrations the&#160;upgrade&#160;command applies updates to the tables without af‐</p>
<p style="position:absolute;top:722px;left:108px;white-space:nowrap" class="ft8614">fecting their contents.</p>
<p style="position:absolute;top:764px;left:198px;white-space:nowrap" class="ft8625">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;delete</p>
<p style="position:absolute;top:782px;left:198px;white-space:nowrap" class="ft8625">your&#160;<i>data.sqlite</i>&#160;database&#160;file&#160;and&#160;then&#160;run&#160;Flask-Migrate’s&#160;upgrade</p>
<p style="position:absolute;top:799px;left:198px;white-space:nowrap" class="ft8625">command&#160;to&#160;regenerate&#160;the&#160;database&#160;through&#160;the&#160;migration&#160;frame‐</p>
<p style="position:absolute;top:816px;left:198px;white-space:nowrap" class="ft8625">work.</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft865"><b>66&#160;&#160;|&#160;&#160;Chapter 5: Databases</b></p>
</div>
<!-- Page 87 -->
<a name="87"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page87-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask087.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft8714">The topic of database design and usage is very important; entire books have been written</p>
<p style="position:absolute;top:97px;left:108px;white-space:nowrap" class="ft8714">on the subject. You should consider this chapter as an overview; more advanced topics</p>
<p style="position:absolute;top:116px;left:108px;white-space:nowrap" class="ft8714">will be discussed in later chapters. The next chapter is dedicated to sending email.</p>
<p style="position:absolute;top:915px;left:427px;white-space:nowrap" class="ft875"><b>Database Migrations with Flask-Migrate &#160;&#160;|&#160;&#160;67</b></p>
</div>
<!-- Page 88 -->
<a name="88"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page88-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask088.png" alt="background image"/>
</div>
<!-- Page 89 -->
<a name="89"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page89-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask089.png" alt="background image"/>
<p style="position:absolute;top:104px;left:559px;white-space:nowrap" class="ft8928"><b>CHAPTER 6</b></p>
<p style="position:absolute;top:131px;left:579px;white-space:nowrap" class="ft8911"><b>Email</b></p>
<p style="position:absolute;top:345px;left:108px;white-space:nowrap" class="ft8914">Many types of applications need to notify users when certain events occur, and the usual</p>
<p style="position:absolute;top:364px;left:108px;white-space:nowrap" class="ft8914">method of communication is email. Although the&#160;<i>smtplib</i>&#160;package from the Python</p>
<p style="position:absolute;top:383px;left:108px;white-space:nowrap" class="ft8914">standard library can be used to send email inside a Flask application, the Flask-Mail</p>
<p style="position:absolute;top:402px;left:108px;white-space:nowrap" class="ft8914">extension wraps smtplib and integrates it nicely with Flask.</p>
<p style="position:absolute;top:439px;left:108px;white-space:nowrap" class="ft8922"><b>Email Support with Flask-Mail&#160;<br/></b>Flask-Mail is installed with pip:</p>
<p style="position:absolute;top:512px;left:134px;white-space:nowrap" class="ft8933">(venv)&#160;$&#160;pip install flask-mail</p>
<p style="position:absolute;top:533px;left:108px;white-space:nowrap" class="ft8914">The extension connects to a Simple Mail Transfer Protocol (SMTP) server and passes</p>
<p style="position:absolute;top:552px;left:108px;white-space:nowrap" class="ft8914">emails to it for delivery. If no configuration is given, Flask-Mail connects to&#160;<i>localhost</i>&#160;at</p>
<p style="position:absolute;top:571px;left:108px;white-space:nowrap" class="ft8914">port 25 and sends email without authentication.&#160;<a href="Flask.html#89">Table 6-1&#160;shows the list of configura</a>tion</p>
<p style="position:absolute;top:590px;left:108px;white-space:nowrap" class="ft8948">keys that can be used to configure the SMTP server.<br/><i>Table 6-1. Flask-Mail SMTP server configuration keys</i></p>
<p style="position:absolute;top:646px;left:113px;white-space:nowrap" class="ft8953"><b>Key</b></p>
<p style="position:absolute;top:646px;left:222px;white-space:nowrap" class="ft8953"><b>Default&#160;Description</b></p>
<p style="position:absolute;top:671px;left:113px;white-space:nowrap" class="ft8914">MAIL_HOSTNAME&#160;<i>localhost&#160;</i>Hostname&#160;or&#160;IP&#160;address&#160;of&#160;the&#160;email&#160;server</p>
<p style="position:absolute;top:695px;left:113px;white-space:nowrap" class="ft8914">MAIL_PORT</p>
<p style="position:absolute;top:692px;left:222px;white-space:nowrap" class="ft8930">25</p>
<p style="position:absolute;top:692px;left:270px;white-space:nowrap" class="ft8930">Port&#160;of&#160;the&#160;email&#160;server</p>
<p style="position:absolute;top:719px;left:113px;white-space:nowrap" class="ft8914">MAIL_USE_TLS</p>
<p style="position:absolute;top:719px;left:222px;white-space:nowrap" class="ft8914">False&#160;Enable&#160;Transport&#160;Layer&#160;Security&#160;(TLS)&#160;security</p>
<p style="position:absolute;top:743px;left:113px;white-space:nowrap" class="ft8914">MAIL_USE_SSL</p>
<p style="position:absolute;top:743px;left:222px;white-space:nowrap" class="ft8914">False&#160;Enable&#160;Secure&#160;Sockets&#160;Layer&#160;(SSL)&#160;security</p>
<p style="position:absolute;top:767px;left:113px;white-space:nowrap" class="ft8914">MAIL_USERNAME&#160;None</p>
<p style="position:absolute;top:764px;left:270px;white-space:nowrap" class="ft8930">Mail&#160;account&#160;username</p>
<p style="position:absolute;top:791px;left:113px;white-space:nowrap" class="ft8914">MAIL_PASSWORD&#160;None</p>
<p style="position:absolute;top:788px;left:270px;white-space:nowrap" class="ft8930">Mail&#160;account&#160;password</p>
<p style="position:absolute;top:824px;left:108px;white-space:nowrap" class="ft8914">During development it may be more convenient to connect to an external SMTP server.</p>
<p style="position:absolute;top:843px;left:108px;white-space:nowrap" class="ft8914">As an exam<a href="Flask.html#90">ple,&#160;Example 6-1</a>&#160;shows how to configure the application to send email</p>
<p style="position:absolute;top:862px;left:108px;white-space:nowrap" class="ft8914">through a Google Gmail account.</p>
<p style="position:absolute;top:915px;left:637px;white-space:nowrap" class="ft895"><b>69</b></p>
</div>
<!-- Page 90 -->
<a name="90"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page90-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask090.png" alt="background image"/>
<p style="position:absolute;top:94px;left:108px;white-space:nowrap" class="ft9047"><i>Example 6-1. hello.py: Flask-Mail configuration for Gmail<br/></i><b>import</b>&#160;<b>os<br/></b><i># ...<br/></i>app.config['MAIL_SERVER']&#160;=&#160;'smtp.googlemail.com'<br/>app.config['MAIL_PORT']&#160;=&#160;587<br/>app.config['MAIL_USE_TLS']&#160;=&#160;True<br/>app.config['MAIL_USERNAME']&#160;=&#160;os.environ.get('MAIL_USERNAME')<br/>app.config['MAIL_PASSWORD']&#160;=&#160;os.environ.get('MAIL_PASSWORD')</p>
<p style="position:absolute;top:248px;left:198px;white-space:nowrap" class="ft9025">Never&#160;write&#160;account&#160;credentials&#160;directly&#160;in&#160;your&#160;scripts,&#160;particularly</p>
<p style="position:absolute;top:265px;left:198px;white-space:nowrap" class="ft9025">if&#160;you&#160;plan&#160;to&#160;release&#160;your&#160;work&#160;as&#160;open&#160;source.&#160;To&#160;protect&#160;your</p>
<p style="position:absolute;top:283px;left:198px;white-space:nowrap" class="ft9025">account&#160;information,&#160;have&#160;your&#160;script&#160;import&#160;sensitive&#160;information</p>
<p style="position:absolute;top:300px;left:198px;white-space:nowrap" class="ft9025">from&#160;the&#160;environment.</p>
<p style="position:absolute;top:354px;left:108px;white-space:nowrap" class="ft9014">Flask-Mail is initialized as shown in&#160;<a href="Flask.html#90">Example 6-2.</a></p>
<p style="position:absolute;top:386px;left:108px;white-space:nowrap" class="ft9040"><i>Example 6-2. hello.py: Flask-Mail initialization<br/></i><b>from</b>&#160;<b>flask.ext.mail</b>&#160;<b>import</b>&#160;Mail<br/>mail&#160;=&#160;Mail(app)</p>
<p style="position:absolute;top:456px;left:108px;white-space:nowrap" class="ft9014">The two environment variables that hold the email server username and password need</p>
<p style="position:absolute;top:475px;left:108px;white-space:nowrap" class="ft9014">to be defined in the environment. If you are on Linux or Mac OS X using bash, you can</p>
<p style="position:absolute;top:494px;left:108px;white-space:nowrap" class="ft9014">set these variables as follows:</p>
<p style="position:absolute;top:525px;left:133px;white-space:nowrap" class="ft9023">(venv)&#160;$&#160;export&#160;MAIL_USERNAME=&lt;Gmail username&gt;<br/>(venv)&#160;$&#160;export&#160;MAIL_PASSWORD=&lt;Gmail password&gt;</p>
<p style="position:absolute;top:561px;left:108px;white-space:nowrap" class="ft9014">For Microsoft Windows users, the environment variables are set as follows:</p>
<p style="position:absolute;top:593px;left:134px;white-space:nowrap" class="ft9023">(venv)&#160;$&#160;set&#160;MAIL_USERNAME=&lt;Gmail username&gt;<br/>(venv)&#160;$&#160;set&#160;MAIL_PASSWORD=&lt;Gmail password&gt;</p>
<p style="position:absolute;top:636px;left:108px;white-space:nowrap" class="ft9058"><b>Sending Email from the Python Shell<br/></b>To test the configuration, you can start a shell session and send a test email:</p>
<p style="position:absolute;top:702px;left:133px;white-space:nowrap" class="ft9047">(venv)&#160;$&#160;python&#160;hello.py&#160;shell<br/>&gt;&gt;&gt;&#160;<b>from</b>&#160;<b>flask.ext.mail</b>&#160;<b>import</b>&#160;Message<br/>&gt;&gt;&gt;&#160;<b>from</b>&#160;<b>hello</b>&#160;<b>import</b>&#160;mail<br/>&gt;&gt;&gt;&#160;msg&#160;=&#160;Message('test subject',&#160;sender='you@example.com',<br/>...&#160; &#160; &#160;recipients=['you@example.com'])<br/>&gt;&gt;&gt;&#160;msg.body&#160;=&#160;'text body'<br/>&gt;&gt;&gt;&#160;msg.html&#160;=&#160;'&lt;b&gt;HTML&lt;/b&gt; body'<br/>&gt;&gt;&gt;&#160;<b>with</b>&#160;app.app_context():<br/>...&#160; &#160;&#160;mail.send(msg)<br/>...</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft905"><b>70&#160;&#160;|&#160;&#160;Chapter 6: Email</b></p>
</div>
<!-- Page 91 -->
<a name="91"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page91-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask091.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft9114">Note that Flask-Mail’s&#160;send()&#160;function uses&#160;current_app, so it needs to be executed</p>
<p style="position:absolute;top:98px;left:108px;white-space:nowrap" class="ft9114">with an activated application context.</p>
<p style="position:absolute;top:134px;left:108px;white-space:nowrap" class="ft9158"><b>Integrating Emails with the Application<br/></b>To avoid having to create email messages manually every time, it is a good idea to abstract</p>
<p style="position:absolute;top:186px;left:108px;white-space:nowrap" class="ft9114">the common parts of the application’s email sending functionality into a function. As</p>
<p style="position:absolute;top:205px;left:108px;white-space:nowrap" class="ft9114">an added benefit, this function can render email bodies from Jinja2 templates to have</p>
<p style="position:absolute;top:224px;left:108px;white-space:nowrap" class="ft9114">the most flexibility. The implementation is shown in&#160;<a href="Flask.html#91">Example 6-3</a>.</p>
<p style="position:absolute;top:256px;left:108px;white-space:nowrap" class="ft9150"><i>Example 6-3. hello.py: Email support<br/></i><b>from</b>&#160;<b>flask.ext.mail</b>&#160;<b>import</b>&#160;Message</p>
<p style="position:absolute;top:314px;left:108px;white-space:nowrap" class="ft9157">app.config['FLASKY_MAIL_SUBJECT_PREFIX']&#160;=&#160;'[Flasky]'<br/>app.config['FLASKY_MAIL_SENDER']&#160;=&#160;'Flasky Admin &lt;flasky@example.com&gt;'</p>
<p style="position:absolute;top:360px;left:108px;white-space:nowrap" class="ft9147"><b>def</b>&#160;send_email(to,&#160;subject,&#160;template,&#160;**kwargs):<br/>&#160; &#160;&#160;msg&#160;=&#160;Message(app.config['FLASKY_MAIL_SUBJECT_PREFIX']&#160;+&#160;subject,<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;sender=app.config['FLASKY_MAIL_SENDER'],&#160;recipients=[to])<br/>&#160; &#160;&#160;msg.body&#160;=&#160;render_template(template&#160;+&#160;'.txt',&#160;**kwargs)<br/>&#160; &#160;&#160;msg.html&#160;=&#160;render_template(template&#160;+&#160;'.html',&#160;**kwargs)<br/>&#160; &#160;&#160;mail.send(msg)</p>
<p style="position:absolute;top:463px;left:108px;white-space:nowrap" class="ft9114">The function relies on two application-specific configuration keys that define a prefix</p>
<p style="position:absolute;top:483px;left:108px;white-space:nowrap" class="ft9114">string for the subject and the address that will be used as sender. The&#160;send_email</p>
<p style="position:absolute;top:502px;left:108px;white-space:nowrap" class="ft9114">function takes the destination address, a subject line, a template for the email body, and</p>
<p style="position:absolute;top:521px;left:108px;white-space:nowrap" class="ft9114">a list of keyword arguments. The template name must be given without the extension,</p>
<p style="position:absolute;top:540px;left:108px;white-space:nowrap" class="ft9114">so that two versions of the template can be used for the plain- and rich-text bodies. The</p>
<p style="position:absolute;top:560px;left:108px;white-space:nowrap" class="ft9114">keyword arguments passed by the caller are given to the&#160;render_template()&#160;calls so</p>
<p style="position:absolute;top:579px;left:108px;white-space:nowrap" class="ft9148">that they can be used by the templates that generate the email body.<br/>The&#160;index()&#160;view function can be easily expanded to send an email to the administrator</p>
<p style="position:absolute;top:626px;left:108px;white-space:nowrap" class="ft9114">whenever a new name is received with the form.&#160;<a href="Flask.html#91">Example 6-4</a>&#160;shows this change.</p>
<p style="position:absolute;top:658px;left:108px;white-space:nowrap" class="ft9163"><i>Example 6-4. hello.py: Email example<br/># ...<br/></i>app.config['FLASKY_ADMIN']&#160;=&#160;os.environ.get('FLASKY_ADMIN')<br/><i># ...<br/></i>@app.route('/',&#160;methods=['GET',&#160;'POST'])<br/><b>def</b>&#160;index():<br/>&#160; &#160;&#160;form&#160;=&#160;NameForm()<br/>&#160; &#160;&#160;<b>if</b>&#160;form.validate_on_submit():<br/>&#160; &#160; &#160; &#160;&#160;user&#160;=&#160;User.query.filter_by(username=form.name.data).first()<br/>&#160; &#160; &#160; &#160;&#160;<b>if</b>&#160;user&#160;<b>is</b>&#160;None:<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;user&#160;=&#160;User(username=form.name.data)<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;db.session.add(user)<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;session['known']&#160;=&#160;False<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>if</b>&#160;app.config['FLASKY_ADMIN']:</p>
<p style="position:absolute;top:915px;left:472px;white-space:nowrap" class="ft915"><b>Email Support with Flask-Mail &#160;&#160;|&#160;&#160;71</b></p>
</div>
<!-- Page 92 -->
<a name="92"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page92-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask092.png" alt="background image"/>
<p style="position:absolute;top:82px;left:108px;white-space:nowrap" class="ft9247">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;send_email(app.config['FLASKY_ADMIN'],&#160;'New User',<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;'mail/new_user',&#160;user=user)<br/>&#160; &#160; &#160; &#160;&#160;<b>else</b>:<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;session['known']&#160;=&#160;True<br/>&#160; &#160; &#160; &#160;&#160;session['name']&#160;=&#160;form.name.data<br/>&#160; &#160; &#160; &#160;&#160;form.name.data&#160;=&#160;''<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;redirect(url_for('index'))<br/>&#160; &#160;&#160;<b>return</b>&#160;render_template('index.html',&#160;form=form,&#160;name=session.get('name'),<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;known=session.get('known',&#160;False))</p>
<p style="position:absolute;top:232px;left:108px;white-space:nowrap" class="ft9214">The recipient of the email is given in the&#160;FLASKY_ADMIN&#160;environment variable loaded</p>
<p style="position:absolute;top:251px;left:108px;white-space:nowrap" class="ft9214">into a configuration variable of the same name during startup. Two template files need</p>
<p style="position:absolute;top:270px;left:108px;white-space:nowrap" class="ft9214">to be created for the text and HTML versions of the email. These files are stored in a</p>
<p style="position:absolute;top:290px;left:108px;white-space:nowrap" class="ft9210"><i>mail</i></p>
<p style="position:absolute;top:289px;left:136px;white-space:nowrap" class="ft9214">&#160;subfolder inside&#160;<i>templates</i>&#160;to keep them separate from regular templates. The email</p>
<p style="position:absolute;top:309px;left:108px;white-space:nowrap" class="ft9214">templates expect the user to be given as a template argument, so the call to&#160;send_email()</p>
<p style="position:absolute;top:327px;left:108px;white-space:nowrap" class="ft9214">includes it as a keyword argument.</p>
<p style="position:absolute;top:369px;left:198px;white-space:nowrap" class="ft9225">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:387px;left:198px;white-space:nowrap" class="ft9225">run&#160;git&#160;checkout&#160;6a&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:476px;left:108px;white-space:nowrap" class="ft9214">In addition to the&#160;MAIL_USERNAME&#160;and&#160;MAIL_PASSWORD&#160;environment variables described</p>
<p style="position:absolute;top:496px;left:108px;white-space:nowrap" class="ft9214">earlier, this version of the application needs the&#160;FLASKY_ADMIN&#160;environment variable.</p>
<p style="position:absolute;top:515px;left:108px;white-space:nowrap" class="ft9214">For Linux and Mac OS X users, the command to start the application is:</p>
<p style="position:absolute;top:547px;left:133px;white-space:nowrap" class="ft9233">(venv)&#160;$&#160;export&#160;FLASKY_ADMIN=&lt;your-email-address&gt;</p>
<p style="position:absolute;top:567px;left:108px;white-space:nowrap" class="ft9214">For Microsoft Windows users, this is the equivalent command:</p>
<p style="position:absolute;top:599px;left:133px;white-space:nowrap" class="ft9233">(venv)&#160;$&#160;set&#160;FLASKY_ADMIN=&lt;Gmail username&gt;</p>
<p style="position:absolute;top:619px;left:108px;white-space:nowrap" class="ft9214">With these environment variables set, you can test the application and receive an email</p>
<p style="position:absolute;top:638px;left:108px;white-space:nowrap" class="ft9214">every time you enter a new name in the form.</p>
<p style="position:absolute;top:675px;left:108px;white-space:nowrap" class="ft9265"><b>Sending Asynchronous Email&#160;<br/></b>If you sent a few test emails, you likely noticed that the&#160;mail.send()&#160;function blocks</p>
<p style="position:absolute;top:729px;left:108px;white-space:nowrap" class="ft9214">for a few seconds while the email is sent, making the browser look unresponsive during</p>
<p style="position:absolute;top:748px;left:108px;white-space:nowrap" class="ft9214">that time. To avoid unnecessary delays during request handling, the email send function</p>
<p style="position:absolute;top:767px;left:108px;white-space:nowrap" class="ft9214"><a href="Flask.html#92">can be moved to a background thread.&#160;Example 6-5&#160;shows this change.</a></p>
<p style="position:absolute;top:799px;left:108px;white-space:nowrap" class="ft9250"><i>Example 6-5. hello.py: Asynchronous email support<br/></i><b>from</b>&#160;<b>threading</b>&#160;<b>import</b>&#160;Thread</p>
<p style="position:absolute;top:857px;left:108px;white-space:nowrap" class="ft9247"><b>def</b>&#160;send_async_email(app,&#160;msg):<br/>&#160; &#160;&#160;<b>with</b>&#160;app.app_context():</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft925"><b>72&#160;&#160;|&#160;&#160;Chapter 6: Email</b></p>
</div>
<!-- Page 93 -->
<a name="93"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page93-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask093.png" alt="background image"/>
<p style="position:absolute;top:82px;left:108px;white-space:nowrap" class="ft933">&#160; &#160; &#160; &#160;&#160;mail.send(msg)</p>
<p style="position:absolute;top:113px;left:108px;white-space:nowrap" class="ft9347"><b>def</b>&#160;send_email(to,&#160;subject,&#160;template,&#160;**kwargs):<br/>&#160; &#160;&#160;msg&#160;=&#160;Message(app.config['FLASKY_MAIL_SUBJECT_PREFIX']&#160;+&#160;subject,<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;sender=app.config['FLASKY_MAIL_SENDER'],&#160;recipients=[to])<br/>&#160; &#160;&#160;msg.body&#160;=&#160;render_template(template&#160;+&#160;'.txt',&#160;**kwargs)<br/>&#160; &#160;&#160;msg.html&#160;=&#160;render_template(template&#160;+&#160;'.html',&#160;**kwargs)<br/>&#160; &#160;&#160;thr&#160;=&#160;Thread(target=send_async_email,&#160;args=[app,&#160;msg])<br/>&#160; &#160;&#160;thr.start()<br/>&#160; &#160;&#160;<b>return</b>&#160;thr</p>
<p style="position:absolute;top:246px;left:108px;white-space:nowrap" class="ft9314">This implementation highlights an interesting problem. Many Flask extensions operate</p>
<p style="position:absolute;top:265px;left:108px;white-space:nowrap" class="ft9346">under the assumption that there are active application and request contexts. Flask-Mail’s<br/>send()</p>
<p style="position:absolute;top:285px;left:153px;white-space:nowrap" class="ft9314">&#160;function uses&#160;current_app, so it requires the application context to be active.</p>
<p style="position:absolute;top:305px;left:108px;white-space:nowrap" class="ft9314">But when the&#160;mail.send()&#160;function executes in a different thread, the application con‐</p>
<p style="position:absolute;top:325px;left:108px;white-space:nowrap" class="ft9314">text needs to be created artificially using&#160;app.app_context().</p>
<p style="position:absolute;top:366px;left:198px;white-space:nowrap" class="ft9325">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:385px;left:198px;white-space:nowrap" class="ft9325">run&#160;git&#160;checkout&#160;6b&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:473px;left:108px;white-space:nowrap" class="ft9314">If you run the application now, you will notice that it is much more responsive, but keep</p>
<p style="position:absolute;top:492px;left:108px;white-space:nowrap" class="ft9314">in mind that for applications that send a large volume of email, having a job dedicated</p>
<p style="position:absolute;top:510px;left:108px;white-space:nowrap" class="ft9314">to sending email is more appropriate than starting a new thread for every email. For</p>
<p style="position:absolute;top:530px;left:108px;white-space:nowrap" class="ft9314">example, the execution of the&#160;send_async_email()&#160;function can be sent to a&#160;<a href="http://www.celeryproject.org/">Celery</a></p>
<p style="position:absolute;top:549px;left:108px;white-space:nowrap" class="ft9315">task queue.<br/>This chapter completes the overview of the features that are a must-have for most web</p>
<p style="position:absolute;top:596px;left:108px;white-space:nowrap" class="ft9314">applications. The problem now is that the&#160;<i>hello.py</i>&#160;script is starting to get large and that</p>
<p style="position:absolute;top:615px;left:108px;white-space:nowrap" class="ft9314">makes it harder to work with. In the next chapter, you will learn how to structure a larger</p>
<p style="position:absolute;top:634px;left:108px;white-space:nowrap" class="ft9314">application.</p>
<p style="position:absolute;top:915px;left:472px;white-space:nowrap" class="ft935"><b>Email Support with Flask-Mail &#160;&#160;|&#160;&#160;73</b></p>
</div>
<!-- Page 94 -->
<a name="94"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page94-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask094.png" alt="background image"/>
</div>
<!-- Page 95 -->
<a name="95"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page95-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask095.png" alt="background image"/>
<p style="position:absolute;top:104px;left:559px;white-space:nowrap" class="ft9528"><b>CHAPTER 7</b></p>
<p style="position:absolute;top:131px;left:308px;white-space:nowrap" class="ft9511"><b>Large Application Structure</b></p>
<p style="position:absolute;top:345px;left:108px;white-space:nowrap" class="ft9514">Although having small web applications stored in a single script can be very convenient,</p>
<p style="position:absolute;top:364px;left:108px;white-space:nowrap" class="ft9514">this approach does not scale well. As the application grows in complexity, working with</p>
<p style="position:absolute;top:383px;left:108px;white-space:nowrap" class="ft9515">a single large source file becomes problematic.<br/>Unlike most other web frameworks, Flask does not impose a specific organization for</p>
<p style="position:absolute;top:430px;left:108px;white-space:nowrap" class="ft9514">large projects; the way to structure the application is left entirely to the developer. In</p>
<p style="position:absolute;top:449px;left:108px;white-space:nowrap" class="ft9514">this chapter, a possible way to organize a large application in packages and modules is</p>
<p style="position:absolute;top:468px;left:108px;white-space:nowrap" class="ft9514">presented. This structure will be used in the remaining examples of the book.</p>
<p style="position:absolute;top:504px;left:108px;white-space:nowrap" class="ft9518"><b>Project Structure<br/></b><a href="Flask.html#95">Example 7-1</a>&#160;shows the basic layout for a Flask application.</p>
<p style="position:absolute;top:576px;left:108px;white-space:nowrap" class="ft9523"><i>Example 7-1. Basic multiple-file Flask application structure<br/></i>|-flasky<br/>&#160; |-app/<br/>&#160; &#160; |-templates/<br/>&#160; &#160; |-static/<br/>&#160; &#160; |-main/<br/>&#160; &#160; &#160; |-__init__.py<br/>&#160; &#160; &#160; |-errors.py<br/>&#160; &#160; &#160; |-forms.py<br/>&#160; &#160; &#160; |-views.py<br/>&#160; &#160; |-__init__.py<br/>&#160; &#160; |-email.py<br/>&#160; &#160; |-models.py<br/>&#160; |-migrations/<br/>&#160; |-tests/<br/>&#160; &#160; |-__init__.py<br/>&#160; &#160; |-test*.py<br/>&#160; |-venv/<br/>&#160; |-requirements.txt</p>
<p style="position:absolute;top:915px;left:637px;white-space:nowrap" class="ft955"><b>75</b></p>
</div>
<!-- Page 96 -->
<a name="96"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft9677{font-size:10px;line-height:15px;font-family:Times;color:#9999ff;}
-->
</style>
<div id="page96-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask096.png" alt="background image"/>
<p style="position:absolute;top:82px;left:108px;white-space:nowrap" class="ft9623">&#160; |-config.py<br/>&#160; |-manage.py</p>
<p style="position:absolute;top:124px;left:108px;white-space:nowrap" class="ft9614">This structure has four top-level folders:</p>
<p style="position:absolute;top:158px;left:121px;white-space:nowrap" class="ft9619">•&#160;The Flask application lives inside a package generically named&#160;<i>app</i>.<br/>•&#160;The&#160;<i>migrations</i>&#160;folder contains the database migration scripts, as before.<br/>•&#160;Unit tests are written in a&#160;<i>tests</i>&#160;package.<br/>•&#160;The&#160;<i>venv</i>&#160;folder contains the Python virtual environment, as before.</p>
<p style="position:absolute;top:267px;left:108px;white-space:nowrap" class="ft9614">There are also a few new files:&#160;</p>
<p style="position:absolute;top:300px;left:121px;white-space:nowrap" class="ft9614">•&#160;<i>requirements.txt</i>&#160;lists the package dependencies so that it is easy to regenerate an</p>
<p style="position:absolute;top:319px;left:135px;white-space:nowrap" class="ft9614">identical virtual environment on a different computer.</p>
<p style="position:absolute;top:344px;left:121px;white-space:nowrap" class="ft9619">•&#160;<i>config.py</i>&#160;stores the configuration settings.<br/>•&#160;<i>manage.py</i>&#160;launches the application and other application tasks.</p>
<p style="position:absolute;top:403px;left:108px;white-space:nowrap" class="ft9614">To help you fully understand this structure, the following sections describe the process</p>
<p style="position:absolute;top:422px;left:108px;white-space:nowrap" class="ft9614">to convert the&#160;<i>hello.py</i>&#160;application to it.</p>
<p style="position:absolute;top:458px;left:108px;white-space:nowrap" class="ft9618"><b>Configuration Options<br/></b>Applications often need several configuration sets. The best example of this is the need</p>
<p style="position:absolute;top:517px;left:108px;white-space:nowrap" class="ft9614">to use different databases during development, testing, and production so that they don’t</p>
<p style="position:absolute;top:536px;left:108px;white-space:nowrap" class="ft9615">interfere with each other.<br/>Instead of the simple dictionary-like structure configuration used by&#160;<i>hello.py</i>, a hierar‐</p>
<p style="position:absolute;top:583px;left:108px;white-space:nowrap" class="ft9614">chy of configuration classes can be used.&#160;<a href="Flask.html#96">Example 7-2</a>&#160;shows the&#160;<i>config.py</i>&#160;file.&#160;</p>
<p style="position:absolute;top:615px;left:108px;white-space:nowrap" class="ft9641"><i>Example 7-2. config.py: Application configuration<br/></i><b>import</b>&#160;<b>os<br/></b>basedir&#160;=&#160;os.path.abspath(os.path.dirname(__file__))</p>
<p style="position:absolute;top:688px;left:108px;white-space:nowrap" class="ft9657"><b>class</b>&#160;<b>Config</b>:<br/>&#160; &#160;&#160;SECRET_KEY&#160;=&#160;os.environ.get('SECRET_KEY')&#160;<b>or</b>&#160;'hard to guess string'<br/>&#160; &#160;&#160;SQLALCHEMY_COMMIT_ON_TEARDOWN&#160;=&#160;True<br/>&#160; &#160;&#160;FLASKY_MAIL_SUBJECT_PREFIX&#160;=&#160;'[Flasky]'<br/>&#160; &#160;&#160;FLASKY_MAIL_SENDER&#160;=&#160;'Flasky Admin &lt;flasky@example.com&gt;'<br/>&#160; &#160;&#160;FLASKY_ADMIN&#160;=&#160;os.environ.get('FLASKY_ADMIN')</p>
<p style="position:absolute;top:796px;left:108px;white-space:nowrap" class="ft9647">&#160; &#160;&#160;@staticmethod<br/>&#160; &#160;&#160;<b>def</b>&#160;init_app(app):<br/>&#160; &#160; &#160; &#160;&#160;<b>pass</b></p>
<p style="position:absolute;top:857px;left:108px;white-space:nowrap" class="ft9647"><b>class</b>&#160;<b>DevelopmentConfig</b>(Config):<br/>&#160; &#160;&#160;DEBUG&#160;=&#160;True</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft965"><b>76&#160;&#160;|&#160;&#160;Chapter 7: Large Application Structure</b></p>
</div>
<!-- Page 97 -->
<a name="97"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page97-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask097.png" alt="background image"/>
<p style="position:absolute;top:82px;left:108px;white-space:nowrap" class="ft9723">&#160; &#160;&#160;MAIL_SERVER&#160;=&#160;'smtp.googlemail.com'<br/>&#160; &#160;&#160;MAIL_PORT&#160;=&#160;587<br/>&#160; &#160;&#160;MAIL_USE_TLS&#160;=&#160;True<br/>&#160; &#160;&#160;MAIL_USERNAME&#160;=&#160;os.environ.get('MAIL_USERNAME')<br/>&#160; &#160;&#160;MAIL_PASSWORD&#160;=&#160;os.environ.get('MAIL_PASSWORD')<br/>&#160; &#160;&#160;SQLALCHEMY_DATABASE_URI&#160;=&#160;os.environ.get('DEV_DATABASE_URL')&#160;<b>or</b>&#160;\<br/>&#160; &#160; &#160; &#160;&#160;'sqlite:///'&#160;+&#160;os.path.join(basedir,&#160;'data-dev.sqlite')</p>
<p style="position:absolute;top:205px;left:108px;white-space:nowrap" class="ft9723"><b>class</b>&#160;<b>TestingConfig</b>(Config):<br/>&#160; &#160;&#160;TESTING&#160;=&#160;True<br/>&#160; &#160;&#160;SQLALCHEMY_DATABASE_URI&#160;=&#160;os.environ.get('TEST_DATABASE_URL')&#160;<b>or</b>&#160;\<br/>&#160; &#160; &#160; &#160;&#160;'sqlite:///'&#160;+&#160;os.path.join(basedir,&#160;'data-test.sqlite')</p>
<p style="position:absolute;top:281px;left:108px;white-space:nowrap" class="ft9723"><b>class</b>&#160;<b>ProductionConfig</b>(Config):<br/>&#160; &#160;&#160;SQLALCHEMY_DATABASE_URI&#160;=&#160;os.environ.get('DATABASE_URL')&#160;<b>or</b>&#160;\<br/>&#160; &#160; &#160; &#160;&#160;'sqlite:///'&#160;+&#160;os.path.join(basedir,&#160;'data.sqlite')</p>
<p style="position:absolute;top:342px;left:108px;white-space:nowrap" class="ft9747">config&#160;=&#160;{<br/>&#160; &#160;&#160;'development':&#160;DevelopmentConfig,<br/>&#160; &#160;&#160;'testing':&#160;TestingConfig,<br/>&#160; &#160;&#160;'production':&#160;ProductionConfig,</p>
<p style="position:absolute;top:419px;left:108px;white-space:nowrap" class="ft9740">&#160; &#160;&#160;'default':&#160;DevelopmentConfig<br/>}</p>
<p style="position:absolute;top:462px;left:108px;white-space:nowrap" class="ft9714">The&#160;Config&#160;base class contains settings that are common to all configurations; the dif‐</p>
<p style="position:absolute;top:480px;left:108px;white-space:nowrap" class="ft9714">ferent subclasses define settings that are specific to a configuration. Additional config‐</p>
<p style="position:absolute;top:499px;left:108px;white-space:nowrap" class="ft9715">urations can be added as needed.<br/>To make configuration more flexible and safe, some settings can be optionally imported</p>
<p style="position:absolute;top:547px;left:108px;white-space:nowrap" class="ft9714">from environment variables. For example, the value of the&#160;SECRET_KEY, due to its sen‐</p>
<p style="position:absolute;top:566px;left:108px;white-space:nowrap" class="ft9714">sitive nature, can be set in the environment, but a default value is provided in case the</p>
<p style="position:absolute;top:585px;left:108px;white-space:nowrap" class="ft9748">environment does not define it.<br/>The&#160;SQLALCHEMY_DATABASE_URI&#160;variable is assigned different values under each of the</p>
<p style="position:absolute;top:633px;left:108px;white-space:nowrap" class="ft9714">three configurations. This enables the application to run under different configurations,</p>
<p style="position:absolute;top:652px;left:108px;white-space:nowrap" class="ft9748">each using a different database.<br/>Configuration classes can define a&#160;init_app()&#160;class method that takes an application</p>
<p style="position:absolute;top:699px;left:108px;white-space:nowrap" class="ft9714">instance as an argument. Here configuration-specific initialization can performed. For</p>
<p style="position:absolute;top:719px;left:108px;white-space:nowrap" class="ft9715">now the base&#160;Config&#160;class implements an empty&#160;init_app()&#160;method.<br/>At the bottom of the configuration script, the different configurations are registered in</p>
<p style="position:absolute;top:767px;left:108px;white-space:nowrap" class="ft9714">a&#160;config&#160;dictionary. One of the configurations (the one for development in this case)</p>
<p style="position:absolute;top:786px;left:108px;white-space:nowrap" class="ft9714">is also registered as the default.</p>
<p style="position:absolute;top:915px;left:509px;white-space:nowrap" class="ft975"><b>Configuration Options&#160;&#160;|&#160;&#160;77</b></p>
</div>
<!-- Page 98 -->
<a name="98"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page98-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask098.png" alt="background image"/>
<p style="position:absolute;top:74px;left:108px;white-space:nowrap" class="ft9818"><b>Application Package<br/></b>The application package is where all the application code, templates, and static files live.</p>
<p style="position:absolute;top:134px;left:108px;white-space:nowrap" class="ft9814">It is called simply&#160;<i>app</i>, though it can be given an application-specific name if desired.</p>
<p style="position:absolute;top:152px;left:108px;white-space:nowrap" class="ft9814">The&#160;<i>templates</i>&#160;and&#160;<i>static</i>&#160;folders are part of the application package, so these two folders</p>
<p style="position:absolute;top:171px;left:108px;white-space:nowrap" class="ft9814">are moved inside&#160;<i>app</i>. The database models and the email support functions are also</p>
<p style="position:absolute;top:190px;left:108px;white-space:nowrap" class="ft9814">moved inside this package, each in its own module as&#160;<i>app/models.py</i>&#160;and&#160;<i>app/email.py</i>.</p>
<p style="position:absolute;top:227px;left:108px;white-space:nowrap" class="ft9852"><b>Using an Application Factory&#160;<br/></b>The way the application is created in the single-file version is very convenient, but it has</p>
<p style="position:absolute;top:280px;left:108px;white-space:nowrap" class="ft9814">one big drawback. Because the application is created in the global scope, there is no way</p>
<p style="position:absolute;top:299px;left:108px;white-space:nowrap" class="ft9814">to apply configuration changes dynamically: by the time the script is running, the ap‐</p>
<p style="position:absolute;top:318px;left:108px;white-space:nowrap" class="ft9814">plication instance has already been created, so it is already too late to make configuration</p>
<p style="position:absolute;top:337px;left:108px;white-space:nowrap" class="ft9814">changes. This is particularly important for unit tests because sometimes it is necessary</p>
<p style="position:absolute;top:356px;left:108px;white-space:nowrap" class="ft9815">to run the application under different configuration settings for better test coverage.<br/>The solution to this problem is to delay the creation of the application by moving it into</p>
<p style="position:absolute;top:403px;left:108px;white-space:nowrap" class="ft9814">a&#160;<i>factory function</i>&#160;that can be explicitly invoked from the script. This not only gives the</p>
<p style="position:absolute;top:422px;left:108px;white-space:nowrap" class="ft9814">script time to set the configuration but also the ability to create multiple application</p>
<p style="position:absolute;top:441px;left:108px;white-space:nowrap" class="ft9814">instances—something that can also be very useful during testing. The application fac‐</p>
<p style="position:absolute;top:459px;left:108px;white-space:nowrap" class="ft9815">tory function, shown in&#160;<a href="Flask.html#98">Example 7-3, is defined in the&#160;</a><i>app</i>&#160;package constructor.<br/>This constructor imports most of the Flask extensions currently in use, but because</p>
<p style="position:absolute;top:506px;left:108px;white-space:nowrap" class="ft9814">there is no application instance to initialize them with, it creates them uninitialized by</p>
<p style="position:absolute;top:526px;left:108px;white-space:nowrap" class="ft9814">passing no arguments into their constructors. The&#160;create_app()&#160;function is the appli‐</p>
<p style="position:absolute;top:545px;left:108px;white-space:nowrap" class="ft9814">cation factory, which takes as an argument the name of a configuration to use for the</p>
<p style="position:absolute;top:564px;left:108px;white-space:nowrap" class="ft9814">application. The configuration settings stored in one of the classes defined in&#160;<i>con‐</i></p>
<p style="position:absolute;top:585px;left:108px;white-space:nowrap" class="ft9810"><i>fig.py</i></p>
<p style="position:absolute;top:584px;left:142px;white-space:nowrap" class="ft9814">&#160;can be imported directly into the application using the&#160;from_object()&#160;method</p>
<p style="position:absolute;top:604px;left:108px;white-space:nowrap" class="ft9814">available in Flask’s&#160;app.config&#160;configuration object. The configuration object is selected</p>
<p style="position:absolute;top:623px;left:108px;white-space:nowrap" class="ft9814">by name from the&#160;config&#160;dictionary. Once an application is created and configured,</p>
<p style="position:absolute;top:643px;left:108px;white-space:nowrap" class="ft9814">the extensions can be initialized. Calling&#160;init_app()&#160;on the extensions that were created</p>
<p style="position:absolute;top:662px;left:108px;white-space:nowrap" class="ft9814">earlier completes their initialization.&#160;</p>
<p style="position:absolute;top:694px;left:108px;white-space:nowrap" class="ft9840"><i>Example 7-3. app/__init__.py: Application package constructor<br/></i><b>from</b>&#160;<b>flask</b>&#160;<b>import</b>&#160;Flask,&#160;render_template<br/><b>from</b>&#160;<b>flask.ext.bootstrap</b>&#160;<b>import</b>&#160;Bootstrap<br/><b>from</b>&#160;<b>flask.ext.mail</b>&#160;<b>import</b>&#160;Mail<br/><b>from</b>&#160;<b>flask.ext.moment</b>&#160;<b>import</b>&#160;Moment<br/><b>from</b>&#160;<b>flask.ext.sqlalchemy</b>&#160;<b>import</b>&#160;SQLAlchemy<br/><b>from</b>&#160;<b>config</b>&#160;<b>import</b>&#160;config</p>
<p style="position:absolute;top:829px;left:108px;white-space:nowrap" class="ft9847">bootstrap&#160;=&#160;Bootstrap()<br/>mail&#160;=&#160;Mail()<br/>moment&#160;=&#160;Moment()<br/>db&#160;=&#160;SQLAlchemy()</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft985"><b>78&#160;&#160;|&#160;&#160;Chapter 7: Large Application Structure</b></p>
</div>
<!-- Page 99 -->
<a name="99"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page99-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask099.png" alt="background image"/>
<p style="position:absolute;top:98px;left:108px;white-space:nowrap" class="ft9947"><b>def</b>&#160;create_app(config_name):<br/>&#160; &#160;&#160;app&#160;=&#160;Flask(__name__)<br/>&#160; &#160;&#160;app.config.from_object(config[config_name])<br/>&#160; &#160;&#160;config[config_name].init_app(app)</p>
<p style="position:absolute;top:174px;left:108px;white-space:nowrap" class="ft9947">&#160; &#160;&#160;bootstrap.init_app(app)<br/>&#160; &#160;&#160;mail.init_app(app)<br/>&#160; &#160;&#160;moment.init_app(app)<br/>&#160; &#160;&#160;db.init_app(app)</p>
<p style="position:absolute;top:251px;left:108px;white-space:nowrap" class="ft993">&#160; &#160;&#160;<i># attach routes and custom error pages here</i></p>
<p style="position:absolute;top:281px;left:108px;white-space:nowrap" class="ft993">&#160; &#160;&#160;<b>return</b>&#160;app</p>
<p style="position:absolute;top:308px;left:108px;white-space:nowrap" class="ft9914">The factory function returns the created application instance, but note that applications</p>
<p style="position:absolute;top:327px;left:108px;white-space:nowrap" class="ft9914">created with the factory function in its current state are incomplete, as they are missing</p>
<p style="position:absolute;top:345px;left:108px;white-space:nowrap" class="ft9914">routes and custom error page handlers. This is the topic of the next section.</p>
<p style="position:absolute;top:382px;left:108px;white-space:nowrap" class="ft9952"><b>Implementing Application Functionality in a Blueprint&#160;<br/></b>The conversion to an application factory introduces a complication for routes. In single-</p>
<p style="position:absolute;top:436px;left:108px;white-space:nowrap" class="ft9914">script applications, the application instance exists in the global scope, so routes can be</p>
<p style="position:absolute;top:455px;left:108px;white-space:nowrap" class="ft9914">easily defined using the&#160;app.route&#160;decorator. But now that the application is created at</p>
<p style="position:absolute;top:475px;left:108px;white-space:nowrap" class="ft9914">runtime, the&#160;app.route&#160;decorator begins to exist only after&#160;create_app()&#160;is invoked,</p>
<p style="position:absolute;top:494px;left:108px;white-space:nowrap" class="ft9914">which is too late. Like routes, custom error page handlers present the same problem, as</p>
<p style="position:absolute;top:514px;left:108px;white-space:nowrap" class="ft9915">these are defined with the&#160;app.errorhandler&#160;decorator.<br/>Luckily Flask offers a better solution using&#160;<i>blueprints</i>. A blueprint is similar to an ap‐</p>
<p style="position:absolute;top:561px;left:108px;white-space:nowrap" class="ft9914">plication in that it can also define routes. The difference is that routes associated with</p>
<p style="position:absolute;top:580px;left:108px;white-space:nowrap" class="ft9914">a blueprint are in a dormant state until the blueprint is registered with an application,</p>
<p style="position:absolute;top:599px;left:108px;white-space:nowrap" class="ft9914">at which point the routes become part of it. Using a blueprint defined in the global scope,</p>
<p style="position:absolute;top:617px;left:108px;white-space:nowrap" class="ft9914">the routes of the application can be defined in almost the same way as in the single-</p>
<p style="position:absolute;top:636px;left:108px;white-space:nowrap" class="ft9915">script application.<br/>Like applications, blueprints can be defined all in a single file or can be created in a more</p>
<p style="position:absolute;top:683px;left:108px;white-space:nowrap" class="ft9914">structured way with multiple modules inside a package. To allow for the greatest flexi‐</p>
<p style="position:absolute;top:702px;left:108px;white-space:nowrap" class="ft9914">bility, a subpackage inside the application package will be created to host the blueprint.</p>
<p style="position:absolute;top:721px;left:108px;white-space:nowrap" class="ft9917"><a href="Flask.html#99">Example 7-4</a>&#160;shows the package constructor, which creates the blueprint.</p>
<p style="position:absolute;top:753px;left:108px;white-space:nowrap" class="ft9950"><i>Example 7-4. app/main/__init__.py: Blueprint creation<br/></i><b>from</b>&#160;<b>flask</b>&#160;<b>import</b>&#160;Blueprint</p>
<p style="position:absolute;top:811px;left:108px;white-space:nowrap" class="ft9937">main&#160;=&#160;Blueprint('main',&#160;__name__)</p>
<p style="position:absolute;top:842px;left:108px;white-space:nowrap" class="ft9938"><b>from</b>&#160;<b>.</b>&#160;<b>import</b>&#160;views,&#160;errors</p>
<p style="position:absolute;top:915px;left:517px;white-space:nowrap" class="ft995"><b>Application Package&#160;&#160;|&#160;&#160;79</b></p>
</div>
<!-- Page 100 -->
<a name="100"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page100-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask100.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft10014">Blueprints are created by instantiating an object of class&#160;Blueprint. The constructor</p>
<p style="position:absolute;top:98px;left:108px;white-space:nowrap" class="ft10014">for this class takes two required arguments: the blueprint name and the module or</p>
<p style="position:absolute;top:118px;left:108px;white-space:nowrap" class="ft10014">package where the blueprint is located. As with applications, Python’s&#160;__name__&#160;variable</p>
<p style="position:absolute;top:137px;left:108px;white-space:nowrap" class="ft10015">is in most cases the correct value for the second argument.<br/>The routes of the application are stored in an&#160;<i>app/main/views.py</i>&#160;module inside the</p>
<p style="position:absolute;top:184px;left:108px;white-space:nowrap" class="ft10014">package, and the error handlers are in&#160;<i>app/main/errors.py</i>. Importing these modules</p>
<p style="position:absolute;top:203px;left:108px;white-space:nowrap" class="ft10014">causes the routes and error handlers to be associated with the blueprint. It is important</p>
<p style="position:absolute;top:222px;left:108px;white-space:nowrap" class="ft10014">to note that the modules are imported at the bottom of the&#160;<i>app/__init__.py</i>&#160;script to</p>
<p style="position:absolute;top:241px;left:108px;white-space:nowrap" class="ft10014">avoid circular dependencies, because&#160;<i>views.py</i>&#160;and&#160;<i>errors.py</i>&#160;need to import the&#160;main</p>
<p style="position:absolute;top:260px;left:108px;white-space:nowrap" class="ft10048">blueprint.<br/>The blueprint is registered with the application inside the&#160;create_app()&#160;factory func‐</p>
<p style="position:absolute;top:308px;left:108px;white-space:nowrap" class="ft10014">tion, as shown in&#160;<a href="Flask.html#100">Example 7-5.</a></p>
<p style="position:absolute;top:340px;left:108px;white-space:nowrap" class="ft10047"><i>Example 7-5. app/_init_.py: Blueprint registration<br/></i><b>def</b>&#160;create_app(config_name):<br/>&#160; &#160;&#160;<i># ...</i></p>
<p style="position:absolute;top:414px;left:108px;white-space:nowrap" class="ft10040">&#160; &#160;&#160;<b>from</b>&#160;<b>main</b>&#160;<b>import</b>&#160;main&#160;<b>as</b>&#160;main_blueprint<br/>&#160; &#160;&#160;app.register_blueprint(main_blueprint)</p>
<p style="position:absolute;top:459px;left:108px;white-space:nowrap" class="ft1003">&#160; &#160;&#160;<b>return</b>&#160;app</p>
<p style="position:absolute;top:486px;left:108px;white-space:nowrap" class="ft10017"><a href="Flask.html#100">Example 7-6</a>&#160;shows the error handlers.&#160;</p>
<p style="position:absolute;top:518px;left:108px;white-space:nowrap" class="ft10040"><i>Example 7-6. app/main/errors.py: Blueprint with error handlers<br/></i><b>from</b>&#160;<b>flask</b>&#160;<b>import</b>&#160;render_template<br/><b>from</b>&#160;<b>.</b>&#160;<b>import</b>&#160;main</p>
<p style="position:absolute;top:591px;left:108px;white-space:nowrap" class="ft10047">@main.app_errorhandler(404)<br/><b>def</b>&#160;page_not_found(e):<br/>&#160; &#160;&#160;<b>return</b>&#160;render_template('404.html'),&#160;404</p>
<p style="position:absolute;top:653px;left:108px;white-space:nowrap" class="ft10047">@main.app_errorhandler(500)<br/><b>def</b>&#160;internal_server_error(e):<br/>&#160; &#160;&#160;<b>return</b>&#160;render_template('500.html'),&#160;500</p>
<p style="position:absolute;top:711px;left:108px;white-space:nowrap" class="ft10014">A difference when writing error handlers inside a blueprint is that if the&#160;errorhandler</p>
<p style="position:absolute;top:730px;left:108px;white-space:nowrap" class="ft10014">decorator is used, the handler will only be invoked for errors that originate in the blue‐</p>
<p style="position:absolute;top:749px;left:108px;white-space:nowrap" class="ft10014">print. To install application-wide error handlers, the&#160;app_errorhandler&#160;must be used</p>
<p style="position:absolute;top:768px;left:108px;white-space:nowrap" class="ft10015">instead.<br/><a href="Flask.html#100">Example 7-7</a>&#160;shows the routes of the application updated to be in the blueprint.</p>
<p style="position:absolute;top:828px;left:108px;white-space:nowrap" class="ft10040"><i>Example 7-7. app/main/views.py: Blueprint with application routes<br/></i><b>from</b>&#160;<b>datetime</b>&#160;<b>import</b>&#160;datetime<br/><b>from</b>&#160;<b>flask</b>&#160;<b>import</b>&#160;render_template,&#160;session,&#160;redirect,&#160;url_for</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1005"><b>80&#160;&#160;|&#160;&#160;Chapter 7: Large Application Structure</b></p>
</div>
<!-- Page 101 -->
<a name="101"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page101-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask101.png" alt="background image"/>
<p style="position:absolute;top:82px;left:108px;white-space:nowrap" class="ft10140"><b>from</b>&#160;<b>.</b>&#160;<b>import</b>&#160;main<br/><b>from</b>&#160;<b>.forms</b>&#160;<b>import</b>&#160;NameForm<br/><b>from</b>&#160;<b>..</b>&#160;<b>import</b>&#160;db<br/><b>from</b>&#160;<b>..models</b>&#160;<b>import</b>&#160;User</p>
<p style="position:absolute;top:159px;left:108px;white-space:nowrap" class="ft10147">@main.route('/',&#160;methods=['GET',&#160;'POST'])<br/><b>def</b>&#160;index():<br/>&#160; &#160;&#160;form&#160;=&#160;NameForm()<br/>&#160; &#160;&#160;<b>if</b>&#160;form.validate_on_submit():<br/>&#160; &#160; &#160; &#160;&#160;<i># ...<br/></i>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;redirect(url_for('.index'))<br/>&#160; &#160;&#160;<b>return</b>&#160;render_template('index.html',<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;form=form,&#160;name=session.get('name'),<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;known=session.get('known',&#160;False),<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;current_time=datetime.utcnow())</p>
<p style="position:absolute;top:323px;left:108px;white-space:nowrap" class="ft10114">There are two main differences when writing a view function inside a blueprint. First,</p>
<p style="position:absolute;top:342px;left:108px;white-space:nowrap" class="ft10114">as was done for error handlers earlier, the route decorator comes from the blueprint.</p>
<p style="position:absolute;top:362px;left:108px;white-space:nowrap" class="ft10114">The second difference is in the usage of the&#160;url_for()&#160;function. As you may recall, the</p>
<p style="position:absolute;top:381px;left:108px;white-space:nowrap" class="ft10114">first argument to this function is the endpoint name of the route, which for application-</p>
<p style="position:absolute;top:399px;left:108px;white-space:nowrap" class="ft10114">based routes defaults to the name of the view function. For example, in a single-script</p>
<p style="position:absolute;top:419px;left:108px;white-space:nowrap" class="ft10146">application the URL for an&#160;index()&#160;view function can be obtained with<br/>url_for('index')</p>
<p style="position:absolute;top:439px;left:228px;white-space:nowrap" class="ft10114">.</p>
<p style="position:absolute;top:467px;left:108px;white-space:nowrap" class="ft10114">The difference with blueprints is that Flask applies a namespace to all the endpoints</p>
<p style="position:absolute;top:486px;left:108px;white-space:nowrap" class="ft10114">coming from a blueprint so that multiple blueprints can define view functions with the</p>
<p style="position:absolute;top:505px;left:108px;white-space:nowrap" class="ft10114">same endpoint names without collisions. The namespace is the name of the blueprint</p>
<p style="position:absolute;top:525px;left:108px;white-space:nowrap" class="ft10114">(the first argument to the&#160;Blueprint&#160;constructor), so the&#160;index()&#160;view function is</p>
<p style="position:absolute;top:544px;left:108px;white-space:nowrap" class="ft10146">registered with endpoint name&#160;main.index&#160;and its URL can be obtained with<br/>url_for('main.index')</p>
<p style="position:absolute;top:564px;left:266px;white-space:nowrap" class="ft10114">.</p>
<p style="position:absolute;top:593px;left:108px;white-space:nowrap" class="ft10114">The&#160;url_for()&#160;function also supports a shorter format for endpoints in blueprints in</p>
<p style="position:absolute;top:613px;left:108px;white-space:nowrap" class="ft10114">which the blueprint name is omitted, such as&#160;url_for('.index'). With this notation,</p>
<p style="position:absolute;top:632px;left:108px;white-space:nowrap" class="ft10114">the blueprint for the current request is used. This effectively means that redirects within</p>
<p style="position:absolute;top:651px;left:108px;white-space:nowrap" class="ft10114">the same blueprint can use the shorter form, while redirects across blueprints must use</p>
<p style="position:absolute;top:670px;left:108px;white-space:nowrap" class="ft10115">the namespaced endpoint name.<br/>To complete the changes to the application page, the form objects are also stored inside</p>
<p style="position:absolute;top:716px;left:108px;white-space:nowrap" class="ft10114">the blueprint in an&#160;<i>app/main/forms.py</i>&#160;module.</p>
<p style="position:absolute;top:754px;left:108px;white-space:nowrap" class="ft10122"><b>Launch Script&#160;<br/></b>The&#160;<i>manage.py</i>&#160;file in the top-level folder is used to start the application. This script is</p>
<p style="position:absolute;top:814px;left:108px;white-space:nowrap" class="ft10114">shown in&#160;<a href="Flask.html#101">Example 7-8.</a></p>
<p style="position:absolute;top:915px;left:546px;white-space:nowrap" class="ft1015"><b>Launch Script &#160;&#160;|&#160;&#160;81</b></p>
</div>
<!-- Page 102 -->
<a name="102"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page102-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask102.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft10240"><i>Example 7-8. manage.py: Launch script<br/>#!/usr/bin/env python<br/></i><b>import</b>&#160;<b>os<br/>from</b>&#160;<b>app</b>&#160;<b>import</b>&#160;create_app,&#160;db<br/><b>from</b>&#160;<b>app.models</b>&#160;<b>import</b>&#160;User,&#160;Role<br/><b>from</b>&#160;<b>flask.ext.script</b>&#160;<b>import</b>&#160;Manager,&#160;Shell<br/><b>from</b>&#160;<b>flask.ext.migrate</b>&#160;<b>import</b>&#160;Migrate,&#160;MigrateCommand</p>
<p style="position:absolute;top:214px;left:108px;white-space:nowrap" class="ft10247">app&#160;=&#160;create_app(os.getenv('FLASK_CONFIG')&#160;<b>or</b>&#160;'default')<br/>manager&#160;=&#160;Manager(app)<br/>migrate&#160;=&#160;Migrate(app,&#160;db)</p>
<p style="position:absolute;top:275px;left:108px;white-space:nowrap" class="ft10247"><b>def</b>&#160;make_shell_context():<br/>&#160; &#160;&#160;<b>return</b>&#160;dict(app=app,&#160;db=db,&#160;User=User,&#160;Role=Role)<br/>manager.add_command(&#34;shell&#34;,&#160;Shell(make_context=make_shell_context))<br/>manager.add_command('db',&#160;MigrateCommand)</p>
<p style="position:absolute;top:352px;left:108px;white-space:nowrap" class="ft10247"><b>if</b>&#160;__name__&#160;==&#160;'__main__':<br/>&#160; &#160;&#160;manager.run()</p>
<p style="position:absolute;top:394px;left:108px;white-space:nowrap" class="ft10214">The script begins by creating an application. The configuration used is taken from the</p>
<p style="position:absolute;top:414px;left:108px;white-space:nowrap" class="ft10214">environment variable&#160;FLASK_CONFIG&#160;if it’s defined; if not, the default configuration is</p>
<p style="position:absolute;top:432px;left:108px;white-space:nowrap" class="ft10214">used. Flask-Script, Flask-Migrate, and the custom context for the Python shell are then</p>
<p style="position:absolute;top:451px;left:108px;white-space:nowrap" class="ft10215">initialized.<br/>As a convenience, a shebang line is added, so that on Unix-based operating systems the</p>
<p style="position:absolute;top:499px;left:108px;white-space:nowrap" class="ft10214">script can be executed as&#160;./manage.py&#160;instead of the more verbose&#160;python manage.py.</p>
<p style="position:absolute;top:536px;left:108px;white-space:nowrap" class="ft10222"><b>Requirements File&#160;<br/></b>Applications must include a&#160;<i>requirements.txt</i>&#160;file that records all the package depen‐</p>
<p style="position:absolute;top:597px;left:108px;white-space:nowrap" class="ft10214">dencies, with the exact version numbers. This is important in case the virtual environ‐</p>
<p style="position:absolute;top:616px;left:108px;white-space:nowrap" class="ft10214">ment needs to be regenerated in a different machine, such as the machine on which the</p>
<p style="position:absolute;top:634px;left:108px;white-space:nowrap" class="ft10214">application will be deployed for production use. This file can be generated automatically</p>
<p style="position:absolute;top:653px;left:108px;white-space:nowrap" class="ft10214">by pip with the following command:</p>
<p style="position:absolute;top:685px;left:133px;white-space:nowrap" class="ft10233">(venv)&#160;$&#160;pip freeze &gt;requirements.txt</p>
<p style="position:absolute;top:706px;left:108px;white-space:nowrap" class="ft10214">It is a good idea to refresh this file whenever a package is installed or upgraded. An</p>
<p style="position:absolute;top:724px;left:108px;white-space:nowrap" class="ft10214">example requirements file is shown here:</p>
<p style="position:absolute;top:756px;left:133px;white-space:nowrap" class="ft10223">Flask==0.10.1<br/>Flask-Bootstrap==3.0.3.1<br/>Flask-Mail==0.9.0<br/>Flask-Migrate==1.1.0<br/>Flask-Moment==0.2.0<br/>Flask-SQLAlchemy==1.0<br/>Flask-Script==0.6.6<br/>Flask-WTF==0.9.4</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1025"><b>82&#160;&#160;|&#160;&#160;Chapter 7: Large Application Structure</b></p>
</div>
<!-- Page 103 -->
<a name="103"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page103-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask103.png" alt="background image"/>
<p style="position:absolute;top:82px;left:134px;white-space:nowrap" class="ft10323">Jinja2==2.7.1<br/>Mako==0.9.1<br/>MarkupSafe==0.18<br/>SQLAlchemy==0.8.4<br/>WTForms==1.0.5<br/>Werkzeug==0.9.4<br/>alembic==0.6.2<br/>blinker==1.3<br/>itsdangerous==0.23</p>
<p style="position:absolute;top:225px;left:108px;white-space:nowrap" class="ft10314">When you need to build a perfect replica of the virtual environment, you can create a</p>
<p style="position:absolute;top:244px;left:108px;white-space:nowrap" class="ft10314">new virtual environment and run the following command on it:</p>
<p style="position:absolute;top:276px;left:133px;white-space:nowrap" class="ft10333">(venv)&#160;$&#160;pip install -r requirements.txt</p>
<p style="position:absolute;top:296px;left:108px;white-space:nowrap" class="ft10314">The version numbers in the example&#160;<i>requirements.txt</i>&#160;file are likely going to be outdated</p>
<p style="position:absolute;top:315px;left:108px;white-space:nowrap" class="ft10314">by the time you read this. You can try using more recent releases of the packages, if you</p>
<p style="position:absolute;top:334px;left:108px;white-space:nowrap" class="ft10314">like. If you experience any problems, you can always go back to the versions specified</p>
<p style="position:absolute;top:353px;left:108px;white-space:nowrap" class="ft10314">in the requirements file, as those are known to be compatible with the application.</p>
<p style="position:absolute;top:390px;left:108px;white-space:nowrap" class="ft10322"><b>Unit Tests&#160;<br/></b>This application is very small so there isn’t a lot to test yet, but as an example two simple</p>
<p style="position:absolute;top:451px;left:108px;white-space:nowrap" class="ft10314"><a href="Flask.html#103">tests can be defined as shown in&#160;Example 7-9.</a></p>
<p style="position:absolute;top:482px;left:108px;white-space:nowrap" class="ft10340"><i>Example 7-9. tests/test_basics.py: Unit tests<br/></i><b>import</b>&#160;<b>unittest<br/>from</b>&#160;<b>flask</b>&#160;<b>import</b>&#160;current_app<br/><b>from</b>&#160;<b>app</b>&#160;<b>import</b>&#160;create_app,&#160;db</p>
<p style="position:absolute;top:571px;left:108px;white-space:nowrap" class="ft10347"><b>class</b>&#160;<b>BasicsTestCase</b>(unittest.TestCase):<br/>&#160; &#160;&#160;<b>def</b>&#160;setUp(self):<br/>&#160; &#160; &#160; &#160;&#160;self.app&#160;=&#160;create_app('testing')<br/>&#160; &#160; &#160; &#160;&#160;self.app_context&#160;=&#160;self.app.app_context()<br/>&#160; &#160; &#160; &#160;&#160;self.app_context.push()<br/>&#160; &#160; &#160; &#160;&#160;db.create_all()</p>
<p style="position:absolute;top:678px;left:108px;white-space:nowrap" class="ft10347">&#160; &#160;&#160;<b>def</b>&#160;tearDown(self):<br/>&#160; &#160; &#160; &#160;&#160;db.session.remove()<br/>&#160; &#160; &#160; &#160;&#160;db.drop_all()<br/>&#160; &#160; &#160; &#160;&#160;self.app_context.pop()</p>
<p style="position:absolute;top:755px;left:108px;white-space:nowrap" class="ft10347">&#160; &#160;&#160;<b>def</b>&#160;test_app_exists(self):<br/>&#160; &#160; &#160; &#160;&#160;self.assertFalse(current_app&#160;<b>is</b>&#160;None)</p>
<p style="position:absolute;top:801px;left:108px;white-space:nowrap" class="ft10347">&#160; &#160;&#160;<b>def</b>&#160;test_app_is_testing(self):<br/>&#160; &#160; &#160; &#160;&#160;self.assertTrue(current_app.config['TESTING'])</p>
<p style="position:absolute;top:915px;left:561px;white-space:nowrap" class="ft1035"><b>Unit Tests &#160;&#160;|&#160;&#160;83</b></p>
</div>
<!-- Page 104 -->
<a name="104"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft10478{font-size:10px;font-family:Times;color:#cc3300;}
	.ft10479{font-size:10px;line-height:15px;font-family:Times;color:#cc3300;}
-->
</style>
<div id="page104-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask104.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft10414">The tests are written using the standard&#160;unittest&#160;package from the Python standard</p>
<p style="position:absolute;top:99px;left:108px;white-space:nowrap" class="ft10414">library. The&#160;setUp()&#160;and&#160;tearDown()&#160;methods run before and after each test, and any</p>
<p style="position:absolute;top:119px;left:108px;white-space:nowrap" class="ft10414">methods that have a name that begins with&#160;test_&#160;are executed as tests.</p>
<p style="position:absolute;top:161px;left:198px;white-space:nowrap" class="ft10425">If&#160;you&#160;want&#160;to&#160;learn&#160;more&#160;about&#160;writing&#160;unit&#160;tests&#160;with&#160;Python’s</p>
<p style="position:absolute;top:179px;left:198px;white-space:nowrap" class="ft10442"><i>unittest</i></p>
<p style="position:absolute;top:178px;left:241px;white-space:nowrap" class="ft10425">&#160;package,&#160;read&#160;the&#160;<a href="http://bit.ly/py-unittest">official&#160;documentation</a>.</p>
<p style="position:absolute;top:268px;left:108px;white-space:nowrap" class="ft10414">The&#160;setUp()&#160;method tries to create an environment for the test that is close to that of</p>
<p style="position:absolute;top:287px;left:108px;white-space:nowrap" class="ft10414">a running application. It first creates an application configured for testing and activates</p>
<p style="position:absolute;top:307px;left:108px;white-space:nowrap" class="ft10414">its context. This step ensures that tests have access to&#160;current_app, like regular requests.</p>
<p style="position:absolute;top:325px;left:108px;white-space:nowrap" class="ft10414">Then it creates a brand-new database that the test can use when necessary. The database</p>
<p style="position:absolute;top:345px;left:108px;white-space:nowrap" class="ft10415">and the application context are removed in the&#160;tearDown()&#160;method.&#160;<br/>The first test ensures that the application instance exists. The second test ensures that</p>
<p style="position:absolute;top:392px;left:108px;white-space:nowrap" class="ft10414">the application is running under the testing configuration. To make the&#160;<i>tests</i>&#160;folder a</p>
<p style="position:absolute;top:411px;left:108px;white-space:nowrap" class="ft10414">proper package, a&#160;<i>tests/__init__.py</i>&#160;file needs to be added, but this can be an empty file,</p>
<p style="position:absolute;top:431px;left:108px;white-space:nowrap" class="ft10414">as the&#160;unittest&#160;package can scan all the modules and locate the tests.</p>
<p style="position:absolute;top:472px;left:198px;white-space:nowrap" class="ft10425">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:490px;left:198px;white-space:nowrap" class="ft10425">run&#160;git&#160;checkout&#160;7a&#160;to&#160;check&#160;out&#160;the&#160;converted&#160;version&#160;of&#160;the&#160;ap‐</p>
<p style="position:absolute;top:508px;left:198px;white-space:nowrap" class="ft10425">plication.&#160;To&#160;ensure&#160;that&#160;you&#160;have&#160;all&#160;the&#160;dependencies&#160;installed,&#160;al‐</p>
<p style="position:absolute;top:526px;left:198px;white-space:nowrap" class="ft10425">so&#160;run&#160;pip&#160;install&#160;-r&#160;requirements.txt.</p>
<p style="position:absolute;top:579px;left:108px;white-space:nowrap" class="ft10414">To run the unit tests, a custom command can be added to the&#160;<i>manage.py</i>&#160;script.</p>
<p style="position:absolute;top:598px;left:108px;white-space:nowrap" class="ft10417"><a href="Flask.html#104">Example 7-10&#160;shows how to add a&#160;</a>test&#160;command.</p>
<p style="position:absolute;top:630px;left:108px;white-space:nowrap" class="ft10447"><i>Example 7-10. manage.py: Unit test launcher command<br/></i>@manager.command<br/><b>def</b>&#160;test():<br/>&#160; &#160;&#160;<i>&#34;&#34;&#34;Run the unit tests.&#34;&#34;&#34;<br/></i>&#160; &#160;&#160;<b>import</b>&#160;<b>unittest<br/></b>&#160; &#160;&#160;tests&#160;=&#160;unittest.TestLoader().discover('tests')<br/>&#160; &#160;&#160;unittest.TextTestRunner(verbosity=2).run(tests)</p>
<p style="position:absolute;top:762px;left:108px;white-space:nowrap" class="ft10414">The&#160;manager.command&#160;decorator makes it simple to implement custom commands. The</p>
<p style="position:absolute;top:781px;left:108px;white-space:nowrap" class="ft10414">name of the decorated function is used as the command name, and the function’s doc‐</p>
<p style="position:absolute;top:801px;left:108px;white-space:nowrap" class="ft10414">string is displayed in the help messages. The implementation of&#160;test()&#160;function invokes</p>
<p style="position:absolute;top:820px;left:108px;white-space:nowrap" class="ft10415">the test runner from the&#160;unittest&#160;package.<br/>The unit tests can be executed as follows:</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1045"><b>84&#160;&#160;|&#160;&#160;Chapter 7: Large Application Structure</b></p>
</div>
<!-- Page 105 -->
<a name="105"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page105-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask105.png" alt="background image"/>
<p style="position:absolute;top:82px;left:134px;white-space:nowrap" class="ft10523">(venv)&#160;$&#160;python manage.py&#160;test<br/>test_app_exists&#160;(test_basics.BasicsTestCase)&#160;... ok<br/>test_app_is_testing&#160;(test_basics.BasicsTestCase)&#160;... ok</p>
<p style="position:absolute;top:143px;left:134px;white-space:nowrap" class="ft10523">.----------------------------------------------------------------------<br/>Ran 2 tests in 0.001s</p>
<p style="position:absolute;top:189px;left:134px;white-space:nowrap" class="ft1053">OK</p>
<p style="position:absolute;top:218px;left:108px;white-space:nowrap" class="ft10515"><b>Database Setup<br/></b>The restructured application uses a different database than the single-script version.<br/>The database URL is taken from an environment variable as a first choice, with a default</p>
<p style="position:absolute;top:305px;left:108px;white-space:nowrap" class="ft10514">SQLite database as an alternative. The environment variables and SQLite database</p>
<p style="position:absolute;top:324px;left:108px;white-space:nowrap" class="ft10514">filenames&#160;are different for each of the three configurations. For example, in the devel‐</p>
<p style="position:absolute;top:343px;left:108px;white-space:nowrap" class="ft10546">opment configuration the URL is obtained from environment variable<br/>DEV_DATABASE_URL</p>
<p style="position:absolute;top:363px;left:228px;white-space:nowrap" class="ft10514">, and if that is not defined then a SQLite database with the name</p>
<p style="position:absolute;top:383px;left:108px;white-space:nowrap" class="ft10510"><i>data-dev.sqlite</i></p>
<p style="position:absolute;top:382px;left:199px;white-space:nowrap" class="ft10514">&#160;is used.</p>
<p style="position:absolute;top:410px;left:108px;white-space:nowrap" class="ft10514">Regardless of the source of the database URL, the database tables must be created for</p>
<p style="position:absolute;top:428px;left:108px;white-space:nowrap" class="ft10514">the new database. When working with Flask-Migrate to keep track of migrations, da‐</p>
<p style="position:absolute;top:447px;left:108px;white-space:nowrap" class="ft10514">tabase tables can be created or upgraded to the latest revision with a single command:</p>
<p style="position:absolute;top:479px;left:134px;white-space:nowrap" class="ft10533">(venv)&#160;$&#160;python manage.py db upgrade</p>
<p style="position:absolute;top:500px;left:108px;white-space:nowrap" class="ft10514">Believe it or not, you have reached the end of Part I. You now have learned the basic</p>
<p style="position:absolute;top:518px;left:108px;white-space:nowrap" class="ft10514">elements necessary to build a web application with Flask, but you probably feel unsure</p>
<p style="position:absolute;top:537px;left:108px;white-space:nowrap" class="ft10514">about how all these pieces fit together to form a real application. The goal of Part II is</p>
<p style="position:absolute;top:556px;left:108px;white-space:nowrap" class="ft10514">to help with that by walking you through the development of a complete application.</p>
<p style="position:absolute;top:915px;left:538px;white-space:nowrap" class="ft1055"><b>Database Setup&#160;&#160;|&#160;&#160;85</b></p>
</div>
<!-- Page 106 -->
<a name="106"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page106-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask106.png" alt="background image"/>
</div>
<!-- Page 107 -->
<a name="107"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page107-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask107.png" alt="background image"/>
<p style="position:absolute;top:103px;left:584px;white-space:nowrap" class="ft10716"><b>PART II</b></p>
<p style="position:absolute;top:133px;left:404px;white-space:nowrap" class="ft10727"><b>Example: A Social</b></p>
<p style="position:absolute;top:173px;left:354px;white-space:nowrap" class="ft10727"><b>Blogging Application</b></p>
</div>
<!-- Page 108 -->
<a name="108"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page108-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask108.png" alt="background image"/>
</div>
<!-- Page 109 -->
<a name="109"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page109-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask109.png" alt="background image"/>
<p style="position:absolute;top:104px;left:559px;white-space:nowrap" class="ft10928"><b>CHAPTER 8</b></p>
<p style="position:absolute;top:131px;left:400px;white-space:nowrap" class="ft10911"><b>User Authentication</b></p>
<p style="position:absolute;top:345px;left:108px;white-space:nowrap" class="ft10914">Most applications need to keep track of who its users are. When users connect with the</p>
<p style="position:absolute;top:364px;left:108px;white-space:nowrap" class="ft10914">application, they&#160;<i>authenticate</i>&#160;with it, a process by which they make their identity</p>
<p style="position:absolute;top:383px;left:108px;white-space:nowrap" class="ft10915">known. Once the application knows who the user is, it can offer a customized experience.<br/>The most commonly used method of authentication requires users to provide a piece</p>
<p style="position:absolute;top:430px;left:108px;white-space:nowrap" class="ft10914">of identification (either their email or username) and a secret password. In this chapter,</p>
<p style="position:absolute;top:449px;left:108px;white-space:nowrap" class="ft10914">the complete authentication system for Flasky is created.</p>
<p style="position:absolute;top:485px;left:108px;white-space:nowrap" class="ft10918"><b>Authentication Extensions for Flask<br/></b>There are many excellent Python authentication packages, but none of them do every‐</p>
<p style="position:absolute;top:544px;left:108px;white-space:nowrap" class="ft10914">thing. The user authentication solution presented in this chapter uses several packages</p>
<p style="position:absolute;top:563px;left:108px;white-space:nowrap" class="ft10914">and provides the glue that makes them work well together. This is the list of packages</p>
<p style="position:absolute;top:582px;left:108px;white-space:nowrap" class="ft10914">that will be used:</p>
<p style="position:absolute;top:616px;left:121px;white-space:nowrap" class="ft10919">•&#160;Flask-Login: Management of user sessions for logged-in users<br/>•&#160;Werkzeug: Password hashing and verification<br/>•&#160;itsdangerous: Cryptographically secure token generation and verification</p>
<p style="position:absolute;top:700px;left:108px;white-space:nowrap" class="ft10914">In addition to authentication-specific packages, the following general-purpose exten‐</p>
<p style="position:absolute;top:718px;left:108px;white-space:nowrap" class="ft10914">sions will be used:</p>
<p style="position:absolute;top:752px;left:121px;white-space:nowrap" class="ft10919">•&#160;Flask-Mail: Sending of authentication-related emails<br/>•&#160;Flask-Bootstrap: HTML templates<br/>•&#160;Flask-WTF: Web forms</p>
<p style="position:absolute;top:915px;left:637px;white-space:nowrap" class="ft1095"><b>89</b></p>
</div>
<!-- Page 110 -->
<a name="110"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page110-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask110.png" alt="background image"/>
<p style="position:absolute;top:75px;left:108px;white-space:nowrap" class="ft11022"><b>Password Security&#160;<br/></b>The safety of user information stored in databases is often overlooked during the design</p>
<p style="position:absolute;top:136px;left:108px;white-space:nowrap" class="ft11014">of web applications. If an attacker is able to break into your server and access your user</p>
<p style="position:absolute;top:155px;left:108px;white-space:nowrap" class="ft11014">database, then you risk the security of your users, and the risk is bigger than you think.</p>
<p style="position:absolute;top:174px;left:108px;white-space:nowrap" class="ft11014">It is a known fact that most users use the same password on multiple sites, so even if</p>
<p style="position:absolute;top:193px;left:108px;white-space:nowrap" class="ft11014">you don’t store any sensitive information, access to the passwords stored in your data‐</p>
<p style="position:absolute;top:211px;left:108px;white-space:nowrap" class="ft11015">base can give the attacker access to accounts your users have on other sites.<br/>The key to storing user passwords securely in a database relies not on storing the pass‐</p>
<p style="position:absolute;top:258px;left:108px;white-space:nowrap" class="ft11014">word itself but a&#160;<i>hash</i>&#160;of it. A password hashing function takes a password as input and</p>
<p style="position:absolute;top:277px;left:108px;white-space:nowrap" class="ft11014">applies one or more cryptographic transformations to it. The result is a new sequence</p>
<p style="position:absolute;top:296px;left:108px;white-space:nowrap" class="ft11014">of characters that has no resemblance to the original password. Password hashes can be</p>
<p style="position:absolute;top:315px;left:108px;white-space:nowrap" class="ft11014">verified in place of the real passwords because hashing functions are repeatable: given</p>
<p style="position:absolute;top:334px;left:108px;white-space:nowrap" class="ft11014">the same inputs, the result is always the same.</p>
<p style="position:absolute;top:375px;left:198px;white-space:nowrap" class="ft11025">Password&#160;hashing&#160;is&#160;a&#160;complex&#160;task&#160;that&#160;is&#160;hard&#160;to&#160;get&#160;right.&#160;It&#160;is</p>
<p style="position:absolute;top:393px;left:198px;white-space:nowrap" class="ft11025">recommended&#160;that&#160;you&#160;don’t&#160;implement&#160;your&#160;own&#160;solution&#160;but&#160;in‐</p>
<p style="position:absolute;top:410px;left:198px;white-space:nowrap" class="ft11025">stead&#160;rely&#160;on&#160;reputable&#160;libraries&#160;that&#160;have&#160;been&#160;reviewed&#160;by&#160;the&#160;com‐</p>
<p style="position:absolute;top:427px;left:198px;white-space:nowrap" class="ft11025">munity.&#160;If&#160;you&#160;are&#160;interested&#160;in&#160;learning&#160;what’s&#160;involved&#160;in&#160;generat‐</p>
<p style="position:absolute;top:445px;left:198px;white-space:nowrap" class="ft11025">ing&#160;secure&#160;password&#160;hashes,&#160;the&#160;article&#160;<a href="http://bit.ly/saltedpass">Salted&#160;Password&#160;Hashing&#160;-</a></p>
<p style="position:absolute;top:462px;left:198px;white-space:nowrap" class="ft11035"><a href="http://bit.ly/saltedpass">Doing&#160;it&#160;Right</a>&#160;is&#160;a&#160;worthwhile&#160;read.</p>
<p style="position:absolute;top:505px;left:108px;white-space:nowrap" class="ft11052"><b>Hashing Passwords with Werkzeug&#160;<br/></b>Werkzeug’s&#160;<i>security</i>&#160;module conveniently implements secure password hashing. This</p>
<p style="position:absolute;top:559px;left:108px;white-space:nowrap" class="ft11014">functionality is exposed with just two functions, used in the registration and verification</p>
<p style="position:absolute;top:578px;left:108px;white-space:nowrap" class="ft11014">phases, respectively:</p>
<p style="position:absolute;top:613px;left:121px;white-space:nowrap" class="ft11014">•&#160;generate_password_hash(password, method=<i>pbkdf2:sha1</i>, salt_length=8):</p>
<p style="position:absolute;top:632px;left:135px;white-space:nowrap" class="ft11014">This function takes a plain-text password and returns the password hash as a string</p>
<p style="position:absolute;top:651px;left:135px;white-space:nowrap" class="ft11046">that can be stored in the user database. The default values for&#160;method&#160;and<br/>salt_length</p>
<p style="position:absolute;top:671px;left:217px;white-space:nowrap" class="ft11014">&#160;are sufficient for most use cases.</p>
<p style="position:absolute;top:697px;left:121px;white-space:nowrap" class="ft11014">•&#160;check_password_hash(hash, password): This function takes a password hash re‐</p>
<p style="position:absolute;top:716px;left:135px;white-space:nowrap" class="ft11046">trieved from the database and the password entered by the user. A return value of<br/>True</p>
<p style="position:absolute;top:736px;left:165px;white-space:nowrap" class="ft11014">&#160;indicates that the password is correct.</p>
<p style="position:absolute;top:771px;left:108px;white-space:nowrap" class="ft11017"><a href="Flask.html#110">Example 8-1&#160;shows the changes to the&#160;</a>User&#160;model created in&#160;<a href="Flask.html#69">Chapter 5&#160;</a>to accommodate</p>
<p style="position:absolute;top:790px;left:108px;white-space:nowrap" class="ft11014">password hashing.</p>
<p style="position:absolute;top:821px;left:108px;white-space:nowrap" class="ft11050"><i>Example 8-1. app/models.py: Password hashing in User model<br/></i><b>from</b>&#160;<b>werkzeug.security</b>&#160;<b>import</b>&#160;generate_password_hash,&#160;check_password_hash</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1105"><b>90&#160;&#160;|&#160;&#160;Chapter 8: User Authentication</b></p>
</div>
<!-- Page 111 -->
<a name="111"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page111-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask111.png" alt="background image"/>
<p style="position:absolute;top:82px;left:108px;white-space:nowrap" class="ft11168"><b>class</b>&#160;<b>User</b>(db.Model):<br/>&#160; &#160;&#160;<i># ...<br/></i>&#160; &#160;&#160;password_hash&#160;=&#160;db.Column(db.String(128))</p>
<p style="position:absolute;top:143px;left:108px;white-space:nowrap" class="ft11147">&#160; &#160;&#160;@property<br/>&#160; &#160;&#160;<b>def</b>&#160;password(self):<br/>&#160; &#160; &#160; &#160;&#160;<b>raise</b>&#160;<b>AttributeError</b>('password is not a readable attribute')</p>
<p style="position:absolute;top:205px;left:108px;white-space:nowrap" class="ft11147">&#160; &#160;&#160;@password.setter<br/>&#160; &#160;&#160;<b>def</b>&#160;password(self,&#160;password):<br/>&#160; &#160; &#160; &#160;&#160;self.password_hash&#160;=&#160;generate_password_hash(password)</p>
<p style="position:absolute;top:266px;left:108px;white-space:nowrap" class="ft11147">&#160; &#160;&#160;<b>def</b>&#160;verify_password(self,&#160;password):<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;check_password_hash(self.password_hash,&#160;password)</p>
<p style="position:absolute;top:308px;left:108px;white-space:nowrap" class="ft11146">The password hashing function is implemented through a write-only property called<br/>password</p>
<p style="position:absolute;top:327px;left:168px;white-space:nowrap" class="ft11114">. When this property is set, the setter method will call Werkzeug’s</p>
<p style="position:absolute;top:350px;left:108px;white-space:nowrap" class="ft11114">generate_password_hash()</p>
<p style="position:absolute;top:347px;left:288px;white-space:nowrap" class="ft11114">&#160;function and write the result to the&#160;password_hash&#160;field.</p>
<p style="position:absolute;top:367px;left:108px;white-space:nowrap" class="ft11114">Attempting to read the&#160;password&#160;property will return an error, as clearly the original</p>
<p style="position:absolute;top:386px;left:108px;white-space:nowrap" class="ft11146">password cannot be recovered once hashed.<br/>The&#160;verify_password&#160;method takes a password and passes it to Werkzeug’s<br/>check_password_hash()</p>
<p style="position:absolute;top:435px;left:266px;white-space:nowrap" class="ft11114">&#160;function for verification against the hashed version stored in</p>
<p style="position:absolute;top:454px;left:108px;white-space:nowrap" class="ft11114">the&#160;User&#160;model. If this method returns&#160;True, then the password is correct.</p>
<p style="position:absolute;top:496px;left:198px;white-space:nowrap" class="ft11125">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:514px;left:198px;white-space:nowrap" class="ft11125">run&#160;git&#160;checkout&#160;8a&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:602px;left:108px;white-space:nowrap" class="ft11114">The password hashing functionality is now complete and can be tested in the shell:</p>
<p style="position:absolute;top:634px;left:133px;white-space:nowrap" class="ft11123">(venv)&#160;$&#160;python manage.py shell<br/>&gt;&gt;&gt;&#160;u&#160;=&#160;User()<br/>&gt;&gt;&gt; u.password&#160;=&#160;'cat'<br/>&gt;&gt;&gt; u.password_hash<br/>'pbkdf2:sha1:1000$duxMk0OF$4735b293e397d6eeaf650aaf490fd9091f928bed'<br/>&gt;&gt;&gt; u.verify_password('cat')<br/>True<br/>&gt;&gt;&gt; u.verify_password('dog')<br/>False<br/>&gt;&gt;&gt;&#160;u2&#160;=&#160;User()<br/>&gt;&gt;&gt; u2.password&#160;=&#160;'cat'<br/>&gt;&gt;&gt; u2.password_hash<br/>'pbkdf2:sha1:1000$UjvnGeTP$875e28eb0874f44101d6b332442218f66975ee89'</p>
<p style="position:absolute;top:839px;left:108px;white-space:nowrap" class="ft11114">Note how users&#160;u&#160;and&#160;u2&#160;have completely different password hashes, even though they</p>
<p style="position:absolute;top:858px;left:108px;white-space:nowrap" class="ft11114">both use the same password. To ensure that this functionality continues to work in the</p>
<p style="position:absolute;top:915px;left:525px;white-space:nowrap" class="ft1115"><b>Password Security &#160;&#160;|&#160;&#160;91</b></p>
</div>
<!-- Page 112 -->
<a name="112"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page112-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask112.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft11214">future, the above tests can be written as unit tests that can be repeated easily. In</p>
<p style="position:absolute;top:97px;left:108px;white-space:nowrap" class="ft11217"><a href="Flask.html#112">Example 8-2</a>&#160;a new module inside the&#160;<i>tests</i>&#160;package is shown with three new tests that</p>
<p style="position:absolute;top:117px;left:108px;white-space:nowrap" class="ft11214">exercise the recent changes to the&#160;User&#160;model.</p>
<p style="position:absolute;top:149px;left:108px;white-space:nowrap" class="ft11241"><i>Example 8-2. tests/test_user_model.py: Password hashing tests<br/></i><b>import</b>&#160;<b>unittest<br/>from</b>&#160;<b>app.models</b>&#160;<b>import</b>&#160;User</p>
<p style="position:absolute;top:223px;left:108px;white-space:nowrap" class="ft11247"><b>class</b>&#160;<b>UserModelTestCase</b>(unittest.TestCase):<br/>&#160; &#160;&#160;<b>def</b>&#160;test_password_setter(self):<br/>&#160; &#160; &#160; &#160;&#160;u&#160;=&#160;User(password&#160;=&#160;'cat')<br/>&#160; &#160; &#160; &#160;&#160;self.assertTrue(u.password_hash&#160;<b>is</b>&#160;<b>not</b>&#160;None)</p>
<p style="position:absolute;top:299px;left:108px;white-space:nowrap" class="ft11247">&#160; &#160;&#160;<b>def</b>&#160;test_no_password_getter(self):<br/>&#160; &#160; &#160; &#160;&#160;u&#160;=&#160;User(password&#160;=&#160;'cat')<br/>&#160; &#160; &#160; &#160;&#160;<b>with</b>&#160;self.assertRaises(<b>AttributeError</b>):<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;u.password</p>
<p style="position:absolute;top:376px;left:108px;white-space:nowrap" class="ft11247">&#160; &#160;&#160;<b>def</b>&#160;test_password_verification(self):<br/>&#160; &#160; &#160; &#160;&#160;u&#160;=&#160;User(password&#160;=&#160;'cat')<br/>&#160; &#160; &#160; &#160;&#160;self.assertTrue(u.verify_password('cat'))<br/>&#160; &#160; &#160; &#160;&#160;self.assertFalse(u.verify_password('dog'))</p>
<p style="position:absolute;top:452px;left:108px;white-space:nowrap" class="ft11247">&#160; &#160;&#160;<b>def</b>&#160;test_password_salts_are_random(self):<br/>&#160; &#160; &#160; &#160;&#160;u&#160;=&#160;User(password='cat')<br/>&#160; &#160; &#160; &#160;&#160;u2&#160;=&#160;User(password='cat')<br/>&#160; &#160; &#160; &#160;&#160;self.assertTrue(u.password_hash&#160;!=&#160;u2.password_hash)</p>
<p style="position:absolute;top:528px;left:108px;white-space:nowrap" class="ft11222"><b>Creating an Authentication Blueprint&#160;<br/></b>Blueprints were in<a href="Flask.html#95">troduced in&#160;Chapter 7&#160;</a>as a way to define routes in the global scope</p>
<p style="position:absolute;top:588px;left:108px;white-space:nowrap" class="ft11214">after the creation of the application was moved into a factory function. The routes related</p>
<p style="position:absolute;top:608px;left:108px;white-space:nowrap" class="ft11214">to the user authentication system can be added to a&#160;auth&#160;blueprint. Using different</p>
<p style="position:absolute;top:627px;left:108px;white-space:nowrap" class="ft11214">blueprints for different sets of application functionality is a great way to keep the code</p>
<p style="position:absolute;top:646px;left:108px;white-space:nowrap" class="ft11248">neatly organized.<br/>The&#160;auth&#160;blueprint will be hosted in a Python package with the same name. The blue‐</p>
<p style="position:absolute;top:694px;left:108px;white-space:nowrap" class="ft11214">print’s package constructor creates the blueprint object and imports routes from a</p>
<p style="position:absolute;top:713px;left:108px;white-space:nowrap" class="ft11210"><i>views.py</i></p>
<p style="position:absolute;top:713px;left:160px;white-space:nowrap" class="ft11214">&#160;module. This is shown in&#160;<a href="Flask.html#112">Example 8-3.</a></p>
<p style="position:absolute;top:744px;left:108px;white-space:nowrap" class="ft11250"><i>Example 8-3. app/auth/__init__.py: Blueprint creation<br/></i><b>from</b>&#160;<b>flask</b>&#160;<b>import</b>&#160;Blueprint</p>
<p style="position:absolute;top:803px;left:108px;white-space:nowrap" class="ft11237">auth&#160;=&#160;Blueprint('auth',&#160;__name__)</p>
<p style="position:absolute;top:833px;left:108px;white-space:nowrap" class="ft11238"><b>from</b>&#160;<b>.</b>&#160;<b>import</b>&#160;views</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1125"><b>92&#160;&#160;|&#160;&#160;Chapter 8: User Authentication</b></p>
</div>
<!-- Page 113 -->
<a name="113"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page113-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask113.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft11314">The&#160;<i>app/auth/views.py</i>&#160;module, shown in&#160;<a href="Flask.html#113">Example 8-4</a>, imports the blueprint and de‐</p>
<p style="position:absolute;top:98px;left:108px;white-space:nowrap" class="ft11314">fines the routes associated with authentication using its&#160;route&#160;decorator. For now</p>
<p style="position:absolute;top:117px;left:108px;white-space:nowrap" class="ft11314">a&#160;<i>/login</i>&#160;route is added, which renders a placeholder template of the same name.</p>
<p style="position:absolute;top:149px;left:108px;white-space:nowrap" class="ft11340"><i>Example 8-4. app/auth/views.py: Blueprint routes and view functions<br/></i><b>from</b>&#160;<b>flask</b>&#160;<b>import</b>&#160;render_template<br/><b>from</b>&#160;<b>.</b>&#160;<b>import</b>&#160;auth</p>
<p style="position:absolute;top:223px;left:108px;white-space:nowrap" class="ft11347">@auth.route('/login')<br/><b>def</b>&#160;login():<br/>&#160; &#160;&#160;<b>return</b>&#160;render_template('auth/login.html')</p>
<p style="position:absolute;top:281px;left:108px;white-space:nowrap" class="ft11314">Note that the template file given to&#160;render_template()&#160;is stored inside the&#160;<i>auth</i>&#160;folder.</p>
<p style="position:absolute;top:300px;left:108px;white-space:nowrap" class="ft11314">This folder must be created inside&#160;<i>app/templates</i>, as Flask expects the templates to be</p>
<p style="position:absolute;top:318px;left:108px;white-space:nowrap" class="ft11314">relative to the application’s template folder. By storing the blueprint templates in their</p>
<p style="position:absolute;top:338px;left:108px;white-space:nowrap" class="ft11314">own folder, there is no risk of naming collisions with the&#160;main&#160;blueprint or any other</p>
<p style="position:absolute;top:357px;left:108px;white-space:nowrap" class="ft11314">blueprints that will be added in the future.</p>
<p style="position:absolute;top:397px;left:198px;white-space:nowrap" class="ft11325">Blueprints&#160;can&#160;also&#160;be&#160;configured&#160;to&#160;have&#160;their&#160;own&#160;independent</p>
<p style="position:absolute;top:414px;left:198px;white-space:nowrap" class="ft11325">folder&#160;for&#160;templates.&#160;When&#160;multiple&#160;template&#160;folders&#160;have&#160;been</p>
<p style="position:absolute;top:432px;left:198px;white-space:nowrap" class="ft11325">configured,&#160;the&#160;render_template()&#160;function&#160;searches&#160;the&#160;templates</p>
<p style="position:absolute;top:449px;left:198px;white-space:nowrap" class="ft11325">folder&#160;configured&#160;for&#160;the&#160;application&#160;first&#160;and&#160;then&#160;searches&#160;the&#160;tem‐</p>
<p style="position:absolute;top:466px;left:198px;white-space:nowrap" class="ft11325">plate&#160;folders&#160;defined&#160;by&#160;blueprints.</p>
<p style="position:absolute;top:513px;left:108px;white-space:nowrap" class="ft11314">The&#160;auth&#160;blueprint needs to be attached to the application in the&#160;create_app()&#160;factory</p>
<p style="position:absolute;top:532px;left:108px;white-space:nowrap" class="ft11314"><a href="Flask.html#113">function as shown in&#160;Example 8-5.</a></p>
<p style="position:absolute;top:564px;left:108px;white-space:nowrap" class="ft11340"><i>Example 8-5. app/__init__.py: Blueprint attachment<br/></i><b>def</b>&#160;create_app(config_name):<br/>&#160; &#160;&#160;<i># ...<br/></i>&#160; &#160;&#160;<b>from</b>&#160;<b>.auth</b>&#160;<b>import</b>&#160;auth&#160;<b>as</b>&#160;auth_blueprint<br/>&#160; &#160;&#160;app.register_blueprint(auth_blueprint,&#160;url_prefix='/auth')</p>
<p style="position:absolute;top:668px;left:108px;white-space:nowrap" class="ft1133">&#160; &#160;&#160;<b>return</b>&#160;app</p>
<p style="position:absolute;top:695px;left:108px;white-space:nowrap" class="ft11314">The&#160;url_prefix&#160;argument in the blueprint registration is optional. When used, all the</p>
<p style="position:absolute;top:714px;left:108px;white-space:nowrap" class="ft11314">routes defined in the blueprint will be registered with the given prefix, in this</p>
<p style="position:absolute;top:733px;left:108px;white-space:nowrap" class="ft11314">case&#160;<i>/auth</i>. For example, the&#160;<i>/login</i>&#160;route will be registered as&#160;<i>/auth/login</i>, and the fully</p>
<p style="position:absolute;top:752px;left:108px;white-space:nowrap" class="ft11314">qualified URL under the development web server then becomes&#160;<i>http://localhost:5000/</i></p>
<p style="position:absolute;top:772px;left:108px;white-space:nowrap" class="ft11310"><i>auth/login</i></p>
<p style="position:absolute;top:771px;left:173px;white-space:nowrap" class="ft11314">.</p>
<p style="position:absolute;top:915px;left:441px;white-space:nowrap" class="ft1135"><b>Creating an Authentication Blueprint &#160;&#160;|&#160;&#160;93</b></p>
</div>
<!-- Page 114 -->
<a name="114"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page114-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask114.png" alt="background image"/>
<p style="position:absolute;top:85px;left:198px;white-space:nowrap" class="ft11425">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:103px;left:198px;white-space:nowrap" class="ft11425">run&#160;git&#160;checkout&#160;8b&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:189px;left:108px;white-space:nowrap" class="ft11422"><b>User Authentication with Flask-Login&#160;<br/></b>When users log in to the application, their authenticated state has to be recorded so that</p>
<p style="position:absolute;top:249px;left:108px;white-space:nowrap" class="ft11414">it is remembered as they navigate through different pages. Flask-Login is a small but</p>
<p style="position:absolute;top:268px;left:108px;white-space:nowrap" class="ft11414">extremely useful extension that specializes in managing this particular aspect of a user</p>
<p style="position:absolute;top:287px;left:108px;white-space:nowrap" class="ft11415">authentication system, without being tied to a specific authentication mechanism.<br/>To begin, the extension needs to be installed in the virtual environment:</p>
<p style="position:absolute;top:346px;left:133px;white-space:nowrap" class="ft11433">(venv)&#160;$&#160;pip install flask-login</p>
<p style="position:absolute;top:374px;left:108px;white-space:nowrap" class="ft11452"><b>Preparing the User Model for Logins<br/></b>To be able to work with the application’s&#160;User&#160;model, the Flask-Login extension requires</p>
<p style="position:absolute;top:428px;left:108px;white-space:nowrap" class="ft11448">a few methods to be implemen<a href="Flask.html#114">ted by it. The required methods are shown in&#160;Table 8-1</a>.<br/><i>Table 8-1. Flask-Login user methods</i></p>
<p style="position:absolute;top:485px;left:113px;white-space:nowrap" class="ft11453"><b>Method</b></p>
<p style="position:absolute;top:485px;left:259px;white-space:nowrap" class="ft11453"><b>Description</b></p>
<p style="position:absolute;top:509px;left:113px;white-space:nowrap" class="ft11414">is_authenticated()</p>
<p style="position:absolute;top:509px;left:259px;white-space:nowrap" class="ft11430">Must&#160;return&#160;True&#160;if&#160;the&#160;user&#160;has&#160;login&#160;credentials&#160;or&#160;False&#160;otherwise.</p>
<p style="position:absolute;top:533px;left:113px;white-space:nowrap" class="ft11414">is_active()</p>
<p style="position:absolute;top:533px;left:259px;white-space:nowrap" class="ft11455">Must&#160;return&#160;True&#160;if&#160;the&#160;user&#160;is&#160;allowed&#160;to&#160;log&#160;in&#160;or&#160;False&#160;otherwise.&#160;A&#160;False&#160;return<br/>value&#160;can&#160;be&#160;used&#160;for&#160;disabled&#160;accounts.</p>
<p style="position:absolute;top:574px;left:113px;white-space:nowrap" class="ft11414">is_anonymous()</p>
<p style="position:absolute;top:573px;left:259px;white-space:nowrap" class="ft11430">Must&#160;always&#160;return&#160;False&#160;for&#160;regular&#160;users.</p>
<p style="position:absolute;top:598px;left:113px;white-space:nowrap" class="ft11414">get_id()</p>
<p style="position:absolute;top:595px;left:259px;white-space:nowrap" class="ft11430">Must&#160;return&#160;a&#160;unique&#160;identifier&#160;for&#160;the&#160;user,&#160;encoded&#160;as&#160;a&#160;Unicode&#160;string.</p>
<p style="position:absolute;top:630px;left:108px;white-space:nowrap" class="ft11414">These four methods can be implemented directly as methods in the model class, but as</p>
<p style="position:absolute;top:650px;left:108px;white-space:nowrap" class="ft11414">an easier alternative Flask-Login provides a&#160;UserMixin&#160;class that has default imple‐</p>
<p style="position:absolute;top:670px;left:108px;white-space:nowrap" class="ft11414">mentations that are appropriate for most cases. The updated&#160;User&#160;model is shown in</p>
<p style="position:absolute;top:689px;left:108px;white-space:nowrap" class="ft11417"><a href="Flask.html#114">Example 8-6</a>.</p>
<p style="position:absolute;top:721px;left:108px;white-space:nowrap" class="ft11450"><i>Example 8-6. app/models.py: Updates to the User model to support user logins<br/></i><b>from</b>&#160;<b>flask.ext.login</b>&#160;<b>import</b>&#160;UserMixin</p>
<p style="position:absolute;top:779px;left:108px;white-space:nowrap" class="ft11447"><b>class</b>&#160;<b>User</b>(UserMixin,&#160;db.Model):<br/>&#160; &#160;&#160;__tablename__&#160;=&#160;'users'<br/>&#160; &#160;&#160;id&#160;=&#160;db.Column(db.Integer,&#160;primary_key&#160;=&#160;True)<br/>&#160; &#160;&#160;email&#160;=&#160;db.Column(db.String(64),&#160;unique=True,&#160;index=True)<br/>&#160; &#160;&#160;username&#160;=&#160;db.Column(db.String(64),&#160;unique=True,&#160;index=True)<br/>&#160; &#160;&#160;password_hash&#160;=&#160;db.Column(db.String(128))<br/>&#160; &#160;&#160;role_id&#160;=&#160;db.Column(db.Integer,&#160;db.ForeignKey('roles.id'))</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1145"><b>94&#160;&#160;|&#160;&#160;Chapter 8: User Authentication</b></p>
</div>
<!-- Page 115 -->
<a name="115"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page115-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask115.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft11514">Note that an&#160;email&#160;field was also added. In this application, users will log in with their</p>
<p style="position:absolute;top:98px;left:108px;white-space:nowrap" class="ft11515">email, as they are less likely to forget their email addresses than their usernames.<br/>Flask-Login is initialized in the application factor<a href="Flask.html#115">y function, as shown in&#160;Example 8-7</a>.</p>
<p style="position:absolute;top:158px;left:108px;white-space:nowrap" class="ft11550"><i>Example 8-7. app/__init__.py: Flask-Login initialization<br/></i><b>from</b>&#160;<b>flask.ext.login</b>&#160;<b>import</b>&#160;LoginManager</p>
<p style="position:absolute;top:216px;left:108px;white-space:nowrap" class="ft11557">login_manager&#160;=&#160;LoginManager()<br/>login_manager.session_protection&#160;=&#160;'strong'<br/>login_manager.login_view&#160;=&#160;'auth.login'</p>
<p style="position:absolute;top:278px;left:108px;white-space:nowrap" class="ft11547"><b>def</b>&#160;create_app(config_name):<br/>&#160; &#160;&#160;<i># ...<br/></i>&#160; &#160;&#160;login_manager.init_app(app)<br/>&#160; &#160;&#160;<i># ...</i></p>
<p style="position:absolute;top:351px;left:108px;white-space:nowrap" class="ft11546">The&#160;session_protection&#160;attribute of the&#160;LoginManager&#160;object can be set to&#160;None,<br/>'basic'</p>
<p style="position:absolute;top:371px;left:160px;white-space:nowrap" class="ft11514">, or&#160;'strong'&#160;to provide different levels of security against user session tam‐</p>
<p style="position:absolute;top:391px;left:108px;white-space:nowrap" class="ft11514">pering. With the&#160;'strong'&#160;setting, Flask-Login will keep track of the client’s IP address</p>
<p style="position:absolute;top:410px;left:108px;white-space:nowrap" class="ft11514">and browser agent and will log the user out if it detects a change. The&#160;login_view</p>
<p style="position:absolute;top:429px;left:108px;white-space:nowrap" class="ft11514">attribute sets the endpoint for the login page. Recall that because the login route is inside</p>
<p style="position:absolute;top:448px;left:108px;white-space:nowrap" class="ft11515">a blueprint, it needs to be prefixed with the blueprint name.<br/>Finally, Flask-Login requires the application to set up a callback function that loads a</p>
<p style="position:absolute;top:495px;left:108px;white-space:nowrap" class="ft11514">user, given the identifier. This function is shown in&#160;<a href="Flask.html#115">Example 8-8.</a></p>
<p style="position:absolute;top:527px;left:108px;white-space:nowrap" class="ft11550"><i>Example 8-8. app/models.py: User loader callback function<br/></i><b>from</b>&#160;<b>.</b>&#160;<b>import</b>&#160;login_manager</p>
<p style="position:absolute;top:585px;left:108px;white-space:nowrap" class="ft11547">@login_manager.user_loader<br/><b>def</b>&#160;load_user(user_id):<br/>&#160; &#160;&#160;<b>return</b>&#160;User.query.get(int(user_id))</p>
<p style="position:absolute;top:642px;left:108px;white-space:nowrap" class="ft11514">The user loader callback function receives a user identifier as a Unicode string. The</p>
<p style="position:absolute;top:662px;left:108px;white-space:nowrap" class="ft11514">return value of the function must be the user object if available or&#160;None&#160;otherwise.</p>
<p style="position:absolute;top:698px;left:108px;white-space:nowrap" class="ft11552"><b>Protecting Routes&#160;<br/></b>To protect a route so that it can only be accessed by authenticated users, Flask-Login</p>
<p style="position:absolute;top:753px;left:108px;white-space:nowrap" class="ft11514">provides a&#160;login_required&#160;decorator. An example of its usage follows:</p>
<p style="position:absolute;top:785px;left:134px;white-space:nowrap" class="ft11538"><b>from</b>&#160;<b>flask.ext.login</b>&#160;<b>import</b>&#160;login_required</p>
<p style="position:absolute;top:815px;left:134px;white-space:nowrap" class="ft11547">@app.route('/secret')<br/>@login_required<br/><b>def</b>&#160;secret():<br/>&#160; &#160;&#160;<b>return</b>&#160;'Only authenticated users are allowed!'</p>
<p style="position:absolute;top:915px;left:441px;white-space:nowrap" class="ft1155"><b>User Authentication with Flask-Login &#160;&#160;|&#160;&#160;95</b></p>
</div>
<!-- Page 116 -->
<a name="116"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page116-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask116.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft11614">If this route is accessed by a user who is not authenticated, Flask-Login will intercept</p>
<p style="position:absolute;top:97px;left:108px;white-space:nowrap" class="ft11614">the request and send the user to the login page instead.</p>
<p style="position:absolute;top:134px;left:108px;white-space:nowrap" class="ft11652"><b>Adding a Login Form&#160;<br/></b>The login form that will be presented to users has a text field for the email address, a</p>
<p style="position:absolute;top:187px;left:108px;white-space:nowrap" class="ft11614">password field, a “remember me” checkbox, and a submit button. The Flask-WTF form</p>
<p style="position:absolute;top:206px;left:108px;white-space:nowrap" class="ft11614">class is shown in&#160;<a href="Flask.html#116">Example 8-9</a>.</p>
<p style="position:absolute;top:238px;left:108px;white-space:nowrap" class="ft11640"><i>Example 8-9. app/auth/forms.py: Login form<br/></i><b>from</b>&#160;<b>flask.ext.wtf</b>&#160;<b>import</b>&#160;Form<br/><b>from</b>&#160;<b>wtforms</b>&#160;<b>import</b>&#160;StringField,&#160;PasswordField,&#160;BooleanField,&#160;SubmitField<br/><b>from</b>&#160;<b>wtforms.validators</b>&#160;<b>import</b>&#160;Required,&#160;Email</p>
<p style="position:absolute;top:327px;left:108px;white-space:nowrap" class="ft11647"><b>class</b>&#160;<b>LoginForm</b>(Form):<br/>&#160; &#160;&#160;email&#160;=&#160;StringField('Email',&#160;validators=[Required(),&#160;Length(1,&#160;64),<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;Email()])<br/>&#160; &#160;&#160;password&#160;=&#160;PasswordField('Password',&#160;validators=[Required()])<br/>&#160; &#160;&#160;remember_me&#160;=&#160;BooleanField('Keep me logged in')<br/>&#160; &#160;&#160;submit&#160;=&#160;SubmitField('Log In')</p>
<p style="position:absolute;top:431px;left:108px;white-space:nowrap" class="ft11614">The email field takes advantage of the&#160;Length()&#160;and&#160;Email()&#160;validators provided by</p>
<p style="position:absolute;top:451px;left:108px;white-space:nowrap" class="ft11646">WTForms. The&#160;PasswordField&#160;class represents an&#160;&lt;input&gt;&#160;element with<br/>type=&#34;password&#34;</p>
<p style="position:absolute;top:471px;left:220px;white-space:nowrap" class="ft11614">. The&#160;BooleanField&#160;class represents a checkbox.</p>
<p style="position:absolute;top:499px;left:108px;white-space:nowrap" class="ft11614">The template associated with the login page is stored in&#160;<i>auth/login.html</i>. This template</p>
<p style="position:absolute;top:518px;left:108px;white-space:nowrap" class="ft11614">just needs to render the form using Flask-Bootstrap’s&#160;wtf.quick_form()&#160;macro.</p>
<p style="position:absolute;top:537px;left:108px;white-space:nowrap" class="ft11615"><a href="Flask.html#117">Figure 8-1</a>&#160;shows the login form rendered by the web browser.<br/>The navigation bar in the&#160;<i>base.html</i>&#160;template uses a Jinja2 conditional to display “Sign</p>
<p style="position:absolute;top:584px;left:108px;white-space:nowrap" class="ft11614">In” or “Sign Out” links depending on the logged in state of the current user. The con‐</p>
<p style="position:absolute;top:603px;left:108px;white-space:nowrap" class="ft11614">ditional is shown in&#160;<a href="Flask.html#116">Example 8-10.</a></p>
<p style="position:absolute;top:635px;left:108px;white-space:nowrap" class="ft11623"><i>Example 8-10. app/templates/base.html: Sign In and Sign Out navigation bar links<br/></i><b>&lt;ul</b>&#160;class=&#34;nav navbar-nav navbar-right&#34;<b>&gt;<br/></b>&#160; &#160; {% if current_user.is_authenticated() %}<br/>&#160; &#160;&#160;<b>&lt;li&gt;&lt;a</b>&#160;href=&#34;{{ url_for('auth.logout') }}&#34;<b>&gt;</b>Sign Out<b>&lt;/a&gt;&lt;/li&gt;<br/></b>&#160; &#160; {% else %}<br/>&#160; &#160;&#160;<b>&lt;li&gt;&lt;a</b>&#160;href=&#34;{{ url_for('auth.login') }}&#34;<b>&gt;</b>Sign In<b>&lt;/a&gt;&lt;/li&gt;<br/></b>&#160; &#160; {% endif %}<br/><b>&lt;/ul&gt;</b></p>
<p style="position:absolute;top:782px;left:108px;white-space:nowrap" class="ft11614">The&#160;current_user&#160;variable used in the conditional is defined by Flask-Login and is</p>
<p style="position:absolute;top:801px;left:108px;white-space:nowrap" class="ft11614">automatically available to view functions and templates. This variable contains the user</p>
<p style="position:absolute;top:820px;left:108px;white-space:nowrap" class="ft11614">currently logged in, or a proxy anonymous user object if the user is not logged in.</p>
<p style="position:absolute;top:839px;left:108px;white-space:nowrap" class="ft11614">Anonymous user objects respond to the&#160;is_authenticated()&#160;method with&#160;False, so</p>
<p style="position:absolute;top:858px;left:108px;white-space:nowrap" class="ft11614">this is a convenient way to know whether the current user is logged in.</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1165"><b>96&#160;&#160;|&#160;&#160;Chapter 8: User Authentication</b></p>
</div>
<!-- Page 117 -->
<a name="117"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page117-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask117.png" alt="background image"/>
<p style="position:absolute;top:459px;left:108px;white-space:nowrap" class="ft11710"><i>Figure 8-1. Login form</i></p>
<p style="position:absolute;top:493px;left:108px;white-space:nowrap" class="ft11752"><b>Signing Users In<br/></b>The implementation of the&#160;login()&#160;view function is shown in&#160;<a href="Flask.html#117">Example 8-11.</a></p>
<p style="position:absolute;top:560px;left:108px;white-space:nowrap" class="ft11740"><i>Example 8-11. app/auth/views.py: Sign In route<br/></i><b>from</b>&#160;<b>flask</b>&#160;<b>import</b>&#160;render_template,&#160;redirect,&#160;request,&#160;url_for,&#160;flash<br/><b>from</b>&#160;<b>flask.ext.login</b>&#160;<b>import</b>&#160;login_user<br/><b>from</b>&#160;<b>.</b>&#160;<b>import</b>&#160;auth<br/><b>from</b>&#160;<b>..models</b>&#160;<b>import</b>&#160;User<br/><b>from</b>&#160;<b>.forms</b>&#160;<b>import</b>&#160;LoginForm</p>
<p style="position:absolute;top:680px;left:108px;white-space:nowrap" class="ft11747">@auth.route('/login',&#160;methods=['GET',&#160;'POST'])<br/><b>def</b>&#160;login():<br/>&#160; &#160;&#160;form&#160;=&#160;LoginForm()<br/>&#160; &#160;&#160;<b>if</b>&#160;form.validate_on_submit():<br/>&#160; &#160; &#160; &#160;&#160;user&#160;=&#160;User.query.filter_by(email=form.email.data).first()<br/>&#160; &#160; &#160; &#160;&#160;<b>if</b>&#160;user&#160;<b>is</b>&#160;<b>not</b>&#160;None&#160;<b>and</b>&#160;user.verify_password(form.password.data):<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;login_user(user,&#160;form.remember_me.data)<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;redirect(request.args.get('next')&#160;<b>or</b>&#160;url_for('main.index'))<br/>&#160; &#160; &#160; &#160;&#160;flash('Invalid username or password.')<br/>&#160; &#160;&#160;<b>return</b>&#160;render_template('auth/login.html',&#160;form=form)</p>
<p style="position:absolute;top:845px;left:108px;white-space:nowrap" class="ft11714">The view function creates a&#160;LoginForm&#160;object and uses it like the simple form in&#160;<a href="Flask.html#57">Chap‐</a></p>
<p style="position:absolute;top:865px;left:108px;white-space:nowrap" class="ft11717"><a href="Flask.html#57">ter 4</a>. When the request is of type&#160;GET, the view function just renders the template, which</p>
<p style="position:absolute;top:915px;left:441px;white-space:nowrap" class="ft1175"><b>User Authentication with Flask-Login &#160;&#160;|&#160;&#160;97</b></p>
</div>
<!-- Page 118 -->
<a name="118"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page118-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask118.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft11846">in turn displays the form. When the form is submitted in a&#160;POST&#160;request Flask-WTF’s<br/>validate_on_submit()</p>
<p style="position:absolute;top:99px;left:258px;white-space:nowrap" class="ft11814">&#160;function validates the form variables, and then attempts to log</p>
<p style="position:absolute;top:118px;left:108px;white-space:nowrap" class="ft11846">the user in.<br/>To log a user in, the function begins by loading the user from the database using the<br/>email</p>
<p style="position:absolute;top:166px;left:145px;white-space:nowrap" class="ft11814">&#160;provided with the form. If a user with the given email address exists, then its</p>
<p style="position:absolute;top:189px;left:108px;white-space:nowrap" class="ft11814">verify_password()</p>
<p style="position:absolute;top:186px;left:235px;white-space:nowrap" class="ft11814">&#160;method is called with the password that also came with the form.</p>
<p style="position:absolute;top:205px;left:108px;white-space:nowrap" class="ft11814">If the password is valid, Flask-Login’s&#160;login_user()&#160;function is invoked to record the</p>
<p style="position:absolute;top:225px;left:108px;white-space:nowrap" class="ft11814">user as logged in for the user session. The&#160;login_user()&#160;function takes the user to log</p>
<p style="position:absolute;top:244px;left:108px;white-space:nowrap" class="ft11814">in and an optional “remember me” Boolean, which was also submitted with the form.</p>
<p style="position:absolute;top:264px;left:108px;white-space:nowrap" class="ft11814">A value of&#160;False&#160;for this argument causes the user session to expire when the browser</p>
<p style="position:absolute;top:284px;left:108px;white-space:nowrap" class="ft11814">window is closed, so the user will have to log in again next time. A value of&#160;True&#160;causes</p>
<p style="position:absolute;top:303px;left:108px;white-space:nowrap" class="ft11814">a long-term cookie to be set in the user’s browser and with that the user session can be</p>
<p style="position:absolute;top:322px;left:108px;white-space:nowrap" class="ft11848">restored.<br/>In accordance with the Post/Redirect/Get pattern discussed in&#160;<a href="Flask.html#57">Chapter 4</a>, the&#160;POST</p>
<p style="position:absolute;top:369px;left:108px;white-space:nowrap" class="ft11814">request that submitted the login credentials ends with a redirect, but there are two</p>
<p style="position:absolute;top:388px;left:108px;white-space:nowrap" class="ft11814">possible URL destinations. If the login form was presented to the user to prevent un‐</p>
<p style="position:absolute;top:407px;left:108px;white-space:nowrap" class="ft11846">authorized access to a protected URL, then Flask-Login saved the original URL in the<br/>next</p>
<p style="position:absolute;top:427px;left:138px;white-space:nowrap" class="ft11814">&#160;query string argument, which can be accessed from the&#160;request.args&#160;dictionary.</p>
<p style="position:absolute;top:447px;left:108px;white-space:nowrap" class="ft11814">If the&#160;next&#160;query string argument is not available, a redirect to the home page is issued</p>
<p style="position:absolute;top:466px;left:108px;white-space:nowrap" class="ft11814">instead. If the email or the password provided by the user are invalid, a flash message</p>
<p style="position:absolute;top:485px;left:108px;white-space:nowrap" class="ft11814">is set and the form is rendered again for the user to retry.</p>
<p style="position:absolute;top:524px;left:198px;white-space:nowrap" class="ft11825">On&#160;a&#160;production&#160;server,&#160;the&#160;login&#160;route&#160;must&#160;be&#160;made&#160;available&#160;over</p>
<p style="position:absolute;top:541px;left:198px;white-space:nowrap" class="ft11825">secure&#160;HTTP&#160;so&#160;that&#160;the&#160;form&#160;data&#160;transmitted&#160;to&#160;the&#160;server&#160;is&#160;en‐</p>
<p style="position:absolute;top:559px;left:198px;white-space:nowrap" class="ft11825">crypted.&#160;Without&#160;secure&#160;HTTP,&#160;the&#160;login&#160;credentials&#160;can&#160;be&#160;intercep‐</p>
<p style="position:absolute;top:576px;left:198px;white-space:nowrap" class="ft11825">ted&#160;during&#160;transit,&#160;defeating&#160;any&#160;efforts&#160;put&#160;into&#160;securing&#160;passwords</p>
<p style="position:absolute;top:593px;left:198px;white-space:nowrap" class="ft11825">in&#160;the&#160;server.</p>
<p style="position:absolute;top:639px;left:108px;white-space:nowrap" class="ft11814">The login template needs to be updated to render the form. These changes are shown</p>
<p style="position:absolute;top:658px;left:108px;white-space:nowrap" class="ft11814"><a href="Flask.html#118">in&#160;Example 8-12</a>.</p>
<p style="position:absolute;top:689px;left:108px;white-space:nowrap" class="ft11823"><i>Example 8-12. app/templates/auth/login.html: Render login form<br/></i>{% extends &#34;base.html&#34; %}<br/>{% import &#34;bootstrap/wtf.html&#34; as wtf %}</p>
<p style="position:absolute;top:763px;left:108px;white-space:nowrap" class="ft1183">{% block title %}Flasky - Login{% endblock %}</p>
<p style="position:absolute;top:794px;left:108px;white-space:nowrap" class="ft11866">{% block page_content %}<br/><b>&lt;div</b>&#160;class=&#34;page-header&#34;<b>&gt;<br/></b>&#160; &#160;&#160;<b>&lt;h1&gt;</b>Login<b>&lt;/h1&gt;<br/>&lt;/div&gt;<br/>&lt;div</b>&#160;class=&#34;col-md-4&#34;<b>&gt;<br/></b>&#160; &#160; {{ wtf.quick_form(form) }}</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1185"><b>98&#160;&#160;|&#160;&#160;Chapter 8: User Authentication</b></p>
</div>
<!-- Page 119 -->
<a name="119"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft11980{font-size:11px;line-height:20px;font-family:Times;color:#231f20;}
-->
</style>
<div id="page119-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask119.png" alt="background image"/>
<p style="position:absolute;top:82px;left:108px;white-space:nowrap" class="ft11966"><b>&lt;/div&gt;<br/></b>{% endblock %}</p>
<p style="position:absolute;top:126px;left:108px;white-space:nowrap" class="ft11958"><b>Signing Users Out<br/></b>The implementa<a href="Flask.html#119">tion of the logout route is shown in&#160;Example 8-13.</a></p>
<p style="position:absolute;top:191px;left:108px;white-space:nowrap" class="ft11950"><i>Example 8-13. app/auth/views.py: Sign Out route<br/></i><b>from</b>&#160;<b>flask.ext.login</b>&#160;<b>import</b>&#160;logout_user,&#160;login_required</p>
<p style="position:absolute;top:250px;left:108px;white-space:nowrap" class="ft11947">@auth.route('/logout')<br/>@login_required<br/><b>def</b>&#160;logout():<br/>&#160; &#160;&#160;logout_user()<br/>&#160; &#160;&#160;flash('You have been logged out.')<br/>&#160; &#160;&#160;<b>return</b>&#160;redirect(url_for('main.index'))</p>
<p style="position:absolute;top:354px;left:108px;white-space:nowrap" class="ft11914">To log a user out, Flask-Login’s&#160;logout_user()&#160;function is called to remove and reset</p>
<p style="position:absolute;top:372px;left:108px;white-space:nowrap" class="ft11914">the user session. The logout is completed with a flash message that confirms the action</p>
<p style="position:absolute;top:391px;left:108px;white-space:nowrap" class="ft11914">and a redirect to the home page.</p>
<p style="position:absolute;top:433px;left:198px;white-space:nowrap" class="ft11925">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:451px;left:198px;white-space:nowrap" class="ft11925">run&#160;git&#160;checkout&#160;8c&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:468px;left:198px;white-space:nowrap" class="ft11931">This&#160;update&#160;contains&#160;a&#160;database&#160;migration,&#160;so&#160;remember&#160;to&#160;run<br/>python&#160;manage.py&#160;db&#160;upgrade</p>
<p style="position:absolute;top:486px;left:390px;white-space:nowrap" class="ft11925">&#160;after&#160;you&#160;check&#160;out&#160;the&#160;code.&#160;To</p>
<p style="position:absolute;top:504px;left:198px;white-space:nowrap" class="ft11980">ensure&#160;that&#160;you&#160;have&#160;all&#160;the&#160;dependencies&#160;installed,&#160;also&#160;run&#160;pip<br/>install&#160;-r&#160;requirements.txt</p>
<p style="position:absolute;top:523px;left:383px;white-space:nowrap" class="ft11925">.</p>
<p style="position:absolute;top:565px;left:108px;white-space:nowrap" class="ft11958"><b>Testing Logins<br/></b>To verify that the login functionality is working, the home page can be updated to greet</p>
<p style="position:absolute;top:618px;left:108px;white-space:nowrap" class="ft11914">the logged-in user by name. The template section that generates the greeting is shown</p>
<p style="position:absolute;top:637px;left:108px;white-space:nowrap" class="ft11914"><a href="Flask.html#119">in&#160;Example 8-14</a>.</p>
<p style="position:absolute;top:669px;left:108px;white-space:nowrap" class="ft11923"><i>Example 8-14. app/templates/index.html: Greet the logged-in user<br/></i>Hello,<br/>{% if current_user.is_authenticated() %}<br/>&#160; &#160; {{ current_user.username }}<br/>{% else %}<br/>&#160; &#160; Stranger<br/>{% endif %}!</p>
<p style="position:absolute;top:800px;left:108px;white-space:nowrap" class="ft11914">In this template once again&#160;current_user.is_authenticated()&#160;is used to determine</p>
<p style="position:absolute;top:819px;left:108px;white-space:nowrap" class="ft11915">whether the user is logged in.<br/>Because no user registration functionality has been built, a new user can be registered</p>
<p style="position:absolute;top:866px;left:108px;white-space:nowrap" class="ft11914">from the shell:</p>
<p style="position:absolute;top:915px;left:441px;white-space:nowrap" class="ft1195"><b>User Authentication with Flask-Login &#160;&#160;|&#160;&#160;99</b></p>
</div>
<!-- Page 120 -->
<a name="120"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page120-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask120.png" alt="background image"/>
<p style="position:absolute;top:82px;left:134px;white-space:nowrap" class="ft12047">(venv)&#160;$&#160;python&#160;manage.py&#160;shell<br/>&gt;&gt;&gt;&#160;u&#160;=&#160;User(email='john@example.com',&#160;username='john',&#160;password='cat')<br/>&gt;&gt;&gt;&#160;db.session.add(u)<br/>&gt;&gt;&gt;&#160;db.session.commit()</p>
<p style="position:absolute;top:149px;left:108px;white-space:nowrap" class="ft12014">The user created previously can now log in.&#160;<a href="Flask.html#120">Figure 8-2&#160;shows the a</a>pplication home page</p>
<p style="position:absolute;top:168px;left:108px;white-space:nowrap" class="ft12014">with the user logged in.</p>
<p style="position:absolute;top:576px;left:108px;white-space:nowrap" class="ft12010"><i>Figure 8-2. Home page after successful login</i></p>
<p style="position:absolute;top:611px;left:108px;white-space:nowrap" class="ft12018"><b>New User Registration<br/></b>When new users want to become members of the application, they must register with</p>
<p style="position:absolute;top:670px;left:108px;white-space:nowrap" class="ft12014">it so that they are known and can log in. A link in the login page will send them to a</p>
<p style="position:absolute;top:689px;left:108px;white-space:nowrap" class="ft12014">registration page, where they can enter their email address, username, and password.</p>
<p style="position:absolute;top:725px;left:108px;white-space:nowrap" class="ft12058"><b>Adding a User Registration Form<br/></b>The form that will be used in the registration page asks the user to enter an email address,</p>
<p style="position:absolute;top:777px;left:108px;white-space:nowrap" class="ft12014"><a href="Flask.html#120">username, and password. This form is shown in&#160;Example 8-15.</a></p>
<p style="position:absolute;top:809px;left:108px;white-space:nowrap" class="ft12040"><i>Example 8-15. app/auth/forms.py: User registration form<br/></i><b>from</b>&#160;<b>flask.ext.wtf</b>&#160;<b>import</b>&#160;Form<br/><b>from</b>&#160;<b>wtforms</b>&#160;<b>import</b>&#160;StringField,&#160;PasswordField,&#160;BooleanField,&#160;SubmitField<br/><b>from</b>&#160;<b>wtforms.validators</b>&#160;<b>import</b>&#160;Required,&#160;Length,&#160;Email,&#160;Regexp,&#160;EqualTo</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1205"><b>100&#160;&#160;|&#160;&#160;Chapter 8: User Authentication</b></p>
</div>
<!-- Page 121 -->
<a name="121"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page121-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask121.png" alt="background image"/>
<p style="position:absolute;top:82px;left:108px;white-space:nowrap" class="ft12140"><b>from</b>&#160;<b>wtforms</b>&#160;<b>import</b>&#160;ValidationError<br/><b>from</b>&#160;<b>..models</b>&#160;<b>import</b>&#160;User</p>
<p style="position:absolute;top:128px;left:108px;white-space:nowrap" class="ft12147"><b>class</b>&#160;<b>RegistrationForm</b>(Form):<br/>&#160; &#160;&#160;email&#160;=&#160;StringField('Email',&#160;validators=[Required(),&#160;Length(1,&#160;64),<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;Email()])<br/>&#160; &#160;&#160;username&#160;=&#160;StringField('Username',&#160;validators=[<br/>&#160; &#160; &#160; &#160;&#160;Required(),&#160;Length(1,&#160;64),&#160;Regexp('^[A-Za-z][A-Za-z0-9_.]*$',&#160;0,<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;'Usernames must have only letters, '<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;'numbers, dots or underscores')])<br/>&#160; &#160;&#160;password&#160;=&#160;PasswordField('Password',&#160;validators=[<br/>&#160; &#160; &#160; &#160;&#160;Required(),&#160;EqualTo('password2',&#160;message='Passwords must match.')])<br/>&#160; &#160;&#160;password2&#160;=&#160;PasswordField('Confirm password',&#160;validators=[Required()])<br/>&#160; &#160;&#160;submit&#160;=&#160;SubmitField('Register')</p>
<p style="position:absolute;top:312px;left:108px;white-space:nowrap" class="ft12147">&#160; &#160;&#160;<b>def</b>&#160;validate_email(self,&#160;field):<br/>&#160; &#160; &#160; &#160;&#160;<b>if</b>&#160;User.query.filter_by(email=field.data).first():<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>raise</b>&#160;ValidationError('Email already registered.')</p>
<p style="position:absolute;top:373px;left:108px;white-space:nowrap" class="ft12147">&#160; &#160;&#160;<b>def</b>&#160;validate_username(self,&#160;field):<br/>&#160; &#160; &#160; &#160;&#160;<b>if</b>&#160;User.query.filter_by(username=field.data).first():<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>raise</b>&#160;ValidationError('Username already in use.')</p>
<p style="position:absolute;top:431px;left:108px;white-space:nowrap" class="ft12114">This form uses the&#160;Regexp&#160;validator from WTForms to ensure that the&#160;username&#160;field</p>
<p style="position:absolute;top:450px;left:108px;white-space:nowrap" class="ft12114">contains letters, numbers, underscores, and dots only. The two arguments to the vali‐</p>
<p style="position:absolute;top:469px;left:108px;white-space:nowrap" class="ft12114">dator that follow the regular expression are the regular expression flags and the error</p>
<p style="position:absolute;top:488px;left:108px;white-space:nowrap" class="ft12115">message to display on failure.&#160;<br/>The password is entered twice as a safety measure, but this step makes it necessary to</p>
<p style="position:absolute;top:534px;left:108px;white-space:nowrap" class="ft12114">validate that the two password fields have the same content, which is done with another</p>
<p style="position:absolute;top:554px;left:108px;white-space:nowrap" class="ft12114">validator from WTForms called&#160;EqualTo. This validator is attached to one of the pass‐</p>
<p style="position:absolute;top:573px;left:108px;white-space:nowrap" class="ft12115">word fields with the name of the other field given as an argument.<br/>This form also has two custom validators implemented as methods. When a form de‐</p>
<p style="position:absolute;top:621px;left:108px;white-space:nowrap" class="ft12114">fines a method with the prefix&#160;validate_&#160;followed by the name of a field, the method</p>
<p style="position:absolute;top:640px;left:108px;white-space:nowrap" class="ft12114">is invoked in addition to any regularly defined validators. In this case, the custom val‐</p>
<p style="position:absolute;top:660px;left:108px;white-space:nowrap" class="ft12114">idators for&#160;email&#160;and&#160;username&#160;ensure that the values given are not duplicates. The</p>
<p style="position:absolute;top:679px;left:108px;white-space:nowrap" class="ft12114">custom validators indicate a validation error by throwing a&#160;ValidationError&#160;exception</p>
<p style="position:absolute;top:698px;left:108px;white-space:nowrap" class="ft12115">with the text of the error message as argument.<br/>The template that presents this format is called&#160;<i>/templates/auth/register.html</i>. Like the</p>
<p style="position:absolute;top:746px;left:108px;white-space:nowrap" class="ft12114">login template, this one also renders the form with&#160;wtf.quick_form(). The registration</p>
<p style="position:absolute;top:765px;left:108px;white-space:nowrap" class="ft12114">page is shown in&#160;<a href="Flask.html#121">Figure 8-3</a>.</p>
<p style="position:absolute;top:915px;left:503px;white-space:nowrap" class="ft1215"><b>New User Registration&#160;&#160;|&#160;&#160;101</b></p>
</div>
<!-- Page 122 -->
<a name="122"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page122-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask122.png" alt="background image"/>
<p style="position:absolute;top:517px;left:108px;white-space:nowrap" class="ft12210"><i>Figure 8-3. New user registration form</i></p>
<p style="position:absolute;top:553px;left:108px;white-space:nowrap" class="ft12214">The registration page needs to be linked from the login page so that users who don’t</p>
<p style="position:absolute;top:572px;left:108px;white-space:nowrap" class="ft12214">have an account can easily find it. This change is shown in&#160;<a href="Flask.html#122">Example 8-16.</a></p>
<p style="position:absolute;top:604px;left:108px;white-space:nowrap" class="ft12266"><i>Example 8-16. app/templates/auth/login.html: Link to the registration page<br/></i><b>&lt;p&gt;<br/></b>&#160; &#160; New user?<br/>&#160; &#160;&#160;<b>&lt;a</b>&#160;href=&#34;{{ url_for('auth.register') }}&#34;<b>&gt;<br/></b>&#160; &#160; &#160; &#160; Click here to register<br/>&#160; &#160;&#160;<b>&lt;/a&gt;<br/>&lt;/p&gt;</b></p>
<p style="position:absolute;top:736px;left:108px;white-space:nowrap" class="ft12258"><b>Registering New Users<br/></b>Handling user registrations does not present any big surprises. When the registration</p>
<p style="position:absolute;top:789px;left:108px;white-space:nowrap" class="ft12214">form is submitted and validated, a new user is added to the database using the user-</p>
<p style="position:absolute;top:808px;left:108px;white-space:nowrap" class="ft12214">provided information. The view function that performs this task is shown in</p>
<p style="position:absolute;top:826px;left:108px;white-space:nowrap" class="ft12217"><a href="Flask.html#122">Example 8-17.</a></p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1225"><b>102&#160;&#160;|&#160;&#160;Chapter 8: User Authentication</b></p>
</div>
<!-- Page 123 -->
<a name="123"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page123-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask123.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft12347"><i>Example 8-17. app/auth/views.py: User registration route<br/></i>@auth.route('/register',&#160;methods=['GET',&#160;'POST'])<br/><b>def</b>&#160;register():<br/>&#160; &#160;&#160;form&#160;=&#160;RegistrationForm()<br/>&#160; &#160;&#160;<b>if</b>&#160;form.validate_on_submit():<br/>&#160; &#160; &#160; &#160;&#160;user&#160;=&#160;User(email=form.email.data,<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;username=form.username.data,<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;password=form.password.data)<br/>&#160; &#160; &#160; &#160;&#160;db.session.add(user)<br/>&#160; &#160; &#160; &#160;&#160;flash('You can now login.')<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;redirect(url_for('auth.login'))<br/>&#160; &#160;&#160;<b>return</b>&#160;render_template('auth/register.html',&#160;form=form)</p>
<p style="position:absolute;top:294px;left:198px;white-space:nowrap" class="ft12325">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:312px;left:198px;white-space:nowrap" class="ft12325">run&#160;git&#160;checkout&#160;8d&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:396px;left:108px;white-space:nowrap" class="ft12318"><b>Account Confirmation<br/></b>For certain types of applications, it is important to ensure that the user information</p>
<p style="position:absolute;top:456px;left:108px;white-space:nowrap" class="ft12314">provided during registration is valid. A common requirement is to ensure that the user</p>
<p style="position:absolute;top:475px;left:108px;white-space:nowrap" class="ft12315">can be reached through the provided email address.<br/>To validate the email address, applications send a confirmation email to users imme‐</p>
<p style="position:absolute;top:521px;left:108px;white-space:nowrap" class="ft12314">diately after they register. The new account is initially marked as unconfirmed until the</p>
<p style="position:absolute;top:540px;left:108px;white-space:nowrap" class="ft12314">instructions in the email are followed, which proves that the user can be reached. The</p>
<p style="position:absolute;top:559px;left:108px;white-space:nowrap" class="ft12314">account confirmation procedure usually involves clicking a specially crafted URL link</p>
<p style="position:absolute;top:578px;left:108px;white-space:nowrap" class="ft12314">that includes a confirmation token.</p>
<p style="position:absolute;top:614px;left:108px;white-space:nowrap" class="ft12358"><b>Generating Confirmation Tokens with itsdangerous<br/></b>The simplest account confirmation link would be a URL with the format&#160;<i>http://</i></p>
<p style="position:absolute;top:667px;left:108px;white-space:nowrap" class="ft12310"><i>www.example.com/auth/confirm/&lt;id&gt;</i></p>
<p style="position:absolute;top:666px;left:348px;white-space:nowrap" class="ft12314">&#160;included in the confirmation email, where&#160;<i>id</i>&#160;is</p>
<p style="position:absolute;top:686px;left:108px;white-space:nowrap" class="ft12314">the numeric&#160;id&#160;assigned to the user in the database. When the user clicks the link, the</p>
<p style="position:absolute;top:706px;left:108px;white-space:nowrap" class="ft12314">view function that handles this route receives the user&#160;id&#160;to confirm as an argument</p>
<p style="position:absolute;top:725px;left:108px;white-space:nowrap" class="ft12315">and can easily update the confirmed status of the user.<br/>But this is obviously not a secure implementation, as any user who figures out the format</p>
<p style="position:absolute;top:772px;left:108px;white-space:nowrap" class="ft12314">of the confirmation links will be able to confirm arbitrary accounts just by sending</p>
<p style="position:absolute;top:791px;left:108px;white-space:nowrap" class="ft12314">random numbers in the URL. The idea is to replace the&#160;<i>id</i>&#160;in the URL with a token that</p>
<p style="position:absolute;top:809px;left:108px;white-space:nowrap" class="ft12315">contains the same information securely encrypted.<br/>If you recall the discussion on user sessions in&#160;<a href="Flask.html#57">Chapter 4</a>, Flask uses cryptographically</p>
<p style="position:absolute;top:856px;left:108px;white-space:nowrap" class="ft12314">signed cookies to protect the content of user sessions against tampering. These secure</p>
<p style="position:absolute;top:915px;left:505px;white-space:nowrap" class="ft1235"><b>Account Confirmation&#160;&#160;|&#160;&#160;103</b></p>
</div>
<!-- Page 124 -->
<a name="124"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page124-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask124.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft12414">cookies are signed by a package called&#160;<i>itsdangerous</i>. The same idea can be applied to</p>
<p style="position:absolute;top:97px;left:108px;white-space:nowrap" class="ft12415">confirmation tokens.&#160;<br/>The following is a short shell session that shows how itsdangerous can generate a secure</p>
<p style="position:absolute;top:145px;left:108px;white-space:nowrap" class="ft12414">token that contains a user&#160;id&#160;inside:</p>
<p style="position:absolute;top:177px;left:133px;white-space:nowrap" class="ft12440">(venv)&#160;$&#160;python&#160;manage.py&#160;shell<br/>&gt;&gt;&gt;&#160;<b>from</b>&#160;<b>manage</b>&#160;<b>import</b>&#160;app<br/>&gt;&gt;&gt;&#160;<b>from</b>&#160;<b>itsdangerous</b>&#160;<b>import</b>&#160;TimedJSONWebSignatureSerializer&#160;<b>as</b>&#160;Serializer<br/>&gt;&gt;&gt;&#160;s&#160;=&#160;Serializer(app.config['SECRET_KEY'],&#160;expires_in&#160;=&#160;3600)<br/>&gt;&gt;&gt;&#160;token&#160;=&#160;s.dumps({&#160;'confirm':&#160;23&#160;})<br/>&gt;&gt;&gt;&#160;token<br/>'eyJhbGciOiJIUzI1NiIsImV4cCI6MTM4MTcxODU1OCwiaWF0IjoxMzgxNzE0OTU4fQ.ey ...'<br/>&gt;&gt;&gt;&#160;data&#160;=&#160;s.loads(token)<br/>&gt;&gt;&gt;&#160;data<br/>{u'confirm':&#160;23}</p>
<p style="position:absolute;top:335px;left:108px;white-space:nowrap" class="ft12446">Itsdangerous provides several types of token generators. Among them, the class<br/>TimedJSONWebSignatureSerializer</p>
<p style="position:absolute;top:355px;left:340px;white-space:nowrap" class="ft12414">&#160;generates JSON Web Signatures (JWS) with a</p>
<p style="position:absolute;top:374px;left:108px;white-space:nowrap" class="ft12414">time expiration. The constructor of this class takes an encryption key as argument,</p>
<p style="position:absolute;top:394px;left:108px;white-space:nowrap" class="ft12448">which in a Flask application can be the configured&#160;SECRET_KEY.<br/>The&#160;dumps()&#160;method generates a cryptographic signature for the data given as an ar‐</p>
<p style="position:absolute;top:441px;left:108px;white-space:nowrap" class="ft12446">gument and then serializes the data plus the signature as a convenient token string. The<br/>expires_in</p>
<p style="position:absolute;top:461px;left:183px;white-space:nowrap" class="ft12414">&#160;argument sets an expiration time for the token expressed in seconds.</p>
<p style="position:absolute;top:490px;left:108px;white-space:nowrap" class="ft12414">To decode the token, the serializer object provides a&#160;loads()&#160;method that takes the</p>
<p style="position:absolute;top:509px;left:108px;white-space:nowrap" class="ft12414">token as its only argument. The function verifies the signature and the expiration time</p>
<p style="position:absolute;top:529px;left:108px;white-space:nowrap" class="ft12414">and, if found valid, it returns the original data. When the&#160;loads()&#160;method is given an</p>
<p style="position:absolute;top:548px;left:108px;white-space:nowrap" class="ft12448">invalid token or a valid token that is expired, an exception is thrown.<br/>Token generation and verification using this functionality can be added to the&#160;User</p>
<p style="position:absolute;top:595px;left:108px;white-space:nowrap" class="ft12414"><a href="Flask.html#124">model. The changes are shown in&#160;Example 8-18.</a></p>
<p style="position:absolute;top:627px;left:108px;white-space:nowrap" class="ft12440"><i>Example 8-18. app/models.py: User account confirmation<br/></i><b>from</b>&#160;<b>itsdangerous</b>&#160;<b>import</b>&#160;TimedJSONWebSignatureSerializer&#160;<b>as</b>&#160;Serializer<br/><b>from</b>&#160;<b>flask</b>&#160;<b>import</b>&#160;current_app<br/><b>from</b>&#160;<b>.</b>&#160;<b>import</b>&#160;db</p>
<p style="position:absolute;top:716px;left:108px;white-space:nowrap" class="ft12468"><b>class</b>&#160;<b>User</b>(UserMixin,&#160;db.Model):<br/>&#160; &#160;&#160;<i># ...<br/></i>&#160; &#160;&#160;confirmed&#160;=&#160;db.Column(db.Boolean,&#160;default=False)</p>
<p style="position:absolute;top:777px;left:108px;white-space:nowrap" class="ft12447">&#160; &#160;&#160;<b>def</b>&#160;generate_confirmation_token(self,&#160;expiration=3600):<br/>&#160; &#160; &#160; &#160;&#160;s&#160;=&#160;Serializer(current_app.config['SECRET_KEY'],&#160;expiration)<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;s.dumps({'confirm':&#160;self.id})</p>
<p style="position:absolute;top:838px;left:108px;white-space:nowrap" class="ft12447">&#160; &#160;&#160;<b>def</b>&#160;confirm(self,&#160;token):<br/>&#160; &#160; &#160; &#160;&#160;s&#160;=&#160;Serializer(current_app.config['SECRET_KEY'])<br/>&#160; &#160; &#160; &#160;&#160;<b>try</b>:</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1245"><b>104&#160;&#160;|&#160;&#160;Chapter 8: User Authentication</b></p>
</div>
<!-- Page 125 -->
<a name="125"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page125-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask125.png" alt="background image"/>
<p style="position:absolute;top:82px;left:108px;white-space:nowrap" class="ft12547">&#160; &#160; &#160; &#160; &#160; &#160;&#160;data&#160;=&#160;s.loads(token)<br/>&#160; &#160; &#160; &#160;&#160;<b>except</b>:<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;False<br/>&#160; &#160; &#160; &#160;&#160;<b>if</b>&#160;data.get('confirm')&#160;!=&#160;self.id:<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;False<br/>&#160; &#160; &#160; &#160;&#160;self.confirmed&#160;=&#160;True<br/>&#160; &#160; &#160; &#160;&#160;db.session.add(self)<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;True</p>
<p style="position:absolute;top:217px;left:108px;white-space:nowrap" class="ft12514">The&#160;generate_confirmation_token()&#160;method generates a token with a default validity</p>
<p style="position:absolute;top:237px;left:108px;white-space:nowrap" class="ft12546">time of one hour. The&#160;confirm()&#160;method verifies the token and, if valid, sets the new<br/>confirmed</p>
<p style="position:absolute;top:256px;left:175px;white-space:nowrap" class="ft12514">&#160;attribute to&#160;True.</p>
<p style="position:absolute;top:285px;left:108px;white-space:nowrap" class="ft12514">In addition to verifying the token, the&#160;confirm()&#160;function checks that the&#160;id&#160;from the</p>
<p style="position:absolute;top:305px;left:108px;white-space:nowrap" class="ft12514">token matches the logged-in user, which is stored in&#160;current_user. This ensures that</p>
<p style="position:absolute;top:324px;left:108px;white-space:nowrap" class="ft12514">even if a malicious user figures out how to generate signed tokens, he or she cannot</p>
<p style="position:absolute;top:343px;left:108px;white-space:nowrap" class="ft12514">confirm somebody else’s account.</p>
<p style="position:absolute;top:382px;left:198px;white-space:nowrap" class="ft12525">Because&#160;a&#160;new&#160;column&#160;was&#160;added&#160;to&#160;the&#160;model&#160;to&#160;track&#160;the&#160;con‐</p>
<p style="position:absolute;top:400px;left:198px;white-space:nowrap" class="ft12525">firmed&#160;state&#160;of&#160;each&#160;account,&#160;a&#160;new&#160;database&#160;migration&#160;needs&#160;to&#160;be</p>
<p style="position:absolute;top:417px;left:198px;white-space:nowrap" class="ft12525">generated&#160;and&#160;applied.</p>
<p style="position:absolute;top:488px;left:108px;white-space:nowrap" class="ft12514">The two new methods added to the&#160;User&#160;model are easily tested in unit tests. You can</p>
<p style="position:absolute;top:507px;left:108px;white-space:nowrap" class="ft12514">find the unit tests in the GitHub repository for the application.</p>
<p style="position:absolute;top:542px;left:108px;white-space:nowrap" class="ft12558"><b>Sending Confirmation Emails<br/></b>The current&#160;<i>/register</i>&#160;route redirects to&#160;<i>/index</i>&#160;after adding the new user to the database.</p>
<p style="position:absolute;top:595px;left:108px;white-space:nowrap" class="ft12514">Before redirecting, this route now needs to send the confirmation email. This change</p>
<p style="position:absolute;top:614px;left:108px;white-space:nowrap" class="ft12514"><a href="Flask.html#125">is shown in&#160;Example 8-19.</a></p>
<p style="position:absolute;top:646px;left:108px;white-space:nowrap" class="ft12550"><i>Example 8-19. app/auth/views.py: Registration route with confirmation email<br/></i><b>from</b>&#160;<b>..email</b>&#160;<b>import</b>&#160;send_email</p>
<p style="position:absolute;top:704px;left:108px;white-space:nowrap" class="ft12547">@auth.route('/register',&#160;methods&#160;=&#160;['GET',&#160;'POST'])<br/><b>def</b>&#160;register():<br/>&#160; &#160;&#160;form&#160;=&#160;RegistrationForm()<br/>&#160; &#160;&#160;<b>if</b>&#160;form.validate_on_submit():<br/>&#160; &#160; &#160; &#160;&#160;<i># ...<br/></i>&#160; &#160; &#160; &#160;&#160;db.session.add(user)<br/>&#160; &#160; &#160; &#160;&#160;db.session.commit()<br/>&#160; &#160; &#160; &#160;&#160;token&#160;=&#160;user.generate_confirmation_token()<br/>&#160; &#160; &#160; &#160;&#160;send_email(user.email,&#160;'Confirm Your Account',<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;'auth/email/confirm',&#160;user=user,&#160;token=token)<br/>&#160; &#160; &#160; &#160;&#160;flash('A confirmation email has been sent to you by email.')</p>
<p style="position:absolute;top:915px;left:505px;white-space:nowrap" class="ft1255"><b>Account Confirmation&#160;&#160;|&#160;&#160;105</b></p>
</div>
<!-- Page 126 -->
<a name="126"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page126-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask126.png" alt="background image"/>
<p style="position:absolute;top:82px;left:108px;white-space:nowrap" class="ft12647">&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;redirect(url_for('main.index'))<br/>&#160; &#160;&#160;<b>return</b>&#160;render_template('auth/register.html',&#160;form=form)</p>
<p style="position:absolute;top:125px;left:108px;white-space:nowrap" class="ft12614">Note that a&#160;db.session.commit()&#160;call had to be added, even though the application</p>
<p style="position:absolute;top:144px;left:108px;white-space:nowrap" class="ft12614">configured automatic database commits at the end of the request. The problem is that</p>
<p style="position:absolute;top:164px;left:108px;white-space:nowrap" class="ft12614">new users get assigned an&#160;id&#160;when they are committed to the database. Because the&#160;id</p>
<p style="position:absolute;top:183px;left:108px;white-space:nowrap" class="ft12615">is needed for the confirmation token, the commit cannot be delayed.<br/>The email templates used by the authentication blueprint will be added in the folder</p>
<p style="position:absolute;top:230px;left:108px;white-space:nowrap" class="ft12610"><i>templates/auth/email</i></p>
<p style="position:absolute;top:229px;left:241px;white-space:nowrap" class="ft12614">&#160;to keep them separate from the HTML templates. As discussed in</p>
<p style="position:absolute;top:248px;left:108px;white-space:nowrap" class="ft12617"><a href="Flask.html#89">Chapter 6, for each email two tem</a>plates are needed for the plain- and rich-text versions</p>
<p style="position:absolute;top:267px;left:108px;white-space:nowrap" class="ft12614">of the body. As an exam<a href="Flask.html#126">ple,&#160;Example 8-20&#160;shows the plain-text version of the confir‐</a></p>
<p style="position:absolute;top:286px;left:108px;white-space:nowrap" class="ft12614">mation email template, and you can find the equivalent HTML version in the GitHub</p>
<p style="position:absolute;top:305px;left:108px;white-space:nowrap" class="ft12614">repository.</p>
<p style="position:absolute;top:337px;left:108px;white-space:nowrap" class="ft12650"><i>Example 8-20.&#160;app/auth/templates/auth/email/confirm.txt: Text body of confirmation<br/>email<br/></i>Dear {{ user.username }},</p>
<p style="position:absolute;top:414px;left:108px;white-space:nowrap" class="ft1263">Welcome to Flasky!</p>
<p style="position:absolute;top:445px;left:108px;white-space:nowrap" class="ft1263">To confirm your account please click on the following link:</p>
<p style="position:absolute;top:475px;left:108px;white-space:nowrap" class="ft1263">{{ url_for('auth.confirm', token=token, _external=True) }}</p>
<p style="position:absolute;top:506px;left:108px;white-space:nowrap" class="ft1263">Sincerely,</p>
<p style="position:absolute;top:537px;left:108px;white-space:nowrap" class="ft1263">The Flasky Team</p>
<p style="position:absolute;top:567px;left:108px;white-space:nowrap" class="ft1263">Note: replies to this email address are not monitored.</p>
<p style="position:absolute;top:595px;left:108px;white-space:nowrap" class="ft12646">By default,&#160;url_for()&#160;generates relative URLs, so, for example,<br/>url_for('auth.confirm', token='abc')</p>
<p style="position:absolute;top:614px;left:379px;white-space:nowrap" class="ft12614">&#160;returns the string&#160;'/auth/confirm/abc'.</p>
<p style="position:absolute;top:633px;left:108px;white-space:nowrap" class="ft12614">This, of course, is not a valid URL that can be sent in an email. Relative URLs work fine</p>
<p style="position:absolute;top:652px;left:108px;white-space:nowrap" class="ft12614">when they are used within the context of a web page because the browser converts them</p>
<p style="position:absolute;top:671px;left:108px;white-space:nowrap" class="ft12614">to absolute by adding the hostname and port number from the current page, but when</p>
<p style="position:absolute;top:691px;left:108px;white-space:nowrap" class="ft12614">sending a URL over email there is no such context. The&#160;_external=True&#160;argument is</p>
<p style="position:absolute;top:711px;left:108px;white-space:nowrap" class="ft12614">added to the&#160;url_for()&#160;call to request a fully qualified URL that includes the scheme</p>
<p style="position:absolute;top:730px;left:108px;white-space:nowrap" class="ft12615">(<i>http://</i>&#160;or&#160;<i>https://</i>), hostname, and port.<br/>The view function that confirms accoun<a href="Flask.html#126">ts is shown in&#160;Example 8-21</a>.</p>
<p style="position:absolute;top:789px;left:108px;white-space:nowrap" class="ft12650"><i>Example 8-21. app/auth/views.py: Confirm a user account<br/></i><b>from</b>&#160;<b>flask.ext.login</b>&#160;<b>import</b>&#160;current_user</p>
<p style="position:absolute;top:848px;left:108px;white-space:nowrap" class="ft12647">@auth.route('/confirm/&lt;token&gt;')<br/>@login_required</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1265"><b>106&#160;&#160;|&#160;&#160;Chapter 8: User Authentication</b></p>
</div>
<!-- Page 127 -->
<a name="127"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page127-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask127.png" alt="background image"/>
<p style="position:absolute;top:82px;left:108px;white-space:nowrap" class="ft12747"><b>def</b>&#160;confirm(token):<br/>&#160; &#160;&#160;<b>if</b>&#160;current_user.confirmed:<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;redirect(url_for('main.index'))<br/>&#160; &#160;&#160;<b>if</b>&#160;current_user.confirm(token):<br/>&#160; &#160; &#160; &#160;&#160;flash('You have confirmed your account. Thanks!')<br/>&#160; &#160;&#160;<b>else</b>:<br/>&#160; &#160; &#160; &#160;&#160;flash('The confirmation link is invalid or has expired.')<br/>&#160; &#160;&#160;<b>return</b>&#160;redirect(url_for('main.index'))</p>
<p style="position:absolute;top:217px;left:108px;white-space:nowrap" class="ft12714">This route is protected with the&#160;login_required&#160;decorator from Flask-Login, so that</p>
<p style="position:absolute;top:236px;left:108px;white-space:nowrap" class="ft12714">when the users click on the link from the confirmation email they are asked to log in</p>
<p style="position:absolute;top:255px;left:108px;white-space:nowrap" class="ft12715">before they reach this view function.<br/>The function first checks if the logged-in user is already confirmed, and in that case it</p>
<p style="position:absolute;top:301px;left:108px;white-space:nowrap" class="ft12714">redirects to the home page, as obviously there is nothing to do. This can prevent un‐</p>
<p style="position:absolute;top:320px;left:108px;white-space:nowrap" class="ft12748">necessary work if a user clicks the confirmation token multiple times by mistake.<br/>Because the actual token confirmation is done entirely in the&#160;User&#160;model, all the view</p>
<p style="position:absolute;top:369px;left:108px;white-space:nowrap" class="ft12714">function needs to do is call the&#160;confirm()&#160;method and then flash a message according</p>
<p style="position:absolute;top:389px;left:108px;white-space:nowrap" class="ft12714">to the result. When the confirmation succeeds, the&#160;User&#160;model’s&#160;confirmed&#160;attribute is</p>
<p style="position:absolute;top:408px;left:108px;white-space:nowrap" class="ft12715">changed and added to the session, which will be committed when the request ends.<br/>Each application can decide what unconfirmed users are allowed to do before they</p>
<p style="position:absolute;top:454px;left:108px;white-space:nowrap" class="ft12714">confirm their account. One possibility is to allow unconfirmed users to log in, but only</p>
<p style="position:absolute;top:473px;left:108px;white-space:nowrap" class="ft12748">show them a page that asks them to confirm their accounts before they can gain access.<br/>This step can be done using Flask’s&#160;before_request&#160;hook, which was briefly described</p>
<p style="position:absolute;top:522px;left:108px;white-space:nowrap" class="ft12714"><a href="Flask.html#27">in&#160;Chapter 2</a>. From a blueprint, the&#160;before_request&#160;hook applies only to requests that</p>
<p style="position:absolute;top:541px;left:108px;white-space:nowrap" class="ft12714">belong to the blueprint. To install a hook for all application requests from a blueprint,</p>
<p style="position:absolute;top:561px;left:108px;white-space:nowrap" class="ft12714">the&#160;before_app_request&#160;decorator must be used instead.&#160;<a href="Flask.html#127">Example 8-22</a>&#160;shows how this</p>
<p style="position:absolute;top:580px;left:108px;white-space:nowrap" class="ft12714">handler is implemented.</p>
<p style="position:absolute;top:611px;left:108px;white-space:nowrap" class="ft12747"><i>Example 8-22.&#160;app/auth/views.py: Filter unconfirmed accounts in before_app_request<br/>handler<br/></i>@auth.before_app_request<br/><b>def</b>&#160;before_request():<br/>&#160; &#160;&#160;<b>if</b>&#160;current_user.is_authenticated()&#160;\<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>and</b>&#160;<b>not</b>&#160;current_user.confirmed&#160;\<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>and</b>&#160;request.endpoint[:5]&#160;!=&#160;'auth.':<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;redirect(url_for('auth.unconfirmed'))</p>
<p style="position:absolute;top:765px;left:108px;white-space:nowrap" class="ft12747">@auth.route('/unconfirmed')<br/><b>def</b>&#160;unconfirmed():<br/>&#160; &#160;&#160;<b>if</b>&#160;current_user.is_anonymous()&#160;<b>or</b>&#160;current_user.confirmed:<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;redirect('main.index')<br/>&#160; &#160;&#160;<b>return</b>&#160;render_template('auth/unconfirmed.html')</p>
<p style="position:absolute;top:915px;left:505px;white-space:nowrap" class="ft1275"><b>Account Confirmation&#160;&#160;|&#160;&#160;107</b></p>
</div>
<!-- Page 128 -->
<a name="128"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page128-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask128.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft12814">The&#160;before_app_request&#160;handler will intercept a request when three conditions are</p>
<p style="position:absolute;top:98px;left:108px;white-space:nowrap" class="ft12814">true:</p>
<p style="position:absolute;top:133px;left:116px;white-space:nowrap" class="ft12860">1.&#160;A user is logged in (current_user.is_authenticated()&#160;must return&#160;True).<br/>2.&#160;The account for the user is not confirmed.<br/>3.&#160;The requested endpoint (accessible as&#160;request.endpoint) is outside of the au‐</p>
<p style="position:absolute;top:203px;left:135px;white-space:nowrap" class="ft12814">thentication blueprint. Access to the authentication routes needs to be granted, as</p>
<p style="position:absolute;top:222px;left:135px;white-space:nowrap" class="ft12814">those are the routes that will enable the user to confirm the account or perform</p>
<p style="position:absolute;top:241px;left:135px;white-space:nowrap" class="ft12814">other account management functions.</p>
<p style="position:absolute;top:274px;left:108px;white-space:nowrap" class="ft12814">If the three conditions are met, then a redirect is issued to a new&#160;<i>/auth/unconfirmed</i></p>
<p style="position:absolute;top:293px;left:108px;white-space:nowrap" class="ft12814">route that shows a page with information about account confirmation.</p>
<p style="position:absolute;top:333px;left:198px;white-space:nowrap" class="ft12825">When&#160;a&#160;before_request&#160;or&#160;before_app_request&#160;callback&#160;returns&#160;a</p>
<p style="position:absolute;top:351px;left:198px;white-space:nowrap" class="ft12825">response&#160;or&#160;a&#160;redirect,&#160;Flask&#160;sends&#160;that&#160;to&#160;the&#160;client&#160;without&#160;invok‐</p>
<p style="position:absolute;top:368px;left:198px;white-space:nowrap" class="ft12825">ing&#160;the&#160;view&#160;function&#160;associated&#160;with&#160;the&#160;request.&#160;This&#160;effectively</p>
<p style="position:absolute;top:385px;left:198px;white-space:nowrap" class="ft12825">allows&#160;these&#160;callbacks&#160;to&#160;intercept&#160;a&#160;request&#160;when&#160;necessary.</p>
<p style="position:absolute;top:438px;left:108px;white-space:nowrap" class="ft12814">The page that is presen<a href="Flask.html#129">ted to unconfirmed users (shown in&#160;Figure 8-4) just renders a</a></p>
<p style="position:absolute;top:456px;left:108px;white-space:nowrap" class="ft12814">template that gives users instructions for how to confirm their account and offers a link</p>
<p style="position:absolute;top:475px;left:108px;white-space:nowrap" class="ft12814">to request a new confirmation email, in case the original email was lost. The route that</p>
<p style="position:absolute;top:494px;left:108px;white-space:nowrap" class="ft12814">resends the confirma<a href="Flask.html#128">tion email is shown in&#160;Example 8-23.</a></p>
<p style="position:absolute;top:526px;left:108px;white-space:nowrap" class="ft12847"><i>Example 8-23. app/auth/views.py: Resend account confirmation email<br/></i>@auth.route('/confirm')<br/>@login_required<br/><b>def</b>&#160;resend_confirmation():<br/>&#160; &#160;&#160;token&#160;=&#160;current_user.generate_confirmation_token()<br/>&#160; &#160;&#160;send_email('auth/email/confirm',<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;'Confirm Your Account',&#160;user,&#160;token=token)<br/>&#160; &#160;&#160;flash('A new confirmation email has been sent to you by email.')<br/>&#160; &#160;&#160;<b>return</b>&#160;redirect(url_for('main.index'))</p>
<p style="position:absolute;top:688px;left:108px;white-space:nowrap" class="ft12814">This route repeats what was done in the registration route using&#160;current_user, the user</p>
<p style="position:absolute;top:708px;left:108px;white-space:nowrap" class="ft12814">who is logged in, as the target user. This route is also protected with&#160;login_required</p>
<p style="position:absolute;top:727px;left:108px;white-space:nowrap" class="ft12814">to ensure that when it is accessed, the user that is making the request is known.</p>
<p style="position:absolute;top:769px;left:198px;white-space:nowrap" class="ft12825">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:787px;left:198px;white-space:nowrap" class="ft12825">run&#160;git&#160;checkout&#160;8e&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:804px;left:198px;white-space:nowrap" class="ft12831">This&#160;update&#160;contains&#160;a&#160;database&#160;migration,&#160;so&#160;remember&#160;to&#160;run<br/>python&#160;manage.py&#160;db&#160;upgrade</p>
<p style="position:absolute;top:822px;left:384px;white-space:nowrap" class="ft12825">&#160;after&#160;you&#160;check&#160;out&#160;the&#160;code.</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1285"><b>108&#160;&#160;|&#160;&#160;Chapter 8: User Authentication</b></p>
</div>
<!-- Page 129 -->
<a name="129"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page129-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask129.png" alt="background image"/>
<p style="position:absolute;top:412px;left:108px;white-space:nowrap" class="ft12910"><i>Figure 8-4. Unconfirmed account page</i></p>
<p style="position:absolute;top:447px;left:108px;white-space:nowrap" class="ft12918"><b>Account Management<br/></b>Users who have accounts with the application may need to make changes to their ac‐</p>
<p style="position:absolute;top:506px;left:108px;white-space:nowrap" class="ft12914">counts from time to time. The following tasks can be added to the authentication blue‐</p>
<p style="position:absolute;top:525px;left:108px;white-space:nowrap" class="ft12924">print using the techniques presented in this chapter:<br/><i>Password updates</i></p>
<p style="position:absolute;top:570px;left:135px;white-space:nowrap" class="ft12914">Security conscious users may want to change their passwords periodically. This is</p>
<p style="position:absolute;top:589px;left:135px;white-space:nowrap" class="ft12914">an easy feature to implement, because as long as the user is logged in, it is safe to</p>
<p style="position:absolute;top:608px;left:135px;white-space:nowrap" class="ft12914">present a form that asks for the old password and a new password to replace it.</p>
<p style="position:absolute;top:628px;left:135px;white-space:nowrap" class="ft12914">(This feature is implemented as commit&#160;8f&#160;in the GitHub repository.)</p>
<p style="position:absolute;top:658px;left:108px;white-space:nowrap" class="ft12910"><i>Password resets</i></p>
<p style="position:absolute;top:676px;left:135px;white-space:nowrap" class="ft12914">To avoid locking users out of the application when they forget their passwords, a</p>
<p style="position:absolute;top:694px;left:135px;white-space:nowrap" class="ft12914">password reset option can be offered. To implement password resets in a secure</p>
<p style="position:absolute;top:713px;left:135px;white-space:nowrap" class="ft12914">way, it is necessary to use tokens similar to those used to confirm accounts. When</p>
<p style="position:absolute;top:732px;left:135px;white-space:nowrap" class="ft12914">a user requests a password reset, an email with a reset token is sent to the registered</p>
<p style="position:absolute;top:751px;left:135px;white-space:nowrap" class="ft12914">email address. The user then clicks the link in the email and, after the token is</p>
<p style="position:absolute;top:770px;left:135px;white-space:nowrap" class="ft12914">verified, a form is presented where a new password can be entered. (This feature is</p>
<p style="position:absolute;top:790px;left:135px;white-space:nowrap" class="ft12914">implemented as commit&#160;8g&#160;in the GitHub repository.)</p>
<p style="position:absolute;top:820px;left:108px;white-space:nowrap" class="ft12910"><i>Email address changes</i></p>
<p style="position:absolute;top:838px;left:135px;white-space:nowrap" class="ft12914">Users can be given the option to change the registered email address, but before the</p>
<p style="position:absolute;top:857px;left:135px;white-space:nowrap" class="ft12914">new address is accepted it must be verified with a confirmation email. To use this</p>
<p style="position:absolute;top:915px;left:504px;white-space:nowrap" class="ft1295"><b>Account Management&#160;&#160;|&#160;&#160;109</b></p>
</div>
<!-- Page 130 -->
<a name="130"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page130-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask130.png" alt="background image"/>
<p style="position:absolute;top:78px;left:135px;white-space:nowrap" class="ft13014">feature, the user enters the new email address in a form. To confirm the email</p>
<p style="position:absolute;top:97px;left:135px;white-space:nowrap" class="ft13014">address, a token is emailed to that address. When the server receives the token back,</p>
<p style="position:absolute;top:116px;left:135px;white-space:nowrap" class="ft13014">it can update the user object. While the server waits to receive the token, it can store</p>
<p style="position:absolute;top:135px;left:135px;white-space:nowrap" class="ft13014">the new email address in a new database field reserved for pending email addresses,</p>
<p style="position:absolute;top:155px;left:135px;white-space:nowrap" class="ft13014">or it can store the address in the token along with the&#160;id. (This feature is imple‐</p>
<p style="position:absolute;top:175px;left:135px;white-space:nowrap" class="ft13014">mented as commit&#160;8h&#160;in the GitHub repository.)</p>
<p style="position:absolute;top:203px;left:108px;white-space:nowrap" class="ft13014">In the next chapter, the user subsystem of Flasky will be extended through the use of</p>
<p style="position:absolute;top:222px;left:108px;white-space:nowrap" class="ft13014">user roles.</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1305"><b>110&#160;&#160;|&#160;&#160;Chapter 8: User Authentication</b></p>
</div>
<!-- Page 131 -->
<a name="131"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page131-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask131.png" alt="background image"/>
<p style="position:absolute;top:104px;left:559px;white-space:nowrap" class="ft13128"><b>CHAPTER 9</b></p>
<p style="position:absolute;top:131px;left:521px;white-space:nowrap" class="ft13111"><b>User Roles</b></p>
<p style="position:absolute;top:345px;left:108px;white-space:nowrap" class="ft13114">Not all users of web applications are created equal. In most applications, a small per‐</p>
<p style="position:absolute;top:364px;left:108px;white-space:nowrap" class="ft13114">centage of users are trusted with extra powers to help keep the application running</p>
<p style="position:absolute;top:383px;left:108px;white-space:nowrap" class="ft13114">smoothly. Administrators are the best example, but in many cases middle-level power</p>
<p style="position:absolute;top:402px;left:108px;white-space:nowrap" class="ft13115">users such as content moderators exist as well.<br/>There are several ways to implement roles in an application. The appropriate method</p>
<p style="position:absolute;top:449px;left:108px;white-space:nowrap" class="ft13114">largely depends on how many roles need to be supported and how elaborate they are.</p>
<p style="position:absolute;top:468px;left:108px;white-space:nowrap" class="ft13114">For example, a simple application may need just two roles, one for regular users and</p>
<p style="position:absolute;top:488px;left:108px;white-space:nowrap" class="ft13146">one for administrators. In this case, having an&#160;is_administrator&#160;Boolean field in the<br/>User</p>
<p style="position:absolute;top:507px;left:138px;white-space:nowrap" class="ft13114">&#160;model may be all that is necessary. A more complex application may need addi‐</p>
<p style="position:absolute;top:526px;left:108px;white-space:nowrap" class="ft13114">tional roles with varying levels of power in between regular users and administrators.</p>
<p style="position:absolute;top:545px;left:108px;white-space:nowrap" class="ft13114">In some applications it may not even make sense to talk about discrete roles; instead,</p>
<p style="position:absolute;top:564px;left:108px;white-space:nowrap" class="ft13115">giving users a combination of&#160;<i>permissions</i>&#160;may be the right approach.<br/>The user role implementation presented in this chapter is a hybrid between discrete</p>
<p style="position:absolute;top:611px;left:108px;white-space:nowrap" class="ft13114">roles and permissions. Users are assigned a discrete role, but the roles are defined in</p>
<p style="position:absolute;top:630px;left:108px;white-space:nowrap" class="ft13114">terms of permissions.</p>
<p style="position:absolute;top:666px;left:108px;white-space:nowrap" class="ft13122"><b>Database Representation of Roles<br/></b>A simple&#160;roles&#160;table was created in&#160;<a href="Flask.html#69">Chapter 5</a>&#160;as a vehicle to demonstrate one-to-many</p>
<p style="position:absolute;top:727px;left:108px;white-space:nowrap" class="ft13114">rela<a href="Flask.html#131">tionships.&#160;Example 9-1&#160;shows an im</a>proved&#160;Role&#160;model with some additions.</p>
<p style="position:absolute;top:759px;left:108px;white-space:nowrap" class="ft13147"><i>Example 9-1. app/models.py: Role permissions<br/></i><b>class</b>&#160;<b>Role</b>(db.Model):<br/>&#160; &#160;&#160;__tablename__&#160;=&#160;'roles'<br/>&#160; &#160;&#160;id&#160;=&#160;db.Column(db.Integer,&#160;primary_key=True)<br/>&#160; &#160;&#160;name&#160;=&#160;db.Column(db.String(64),&#160;unique=True)<br/>&#160; &#160;&#160;default&#160;=&#160;db.Column(db.Boolean,&#160;default=False,&#160;index=True)</p>
<p style="position:absolute;top:915px;left:631px;white-space:nowrap" class="ft1315"><b>111</b></p>
</div>
<!-- Page 132 -->
<a name="132"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft13281{font-size:11px;line-height:21px;font-family:Times;color:#231f20;}
-->
</style>
<div id="page132-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask132.png" alt="background image"/>
<p style="position:absolute;top:82px;left:108px;white-space:nowrap" class="ft13247">&#160; &#160;&#160;permissions&#160;=&#160;db.Column(db.Integer)<br/>&#160; &#160;&#160;users&#160;=&#160;db.relationship('User',&#160;backref='role',&#160;lazy='dynamic')</p>
<p style="position:absolute;top:125px;left:108px;white-space:nowrap" class="ft13214">The&#160;default&#160;field should be set to&#160;True&#160;for only one role and&#160;False&#160;for all the others.</p>
<p style="position:absolute;top:144px;left:108px;white-space:nowrap" class="ft13248">The role marked as default will be the one assigned to new users upon registration.<br/>The second addition to the model is the&#160;permissions&#160;field, which is an integer that will</p>
<p style="position:absolute;top:192px;left:108px;white-space:nowrap" class="ft13214">be used as bit flags. Each task will be assigned a bit position, and for each role the tasks</p>
<p style="position:absolute;top:210px;left:108px;white-space:nowrap" class="ft13215">that are allowed for that role will have their bits set to 1.<br/>The list of tasks for which permissions are needed is obviously application specific. For</p>
<p style="position:absolute;top:257px;left:108px;white-space:nowrap" class="ft13248">Flasky<a href="Flask.html#132">, the list of tasks is shown in&#160;Table 9-1</a>.<br/><i>Table 9-1. Application permissions</i></p>
<p style="position:absolute;top:314px;left:113px;white-space:nowrap" class="ft13253"><b>Task&#160;name</b></p>
<p style="position:absolute;top:314px;left:278px;white-space:nowrap" class="ft13253"><b>Bit&#160;value</b></p>
<p style="position:absolute;top:314px;left:370px;white-space:nowrap" class="ft13253"><b>Description</b></p>
<p style="position:absolute;top:336px;left:113px;white-space:nowrap" class="ft13230">Follow&#160;users</p>
<p style="position:absolute;top:336px;left:278px;white-space:nowrap" class="ft13230">0b00000001&#160;(0x01)&#160;Follow&#160;other&#160;users</p>
<p style="position:absolute;top:357px;left:113px;white-space:nowrap" class="ft13230">Comment&#160;on&#160;posts&#160;made&#160;by&#160;others</p>
<p style="position:absolute;top:357px;left:278px;white-space:nowrap" class="ft13230">0b00000010&#160;(0x02)&#160;Comment&#160;on&#160;articles&#160;written&#160;by&#160;others</p>
<p style="position:absolute;top:379px;left:113px;white-space:nowrap" class="ft13230">Write&#160;articles</p>
<p style="position:absolute;top:379px;left:278px;white-space:nowrap" class="ft13230">0b00000100&#160;(0x04)&#160;Write&#160;original&#160;articles</p>
<p style="position:absolute;top:401px;left:113px;white-space:nowrap" class="ft13281">Moderate&#160;comments&#160;made&#160;by&#160;others&#160;0b00001000&#160;(0x08)&#160;Suppress&#160;offensive&#160;comments&#160;made&#160;by&#160;others<br/>Administration&#160;access</p>
<p style="position:absolute;top:422px;left:278px;white-space:nowrap" class="ft13230">0b10000000&#160;(0x80)&#160;Administrative&#160;access&#160;to&#160;the&#160;site</p>
<p style="position:absolute;top:455px;left:108px;white-space:nowrap" class="ft13214">Note that a total of eight bits was allocated to tasks, and so far only five have been used.</p>
<p style="position:absolute;top:474px;left:108px;white-space:nowrap" class="ft13215">The remaining three are left for future expansion.<br/>The code representation of&#160;<a href="Flask.html#132">Table 9-1&#160;is shown in&#160;Example 9-2.</a></p>
<p style="position:absolute;top:534px;left:108px;white-space:nowrap" class="ft13276"><i>Example 9-2. app/models.py: Permission constants<br/></i><b>class</b>&#160;<b>Permission</b>:<br/>&#160; &#160;&#160;FOLLOW&#160;=&#160;0x01<br/>&#160; &#160;&#160;COMMENT&#160;=&#160;0x02<br/>&#160; &#160;&#160;WRITE_ARTICLES&#160;=&#160;0x04<br/>&#160; &#160;&#160;MODERATE_COMMENTS&#160;=&#160;0x08<br/>&#160; &#160;&#160;ADMINISTER&#160;=&#160;0x80</p>
<p style="position:absolute;top:664px;left:108px;white-space:nowrap" class="ft13217"><a href="Flask.html#132">Table 9-2</a>&#160;shows the list of user roles that will be supported, along with the permission</p>
<p style="position:absolute;top:683px;left:108px;white-space:nowrap" class="ft13248">bits that define it.<br/><i>Table 9-2. User roles</i></p>
<p style="position:absolute;top:740px;left:113px;white-space:nowrap" class="ft13253"><b>User&#160;role</b></p>
<p style="position:absolute;top:740px;left:182px;white-space:nowrap" class="ft13253"><b>Permissions</b></p>
<p style="position:absolute;top:740px;left:274px;white-space:nowrap" class="ft13253"><b>Description</b></p>
<p style="position:absolute;top:762px;left:113px;white-space:nowrap" class="ft13230">Anonymous</p>
<p style="position:absolute;top:762px;left:182px;white-space:nowrap" class="ft13230">0b00000000&#160;(0x00)&#160;User&#160;who&#160;is&#160;not&#160;logged&#160;in.&#160;Read-only&#160;access&#160;to&#160;the&#160;application.</p>
<p style="position:absolute;top:783px;left:113px;white-space:nowrap" class="ft13230">User</p>
<p style="position:absolute;top:783px;left:182px;white-space:nowrap" class="ft13230">0b00000111&#160;(0x07)&#160;Basic&#160;permissions&#160;to&#160;write&#160;articles&#160;and&#160;comments&#160;and&#160;to&#160;follow&#160;other&#160;users.&#160;This&#160;is&#160;the</p>
<p style="position:absolute;top:800px;left:274px;white-space:nowrap" class="ft13230">default&#160;for&#160;new&#160;users.</p>
<p style="position:absolute;top:821px;left:113px;white-space:nowrap" class="ft13230">Moderator</p>
<p style="position:absolute;top:821px;left:182px;white-space:nowrap" class="ft13230">0b00001111&#160;(0x0f)&#160;Adds&#160;permission&#160;to&#160;suppress&#160;comments&#160;deemed&#160;offensive&#160;or&#160;inappropriate.</p>
<p style="position:absolute;top:843px;left:113px;white-space:nowrap" class="ft13230">Administrator&#160;0b11111111&#160;(0xff)&#160;Full&#160;access,&#160;which&#160;includes&#160;permission&#160;to&#160;change&#160;the&#160;roles&#160;of&#160;other&#160;users.</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1325"><b>112&#160;&#160;|&#160;&#160;Chapter 9: User Roles</b></p>
</div>
<!-- Page 133 -->
<a name="133"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page133-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask133.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft13314">Organizing the roles with permissions lets you add new roles in the future that use</p>
<p style="position:absolute;top:97px;left:108px;white-space:nowrap" class="ft13315">different combinations of permissions.<br/>Adding the roles to the database manually is time consuming and error prone. Instead,</p>
<p style="position:absolute;top:145px;left:108px;white-space:nowrap" class="ft13314">a class method will be added to the&#160;Role<a href="Flask.html#133">&#160;class for this purpose, as shown in&#160;Example 9-3</a>.</p>
<p style="position:absolute;top:177px;left:108px;white-space:nowrap" class="ft13347"><i>Example 9-3. app/models.py: Create roles in the database<br/></i><b>class</b>&#160;<b>Role</b>(db.Model):<br/>&#160; &#160;&#160;<i># ...<br/></i>&#160; &#160;&#160;@staticmethod<br/>&#160; &#160;&#160;<b>def</b>&#160;insert_roles():<br/>&#160; &#160; &#160; &#160;&#160;roles&#160;=&#160;{<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;'User':&#160;(Permission.FOLLOW&#160;|<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;Permission.COMMENT&#160;|<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;Permission.WRITE_ARTICLES,&#160;True),<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;'Moderator':&#160;(Permission.FOLLOW&#160;|<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;Permission.COMMENT&#160;|<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;Permission.WRITE_ARTICLES&#160;|<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;Permission.MODERATE_COMMENTS,&#160;False),<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;'Administrator':&#160;(0xff,&#160;False)<br/>&#160; &#160; &#160; &#160;&#160;}<br/>&#160; &#160; &#160; &#160;&#160;<b>for</b>&#160;r&#160;<b>in</b>&#160;roles:<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;role&#160;=&#160;Role.query.filter_by(name=r).first()<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>if</b>&#160;role&#160;<b>is</b>&#160;None:<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;role&#160;=&#160;Role(name=r)<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;role.permissions&#160;=&#160;roles[r][0]<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;role.default&#160;=&#160;roles[r][1]<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;db.session.add(role)<br/>&#160; &#160; &#160; &#160;&#160;db.session.commit()</p>
<p style="position:absolute;top:553px;left:108px;white-space:nowrap" class="ft13314">The&#160;insert_roles()&#160;function does not directly create new role objects. Instead, it tries</p>
<p style="position:absolute;top:572px;left:108px;white-space:nowrap" class="ft13314">to find existing roles by name and update those. A new role object is created only for</p>
<p style="position:absolute;top:591px;left:108px;white-space:nowrap" class="ft13314">role names that aren’t in the database already. This is done so that the role list can be</p>
<p style="position:absolute;top:610px;left:108px;white-space:nowrap" class="ft13314">updated in the future when changes need to be made. To add a new role or change the</p>
<p style="position:absolute;top:630px;left:108px;white-space:nowrap" class="ft13314">permission assignments for a role, change the&#160;roles&#160;array and rerun the function. Note</p>
<p style="position:absolute;top:649px;left:108px;white-space:nowrap" class="ft13314">that the “Anonymous” role does not need to be represented in the database, as it is</p>
<p style="position:absolute;top:668px;left:108px;white-space:nowrap" class="ft13315">designed to represent users who are not in the database.<br/>To apply these roles to the database, a shell session can be used:</p>
<p style="position:absolute;top:727px;left:133px;white-space:nowrap" class="ft13347">(venv)&#160;$&#160;python&#160;manage.py&#160;shell<br/>&gt;&gt;&gt;&#160;Role.insert_roles()<br/>&gt;&gt;&gt;&#160;Role.query.all()<br/>[&lt;Role&#160;u'Administrator'&gt;,&#160;&lt;Role&#160;u'User'&gt;,&#160;&lt;Role&#160;u'Moderator'&gt;]</p>
<p style="position:absolute;top:802px;left:108px;white-space:nowrap" class="ft13318"><b>Role Assignment<br/></b>When users register an account with the application, the correct role should be assigned</p>
<p style="position:absolute;top:861px;left:108px;white-space:nowrap" class="ft13314">to them. For most users, the role assigned at registration time will be the “User” role, as</p>
<p style="position:absolute;top:915px;left:527px;white-space:nowrap" class="ft1335"><b>Role Assignment&#160;&#160;|&#160;&#160;113</b></p>
</div>
<!-- Page 134 -->
<a name="134"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page134-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask134.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft13414">that is the role that is marked as a default role. The only exception is made for the</p>
<p style="position:absolute;top:97px;left:108px;white-space:nowrap" class="ft13414">administrator, which needs to be assigned the “Administrator” role from the start. This</p>
<p style="position:absolute;top:117px;left:108px;white-space:nowrap" class="ft13414">user is identified by an email address stored in the&#160;FLASKY_ADMIN&#160;configuration variable,</p>
<p style="position:absolute;top:136px;left:108px;white-space:nowrap" class="ft13414">so as soon as that email address appears in a registration request it can be given the</p>
<p style="position:absolute;top:156px;left:108px;white-space:nowrap" class="ft13414">correct role.&#160;<a href="Flask.html#134">Example 9-4&#160;shows how this is done in the&#160;</a>User&#160;model constructor.</p>
<p style="position:absolute;top:188px;left:108px;white-space:nowrap" class="ft13447"><i>Example 9-4. app/models.py: Define a default role for users<br/></i><b>class</b>&#160;<b>User</b>(UserMixin,&#160;db.Model):<br/>&#160; &#160;&#160;<i># ...<br/></i>&#160; &#160;&#160;<b>def</b>&#160;__init__(self,&#160;**kwargs):<br/>&#160; &#160; &#160; &#160;&#160;super(User,&#160;self).__init__(**kwargs)<br/>&#160; &#160; &#160; &#160;&#160;<b>if</b>&#160;self.role&#160;<b>is</b>&#160;None:<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>if</b>&#160;self.email&#160;==&#160;current_app.config['FLASKY_ADMIN']:<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;self.role&#160;=&#160;Role.query.filter_by(permissions=0xff).first()<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>if</b>&#160;self.role&#160;<b>is</b>&#160;None:<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;self.role&#160;=&#160;Role.query.filter_by(default=True).first()<br/>&#160; &#160;&#160;<i># ...</i></p>
<p style="position:absolute;top:381px;left:108px;white-space:nowrap" class="ft13414">The&#160;User&#160;constructor first invokes the constructors of the base classes, and if after that</p>
<p style="position:absolute;top:400px;left:108px;white-space:nowrap" class="ft13414">the object does not have a role defined, it sets the administrator or default roles de‐</p>
<p style="position:absolute;top:418px;left:108px;white-space:nowrap" class="ft13414">pending on the email address.</p>
<p style="position:absolute;top:454px;left:108px;white-space:nowrap" class="ft13418"><b>Role Verification<br/></b>To simplify the implementation of roles and permissions, a helper method can be added</p>
<p style="position:absolute;top:515px;left:108px;white-space:nowrap" class="ft13414">to the&#160;User&#160;model that checks whether a given permission is present, as shown in</p>
<p style="position:absolute;top:534px;left:108px;white-space:nowrap" class="ft13417"><a href="Flask.html#134">Example 9-5</a>.</p>
<p style="position:absolute;top:565px;left:108px;white-space:nowrap" class="ft13450"><i>Example 9-5. app/models.py: Evaluate whether a user has a given permission<br/></i><b>from</b>&#160;<b>flask.ext.login</b>&#160;<b>import</b>&#160;UserMixin,&#160;AnonymousUserMixin</p>
<p style="position:absolute;top:624px;left:108px;white-space:nowrap" class="ft13447"><b>class</b>&#160;<b>User</b>(UserMixin,&#160;db.Model):<br/>&#160; &#160;&#160;<i># ...</i></p>
<p style="position:absolute;top:670px;left:108px;white-space:nowrap" class="ft13423">&#160; &#160;&#160;<b>def</b>&#160;can(self,&#160;permissions):<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;self.role&#160;<b>is</b>&#160;<b>not</b>&#160;None&#160;<b>and</b>&#160;\<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;(self.role.permissions&#160;&amp;&#160;permissions)&#160;==&#160;permissions</p>
<p style="position:absolute;top:731px;left:108px;white-space:nowrap" class="ft13447">&#160; &#160;&#160;<b>def</b>&#160;is_administrator(self):<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;self.can(Permission.ADMINISTER)</p>
<p style="position:absolute;top:777px;left:108px;white-space:nowrap" class="ft13447"><b>class</b>&#160;<b>AnonymousUser</b>(AnonymousUserMixin):<br/>&#160; &#160;&#160;<b>def</b>&#160;can(self,&#160;permissions):<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;False</p>
<p style="position:absolute;top:838px;left:108px;white-space:nowrap" class="ft13447">&#160; &#160;&#160;<b>def</b>&#160;is_administrator(self):<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;False</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1345"><b>114&#160;&#160;|&#160;&#160;Chapter 9: User Roles</b></p>
</div>
<!-- Page 135 -->
<a name="135"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page135-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask135.png" alt="background image"/>
<p style="position:absolute;top:98px;left:108px;white-space:nowrap" class="ft13537">login_manager.anonymous_user&#160;=&#160;AnonymousUser</p>
<p style="position:absolute;top:125px;left:108px;white-space:nowrap" class="ft13514">The&#160;can()&#160;method added to the&#160;User&#160;model performs a&#160;<i>bitwise and</i>&#160;operation between</p>
<p style="position:absolute;top:144px;left:108px;white-space:nowrap" class="ft13546">the requested permissions and the permissions of the assigned role. The method returns<br/>True</p>
<p style="position:absolute;top:164px;left:138px;white-space:nowrap" class="ft13514">&#160;if all the requested bits are present in the role, which means that the user should</p>
<p style="position:absolute;top:183px;left:108px;white-space:nowrap" class="ft13514">be allowed to perform the task. The check for administration permissions is so common</p>
<p style="position:absolute;top:202px;left:108px;white-space:nowrap" class="ft13546">that it is also implemented as a standalone&#160;is_administrator()&#160;method.<br/>For consistency, a custom&#160;AnonymousUser&#160;class that implements the&#160;can()&#160;and<br/>is_administrator()</p>
<p style="position:absolute;top:251px;left:243px;white-space:nowrap" class="ft13514">&#160;methods is created. This object inherits from Flask-Login’s</p>
<p style="position:absolute;top:274px;left:108px;white-space:nowrap" class="ft13514">AnonymousUserMixin</p>
<p style="position:absolute;top:271px;left:243px;white-space:nowrap" class="ft13514">&#160;class and is registered as the class of the object that is assigned to</p>
<p style="position:absolute;top:294px;left:108px;white-space:nowrap" class="ft13514">current_user</p>
<p style="position:absolute;top:291px;left:198px;white-space:nowrap" class="ft13514">&#160;when the user is not logged in. This will enable the application to freely</p>
<p style="position:absolute;top:311px;left:108px;white-space:nowrap" class="ft13514">call&#160;current_user.can()&#160;and&#160;current_user.is_administrator()&#160;without having to</p>
<p style="position:absolute;top:329px;left:108px;white-space:nowrap" class="ft13515">check whether the user is logged in first.<br/>For cases in which an entire view function needs to be made available only to users with</p>
<p style="position:absolute;top:376px;left:108px;white-space:nowrap" class="ft13514">certain permissions, a custom decora<a href="Flask.html#135">tor can be used.&#160;Example 9-6&#160;</a>shows the imple‐</p>
<p style="position:absolute;top:395px;left:108px;white-space:nowrap" class="ft13514">mentation of two decorators, one for generic permission checks and one that checks</p>
<p style="position:absolute;top:414px;left:108px;white-space:nowrap" class="ft13514">specifically for administrator permission.</p>
<p style="position:absolute;top:446px;left:108px;white-space:nowrap" class="ft13540"><i>Example 9-6. app/decorators.py: Custom decorators that check user permissions<br/></i><b>from</b>&#160;<b>functools</b>&#160;<b>import</b>&#160;wraps<br/><b>from</b>&#160;<b>flask</b>&#160;<b>import</b>&#160;abort<br/><b>from</b>&#160;<b>flask.ext.login</b>&#160;<b>import</b>&#160;current_user</p>
<p style="position:absolute;top:535px;left:108px;white-space:nowrap" class="ft13540"><b>def</b>&#160;permission_required(permission):<br/>&#160; &#160;&#160;<b>def</b>&#160;decorator(f):<br/>&#160; &#160; &#160; &#160;&#160;@wraps(f)<br/>&#160; &#160; &#160; &#160;&#160;<b>def</b>&#160;decorated_function(*args,&#160;**kwargs):<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>if</b>&#160;<b>not</b>&#160;current_user.can(permission):<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;abort(403)<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;f(*args,&#160;**kwargs)<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;decorated_function<br/>&#160; &#160;&#160;<b>return</b>&#160;decorator</p>
<p style="position:absolute;top:688px;left:108px;white-space:nowrap" class="ft13547"><b>def</b>&#160;admin_required(f):<br/>&#160; &#160;&#160;<b>return</b>&#160;permission_required(Permission.ADMINISTER)(f)</p>
<p style="position:absolute;top:730px;left:108px;white-space:nowrap" class="ft13514">These decorators are built with the help of the&#160;<i>functools</i>&#160;package from the Python stan‐</p>
<p style="position:absolute;top:749px;left:108px;white-space:nowrap" class="ft13514">dard library, and return an error code 403, the “Forbidden” HTTP error, when the</p>
<p style="position:absolute;top:767px;left:108px;white-space:nowrap" class="ft13514">current user does not have the requested permissions. In&#160;<a href="Flask.html#41">Chapter 3</a>, custom error pages</p>
<p style="position:absolute;top:786px;left:108px;white-space:nowrap" class="ft13514">were created for errors 404 and 500, so now a page for the 403 error needs to be added</p>
<p style="position:absolute;top:805px;left:108px;white-space:nowrap" class="ft13515">as well.<br/>The following are two examples that demonstrate the usage of these decorators:</p>
<p style="position:absolute;top:915px;left:528px;white-space:nowrap" class="ft1355"><b>Role Verification&#160;&#160;|&#160;&#160;115</b></p>
</div>
<!-- Page 136 -->
<a name="136"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page136-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask136.png" alt="background image"/>
<p style="position:absolute;top:82px;left:134px;white-space:nowrap" class="ft13638"><b>from</b>&#160;<b>decorators</b>&#160;<b>import</b>&#160;admin_required,&#160;permission_required</p>
<p style="position:absolute;top:113px;left:134px;white-space:nowrap" class="ft13647">@main.route('/admin')<br/>@login_required<br/>@admin_required<br/><b>def</b>&#160;for_admins_only():<br/>&#160; &#160;&#160;<b>return</b>&#160;&#34;For administrators!&#34;</p>
<p style="position:absolute;top:205px;left:134px;white-space:nowrap" class="ft13647">@main.route('/moderator')<br/>@login_required<br/>@permission_required(Permission.MODERATE_COMMENTS)<br/><b>def</b>&#160;for_moderators_only():<br/>&#160; &#160;&#160;<b>return</b>&#160;&#34;For comment moderators!&#34;</p>
<p style="position:absolute;top:287px;left:108px;white-space:nowrap" class="ft13614">Permissions may also need to be checked from templates, so the&#160;Permission&#160;class with</p>
<p style="position:absolute;top:306px;left:108px;white-space:nowrap" class="ft13614">all the bit constants needs to be accessible to them. To avoid having to add a template</p>
<p style="position:absolute;top:326px;left:108px;white-space:nowrap" class="ft13614">argument in every&#160;render_template()&#160;call, a&#160;<i>context processor</i>&#160;can be used. Context</p>
<p style="position:absolute;top:345px;left:108px;white-space:nowrap" class="ft13614">processors make variables globally available to all templates. This change is shown in</p>
<p style="position:absolute;top:364px;left:108px;white-space:nowrap" class="ft13617"><a href="Flask.html#136">Example 9-7</a>.</p>
<p style="position:absolute;top:396px;left:108px;white-space:nowrap" class="ft13647"><i>Example 9-7.&#160;app/main/__init__.py: Adding the Permission class to the template con‐<br/>text<br/></i>@main.app_context_processor<br/><b>def</b>&#160;inject_permissions():<br/>&#160; &#160;&#160;<b>return</b>&#160;dict(Permission=Permission)</p>
<p style="position:absolute;top:499px;left:108px;white-space:nowrap" class="ft13614"><a href="Flask.html#136">The new roles and permissions can be exercised in unit tests.&#160;Example 9-8&#160;</a>shows two</p>
<p style="position:absolute;top:518px;left:108px;white-space:nowrap" class="ft13614">simple tests that also serve as a demonstration of the usage.</p>
<p style="position:absolute;top:550px;left:108px;white-space:nowrap" class="ft13647"><i>Example 9-8. tests/test_user_model.py: Unit tests for roles and permissions<br/></i><b>class</b>&#160;<b>UserModelTestCase</b>(unittest.TestCase):<br/>&#160; &#160;&#160;<i># ...</i></p>
<p style="position:absolute;top:624px;left:108px;white-space:nowrap" class="ft13647">&#160; &#160;&#160;<b>def</b>&#160;test_roles_and_permissions(self):<br/>&#160; &#160; &#160; &#160;&#160;Role.insert_roles()<br/>&#160; &#160; &#160; &#160;&#160;u&#160;=&#160;User(email='john@example.com',&#160;password='cat')<br/>&#160; &#160; &#160; &#160;&#160;self.assertTrue(u.can(Permission.WRITE_ARTICLES))<br/>&#160; &#160; &#160; &#160;&#160;self.assertFalse(u.can(Permission.MODERATE_COMMENTS))</p>
<p style="position:absolute;top:716px;left:108px;white-space:nowrap" class="ft13647">&#160; &#160;&#160;<b>def</b>&#160;test_anonymous_user(self):<br/>&#160; &#160; &#160; &#160;&#160;u&#160;=&#160;AnonymousUser()<br/>&#160; &#160; &#160; &#160;&#160;self.assertFalse(u.can(Permission.FOLLOW))</p>
<p style="position:absolute;top:780px;left:198px;white-space:nowrap" class="ft13625">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:798px;left:198px;white-space:nowrap" class="ft13625">run&#160;git&#160;checkout&#160;9a&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:816px;left:198px;white-space:nowrap" class="ft13631">This&#160;update&#160;contains&#160;a&#160;database&#160;migration,&#160;so&#160;remember&#160;to&#160;run<br/>python&#160;manage.py&#160;db&#160;upgrade</p>
<p style="position:absolute;top:834px;left:384px;white-space:nowrap" class="ft13625">&#160;after&#160;you&#160;check&#160;out&#160;the&#160;code.</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1365"><b>116&#160;&#160;|&#160;&#160;Chapter 9: User Roles</b></p>
</div>
<!-- Page 137 -->
<a name="137"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page137-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask137.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft13714">Before you move to the next chapter, it is a good idea to re-create or update the devel‐</p>
<p style="position:absolute;top:97px;left:108px;white-space:nowrap" class="ft13714">opment database so that all the user accounts that were created before roles and per‐</p>
<p style="position:absolute;top:116px;left:108px;white-space:nowrap" class="ft13715">missions existed have a role assigned.<br/>The user system is now fairly complete. The next chapter will make use of it to create</p>
<p style="position:absolute;top:163px;left:108px;white-space:nowrap" class="ft13714">user profile pages.</p>
<p style="position:absolute;top:915px;left:528px;white-space:nowrap" class="ft1375"><b>Role Verification&#160;&#160;|&#160;&#160;117</b></p>
</div>
<!-- Page 138 -->
<a name="138"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page138-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask138.png" alt="background image"/>
</div>
<!-- Page 139 -->
<a name="139"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page139-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask139.png" alt="background image"/>
<p style="position:absolute;top:104px;left:549px;white-space:nowrap" class="ft13928"><b>CHAPTER 10</b></p>
<p style="position:absolute;top:131px;left:494px;white-space:nowrap" class="ft13911"><b>User Profiles</b></p>
<p style="position:absolute;top:345px;left:108px;white-space:nowrap" class="ft13914">In this chapter, user profiles for Flasky are implemented. All socially aware sites give</p>
<p style="position:absolute;top:364px;left:108px;white-space:nowrap" class="ft13914">their users a profile page, where a summary of the user’s participation in the website is</p>
<p style="position:absolute;top:383px;left:108px;white-space:nowrap" class="ft13914">presented. Users can advertise their presence on the website by sharing the URL to their</p>
<p style="position:absolute;top:402px;left:108px;white-space:nowrap" class="ft13914">profile page, so it is important that the URLs be short and easy to remember.</p>
<p style="position:absolute;top:438px;left:108px;white-space:nowrap" class="ft13918"><b>Profile Information<br/></b>To make user profile pages more interesting, some additional information about users</p>
<p style="position:absolute;top:498px;left:108px;white-space:nowrap" class="ft13914"><a href="Flask.html#139">can be recorded. In&#160;Example 10-1&#160;the&#160;</a>User&#160;model is extended with several new fields.</p>
<p style="position:absolute;top:530px;left:108px;white-space:nowrap" class="ft13947"><i>Example 10-1. app/models.py: User information fields<br/></i><b>class</b>&#160;<b>User</b>(UserMixin,&#160;db.Model):<br/>&#160; &#160;&#160;<i># ...<br/></i>&#160; &#160;&#160;name&#160;=&#160;db.Column(db.String(64))<br/>&#160; &#160;&#160;location&#160;=&#160;db.Column(db.String(64))<br/>&#160; &#160;&#160;about_me&#160;=&#160;db.Column(db.Text())<br/>&#160; &#160;&#160;member_since&#160;=&#160;db.Column(db.DateTime(),&#160;default=datetime.utcnow)<br/>&#160; &#160;&#160;last_seen&#160;=&#160;db.Column(db.DateTime(),&#160;default=datetime.utcnow)</p>
<p style="position:absolute;top:676px;left:108px;white-space:nowrap" class="ft13914">The new fields store the user’s real name, location, self-written description, date of</p>
<p style="position:absolute;top:696px;left:108px;white-space:nowrap" class="ft13914">registration, and date of last visit. The&#160;about_me&#160;field is assigned the type&#160;db.Text().</p>
<p style="position:absolute;top:716px;left:108px;white-space:nowrap" class="ft13914">The difference between&#160;db.String&#160;and&#160;db.Text&#160;is that&#160;db.Text&#160;does not need a max‐</p>
<p style="position:absolute;top:735px;left:108px;white-space:nowrap" class="ft13946">imum length.<br/>The two timestamps are given a default value of the current time. Note that<br/>datetime.utcnow</p>
<p style="position:absolute;top:782px;left:220px;white-space:nowrap" class="ft13914">&#160;is missing the&#160;()&#160;at the end. This is because the&#160;default&#160;argument</p>
<p style="position:absolute;top:802px;left:108px;white-space:nowrap" class="ft13914">to&#160;db.Column()&#160;can take a function as a default value, so each time a default value needs</p>
<p style="position:absolute;top:821px;left:108px;white-space:nowrap" class="ft13914">to be generated the function is invoked to produce it. This default value is all that is</p>
<p style="position:absolute;top:841px;left:108px;white-space:nowrap" class="ft13914">needed to manage the&#160;member_since&#160;field.</p>
<p style="position:absolute;top:915px;left:631px;white-space:nowrap" class="ft1395"><b>119</b></p>
</div>
<!-- Page 140 -->
<a name="140"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page140-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask140.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft14014">The&#160;last_seen&#160;field is also initialized to the current time upon creation, but it needs to</p>
<p style="position:absolute;top:99px;left:108px;white-space:nowrap" class="ft14014">be refreshed each time the user accesses the site. A method in the&#160;User&#160;class can be</p>
<p style="position:absolute;top:118px;left:108px;white-space:nowrap" class="ft14014">added to perform this upda<a href="Flask.html#140">te. This is shown in&#160;Example 10-2.</a></p>
<p style="position:absolute;top:150px;left:108px;white-space:nowrap" class="ft14047"><i>Example 10-2. app/models.py: Refresh last visit time of a user<br/></i><b>class</b>&#160;<b>User</b>(UserMixin,&#160;db.Model):<br/>&#160; &#160;&#160;<i># ...</i></p>
<p style="position:absolute;top:224px;left:108px;white-space:nowrap" class="ft14047">&#160; &#160;&#160;<b>def</b>&#160;ping(self):<br/>&#160; &#160; &#160; &#160;&#160;self.last_seen&#160;=&#160;datetime.utcnow()<br/>&#160; &#160; &#160; &#160;&#160;db.session.add(self)</p>
<p style="position:absolute;top:282px;left:108px;white-space:nowrap" class="ft14014">The&#160;ping()&#160;method must be called each time a request from the user is received. Because</p>
<p style="position:absolute;top:301px;left:108px;white-space:nowrap" class="ft14014">the&#160;before_app_request&#160;handler in the&#160;auth&#160;blueprint runs before every request, it can</p>
<p style="position:absolute;top:320px;left:108px;white-space:nowrap" class="ft14014">do this easily<a href="Flask.html#140">, as shown in&#160;Example 10-3</a>.</p>
<p style="position:absolute;top:352px;left:108px;white-space:nowrap" class="ft14047"><i>Example 10-3. app/auth/views.py: Ping logged-in user<br/></i>@auth.before_app_request<br/><b>def</b>&#160;before_request():<br/>&#160; &#160;&#160;<b>if</b>&#160;current_user.is_authenticated():<br/>&#160; &#160; &#160; &#160;&#160;current_user.ping()<br/>&#160; &#160; &#160; &#160;&#160;<b>if</b>&#160;<b>not</b>&#160;current_user.confirmed&#160;\<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>and</b>&#160;request.endpoint[:5]&#160;!=&#160;'auth.':<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;redirect(url_for('auth.unconfirmed'))</p>
<p style="position:absolute;top:500px;left:108px;white-space:nowrap" class="ft14018"><b>User Profile Page<br/></b>Creating a profile page for each user does not present an<a href="Flask.html#140">y new challenges.&#160;Example 10-4</a></p>
<p style="position:absolute;top:560px;left:108px;white-space:nowrap" class="ft14014">shows the route definition.</p>
<p style="position:absolute;top:592px;left:108px;white-space:nowrap" class="ft14047"><i>Example 10-4. app/main/views.py: Profile page route<br/></i>@main.route('/user/&lt;username&gt;')<br/><b>def</b>&#160;user(username):<br/>&#160; &#160;&#160;user&#160;=&#160;User.query.filter_by(username=username).first()<br/>&#160; &#160;&#160;<b>if</b>&#160;user&#160;<b>is</b>&#160;None:<br/>&#160; &#160; &#160; &#160;&#160;abort(404)<br/>&#160; &#160;&#160;<b>return</b>&#160;render_template('user.html',&#160;user=user)</p>
<p style="position:absolute;top:723px;left:108px;white-space:nowrap" class="ft14014">This route is added in the&#160;main&#160;blueprint. For a user named&#160;john, the profile page will</p>
<p style="position:absolute;top:742px;left:108px;white-space:nowrap" class="ft14014">be at&#160;<i>http://localhost:5000/user/john</i>. The username given in the URL is searched in the</p>
<p style="position:absolute;top:761px;left:108px;white-space:nowrap" class="ft14014">database and, if found, the&#160;<i>user.html</i>&#160;template is rendered with it as the argument. An</p>
<p style="position:absolute;top:780px;left:108px;white-space:nowrap" class="ft14014">invalid username sent into this route will cause a 404 error to be returned. The&#160;<i>user.html</i></p>
<p style="position:absolute;top:799px;left:108px;white-space:nowrap" class="ft14014">template should render the information stored in the user object. An initial version of</p>
<p style="position:absolute;top:818px;left:108px;white-space:nowrap" class="ft14014">this templa<a href="Flask.html#140">te is shown in&#160;Example 10-5.</a></p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1405"><b>120&#160;&#160;|&#160;&#160;Chapter 10: User Profiles</b></p>
</div>
<!-- Page 141 -->
<a name="141"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page141-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask141.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft14166"><i>Example 10-5. app/templates/user.html: User profile template<br/></i>{% block page_content %}<br/><b>&lt;div</b>&#160;class=&#34;page-header&#34;<b>&gt;<br/></b>&#160; &#160;&#160;<b>&lt;h1&gt;</b>{{ user.username }}<b>&lt;/h1&gt;<br/></b>&#160; &#160; {% if user.name or user.location %}<br/>&#160; &#160;&#160;<b>&lt;p&gt;<br/></b>&#160; &#160; &#160; &#160; {% if user.name %}{{ user.name }}{% endif %}<br/>&#160; &#160; &#160; &#160; {% if user.location %}<br/>&#160; &#160; &#160; &#160; &#160; &#160; From&#160;<b>&lt;a</b>&#160;href=&#34;http://maps.google.com/?q={{ user.location }}&#34;<b>&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; {{ user.location }}<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;/a&gt;<br/></b>&#160; &#160; &#160; &#160; {% endif %}<br/>&#160; &#160;&#160;<b>&lt;/p&gt;<br/></b>&#160; &#160; {% endif %}<br/>&#160; &#160; {% if current_user.is_administrator() %}<br/>&#160; &#160;&#160;<b>&lt;p&gt;&lt;a</b>&#160;href=&#34;mailto:{{ user.email }}&#34;<b>&gt;</b>{{ user.email }}<b>&lt;/a&gt;&lt;/p&gt;<br/></b>&#160; &#160; {% endif %}<br/>&#160; &#160; {% if user.about_me %}<b>&lt;p&gt;</b>{{ user.about_me }}<b>&lt;/p&gt;</b>{% endif %}<br/>&#160; &#160;&#160;<b>&lt;p&gt;<br/></b>&#160; &#160; &#160; &#160; Member since {{ moment(user.member_since).format('L') }}.<br/>&#160; &#160; &#160; &#160; Last seen {{ moment(user.last_seen).fromNow() }}.<br/>&#160; &#160;&#160;<b>&lt;/p&gt;<br/>&lt;/div&gt;<br/></b>{% endblock %}</p>
<p style="position:absolute;top:470px;left:108px;white-space:nowrap" class="ft14114">This template has a few interesting implementation details:</p>
<p style="position:absolute;top:505px;left:121px;white-space:nowrap" class="ft14114">•&#160;The&#160;name&#160;and&#160;location&#160;fields are rendered inside a single&#160;&lt;p&gt;&#160;element. Only when</p>
<p style="position:absolute;top:525px;left:135px;white-space:nowrap" class="ft14114">at least one of the fields is defined is the&#160;&lt;p&gt;&#160;element created.</p>
<p style="position:absolute;top:551px;left:121px;white-space:nowrap" class="ft14119">•&#160;The user&#160;location&#160;field is rendered as a link to a Google Maps query.<br/>•&#160;If the logged-in user is an administrator, then email addresses are shown, rendered</p>
<p style="position:absolute;top:595px;left:135px;white-space:nowrap" class="ft14114">as a&#160;<i>mailto</i>&#160;link.</p>
<p style="position:absolute;top:628px;left:108px;white-space:nowrap" class="ft14114">As most users will want easy access to their own profile page, a link to it can be added</p>
<p style="position:absolute;top:647px;left:108px;white-space:nowrap" class="ft14114">to the navigation bar. The relevant changes to the&#160;<i>base.html</i>&#160;template are shown in</p>
<p style="position:absolute;top:666px;left:108px;white-space:nowrap" class="ft14117"><a href="Flask.html#141">Example 10-6.</a></p>
<p style="position:absolute;top:698px;left:108px;white-space:nowrap" class="ft14166"><i>Example 10-6. app/templates/base.html<br/></i>{% if current_user.is_authenticated() %}<br/><b>&lt;li&gt;<br/></b>&#160; &#160;&#160;<b>&lt;a</b>&#160;href=&#34;{{ url_for('main.user', username=current_user.username) }}&#34;<b>&gt;<br/></b>&#160; &#160; &#160; &#160; Profile<br/>&#160; &#160;&#160;<b>&lt;/a&gt;<br/>&lt;/li&gt;<br/></b>{% endif %}</p>
<p style="position:absolute;top:844px;left:108px;white-space:nowrap" class="ft14114">Using a conditional for the profile page link is necessary because the navigation bar is</p>
<p style="position:absolute;top:863px;left:108px;white-space:nowrap" class="ft14114">also rendered for nonauthenticated users, in which case the profile link is skipped.</p>
<p style="position:absolute;top:915px;left:526px;white-space:nowrap" class="ft1415"><b>User Profile Page&#160;&#160;|&#160;&#160;121</b></p>
</div>
<!-- Page 142 -->
<a name="142"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page142-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask142.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft14217"><a href="Flask.html#142">Figure 10-1</a>&#160;shows how the profile page looks in the browser. The new profile link in</p>
<p style="position:absolute;top:97px;left:108px;white-space:nowrap" class="ft14214">the navigation bar is also shown.</p>
<p style="position:absolute;top:139px;left:198px;white-space:nowrap" class="ft14225">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:157px;left:198px;white-space:nowrap" class="ft14225">run&#160;git&#160;checkout&#160;10a&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:174px;left:198px;white-space:nowrap" class="ft14231">This&#160;update&#160;contains&#160;a&#160;database&#160;migration,&#160;so&#160;remember&#160;to&#160;run<br/>python&#160;manage.py&#160;db&#160;upgrade</p>
<p style="position:absolute;top:192px;left:384px;white-space:nowrap" class="ft14225">&#160;after&#160;you&#160;check&#160;out&#160;the&#160;code.</p>
<p style="position:absolute;top:545px;left:108px;white-space:nowrap" class="ft14210"><i>Figure 10-1. User profile page</i></p>
<p style="position:absolute;top:580px;left:108px;white-space:nowrap" class="ft14218"><b>Profile Editor<br/></b>There are two different use cases related to editing of user profiles. The most obvious</p>
<p style="position:absolute;top:639px;left:108px;white-space:nowrap" class="ft14214">is that users need to have access to a page where they can enter information about</p>
<p style="position:absolute;top:658px;left:108px;white-space:nowrap" class="ft14214">themselves to present in their profile pages. A less obvious but also important require‐</p>
<p style="position:absolute;top:677px;left:108px;white-space:nowrap" class="ft14214">ment is to let administrators edit the profile of any users—not only the personal infor‐</p>
<p style="position:absolute;top:697px;left:108px;white-space:nowrap" class="ft14214">mation items but also other fields in the&#160;User&#160;model to which users have no direct access,</p>
<p style="position:absolute;top:716px;left:108px;white-space:nowrap" class="ft14214">such as the user role. Because the two profile editing requirements are substantially</p>
<p style="position:absolute;top:735px;left:108px;white-space:nowrap" class="ft14214">different, two different forms will be created.</p>
<p style="position:absolute;top:770px;left:108px;white-space:nowrap" class="ft14258"><b>User-Level Profile Editor<br/></b><a href="Flask.html#142">The profile edit form for regular users is shown in&#160;Example 10-7.</a></p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1425"><b>122&#160;&#160;|&#160;&#160;Chapter 10: User Profiles</b></p>
</div>
<!-- Page 143 -->
<a name="143"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page143-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask143.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft14347"><i>Example 10-7. app/main/forms.py: Profile edit form<br/></i><b>class</b>&#160;<b>EditProfileForm</b>(Form):<br/>&#160; &#160;&#160;name&#160;=&#160;StringField('Real name',&#160;validators=[Length(0,&#160;64)])<br/>&#160; &#160;&#160;location&#160;=&#160;StringField('Location',&#160;validators=[Length(0,&#160;64)])<br/>&#160; &#160;&#160;about_me&#160;=&#160;TextAreaField('About me')<br/>&#160; &#160;&#160;submit&#160;=&#160;SubmitField('Submit')</p>
<p style="position:absolute;top:195px;left:108px;white-space:nowrap" class="ft14314">Note that as all the fields in this form are optional, the length validator allows a length</p>
<p style="position:absolute;top:214px;left:108px;white-space:nowrap" class="ft14314">of zero. The route definition tha<a href="Flask.html#143">t uses this form is shown in&#160;Example 10-8.</a></p>
<p style="position:absolute;top:246px;left:108px;white-space:nowrap" class="ft14340"><i>Example 10-8. app/main/views.py: Profile edit route<br/></i>@main.route('/edit-profile',&#160;methods=['GET',&#160;'POST'])<br/>@login_required<br/><b>def</b>&#160;edit_profile():<br/>&#160; &#160;&#160;form&#160;=&#160;EditProfileForm()<br/>&#160; &#160;&#160;<b>if</b>&#160;form.validate_on_submit():<br/>&#160; &#160; &#160; &#160;&#160;current_user.name&#160;=&#160;form.name.data<br/>&#160; &#160; &#160; &#160;&#160;current_user.location&#160;=&#160;form.location.data<br/>&#160; &#160; &#160; &#160;&#160;current_user.about_me&#160;=&#160;form.about_me.data<br/>&#160; &#160; &#160; &#160;&#160;db.session.add(user)<br/>&#160; &#160; &#160; &#160;&#160;flash('Your profile has been updated.')<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;redirect(url_for('.user',&#160;username=current_user.username))<br/>&#160; &#160;&#160;form.name.data&#160;=&#160;current_user.name<br/>&#160; &#160;&#160;form.location.data&#160;=&#160;current_user.location<br/>&#160; &#160;&#160;form.about_me.data&#160;=&#160;current_user.about_me<br/>&#160; &#160;&#160;<b>return</b>&#160;render_template('edit_profile.html',&#160;form=form)</p>
<p style="position:absolute;top:514px;left:108px;white-space:nowrap" class="ft14314">This view function sets initial values for all the fields before presenting the form. For</p>
<p style="position:absolute;top:534px;left:108px;white-space:nowrap" class="ft14314">any given field, this is done by assigning the initial value to&#160;form.&lt;field-name&gt;.data.</p>
<p style="position:absolute;top:554px;left:108px;white-space:nowrap" class="ft14314">When&#160;form.validate_on_submit()&#160;is&#160;False, the three fields in this form are initialized</p>
<p style="position:absolute;top:574px;left:108px;white-space:nowrap" class="ft14346">from the corresponding fields in&#160;current_user. Then, when the form is submitted, the<br/>data</p>
<p style="position:absolute;top:593px;left:138px;white-space:nowrap" class="ft14314">&#160;attributes of the form fields contain the updated values, so these are moved back</p>
<p style="position:absolute;top:612px;left:108px;white-space:nowrap" class="ft14314">into the fields of the user object and the object is added to the database session.</p>
<p style="position:absolute;top:631px;left:108px;white-space:nowrap" class="ft14315"><a href="Flask.html#144">Figure 10-2&#160;shows the Edit Profile page.<br/></a>To make it easy for users to reach this page, a direct link can be added in the profile</p>
<p style="position:absolute;top:678px;left:108px;white-space:nowrap" class="ft14314"><a href="Flask.html#143">page, as shown in&#160;Example 10-9.</a></p>
<p style="position:absolute;top:710px;left:108px;white-space:nowrap" class="ft14366"><i>Example 10-9. app/templates/user.html: Profile edit link<br/></i>{% if user == current_user %}<br/><b>&lt;a</b>&#160;class=&#34;btn btn-default&#34;&#160;href=&#34;{{ url_for('.edit_profile') }}&#34;<b>&gt;<br/></b>&#160; &#160; Edit Profile<br/><b>&lt;/a&gt;<br/></b>{% endif %}</p>
<p style="position:absolute;top:825px;left:108px;white-space:nowrap" class="ft14314">The conditional that encloses the link will make the link appear only when users are</p>
<p style="position:absolute;top:844px;left:108px;white-space:nowrap" class="ft14314">viewing their own profiles.</p>
<p style="position:absolute;top:915px;left:543px;white-space:nowrap" class="ft1435"><b>Profile Editor&#160;&#160;|&#160;&#160;123</b></p>
</div>
<!-- Page 144 -->
<a name="144"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page144-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask144.png" alt="background image"/>
<p style="position:absolute;top:501px;left:108px;white-space:nowrap" class="ft14410"><i>Figure 10-2. Profile editor</i></p>
<p style="position:absolute;top:535px;left:108px;white-space:nowrap" class="ft14458"><b>Administrator-Level Profile Editor<br/></b>The profile edit form for administrators is more complex than the one for regular users.</p>
<p style="position:absolute;top:588px;left:108px;white-space:nowrap" class="ft14414">In addition to the three profile information fields, this form allows administrators to</p>
<p style="position:absolute;top:607px;left:108px;white-space:nowrap" class="ft14414">edit a user’s email, username, confirmed status, and role. The form is shown in</p>
<p style="position:absolute;top:626px;left:108px;white-space:nowrap" class="ft14417"><a href="Flask.html#144">Example 10-10</a>.</p>
<p style="position:absolute;top:658px;left:108px;white-space:nowrap" class="ft14447"><i>Example 10-10. app/main/forms.py: Profile editing form for administrators<br/></i><b>class</b>&#160;<b>EditProfileAdminForm</b>(Form):<br/>&#160; &#160;&#160;email&#160;=&#160;StringField('Email',&#160;validators=[Required(),&#160;Length(1,&#160;64),<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;Email()])<br/>&#160; &#160;&#160;username&#160;=&#160;StringField('Username',&#160;validators=[<br/>&#160; &#160; &#160; &#160;&#160;Required(),&#160;Length(1,&#160;64),&#160;Regexp('^[A-Za-z][A-Za-z0-9_.]*$',&#160;0,<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;'Usernames must have only letters, '<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;'numbers, dots or underscores')])<br/>&#160; &#160;&#160;confirmed&#160;=&#160;BooleanField('Confirmed')<br/>&#160; &#160;&#160;role&#160;=&#160;SelectField('Role',&#160;coerce=int)<br/>&#160; &#160;&#160;name&#160;=&#160;StringField('Real name',&#160;validators=[Length(0,&#160;64)])<br/>&#160; &#160;&#160;location&#160;=&#160;StringField('Location',&#160;validators=[Length(0,&#160;64)])<br/>&#160; &#160;&#160;about_me&#160;=&#160;TextAreaField('About me')<br/>&#160; &#160;&#160;submit&#160;=&#160;SubmitField('Submit')</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1445"><b>124&#160;&#160;|&#160;&#160;Chapter 10: User Profiles</b></p>
</div>
<!-- Page 145 -->
<a name="145"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page145-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask145.png" alt="background image"/>
<p style="position:absolute;top:98px;left:108px;white-space:nowrap" class="ft14547">&#160; &#160;&#160;<b>def</b>&#160;__init__(self,&#160;user,&#160;*args,&#160;**kwargs):<br/>&#160; &#160; &#160; &#160;&#160;super(EditProfileAdminForm,&#160;self).__init__(*args,&#160;**kwargs)<br/>&#160; &#160; &#160; &#160;&#160;self.role.choices&#160;=&#160;[(role.id,&#160;role.name)<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;<b>for</b>&#160;role&#160;<b>in</b>&#160;Role.query.order_by(Role.name).all()]<br/>&#160; &#160; &#160; &#160;&#160;self.user&#160;=&#160;user</p>
<p style="position:absolute;top:189px;left:108px;white-space:nowrap" class="ft14547">&#160; &#160;&#160;<b>def</b>&#160;validate_email(self,&#160;field):<br/>&#160; &#160; &#160; &#160;&#160;<b>if</b>&#160;field.data&#160;!=&#160;self.user.email&#160;<b>and</b>&#160;\<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;User.query.filter_by(email=field.data).first():<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>raise</b>&#160;ValidationError('Email already registered.')</p>
<p style="position:absolute;top:266px;left:108px;white-space:nowrap" class="ft14547">&#160; &#160;&#160;<b>def</b>&#160;validate_username(self,&#160;field):<br/>&#160; &#160; &#160; &#160;&#160;<b>if</b>&#160;field.data&#160;!=&#160;self.user.username&#160;<b>and</b>&#160;\<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;User.query.filter_by(username=field.data).first():<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>raise</b>&#160;ValidationError('Username already in use.')</p>
<p style="position:absolute;top:339px;left:108px;white-space:nowrap" class="ft14514">The&#160;SelectField&#160;is WTForm’s wrapper for the&#160;&lt;select&gt;&#160;HTML form control, which</p>
<p style="position:absolute;top:358px;left:108px;white-space:nowrap" class="ft14546">implements a dropdown list, used in this form to select a user role. An instance of<br/>SelectField</p>
<p style="position:absolute;top:378px;left:190px;white-space:nowrap" class="ft14514">&#160;must have the items set in its&#160;choices&#160;attribute. They must be given as a</p>
<p style="position:absolute;top:397px;left:108px;white-space:nowrap" class="ft14514">list of tuples, with each tuple consisting of two values: an identifier for the item and the</p>
<p style="position:absolute;top:417px;left:108px;white-space:nowrap" class="ft14514">text to show in the control as a string. The&#160;choices&#160;list is set in the form’s constructor,</p>
<p style="position:absolute;top:436px;left:108px;white-space:nowrap" class="ft14514">with values obtained from the&#160;Role&#160;model with a query that sorts all the roles alpha‐</p>
<p style="position:absolute;top:456px;left:108px;white-space:nowrap" class="ft14514">betically by name. The identifier for each tuple is set to the&#160;id&#160;of each role, and since</p>
<p style="position:absolute;top:476px;left:108px;white-space:nowrap" class="ft14514">these are integers, a&#160;coerce=int&#160;argument is added to the&#160;SelectField&#160;constructor so</p>
<p style="position:absolute;top:495px;left:108px;white-space:nowrap" class="ft14548">that the field values are stored as integers instead of the default, which is strings.<br/>The&#160;email&#160;and&#160;username&#160;fields are constructed in the same way as in the authentication</p>
<p style="position:absolute;top:543px;left:108px;white-space:nowrap" class="ft14514">forms, but their validation requires some careful handling. The validation condition</p>
<p style="position:absolute;top:562px;left:108px;white-space:nowrap" class="ft14514">used for both these fields must first check whether a change to the field was made, and</p>
<p style="position:absolute;top:581px;left:108px;white-space:nowrap" class="ft14514">only when there is a change should it ensure that the new value does not duplicate</p>
<p style="position:absolute;top:599px;left:108px;white-space:nowrap" class="ft14514">another user’s. When these fields are not changed, then validation should pass. To im‐</p>
<p style="position:absolute;top:618px;left:108px;white-space:nowrap" class="ft14514">plement this logic, the form’s constructor receives the user object as an argument and</p>
<p style="position:absolute;top:637px;left:108px;white-space:nowrap" class="ft14515">saves it as a member variable, which is later used in the custom validation methods.<br/>The route definition for the administrator’s profile editor is shown in&#160;<a href="Flask.html#145">Example 10-11.</a></p>
<p style="position:absolute;top:697px;left:108px;white-space:nowrap" class="ft14540"><i>Example 10-11. app/main/views.py: Profile edit route for administrators<br/></i>@main.route('/edit-profile/&lt;int:id&gt;',&#160;methods=['GET',&#160;'POST'])<br/>@login_required<br/>@admin_required<br/><b>def</b>&#160;edit_profile_admin(id):<br/>&#160; &#160;&#160;user&#160;=&#160;User.query.get_or_404(id)<br/>&#160; &#160;&#160;form&#160;=&#160;EditProfileAdminForm(user=user)<br/>&#160; &#160;&#160;<b>if</b>&#160;form.validate_on_submit():<br/>&#160; &#160; &#160; &#160;&#160;user.email&#160;=&#160;form.email.data<br/>&#160; &#160; &#160; &#160;&#160;user.username&#160;=&#160;form.username.data<br/>&#160; &#160; &#160; &#160;&#160;user.confirmed&#160;=&#160;form.confirmed.data</p>
<p style="position:absolute;top:915px;left:543px;white-space:nowrap" class="ft1455"><b>Profile Editor&#160;&#160;|&#160;&#160;125</b></p>
</div>
<!-- Page 146 -->
<a name="146"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page146-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask146.png" alt="background image"/>
<p style="position:absolute;top:82px;left:108px;white-space:nowrap" class="ft14640">&#160; &#160; &#160; &#160;&#160;user.role&#160;=&#160;Role.query.get(form.role.data)<br/>&#160; &#160; &#160; &#160;&#160;user.name&#160;=&#160;form.name.data<br/>&#160; &#160; &#160; &#160;&#160;user.location&#160;=&#160;form.location.data<br/>&#160; &#160; &#160; &#160;&#160;user.about_me&#160;=&#160;form.about_me.data<br/>&#160; &#160; &#160; &#160;&#160;db.session.add(user)<br/>&#160; &#160; &#160; &#160;&#160;flash('The profile has been updated.')<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;redirect(url_for('.user',&#160;username=user.username))<br/>&#160; &#160;&#160;form.email.data&#160;=&#160;user.email<br/>&#160; &#160;&#160;form.username.data&#160;=&#160;user.username<br/>&#160; &#160;&#160;form.confirmed.data&#160;=&#160;user.confirmed<br/>&#160; &#160;&#160;form.role.data&#160;=&#160;user.role_id<br/>&#160; &#160;&#160;form.name.data&#160;=&#160;user.name<br/>&#160; &#160;&#160;form.location.data&#160;=&#160;user.location<br/>&#160; &#160;&#160;form.about_me.data&#160;=&#160;user.about_me<br/>&#160; &#160;&#160;<b>return</b>&#160;render_template('edit_profile.html',&#160;form=form,&#160;user=user)</p>
<p style="position:absolute;top:323px;left:108px;white-space:nowrap" class="ft14614">This route has largely the same structure as the simpler one for regular users. In this</p>
<p style="position:absolute;top:343px;left:108px;white-space:nowrap" class="ft14614">view function, the user is given by its&#160;id, so Flask-SQLAlchemy’s&#160;get_or_404()&#160;con‐</p>
<p style="position:absolute;top:363px;left:108px;white-space:nowrap" class="ft14614">venience function can be used, knowing that if the&#160;id&#160;is invalid the request will return</p>
<p style="position:absolute;top:381px;left:108px;white-space:nowrap" class="ft14648">a code 404 error.<br/>The&#160;SelectField&#160;used for the user role also deserves to be studied. When setting the</p>
<p style="position:absolute;top:430px;left:108px;white-space:nowrap" class="ft14614">initial value for the field, the&#160;role_id&#160;is assigned to&#160;field.role.data&#160;because the list</p>
<p style="position:absolute;top:450px;left:108px;white-space:nowrap" class="ft14614">of tuples set in the&#160;choices&#160;attribute uses the numeric identifiers to reference each</p>
<p style="position:absolute;top:470px;left:108px;white-space:nowrap" class="ft14614">option. When the form is submitted, the&#160;id&#160;is extracted from the field’s&#160;data&#160;attribute</p>
<p style="position:absolute;top:490px;left:108px;white-space:nowrap" class="ft14614">and used in a query to load the role object by its&#160;id. The&#160;coerce=int&#160;argument used in</p>
<p style="position:absolute;top:509px;left:108px;white-space:nowrap" class="ft14614">the&#160;SelectField&#160;declaration in the form ensures that the&#160;data&#160;attribute of this field is</p>
<p style="position:absolute;top:528px;left:108px;white-space:nowrap" class="ft14615">an integer.<br/>To link to this page, another button is added in the user profile page, as shown in</p>
<p style="position:absolute;top:575px;left:108px;white-space:nowrap" class="ft14617"><a href="Flask.html#146">Example 10-12</a>.</p>
<p style="position:absolute;top:607px;left:108px;white-space:nowrap" class="ft14666"><i>Example 10-12. app/templates/user.html: Profile edit link for administrator<br/></i>{% if current_user.is_administrator() %}<br/><b>&lt;a</b>&#160;class=&#34;btn btn-danger&#34;<br/>&#160; &#160; &#160; &#160;&#160;href=&#34;{{ url_for('.edit_profile_admin', id=user.id) }}&#34;<b>&gt;<br/></b>&#160; &#160; Edit Profile [Admin]<br/><b>&lt;/a&gt;<br/></b>{% endif %}</p>
<p style="position:absolute;top:738px;left:108px;white-space:nowrap" class="ft14614">This button is rendered with a different Bootstrap style to call attention to it. The con‐</p>
<p style="position:absolute;top:757px;left:108px;white-space:nowrap" class="ft14614">ditional in this case makes the button appear in profile pages if the logged-in user is an</p>
<p style="position:absolute;top:776px;left:108px;white-space:nowrap" class="ft14614">administrator.</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1465"><b>126&#160;&#160;|&#160;&#160;Chapter 10: User Profiles</b></p>
</div>
<!-- Page 147 -->
<a name="147"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page147-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask147.png" alt="background image"/>
<p style="position:absolute;top:85px;left:198px;white-space:nowrap" class="ft14725">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:103px;left:198px;white-space:nowrap" class="ft14725">run&#160;git&#160;checkout&#160;10b&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:187px;left:108px;white-space:nowrap" class="ft14718"><b>User Avatars<br/></b>The look of the profile pages can be improved by showing avatar pictures of users. In</p>
<p style="position:absolute;top:247px;left:108px;white-space:nowrap" class="ft14714">this section, you will learn how to add user avatars provided by&#160;<a href="http://gravatar.com/">Gravatar</a>, the leading</p>
<p style="position:absolute;top:266px;left:108px;white-space:nowrap" class="ft14714">avatar service. Gravatar associates avatar images with email addresses. Users create an</p>
<p style="position:absolute;top:285px;left:108px;white-space:nowrap" class="ft14714">account at&#160;<i>http://gravatar.com</i>&#160;and then upload their images. To generate the avatar</p>
<p style="position:absolute;top:303px;left:108px;white-space:nowrap" class="ft14714">URL for a given email address, its MD5 hash is calculated:</p>
<p style="position:absolute;top:335px;left:133px;white-space:nowrap" class="ft14747">(venv)&#160;$&#160;python<br/>&gt;&gt;&gt;&#160;<b>import</b>&#160;<b>hashlib<br/></b>&gt;&gt;&gt;&#160;hashlib.md5('john@example.com'.encode('utf-8')).hexdigest()<br/>'d4c74594d841139328695756648b6bd6'</p>
<p style="position:absolute;top:402px;left:108px;white-space:nowrap" class="ft14714">The avatar URLs are then generated by appending the MD5 hash to URL&#160;<i>http://</i></p>
<p style="position:absolute;top:421px;left:108px;white-space:nowrap" class="ft14710"><i>www.gravatar.com/avatar/</i></p>
<p style="position:absolute;top:420px;left:277px;white-space:nowrap" class="ft14714">&#160;or&#160;<i>https://secure.gravatar.com/avatar/</i>. For example, you</p>
<p style="position:absolute;top:439px;left:108px;white-space:nowrap" class="ft14714">can type&#160;<i>http://www.gravatar.com/avatar/d4c74594d841139328695756648b6bd6</i>&#160;in</p>
<p style="position:absolute;top:458px;left:108px;white-space:nowrap" class="ft14746">your browser’s address bar to get the avatar image for the email address<br/>john@example.com</p>
<p style="position:absolute;top:478px;left:228px;white-space:nowrap" class="ft14714">, or a default generated image if that email address does not have an</p>
<p style="position:absolute;top:497px;left:108px;white-space:nowrap" class="ft14714">avatar registered. The query string of the URL can include several arguments that con‐</p>
<p style="position:absolute;top:516px;left:108px;white-space:nowrap" class="ft14748">figure the characteristics of the ava<a href="Flask.html#147">tar image, listed in&#160;Table 10-1</a>.<br/><i>Table 10-1. Gravatar query string arguments</i></p>
<p style="position:absolute;top:573px;left:113px;white-space:nowrap" class="ft14753"><b>Argument&#160;name&#160;Description</b></p>
<p style="position:absolute;top:597px;left:113px;white-space:nowrap" class="ft14714">s</p>
<p style="position:absolute;top:594px;left:197px;white-space:nowrap" class="ft14730">Image&#160;size,&#160;in&#160;pixels.</p>
<p style="position:absolute;top:621px;left:113px;white-space:nowrap" class="ft14714">r</p>
<p style="position:absolute;top:621px;left:197px;white-space:nowrap" class="ft14730">Image&#160;rating.&#160;Options&#160;are&#160;&#34;g&#34;,&#160;&#34;pg&#34;,&#160;&#34;r&#34;,&#160;and&#160;&#34;x&#34;.</p>
<p style="position:absolute;top:645px;left:113px;white-space:nowrap" class="ft14714">d</p>
<p style="position:absolute;top:643px;left:197px;white-space:nowrap" class="ft14775">The&#160;default&#160;image&#160;generator&#160;for&#160;users&#160;who&#160;have&#160;no&#160;avatars&#160;registered&#160;with&#160;the&#160;Gravatar&#160;service.&#160;Options&#160;are<br/>&#34;404&#34;</p>
<p style="position:absolute;top:661px;left:235px;white-space:nowrap" class="ft14730">&#160;to&#160;return&#160;a&#160;404&#160;error,&#160;a&#160;URL&#160;that&#160;points&#160;to&#160;a&#160;default&#160;image,&#160;or&#160;one&#160;of&#160;the&#160;following&#160;image&#160;generators:</p>
<p style="position:absolute;top:680px;left:197px;white-space:nowrap" class="ft14714">&#34;mm&#34;</p>
<p style="position:absolute;top:680px;left:227px;white-space:nowrap" class="ft14730">,&#160;&#34;identicon&#34;,&#160;&#34;monsterid&#34;,&#160;&#34;wavatar&#34;,&#160;&#34;retro&#34;,&#160;or&#160;&#34;blank&#34;.</p>
<p style="position:absolute;top:704px;left:113px;white-space:nowrap" class="ft14714">fd</p>
<p style="position:absolute;top:701px;left:197px;white-space:nowrap" class="ft14730">Force&#160;the&#160;use&#160;of&#160;default&#160;avatars.</p>
<p style="position:absolute;top:738px;left:108px;white-space:nowrap" class="ft14714">The knowledge of how to build a Gravatar URL can be added to the&#160;User&#160;model. The</p>
<p style="position:absolute;top:757px;left:108px;white-space:nowrap" class="ft14714">implementation is shown in&#160;<a href="Flask.html#147">Example 10-13.</a></p>
<p style="position:absolute;top:789px;left:108px;white-space:nowrap" class="ft14741"><i>Example 10-13. app/models.py: Gravatar URL generation<br/></i><b>import</b>&#160;<b>hashlib<br/>from</b>&#160;<b>flask</b>&#160;<b>import</b>&#160;request</p>
<p style="position:absolute;top:862px;left:108px;white-space:nowrap" class="ft14738"><b>class</b>&#160;<b>User</b>(UserMixin,&#160;db.Model):</p>
<p style="position:absolute;top:915px;left:546px;white-space:nowrap" class="ft1475"><b>User Avatars&#160;&#160;|&#160;&#160;127</b></p>
</div>
<!-- Page 148 -->
<a name="148"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page148-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask148.png" alt="background image"/>
<p style="position:absolute;top:82px;left:108px;white-space:nowrap" class="ft14847">&#160; &#160;&#160;<i># ...<br/></i>&#160; &#160;&#160;<b>def</b>&#160;gravatar(self,&#160;size=100,&#160;default='identicon',&#160;rating='g'):<br/>&#160; &#160; &#160; &#160;&#160;<b>if</b>&#160;request.is_secure:<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;url&#160;=&#160;'https://secure.gravatar.com/avatar'<br/>&#160; &#160; &#160; &#160;&#160;<b>else</b>:<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;url&#160;=&#160;'http://www.gravatar.com/avatar'<br/>&#160; &#160; &#160; &#160;&#160;hash&#160;=&#160;hashlib.md5(self.email.encode('utf-8')).hexdigest()<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;'{url}/{hash}?s={size}&amp;d={default}&amp;r={rating}'.format(<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;url=url,&#160;hash=hash,&#160;size=size,&#160;default=default,&#160;rating=rating)</p>
<p style="position:absolute;top:231px;left:108px;white-space:nowrap" class="ft14814">This implementation selects the standard or secure Gravatar base URL to match the</p>
<p style="position:absolute;top:250px;left:108px;white-space:nowrap" class="ft14814">security of the client request. The avatar URL is generated from the base URL, the MD5</p>
<p style="position:absolute;top:269px;left:108px;white-space:nowrap" class="ft14814">hash of the user’s email address, and the arguments, all of which have default values.</p>
<p style="position:absolute;top:288px;left:108px;white-space:nowrap" class="ft14814">With this implementation it is easy to generate avatar URLs in the Python shell:</p>
<p style="position:absolute;top:320px;left:134px;white-space:nowrap" class="ft14847">(venv)&#160;$&#160;python&#160;manage.py&#160;shell<br/>&gt;&gt;&gt;&#160;u&#160;=&#160;User(email='john@example.com')<br/>&gt;&gt;&gt;&#160;u.gravatar()<br/>'http://www.gravatar.com/avatar/d4c74594d84113932869575bd6?s=100&amp;d=identicon&amp;r=g'<br/>&gt;&gt;&gt;&#160;u.gravatar(size=256)<br/>'http://www.gravatar.com/avatar/d4c74594d84113932869575bd6?s=256&amp;d=identicon&amp;r=g'</p>
<p style="position:absolute;top:417px;left:108px;white-space:nowrap" class="ft14814">The&#160;gravatar()&#160;method can also be invoked from Jinja2 templa<a href="Flask.html#148">tes.&#160;Example 10-14</a></p>
<p style="position:absolute;top:436px;left:108px;white-space:nowrap" class="ft14814">shows how a 256-pixel avatar can be added to the profile page.</p>
<p style="position:absolute;top:468px;left:108px;white-space:nowrap" class="ft14866"><i>Example 10-14. app/tempaltes/user.html: Avatar in profile page<br/></i>...<br/><b>&lt;img</b>&#160;class=&#34;img-rounded profile-thumbnail&#34;&#160;src=&#34;{{ user.gravatar(size=256) }}&#34;<b>&gt;<br/></b>...</p>
<p style="position:absolute;top:553px;left:108px;white-space:nowrap" class="ft14814">Using a similar approach, the base template adds a small thumbnail image of the logged-</p>
<p style="position:absolute;top:572px;left:108px;white-space:nowrap" class="ft14814">in user in the navigation bar. To better format the avatar pictures in the page, custom</p>
<p style="position:absolute;top:591px;left:108px;white-space:nowrap" class="ft14814">CSS classes are used. You can find these in the source code repository in a&#160;<i>styles.css</i>&#160;file</p>
<p style="position:absolute;top:610px;left:108px;white-space:nowrap" class="ft14814">added to the application’s static file folder and referenced from the&#160;<i>base.html</i>&#160;template.</p>
<p style="position:absolute;top:629px;left:108px;white-space:nowrap" class="ft14817"><a href="Flask.html#149">Figure 10-3&#160;shows the user profile page with a</a>vatar.</p>
<p style="position:absolute;top:670px;left:198px;white-space:nowrap" class="ft14825">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:688px;left:198px;white-space:nowrap" class="ft14825">run&#160;git&#160;checkout&#160;10c&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:777px;left:108px;white-space:nowrap" class="ft14814">The generation of avatars requires an MD5 hash to be generated, which is a CPU-</p>
<p style="position:absolute;top:795px;left:108px;white-space:nowrap" class="ft14814">intensive operation. If a large number of avatars need to be generated for a page, then</p>
<p style="position:absolute;top:814px;left:108px;white-space:nowrap" class="ft14814">the computational work can be significant. Since the MD5 hash for a user will remain</p>
<p style="position:absolute;top:834px;left:108px;white-space:nowrap" class="ft14846">constant, it can be&#160;<i>cached</i>&#160;in the&#160;User&#160;<a href="Flask.html#149">model.&#160;Example 10-15&#160;</a>shows the changes to the<br/>User</p>
<p style="position:absolute;top:854px;left:138px;white-space:nowrap" class="ft14814">&#160;model to store the MD5 hashes in the database.</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1485"><b>128&#160;&#160;|&#160;&#160;Chapter 10: User Profiles</b></p>
</div>
<!-- Page 149 -->
<a name="149"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page149-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask149.png" alt="background image"/>
<p style="position:absolute;top:453px;left:108px;white-space:nowrap" class="ft14910"><i>Figure 10-3. User profile page with avatar</i></p>
<p style="position:absolute;top:493px;left:108px;white-space:nowrap" class="ft14968"><i>Example 10-15. app/models.py: Gravatar URL generation with caching of MD5 hashes<br/></i><b>class</b>&#160;<b>User</b>(UserMixin,&#160;db.Model):<br/>&#160; &#160;&#160;<i># ...<br/></i>&#160; &#160;&#160;avatar_hash&#160;=&#160;db.Column(db.String(32))</p>
<p style="position:absolute;top:582px;left:108px;white-space:nowrap" class="ft14947">&#160; &#160;&#160;<b>def</b>&#160;__init__(self,&#160;**kwargs):<br/>&#160; &#160; &#160; &#160;&#160;<i># ...<br/></i>&#160; &#160; &#160; &#160;&#160;<b>if</b>&#160;self.email&#160;<b>is</b>&#160;<b>not</b>&#160;None&#160;<b>and</b>&#160;self.avatar_hash&#160;<b>is</b>&#160;None:<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;self.avatar_hash&#160;=&#160;hashlib.md5(<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;self.email.encode('utf-8')).hexdigest()</p>
<p style="position:absolute;top:674px;left:108px;white-space:nowrap" class="ft14947">&#160; &#160;&#160;<b>def</b>&#160;change_email(self,&#160;token):<br/>&#160; &#160; &#160; &#160;&#160;<i># ...<br/></i>&#160; &#160; &#160; &#160;&#160;self.email&#160;=&#160;new_email<br/>&#160; &#160; &#160; &#160;&#160;self.avatar_hash&#160;=&#160;hashlib.md5(<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;self.email.encode('utf-8')).hexdigest()<br/>&#160; &#160; &#160; &#160;&#160;db.session.add(self)<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;True</p>
<p style="position:absolute;top:796px;left:108px;white-space:nowrap" class="ft14957">&#160; &#160;&#160;<b>def</b>&#160;gravatar(self,&#160;size=100,&#160;default='identicon',&#160;rating='g'):<br/>&#160; &#160; &#160; &#160;&#160;<b>if</b>&#160;request.is_secure:<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;url&#160;=&#160;'https://secure.gravatar.com/avatar'<br/>&#160; &#160; &#160; &#160;&#160;<b>else</b>:<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;url&#160;=&#160;'http://www.gravatar.com/avatar'<br/>&#160; &#160; &#160; &#160;&#160;hash&#160;=&#160;self.avatar_hash&#160;<b>or</b>&#160;hashlib.md5(</p>
<p style="position:absolute;top:915px;left:546px;white-space:nowrap" class="ft1495"><b>User Avatars&#160;&#160;|&#160;&#160;129</b></p>
</div>
<!-- Page 150 -->
<a name="150"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page150-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask150.png" alt="background image"/>
<p style="position:absolute;top:82px;left:108px;white-space:nowrap" class="ft15047">&#160; &#160; &#160; &#160; &#160; &#160;&#160;self.email.encode('utf-8')).hexdigest()<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;'{url}/{hash}?s={size}&amp;d={default}&amp;r={rating}'.format(<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;url=url,&#160;hash=hash,&#160;size=size,&#160;default=default,&#160;rating=rating)</p>
<p style="position:absolute;top:139px;left:108px;white-space:nowrap" class="ft15014">During model initialization, the hash is calculated from the email and stored, and in the</p>
<p style="position:absolute;top:159px;left:108px;white-space:nowrap" class="ft15014">event that the user updates the email address the hash is recalculated. The&#160;gravatar()</p>
<p style="position:absolute;top:178px;left:108px;white-space:nowrap" class="ft15014">method uses the hash from the model if available; if not, it works as before and generates</p>
<p style="position:absolute;top:197px;left:108px;white-space:nowrap" class="ft15014">the hash from the email address.</p>
<p style="position:absolute;top:239px;left:198px;white-space:nowrap" class="ft15025">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:257px;left:198px;white-space:nowrap" class="ft15025">run&#160;git&#160;checkout&#160;10d&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:274px;left:198px;white-space:nowrap" class="ft15031">This&#160;update&#160;contains&#160;a&#160;database&#160;migration,&#160;so&#160;remember&#160;to&#160;run<br/>python&#160;manage.py&#160;db&#160;upgrade</p>
<p style="position:absolute;top:292px;left:384px;white-space:nowrap" class="ft15025">&#160;after&#160;you&#160;check&#160;out&#160;the&#160;code.</p>
<p style="position:absolute;top:345px;left:108px;white-space:nowrap" class="ft15014">In the next chapter, the blogging engine that powers this application will be created.</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1505"><b>130&#160;&#160;|&#160;&#160;Chapter 10: User Profiles</b></p>
</div>
<!-- Page 151 -->
<a name="151"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page151-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask151.png" alt="background image"/>
<p style="position:absolute;top:104px;left:549px;white-space:nowrap" class="ft15128"><b>CHAPTER 11</b></p>
<p style="position:absolute;top:131px;left:520px;white-space:nowrap" class="ft15111"><b>Blog Posts</b></p>
<p style="position:absolute;top:345px;left:108px;white-space:nowrap" class="ft15114">This chapter is dedicated to the implementation of Flasky’s main feature, which is to</p>
<p style="position:absolute;top:364px;left:108px;white-space:nowrap" class="ft15114">allow users to read and write blog posts. Here you will learn a few new techniques for</p>
<p style="position:absolute;top:383px;left:108px;white-space:nowrap" class="ft15114">reuse of templates, pagination of long lists of items, and working with rich text.</p>
<p style="position:absolute;top:419px;left:108px;white-space:nowrap" class="ft15118"><b>Blog Post Submission and Display<br/></b>To support blog posts, a new database model that represents them is necessary. This</p>
<p style="position:absolute;top:478px;left:108px;white-space:nowrap" class="ft15114">model is shown in&#160;<a href="Flask.html#151">Example 11-1</a>.</p>
<p style="position:absolute;top:510px;left:108px;white-space:nowrap" class="ft15147"><i>Example 11-1. app/models.py: Post model<br/></i><b>class</b>&#160;<b>Post</b>(db.Model):<br/>&#160; &#160;&#160;__tablename__&#160;=&#160;'posts'<br/>&#160; &#160;&#160;id&#160;=&#160;db.Column(db.Integer,&#160;primary_key=True)<br/>&#160; &#160;&#160;body&#160;=&#160;db.Column(db.Text)<br/>&#160; &#160;&#160;timestamp&#160;=&#160;db.Column(db.DateTime,&#160;index=True,&#160;default=datetime.utcnow)<br/>&#160; &#160;&#160;author_id&#160;=&#160;db.Column(db.Integer,&#160;db.ForeignKey('users.id'))</p>
<p style="position:absolute;top:645px;left:108px;white-space:nowrap" class="ft15168"><b>class</b>&#160;<b>User</b>(UserMixin,&#160;db.Model):<br/>&#160; &#160;&#160;<i># ...<br/></i>&#160; &#160;&#160;posts&#160;=&#160;db.relationship('Post',&#160;backref='author',&#160;lazy='dynamic')</p>
<p style="position:absolute;top:702px;left:108px;white-space:nowrap" class="ft15114">A blog post is is represented by a body, a timestamp, and a one-to-many relationship</p>
<p style="position:absolute;top:722px;left:108px;white-space:nowrap" class="ft15114">from the&#160;User&#160;model. The&#160;body&#160;field is defined with type&#160;db.Text&#160;so that there is no</p>
<p style="position:absolute;top:741px;left:108px;white-space:nowrap" class="ft15115">limitation on the length.<br/>The form that will be shown in the main page of the application lets users write a blog</p>
<p style="position:absolute;top:788px;left:108px;white-space:nowrap" class="ft15114">post. This form is very simple; it contains just a text area where the blog post can be</p>
<p style="position:absolute;top:807px;left:108px;white-space:nowrap" class="ft15114">typed and a submit button. The form definition is shown in&#160;<a href="Flask.html#151">Example 11-2</a>.</p>
<p style="position:absolute;top:915px;left:631px;white-space:nowrap" class="ft1515"><b>131</b></p>
</div>
<!-- Page 152 -->
<a name="152"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page152-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask152.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft15247"><i>Example 11-2. app/main/forms.py: Blog post form<br/></i><b>class</b>&#160;<b>PostForm</b>(Form):<br/>&#160; &#160;&#160;body&#160;=&#160;TextAreaField(&#34;What's on your mind?&#34;,&#160;validators=[Required()])<br/>&#160; &#160;&#160;submit&#160;=&#160;SubmitField('Submit')</p>
<p style="position:absolute;top:165px;left:108px;white-space:nowrap" class="ft15214">The&#160;index()&#160;view function handles the form and passes the list of old blog posts to the</p>
<p style="position:absolute;top:184px;left:108px;white-space:nowrap" class="ft15214">templa<a href="Flask.html#152">te, as shown in&#160;Example 11-3</a>.</p>
<p style="position:absolute;top:216px;left:108px;white-space:nowrap" class="ft15247"><i>Example 11-3. app/main/views.py: Home page route with a blog post<br/></i>@main.route('/',&#160;methods=['GET',&#160;'POST'])<br/><b>def</b>&#160;index():<br/>&#160; &#160;&#160;form&#160;=&#160;PostForm()<br/>&#160; &#160;&#160;<b>if</b>&#160;current_user.can(Permission.WRITE_ARTICLES)&#160;<b>and</b>&#160;\<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;form.validate_on_submit():<br/>&#160; &#160; &#160; &#160;&#160;post&#160;=&#160;Post(body=form.body.data,<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;author=current_user._get_current_object())<br/>&#160; &#160; &#160; &#160;&#160;db.session.add(post)<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;redirect(url_for('.index'))<br/>&#160; &#160;&#160;posts&#160;=&#160;Post.query.order_by(Post.timestamp.desc()).all()<br/>&#160; &#160;&#160;<b>return</b>&#160;render_template('index.html',&#160;form=form,&#160;posts=posts)</p>
<p style="position:absolute;top:423px;left:108px;white-space:nowrap" class="ft15214">This view function passes the form and the complete list of blog posts to the template.</p>
<p style="position:absolute;top:442px;left:108px;white-space:nowrap" class="ft15214">The list of posts is ordered by their timestamp in descending order. The blog post form</p>
<p style="position:absolute;top:462px;left:108px;white-space:nowrap" class="ft15214">is handled in the usual manner, with the creation of a new&#160;Post&#160;instance when a valid</p>
<p style="position:absolute;top:481px;left:108px;white-space:nowrap" class="ft15214">submission is received. The current user’s permission to write articles is checked before</p>
<p style="position:absolute;top:500px;left:108px;white-space:nowrap" class="ft15246">allowing the new post.<br/>Note the way the&#160;author&#160;attribute of the new post object is set to the expression<br/>current_user._get_current_object()</p>
<p style="position:absolute;top:548px;left:363px;white-space:nowrap" class="ft15214">. The&#160;current_user&#160;variable from Flask-</p>
<p style="position:absolute;top:567px;left:108px;white-space:nowrap" class="ft15214">Login, like all context variables, is implemented as a thread-local proxy object. This</p>
<p style="position:absolute;top:586px;left:108px;white-space:nowrap" class="ft15214">object behaves like a user object but is really a thin wrapper that contains the actual user</p>
<p style="position:absolute;top:605px;left:108px;white-space:nowrap" class="ft15246">object inside. The database needs a real user object, which is obtained by calling<br/>_get_current_object()</p>
<p style="position:absolute;top:625px;left:266px;white-space:nowrap" class="ft15214">.</p>
<p style="position:absolute;top:653px;left:108px;white-space:nowrap" class="ft15214">The form is rendered below the greeting in the&#160;<i>index.html</i>&#160;template, followed by the</p>
<p style="position:absolute;top:672px;left:108px;white-space:nowrap" class="ft15214">blog posts. The list of blog posts is a first attempt to create a blog post timeline, with all</p>
<p style="position:absolute;top:691px;left:108px;white-space:nowrap" class="ft15214">the blog posts in the database listed in chronological order from newest to oldest. The</p>
<p style="position:absolute;top:709px;left:108px;white-space:nowrap" class="ft15214">changes to the template are shown in&#160;<a href="Flask.html#152">Example 11-4</a>.</p>
<p style="position:absolute;top:741px;left:108px;white-space:nowrap" class="ft15223"><i>Example 11-4. app/templates/index.html: Home page template with blog posts<br/></i>{% extends &#34;base.html&#34; %}<br/>{% import &#34;bootstrap/wtf.html&#34; as wtf %}<br/>...<br/><b>&lt;div&gt;<br/></b>&#160; &#160; {% if current_user.can(Permission.WRITE_ARTICLES) %}<br/>&#160; &#160; {{ wtf.quick_form(form) }}<br/>&#160; &#160; {% endif %}</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1525"><b>132&#160;&#160;|&#160;&#160;Chapter 11: Blog Posts</b></p>
</div>
<!-- Page 153 -->
<a name="153"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page153-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask153.png" alt="background image"/>
<p style="position:absolute;top:82px;left:108px;white-space:nowrap" class="ft15366"><b>&lt;/div&gt;<br/>&lt;ul</b>&#160;class=&#34;posts&#34;<b>&gt;<br/></b>&#160; &#160; {% for post in posts %}<br/>&#160; &#160;&#160;<b>&lt;li</b>&#160;class=&#34;post&#34;<b>&gt;<br/></b>&#160; &#160; &#160; &#160;&#160;<b>&lt;div</b>&#160;class=&#34;profile-thumbnail&#34;<b>&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;a</b>&#160;href=&#34;{{ url_for('.user', username=post.author.username) }}&#34;<b>&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;img</b>&#160;class=&#34;img-rounded profile-thumbnail&#34;<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;src=&#34;{{ post.author.gravatar(size=40) }}&#34;<b>&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;/a&gt;<br/></b>&#160; &#160; &#160; &#160;&#160;<b>&lt;/div&gt;<br/></b>&#160; &#160; &#160; &#160;&#160;<b>&lt;div</b>&#160;class=&#34;post-date&#34;<b>&gt;</b>{{ moment(post.timestamp).fromNow() }}<b>&lt;/div&gt;<br/></b>&#160; &#160; &#160; &#160;&#160;<b>&lt;div</b>&#160;class=&#34;post-author&#34;<b>&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;a</b>&#160;href=&#34;{{ url_for('.user', username=post.author.username) }}&#34;<b>&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; {{ post.author.username }}<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;/a&gt;<br/></b>&#160; &#160; &#160; &#160;&#160;<b>&lt;/div&gt;<br/></b>&#160; &#160; &#160; &#160;&#160;<b>&lt;div</b>&#160;class=&#34;post-body&#34;<b>&gt;</b>{{ post.body }}<b>&lt;/div&gt;<br/></b>&#160; &#160;&#160;<b>&lt;/li&gt;<br/></b>&#160; &#160; {% endfor %}<br/><b>&lt;/ul&gt;<br/></b>...</p>
<p style="position:absolute;top:416px;left:108px;white-space:nowrap" class="ft15314">Note that the&#160;User.can()&#160;method is used to skip the blog post form for users who do</p>
<p style="position:absolute;top:435px;left:108px;white-space:nowrap" class="ft15314">not have the&#160;WRITE_ARTICLES&#160;permission in their role. The blog post list is implemented</p>
<p style="position:absolute;top:454px;left:108px;white-space:nowrap" class="ft15314">as an HTML unordered list, with CSS classes giving it nicer formatting. A small avatar</p>
<p style="position:absolute;top:473px;left:108px;white-space:nowrap" class="ft15314">of the author is rendered on the left side, and both the avatar and the author’s username</p>
<p style="position:absolute;top:492px;left:108px;white-space:nowrap" class="ft15314">are rendered as links to the user profile page. The CSS styles used are stored in a&#160;<i>styles.css</i></p>
<p style="position:absolute;top:511px;left:108px;white-space:nowrap" class="ft15314">file in the application’s&#160;<i>static</i>&#160;folder. You can review this file in the GitHub repository.</p>
<p style="position:absolute;top:530px;left:108px;white-space:nowrap" class="ft15317"><a href="Flask.html#153">Figure 11-1&#160;shows the home page with submission form and blog post list.</a></p>
<p style="position:absolute;top:572px;left:198px;white-space:nowrap" class="ft15325">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:590px;left:198px;white-space:nowrap" class="ft15325">run&#160;git&#160;checkout&#160;11a&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:607px;left:198px;white-space:nowrap" class="ft15331">This&#160;update&#160;contains&#160;a&#160;database&#160;migration,&#160;so&#160;remember&#160;to&#160;run<br/>python&#160;manage.py&#160;db&#160;upgrade</p>
<p style="position:absolute;top:625px;left:384px;white-space:nowrap" class="ft15325">&#160;after&#160;you&#160;check&#160;out&#160;the&#160;code.</p>
<p style="position:absolute;top:915px;left:454px;white-space:nowrap" class="ft1535"><b>Blog Post Submission and Display&#160;&#160;|&#160;&#160;133</b></p>
</div>
<!-- Page 154 -->
<a name="154"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page154-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask154.png" alt="background image"/>
<p style="position:absolute;top:478px;left:108px;white-space:nowrap" class="ft15410"><i>Figure 11-1. Home page with blog submission form and blog post list</i></p>
<p style="position:absolute;top:513px;left:108px;white-space:nowrap" class="ft15418"><b>Blog Posts on Profile Pages<br/></b>The user profile page can be improved by showing a list of blog posts authored by the</p>
<p style="position:absolute;top:572px;left:108px;white-space:nowrap" class="ft15414">user.&#160;<a href="Flask.html#154">Example 11-5&#160;shows the changes to the view function to obtain the post list.</a></p>
<p style="position:absolute;top:604px;left:108px;white-space:nowrap" class="ft15447"><i>Example 11-5. app/main/views.py: Profile page route with blog posts<br/></i>@main.route('/user/&lt;username&gt;')<br/><b>def</b>&#160;user(username):<br/>&#160; &#160;&#160;user&#160;=&#160;User.query.filter_by(username=username).first()<br/>&#160; &#160;&#160;<b>if</b>&#160;user&#160;<b>is</b>&#160;None:<br/>&#160; &#160; &#160; &#160;&#160;abort(404)<br/>&#160; &#160;&#160;posts&#160;=&#160;user.posts.order_by(Post.timestamp.desc()).all()<br/>&#160; &#160;&#160;<b>return</b>&#160;render_template('user.html',&#160;user=user,&#160;posts=posts)</p>
<p style="position:absolute;top:751px;left:108px;white-space:nowrap" class="ft15414">The list of blog posts for a user is obtained from the&#160;User.posts&#160;relationship, which is</p>
<p style="position:absolute;top:771px;left:108px;white-space:nowrap" class="ft15448">a query object, so filters such as&#160;order_by()&#160;can be used on it as well.<br/>The&#160;<i>user.html</i>&#160;template requires the&#160;&lt;ul&gt;&#160;HTML tree that renders a list of blog posts</p>
<p style="position:absolute;top:819px;left:108px;white-space:nowrap" class="ft15414">like the one in&#160;<i>index.html</i>. Having to maintain two identical copies of a piece of HTML</p>
<p style="position:absolute;top:838px;left:108px;white-space:nowrap" class="ft15414">is not ideal, so for cases like this, Jinja2’s&#160;include()&#160;directive is very useful. The&#160;<i>user.html</i></p>
<p style="position:absolute;top:857px;left:108px;white-space:nowrap" class="ft15414">templa<a href="Flask.html#155">te includes the list from an external file, as shown in&#160;Example 11-6</a>.</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1545"><b>134&#160;&#160;|&#160;&#160;Chapter 11: Blog Posts</b></p>
</div>
<!-- Page 155 -->
<a name="155"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page155-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask155.png" alt="background image"/>
<p style="position:absolute;top:94px;left:108px;white-space:nowrap" class="ft15523"><i>Example 11-6. app/templates/user.html: Profile page template with blog posts<br/></i>...<br/><b>&lt;h3&gt;</b>Posts by {{ user.username }}<b>&lt;/h3&gt;<br/></b>{% include '_posts.html' %}<br/>...</p>
<p style="position:absolute;top:195px;left:108px;white-space:nowrap" class="ft15514">To complete this reorganization, the&#160;&lt;ul&gt;&#160;tree from&#160;<i>index.html</i>&#160;is moved to the new</p>
<p style="position:absolute;top:215px;left:108px;white-space:nowrap" class="ft15514">template&#160;<i>_posts.html</i>, and replaced with another&#160;include()&#160;directive. Note that the use</p>
<p style="position:absolute;top:234px;left:108px;white-space:nowrap" class="ft15514">of an underscore prefix in the&#160;<i>_posts.html</i>&#160;template name is not a requirement; this is</p>
<p style="position:absolute;top:253px;left:108px;white-space:nowrap" class="ft15514">merely a convention to distinguish standalone and partial templates.</p>
<p style="position:absolute;top:295px;left:198px;white-space:nowrap" class="ft15525">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:313px;left:198px;white-space:nowrap" class="ft15525">run&#160;git&#160;checkout&#160;11b&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:397px;left:108px;white-space:nowrap" class="ft15518"><b>Paginating Long Blog Post Lists<br/></b>As the site grows and the number of blog posts increases, it will become slow and im‐</p>
<p style="position:absolute;top:456px;left:108px;white-space:nowrap" class="ft15514">practical to show the complete list of posts on the home and profile pages. Big pages</p>
<p style="position:absolute;top:475px;left:108px;white-space:nowrap" class="ft15514">take longer to generate, download, and render in the web browser, so the quality of the</p>
<p style="position:absolute;top:494px;left:108px;white-space:nowrap" class="ft15514">user experience decreases as the pages get larger. The solution is to&#160;<i>paginate</i>&#160;the data</p>
<p style="position:absolute;top:513px;left:108px;white-space:nowrap" class="ft15514">and render it in chunks.</p>
<p style="position:absolute;top:548px;left:108px;white-space:nowrap" class="ft15558"><b>Creating Fake Blog Post Data<br/></b>To be able to work with multiple pages of blog posts, it is necessary to have a test database</p>
<p style="position:absolute;top:601px;left:108px;white-space:nowrap" class="ft15514">with a large volume of data. Manually adding new database entries is time consuming</p>
<p style="position:absolute;top:620px;left:108px;white-space:nowrap" class="ft15514">and tedious; an automated solution is more appropriate. There are several Python</p>
<p style="position:absolute;top:639px;left:108px;white-space:nowrap" class="ft15514">packages that can be used to generate fake information. A fairly complete one is&#160;<i>Forg‐</i></p>
<p style="position:absolute;top:659px;left:108px;white-space:nowrap" class="ft15510"><i>eryPy</i></p>
<p style="position:absolute;top:658px;left:143px;white-space:nowrap" class="ft15514">, which is installed with pip:</p>
<p style="position:absolute;top:689px;left:133px;white-space:nowrap" class="ft15533">(venv)&#160;$&#160;pip install forgerypy</p>
<p style="position:absolute;top:710px;left:108px;white-space:nowrap" class="ft15514">The ForgeryPy package is not, strictly speaking, a dependency of the application, be‐</p>
<p style="position:absolute;top:729px;left:108px;white-space:nowrap" class="ft15514">cause it is needed only during development. To separate the production dependencies</p>
<p style="position:absolute;top:748px;left:108px;white-space:nowrap" class="ft15514">from the development dependencies, the&#160;<i>requirements.txt</i>&#160;file can be replaced with a</p>
<p style="position:absolute;top:768px;left:108px;white-space:nowrap" class="ft15510"><i>requirements</i></p>
<p style="position:absolute;top:767px;left:190px;white-space:nowrap" class="ft15514">&#160;folder that stores different sets of dependencies. Inside this new folder a</p>
<p style="position:absolute;top:786px;left:108px;white-space:nowrap" class="ft15510"><i>dev.txt</i></p>
<p style="position:absolute;top:785px;left:150px;white-space:nowrap" class="ft15514">&#160;file can list the dependencies that are necessary for development and a&#160;<i>prod.txt</i></p>
<p style="position:absolute;top:804px;left:108px;white-space:nowrap" class="ft15514">file can list the dependencies that are needed in production. As there is a large number</p>
<p style="position:absolute;top:823px;left:108px;white-space:nowrap" class="ft15514">of dependencies that will be in both lists, a&#160;<i>common.txt</i>&#160;file is added for those, and then</p>
<p style="position:absolute;top:843px;left:108px;white-space:nowrap" class="ft15514">the&#160;<i>dev.txt</i>&#160;and&#160;<i>prod.txt</i>&#160;lists use the&#160;-r&#160;prefix to include it.&#160;<a href="Flask.html#156">Example 11-7&#160;</a>shows the</p>
<p style="position:absolute;top:863px;left:108px;white-space:nowrap" class="ft15510"><i>dev.txt</i></p>
<p style="position:absolute;top:862px;left:150px;white-space:nowrap" class="ft15514">&#160;file.</p>
<p style="position:absolute;top:915px;left:463px;white-space:nowrap" class="ft1555"><b>Paginating Long Blog Post Lists&#160;&#160;|&#160;&#160;135</b></p>
</div>
<!-- Page 156 -->
<a name="156"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page156-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask156.png" alt="background image"/>
<p style="position:absolute;top:94px;left:108px;white-space:nowrap" class="ft15647"><i>Example 11-7. requirements/dev.txt: Development requirements file<br/></i>-r common.txt<br/>ForgeryPy==0.1</p>
<p style="position:absolute;top:165px;left:108px;white-space:nowrap" class="ft15617"><a href="Flask.html#156">Example 11-8</a>&#160;shows class methods added to the&#160;User&#160;and&#160;Post&#160;models that can generate</p>
<p style="position:absolute;top:184px;left:108px;white-space:nowrap" class="ft15614">fake data.</p>
<p style="position:absolute;top:216px;left:108px;white-space:nowrap" class="ft15640"><i>Example 11-8. app/models.py: Generate fake users and blog posts<br/></i><b>class</b>&#160;<b>User</b>(UserMixin,&#160;db.Model):<br/>&#160; &#160;&#160;<i># ...<br/></i>&#160; &#160;&#160;@staticmethod<br/>&#160; &#160;&#160;<b>def</b>&#160;generate_fake(count=100):<br/>&#160; &#160; &#160; &#160;&#160;<b>from</b>&#160;<b>sqlalchemy.exc</b>&#160;<b>import</b>&#160;IntegrityError<br/>&#160; &#160; &#160; &#160;&#160;<b>from</b>&#160;<b>random</b>&#160;<b>import</b>&#160;seed<br/>&#160; &#160; &#160; &#160;&#160;<b>import</b>&#160;<b>forgery_py</b></p>
<p style="position:absolute;top:366px;left:108px;white-space:nowrap" class="ft15647">&#160; &#160; &#160; &#160;&#160;seed()<br/>&#160; &#160; &#160; &#160;&#160;<b>for</b>&#160;i&#160;<b>in</b>&#160;range(count):<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;u&#160;=&#160;User(email=forgery_py.internet.email_address(),<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;username=forgery_py.internet.user_name(True),<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;password=forgery_py.lorem_ipsum.word(),<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;confirmed=True,<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;name=forgery_py.name.full_name(),<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;location=forgery_py.address.city(),<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;about_me=forgery_py.lorem_ipsum.sentence(),<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;member_since=forgery_py.date.date(True))<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;db.session.add(u)<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>try</b>:<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;db.session.commit()<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>except</b>&#160;IntegrityError:<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;db.session.rollback()</p>
<p style="position:absolute;top:611px;left:108px;white-space:nowrap" class="ft15640"><b>class</b>&#160;<b>Post</b>(db.Model):<br/>&#160; &#160;&#160;<i># ...<br/></i>&#160; &#160;&#160;@staticmethod<br/>&#160; &#160;&#160;<b>def</b>&#160;generate_fake(count=100):<br/>&#160; &#160; &#160; &#160;&#160;<b>from</b>&#160;<b>random</b>&#160;<b>import</b>&#160;seed,&#160;randint<br/>&#160; &#160; &#160; &#160;&#160;<b>import</b>&#160;<b>forgery_py</b></p>
<p style="position:absolute;top:718px;left:108px;white-space:nowrap" class="ft15647">&#160; &#160; &#160; &#160;&#160;seed()<br/>&#160; &#160; &#160; &#160;&#160;user_count&#160;=&#160;User.query.count()<br/>&#160; &#160; &#160; &#160;&#160;<b>for</b>&#160;i&#160;<b>in</b>&#160;range(count):<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;u&#160;=&#160;User.query.offset(randint(0,&#160;user_count&#160;-&#160;1)).first()<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;p&#160;=&#160;Post(body=forgery_py.lorem_ipsum.sentences(randint(1,&#160;3)),<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;timestamp=forgery_py.date.date(True),<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;author=u)<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;db.session.add(p)<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;db.session.commit()</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1565"><b>136&#160;&#160;|&#160;&#160;Chapter 11: Blog Posts</b></p>
</div>
<!-- Page 157 -->
<a name="157"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page157-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask157.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft15714">The attributes of these fake objects are generated with ForgeryPy random information</p>
<p style="position:absolute;top:97px;left:108px;white-space:nowrap" class="ft15714">generators, which can generate real-looking names, emails, sentences, and many more</p>
<p style="position:absolute;top:116px;left:108px;white-space:nowrap" class="ft15715">attributes.<br/>The email addresses and usernames of users must be unique, but since ForgeryPy gen‐</p>
<p style="position:absolute;top:163px;left:108px;white-space:nowrap" class="ft15714">erates these in completely random fashion, there is a risk of having duplicates. In this</p>
<p style="position:absolute;top:183px;left:108px;white-space:nowrap" class="ft15714">unlikely event, the database session commit will throw an&#160;IntegrityError&#160;exception.</p>
<p style="position:absolute;top:202px;left:108px;white-space:nowrap" class="ft15714">This exception is handled by rolling back the session before continuing. The loop iter‐</p>
<p style="position:absolute;top:221px;left:108px;white-space:nowrap" class="ft15714">ations that produce a duplicate will not write a user to the database, so the total number</p>
<p style="position:absolute;top:240px;left:108px;white-space:nowrap" class="ft15746">of fake users added can be less than the number requested.<br/>The random post generation must assign a random user to each post. For this the<br/>offset()</p>
<p style="position:absolute;top:287px;left:168px;white-space:nowrap" class="ft15714">&#160;query filter is used. This filter discards the number of results given as an</p>
<p style="position:absolute;top:307px;left:108px;white-space:nowrap" class="ft15714">argument. By setting a random offset and then calling&#160;first(), a different random user</p>
<p style="position:absolute;top:326px;left:108px;white-space:nowrap" class="ft15714">is obtained each time.</p>
<p style="position:absolute;top:368px;left:198px;white-space:nowrap" class="ft15725">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:386px;left:198px;white-space:nowrap" class="ft15725">run&#160;git&#160;checkout&#160;11c&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:404px;left:198px;white-space:nowrap" class="ft15780">To&#160;ensure&#160;that&#160;you&#160;have&#160;all&#160;the&#160;dependencies&#160;installed,&#160;also&#160;run&#160;pip<br/>install&#160;-r&#160;requirements/dev.txt</p>
<p style="position:absolute;top:422px;left:410px;white-space:nowrap" class="ft15725">.</p>
<p style="position:absolute;top:474px;left:108px;white-space:nowrap" class="ft15714">The new methods make it easy to create a large number of fake users and posts from</p>
<p style="position:absolute;top:493px;left:108px;white-space:nowrap" class="ft15714">the Python shell:</p>
<p style="position:absolute;top:524px;left:134px;white-space:nowrap" class="ft15747">(venv)&#160;$&#160;python&#160;manage.py&#160;shell<br/>&gt;&gt;&gt;&#160;User.generate_fake(100)<br/>&gt;&gt;&gt;&#160;Post.generate_fake(100)</p>
<p style="position:absolute;top:576px;left:108px;white-space:nowrap" class="ft15714">If you run the application now, you will see a long list of random blog posts on the home</p>
<p style="position:absolute;top:594px;left:108px;white-space:nowrap" class="ft15714">page.</p>
<p style="position:absolute;top:630px;left:108px;white-space:nowrap" class="ft15758"><b>Rendering Data on Pages<br/></b><a href="Flask.html#157">Example 11-9&#160;shows the changes to the home page route to support pagina</a>tion.</p>
<p style="position:absolute;top:696px;left:108px;white-space:nowrap" class="ft15747"><i>Example 11-9. app/main/views.py: Paginate the blog post list<br/></i>@main.route('/',&#160;methods=['GET',&#160;'POST'])<br/><b>def</b>&#160;index():<br/>&#160; &#160;&#160;<i># ...<br/></i>&#160; &#160;&#160;page&#160;=&#160;request.args.get('page',&#160;1,&#160;type=int)<br/>&#160; &#160;&#160;pagination&#160;=&#160;Post.query.order_by(Post.timestamp.desc()).paginate(<br/>&#160; &#160; &#160; &#160;&#160;page,&#160;per_page=current_app.config['FLASKY_POSTS_PER_PAGE'],<br/>&#160; &#160; &#160; &#160;&#160;error_out=False)<br/>&#160; &#160;&#160;posts&#160;=&#160;pagination.items<br/>&#160; &#160;&#160;<b>return</b>&#160;render_template('index.html',&#160;form=form,&#160;posts=posts,<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;pagination=pagination)</p>
<p style="position:absolute;top:915px;left:463px;white-space:nowrap" class="ft1575"><b>Paginating Long Blog Post Lists&#160;&#160;|&#160;&#160;137</b></p>
</div>
<!-- Page 158 -->
<a name="158"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page158-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask158.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft15814">The page number to render is obtained from the request’s query string, which is available</p>
<p style="position:absolute;top:98px;left:108px;white-space:nowrap" class="ft15814">as&#160;request.args. When an explicit page isn’t given, a default page of 1 (the first page)</p>
<p style="position:absolute;top:118px;left:108px;white-space:nowrap" class="ft15814">is used. The&#160;type=int&#160;argument ensures that if the argument cannot be converted to</p>
<p style="position:absolute;top:137px;left:108px;white-space:nowrap" class="ft15846">an integer, the default value is returned.<br/>To load a single page of records, the call to&#160;all()&#160;is replaced with Flask-SQLAlchemy’s<br/>paginate()</p>
<p style="position:absolute;top:186px;left:183px;white-space:nowrap" class="ft15814">. The&#160;paginate()&#160;method takes the page number as the first and only re‐</p>
<p style="position:absolute;top:205px;left:108px;white-space:nowrap" class="ft15814">quired argument. An optional&#160;per_page&#160;argument can be given to indicate the size of</p>
<p style="position:absolute;top:224px;left:108px;white-space:nowrap" class="ft15814">each page, in number of items. If this argument is not specified, the default is 20 items</p>
<p style="position:absolute;top:244px;left:108px;white-space:nowrap" class="ft15814">per page. Another optional argument called&#160;error_out&#160;can be set to&#160;True&#160;(the default)</p>
<p style="position:absolute;top:264px;left:108px;white-space:nowrap" class="ft15814">to issue a code 404 error when a page outside of the valid range is requested. If&#160;error_out</p>
<p style="position:absolute;top:284px;left:108px;white-space:nowrap" class="ft15814">is&#160;False, pages outside of the valid range are returned with an empty list of items. To</p>
<p style="position:absolute;top:304px;left:108px;white-space:nowrap" class="ft15814">make the page sizes configurable, the value of the&#160;per_page&#160;argument is read from an</p>
<p style="position:absolute;top:323px;left:108px;white-space:nowrap" class="ft15815">application-specific configuration variable called&#160;FLASKY_POSTS_PER_PAGE.<br/>With these changes, the blog post list in the home page will show a limited number of</p>
<p style="position:absolute;top:370px;left:108px;white-space:nowrap" class="ft15814">items. To see the second page of posts, add a&#160;<i>?page=2</i>&#160;query string to the URL in the</p>
<p style="position:absolute;top:389px;left:108px;white-space:nowrap" class="ft15814">browser’s address bar.</p>
<p style="position:absolute;top:425px;left:108px;white-space:nowrap" class="ft15852"><b>Adding a Pagination Widget<br/></b>The return value of&#160;paginate()&#160;is an object of class&#160;Pagination, a class defined by Flask-</p>
<p style="position:absolute;top:478px;left:108px;white-space:nowrap" class="ft15814">SQLAlchemy. This object contains several properties that are useful to generate page</p>
<p style="position:absolute;top:497px;left:108px;white-space:nowrap" class="ft15814">links in a template, so it is passed to the template as an argument. A summary of the</p>
<p style="position:absolute;top:516px;left:108px;white-space:nowrap" class="ft15848">attributes of the pagina<a href="Flask.html#158">tion object is shown in&#160;Table 11-1</a>.<br/><i>Table 11-1. Flask-SQLAlchemy pagination object attributes</i></p>
<p style="position:absolute;top:573px;left:113px;white-space:nowrap" class="ft15853"><b>Attribute</b></p>
<p style="position:absolute;top:573px;left:184px;white-space:nowrap" class="ft15853"><b>Description</b></p>
<p style="position:absolute;top:597px;left:113px;white-space:nowrap" class="ft15814">items</p>
<p style="position:absolute;top:595px;left:184px;white-space:nowrap" class="ft15830">The&#160;records&#160;in&#160;the&#160;current&#160;page</p>
<p style="position:absolute;top:621px;left:113px;white-space:nowrap" class="ft15814">query</p>
<p style="position:absolute;top:619px;left:184px;white-space:nowrap" class="ft15830">The&#160;source&#160;query&#160;that&#160;was&#160;paginated</p>
<p style="position:absolute;top:645px;left:113px;white-space:nowrap" class="ft15814">page</p>
<p style="position:absolute;top:643px;left:184px;white-space:nowrap" class="ft15830">The&#160;current&#160;page&#160;number</p>
<p style="position:absolute;top:669px;left:113px;white-space:nowrap" class="ft15814">prev_num&#160;The&#160;previous&#160;page&#160;number</p>
<p style="position:absolute;top:694px;left:113px;white-space:nowrap" class="ft15814">next_num&#160;The&#160;next&#160;page&#160;number</p>
<p style="position:absolute;top:718px;left:113px;white-space:nowrap" class="ft15814">has_next&#160;True</p>
<p style="position:absolute;top:717px;left:214px;white-space:nowrap" class="ft15830">&#160;if&#160;there&#160;is&#160;a&#160;next&#160;page</p>
<p style="position:absolute;top:742px;left:113px;white-space:nowrap" class="ft15814">has_prev&#160;True</p>
<p style="position:absolute;top:742px;left:214px;white-space:nowrap" class="ft15830">&#160;if&#160;there&#160;is&#160;a&#160;previous&#160;page</p>
<p style="position:absolute;top:766px;left:113px;white-space:nowrap" class="ft15814">pages</p>
<p style="position:absolute;top:763px;left:184px;white-space:nowrap" class="ft15830">The&#160;total&#160;number&#160;of&#160;pages&#160;for&#160;the&#160;query</p>
<p style="position:absolute;top:790px;left:113px;white-space:nowrap" class="ft15814">per_page&#160;The&#160;number&#160;of&#160;items&#160;per&#160;page</p>
<p style="position:absolute;top:814px;left:113px;white-space:nowrap" class="ft15814">total</p>
<p style="position:absolute;top:811px;left:184px;white-space:nowrap" class="ft15830">The&#160;total&#160;number&#160;of&#160;items&#160;returned&#160;by&#160;the&#160;query</p>
<p style="position:absolute;top:847px;left:108px;white-space:nowrap" class="ft15814">The pagina<a href="Flask.html#159">tion object also has some methods, listed in&#160;Table 11-2.</a></p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1585"><b>138&#160;&#160;|&#160;&#160;Chapter 11: Blog Posts</b></p>
</div>
<!-- Page 159 -->
<a name="159"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft15982{font-size:13px;line-height:18px;font-family:Times;color:#231f20;}
	.ft15983{font-size:10px;line-height:15px;font-family:Times;color:#999999;}
-->
</style>
<div id="page159-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask159.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft15910"><i>Table 11-2. Flask-SQLAlchemy pagination object attributes</i></p>
<p style="position:absolute;top:107px;left:113px;white-space:nowrap" class="ft15953"><b>Method</b></p>
<p style="position:absolute;top:107px;left:313px;white-space:nowrap" class="ft15953"><b>Description</b></p>
<p style="position:absolute;top:132px;left:113px;white-space:nowrap" class="ft15982">iter_pages(left_edge=2,<br/>left_current=2,<br/>right_current=5,<br/>right_edge=2)</p>
<p style="position:absolute;top:129px;left:313px;white-space:nowrap" class="ft15975">An&#160;iterator&#160;that&#160;returns&#160;the&#160;sequence&#160;of&#160;page&#160;numbers&#160;to&#160;display&#160;in&#160;a&#160;pagination<br/>widget.&#160;The&#160;list&#160;will&#160;have&#160;left_edge&#160;pages&#160;on&#160;the&#160;left&#160;side,<br/>left_current</p>
<p style="position:absolute;top:166px;left:403px;white-space:nowrap" class="ft15930">&#160;pages&#160;to&#160;the&#160;left&#160;of&#160;the&#160;current&#160;page,</p>
<p style="position:absolute;top:185px;left:313px;white-space:nowrap" class="ft15914">right_current</p>
<p style="position:absolute;top:185px;left:411px;white-space:nowrap" class="ft15930">&#160;pages&#160;to&#160;the&#160;right&#160;of&#160;the&#160;current&#160;page,&#160;and</p>
<p style="position:absolute;top:204px;left:313px;white-space:nowrap" class="ft15914">right_edge</p>
<p style="position:absolute;top:204px;left:388px;white-space:nowrap" class="ft15930">&#160;pages&#160;on&#160;the&#160;right&#160;side.&#160;For&#160;example,&#160;for&#160;page&#160;50&#160;of&#160;100&#160;this</p>
<p style="position:absolute;top:220px;left:313px;white-space:nowrap" class="ft15975">iterator&#160;configured&#160;with&#160;default&#160;values&#160;will&#160;return&#160;the&#160;following&#160;pages:&#160;1,&#160;2,<br/>None</p>
<p style="position:absolute;top:239px;left:343px;white-space:nowrap" class="ft15930">,&#160;48,&#160;49,&#160;50,&#160;51,&#160;52,&#160;53,&#160;54,&#160;55,&#160;None,&#160;99,&#160;100.&#160;A&#160;None&#160;value&#160;in&#160;the</p>
<p style="position:absolute;top:255px;left:313px;white-space:nowrap" class="ft15930">sequence&#160;indicates&#160;a&#160;gap&#160;in&#160;the&#160;sequence&#160;of&#160;pages.</p>
<p style="position:absolute;top:279px;left:113px;white-space:nowrap" class="ft15914">prev()</p>
<p style="position:absolute;top:276px;left:313px;white-space:nowrap" class="ft15930">A&#160;pagination&#160;object&#160;for&#160;the&#160;previous&#160;page.</p>
<p style="position:absolute;top:303px;left:113px;white-space:nowrap" class="ft15914">next()</p>
<p style="position:absolute;top:301px;left:313px;white-space:nowrap" class="ft15930">A&#160;pagination&#160;object&#160;for&#160;the&#160;next&#160;page.</p>
<p style="position:absolute;top:336px;left:108px;white-space:nowrap" class="ft15914">Armed with this powerful object and Bootstrap’s pagination CSS classes, it is quite easy</p>
<p style="position:absolute;top:355px;left:108px;white-space:nowrap" class="ft15914">to build a pagination footer in the template. The implementation shown in</p>
<p style="position:absolute;top:374px;left:108px;white-space:nowrap" class="ft15917"><a href="Flask.html#159">Example 11-10</a>&#160;is done as a reusable Jinja2 macro.</p>
<p style="position:absolute;top:406px;left:108px;white-space:nowrap" class="ft15966"><i>Example 11-10. app/templates/_macros.html: Pagination template macro<br/></i>{% macro pagination_widget(pagination, endpoint) %}<br/><b>&lt;ul</b>&#160;class=&#34;pagination&#34;<b>&gt;<br/></b>&#160; &#160;&#160;<b>&lt;li</b>{%&#160;if&#160;not&#160;pagination.has_prev&#160;%}&#160;class=&#34;disabled&#34;{%&#160;endif&#160;%}<b>&gt;<br/></b>&#160; &#160; &#160; &#160;&#160;<b>&lt;a</b>&#160;href=&#34;{% if pagination.has_prev %}{{ url_for(endpoint,<br/>&#160; &#160; &#160; &#160; &#160; &#160; page = pagination.page - 1, **kwargs) }}{% else %}#{% endif %}&#34;<b>&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&amp;laquo;<br/></b>&#160; &#160; &#160; &#160;&#160;<b>&lt;/a&gt;<br/></b>&#160; &#160;&#160;<b>&lt;/li&gt;<br/></b>&#160; &#160; {% for p in pagination.iter_pages() %}<br/>&#160; &#160; &#160; &#160; {% if p %}<br/>&#160; &#160; &#160; &#160; &#160; &#160; {% if p == pagination.page %}<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;li</b>&#160;class=&#34;active&#34;<b>&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;a</b>&#160;href=&#34;{{ url_for(endpoint, page = p, **kwargs) }}&#34;<b>&gt;</b>{{ p }}<b>&lt;/a&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;/li&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160; {% else %}<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;li&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;a</b>&#160;href=&#34;{{ url_for(endpoint, page = p, **kwargs) }}&#34;<b>&gt;</b>{{ p }}<b>&lt;/a&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;/li&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160; {% endif %}<br/>&#160; &#160; &#160; &#160; {% else %}<br/>&#160; &#160; &#160; &#160;&#160;<b>&lt;li</b>&#160;class=&#34;disabled&#34;<b>&gt;&lt;a</b>&#160;href=&#34;#&#34;<b>&gt;&amp;hellip;&lt;/a&gt;&lt;/li&gt;<br/></b>&#160; &#160; &#160; &#160; {% endif %}<br/>&#160; &#160; {% endfor %}<br/>&#160; &#160;&#160;<b>&lt;li</b>{%&#160;if&#160;not&#160;pagination.has_next&#160;%}&#160;class=&#34;disabled&#34;{%&#160;endif&#160;%}<b>&gt;<br/></b>&#160; &#160; &#160; &#160;&#160;<b>&lt;a</b>&#160;href=&#34;{% if pagination.has_next %}{{ url_for(endpoint,<br/>&#160; &#160; &#160; &#160; &#160; &#160; page = pagination.page + 1, **kwargs) }}{% else %}#{% endif %}&#34;<b>&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&amp;raquo;<br/></b>&#160; &#160; &#160; &#160;&#160;<b>&lt;/a&gt;<br/></b>&#160; &#160;&#160;<b>&lt;/li&gt;</b></p>
<p style="position:absolute;top:915px;left:463px;white-space:nowrap" class="ft1595"><b>Paginating Long Blog Post Lists&#160;&#160;|&#160;&#160;139</b></p>
</div>
<!-- Page 160 -->
<a name="160"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page160-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask160.png" alt="background image"/>
<p style="position:absolute;top:82px;left:108px;white-space:nowrap" class="ft16066"><b>&lt;/ul&gt;<br/></b>{% endmacro %}</p>
<p style="position:absolute;top:124px;left:108px;white-space:nowrap" class="ft16014">The macro creates a Bootstrap pagination element, which is a styled unordered list. It</p>
<p style="position:absolute;top:143px;left:108px;white-space:nowrap" class="ft16014">defines the following page links inside it:</p>
<p style="position:absolute;top:178px;left:121px;white-space:nowrap" class="ft16014">•&#160;A “previous page” link. This link gets the&#160;disabled&#160;class if the current page is the</p>
<p style="position:absolute;top:197px;left:135px;white-space:nowrap" class="ft16014">first page.</p>
<p style="position:absolute;top:222px;left:121px;white-space:nowrap" class="ft16014">•&#160;Links to the all pages returned by the pagination object’s&#160;iter_pages()&#160;iterator.</p>
<p style="position:absolute;top:241px;left:135px;white-space:nowrap" class="ft16014">These pages are rendered as links with an explicit page number, given as an argu‐</p>
<p style="position:absolute;top:261px;left:135px;white-space:nowrap" class="ft16014">ment to&#160;url_for(). The page currently displayed is highlighted using the&#160;active</p>
<p style="position:absolute;top:280px;left:135px;white-space:nowrap" class="ft16014">CSS class. Gaps in the sequence of pages are rendered with the ellipsis character.</p>
<p style="position:absolute;top:305px;left:121px;white-space:nowrap" class="ft16014">•&#160;A “next page” link. This link will appear disabled if the current page is the last page.</p>
<p style="position:absolute;top:340px;left:108px;white-space:nowrap" class="ft16014">Jinja2 macros always receive keyword arguments without having to include&#160;**kwargs</p>
<p style="position:absolute;top:359px;left:108px;white-space:nowrap" class="ft16014">in the argument list. The pagination macro passes all the keyword arguments it receives</p>
<p style="position:absolute;top:379px;left:108px;white-space:nowrap" class="ft16014">to the&#160;url_for()&#160;call that generates the pagination links. This approach can be used</p>
<p style="position:absolute;top:397px;left:108px;white-space:nowrap" class="ft16048">with routes such as the profile page that have a dynamic part.<br/>The&#160;pagination_widget&#160;macro can be added below the&#160;<i>_posts.html</i>&#160;template included</p>
<p style="position:absolute;top:445px;left:108px;white-space:nowrap" class="ft16014">by&#160;<i>index.html</i>&#160;and&#160;<i>user.html</i><a href="Flask.html#160">.&#160;Example 11-11</a>&#160;shows how it is used in the application’s</p>
<p style="position:absolute;top:464px;left:108px;white-space:nowrap" class="ft16014">home page.</p>
<p style="position:absolute;top:496px;left:108px;white-space:nowrap" class="ft16066"><i>Example 11-11. app/templates/index.html: Pagination footer for blog post lists<br/></i>{% extends &#34;base.html&#34; %}<br/>{% import &#34;bootstrap/wtf.html&#34; as wtf %}<br/>{% import &#34;_macros.html&#34; as macros %}<br/>...<br/>{% include '_posts.html' %}<br/><b>&lt;div</b>&#160;class=&#34;pagination&#34;<b>&gt;<br/></b>&#160; &#160; {{ macros.pagination_widget(pagination, '.index') }}<br/><b>&lt;/div&gt;<br/></b>{% endif %}</p>
<p style="position:absolute;top:673px;left:108px;white-space:nowrap" class="ft16017"><a href="Flask.html#160">Figure 11-2&#160;shows how the pagina</a>tion links appear in the page.</p>
<p style="position:absolute;top:714px;left:198px;white-space:nowrap" class="ft16025">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:732px;left:198px;white-space:nowrap" class="ft16025">run&#160;git&#160;checkout&#160;11d&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1605"><b>140&#160;&#160;|&#160;&#160;Chapter 11: Blog Posts</b></p>
</div>
<!-- Page 161 -->
<a name="161"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page161-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask161.png" alt="background image"/>
<p style="position:absolute;top:326px;left:108px;white-space:nowrap" class="ft16110"><i>Figure 11-2. Blog post pagination</i></p>
<p style="position:absolute;top:361px;left:108px;white-space:nowrap" class="ft16118"><b>Rich-Text Posts with Markdown and Flask-PageDown<br/></b>Plain-text posts are sufficient for short messages and status updates, but users who want</p>
<p style="position:absolute;top:420px;left:108px;white-space:nowrap" class="ft16114">to write longer articles will find the lack of formatting very limiting. In this section, the</p>
<p style="position:absolute;top:439px;left:108px;white-space:nowrap" class="ft16114">text area field where posts are en<a href="http://daringfireball.net/projects/markdown/">tered will be upgraded to support the&#160;Markdown</a>&#160;syntax</p>
<p style="position:absolute;top:458px;left:108px;white-space:nowrap" class="ft16115">and present a rich-text preview of the post.<br/>The implementation of this feature requires a few new packages:</p>
<p style="position:absolute;top:520px;left:121px;white-space:nowrap" class="ft16114">•&#160;PageDown, a client-side Markdown-to-HTML converter implemented in Java‐</p>
<p style="position:absolute;top:539px;left:135px;white-space:nowrap" class="ft16114">Script.</p>
<p style="position:absolute;top:564px;left:121px;white-space:nowrap" class="ft16114">•&#160;Flask-PageDown, a PageDown wrapper for Flask that integrates PageDown with</p>
<p style="position:absolute;top:582px;left:135px;white-space:nowrap" class="ft16114">Flask-WTF forms.</p>
<p style="position:absolute;top:607px;left:121px;white-space:nowrap" class="ft16119">•&#160;Markdown, a server-side Markdown-to-HTML converter implemented in Python.<br/>•&#160;Bleach, an HTML sanitizer implemented in Python.</p>
<p style="position:absolute;top:666px;left:108px;white-space:nowrap" class="ft16114">The Python packages can all be installed with pip:</p>
<p style="position:absolute;top:698px;left:134px;white-space:nowrap" class="ft16133">(venv)&#160;$&#160;pip install flask-pagedown markdown bleach</p>
<p style="position:absolute;top:726px;left:108px;white-space:nowrap" class="ft16152"><b>Using Flask-PageDown<br/></b>The Flask-PageDown extension defines a&#160;PageDownField&#160;class that has the same inter‐</p>
<p style="position:absolute;top:780px;left:108px;white-space:nowrap" class="ft16114">face as the&#160;TextAreaField&#160;from WTForms. Before this field can be used, the extension</p>
<p style="position:absolute;top:799px;left:108px;white-space:nowrap" class="ft16114">needs to be initialized as shown in&#160;<a href="Flask.html#161">Example 11-12.</a></p>
<p style="position:absolute;top:831px;left:108px;white-space:nowrap" class="ft16140"><i>Example 11-12. app/__init__.py: Flask-PageDown initialization<br/></i><b>from</b>&#160;<b>flask.ext.pagedown</b>&#160;<b>import</b>&#160;PageDown<br/><i># ...</i></p>
<p style="position:absolute;top:915px;left:366px;white-space:nowrap" class="ft1615"><b>Rich-Text Posts with Markdown and Flask-PageDown&#160;&#160;|&#160;&#160;141</b></p>
</div>
<!-- Page 162 -->
<a name="162"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page162-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask162.png" alt="background image"/>
<p style="position:absolute;top:82px;left:108px;white-space:nowrap" class="ft16247">pagedown&#160;=&#160;PageDown()<br/><i># ...<br/></i><b>def</b>&#160;create_app(config_name):<br/>&#160; &#160;&#160;<i># ...<br/></i>&#160; &#160;&#160;pagedown.init_app(app)<br/>&#160; &#160;&#160;<i># ...</i></p>
<p style="position:absolute;top:185px;left:108px;white-space:nowrap" class="ft16246">To convert the text area control in the home page to a Markdown rich-text editor, the<br/>body</p>
<p style="position:absolute;top:205px;left:138px;white-space:nowrap" class="ft16214">&#160;field of the&#160;PostForm&#160;must be changed to a&#160;PageDownField&#160;as shown in</p>
<p style="position:absolute;top:224px;left:108px;white-space:nowrap" class="ft16217"><a href="Flask.html#162">Example 11-13</a>.</p>
<p style="position:absolute;top:256px;left:108px;white-space:nowrap" class="ft16250"><i>Example 11-13. app/main/forms.py: Markdown-enabled post form<br/></i><b>from</b>&#160;<b>flask.ext.pagedown.fields</b>&#160;<b>import</b>&#160;PageDownField</p>
<p style="position:absolute;top:314px;left:108px;white-space:nowrap" class="ft16247"><b>class</b>&#160;<b>PostForm</b>(Form):<br/>&#160; &#160;&#160;body&#160;=&#160;PageDownField(&#34;What's on your mind?&#34;,&#160;validators=[Required()])<br/>&#160; &#160;&#160;submit&#160;=&#160;SubmitField('Submit')</p>
<p style="position:absolute;top:371px;left:108px;white-space:nowrap" class="ft16214">The Markdown preview is generated with the help of the PageDown libraries, so these</p>
<p style="position:absolute;top:390px;left:108px;white-space:nowrap" class="ft16214">must be added to the template. Flask-PageDown simplifies this task by providing a</p>
<p style="position:absolute;top:409px;left:108px;white-space:nowrap" class="ft16214">template macro tha<a href="Flask.html#162">t includes the required files from a CDN as shown in&#160;Example 11-14</a>.</p>
<p style="position:absolute;top:441px;left:108px;white-space:nowrap" class="ft16223"><i>Example 11-14. app/index.html: Flask-PageDown template declaration<br/></i>{% block scripts %}<br/>{{ super() }}<br/>{{ pagedown.include_pagedown() }}<br/>{% endblock %}</p>
<p style="position:absolute;top:549px;left:198px;white-space:nowrap" class="ft16225">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:567px;left:198px;white-space:nowrap" class="ft16225">run&#160;git&#160;checkout&#160;11e&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:585px;left:198px;white-space:nowrap" class="ft16280">To&#160;ensure&#160;that&#160;you&#160;have&#160;all&#160;the&#160;dependencies&#160;installed&#160;also&#160;run&#160;pip<br/>install&#160;-r&#160;requirements/dev.txt</p>
<p style="position:absolute;top:603px;left:410px;white-space:nowrap" class="ft16225">.</p>
<p style="position:absolute;top:655px;left:108px;white-space:nowrap" class="ft16214">With these changes, Markdown-formatted text typed in the text area field will be im‐</p>
<p style="position:absolute;top:674px;left:108px;white-space:nowrap" class="ft16214">mediately rendered as HTML in the preview area below<a href="Flask.html#162">.&#160;Figure 11-3&#160;</a>shows the blog</p>
<p style="position:absolute;top:693px;left:108px;white-space:nowrap" class="ft16214">submission form with rich text.</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1625"><b>142&#160;&#160;|&#160;&#160;Chapter 11: Blog Posts</b></p>
</div>
<!-- Page 163 -->
<a name="163"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page163-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask163.png" alt="background image"/>
<p style="position:absolute;top:394px;left:108px;white-space:nowrap" class="ft16310"><i>Figure 11-3. Rich-text blog post form</i></p>
<p style="position:absolute;top:428px;left:108px;white-space:nowrap" class="ft16352"><b>Handling Rich Text on the Server<br/></b>When the form is submitted only the raw Markdown text is sent with the&#160;POST&#160;request;</p>
<p style="position:absolute;top:482px;left:108px;white-space:nowrap" class="ft16314">the HTML preview that was shown on the page is discarded. Sending the generated</p>
<p style="position:absolute;top:501px;left:108px;white-space:nowrap" class="ft16314">HTML preview with the form can be considered a security risk, as it would be fairly</p>
<p style="position:absolute;top:520px;left:108px;white-space:nowrap" class="ft16314">easy for an attacker to construct HTML sequences that do not match the Markdown</p>
<p style="position:absolute;top:539px;left:108px;white-space:nowrap" class="ft16314">source and submit them. To avoid any risks, only the Markdown source text is submit‐</p>
<p style="position:absolute;top:558px;left:108px;white-space:nowrap" class="ft16314">ted, and once in the server it is converted again to HTML using&#160;<i>Markdown</i>, a Python</p>
<p style="position:absolute;top:577px;left:108px;white-space:nowrap" class="ft16314">Markdown-to-HTML converter. The resulting HTML will be sanitized with&#160;<i>Bleach</i>&#160;to</p>
<p style="position:absolute;top:595px;left:108px;white-space:nowrap" class="ft16315">ensure that only a short list of allowed HTML tags are used.<br/>The conversion of the Markdown blog posts to HTML can be issued in the&#160;<i>_posts.html</i></p>
<p style="position:absolute;top:642px;left:108px;white-space:nowrap" class="ft16314">template, but this is inefficient, as posts will have to be converted every time they are</p>
<p style="position:absolute;top:661px;left:108px;white-space:nowrap" class="ft16314">rendered to a page. To avoid this repetition, the conversion can be done once when the</p>
<p style="position:absolute;top:680px;left:108px;white-space:nowrap" class="ft16314">blog post is created. The HTML code for the rendered blog post is&#160;<i>cached</i>&#160;in a new field</p>
<p style="position:absolute;top:700px;left:108px;white-space:nowrap" class="ft16314">added to the&#160;Post&#160;model that the template can access directly. The original Markdown</p>
<p style="position:absolute;top:719px;left:108px;white-space:nowrap" class="ft16314">source is also kept in the da<a href="Flask.html#163">tabase in case the post needs to be edited.&#160;Example 11-15</a></p>
<p style="position:absolute;top:739px;left:108px;white-space:nowrap" class="ft16314">shows the changes to the&#160;Post&#160;model.</p>
<p style="position:absolute;top:770px;left:108px;white-space:nowrap" class="ft16340"><i>Example 11-15. app/models/post.py: Markdown text handling in the Post model<br/></i><b>from</b>&#160;<b>markdown</b>&#160;<b>import</b>&#160;markdown<br/><b>import</b>&#160;<b>bleach</b></p>
<p style="position:absolute;top:844px;left:108px;white-space:nowrap" class="ft16368"><b>class</b>&#160;<b>Post</b>(db.Model):<br/>&#160; &#160;&#160;<i># ...<br/></i>&#160; &#160;&#160;body_html&#160;=&#160;db.Column(db.Text)</p>
<p style="position:absolute;top:915px;left:366px;white-space:nowrap" class="ft1635"><b>Rich-Text Posts with Markdown and Flask-PageDown&#160;&#160;|&#160;&#160;143</b></p>
</div>
<!-- Page 164 -->
<a name="164"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page164-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask164.png" alt="background image"/>
<p style="position:absolute;top:82px;left:108px;white-space:nowrap" class="ft16447">&#160; &#160;&#160;<i># ...<br/></i>&#160; &#160;&#160;@staticmethod<br/>&#160; &#160;&#160;<b>def</b>&#160;on_changed_body(target,&#160;value,&#160;oldvalue,&#160;initiator):<br/>&#160; &#160; &#160; &#160;&#160;allowed_tags&#160;=&#160;['a',&#160;'abbr',&#160;'acronym',&#160;'b',&#160;'blockquote',&#160;'code',<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;'em',&#160;'i',&#160;'li',&#160;'ol',&#160;'pre',&#160;'strong',&#160;'ul',<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;'h1',&#160;'h2',&#160;'h3',&#160;'p']<br/>&#160; &#160; &#160; &#160;&#160;target.body_html&#160;=&#160;bleach.linkify(bleach.clean(<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;markdown(value,&#160;output_format='html'),<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;tags=allowed_tags,&#160;strip=True))</p>
<p style="position:absolute;top:235px;left:108px;white-space:nowrap" class="ft16437">db.event.listen(Post.body,&#160;'set',&#160;Post.on_changed_body)</p>
<p style="position:absolute;top:263px;left:108px;white-space:nowrap" class="ft16414">The&#160;on_changed_body&#160;function is registered as a listener of SQLAlchemy’s “set” event</p>
<p style="position:absolute;top:282px;left:108px;white-space:nowrap" class="ft16414">for&#160;body, which means that it will be automatically invoked whenever the&#160;body&#160;field on</p>
<p style="position:absolute;top:301px;left:108px;white-space:nowrap" class="ft16414">any instance of the class is set to a new value. The function renders the HTML version</p>
<p style="position:absolute;top:321px;left:108px;white-space:nowrap" class="ft16414">of the body and stores it in&#160;body_html, effectively making the conversion of the Mark‐</p>
<p style="position:absolute;top:340px;left:108px;white-space:nowrap" class="ft16448">down text to HTML fully automatic.<br/>The actual conversion is done in three steps. First, the&#160;markdown()&#160;function does an</p>
<p style="position:absolute;top:389px;left:108px;white-space:nowrap" class="ft16414">initial conversion to HTML. The result is passed to&#160;clean(), along with the list of</p>
<p style="position:absolute;top:409px;left:108px;white-space:nowrap" class="ft16414">approved HTML tags. The&#160;clean()&#160;function removes any tags not on the white list. The</p>
<p style="position:absolute;top:428px;left:108px;white-space:nowrap" class="ft16414">final conversion is done with&#160;linkify(), another function provided by Bleach that</p>
<p style="position:absolute;top:448px;left:108px;white-space:nowrap" class="ft16414">converts any URLs written in plain text into proper&#160;&lt;a&gt;&#160;links. This last step is necessary</p>
<p style="position:absolute;top:467px;left:108px;white-space:nowrap" class="ft16414">because automatic link generation is not officially in the Markdown specification. Pa‐</p>
<p style="position:absolute;top:487px;left:108px;white-space:nowrap" class="ft16448">geDown supports it as an extension, so&#160;linkify()&#160;is used in the server to match.<br/>The last change is to replace&#160;post.body&#160;with&#160;post.body_html&#160;in the template when</p>
<p style="position:absolute;top:535px;left:108px;white-space:nowrap" class="ft16414">available, as shown in&#160;<a href="Flask.html#164">Example 11-16.</a></p>
<p style="position:absolute;top:567px;left:108px;white-space:nowrap" class="ft16466"><i>Example 11-16.&#160;app/templates/_posts.html: Use the HTML version of the post bodies in<br/>the template<br/></i>...<br/><b>&lt;div</b>&#160;class=&#34;post-body&#34;<b>&gt;<br/></b>&#160; &#160; {% if post.body_html %}<br/>&#160; &#160; &#160; &#160; {{ post.body_html | safe }}<br/>&#160; &#160; {% else %}<br/>&#160; &#160; &#160; &#160; {{ post.body }}<br/>&#160; &#160; {% endif %}<br/><b>&lt;/div&gt;<br/></b>...</p>
<p style="position:absolute;top:763px;left:108px;white-space:nowrap" class="ft16414">The&#160;| safe&#160;suffix when rendering the HTML body is there to tell Jinja2 not to escape</p>
<p style="position:absolute;top:782px;left:108px;white-space:nowrap" class="ft16414">the HTML elements. Jinja2 escapes all template variables by default as a security meas‐</p>
<p style="position:absolute;top:801px;left:108px;white-space:nowrap" class="ft16414">ure. The Markdown-generated HTML was generated in the server, so it is safe to render.</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1645"><b>144&#160;&#160;|&#160;&#160;Chapter 11: Blog Posts</b></p>
</div>
<!-- Page 165 -->
<a name="165"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page165-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask165.png" alt="background image"/>
<p style="position:absolute;top:85px;left:198px;white-space:nowrap" class="ft16525">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:103px;left:198px;white-space:nowrap" class="ft16525">run&#160;git&#160;checkout&#160;11f&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:121px;left:198px;white-space:nowrap" class="ft16531">This&#160;update&#160;also&#160;contains&#160;a&#160;database&#160;migration,&#160;so&#160;remember&#160;to&#160;run<br/>python&#160;manage.py&#160;db&#160;upgrade</p>
<p style="position:absolute;top:139px;left:390px;white-space:nowrap" class="ft16525">&#160;after&#160;you&#160;check&#160;out&#160;the&#160;code.&#160;To</p>
<p style="position:absolute;top:157px;left:198px;white-space:nowrap" class="ft16580">ensure&#160;that&#160;you&#160;have&#160;all&#160;the&#160;dependencies&#160;installed&#160;also&#160;run&#160;pip<br/>install&#160;-r&#160;requirements/dev.txt</p>
<p style="position:absolute;top:175px;left:410px;white-space:nowrap" class="ft16525">.</p>
<p style="position:absolute;top:216px;left:108px;white-space:nowrap" class="ft16518"><b>Permanent Links to Blog Posts<br/></b>Users may want to share links to specific blog posts with friends on social networks. For</p>
<p style="position:absolute;top:276px;left:108px;white-space:nowrap" class="ft16514">this purpose, each post will be assigned a page with a unique URL that references it. The</p>
<p style="position:absolute;top:295px;left:108px;white-space:nowrap" class="ft16514">route and view function that support permanen<a href="Flask.html#165">t links are shown in&#160;Example 11-17</a>.</p>
<p style="position:absolute;top:326px;left:108px;white-space:nowrap" class="ft16547"><i>Example 11-17. app/main/views.py: Permanent links to posts<br/></i>@main.route('/post/&lt;int:id&gt;')<br/><b>def</b>&#160;post(id):<br/>&#160; &#160;&#160;post&#160;=&#160;Post.query.get_or_404(id)<br/>&#160; &#160;&#160;<b>return</b>&#160;render_template('post.html',&#160;posts=[post])</p>
<p style="position:absolute;top:427px;left:108px;white-space:nowrap" class="ft16514">The URLs that will be assigned to blog posts are constructed with the unique&#160;id&#160;field</p>
<p style="position:absolute;top:446px;left:108px;white-space:nowrap" class="ft16514">assigned when the post is inserted in the database.</p>
<p style="position:absolute;top:486px;left:198px;white-space:nowrap" class="ft16525">For&#160;some&#160;types&#160;of&#160;applications,&#160;building&#160;permanent&#160;links&#160;that&#160;use</p>
<p style="position:absolute;top:503px;left:198px;white-space:nowrap" class="ft16525">readable&#160;URLs&#160;instead&#160;of&#160;numeric&#160;IDs&#160;may&#160;be&#160;preferred.&#160;An&#160;alterna‐</p>
<p style="position:absolute;top:520px;left:198px;white-space:nowrap" class="ft16525">tive&#160;to&#160;numeric&#160;IDs&#160;is&#160;to&#160;assign&#160;each&#160;blog&#160;post&#160;a&#160;<i>slug</i>,&#160;which&#160;is&#160;a&#160;unique</p>
<p style="position:absolute;top:538px;left:198px;white-space:nowrap" class="ft16525">string&#160;that&#160;is&#160;related&#160;to&#160;the&#160;post.</p>
<p style="position:absolute;top:591px;left:108px;white-space:nowrap" class="ft16514">Note that the&#160;<i>post.html</i>&#160;template receives a list with just the post to render. Sending a</p>
<p style="position:absolute;top:609px;left:108px;white-space:nowrap" class="ft16514">list is necessary so that the&#160;<i>_posts.html</i>&#160;template referenced by&#160;<i>index.html</i>&#160;and&#160;<i>user.html</i></p>
<p style="position:absolute;top:628px;left:108px;white-space:nowrap" class="ft16515">can be used in this page as well.<br/>The permanent links are added at the bottom of each post in the generic&#160;<i>_posts.html</i></p>
<p style="position:absolute;top:675px;left:108px;white-space:nowrap" class="ft16514">templa<a href="Flask.html#165">te, as shown in&#160;Example 11-18.</a></p>
<p style="position:absolute;top:707px;left:108px;white-space:nowrap" class="ft16566"><i>Example 11-18. app/templates/_posts.html: Permanent links to posts<br/></i><b>&lt;ul</b>&#160;class=&#34;posts&#34;<b>&gt;<br/></b>&#160; &#160; {% for post in posts %}<br/>&#160; &#160;&#160;<b>&lt;li</b>&#160;class=&#34;post&#34;<b>&gt;<br/></b>&#160; &#160; &#160; &#160; ...<br/>&#160; &#160; &#160; &#160;&#160;<b>&lt;div</b>&#160;class=&#34;post-content&#34;<b>&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160; ...<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;div</b>&#160;class=&#34;post-footer&#34;<b>&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;a</b>&#160;href=&#34;{{ url_for('.post', id=post.id) }}&#34;<b>&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;span</b>&#160;class=&#34;label label-default&#34;<b>&gt;</b>Permalink<b>&lt;/span&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;/a&gt;</b></p>
<p style="position:absolute;top:915px;left:467px;white-space:nowrap" class="ft1655"><b>Permanent Links to Blog Posts&#160;&#160;|&#160;&#160;145</b></p>
</div>
<!-- Page 166 -->
<a name="166"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page166-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask166.png" alt="background image"/>
<p style="position:absolute;top:82px;left:108px;white-space:nowrap" class="ft16623">&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;/div&gt;<br/></b>&#160; &#160; &#160; &#160;&#160;<b>&lt;/div&gt;<br/></b>&#160; &#160;&#160;<b>&lt;/li&gt;<br/></b>&#160; &#160; {% endfor %}<br/><b>&lt;/ul&gt;</b></p>
<p style="position:absolute;top:170px;left:108px;white-space:nowrap" class="ft16614">The new&#160;<i>post.html</i>&#160;template that renders the permanent link page is shown in</p>
<p style="position:absolute;top:189px;left:108px;white-space:nowrap" class="ft16617"><a href="Flask.html#166">Example 11-19</a>. It includes the example template.</p>
<p style="position:absolute;top:221px;left:108px;white-space:nowrap" class="ft16650"><i>Example 11-19. app/templates/post.html: Permanent link template<br/></i>{% extends &#34;base.html&#34; %}</p>
<p style="position:absolute;top:279px;left:108px;white-space:nowrap" class="ft1663">{% block title %}Flasky - Post{% endblock %}</p>
<p style="position:absolute;top:310px;left:108px;white-space:nowrap" class="ft16623">{% block page_content %}<br/>{% include '_posts.html' %}<br/>{% endblock %}</p>
<p style="position:absolute;top:374px;left:198px;white-space:nowrap" class="ft16625">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:393px;left:198px;white-space:nowrap" class="ft16625">run&#160;git&#160;checkout&#160;11g&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:476px;left:108px;white-space:nowrap" class="ft16618"><b>Blog Post Editor<br/></b>The last feature related to blog posts is a post editor that allows users to edit their own</p>
<p style="position:absolute;top:536px;left:108px;white-space:nowrap" class="ft16614">posts. The blog post editor will live in a standalone page. At the top of the page, the</p>
<p style="position:absolute;top:555px;left:108px;white-space:nowrap" class="ft16614">current version of the post will be shown for reference, followed by a Markdown editor</p>
<p style="position:absolute;top:574px;left:108px;white-space:nowrap" class="ft16614">where the source Markdown can be modified. The editor will be based on Flask-</p>
<p style="position:absolute;top:593px;left:108px;white-space:nowrap" class="ft16614">PageDown, so a preview of the edited version of the blog post will be shown at the</p>
<p style="position:absolute;top:611px;left:108px;white-space:nowrap" class="ft16614">bottom of the page. The&#160;<i>edit_post.html</i>&#160;template is shown in&#160;<a href="Flask.html#166">Example 11-20</a>.</p>
<p style="position:absolute;top:643px;left:108px;white-space:nowrap" class="ft16623"><i>Example 11-20. app/templates/edit_post.html: Edit blog post template<br/></i>{% extends &#34;base.html&#34; %}<br/>{% import &#34;bootstrap/wtf.html&#34; as wtf %}</p>
<p style="position:absolute;top:717px;left:108px;white-space:nowrap" class="ft1663">{% block title %}Flasky - Edit Post{% endblock %}</p>
<p style="position:absolute;top:748px;left:108px;white-space:nowrap" class="ft16666">{% block page_content %}<br/><b>&lt;div</b>&#160;class=&#34;page-header&#34;<b>&gt;<br/></b>&#160; &#160;&#160;<b>&lt;h1&gt;</b>Edit Post<b>&lt;/h1&gt;<br/>&lt;/div&gt;<br/>&lt;div&gt;<br/></b>&#160; &#160; {{ wtf.quick_form(form) }}<br/><b>&lt;/div&gt;<br/></b>{% endblock %}</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1665"><b>146&#160;&#160;|&#160;&#160;Chapter 11: Blog Posts</b></p>
</div>
<!-- Page 167 -->
<a name="167"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page167-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask167.png" alt="background image"/>
<p style="position:absolute;top:82px;left:108px;white-space:nowrap" class="ft16723">{% block scripts %}<br/>{{ super() }}<br/>{{ pagedown.include_pagedown() }}<br/>{% endblock %}</p>
<p style="position:absolute;top:155px;left:108px;white-space:nowrap" class="ft16714">The route tha<a href="Flask.html#167">t supports the blog post editor is shown in&#160;Example 11-21</a>.</p>
<p style="position:absolute;top:187px;left:108px;white-space:nowrap" class="ft16740"><i>Example 11-21. app/main/views.py: Edit blog post route<br/></i>@main.route('/edit/&lt;int:id&gt;',&#160;methods=['GET',&#160;'POST'])<br/>@login_required<br/><b>def</b>&#160;edit(id):<br/>&#160; &#160;&#160;post&#160;=&#160;Post.query.get_or_404(id)<br/>&#160; &#160;&#160;<b>if</b>&#160;current_user&#160;!=&#160;post.author&#160;<b>and</b>&#160;\<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>not</b>&#160;current_user.can(Permission.ADMINISTER):<br/>&#160; &#160; &#160; &#160;&#160;abort(403)<br/>&#160; &#160;&#160;form&#160;=&#160;PostForm()<br/>&#160; &#160;&#160;<b>if</b>&#160;form.validate_on_submit():<br/>&#160; &#160; &#160; &#160;&#160;post.body&#160;=&#160;form.body.data<br/>&#160; &#160; &#160; &#160;&#160;db.session.add(post)<br/>&#160; &#160; &#160; &#160;&#160;flash('The post has been updated.')<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;redirect(url_for('post',&#160;id=post.id))<br/>&#160; &#160;&#160;form.body.data&#160;=&#160;post.body<br/>&#160; &#160;&#160;<b>return</b>&#160;render_template('edit_post.html',&#160;form=form)</p>
<p style="position:absolute;top:455px;left:108px;white-space:nowrap" class="ft16714">This view function is coded to allow only the author of a blog post to edit it, except for</p>
<p style="position:absolute;top:474px;left:108px;white-space:nowrap" class="ft16714">administrators, who are allowed to edit posts from all users. If a user tries to edit a post</p>
<p style="position:absolute;top:494px;left:108px;white-space:nowrap" class="ft16714">from another user, the view function responds with a 403 code. The&#160;PostForm&#160;web form</p>
<p style="position:absolute;top:513px;left:108px;white-space:nowrap" class="ft16715">class used here is the same one used on the home page.<br/>To complete the feature, a link to the blog post editor can be added below each blog</p>
<p style="position:absolute;top:559px;left:108px;white-space:nowrap" class="ft16714">post, next to the permanen<a href="Flask.html#167">t link, as shown in&#160;Example 11-22.</a></p>
<p style="position:absolute;top:591px;left:108px;white-space:nowrap" class="ft16766"><i>Example 11-22. app/templates/_posts.html: Edit blog post links<br/></i><b>&lt;ul</b>&#160;class=&#34;posts&#34;<b>&gt;<br/></b>&#160; &#160; {% for post in posts %}<br/>&#160; &#160;&#160;<b>&lt;li</b>&#160;class=&#34;post&#34;<b>&gt;<br/></b>&#160; &#160; &#160; &#160; ...<br/>&#160; &#160; &#160; &#160;&#160;<b>&lt;div</b>&#160;class=&#34;post-content&#34;<b>&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160; ...<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;div</b>&#160;class=&#34;post-footer&#34;<b>&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; ...<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; {% if current_user == post.author %}<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;a</b>&#160;href=&#34;{{ url_for('.edit', id=post.id) }}&#34;<b>&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;span</b>&#160;class=&#34;label label-primary&#34;<b>&gt;</b>Edit<b>&lt;/span&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;/a&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; {% elif current_user.is_administrator() %}<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;a</b>&#160;href=&#34;{{ url_for('.edit', id=post.id) }}&#34;<b>&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;span</b>&#160;class=&#34;label label-danger&#34;<b>&gt;</b>Edit [Admin]<b>&lt;/span&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;/a&gt;<br/></b>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; {% endif %}</p>
<p style="position:absolute;top:915px;left:531px;white-space:nowrap" class="ft1675"><b>Blog Post Editor&#160;&#160;|&#160;&#160;147</b></p>
</div>
<!-- Page 168 -->
<a name="168"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page168-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask168.png" alt="background image"/>
<p style="position:absolute;top:82px;left:108px;white-space:nowrap" class="ft16823">&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>&lt;/div&gt;<br/></b>&#160; &#160; &#160; &#160;&#160;<b>&lt;/div&gt;<br/></b>&#160; &#160;&#160;<b>&lt;/li&gt;<br/></b>&#160; &#160; {% endfor %}<br/><b>&lt;/ul&gt;</b></p>
<p style="position:absolute;top:170px;left:108px;white-space:nowrap" class="ft16814">This change adds an “Edit” link to any blog posts that are authored by the current user.</p>
<p style="position:absolute;top:189px;left:108px;white-space:nowrap" class="ft16814">For administrators, the link is added to all posts. The administrator link is styled dif‐</p>
<p style="position:absolute;top:208px;left:108px;white-space:nowrap" class="ft16814">ferently as a visual cue that this is an administration fea<a href="Flask.html#168">ture.&#160;Figure 11-4</a>&#160;shows how the</p>
<p style="position:absolute;top:227px;left:108px;white-space:nowrap" class="ft16814">Edit and Permalink links look in the web browser.</p>
<p style="position:absolute;top:268px;left:198px;white-space:nowrap" class="ft16825">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:286px;left:198px;white-space:nowrap" class="ft16825">run&#160;git&#160;checkout&#160;11h&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:681px;left:108px;white-space:nowrap" class="ft16810"><i>Figure 11-4. Edit and Permalink links in blog posts.</i></p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1685"><b>148&#160;&#160;|&#160;&#160;Chapter 11: Blog Posts</b></p>
</div>
<!-- Page 169 -->
<a name="169"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page169-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask169.png" alt="background image"/>
<p style="position:absolute;top:104px;left:549px;white-space:nowrap" class="ft16928"><b>CHAPTER 12</b></p>
<p style="position:absolute;top:131px;left:529px;white-space:nowrap" class="ft16911"><b>Followers</b></p>
<p style="position:absolute;top:345px;left:108px;white-space:nowrap" class="ft16914">Socially aware web applications allow users to connect with other users. Applications</p>
<p style="position:absolute;top:364px;left:108px;white-space:nowrap" class="ft16914">call these relationships&#160;<i>followers</i>,&#160;<i>friends</i>,&#160;<i>contacts</i>,&#160;<i>connections</i>, or&#160;<i>buddies</i>, but the fea‐</p>
<p style="position:absolute;top:383px;left:108px;white-space:nowrap" class="ft16914">ture is the same regardless of the name, and in all cases involves keeping track of di‐</p>
<p style="position:absolute;top:402px;left:108px;white-space:nowrap" class="ft16915">rectional links between pairs of users and using these links in database queries.<br/>In this chapter, you will learn how to implement a follower feature for Flasky. Users will</p>
<p style="position:absolute;top:449px;left:108px;white-space:nowrap" class="ft16914">be able to “follow” other users and choose to filter the blog post list on the home page</p>
<p style="position:absolute;top:468px;left:108px;white-space:nowrap" class="ft16914">to include only those from the users they follow.</p>
<p style="position:absolute;top:505px;left:108px;white-space:nowrap" class="ft16922"><b>Database Relationships Revisited&#160;<br/></b>As we discussed in&#160;<a href="Flask.html#69">Chapter 5, da</a>tabases establish links between records using&#160;<i>relation‐</i></p>
<p style="position:absolute;top:566px;left:108px;white-space:nowrap" class="ft16910"><i>ships</i></p>
<p style="position:absolute;top:565px;left:139px;white-space:nowrap" class="ft16914">. The one-to-many relationship is the most common type of relationship, where a</p>
<p style="position:absolute;top:584px;left:108px;white-space:nowrap" class="ft16914">record is linked with a list of related records. To implement this type of relationship, the</p>
<p style="position:absolute;top:603px;left:108px;white-space:nowrap" class="ft16914">elements in the “many” side have a foreign key that points to the linked element on the</p>
<p style="position:absolute;top:622px;left:108px;white-space:nowrap" class="ft16914">“one” side. The example application in its current state includes two one-to-many re‐</p>
<p style="position:absolute;top:641px;left:108px;white-space:nowrap" class="ft16914">lationships: one that links user roles to lists of users and another that links users to the</p>
<p style="position:absolute;top:660px;left:108px;white-space:nowrap" class="ft16915">blog posts they authored.<br/>Most other relationship types can be derived from the one-to-many type. The&#160;<i>many-</i></p>
<p style="position:absolute;top:708px;left:108px;white-space:nowrap" class="ft16910"><i>to-one</i></p>
<p style="position:absolute;top:707px;left:148px;white-space:nowrap" class="ft16914">&#160;relationship is a one-to-many looked at from the point of view of the “many”</p>
<p style="position:absolute;top:725px;left:108px;white-space:nowrap" class="ft16914">side. The&#160;<i>one-to-one</i>&#160;relationship type is a simplification of the one-to-many, where the</p>
<p style="position:absolute;top:744px;left:108px;white-space:nowrap" class="ft16914">“many” side is constrained to only have at most one element. The only relationship type</p>
<p style="position:absolute;top:763px;left:108px;white-space:nowrap" class="ft16914">that cannot be implemented as a simple variation of the one-to-many model is the&#160;<i>many-</i></p>
<p style="position:absolute;top:783px;left:108px;white-space:nowrap" class="ft16910"><i>to-many</i></p>
<p style="position:absolute;top:782px;left:161px;white-space:nowrap" class="ft16914">, which has lists of elements on both sides. This relationship is described in</p>
<p style="position:absolute;top:801px;left:108px;white-space:nowrap" class="ft16914">detail in the following section.</p>
<p style="position:absolute;top:915px;left:631px;white-space:nowrap" class="ft1695"><b>149</b></p>
</div>
<!-- Page 170 -->
<a name="170"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page170-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask170.png" alt="background image"/>
<p style="position:absolute;top:75px;left:108px;white-space:nowrap" class="ft17058"><b>Many-to-Many Relationships<br/></b>The one-to-many, many-to-one, and one-to-one relationships all have at least one side</p>
<p style="position:absolute;top:128px;left:108px;white-space:nowrap" class="ft17014">with a single entity, so the links between related records are implemented with foreign</p>
<p style="position:absolute;top:147px;left:108px;white-space:nowrap" class="ft17014">keys pointing to that one element. But how do you implement a relationship where both</p>
<p style="position:absolute;top:166px;left:108px;white-space:nowrap" class="ft17015">sides are “many” sides?<br/>Consider the classical example of a many-to-many relationship: a database of students</p>
<p style="position:absolute;top:213px;left:108px;white-space:nowrap" class="ft17014">and the classes they are taking. Clearly, you can’t add a foreign key to a class in the</p>
<p style="position:absolute;top:232px;left:108px;white-space:nowrap" class="ft17014">students table, because a student takes many classes—one foreign key is not enough.</p>
<p style="position:absolute;top:251px;left:108px;white-space:nowrap" class="ft17014">Likewise, you cannot add a foreign key to the student in the classes table, because classes</p>
<p style="position:absolute;top:269px;left:108px;white-space:nowrap" class="ft17015">have more than one student. Both sides need a list of foreign keys.<br/>The solution is to add a third table to the database, called an&#160;<i>association table</i>. Now the</p>
<p style="position:absolute;top:316px;left:108px;white-space:nowrap" class="ft17014">many-to-many relationship can be decomposed into two one-to-many relationships</p>
<p style="position:absolute;top:335px;left:108px;white-space:nowrap" class="ft17014">from each of the two original tables to the associa<a href="Flask.html#170">tion table.&#160;Figure 12-1&#160;</a>shows how the</p>
<p style="position:absolute;top:354px;left:108px;white-space:nowrap" class="ft17014">many-to-many relationship between students and classes is represented.</p>
<p style="position:absolute;top:518px;left:108px;white-space:nowrap" class="ft17010"><i>Figure 12-1. Many-to-many relationship example</i></p>
<p style="position:absolute;top:555px;left:108px;white-space:nowrap" class="ft17014">The association table in this example is called&#160;registrations. Each row in this table</p>
<p style="position:absolute;top:574px;left:108px;white-space:nowrap" class="ft17015">represents an individual registration of a student in a class.<br/>Querying a many-to-many relationship is a two-step process. To obtain the list of classes</p>
<p style="position:absolute;top:621px;left:108px;white-space:nowrap" class="ft17014">a student is taking, you start from the one-to-many relationship between students and</p>
<p style="position:absolute;top:640px;left:108px;white-space:nowrap" class="ft17014">registrations and get the list of registrations for the desired student. Then the one-to-</p>
<p style="position:absolute;top:658px;left:108px;white-space:nowrap" class="ft17014">many relationship between classes and registrations is traversed in the many-to-one</p>
<p style="position:absolute;top:677px;left:108px;white-space:nowrap" class="ft17014">direction to obtain all the classes associated with the registrations retrieved for the stu‐</p>
<p style="position:absolute;top:696px;left:108px;white-space:nowrap" class="ft17014">dent. Likewise, to find all the students in a class, you start from the class and get a list</p>
<p style="position:absolute;top:715px;left:108px;white-space:nowrap" class="ft17015">of registrations, then get the students linked to those registrations.<br/>Traversing two relationships to obtain query results sounds difficult, but for a simple</p>
<p style="position:absolute;top:762px;left:108px;white-space:nowrap" class="ft17014">relationship like the one in the previous example, SQLAlchemy does most of the work.</p>
<p style="position:absolute;top:781px;left:108px;white-space:nowrap" class="ft17014">Following is the code that represents the many-to-many relationship in&#160;<a href="Flask.html#170">Figure 12-1</a>:</p>
<p style="position:absolute;top:813px;left:133px;white-space:nowrap" class="ft17047">registrations&#160;=&#160;db.Table('registrations',<br/>&#160; &#160;&#160;db.Column('student_id',&#160;db.Integer,&#160;db.ForeignKey('students.id')),<br/>&#160; &#160;&#160;db.Column('class_id',&#160;db.Integer,&#160;db.ForeignKey('classes.id'))<br/>)</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1705"><b>150&#160;&#160;|&#160;&#160;Chapter 12: Followers</b></p>
</div>
<!-- Page 171 -->
<a name="171"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page171-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask171.png" alt="background image"/>
<p style="position:absolute;top:82px;left:134px;white-space:nowrap" class="ft17147"><b>class</b>&#160;<b>Student</b>(db.Model):<br/>&#160; &#160;&#160;id&#160;=&#160;db.Column(db.Integer,&#160;primary_key=True)<br/>&#160; &#160;&#160;name&#160;=&#160;db.Column(db.String)<br/>&#160; &#160;&#160;classes&#160;=&#160;db.relationship('Class',<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;secondary=registrations,<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;backref=db.backref('students',&#160;lazy='dynamic'),<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;lazy='dynamic')</p>
<p style="position:absolute;top:205px;left:134px;white-space:nowrap" class="ft17147"><b>class</b>&#160;<b>Class</b>(db.Model):<br/>&#160; &#160;&#160;id&#160;=&#160;db.Column(db.Integer,&#160;primary_key&#160;=&#160;True)<br/>&#160; &#160;&#160;name&#160;=&#160;db.Column(db.String)</p>
<p style="position:absolute;top:257px;left:108px;white-space:nowrap" class="ft17114">The relationship is defined with the same&#160;db.relationship()&#160;construct that is used for</p>
<p style="position:absolute;top:276px;left:108px;white-space:nowrap" class="ft17114">one-to-many relationships, but in the case of a many-to-many relationship the addi‐</p>
<p style="position:absolute;top:295px;left:108px;white-space:nowrap" class="ft17114">tional&#160;secondary&#160;argument must to be set to the association table. The relationship can</p>
<p style="position:absolute;top:315px;left:108px;white-space:nowrap" class="ft17114">be defined in either one of the two classes, with the&#160;backref&#160;argument taking care of</p>
<p style="position:absolute;top:334px;left:108px;white-space:nowrap" class="ft17114">exposing the relationship from the other side as well. The association table is defined</p>
<p style="position:absolute;top:353px;left:108px;white-space:nowrap" class="ft17148">as a simple table, not as a model, since SQLAlchemy manages this table internally.<br/>The&#160;classes&#160;relationship uses list semantics, which makes working with a many-to-</p>
<p style="position:absolute;top:402px;left:108px;white-space:nowrap" class="ft17146">many relationships configured in this way extremely easy. Given a student&#160;s&#160;and a class<br/>c</p>
<p style="position:absolute;top:421px;left:116px;white-space:nowrap" class="ft17114">, the code that registers the student for the class is:</p>
<p style="position:absolute;top:453px;left:133px;white-space:nowrap" class="ft17147">&gt;&gt;&gt;&#160;s.classes.append(c)<br/>&gt;&gt;&gt;&#160;db.session.add(s)</p>
<p style="position:absolute;top:490px;left:108px;white-space:nowrap" class="ft17114">The queries that list the classes student&#160;s&#160;is registered for and the list of students regis‐</p>
<p style="position:absolute;top:510px;left:108px;white-space:nowrap" class="ft17114">tered for class&#160;c&#160;are also very simple:</p>
<p style="position:absolute;top:541px;left:134px;white-space:nowrap" class="ft17147">&gt;&gt;&gt;&#160;s.classes.all()<br/>&gt;&gt;&gt;&#160;c.students.all()</p>
<p style="position:absolute;top:578px;left:108px;white-space:nowrap" class="ft17146">The&#160;students&#160;relationship available in the&#160;Class&#160;model is the one defined in the<br/>db.backref()</p>
<p style="position:absolute;top:598px;left:198px;white-space:nowrap" class="ft17114">&#160;argument. Note that in this relationship the&#160;backref&#160;argument was ex‐</p>
<p style="position:absolute;top:618px;left:108px;white-space:nowrap" class="ft17114">panded to also have a&#160;lazy = 'dynamic'&#160;attribute, so both sides return a query that can</p>
<p style="position:absolute;top:637px;left:108px;white-space:nowrap" class="ft17148">accept additional filters.<br/>If student&#160;s&#160;later decides to drop class&#160;c, you can update the database as follows:</p>
<p style="position:absolute;top:697px;left:134px;white-space:nowrap" class="ft17133">&gt;&gt;&gt;&#160;s.classes.remove(c)</p>
<p style="position:absolute;top:725px;left:108px;white-space:nowrap" class="ft17158"><b>Self-Referential Relationships<br/></b>A many-to-many relationship can be used to model users following other users, but</p>
<p style="position:absolute;top:778px;left:108px;white-space:nowrap" class="ft17114">there is a problem. In the example of students and classes, there were two very clearly</p>
<p style="position:absolute;top:797px;left:108px;white-space:nowrap" class="ft17114">defined entities linked together by the association table. However, to represent users</p>
<p style="position:absolute;top:816px;left:108px;white-space:nowrap" class="ft17115">following other users, it is just users—there is no second entity.<br/>A relationship in which both sides belong to the same table is said to be&#160;<i>self-</i></p>
<p style="position:absolute;top:864px;left:108px;white-space:nowrap" class="ft17110"><i>referential</i></p>
<p style="position:absolute;top:863px;left:172px;white-space:nowrap" class="ft17114">. In this case the entities on the left side of the relationship are users, which</p>
<p style="position:absolute;top:915px;left:453px;white-space:nowrap" class="ft1715"><b>Database Relationships Revisited &#160;&#160;|&#160;&#160;151</b></p>
</div>
<!-- Page 172 -->
<a name="172"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page172-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask172.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft17214">can be called the “followers.” The entities on the right side are also users, but these are</p>
<p style="position:absolute;top:97px;left:108px;white-space:nowrap" class="ft17214">the “followed” users. Conceptually, self-referential relationships are no different than</p>
<p style="position:absolute;top:116px;left:108px;white-space:nowrap" class="ft17214">regular rela<a href="Flask.html#172">tionships, but they are harder to think about.&#160;Figure 12-2&#160;</a>shows a database</p>
<p style="position:absolute;top:135px;left:108px;white-space:nowrap" class="ft17214">diagram for a self-referential relationship that represents users following other users.</p>
<p style="position:absolute;top:419px;left:108px;white-space:nowrap" class="ft17210"><i>Figure 12-2. Followers, many-to-many relationship</i></p>
<p style="position:absolute;top:456px;left:108px;white-space:nowrap" class="ft17214">The association table in this case is called&#160;follows. Each row in this table represents a</p>
<p style="position:absolute;top:475px;left:108px;white-space:nowrap" class="ft17214">user following another user. The one-to-many relationship pictured on the left side</p>
<p style="position:absolute;top:494px;left:108px;white-space:nowrap" class="ft17214">associates users with the list of “follows” rows in which they are the followers. The one-</p>
<p style="position:absolute;top:513px;left:108px;white-space:nowrap" class="ft17214">to-many relationship pictured on the right side associates users with the list of “follows”</p>
<p style="position:absolute;top:532px;left:108px;white-space:nowrap" class="ft17214">rows in which they are the followed user.</p>
<p style="position:absolute;top:567px;left:108px;white-space:nowrap" class="ft17258"><b>Advanced Many-to-Many Relationships<br/></b>With a self-referential many-to-many relationship configured as indicated in the pre‐</p>
<p style="position:absolute;top:620px;left:108px;white-space:nowrap" class="ft17214">vious example, the database can represent followers, but there is one limitation. A com‐</p>
<p style="position:absolute;top:639px;left:108px;white-space:nowrap" class="ft17214">mon need when working with many-to-many relationships is to store additional data</p>
<p style="position:absolute;top:658px;left:108px;white-space:nowrap" class="ft17214">that applies to the link between two entities. For the followers relationship, it can be</p>
<p style="position:absolute;top:676px;left:108px;white-space:nowrap" class="ft17214">useful to store the date a user started following another user, as that will enable lists of</p>
<p style="position:absolute;top:695px;left:108px;white-space:nowrap" class="ft17214">followers to be presented in chronological order. The only place this information can</p>
<p style="position:absolute;top:714px;left:108px;white-space:nowrap" class="ft17214">be stored is in the association table, but in an implementation similar to that of the</p>
<p style="position:absolute;top:733px;left:108px;white-space:nowrap" class="ft17214">students and classes shown earlier, the association table is an internal table that is fully</p>
<p style="position:absolute;top:752px;left:108px;white-space:nowrap" class="ft17215">managed by SQLAlchemy.<br/>To be able to work with custom data in the relationship, the association table must be</p>
<p style="position:absolute;top:799px;left:108px;white-space:nowrap" class="ft17214">promoted to a proper model that the application can access.&#160;<a href="Flask.html#172">Example 12-1</a>&#160;shows the</p>
<p style="position:absolute;top:819px;left:108px;white-space:nowrap" class="ft17214">new association table, represented by the&#160;Follow&#160;model.</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1725"><b>152&#160;&#160;|&#160;&#160;Chapter 12: Followers</b></p>
</div>
<!-- Page 173 -->
<a name="173"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page173-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask173.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft17347"><i>Example 12-1. app/models/user.py: The follows association table as a model<br/></i><b>class</b>&#160;<b>Follow</b>(db.Model):<br/>&#160; &#160;&#160;__tablename__&#160;=&#160;'follows'<br/>&#160; &#160;&#160;follower_id&#160;=&#160;db.Column(db.Integer,&#160;db.ForeignKey('users.id'),<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;primary_key=True)<br/>&#160; &#160;&#160;followed_id&#160;=&#160;db.Column(db.Integer,&#160;db.ForeignKey('users.id'),<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;primary_key=True)<br/>&#160; &#160;&#160;timestamp&#160;=&#160;db.Column(db.DateTime,&#160;default=datetime.utcnow)</p>
<p style="position:absolute;top:225px;left:108px;white-space:nowrap" class="ft17314">SQLAlchemy cannot use the association table transparently because that will not give</p>
<p style="position:absolute;top:244px;left:108px;white-space:nowrap" class="ft17314">the application access to the custom fields in it. Instead, the many-to-many relationship</p>
<p style="position:absolute;top:263px;left:108px;white-space:nowrap" class="ft17314">must be decomposed into the two basic one-to-many relationships for the left and right</p>
<p style="position:absolute;top:282px;left:108px;white-space:nowrap" class="ft17314">sides, and these must be defined as standard relationships. This is shown in</p>
<p style="position:absolute;top:301px;left:108px;white-space:nowrap" class="ft17317"><a href="Flask.html#173">Example 12-2.</a></p>
<p style="position:absolute;top:333px;left:108px;white-space:nowrap" class="ft17347"><i>Example 12-2.&#160;app/models/user.py: A many-to-many relationship implemented as two<br/>one-to-many relationships<br/></i><b>class</b>&#160;<b>User</b>(UserMixin,&#160;db.Model):<br/>&#160; &#160;&#160;<i># ...<br/></i>&#160; &#160;&#160;followed&#160;=&#160;db.relationship('Follow',<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;foreign_keys=[Follow.follower_id],<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;backref=db.backref('follower',&#160;lazy='joined'),<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;lazy='dynamic',<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;cascade='all, delete-orphan')<br/>&#160; &#160;&#160;followers&#160;=&#160;db.relationship('Follow',<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;foreign_keys=[Follow.followed_id],<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;backref=db.backref('followed',&#160;lazy='joined'),<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;lazy='dynamic',<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;cascade='all, delete-orphan')</p>
<p style="position:absolute;top:575px;left:108px;white-space:nowrap" class="ft17314">Here the&#160;followed&#160;and&#160;followers&#160;relationships are defined as individual one-to-many</p>
<p style="position:absolute;top:594px;left:108px;white-space:nowrap" class="ft17314">relationships. Note that it is necessary to eliminate any ambiguity between foreign keys</p>
<p style="position:absolute;top:614px;left:108px;white-space:nowrap" class="ft17314">by specifying in each relationship which foreign key to use through the&#160;foreign_keys</p>
<p style="position:absolute;top:634px;left:108px;white-space:nowrap" class="ft17314">optional argument. The&#160;db.backref()&#160;arguments in these relationships do not apply</p>
<p style="position:absolute;top:654px;left:108px;white-space:nowrap" class="ft17348">to each other; the back references are applied to the&#160;Follow&#160;model.<br/>The&#160;lazy&#160;argument for the back references is specified as&#160;joined. This lazy mode causes</p>
<p style="position:absolute;top:701px;left:108px;white-space:nowrap" class="ft17314">the related object to be loaded immediately from the join query. For example, if a user</p>
<p style="position:absolute;top:721px;left:108px;white-space:nowrap" class="ft17346">is following 100 other users, calling&#160;user.followed.all()&#160;will return a list of 100<br/>Follow</p>
<p style="position:absolute;top:741px;left:153px;white-space:nowrap" class="ft17314">&#160;instances, where each one has the&#160;follower&#160;and&#160;followed&#160;back reference prop‐</p>
<p style="position:absolute;top:761px;left:108px;white-space:nowrap" class="ft17314">erties set to the respective users. The&#160;lazy='joined'&#160;mode enables this all to happen</p>
<p style="position:absolute;top:781px;left:108px;white-space:nowrap" class="ft17346">from a single database query. If&#160;lazy&#160;is set to the default value of&#160;select, then the<br/>follower</p>
<p style="position:absolute;top:800px;left:168px;white-space:nowrap" class="ft17314">&#160;and&#160;followed&#160;users are loaded lazily when they are first accessed and each</p>
<p style="position:absolute;top:819px;left:108px;white-space:nowrap" class="ft17314">attribute will require an individual query, which means that obtaining the complete list</p>
<p style="position:absolute;top:838px;left:108px;white-space:nowrap" class="ft17314">of followed users would require 100 additional database queries.</p>
<p style="position:absolute;top:915px;left:453px;white-space:nowrap" class="ft1735"><b>Database Relationships Revisited &#160;&#160;|&#160;&#160;153</b></p>
</div>
<!-- Page 174 -->
<a name="174"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page174-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask174.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft17414">The&#160;lazy&#160;argument on the&#160;User&#160;side of both relationships has different needs. These</p>
<p style="position:absolute;top:99px;left:108px;white-space:nowrap" class="ft17414">are on the “one” side and return the “many” side; here a mode of&#160;dynamic&#160;is used, so</p>
<p style="position:absolute;top:118px;left:108px;white-space:nowrap" class="ft17414">that the relationship attributes return query objects instead of returning the items di‐</p>
<p style="position:absolute;top:137px;left:108px;white-space:nowrap" class="ft17448">rectly, so that additional filters can be added to the query before it is executed.<br/>The&#160;cascade&#160;argument configures how actions performed on a parent object propagate</p>
<p style="position:absolute;top:185px;left:108px;white-space:nowrap" class="ft17414">to related objects. An example of a cascade option is the rule that says that when an</p>
<p style="position:absolute;top:204px;left:108px;white-space:nowrap" class="ft17414">object is added to the database session, any objects associated with it through relation‐</p>
<p style="position:absolute;top:223px;left:108px;white-space:nowrap" class="ft17414">ships should automatically be added to the session as well. The default cascade options</p>
<p style="position:absolute;top:241px;left:108px;white-space:nowrap" class="ft17414">are appropriate for most situations, but there is one case in which the default cascade</p>
<p style="position:absolute;top:260px;left:108px;white-space:nowrap" class="ft17414">options do not work well for this many-to-many relationship. The default cascade be‐</p>
<p style="position:absolute;top:279px;left:108px;white-space:nowrap" class="ft17414">havior when an object is deleted is to set the foreign key in any related objects that link</p>
<p style="position:absolute;top:298px;left:108px;white-space:nowrap" class="ft17414">to it to a null value. But for an association table, the correct behavior is to delete the</p>
<p style="position:absolute;top:317px;left:108px;white-space:nowrap" class="ft17414">entries that point to a record that was deleted, as this effectively destroys the link. This</p>
<p style="position:absolute;top:337px;left:108px;white-space:nowrap" class="ft17414">is what the&#160;delete-orphan&#160;cascade option does.</p>
<p style="position:absolute;top:377px;left:198px;white-space:nowrap" class="ft17425">The&#160;value&#160;given&#160;to&#160;cascade&#160;is&#160;a&#160;comma-separated&#160;list&#160;of&#160;cascade&#160;op‐</p>
<p style="position:absolute;top:395px;left:198px;white-space:nowrap" class="ft17425">tions.&#160;This&#160;is&#160;somewhat&#160;confusing,&#160;but&#160;the&#160;option&#160;named&#160;all&#160;repre‐</p>
<p style="position:absolute;top:413px;left:198px;white-space:nowrap" class="ft17431">sents&#160;all&#160;the&#160;cascade&#160;options&#160;except&#160;delete-orphan.&#160;Using&#160;the&#160;value<br/>all</p>
<p style="position:absolute;top:431px;left:218px;white-space:nowrap" class="ft17425">,&#160;delete-orphan&#160;leaves&#160;the&#160;default&#160;cascade&#160;options&#160;enabled&#160;and</p>
<p style="position:absolute;top:448px;left:198px;white-space:nowrap" class="ft17425">adds&#160;the&#160;delete&#160;behavior&#160;for&#160;orphans.</p>
<p style="position:absolute;top:494px;left:108px;white-space:nowrap" class="ft17414">The application now needs to work with the two one-to-many relationships to imple‐</p>
<p style="position:absolute;top:513px;left:108px;white-space:nowrap" class="ft17414">ment the many-to-many functionality. Since these are operations that will need to be</p>
<p style="position:absolute;top:533px;left:108px;white-space:nowrap" class="ft17414">repeated often, it is a good idea to create helper methods in the&#160;User&#160;model for all the</p>
<p style="position:absolute;top:552px;left:108px;white-space:nowrap" class="ft17414">possible operations. The four new methods that control this relationship are shown in</p>
<p style="position:absolute;top:571px;left:108px;white-space:nowrap" class="ft17417"><a href="Flask.html#174">Example 12-3.</a></p>
<p style="position:absolute;top:602px;left:108px;white-space:nowrap" class="ft17447"><i>Example 12-3. app/models/user.py: Followers helper methods<br/></i><b>class</b>&#160;<b>User</b>(db.Model):<br/>&#160; &#160;&#160;<i># ...<br/></i>&#160; &#160;&#160;<b>def</b>&#160;follow(self,&#160;user):<br/>&#160; &#160; &#160; &#160;&#160;<b>if</b>&#160;<b>not</b>&#160;self.is_following(user):<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;f&#160;=&#160;Follow(follower=self,&#160;followed=user)<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;db.session.add(f)</p>
<p style="position:absolute;top:737px;left:108px;white-space:nowrap" class="ft17447">&#160; &#160;&#160;<b>def</b>&#160;unfollow(self,&#160;user):<br/>&#160; &#160; &#160; &#160;&#160;f&#160;=&#160;self.followed.filter_by(followed_id=user.id).first()<br/>&#160; &#160; &#160; &#160;&#160;<b>if</b>&#160;f:<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;db.session.delete(f)</p>
<p style="position:absolute;top:814px;left:108px;white-space:nowrap" class="ft17447">&#160; &#160;&#160;<b>def</b>&#160;is_following(self,&#160;user):<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;self.followed.filter_by(<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;followed_id=user.id).first()&#160;<b>is</b>&#160;<b>not</b>&#160;None</p>
<p style="position:absolute;top:875px;left:108px;white-space:nowrap" class="ft1743">&#160; &#160;&#160;<b>def</b>&#160;is_followed_by(self,&#160;user):</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1745"><b>154&#160;&#160;|&#160;&#160;Chapter 12: Followers</b></p>
</div>
<!-- Page 175 -->
<a name="175"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page175-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask175.png" alt="background image"/>
<p style="position:absolute;top:82px;left:108px;white-space:nowrap" class="ft17547">&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;self.followers.filter_by(<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;follower_id=user.id).first()&#160;<b>is</b>&#160;<b>not</b>&#160;None</p>
<p style="position:absolute;top:125px;left:108px;white-space:nowrap" class="ft17514">The&#160;follow()&#160;method manually inserts a&#160;Follow&#160;instance in the association table that</p>
<p style="position:absolute;top:144px;left:108px;white-space:nowrap" class="ft17514">links a follower with a followed user, giving the application the opportunity to set the</p>
<p style="position:absolute;top:164px;left:108px;white-space:nowrap" class="ft17514">custom field. The two users who are connecting are manually assigned to the new&#160;Follow</p>
<p style="position:absolute;top:183px;left:108px;white-space:nowrap" class="ft17514">instance in its constructor, and then the object is added to the database session as usual.</p>
<p style="position:absolute;top:202px;left:108px;white-space:nowrap" class="ft17514">Note that there is no need to manually set the&#160;timestamp&#160;field because it was defined</p>
<p style="position:absolute;top:222px;left:108px;white-space:nowrap" class="ft17514">with a default value that sets the current date and time. The&#160;unfollow()&#160;method uses</p>
<p style="position:absolute;top:242px;left:108px;white-space:nowrap" class="ft17514">the&#160;followed&#160;relationship to locate the&#160;Follow&#160;instance that links the user to the followed</p>
<p style="position:absolute;top:262px;left:108px;white-space:nowrap" class="ft17514">user who needs to be disconnected. To destroy the link between the two users, the&#160;Follow</p>
<p style="position:absolute;top:282px;left:108px;white-space:nowrap" class="ft17514">object is simply deleted. The&#160;is_following()&#160;and&#160;is_followed_by()&#160;methods search</p>
<p style="position:absolute;top:301px;left:108px;white-space:nowrap" class="ft17514">the left-and right-side one-to-many relationships respectively for the given user and</p>
<p style="position:absolute;top:320px;left:108px;white-space:nowrap" class="ft17514">return&#160;True&#160;if the user is found.</p>
<p style="position:absolute;top:362px;left:198px;white-space:nowrap" class="ft17525">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:380px;left:198px;white-space:nowrap" class="ft17525">run&#160;git&#160;checkout&#160;12a&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:397px;left:198px;white-space:nowrap" class="ft17531">This&#160;update&#160;contains&#160;a&#160;database&#160;migration,&#160;so&#160;remember&#160;to&#160;run<br/>python&#160;manage.py&#160;db&#160;upgrade</p>
<p style="position:absolute;top:415px;left:384px;white-space:nowrap" class="ft17525">&#160;after&#160;you&#160;check&#160;out&#160;the&#160;code.</p>
<p style="position:absolute;top:468px;left:108px;white-space:nowrap" class="ft17514">The database part of the feature is now complete. You can find a unit test that exercises</p>
<p style="position:absolute;top:487px;left:108px;white-space:nowrap" class="ft17514">the database relationship in the source code repository on GitHub.</p>
<p style="position:absolute;top:523px;left:108px;white-space:nowrap" class="ft17518"><b>Followers on the Profile Page<br/></b>The profile page of a user needs to present a “Follow” button if the user viewing it is not</p>
<p style="position:absolute;top:582px;left:108px;white-space:nowrap" class="ft17514">a follower, or an “Unfollow” button if the user is a follower. It is also a nice addition to</p>
<p style="position:absolute;top:601px;left:108px;white-space:nowrap" class="ft17514">show the follower and followed counts, display the lists of followers and followed users,</p>
<p style="position:absolute;top:620px;left:108px;white-space:nowrap" class="ft17514">and show a “Follows You” sign when appropriate. The changes to the user profile tem‐</p>
<p style="position:absolute;top:639px;left:108px;white-space:nowrap" class="ft17514">pla<a href="Flask.html#175">te are shown in&#160;Example 12-4.&#160;</a><a href="Flask.html#176">Figure 12-3</a>&#160;shows how the additions look on the</p>
<p style="position:absolute;top:658px;left:108px;white-space:nowrap" class="ft17514">profile page.</p>
<p style="position:absolute;top:690px;left:108px;white-space:nowrap" class="ft17523"><i>Example 12-4.&#160;app/templates/user.html: Follower enhancements to the user profile<br/>header<br/></i>{% if current_user.can(Permission.FOLLOW) and user != current_user %}<br/>&#160; &#160; {% if not current_user.is_following(user) %}<br/>&#160; &#160;&#160;<b>&lt;a</b>&#160;href=&#34;{{ url_for('.follow', username=user.username) }}&#34;<br/>&#160; &#160; &#160; &#160;&#160;class=&#34;btn btn-primary&#34;<b>&gt;</b>Follow<b>&lt;/a&gt;<br/></b>&#160; &#160; {% else %}<br/>&#160; &#160;&#160;<b>&lt;a</b>&#160;href=&#34;{{ url_for('.unfollow', username=user.username) }}&#34;<br/>&#160; &#160; &#160; &#160;&#160;class=&#34;btn btn-default&#34;<b>&gt;</b>Unfollow<b>&lt;/a&gt;<br/></b>&#160; &#160; {% endif %}<br/>{% endif %}<br/><b>&lt;a</b>&#160;href=&#34;{{ url_for('.followers', username=user.username) }}&#34;<b>&gt;</b></p>
<p style="position:absolute;top:915px;left:472px;white-space:nowrap" class="ft1755"><b>Followers on the Profile Page&#160;&#160;|&#160;&#160;155</b></p>
</div>
<!-- Page 176 -->
<a name="176"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page176-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask176.png" alt="background image"/>
<p style="position:absolute;top:82px;left:108px;white-space:nowrap" class="ft17666">&#160; &#160; Followers:&#160;<b>&lt;span</b>&#160;class=&#34;badge&#34;<b>&gt;</b>{{ user.followers.count() }}<b>&lt;/span&gt;<br/>&lt;/a&gt;<br/>&lt;a</b>&#160;href=&#34;{{ url_for('.followed_by', username=user.username) }}&#34;<b>&gt;<br/></b>&#160; &#160; Following:&#160;<b>&lt;span</b>&#160;class=&#34;badge&#34;<b>&gt;</b>{{ user.followed.count() }}<b>&lt;/span&gt;<br/>&lt;/a&gt;<br/></b>{% if current_user.is_authenticated() and user != current_user and<br/>&#160; &#160; user.is_following(current_user) %}<br/>|&#160;<b>&lt;span</b>&#160;class=&#34;label label-default&#34;<b>&gt;</b>Follows you<b>&lt;/span&gt;<br/></b>{% endif %}</p>
<p style="position:absolute;top:599px;left:108px;white-space:nowrap" class="ft17610"><i>Figure 12-3. Followers on the profile page</i></p>
<p style="position:absolute;top:635px;left:108px;white-space:nowrap" class="ft17614">There are four new endpoints defined in these template changes. The&#160;<i>/follow/&lt;user‐</i></p>
<p style="position:absolute;top:654px;left:108px;white-space:nowrap" class="ft17610"><i>name&gt;</i></p>
<p style="position:absolute;top:653px;left:152px;white-space:nowrap" class="ft17614">&#160;route is invoked when a user clicks the “Follow” button on another user’s profile</p>
<p style="position:absolute;top:672px;left:108px;white-space:nowrap" class="ft17614">page. The implementa<a href="Flask.html#176">tion is shown in&#160;Example 12-5.</a></p>
<p style="position:absolute;top:704px;left:108px;white-space:nowrap" class="ft17647"><i>Example 12-5. app/main/views.py: Follow route and view function<br/></i>@main.route('/follow/&lt;username&gt;')<br/>@login_required<br/>@permission_required(Permission.FOLLOW)<br/><b>def</b>&#160;follow(username):<br/>&#160; &#160;&#160;user&#160;=&#160;User.query.filter_by(username=username).first()<br/>&#160; &#160;&#160;<b>if</b>&#160;user&#160;<b>is</b>&#160;None:<br/>&#160; &#160; &#160; &#160;&#160;flash('Invalid user.')<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;redirect(url_for('.index'))<br/>&#160; &#160;&#160;<b>if</b>&#160;current_user.is_following(user):<br/>&#160; &#160; &#160; &#160;&#160;flash('You are already following this user.')</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1765"><b>156&#160;&#160;|&#160;&#160;Chapter 12: Followers</b></p>
</div>
<!-- Page 177 -->
<a name="177"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page177-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask177.png" alt="background image"/>
<p style="position:absolute;top:82px;left:108px;white-space:nowrap" class="ft17747">&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;redirect(url_for('.user',&#160;username=username))<br/>&#160; &#160;&#160;current_user.follow(user)<br/>&#160; &#160;&#160;flash('You are now following&#160;%s.'&#160;%&#160;username)<br/>&#160; &#160;&#160;<b>return</b>&#160;redirect(url_for('.user',&#160;username=username))</p>
<p style="position:absolute;top:155px;left:108px;white-space:nowrap" class="ft17714">This view function loads the requested user, verifies that it is valid and that it isn’t already</p>
<p style="position:absolute;top:174px;left:108px;white-space:nowrap" class="ft17714">followed by the logged-in user, and then calls the&#160;follow()&#160;helper function in the&#160;User</p>
<p style="position:absolute;top:193px;left:108px;white-space:nowrap" class="ft17714">model to establish the link. The&#160;<i>/unfollow/&lt;username&gt;</i>&#160;route is implemented in a similar</p>
<p style="position:absolute;top:212px;left:108px;white-space:nowrap" class="ft17715">way.<br/>The&#160;<i>/followers/&lt;username&gt;</i>&#160;route is invoked when a user clicks another user’s follower</p>
<p style="position:absolute;top:259px;left:108px;white-space:nowrap" class="ft17714">count on the profile page. The implementa<a href="Flask.html#177">tion is shown in&#160;Example 12-6.</a></p>
<p style="position:absolute;top:291px;left:108px;white-space:nowrap" class="ft17747"><i>Example 12-6. app/main/views.py: Followers route and view function<br/></i>@main.route('/followers/&lt;username&gt;')<br/><b>def</b>&#160;followers(username):<br/>&#160; &#160;&#160;user&#160;=&#160;User.query.filter_by(username=username).first()<br/>&#160; &#160;&#160;<b>if</b>&#160;user&#160;<b>is</b>&#160;None:<br/>&#160; &#160; &#160; &#160;&#160;flash('Invalid user.')<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;redirect(url_for('.index'))<br/>&#160; &#160;&#160;page&#160;=&#160;request.args.get('page',&#160;1,&#160;type=int)<br/>&#160; &#160;&#160;pagination&#160;=&#160;user.followers.paginate(<br/>&#160; &#160; &#160; &#160;&#160;page,&#160;per_page=current_app.config['FLASKY_FOLLOWERS_PER_PAGE'],<br/>&#160; &#160; &#160; &#160;&#160;error_out=False)<br/>&#160; &#160;&#160;follows&#160;=&#160;[{'user':&#160;item.follower,&#160;'timestamp':&#160;item.timestamp}<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;<b>for</b>&#160;item&#160;<b>in</b>&#160;pagination.items]<br/>&#160; &#160;&#160;<b>return</b>&#160;render_template('followers.html',&#160;user=user,&#160;title=&#34;Followers of&#34;,<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;endpoint='.followers',&#160;pagination=pagination,<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;follows=follows)</p>
<p style="position:absolute;top:560px;left:108px;white-space:nowrap" class="ft17714">This function loads and validates the requested user, then paginates its&#160;followers</p>
<p style="position:absolute;top:579px;left:108px;white-space:nowrap" class="ft17714">rela<a href="Flask.html#151">tionship using the same techniques learned in&#160;Chapter 11. B</a>ecause the query for</p>
<p style="position:absolute;top:599px;left:108px;white-space:nowrap" class="ft17714">followers returns&#160;Follow&#160;instances, the list is converted into another list that has&#160;user</p>
<p style="position:absolute;top:619px;left:108px;white-space:nowrap" class="ft17715">and&#160;timestamp&#160;fields in each entry so that rendering is simpler.<br/>The template that renders the follower list can be written generically so that it can be</p>
<p style="position:absolute;top:666px;left:108px;white-space:nowrap" class="ft17714">used for lists of followers and followed users. The template receives the user, a title for</p>
<p style="position:absolute;top:685px;left:108px;white-space:nowrap" class="ft17714">the page, the endpoint to use in the pagination links, the pagination object, and the list</p>
<p style="position:absolute;top:703px;left:108px;white-space:nowrap" class="ft17748">of results.<br/>The&#160;followed_by&#160;endpoint is almost identical. The only difference is that the list of</p>
<p style="position:absolute;top:752px;left:108px;white-space:nowrap" class="ft17714">users is obtained from the&#160;user.followed&#160;relationship. The template arguments are</p>
<p style="position:absolute;top:771px;left:108px;white-space:nowrap" class="ft17715">also adjusted accordingly.<br/>The&#160;<i>followers.html</i>&#160;template is implemented with a two-column table that shows user‐</p>
<p style="position:absolute;top:818px;left:108px;white-space:nowrap" class="ft17714">names and their avatars on the left and Flask-Moment timestamps on the right. You can</p>
<p style="position:absolute;top:837px;left:108px;white-space:nowrap" class="ft17714">consult the source code repository on GitHub to study the implementation in detail.</p>
<p style="position:absolute;top:915px;left:472px;white-space:nowrap" class="ft1775"><b>Followers on the Profile Page&#160;&#160;|&#160;&#160;157</b></p>
</div>
<!-- Page 178 -->
<a name="178"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page178-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask178.png" alt="background image"/>
<p style="position:absolute;top:85px;left:198px;white-space:nowrap" class="ft17825">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:103px;left:198px;white-space:nowrap" class="ft17825">run&#160;git&#160;checkout&#160;12b&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:189px;left:108px;white-space:nowrap" class="ft17822"><b>Query Followed Posts Using a Database Join&#160;<br/></b>The application’s home page currently shows all the posts in the database in descending</p>
<p style="position:absolute;top:249px;left:108px;white-space:nowrap" class="ft17814">chronological order. With the followers feature now complete, it would be a nice addi‐</p>
<p style="position:absolute;top:268px;left:108px;white-space:nowrap" class="ft17815">tion to give users the option to view blog posts from only the users they follow.<br/>The obvious way to load all the posts authored by followed users is to first get the list</p>
<p style="position:absolute;top:315px;left:108px;white-space:nowrap" class="ft17814">of those users and then get the posts from each and sort them into a single list. Of course</p>
<p style="position:absolute;top:334px;left:108px;white-space:nowrap" class="ft17814">that approach does not scale well; the effort to obtain this combined list will grow as the</p>
<p style="position:absolute;top:353px;left:108px;white-space:nowrap" class="ft17814">database grows, and operations such as pagination cannot be done efficiently. The key</p>
<p style="position:absolute;top:371px;left:108px;white-space:nowrap" class="ft17815">to obtaining the blog posts with good performance is doing it with a single query.<br/>The database operation that can do this is called a&#160;<i>join</i>. A join operation takes two or</p>
<p style="position:absolute;top:418px;left:108px;white-space:nowrap" class="ft17814">more tables and finds all the combination of rows that satisfy a given condition. The</p>
<p style="position:absolute;top:437px;left:108px;white-space:nowrap" class="ft17814">resulted combined rows are inserted into a temporary table that is the result of the join.</p>
<p style="position:absolute;top:456px;left:108px;white-space:nowrap" class="ft17848">The best way to explain how joins work is through an example.<br/><a href="Flask.html#178">Table 12-1&#160;shows an exam</a>ple&#160;users&#160;table with three users.<br/><i>Table 12-1. users table</i></p>
<p style="position:absolute;top:542px;left:113px;white-space:nowrap" class="ft17881"><b>id&#160;username<br/></b>1&#160;john<br/>2&#160;susan<br/>3&#160;david</p>
<p style="position:absolute;top:640px;left:108px;white-space:nowrap" class="ft17848"><a href="Flask.html#178">Table 12-2&#160;shows the corresponding&#160;</a>posts&#160;table, with some blog posts.<br/><i>Table 12-2. Posts table</i></p>
<p style="position:absolute;top:697px;left:113px;white-space:nowrap" class="ft17874"><b>id&#160;author_id&#160;body<br/></b>1&#160;2</p>
<p style="position:absolute;top:719px;left:189px;white-space:nowrap" class="ft17830">Blog&#160;post&#160;by&#160;susan</p>
<p style="position:absolute;top:740px;left:113px;white-space:nowrap" class="ft17830">2&#160;1</p>
<p style="position:absolute;top:740px;left:189px;white-space:nowrap" class="ft17830">Blog&#160;post&#160;by&#160;john</p>
<p style="position:absolute;top:762px;left:113px;white-space:nowrap" class="ft17830">3&#160;3</p>
<p style="position:absolute;top:762px;left:189px;white-space:nowrap" class="ft17830">Blog&#160;post&#160;by&#160;david</p>
<p style="position:absolute;top:784px;left:113px;white-space:nowrap" class="ft17830">4&#160;1</p>
<p style="position:absolute;top:784px;left:189px;white-space:nowrap" class="ft17830">Second&#160;blog&#160;post&#160;by&#160;john</p>
<p style="position:absolute;top:817px;left:108px;white-space:nowrap" class="ft17814">Finally<a href="Flask.html#178">,&#160;Table 12-3</a>&#160;shows who is following whom. In this table you can see that&#160;<i>john</i>&#160;is</p>
<p style="position:absolute;top:835px;left:108px;white-space:nowrap" class="ft17814">following&#160;<i>david</i>,&#160;<i>susan</i>&#160;is following&#160;<i>john</i>, and&#160;<i>david</i>&#160;is not following anyone.</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1785"><b>158&#160;&#160;|&#160;&#160;Chapter 12: Followers</b></p>
</div>
<!-- Page 179 -->
<a name="179"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page179-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask179.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft17910"><i>Table 12-3. Follows table</i></p>
<p style="position:absolute;top:107px;left:113px;white-space:nowrap" class="ft17974"><b>follower_id&#160;followed_id<br/></b>1</p>
<p style="position:absolute;top:129px;left:176px;white-space:nowrap" class="ft17930">3</p>
<p style="position:absolute;top:151px;left:113px;white-space:nowrap" class="ft17930">2</p>
<p style="position:absolute;top:151px;left:176px;white-space:nowrap" class="ft17930">1</p>
<p style="position:absolute;top:172px;left:113px;white-space:nowrap" class="ft17930">2</p>
<p style="position:absolute;top:172px;left:176px;white-space:nowrap" class="ft17930">3</p>
<p style="position:absolute;top:206px;left:108px;white-space:nowrap" class="ft17914">To obtain the list of posts followed by user&#160;<i>susan</i>, the&#160;posts&#160;and&#160;follows&#160;tables must</p>
<p style="position:absolute;top:226px;left:108px;white-space:nowrap" class="ft17914">be combined. First the&#160;follows&#160;table is filtered to keep just the rows that have&#160;<i>susan</i>&#160;as</p>
<p style="position:absolute;top:245px;left:108px;white-space:nowrap" class="ft17914">the follower, which in this example are the last two rows. Then a temporary join table</p>
<p style="position:absolute;top:265px;left:108px;white-space:nowrap" class="ft17946">is created from all the possible combinations of rows from the&#160;posts&#160;and filtered<br/>follows</p>
<p style="position:absolute;top:284px;left:161px;white-space:nowrap" class="ft17914">&#160;tables in which the&#160;author_id&#160;of the post is the same as the&#160;followed_id&#160;of</p>
<p style="position:absolute;top:303px;left:108px;white-space:nowrap" class="ft17914">the follow, effectively selecting any posts that appear in the list of users&#160;<i>susan</i>&#160;is following.</p>
<p style="position:absolute;top:322px;left:108px;white-space:nowrap" class="ft17917"><a href="Flask.html#179">Table 12-4</a>&#160;shows the result of the join operation. The columns that were used to perform</p>
<p style="position:absolute;top:341px;left:108px;white-space:nowrap" class="ft17948">the join are marked with * in this table.<br/><i>Table 12-4. Joined table</i></p>
<p style="position:absolute;top:398px;left:113px;white-space:nowrap" class="ft17953"><b>id&#160;author_id*&#160;body</b></p>
<p style="position:absolute;top:398px;left:310px;white-space:nowrap" class="ft17953"><b>follower_id&#160;followed_id*</b></p>
<p style="position:absolute;top:420px;left:113px;white-space:nowrap" class="ft17930">2&#160;1</p>
<p style="position:absolute;top:420px;left:194px;white-space:nowrap" class="ft17930">Blog&#160;post&#160;by&#160;john</p>
<p style="position:absolute;top:420px;left:310px;white-space:nowrap" class="ft17930">2</p>
<p style="position:absolute;top:420px;left:373px;white-space:nowrap" class="ft17930">1</p>
<p style="position:absolute;top:441px;left:113px;white-space:nowrap" class="ft17930">3&#160;3</p>
<p style="position:absolute;top:441px;left:194px;white-space:nowrap" class="ft17930">Blog&#160;post&#160;by&#160;david</p>
<p style="position:absolute;top:441px;left:310px;white-space:nowrap" class="ft17930">2</p>
<p style="position:absolute;top:441px;left:373px;white-space:nowrap" class="ft17930">3</p>
<p style="position:absolute;top:463px;left:113px;white-space:nowrap" class="ft17930">4&#160;1</p>
<p style="position:absolute;top:463px;left:194px;white-space:nowrap" class="ft17930">Second&#160;blog&#160;post&#160;by&#160;john&#160;2</p>
<p style="position:absolute;top:463px;left:373px;white-space:nowrap" class="ft17930">1</p>
<p style="position:absolute;top:496px;left:108px;white-space:nowrap" class="ft17914">This table contains exactly the list of blog posts authored by users that&#160;<i>susan</i>&#160;is following.</p>
<p style="position:absolute;top:515px;left:108px;white-space:nowrap" class="ft17914">The Flask-SQLAlchemy query that literally performs the join operation as described is</p>
<p style="position:absolute;top:533px;left:108px;white-space:nowrap" class="ft17914">fairly complex:&#160;</p>
<p style="position:absolute;top:565px;left:134px;white-space:nowrap" class="ft17923"><b>return</b>&#160;db.session.query(Post).select_from(Follow).\<br/>&#160; &#160;&#160;filter_by(follower_id=self.id).\<br/>&#160; &#160;&#160;join(Post,&#160;Follow.followed_id&#160;==&#160;Post.author_id)</p>
<p style="position:absolute;top:617px;left:108px;white-space:nowrap" class="ft17914">All the queries that you have seen so far start from the&#160;query&#160;attribute of the model that</p>
<p style="position:absolute;top:636px;left:108px;white-space:nowrap" class="ft17914">is queried. That format does not work well for this query, because the query needs to</p>
<p style="position:absolute;top:656px;left:108px;white-space:nowrap" class="ft17946">return&#160;posts&#160;rows, yet the first operation that needs to be done is to apply a filter to the<br/>follows</p>
<p style="position:absolute;top:676px;left:160px;white-space:nowrap" class="ft17914">&#160;table. So a more basic form of the query is used instead. To fully understand</p>
<p style="position:absolute;top:695px;left:108px;white-space:nowrap" class="ft17914">this query, each part should be looked at individually:</p>
<p style="position:absolute;top:729px;left:121px;white-space:nowrap" class="ft17914">•&#160;db.session.query(Post)&#160;specifies that this is going to be a query that returns&#160;Post</p>
<p style="position:absolute;top:748px;left:135px;white-space:nowrap" class="ft17914">objects.</p>
<p style="position:absolute;top:774px;left:121px;white-space:nowrap" class="ft17960">•&#160;select_from(Follow)&#160;says that the query begins with the&#160;Follow&#160;model.<br/>•&#160;filter_by(follower_id=self.id)&#160;performs the filtering of the&#160;follows&#160;table by</p>
<p style="position:absolute;top:819px;left:135px;white-space:nowrap" class="ft17914">the follower user.</p>
<p style="position:absolute;top:915px;left:407px;white-space:nowrap" class="ft1795"><b>Query Followed Posts Using a Database Join &#160;&#160;|&#160;&#160;159</b></p>
</div>
<!-- Page 180 -->
<a name="180"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page180-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask180.png" alt="background image"/>
<p style="position:absolute;top:79px;left:121px;white-space:nowrap" class="ft18014">•&#160;join(Post, Follow.followed_id == Post.author_id)&#160;joins the results of</p>
<p style="position:absolute;top:102px;left:135px;white-space:nowrap" class="ft18014">filter_by()</p>
<p style="position:absolute;top:99px;left:217px;white-space:nowrap" class="ft18014">&#160;with the&#160;Post&#160;objects.</p>
<p style="position:absolute;top:133px;left:108px;white-space:nowrap" class="ft18014">The query can be simplified by swapping the order of the filter and the join:</p>
<p style="position:absolute;top:165px;left:134px;white-space:nowrap" class="ft18023"><b>return</b>&#160;Post.query.join(Follow,&#160;Follow.followed_id&#160;==&#160;Post.author_id)\<br/>&#160; &#160;&#160;.filter(Follow.follower_id&#160;==&#160;self.id)</p>
<p style="position:absolute;top:202px;left:108px;white-space:nowrap" class="ft18014">By issuing the join operation first, the query can be started from&#160;Post.query, so now</p>
<p style="position:absolute;top:221px;left:108px;white-space:nowrap" class="ft18014">the only two filters that need to be applied are&#160;join()&#160;and&#160;filter(). But is this the</p>
<p style="position:absolute;top:240px;left:108px;white-space:nowrap" class="ft18014">same? It may seem that doing the join first and then the filtering would be more work,</p>
<p style="position:absolute;top:259px;left:108px;white-space:nowrap" class="ft18014">but in reality these two queries are equivalent. SQLAlchemy first collects all the filters</p>
<p style="position:absolute;top:278px;left:108px;white-space:nowrap" class="ft18014">and then generates the query in the most efficient way. The native SQL instructions for</p>
<p style="position:absolute;top:298px;left:108px;white-space:nowrap" class="ft18014">these two queries are identical. The final version of this query is added to the&#160;Post&#160;model,</p>
<p style="position:absolute;top:317px;left:108px;white-space:nowrap" class="ft18014">as shown in&#160;<a href="Flask.html#180">Example 12-7.</a></p>
<p style="position:absolute;top:349px;left:108px;white-space:nowrap" class="ft18023"><i>Example 12-7. app/models/user.py: Obtain followed posts<br/></i><b>class</b>&#160;<b>User</b>(db.Model):<br/>&#160; &#160;&#160;<i># ...<br/></i>&#160; &#160;&#160;@property<br/>&#160; &#160;&#160;<b>def</b>&#160;followed_posts(self):<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;Post.query.join(Follow,&#160;Follow.followed_id&#160;==&#160;Post.author_id)\<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;.filter(Follow.follower_id&#160;==&#160;self.id)</p>
<p style="position:absolute;top:480px;left:108px;white-space:nowrap" class="ft18014">Note that the&#160;followed_posts()&#160;method is defined as a property so that it does not</p>
<p style="position:absolute;top:500px;left:108px;white-space:nowrap" class="ft18014">need the&#160;(). That way, all relationships have a consistent syntax.</p>
<p style="position:absolute;top:542px;left:198px;white-space:nowrap" class="ft18025">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:560px;left:198px;white-space:nowrap" class="ft18025">run&#160;git&#160;checkout&#160;12c&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:648px;left:108px;white-space:nowrap" class="ft18014">Joins are extremely hard to wrap your head around; you may need to experiment with</p>
<p style="position:absolute;top:667px;left:108px;white-space:nowrap" class="ft18014">the example code in a shell before it all sinks in.</p>
<p style="position:absolute;top:703px;left:108px;white-space:nowrap" class="ft18018"><b>Show Followed Posts on the Home Page<br/></b>The home page can now give users the choice to view all blog posts or just those from</p>
<p style="position:absolute;top:762px;left:108px;white-space:nowrap" class="ft18014">followed users.&#160;<a href="Flask.html#180">Example 12-8</a>&#160;shows how this choice is implemented.</p>
<p style="position:absolute;top:794px;left:108px;white-space:nowrap" class="ft18068"><i>Example 12-8. app/main/views.py: Show all or followed posts<br/></i>@app.route('/',&#160;methods&#160;=&#160;['GET',&#160;'POST'])<br/><b>def</b>&#160;index():<br/>&#160; &#160;&#160;<i># ...<br/></i>&#160; &#160;&#160;show_followed&#160;=&#160;False</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1805"><b>160&#160;&#160;|&#160;&#160;Chapter 12: Followers</b></p>
</div>
<!-- Page 181 -->
<a name="181"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page181-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask181.png" alt="background image"/>
<p style="position:absolute;top:82px;left:108px;white-space:nowrap" class="ft18147">&#160; &#160;&#160;<b>if</b>&#160;current_user.is_authenticated():<br/>&#160; &#160; &#160; &#160;&#160;show_followed&#160;=&#160;bool(request.cookies.get('show_followed',&#160;''))<br/>&#160; &#160;&#160;<b>if</b>&#160;show_followed:<br/>&#160; &#160; &#160; &#160;&#160;query&#160;=&#160;current_user.followed_posts<br/>&#160; &#160;&#160;<b>else</b>:<br/>&#160; &#160; &#160; &#160;&#160;query&#160;=&#160;Post.query<br/>&#160; &#160;&#160;pagination&#160;=&#160;query.order_by(Post.timestamp.desc()).paginate(<br/>&#160; &#160; &#160; &#160;&#160;page,&#160;per_page=current_app.config['FLASKY_POSTS_PER_PAGE'],<br/>&#160; &#160; &#160; &#160;&#160;error_out=False)<br/>&#160; &#160;&#160;posts&#160;=&#160;pagination.items<br/>&#160; &#160;&#160;<b>return</b>&#160;render_template('index.html',&#160;form=form,&#160;posts=posts,<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;show_followed=show_followed,&#160;pagination=pagination)</p>
<p style="position:absolute;top:278px;left:108px;white-space:nowrap" class="ft18114">The choice of showing all or followed posts is stored in a cookie called&#160;show_followed</p>
<p style="position:absolute;top:297px;left:108px;white-space:nowrap" class="ft18114">that when set to a nonempty string indicates that only followed posts should be shown.</p>
<p style="position:absolute;top:317px;left:108px;white-space:nowrap" class="ft18114">Cookies are stored in the request object as a&#160;request.cookies&#160;dictionary. The string</p>
<p style="position:absolute;top:337px;left:108px;white-space:nowrap" class="ft18114">value of the cookie is converted to a Boolean, and based on its value a&#160;query&#160;local variable</p>
<p style="position:absolute;top:355px;left:108px;white-space:nowrap" class="ft18114">is set to the query that obtains the complete or filtered lists of blog posts. To show all</p>
<p style="position:absolute;top:375px;left:108px;white-space:nowrap" class="ft18146">the posts, the top-level query&#160;Post.query&#160;is used, and the recently added<br/>User.followed_posts</p>
<p style="position:absolute;top:395px;left:251px;white-space:nowrap" class="ft18114">&#160;property is used when the list should be restricted to followers.</p>
<p style="position:absolute;top:415px;left:108px;white-space:nowrap" class="ft18114">The query stored in the&#160;query&#160;local variable is then paginated and the results sent to the</p>
<p style="position:absolute;top:434px;left:108px;white-space:nowrap" class="ft18148">template as before.<br/>The&#160;show_followed&#160;cookie is set in two new routes, shown in&#160;<a href="Flask.html#181">Example 12-9</a>.</p>
<p style="position:absolute;top:494px;left:108px;white-space:nowrap" class="ft18147"><i>Example 12-9. app/main/views.py: Selection of all or followed posts<br/></i>@main.route('/all')<br/>@login_required<br/><b>def</b>&#160;show_all():<br/>&#160; &#160;&#160;resp&#160;=&#160;make_response(redirect(url_for('.index')))<br/>&#160; &#160;&#160;resp.set_cookie('show_followed',&#160;'',&#160;max_age=30*24*60*60)<br/>&#160; &#160;&#160;<b>return</b>&#160;resp</p>
<p style="position:absolute;top:629px;left:108px;white-space:nowrap" class="ft18147">@main.route('/followed')<br/>@login_required<br/><b>def</b>&#160;show_followed():<br/>&#160; &#160;&#160;resp&#160;=&#160;make_response(redirect(url_for('.index')))<br/>&#160; &#160;&#160;resp.set_cookie('show_followed',&#160;'1',&#160;max_age=30*24*60*60)<br/>&#160; &#160;&#160;<b>return</b>&#160;resp</p>
<p style="position:absolute;top:732px;left:108px;white-space:nowrap" class="ft18146">Links to these routes are added to the home page template. When they are invoked, the<br/>show_followed</p>
<p style="position:absolute;top:752px;left:205px;white-space:nowrap" class="ft18114">&#160;cookie is set to the proper value and a redirect back to the home page</p>
<p style="position:absolute;top:771px;left:108px;white-space:nowrap" class="ft18115">is issued.<br/>Cookies can be set only on a response object, so these routes need to create a response</p>
<p style="position:absolute;top:819px;left:108px;white-space:nowrap" class="ft18148">object through&#160;make_response()&#160;instead of letting Flask do this.<br/>The&#160;set_cookie()&#160;function takes the cookie name and the value as the first two argu‐</p>
<p style="position:absolute;top:867px;left:108px;white-space:nowrap" class="ft18114">ments. The&#160;max_age&#160;optional argument sets the number of seconds until the cookie</p>
<p style="position:absolute;top:915px;left:425px;white-space:nowrap" class="ft1815"><b>Show Followed Posts on the Home Page&#160;&#160;|&#160;&#160;161</b></p>
</div>
<!-- Page 182 -->
<a name="182"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page182-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask182.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft18214">expires. Not including this argument makes the cookie expire when the browser window</p>
<p style="position:absolute;top:97px;left:108px;white-space:nowrap" class="ft18214">is closed. In this case, an age of 30 days is set so that the setting is remembered even if</p>
<p style="position:absolute;top:116px;left:108px;white-space:nowrap" class="ft18215">the user does not return to the application for several days.<br/>The changes to the template add two navigation tabs at the top of the page that invoke</p>
<p style="position:absolute;top:163px;left:108px;white-space:nowrap" class="ft18214">the&#160;<i>/all</i>&#160;or&#160;<i>/followed</i>&#160;routes to set the correct settings in the session. You can inspect the</p>
<p style="position:absolute;top:182px;left:108px;white-space:nowrap" class="ft18214">template changes in detail in the source code repository on GitHub.&#160;<a href="Flask.html#182">Figure 12-4&#160;</a>shows</p>
<p style="position:absolute;top:201px;left:108px;white-space:nowrap" class="ft18214">how the home page looks with these changes.</p>
<p style="position:absolute;top:596px;left:108px;white-space:nowrap" class="ft18210"><i>Figure 12-4. Followed posts on the home page</i></p>
<p style="position:absolute;top:639px;left:198px;white-space:nowrap" class="ft18225">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:657px;left:198px;white-space:nowrap" class="ft18225">run&#160;git&#160;checkout&#160;12d&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:745px;left:108px;white-space:nowrap" class="ft18214">If you try the application at this point and switch to the followed list of posts, you will</p>
<p style="position:absolute;top:764px;left:108px;white-space:nowrap" class="ft18214">notice that your own posts do not appear in the list. This is of course correct, because</p>
<p style="position:absolute;top:783px;left:108px;white-space:nowrap" class="ft18215">users are not followers of themselves.<br/>Even though the queries are working as designed, most users will expect to see their</p>
<p style="position:absolute;top:830px;left:108px;white-space:nowrap" class="ft18214">own posts when they are looking at those of their friends. The easiest way to address</p>
<p style="position:absolute;top:849px;left:108px;white-space:nowrap" class="ft18214">this issue is to register all users as their own followers at the time they are created. This</p>
<p style="position:absolute;top:868px;left:108px;white-space:nowrap" class="ft18214"><a href="Flask.html#183">trick is shown in&#160;Example 12-10</a>.</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1825"><b>162&#160;&#160;|&#160;&#160;Chapter 12: Followers</b></p>
</div>
<!-- Page 183 -->
<a name="183"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page183-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask183.png" alt="background image"/>
<p style="position:absolute;top:94px;left:108px;white-space:nowrap" class="ft18368"><i>Example 12-10. app/models/user.py: Make users their own followers on construction<br/></i><b>class</b>&#160;<b>User</b>(UserMixin,&#160;db.Model):<br/>&#160; &#160;&#160;<i># ...<br/></i>&#160; &#160;&#160;<b>def</b>&#160;__init__(self,&#160;**kwargs):<br/>&#160; &#160; &#160; &#160;&#160;<i># ...<br/></i>&#160; &#160; &#160; &#160;&#160;self.follow(self)</p>
<p style="position:absolute;top:210px;left:108px;white-space:nowrap" class="ft18314">Unfortunately, you likely have several users in the database who are already created and</p>
<p style="position:absolute;top:229px;left:108px;white-space:nowrap" class="ft18314">are not following themselves. If the database is small and easy to regenerate, then it can</p>
<p style="position:absolute;top:248px;left:108px;white-space:nowrap" class="ft18314">be deleted and re-created, but if that is not an option, then adding an update function</p>
<p style="position:absolute;top:267px;left:108px;white-space:nowrap" class="ft18314">that fixes existing users is the proper solution. This is shown in&#160;<a href="Flask.html#183">Example 12-11</a>.</p>
<p style="position:absolute;top:298px;left:108px;white-space:nowrap" class="ft18347"><i>Example 12-11. app/models/user.py: Make users their own followers<br/></i><b>class</b>&#160;<b>User</b>(UserMixin,&#160;db.Model):<br/>&#160; &#160;&#160;<i># ...<br/></i>&#160; &#160;&#160;@staticmethod<br/>&#160; &#160;&#160;<b>def</b>&#160;add_self_follows():<br/>&#160; &#160; &#160; &#160;&#160;<b>for</b>&#160;user&#160;<b>in</b>&#160;User.query.all():<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>if</b>&#160;<b>not</b>&#160;user.is_following(user):<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;user.follow(user)<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;db.session.add(user)<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;db.session.commit()<br/>&#160; &#160;&#160;<i># ...</i></p>
<p style="position:absolute;top:490px;left:108px;white-space:nowrap" class="ft18314">Now the database can be updated by running the previous example function from the</p>
<p style="position:absolute;top:509px;left:108px;white-space:nowrap" class="ft18314">shell:</p>
<p style="position:absolute;top:541px;left:133px;white-space:nowrap" class="ft18340">(venv)&#160;$&#160;python&#160;manage.py&#160;shell<br/>&gt;&gt;&gt;&#160;User.add_self_follows()</p>
<p style="position:absolute;top:577px;left:108px;white-space:nowrap" class="ft18314">Creating functions that introduce updates to the database is a common technique used</p>
<p style="position:absolute;top:596px;left:108px;white-space:nowrap" class="ft18314">to update applications that are deployed, as running a scripted update is less error prone</p>
<p style="position:absolute;top:615px;left:108px;white-space:nowrap" class="ft18314">than updating databases manually<a href="Flask.html#235">. In&#160;Chapter 17&#160;you will see how this function and</a></p>
<p style="position:absolute;top:633px;left:108px;white-space:nowrap" class="ft18315">others like it can be incorporated into a deployment script.<br/>Making all users self-followers makes the application more usable, but this change in‐</p>
<p style="position:absolute;top:680px;left:108px;white-space:nowrap" class="ft18314">troduces a few complications. The follower and followed user counts shown in the user</p>
<p style="position:absolute;top:699px;left:108px;white-space:nowrap" class="ft18314">profile page are now increased by one due to the self-follower links. The numbers need</p>
<p style="position:absolute;top:718px;left:108px;white-space:nowrap" class="ft18314">to be decreased by one to be accurate, which is easy to do directly in the template by</p>
<p style="position:absolute;top:738px;left:108px;white-space:nowrap" class="ft18346">rendering&#160;{{ user.followers.count() - 1 }}&#160;and&#160;{{ user.followed.count() -<br/>1 }}</p>
<p style="position:absolute;top:758px;left:139px;white-space:nowrap" class="ft18314">. The lists of follower and followed users also must be adjusted to not show the</p>
<p style="position:absolute;top:777px;left:108px;white-space:nowrap" class="ft18314">same user, another simple task to do in the template with a conditional. Finally, any unit</p>
<p style="position:absolute;top:795px;left:108px;white-space:nowrap" class="ft18314">tests that check follower counts are also affected by the self-follower links and must be</p>
<p style="position:absolute;top:814px;left:108px;white-space:nowrap" class="ft18314">adjusted to account for the self-followers.</p>
<p style="position:absolute;top:915px;left:425px;white-space:nowrap" class="ft1835"><b>Show Followed Posts on the Home Page&#160;&#160;|&#160;&#160;163</b></p>
</div>
<!-- Page 184 -->
<a name="184"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page184-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask184.png" alt="background image"/>
<p style="position:absolute;top:85px;left:198px;white-space:nowrap" class="ft18425">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:103px;left:198px;white-space:nowrap" class="ft18425">run&#160;git&#160;checkout&#160;12e&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:192px;left:108px;white-space:nowrap" class="ft18414">In the next chapter, the user comment subsystem will be implemented—another very</p>
<p style="position:absolute;top:211px;left:108px;white-space:nowrap" class="ft18414">important feature of socially aware applications.</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1845"><b>164&#160;&#160;|&#160;&#160;Chapter 12: Followers</b></p>
</div>
<!-- Page 185 -->
<a name="185"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page185-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask185.png" alt="background image"/>
<p style="position:absolute;top:104px;left:549px;white-space:nowrap" class="ft18528"><b>CHAPTER 13</b></p>
<p style="position:absolute;top:131px;left:455px;white-space:nowrap" class="ft18511"><b>User Comments</b></p>
<p style="position:absolute;top:345px;left:108px;white-space:nowrap" class="ft18514">Allowing users to interact is key to the success of a social blogging platform. In this</p>
<p style="position:absolute;top:364px;left:108px;white-space:nowrap" class="ft18514">chapter, you will learn how to implement user comments. The techniques presented are</p>
<p style="position:absolute;top:383px;left:108px;white-space:nowrap" class="ft18514">generic enough to be directly applicable to a large number of socially enabled applica‐</p>
<p style="position:absolute;top:402px;left:108px;white-space:nowrap" class="ft18514">tions.</p>
<p style="position:absolute;top:438px;left:108px;white-space:nowrap" class="ft18518"><b>Database Representation of Comments<br/></b>Comments are not very different from blog posts. Both have a body, an author, and a</p>
<p style="position:absolute;top:497px;left:108px;white-space:nowrap" class="ft18514">timestamp, and in this particular implementation both are written with Markdown</p>
<p style="position:absolute;top:517px;left:108px;white-space:nowrap" class="ft18514">syn<a href="Flask.html#185">tax.&#160;Figure 13-1</a>&#160;shows a diagram of the&#160;comments&#160;table and its relationships with</p>
<p style="position:absolute;top:536px;left:108px;white-space:nowrap" class="ft18514">other tables in the database.</p>
<p style="position:absolute;top:747px;left:108px;white-space:nowrap" class="ft18510"><i>Figure 13-1. Database representation of blog post comments</i></p>
<p style="position:absolute;top:784px;left:108px;white-space:nowrap" class="ft18514">Comments apply specific blog posts, so a one-to-many relationship from the&#160;posts&#160;table</p>
<p style="position:absolute;top:803px;left:108px;white-space:nowrap" class="ft18514">is defined. This relationship can be used to obtain the list of comments associated with</p>
<p style="position:absolute;top:821px;left:108px;white-space:nowrap" class="ft18514">a particular blog post.</p>
<p style="position:absolute;top:915px;left:631px;white-space:nowrap" class="ft1855"><b>165</b></p>
</div>
<!-- Page 186 -->
<a name="186"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page186-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask186.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft18614">The&#160;comments&#160;table is also in a one-to-many relationship with the&#160;users&#160;table. This</p>
<p style="position:absolute;top:98px;left:108px;white-space:nowrap" class="ft18614">relationship gives access to all the comments made by a user, and indirectly how many</p>
<p style="position:absolute;top:117px;left:108px;white-space:nowrap" class="ft18614">comments a user has written, a piece of information that can be interesting to show in</p>
<p style="position:absolute;top:137px;left:108px;white-space:nowrap" class="ft18614">user profile pages. The definition of the&#160;Comment&#160;model is shown in&#160;<a href="Flask.html#186">Example 13-1</a>.</p>
<p style="position:absolute;top:169px;left:108px;white-space:nowrap" class="ft18647"><i>Example 13-1. app/models.py: Comment model<br/></i><b>class</b>&#160;<b>Comment</b>(db.Model):<br/>&#160; &#160;&#160;__tablename__&#160;=&#160;'comments'<br/>&#160; &#160;&#160;id&#160;=&#160;db.Column(db.Integer,&#160;primary_key=True)<br/>&#160; &#160;&#160;body&#160;=&#160;db.Column(db.Text)<br/>&#160; &#160;&#160;body_html&#160;=&#160;db.Column(db.Text)<br/>&#160; &#160;&#160;timestamp&#160;=&#160;db.Column(db.DateTime,&#160;index=True,&#160;default=datetime.utcnow)<br/>&#160; &#160;&#160;disabled&#160;=&#160;db.Column(db.Boolean)<br/>&#160; &#160;&#160;author_id&#160;=&#160;db.Column(db.Integer,&#160;db.ForeignKey('users.id'))<br/>&#160; &#160;&#160;post_id&#160;=&#160;db.Column(db.Integer,&#160;db.ForeignKey('posts.id'))</p>
<p style="position:absolute;top:350px;left:108px;white-space:nowrap" class="ft18647">&#160; &#160;&#160;@staticmethod<br/>&#160; &#160;&#160;<b>def</b>&#160;on_changed_body(target,&#160;value,&#160;oldvalue,&#160;initiator):<br/>&#160; &#160; &#160; &#160;&#160;allowed_tags&#160;=&#160;['a',&#160;'abbr',&#160;'acronym',&#160;'b',&#160;'code',&#160;'em',&#160;'i',<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;'strong']<br/>&#160; &#160; &#160; &#160;&#160;target.body_html&#160;=&#160;bleach.linkify(bleach.clean(<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;markdown(value,&#160;output_format='html'),<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;tags=allowed_tags,&#160;strip=True))</p>
<p style="position:absolute;top:472px;left:108px;white-space:nowrap" class="ft18637">db.event.listen(Comment.body,&#160;'set',&#160;Comment.on_changed_body)</p>
<p style="position:absolute;top:499px;left:108px;white-space:nowrap" class="ft18614">The attributes of the&#160;Comment&#160;model are almost the same as those of&#160;Post. One addition</p>
<p style="position:absolute;top:519px;left:108px;white-space:nowrap" class="ft18614">is the&#160;disabled&#160;field, a Boolean that will be used by moderators to suppress comments</p>
<p style="position:absolute;top:538px;left:108px;white-space:nowrap" class="ft18614">that are inappropriate or offensive. As was done for blog posts, comments define an</p>
<p style="position:absolute;top:558px;left:108px;white-space:nowrap" class="ft18614">event that triggers any time the&#160;body&#160;field changes, automating the rendering of the</p>
<p style="position:absolute;top:577px;left:108px;white-space:nowrap" class="ft18614">Markdown text to HTML. The process is identical to what was done for blog posts in</p>
<p style="position:absolute;top:596px;left:108px;white-space:nowrap" class="ft18617"><a href="Flask.html#151">Chapter 11</a>, but since comments tend to be short, the list of HTML tags that are allowed</p>
<p style="position:absolute;top:615px;left:108px;white-space:nowrap" class="ft18614">in the conversion from Markdown is more restrictive, the paragraph-related tags have</p>
<p style="position:absolute;top:634px;left:108px;white-space:nowrap" class="ft18648">been removed, and only the character formatting tags are left.<br/>To complete the database changes, the&#160;User&#160;and&#160;Post&#160;models must define the one-to-</p>
<p style="position:absolute;top:682px;left:108px;white-space:nowrap" class="ft18614">many relationships with the&#160;comments&#160;table, as shown in&#160;<a href="Flask.html#186">Example 13-2.</a></p>
<p style="position:absolute;top:714px;left:108px;white-space:nowrap" class="ft18668"><i>Example 13-2.&#160;app/models/user.py: One-to-many relationships from users and posts to<br/>comments<br/></i><b>class</b>&#160;<b>User</b>(db.Model):<br/>&#160; &#160;&#160;<i># ...<br/></i>&#160; &#160;&#160;comments&#160;=&#160;db.relationship('Comment',&#160;backref='author',&#160;lazy='dynamic')</p>
<p style="position:absolute;top:822px;left:108px;white-space:nowrap" class="ft18668"><b>class</b>&#160;<b>Post</b>(db.Model):<br/>&#160; &#160;&#160;<i># ...<br/></i>&#160; &#160;&#160;comments&#160;=&#160;db.relationship('Comment',&#160;backref='post',&#160;lazy='dynamic')</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1865"><b>166&#160;&#160;|&#160;&#160;Chapter 13: User Comments</b></p>
</div>
<!-- Page 187 -->
<a name="187"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page187-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask187.png" alt="background image"/>
<p style="position:absolute;top:74px;left:108px;white-space:nowrap" class="ft18718"><b>Comment Submission and Display<br/></b>In this application, comments are displayed in the individual blog post pages that were</p>
<p style="position:absolute;top:134px;left:108px;white-space:nowrap" class="ft18714">added as permanent links in&#160;<a href="Flask.html#151">Chapter 11. A submission form is also included on this</a></p>
<p style="position:absolute;top:152px;left:108px;white-space:nowrap" class="ft18714">page.&#160;<a href="Flask.html#187">Example 13-3&#160;</a>shows the web form that will be used to enter comments—an ex‐</p>
<p style="position:absolute;top:171px;left:108px;white-space:nowrap" class="ft18714">tremely simple form that only has a text field and a submit button.</p>
<p style="position:absolute;top:203px;left:108px;white-space:nowrap" class="ft18747"><i>Example 13-3. app/main/forms.py: Comment input form<br/></i><b>class</b>&#160;<b>CommentForm</b>(Form):<br/>&#160; &#160;&#160;body&#160;=&#160;StringField('',&#160;validators=[Required()])<br/>&#160; &#160;&#160;submit&#160;=&#160;SubmitField('Submit')</p>
<p style="position:absolute;top:288px;left:108px;white-space:nowrap" class="ft18717"><a href="Flask.html#187">Example 13-4&#160;shows the upda</a>ted&#160;<i>/post/&lt;int:id&gt;</i>&#160;route with support for comments.</p>
<p style="position:absolute;top:320px;left:108px;white-space:nowrap" class="ft18747"><i>Example 13-4. app/main/views.py: Blog post comments support<br/></i>@main.route('/post/&lt;int:id&gt;',&#160;methods=['GET',&#160;'POST'])<br/><b>def</b>&#160;post(id):<br/>&#160; &#160;&#160;post&#160;=&#160;Post.query.get_or_404(id)<br/>&#160; &#160;&#160;form&#160;=&#160;CommentForm()<br/>&#160; &#160;&#160;<b>if</b>&#160;form.validate_on_submit():<br/>&#160; &#160; &#160; &#160;&#160;comment&#160;=&#160;Comment(body=form.body.data,<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;post=post,<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;author=current_user._get_current_object())<br/>&#160; &#160; &#160; &#160;&#160;db.session.add(comment)<br/>&#160; &#160; &#160; &#160;&#160;flash('Your comment has been published.')<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;redirect(url_for('.post',&#160;id=post.id,&#160;page=-1))<br/>&#160; &#160;&#160;page&#160;=&#160;request.args.get('page',&#160;1,&#160;type=int)<br/>&#160; &#160;&#160;<b>if</b>&#160;page&#160;==&#160;-1:<br/>&#160; &#160; &#160; &#160;&#160;page&#160;=&#160;(post.comments.count()&#160;-&#160;1)&#160;/&#160;\<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;current_app.config['FLASKY_COMMENTS_PER_PAGE']&#160;+&#160;1<br/>&#160; &#160;&#160;pagination&#160;=&#160;post.comments.order_by(Comment.timestamp.asc()).paginate(<br/>&#160; &#160; &#160; &#160;&#160;page,&#160;per_page=current_app.config['FLASKY_COMMENTS_PER_PAGE'],<br/>&#160; &#160; &#160; &#160;&#160;error_out=False)<br/>&#160; &#160;&#160;comments&#160;=&#160;pagination.items<br/>&#160; &#160;&#160;<b>return</b>&#160;render_template('post.html',&#160;posts=[post],&#160;form=form,<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;comments=comments,&#160;pagination=pagination)</p>
<p style="position:absolute;top:680px;left:108px;white-space:nowrap" class="ft18714">This view function instantiates the comment form and sends it to the&#160;<i>post.html</i>&#160;template</p>
<p style="position:absolute;top:699px;left:108px;white-space:nowrap" class="ft18714">for rendering. The logic that inserts a new comment when the form is submitted is</p>
<p style="position:absolute;top:719px;left:108px;white-space:nowrap" class="ft18714">similar to the handling of blog posts. As in the&#160;Post&#160;case, the&#160;author&#160;of the comment</p>
<p style="position:absolute;top:739px;left:108px;white-space:nowrap" class="ft18714">cannot be set directly to&#160;current_user&#160;because this is a context variable proxy object.</p>
<p style="position:absolute;top:759px;left:108px;white-space:nowrap" class="ft18715">The expression&#160;current_user._get_current_object()&#160;returns the actual&#160;User&#160;object.<br/>The comments are sorted by their timestamp in chronological order, so new comments</p>
<p style="position:absolute;top:805px;left:108px;white-space:nowrap" class="ft18714">are always added at the bottom of the list. When a new comment is entered, the redirect</p>
<p style="position:absolute;top:825px;left:108px;white-space:nowrap" class="ft18714">that ends the request goes back to the same URL, but the&#160;url_for()&#160;function sets the</p>
<p style="position:absolute;top:845px;left:108px;white-space:nowrap" class="ft18714">page to&#160;-1, a special page number that is used to request the last page of comments so</p>
<p style="position:absolute;top:864px;left:108px;white-space:nowrap" class="ft18714">that the comment just entered is seen on the page. When the page number is obtained</p>
<p style="position:absolute;top:915px;left:452px;white-space:nowrap" class="ft1875"><b>Comment Submission and Display&#160;&#160;|&#160;&#160;167</b></p>
</div>
<!-- Page 188 -->
<a name="188"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page188-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask188.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft18814">from the query string and found to be&#160;-1, a calculation with the number of comments</p>
<p style="position:absolute;top:98px;left:108px;white-space:nowrap" class="ft18848">and the page size is done to obtain the actual page number to use.<br/>The list of comments associated with the post are obtained through the&#160;post.comments</p>
<p style="position:absolute;top:146px;left:108px;white-space:nowrap" class="ft18814">one-to-many relationship, sorted by comment timestamp, and paginated with the same</p>
<p style="position:absolute;top:165px;left:108px;white-space:nowrap" class="ft18814">techniques used for blog posts. The comments and the pagination object are sent to the</p>
<p style="position:absolute;top:185px;left:108px;white-space:nowrap" class="ft18814">template for rendering. The&#160;FLASKY_COMMENTS_PER_PAGE&#160;configuration variable is add‐</p>
<p style="position:absolute;top:204px;left:108px;white-space:nowrap" class="ft18815">ed to&#160;<i>config.py</i>&#160;to control the size of each page of comments.<br/>The comment rendering is defined in a new template _<i>comments.html</i>&#160;that is similar to</p>
<p style="position:absolute;top:251px;left:108px;white-space:nowrap" class="ft18810"><i>_posts.html</i></p>
<p style="position:absolute;top:250px;left:179px;white-space:nowrap" class="ft18814">&#160;but uses a different set of CSS classes. This template is included by&#160;<i>_post.html</i></p>
<p style="position:absolute;top:269px;left:108px;white-space:nowrap" class="ft18814">below the body of the post, followed by a call to the pagination macro. You can review</p>
<p style="position:absolute;top:288px;left:108px;white-space:nowrap" class="ft18815">the changes to the templates in the application’s GitHub repository.<br/>To complete this feature, blog posts shown in the home and profile pages need a link to</p>
<p style="position:absolute;top:335px;left:108px;white-space:nowrap" class="ft18814">the page with the comments. This is shown in&#160;<a href="Flask.html#188">Example 13-5</a>.</p>
<p style="position:absolute;top:367px;left:108px;white-space:nowrap" class="ft18866"><i>Example 13-5. _app/templates/_posts.html: Link to blog post comments<br/></i><b>&lt;a</b>&#160;href=&#34;{{ url_for('.post', id=post.id) }}#comments&#34;<b>&gt;<br/></b>&#160; &#160;&#160;<b>&lt;span</b>&#160;class=&#34;label label-primary&#34;<b>&gt;<br/></b>&#160; &#160; &#160; &#160; {{ post.comments.count() }} Comments<br/>&#160; &#160;&#160;<b>&lt;/span&gt;<br/>&lt;/a&gt;</b></p>
<p style="position:absolute;top:482px;left:108px;white-space:nowrap" class="ft18814">Note how the text of the link includes the number of comments, which is easily obtained</p>
<p style="position:absolute;top:502px;left:108px;white-space:nowrap" class="ft18814">from the one-to-many relationship between the&#160;posts&#160;and&#160;comments&#160;tables using</p>
<p style="position:absolute;top:522px;left:108px;white-space:nowrap" class="ft18815">SQLAlchemy’s&#160;count()&#160;filter.<br/>Also of interest is the structure of the link to the comments page, which is built as the</p>
<p style="position:absolute;top:569px;left:108px;white-space:nowrap" class="ft18814">permanent link for the post with a&#160;<i>#comments</i>&#160;suffix added. This last part is called a</p>
<p style="position:absolute;top:589px;left:108px;white-space:nowrap" class="ft18810"><i>URL fragment</i></p>
<p style="position:absolute;top:588px;left:198px;white-space:nowrap" class="ft18814">&#160;and is used to indicate an initial scroll position for the page. The web</p>
<p style="position:absolute;top:607px;left:108px;white-space:nowrap" class="ft18814">browser looks for an element with the&#160;id&#160;given and scrolls the page so that the element</p>
<p style="position:absolute;top:626px;left:108px;white-space:nowrap" class="ft18814">appears at the top of the page. This initial position is set to the comments heading in</p>
<p style="position:absolute;top:646px;left:108px;white-space:nowrap" class="ft18814">the&#160;<i>post.html</i>&#160;template, which is written as&#160;&lt;h4 id=&#34;comments&#34;&gt;Comments&lt;h4&gt;.</p>
<p style="position:absolute;top:665px;left:108px;white-space:nowrap" class="ft18815"><a href="Flask.html#189">Figure 13-2&#160;shows how the commen</a>ts appear on the page.<br/>An additional change was made to the pagination macro. The pagination links for</p>
<p style="position:absolute;top:712px;left:108px;white-space:nowrap" class="ft18814">comments also need the&#160;<i>#comments</i>&#160;fragment added, so a fragment argument was added</p>
<p style="position:absolute;top:731px;left:108px;white-space:nowrap" class="ft18814">to the macro and passed in the macro invocation from the&#160;<i>post.html</i>&#160;template.</p>
<p style="position:absolute;top:772px;left:198px;white-space:nowrap" class="ft18825">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:791px;left:198px;white-space:nowrap" class="ft18825">run&#160;git&#160;checkout&#160;13a&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:808px;left:198px;white-space:nowrap" class="ft18831">This&#160;update&#160;contains&#160;a&#160;database&#160;migration,&#160;so&#160;remember&#160;to&#160;run<br/>python&#160;manage.py&#160;db&#160;upgrade</p>
<p style="position:absolute;top:826px;left:384px;white-space:nowrap" class="ft18825">&#160;after&#160;you&#160;check&#160;out&#160;the&#160;code.</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1885"><b>168&#160;&#160;|&#160;&#160;Chapter 13: User Comments</b></p>
</div>
<!-- Page 189 -->
<a name="189"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page189-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask189.png" alt="background image"/>
<p style="position:absolute;top:526px;left:108px;white-space:nowrap" class="ft18910"><i>Figure 13-2. Blog post comments</i></p>
<p style="position:absolute;top:561px;left:108px;white-space:nowrap" class="ft18918"><b>Comment Moderation<br/></b><a href="Flask.html#131">In&#160;Chapter 9&#160;</a>a list of user roles was defined, each with a list of permissions. One of the</p>
<p style="position:absolute;top:622px;left:108px;white-space:nowrap" class="ft18914">permissions was&#160;Permission.MODERATE_COMMENTS, which gives users who have it in</p>
<p style="position:absolute;top:640px;left:108px;white-space:nowrap" class="ft18915">their roles the power to moderate comments made by others.<br/>This feature will be exposed as a link in the navigation bar that appears only to users</p>
<p style="position:absolute;top:687px;left:108px;white-space:nowrap" class="ft18914">who are permitted to use it. This is done in the&#160;<i>base.html</i>&#160;template using a conditional,</p>
<p style="position:absolute;top:706px;left:108px;white-space:nowrap" class="ft18914">as shown in&#160;<a href="Flask.html#189">Example 13-6.</a></p>
<p style="position:absolute;top:738px;left:108px;white-space:nowrap" class="ft18923"><i>Example 13-6. app/templates/base.html: Moderate comments link in navigation bar<br/></i>...<br/>{% if current_user.can(Permission.MODERATE_COMMENTS) %}<br/><b>&lt;li&gt;&lt;a</b>&#160;href=&#34;{{ url_for('main.moderate') }}&#34;<b>&gt;</b>Moderate Comments<b>&lt;/a&gt;&lt;/li&gt;<br/></b>{% endif %}<br/>...</p>
<p style="position:absolute;top:915px;left:504px;white-space:nowrap" class="ft1895"><b>Comment Moderation&#160;&#160;|&#160;&#160;169</b></p>
</div>
<!-- Page 190 -->
<a name="190"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page190-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask190.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft19014">The moderation page shows the comments for all the posts in the same list, with the</p>
<p style="position:absolute;top:97px;left:108px;white-space:nowrap" class="ft19046">most recent comments shown first. Below each comment is a button that can toggle the<br/>disabled</p>
<p style="position:absolute;top:117px;left:168px;white-space:nowrap" class="ft19014">&#160;attribute. The&#160;<i>/moderate</i><a href="Flask.html#190">&#160;route is shown in&#160;Example 13-7.</a></p>
<p style="position:absolute;top:149px;left:108px;white-space:nowrap" class="ft19047"><i>Example 13-7. app/main/views.py: Comment moderation route<br/></i>@main.route('/moderate')<br/>@login_required<br/>@permission_required(Permission.MODERATE_COMMENTS)<br/><b>def</b>&#160;moderate():<br/>&#160; &#160;&#160;page&#160;=&#160;request.args.get('page',&#160;1,&#160;type=int)<br/>&#160; &#160;&#160;pagination&#160;=&#160;Comment.query.order_by(Comment.timestamp.desc()).paginate(<br/>&#160; &#160; &#160; &#160;&#160;page,&#160;per_page=current_app.config['FLASKY_COMMENTS_PER_PAGE'],<br/>&#160; &#160; &#160; &#160;&#160;error_out=False)<br/>&#160; &#160;&#160;comments&#160;=&#160;pagination.items<br/>&#160; &#160;&#160;<b>return</b>&#160;render_template('moderate.html',&#160;comments=comments,<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;pagination=pagination,&#160;page=page)</p>
<p style="position:absolute;top:356px;left:108px;white-space:nowrap" class="ft19014">This is a very simple function that reads a page of comments from the database and</p>
<p style="position:absolute;top:375px;left:108px;white-space:nowrap" class="ft19014">passes them on to a template for rendering. Along with the comments, the template</p>
<p style="position:absolute;top:394px;left:108px;white-space:nowrap" class="ft19015">receives the pagination object and the current page number.<br/>The&#160;<i>moderate.html</i>&#160;templa<a href="Flask.html#190">te, shown in&#160;Example 13-8, is also sim</a>ple because it relies on</p>
<p style="position:absolute;top:441px;left:108px;white-space:nowrap" class="ft19014">the&#160;<i>_comments.html</i>&#160;subtemplate created earlier for the rendering of the comments.</p>
<p style="position:absolute;top:473px;left:108px;white-space:nowrap" class="ft19023"><i>Example 13-8. app/templates/moderate.html: Comment moderation template<br/></i>{% extends &#34;base.html&#34; %}<br/>{% import &#34;_macros.html&#34; as macros %}</p>
<p style="position:absolute;top:546px;left:108px;white-space:nowrap" class="ft1903">{% block title %}Flasky - Comment Moderation{% endblock %}</p>
<p style="position:absolute;top:577px;left:108px;white-space:nowrap" class="ft19023">{% block page_content %}<br/><b>&lt;div</b>&#160;class=&#34;page-header&#34;<b>&gt;<br/></b>&#160; &#160;&#160;<b>&lt;h1&gt;</b>Comment Moderation<b>&lt;/h1&gt;<br/>&lt;/div&gt;<br/></b>{% set moderate = True %}<br/>{% include '_comments.html' %}<br/>{% if pagination %}<br/><b>&lt;div</b>&#160;class=&#34;pagination&#34;<b>&gt;<br/></b>&#160; &#160; {{ macros.pagination_widget(pagination, '.moderate') }}<br/><b>&lt;/div&gt;<br/></b>{% endif %}<br/>{% endblock %}</p>
<p style="position:absolute;top:772px;left:108px;white-space:nowrap" class="ft19014">This template defers the rendering of the comments to the&#160;<i>_comments.html</i>&#160;template,</p>
<p style="position:absolute;top:792px;left:108px;white-space:nowrap" class="ft19014">but before it hands control to the subordinate template it uses Jinja2’s&#160;set&#160;directive to</p>
<p style="position:absolute;top:811px;left:108px;white-space:nowrap" class="ft19014">define a&#160;moderate&#160;template variable set to&#160;True. This variable is used by the&#160;<i>_com‐</i></p>
<p style="position:absolute;top:831px;left:108px;white-space:nowrap" class="ft19010"><i>ments.html</i></p>
<p style="position:absolute;top:830px;left:178px;white-space:nowrap" class="ft19014">&#160;template to determine whether the moderation features need to be rendered.</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1905"><b>170&#160;&#160;|&#160;&#160;Chapter 13: User Comments</b></p>
</div>
<!-- Page 191 -->
<a name="191"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page191-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask191.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft19114">The portion of the&#160;<i>_comments.html</i>&#160;template that renders the body of each comment</p>
<p style="position:absolute;top:98px;left:108px;white-space:nowrap" class="ft19114">needs to be modified in two ways. For regular users (when the&#160;moderate&#160;variable is not</p>
<p style="position:absolute;top:117px;left:108px;white-space:nowrap" class="ft19114">set), any comments that are marked as disabled should be suppressed. For moderators</p>
<p style="position:absolute;top:137px;left:108px;white-space:nowrap" class="ft19114">(when&#160;moderate&#160;is set to&#160;True), the body of the comment must be rendered regardless</p>
<p style="position:absolute;top:156px;left:108px;white-space:nowrap" class="ft19114">of the disabled state, and below the body a button should be included to toggle the state.</p>
<p style="position:absolute;top:175px;left:108px;white-space:nowrap" class="ft19117"><a href="Flask.html#191">Example 13-9&#160;shows these changes.</a></p>
<p style="position:absolute;top:207px;left:108px;white-space:nowrap" class="ft19123"><i>Example 13-9. app/templates/_comments.html: Rendering of the comment bodies<br/></i>...<br/><b>&lt;div</b>&#160;class=&#34;comment-body&#34;<b>&gt;<br/></b>&#160; &#160; {% if comment.disabled %}<br/>&#160; &#160;&#160;<b>&lt;p&gt;&lt;/p&gt;&lt;i&gt;</b>This comment has been disabled by a moderator.<b>&lt;/i&gt;&lt;/p&gt;<br/></b>&#160; &#160; {% endif %}<br/>&#160; &#160; {% if moderate or not comment.disabled %}<br/>&#160; &#160; &#160; &#160; {% if comment.body_html %}<br/>&#160; &#160; &#160; &#160; &#160; &#160; {{ comment.body_html | safe }}<br/>&#160; &#160; &#160; &#160; {% else %}<br/>&#160; &#160; &#160; &#160; &#160; &#160; {{ comment.body }}<br/>&#160; &#160; &#160; &#160; {% endif %}<br/>&#160; &#160; {% endif %}<br/><b>&lt;/div&gt;<br/></b>{% if moderate %}<br/>&#160; &#160;&#160;<b>&lt;br&gt;<br/></b>&#160; &#160; {% if comment.disabled %}<br/>&#160; &#160;&#160;<b>&lt;a</b>&#160;class=&#34;btn btn-default btn-xs&#34;&#160;href=&#34;{{ url_for('.moderate_enable',<br/>&#160; &#160; &#160; &#160; id=comment.id, page=page) }}&#34;<b>&gt;</b>Enable<b>&lt;/a&gt;<br/></b>&#160; &#160; {% else %}<br/>&#160; &#160;&#160;<b>&lt;a</b>&#160;class=&#34;btn btn-danger btn-xs&#34;&#160;href=&#34;{{ url_for('.moderate_disable',<br/>&#160; &#160; &#160; &#160; id=comment.id, page=page) }}&#34;<b>&gt;</b>Disable<b>&lt;/a&gt;<br/></b>&#160; &#160; {% endif %}<br/>{% endif %}<br/>...</p>
<p style="position:absolute;top:613px;left:108px;white-space:nowrap" class="ft19114">With these changes, users will see a short notice for disabled comments. Moderators</p>
<p style="position:absolute;top:632px;left:108px;white-space:nowrap" class="ft19114">will see both the notice and the comment body. Moderators will also see a button to</p>
<p style="position:absolute;top:651px;left:108px;white-space:nowrap" class="ft19114">toggle the disabled state below each comment. The button invokes one of two new</p>
<p style="position:absolute;top:669px;left:108px;white-space:nowrap" class="ft19114">routes, depending on which of the two possible states the comment is changing to.</p>
<p style="position:absolute;top:688px;left:108px;white-space:nowrap" class="ft19117"><a href="Flask.html#191">Example 13-10</a>&#160;shows how these routes are defined.</p>
<p style="position:absolute;top:720px;left:108px;white-space:nowrap" class="ft19147"><i>Example 13-10. app/main/views.py: Comment moderation routes<br/></i>@main.route('/moderate/enable/&lt;int:id&gt;')<br/>@login_required<br/>@permission_required(Permission.MODERATE_COMMENTS)<br/><b>def</b>&#160;moderate_enable(id):<br/>&#160; &#160;&#160;comment&#160;=&#160;Comment.query.get_or_404(id)<br/>&#160; &#160;&#160;comment.disabled&#160;=&#160;False<br/>&#160; &#160;&#160;db.session.add(comment)<br/>&#160; &#160;&#160;<b>return</b>&#160;redirect(url_for('.moderate',<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;page=request.args.get('page',&#160;1,&#160;type=int)))</p>
<p style="position:absolute;top:915px;left:504px;white-space:nowrap" class="ft1915"><b>Comment Moderation&#160;&#160;|&#160;&#160;171</b></p>
</div>
<!-- Page 192 -->
<a name="192"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page192-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask192.png" alt="background image"/>
<p style="position:absolute;top:98px;left:108px;white-space:nowrap" class="ft19247">@main.route('/moderate/disable/&lt;int:id&gt;')<br/>@login_required<br/>@permission_required(Permission.MODERATE_COMMENTS)<br/><b>def</b>&#160;moderate_disable(id):<br/>&#160; &#160;&#160;comment&#160;=&#160;Comment.query.get_or_404(id)<br/>&#160; &#160;&#160;comment.disabled&#160;=&#160;True<br/>&#160; &#160;&#160;db.session.add(comment)<br/>&#160; &#160;&#160;<b>return</b>&#160;redirect(url_for('.moderate',<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;page=request.args.get('page',&#160;1,&#160;type=int)))</p>
<p style="position:absolute;top:247px;left:108px;white-space:nowrap" class="ft19214">The comment enable and disable routes load the comment object, set the&#160;disabled&#160;field</p>
<p style="position:absolute;top:266px;left:108px;white-space:nowrap" class="ft19214">to the proper value, and write it back to the database. At the end, they redirect back to</p>
<p style="position:absolute;top:286px;left:108px;white-space:nowrap" class="ft19214">the comment modera<a href="Flask.html#192">tion page (shown in&#160;Figure 13-3</a>), and if a&#160;page&#160;argument was</p>
<p style="position:absolute;top:305px;left:108px;white-space:nowrap" class="ft19214">given in the query string, they include it in the redirect. The buttons in the&#160;<i>_com‐</i></p>
<p style="position:absolute;top:325px;left:108px;white-space:nowrap" class="ft19210"><i>ments.html</i></p>
<p style="position:absolute;top:324px;left:178px;white-space:nowrap" class="ft19214">&#160;template were rendered with the page argument so that the redirect brings</p>
<p style="position:absolute;top:343px;left:108px;white-space:nowrap" class="ft19214">the user back to the same page.</p>
<p style="position:absolute;top:816px;left:108px;white-space:nowrap" class="ft19210"><i>Figure 13-3. Comment moderation page</i></p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1925"><b>172&#160;&#160;|&#160;&#160;Chapter 13: User Comments</b></p>
</div>
<!-- Page 193 -->
<a name="193"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page193-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask193.png" alt="background image"/>
<p style="position:absolute;top:85px;left:198px;white-space:nowrap" class="ft19325">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:103px;left:198px;white-space:nowrap" class="ft19325">run&#160;git&#160;checkout&#160;13b&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:192px;left:108px;white-space:nowrap" class="ft19314">The topic of social features is completed with this chapter. In the next chapter, you will</p>
<p style="position:absolute;top:211px;left:108px;white-space:nowrap" class="ft19314">learn how to expose the application functionality as an API that clients other than web</p>
<p style="position:absolute;top:229px;left:108px;white-space:nowrap" class="ft19314">browsers can use.</p>
<p style="position:absolute;top:915px;left:504px;white-space:nowrap" class="ft1935"><b>Comment Moderation&#160;&#160;|&#160;&#160;173</b></p>
</div>
<!-- Page 194 -->
<a name="194"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page194-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask194.png" alt="background image"/>
</div>
<!-- Page 195 -->
<a name="195"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page195-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask195.png" alt="background image"/>
<p style="position:absolute;top:104px;left:549px;white-space:nowrap" class="ft19528"><b>CHAPTER 14</b></p>
<p style="position:absolute;top:132px;left:190px;white-space:nowrap" class="ft19511"><b>Application Programming Interfaces&#160;</b></p>
<p style="position:absolute;top:347px;left:108px;white-space:nowrap" class="ft19514">In recent years, there has been a trend in web applications to move more and more of</p>
<p style="position:absolute;top:366px;left:108px;white-space:nowrap" class="ft19514">the business logic to the client side, producing an architecture that is known as Rich</p>
<p style="position:absolute;top:385px;left:108px;white-space:nowrap" class="ft19514">Internet Application (RIA). In RIAs, the server’s main (and sometimes only) function</p>
<p style="position:absolute;top:404px;left:108px;white-space:nowrap" class="ft19514">is to provide the client application with data retrieval and storage services. In this model,</p>
<p style="position:absolute;top:423px;left:108px;white-space:nowrap" class="ft19515">the server becomes a&#160;<i>web service</i>&#160;or&#160;<i>Application Programming Interface (API)</i>.<br/>There are several protocols by which RIAs can communicate with a web service. Remote</p>
<p style="position:absolute;top:470px;left:108px;white-space:nowrap" class="ft19514">Procedure Call (RPC) protocols such as XML-RPC or its derivative Simplified Object</p>
<p style="position:absolute;top:488px;left:108px;white-space:nowrap" class="ft19514">Access Protocol (SOAP) were popular choices a few years ago. More recently, the Rep‐</p>
<p style="position:absolute;top:507px;left:108px;white-space:nowrap" class="ft19514">resentational State Transfer (REST) architecture has emerged as the favorite for web</p>
<p style="position:absolute;top:526px;left:108px;white-space:nowrap" class="ft19515">applications due to it being built on the familiar model of the World Wide Web.<br/>Flask is an ideal framework to build&#160;<i>RESTful</i>&#160;web services due to its lightweight nature.</p>
<p style="position:absolute;top:573px;left:108px;white-space:nowrap" class="ft19514">In this chapter, you will learn how to implement a Flask-based RESTful API.</p>
<p style="position:absolute;top:610px;left:108px;white-space:nowrap" class="ft19522"><b>Introduction to REST&#160;<br/></b>Roy Fielding’<a href="http://bit.ly/REST-fielding">s&#160;Ph.D. dissertation</a>&#160;introduces the REST architectural style for web serv‐</p>
<p style="position:absolute;top:671px;left:108px;white-space:nowrap" class="ft19524">ices by listing its six defining characteristics:<br/><i>Client-Server</i></p>
<p style="position:absolute;top:716px;left:135px;white-space:nowrap" class="ft19514">There must be a clear separation between the clients and the server.</p>
<p style="position:absolute;top:746px;left:108px;white-space:nowrap" class="ft19510"><i>Stateless</i></p>
<p style="position:absolute;top:763px;left:135px;white-space:nowrap" class="ft19514">A client request must contain all the information that is necessary to carry it out.</p>
<p style="position:absolute;top:782px;left:135px;white-space:nowrap" class="ft19514">The server must not store any state about the client that persists from one request</p>
<p style="position:absolute;top:801px;left:135px;white-space:nowrap" class="ft19514">to the next.</p>
<p style="position:absolute;top:915px;left:631px;white-space:nowrap" class="ft1955"><b>175</b></p>
</div>
<!-- Page 196 -->
<a name="196"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page196-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask196.png" alt="background image"/>
<p style="position:absolute;top:80px;left:108px;white-space:nowrap" class="ft19610"><i>Cache</i></p>
<p style="position:absolute;top:98px;left:135px;white-space:nowrap" class="ft19614">Responses from the server can be labeled as cacheable or noncacheable so that</p>
<p style="position:absolute;top:117px;left:135px;white-space:nowrap" class="ft19614">clients (or intermediaries between clients and servers) can use a cache for optimi‐</p>
<p style="position:absolute;top:136px;left:135px;white-space:nowrap" class="ft19614">zation purposes.</p>
<p style="position:absolute;top:166px;left:108px;white-space:nowrap" class="ft19610"><i>Uniform Interface</i></p>
<p style="position:absolute;top:184px;left:135px;white-space:nowrap" class="ft19614">The protocol by which clients access server resources must be consistent, well de‐</p>
<p style="position:absolute;top:203px;left:135px;white-space:nowrap" class="ft19614">fined, and standardized. The commonly used uniform interface of REST web serv‐</p>
<p style="position:absolute;top:222px;left:135px;white-space:nowrap" class="ft19614">ices is the HTTP protocol.</p>
<p style="position:absolute;top:252px;left:108px;white-space:nowrap" class="ft19610"><i>Layered System</i></p>
<p style="position:absolute;top:270px;left:135px;white-space:nowrap" class="ft19614">Proxy servers, caches, or gateways can be inserted between clients and servers as</p>
<p style="position:absolute;top:289px;left:135px;white-space:nowrap" class="ft19614">necessary to improve performance, reliability, and scalability.</p>
<p style="position:absolute;top:319px;left:108px;white-space:nowrap" class="ft19610"><i>Code-on-Demand</i></p>
<p style="position:absolute;top:337px;left:135px;white-space:nowrap" class="ft19614">Clients can optionally download code from the server to execute in their context.</p>
<p style="position:absolute;top:372px;left:108px;white-space:nowrap" class="ft19658"><b>Resources Are Everything<br/></b>The concept of&#160;<i>resources</i>&#160;is core to the REST architectural style. In this context, a re‐</p>
<p style="position:absolute;top:425px;left:108px;white-space:nowrap" class="ft19614">source is an item of interest in the domain of the application. For example, in the blog‐</p>
<p style="position:absolute;top:444px;left:108px;white-space:nowrap" class="ft19615">ging application, users, blog posts, and comments are all resources.<br/>Each resource must have a unique URL that represents it. Continuing with the blogging</p>
<p style="position:absolute;top:490px;left:108px;white-space:nowrap" class="ft19614">example, a blog post could be represented by the URL&#160;<i>/api/posts/12345</i>, where&#160;<i>12345</i>&#160;is</p>
<p style="position:absolute;top:509px;left:108px;white-space:nowrap" class="ft19614">a unique identifier for the post such as the post’s database primary key. The format or</p>
<p style="position:absolute;top:528px;left:108px;white-space:nowrap" class="ft19614">contents of the URL do not really matter; all that matters is that each resource URL</p>
<p style="position:absolute;top:547px;left:108px;white-space:nowrap" class="ft19615">uniquely identifies a resource.<br/>A collection of all the resources in a class also has an assigned URL. The URL for the</p>
<p style="position:absolute;top:594px;left:108px;white-space:nowrap" class="ft19614">collection of blog posts could be&#160;<i>/api/posts/</i>&#160;and the URL for the collection of all com‐</p>
<p style="position:absolute;top:613px;left:108px;white-space:nowrap" class="ft19615">ments could be&#160;<i>/api/comments/</i>.<br/>An API can also define collection URLs that represent logical subsets of all the resources</p>
<p style="position:absolute;top:660px;left:108px;white-space:nowrap" class="ft19614">in a class. For example, the collection of all comments in blog post 12345 could be</p>
<p style="position:absolute;top:679px;left:108px;white-space:nowrap" class="ft19614">represented by the URL&#160;<i>/api/posts/12345/comments/</i>. It is a common practice to define</p>
<p style="position:absolute;top:697px;left:108px;white-space:nowrap" class="ft19614">URLs that represent collections of resources with a trailing slash, as this gives them a</p>
<p style="position:absolute;top:716px;left:108px;white-space:nowrap" class="ft19614">“folder” representation.</p>
<p style="position:absolute;top:758px;left:198px;white-space:nowrap" class="ft19625">Be&#160;aware&#160;that&#160;Flask&#160;applies&#160;special&#160;treatment&#160;to&#160;routes&#160;that&#160;end&#160;with</p>
<p style="position:absolute;top:775px;left:198px;white-space:nowrap" class="ft19625">a&#160;slash.&#160;If&#160;a&#160;client&#160;requests&#160;a&#160;URL&#160;without&#160;a&#160;trailing&#160;slash&#160;and&#160;the&#160;only</p>
<p style="position:absolute;top:793px;left:198px;white-space:nowrap" class="ft19625">matching&#160;route&#160;has&#160;a&#160;slash&#160;at&#160;the&#160;end,&#160;then&#160;Flask&#160;will&#160;automatically</p>
<p style="position:absolute;top:810px;left:198px;white-space:nowrap" class="ft19625">respond&#160;with&#160;a&#160;redirect&#160;to&#160;the&#160;trailing&#160;slash&#160;URL.&#160;No&#160;redirects&#160;are</p>
<p style="position:absolute;top:827px;left:198px;white-space:nowrap" class="ft19625">issued&#160;for&#160;the&#160;reverse&#160;case.</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1965"><b>176&#160;&#160;|&#160;&#160;Chapter 14: Application Programming Interfaces</b></p>
</div>
<!-- Page 197 -->
<a name="197"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft19784{font-size:11px;line-height:16px;font-family:Times;color:#ffffff;}
-->
</style>
<div id="page197-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask197.png" alt="background image"/>
<p style="position:absolute;top:75px;left:108px;white-space:nowrap" class="ft19758"><b>Request Methods<br/></b>The client application sends requests to the server at the established resource URLs and</p>
<p style="position:absolute;top:128px;left:108px;white-space:nowrap" class="ft19714">uses the request&#160;<i>method</i>&#160;to indicate the desired operation. To obtain the list of available</p>
<p style="position:absolute;top:148px;left:108px;white-space:nowrap" class="ft19714">blog posts in the blogging API the client would send a&#160;GET&#160;request to&#160;<i>http://www.exam‐</i></p>
<p style="position:absolute;top:169px;left:108px;white-space:nowrap" class="ft19710"><i>ple.com/api/posts/</i></p>
<p style="position:absolute;top:168px;left:221px;white-space:nowrap" class="ft19714">, and to insert a new blog post it would send a&#160;POST&#160;request to the</p>
<p style="position:absolute;top:187px;left:108px;white-space:nowrap" class="ft19714">same URL, with the contents of the blog post in the request body. To retrieve blog post</p>
<p style="position:absolute;top:206px;left:108px;white-space:nowrap" class="ft19714">12345 the client would send a&#160;GET&#160;request to&#160;<i>http://www.example.com/api/posts/</i></p>
<p style="position:absolute;top:226px;left:108px;white-space:nowrap" class="ft19710"><i>12345</i></p>
<p style="position:absolute;top:225px;left:146px;white-space:nowrap" class="ft19714"><a href="Flask.html#197">.&#160;Table 14-1&#160;lists the request methods tha</a>t are commonly used in RESTful APIs</p>
<p style="position:absolute;top:244px;left:108px;white-space:nowrap" class="ft19748">with their meanings.<br/><i>Table 14-1. HTTP request methods in RESTful APIs</i></p>
<p style="position:absolute;top:301px;left:113px;white-space:nowrap" class="ft19784"><b>Request<br/>method</b></p>
<p style="position:absolute;top:301px;left:194px;white-space:nowrap" class="ft19753"><b>Target</b></p>
<p style="position:absolute;top:301px;left:298px;white-space:nowrap" class="ft19753"><b>Description</b></p>
<p style="position:absolute;top:301px;left:591px;white-space:nowrap" class="ft19784"><b>HTTP<br/>status&#160;code</b></p>
<p style="position:absolute;top:342px;left:113px;white-space:nowrap" class="ft19714">GET</p>
<p style="position:absolute;top:339px;left:194px;white-space:nowrap" class="ft19755">Individual&#160;resource<br/>URL</p>
<p style="position:absolute;top:339px;left:298px;white-space:nowrap" class="ft19730">Obtain&#160;the&#160;resource.</p>
<p style="position:absolute;top:339px;left:591px;white-space:nowrap" class="ft19730">200</p>
<p style="position:absolute;top:379px;left:113px;white-space:nowrap" class="ft19714">GET</p>
<p style="position:absolute;top:377px;left:194px;white-space:nowrap" class="ft19755">Resource&#160;collection<br/>URL</p>
<p style="position:absolute;top:377px;left:298px;white-space:nowrap" class="ft19755">Obtain&#160;the&#160;collection&#160;of&#160;resources&#160;(or&#160;one&#160;page&#160;from&#160;it&#160;if&#160;the&#160;server<br/>implements&#160;pagination).</p>
<p style="position:absolute;top:377px;left:591px;white-space:nowrap" class="ft19730">200</p>
<p style="position:absolute;top:417px;left:113px;white-space:nowrap" class="ft19714">POST</p>
<p style="position:absolute;top:415px;left:194px;white-space:nowrap" class="ft19755">Resource&#160;collection<br/>URL</p>
<p style="position:absolute;top:415px;left:298px;white-space:nowrap" class="ft19755">Create&#160;a&#160;new&#160;resource&#160;and&#160;add&#160;it&#160;to&#160;the&#160;collection.&#160;The&#160;server&#160;chooses<br/>the&#160;URL&#160;of&#160;the&#160;new&#160;resource&#160;and&#160;returns&#160;it&#160;in&#160;a&#160;Location&#160;header<br/>in&#160;the&#160;response.</p>
<p style="position:absolute;top:415px;left:591px;white-space:nowrap" class="ft19730">201</p>
<p style="position:absolute;top:474px;left:113px;white-space:nowrap" class="ft19714">PUT</p>
<p style="position:absolute;top:471px;left:194px;white-space:nowrap" class="ft19755">Individual&#160;resource<br/>URL</p>
<p style="position:absolute;top:471px;left:298px;white-space:nowrap" class="ft19755">Modify&#160;an&#160;existing&#160;resource.&#160;Alternatively&#160;this&#160;method&#160;can&#160;also&#160;be<br/>used&#160;to&#160;create&#160;a&#160;new&#160;resource&#160;when&#160;the&#160;client&#160;can&#160;choose&#160;the&#160;resource<br/>URL.</p>
<p style="position:absolute;top:471px;left:591px;white-space:nowrap" class="ft19730">200</p>
<p style="position:absolute;top:528px;left:113px;white-space:nowrap" class="ft19714">DELETE</p>
<p style="position:absolute;top:525px;left:194px;white-space:nowrap" class="ft19755">Individual&#160;resource<br/>URL</p>
<p style="position:absolute;top:525px;left:298px;white-space:nowrap" class="ft19730">Delete&#160;a&#160;resource.</p>
<p style="position:absolute;top:525px;left:591px;white-space:nowrap" class="ft19730">200</p>
<p style="position:absolute;top:566px;left:113px;white-space:nowrap" class="ft19714">DELETE</p>
<p style="position:absolute;top:563px;left:194px;white-space:nowrap" class="ft19755">Resource&#160;collection<br/>URL</p>
<p style="position:absolute;top:563px;left:298px;white-space:nowrap" class="ft19730">Delete&#160;all&#160;resources&#160;in&#160;the&#160;collection.</p>
<p style="position:absolute;top:563px;left:591px;white-space:nowrap" class="ft19730">200</p>
<p style="position:absolute;top:617px;left:198px;white-space:nowrap" class="ft19725">The&#160;REST&#160;architecture&#160;does&#160;not&#160;require&#160;that&#160;all&#160;methods&#160;be&#160;imple‐</p>
<p style="position:absolute;top:635px;left:198px;white-space:nowrap" class="ft19725">mented&#160;for&#160;a&#160;resource.&#160;If&#160;the&#160;client&#160;invokes&#160;a&#160;method&#160;that&#160;is&#160;not</p>
<p style="position:absolute;top:652px;left:198px;white-space:nowrap" class="ft19725">supported&#160;for&#160;a&#160;given&#160;resource,&#160;then&#160;a&#160;response&#160;with&#160;the&#160;405&#160;status</p>
<p style="position:absolute;top:669px;left:198px;white-space:nowrap" class="ft19725">code&#160;for&#160;“Method&#160;Not&#160;Allowed”&#160;should&#160;be&#160;returned.&#160;Flask&#160;handles</p>
<p style="position:absolute;top:687px;left:198px;white-space:nowrap" class="ft19725">this&#160;error&#160;automatically.</p>
<p style="position:absolute;top:730px;left:108px;white-space:nowrap" class="ft19752"><b>Request and Response Bodies&#160;<br/></b>Resources are sent back and forth between client and server in the bodies of requests</p>
<p style="position:absolute;top:784px;left:108px;white-space:nowrap" class="ft19746">and responses, but REST does not specify the format to use to encode resources. The<br/>Content-Type</p>
<p style="position:absolute;top:803px;left:198px;white-space:nowrap" class="ft19714">&#160;header in requests and responses is used to indicate the format in which</p>
<p style="position:absolute;top:822px;left:108px;white-space:nowrap" class="ft19714">a resource is encoded in the body. The standard content negotiation mechanisms in the</p>
<p style="position:absolute;top:841px;left:108px;white-space:nowrap" class="ft19714">HTTP protocol can be used between client and server to agree on a format that both</p>
<p style="position:absolute;top:860px;left:108px;white-space:nowrap" class="ft19714">support.</p>
<p style="position:absolute;top:915px;left:509px;white-space:nowrap" class="ft1975"><b>Introduction to REST &#160;&#160;|&#160;&#160;177</b></p>
</div>
<!-- Page 198 -->
<a name="198"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page198-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask198.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft19814">The two formats commonly used with RESTful web services are JavaScript Object No‐</p>
<p style="position:absolute;top:97px;left:108px;white-space:nowrap" class="ft19814">tation (JSON) and Extensible Markup Language (XML). For web-based RIAs, JSON is</p>
<p style="position:absolute;top:116px;left:108px;white-space:nowrap" class="ft19814">attractive because of its close ties to JavaScript, the client-side scripting language used</p>
<p style="position:absolute;top:135px;left:108px;white-space:nowrap" class="ft19814">by web browsers. Returning to the blog example API, a blog post resource could be</p>
<p style="position:absolute;top:154px;left:108px;white-space:nowrap" class="ft19814">represented in JSON as follows:</p>
<p style="position:absolute;top:186px;left:133px;white-space:nowrap" class="ft19857">{<br/>&#160; &#160;&#160;&#34;url&#34;:&#160;&#34;http://www.example.com/api/posts/12345&#34;,<br/>&#160; &#160;&#160;&#34;title&#34;:&#160;&#34;Writing RESTful APIs in Python&#34;,<br/>&#160; &#160;&#160;&#34;author&#34;:&#160;&#34;http://www.example.com/api/users/2&#34;,<br/>&#160; &#160;&#160;&#34;body&#34;:&#160;&#34;... text of the article here ...&#34;,<br/>&#160; &#160;&#160;&#34;comments&#34;:&#160;&#34;http://www.example.com/api/posts/12345/comments&#34;<br/>}</p>
<p style="position:absolute;top:299px;left:108px;white-space:nowrap" class="ft19814">Note how the&#160;url,&#160;author, and&#160;comments&#160;fields in the blog post above are fully qualified</p>
<p style="position:absolute;top:318px;left:108px;white-space:nowrap" class="ft19814">resource URLs. This is important because these URLs allow the client to discover new</p>
<p style="position:absolute;top:337px;left:108px;white-space:nowrap" class="ft19815">resources.<br/>In a well-designed RESTful API, the client just knows a short list of top-level resource</p>
<p style="position:absolute;top:384px;left:108px;white-space:nowrap" class="ft19814">URLs and then discovers the rest from links included in responses, similar to how you</p>
<p style="position:absolute;top:402px;left:108px;white-space:nowrap" class="ft19814">can discover new web pages while browsing the Web by clicking on links that appear</p>
<p style="position:absolute;top:421px;left:108px;white-space:nowrap" class="ft19814">in pages that you know.</p>
<p style="position:absolute;top:458px;left:108px;white-space:nowrap" class="ft19852"><b>Versioning&#160;<br/></b>In a traditional server-centric web application, the server has full control of the appli‐</p>
<p style="position:absolute;top:511px;left:108px;white-space:nowrap" class="ft19814">cation. When an application is updated, installing the new version in the server is</p>
<p style="position:absolute;top:530px;left:108px;white-space:nowrap" class="ft19814">enough to update all users because even the parts of the application that run in the user’s</p>
<p style="position:absolute;top:549px;left:108px;white-space:nowrap" class="ft19815">web browser are downloaded from the server.<br/>The situation with RIAs and web services is more complicated, because often clients are</p>
<p style="position:absolute;top:596px;left:108px;white-space:nowrap" class="ft19814">developed independently of the server—maybe even by different people. Consider the</p>
<p style="position:absolute;top:615px;left:108px;white-space:nowrap" class="ft19814">case of an application where the RESTful web service is used by a variety of clients</p>
<p style="position:absolute;top:634px;left:108px;white-space:nowrap" class="ft19814">including web browsers and native smartphone clients. The web browser client can be</p>
<p style="position:absolute;top:653px;left:108px;white-space:nowrap" class="ft19814">updated in the server at any time, but the smartphone apps cannot be updated by force;</p>
<p style="position:absolute;top:672px;left:108px;white-space:nowrap" class="ft19814">the smartphone owner needs to allow the update to happen. Even if the smartphone</p>
<p style="position:absolute;top:691px;left:108px;white-space:nowrap" class="ft19814">owner is willing to update, it is not possible to time the deployment of the updated</p>
<p style="position:absolute;top:709px;left:108px;white-space:nowrap" class="ft19814">smartphone applications to all the app stores to coincide exactly with the deployment</p>
<p style="position:absolute;top:728px;left:108px;white-space:nowrap" class="ft19815">of the new server.<br/>For these reasons, web services need to be more tolerant than regular web applications</p>
<p style="position:absolute;top:775px;left:108px;white-space:nowrap" class="ft19814">and be able to work with old versions of its clients. A common way to address this</p>
<p style="position:absolute;top:794px;left:108px;white-space:nowrap" class="ft19814">problem is to&#160;<i>version</i>&#160;the URLs handled by the web service. For example, the first release</p>
<p style="position:absolute;top:813px;left:108px;white-space:nowrap" class="ft19815">of the blogging web service could expose the collection of blog posts at&#160;<i>/api/v1.0/posts/</i>.<br/>Including the web service version in the URL helps keeps old and new features organized</p>
<p style="position:absolute;top:860px;left:108px;white-space:nowrap" class="ft19814">so that the server can provide new features to new clients while continuing to support</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft1985"><b>178&#160;&#160;|&#160;&#160;Chapter 14: Application Programming Interfaces</b></p>
</div>
<!-- Page 199 -->
<a name="199"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page199-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask199.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft19914">old clients. An update to the blogging service could change the JSON format of blog</p>
<p style="position:absolute;top:97px;left:108px;white-space:nowrap" class="ft19914">posts and now expose blog posts as&#160;<i>/api/v1.1/posts/</i>, while keeping the older JSON for‐</p>
<p style="position:absolute;top:116px;left:108px;white-space:nowrap" class="ft19914">mat for clients that connect to&#160;<i>/api/v1.0/posts/</i>. For a period of time, the server handles</p>
<p style="position:absolute;top:135px;left:108px;white-space:nowrap" class="ft19915">all the URLs in their&#160;<i>v1.1</i>&#160;and&#160;<i>v1.0</i>&#160;variations.<br/>Although supporting multiple versions of the server can become a maintenance burden,</p>
<p style="position:absolute;top:182px;left:108px;white-space:nowrap" class="ft19914">there are situations in which this is the only way to allow the application to grow without</p>
<p style="position:absolute;top:201px;left:108px;white-space:nowrap" class="ft19914">causing problems to existing deployments.</p>
<p style="position:absolute;top:238px;left:108px;white-space:nowrap" class="ft19949"><b>RESTful Web Services with Flask&#160;<br/></b>Flask makes it very easy to create RESTful web services. The familiar&#160;route()&#160;decorator</p>
<p style="position:absolute;top:300px;left:108px;white-space:nowrap" class="ft19914">along with its&#160;methods&#160;optional argument can be used to declare the routes that handle</p>
<p style="position:absolute;top:319px;left:108px;white-space:nowrap" class="ft19914">the resource URLs exposed by the service. Working with JSON data is also simple, as</p>
<p style="position:absolute;top:339px;left:108px;white-space:nowrap" class="ft19914">JSON data included with a request is automatically exposed as a&#160;request.json&#160;Python</p>
<p style="position:absolute;top:358px;left:108px;white-space:nowrap" class="ft19914">dictionary and a response that needs to contain JSON can be easily generated from a</p>
<p style="position:absolute;top:378px;left:108px;white-space:nowrap" class="ft19915">Python dictionary using Flask’s&#160;jsonify()&#160;helper function.<br/>The following sections show how Flasky can be extended with a RESTful web service</p>
<p style="position:absolute;top:425px;left:108px;white-space:nowrap" class="ft19914">that gives clients access to blog posts and related resources.</p>
<p style="position:absolute;top:461px;left:108px;white-space:nowrap" class="ft19952"><b>Creating an API Blueprint&#160;<br/></b>The routes associated with a RESTful API form a self-contained subset of the application,</p>
<p style="position:absolute;top:515px;left:108px;white-space:nowrap" class="ft19914">so putting them in their own blueprint is the best way to keep them well organized. The</p>
<p style="position:absolute;top:534px;left:108px;white-space:nowrap" class="ft19914">general structure of the API blueprint within the applica<a href="Flask.html#199">tion is shown in&#160;Example 14-1</a>.</p>
<p style="position:absolute;top:565px;left:108px;white-space:nowrap" class="ft19923"><i>Example 14-1. API blueprint structure<br/></i>|-flasky<br/>&#160; |-app/<br/>&#160; &#160; |-api_1_0<br/>&#160; &#160; &#160; |-__init__.py<br/>&#160; &#160; &#160; |-user.py<br/>&#160; &#160; &#160; |-post.py<br/>&#160; &#160; &#160; |-comment.py<br/>&#160; &#160; &#160; |-authentication.py<br/>&#160; &#160; &#160; |-errors.py<br/>&#160; &#160; &#160; |-decorators.py</p>
<p style="position:absolute;top:757px;left:108px;white-space:nowrap" class="ft19914">Note how the package used for the API includes a version number in its name. When</p>
<p style="position:absolute;top:776px;left:108px;white-space:nowrap" class="ft19914">a backward-incompatible version of the API needs to be introduced, it can be added as</p>
<p style="position:absolute;top:795px;left:108px;white-space:nowrap" class="ft19914">another package with a different version number and both APIs can be served at the</p>
<p style="position:absolute;top:814px;left:108px;white-space:nowrap" class="ft19914">same time.</p>
<p style="position:absolute;top:915px;left:459px;white-space:nowrap" class="ft1995"><b>RESTful Web Services with Flask &#160;&#160;|&#160;&#160;179</b></p>
</div>
<!-- Page 200 -->
<a name="200"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page200-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask200.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft20014">This API blueprint implements each resource in a separate module. Modules to take</p>
<p style="position:absolute;top:97px;left:108px;white-space:nowrap" class="ft20014">care of authentication, error handling, and to provide custom decorators are also in‐</p>
<p style="position:absolute;top:116px;left:108px;white-space:nowrap" class="ft20014">cluded. The blueprin<a href="Flask.html#200">t constructor is shown in&#160;Example 14-2.</a></p>
<p style="position:absolute;top:148px;left:108px;white-space:nowrap" class="ft20050"><i>Example 14-2. app/api_1_0/__init__.py: API blueprint constructor<br/></i><b>from</b>&#160;<b>flask</b>&#160;<b>import</b>&#160;Blueprint</p>
<p style="position:absolute;top:206px;left:108px;white-space:nowrap" class="ft20037">api&#160;=&#160;Blueprint('api',&#160;__name__)</p>
<p style="position:absolute;top:237px;left:108px;white-space:nowrap" class="ft20038"><b>from</b>&#160;<b>.</b>&#160;<b>import</b>&#160;authentication,&#160;posts,&#160;users,&#160;comments,&#160;errors</p>
<p style="position:absolute;top:264px;left:108px;white-space:nowrap" class="ft20014">The registration of the API blueprint is shown in&#160;<a href="Flask.html#200">Example 14-3</a>.</p>
<p style="position:absolute;top:295px;left:108px;white-space:nowrap" class="ft20047"><i>Example 14-3. app/_init_.py: API blueprint registration<br/></i><b>def</b>&#160;create_app(config_name):<br/>&#160; &#160;&#160;<i># ...<br/></i>&#160; &#160;&#160;<b>from</b>&#160;<b>.api_1_0</b>&#160;<b>import</b>&#160;api&#160;<b>as</b>&#160;api_1_0_blueprint<br/>&#160; &#160;&#160;app.register_blueprint(api_1_0_blueprint,&#160;url_prefix='/api/v1.0')<br/>&#160; &#160;&#160;<i># ...</i></p>
<p style="position:absolute;top:413px;left:108px;white-space:nowrap" class="ft20052"><b>Error Handling&#160;<br/></b>A RESTful web service informs the client of the status of a request by sending the ap‐</p>
<p style="position:absolute;top:467px;left:108px;white-space:nowrap" class="ft20014">propriate HTTP status code in the response plus any additional information in the</p>
<p style="position:absolute;top:486px;left:108px;white-space:nowrap" class="ft20014">response body. The typical status codes that a client can expect to see from a web service</p>
<p style="position:absolute;top:505px;left:108px;white-space:nowrap" class="ft20048">are listed in&#160;<a href="Flask.html#200">Table 14-2.<br/></a><i>Table 14-2. HTTP response status codes typically returned by APIs</i></p>
<p style="position:absolute;top:562px;left:113px;white-space:nowrap" class="ft20084"><b>HTTP&#160;status<br/>code</b></p>
<p style="position:absolute;top:562px;left:198px;white-space:nowrap" class="ft20053"><b>Name</b></p>
<p style="position:absolute;top:562px;left:294px;white-space:nowrap" class="ft20053"><b>Description</b></p>
<p style="position:absolute;top:600px;left:113px;white-space:nowrap" class="ft20030">200</p>
<p style="position:absolute;top:600px;left:198px;white-space:nowrap" class="ft20030">OK</p>
<p style="position:absolute;top:600px;left:294px;white-space:nowrap" class="ft20030">The&#160;request&#160;was&#160;completed&#160;successfully.</p>
<p style="position:absolute;top:621px;left:113px;white-space:nowrap" class="ft20030">201</p>
<p style="position:absolute;top:621px;left:198px;white-space:nowrap" class="ft20030">Created</p>
<p style="position:absolute;top:621px;left:294px;white-space:nowrap" class="ft20030">The&#160;request&#160;was&#160;completed&#160;successfully&#160;and&#160;a&#160;new&#160;resource&#160;was&#160;created&#160;as&#160;a&#160;result.</p>
<p style="position:absolute;top:643px;left:113px;white-space:nowrap" class="ft20030">400</p>
<p style="position:absolute;top:643px;left:198px;white-space:nowrap" class="ft20030">Bad&#160;request</p>
<p style="position:absolute;top:643px;left:294px;white-space:nowrap" class="ft20030">The&#160;request&#160;is&#160;invalid&#160;or&#160;inconsistent.</p>
<p style="position:absolute;top:664px;left:113px;white-space:nowrap" class="ft20030">401</p>
<p style="position:absolute;top:664px;left:198px;white-space:nowrap" class="ft20030">Unauthorized</p>
<p style="position:absolute;top:664px;left:294px;white-space:nowrap" class="ft20030">The&#160;request&#160;does&#160;not&#160;include&#160;authentication&#160;information.</p>
<p style="position:absolute;top:686px;left:113px;white-space:nowrap" class="ft20030">403</p>
<p style="position:absolute;top:686px;left:198px;white-space:nowrap" class="ft20030">Forbidden</p>
<p style="position:absolute;top:686px;left:294px;white-space:nowrap" class="ft20030">The&#160;authentication&#160;credentials&#160;sent&#160;with&#160;the&#160;request&#160;are&#160;insufficient&#160;for&#160;the&#160;request.</p>
<p style="position:absolute;top:708px;left:113px;white-space:nowrap" class="ft20030">404</p>
<p style="position:absolute;top:708px;left:198px;white-space:nowrap" class="ft20030">Not&#160;found</p>
<p style="position:absolute;top:708px;left:294px;white-space:nowrap" class="ft20030">The&#160;resource&#160;referenced&#160;in&#160;the&#160;URL&#160;was&#160;not&#160;found.</p>
<p style="position:absolute;top:729px;left:113px;white-space:nowrap" class="ft20030">405</p>
<p style="position:absolute;top:729px;left:198px;white-space:nowrap" class="ft20030">Method&#160;not&#160;allowed&#160;The&#160;request&#160;method&#160;requested&#160;is&#160;not&#160;supported&#160;for&#160;the&#160;given&#160;resource.</p>
<p style="position:absolute;top:751px;left:113px;white-space:nowrap" class="ft20030">500</p>
<p style="position:absolute;top:751px;left:198px;white-space:nowrap" class="ft20030">Internal&#160;server&#160;error&#160;An&#160;unexpected&#160;error&#160;has&#160;occurred&#160;while&#160;processing&#160;the&#160;request.</p>
<p style="position:absolute;top:784px;left:108px;white-space:nowrap" class="ft20014">The handling of status codes 404 and 500 presents a small complication, in that these</p>
<p style="position:absolute;top:803px;left:108px;white-space:nowrap" class="ft20014">errors are generated by Flask on its own and will usually return an HTML response,</p>
<p style="position:absolute;top:821px;left:108px;white-space:nowrap" class="ft20014">which is likely to confuse an API client.</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft2005"><b>180&#160;&#160;|&#160;&#160;Chapter 14: Application Programming Interfaces</b></p>
</div>
<!-- Page 201 -->
<a name="201"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page201-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask201.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft20114">One way to generate appropriate responses for all clients is to make the error handlers</p>
<p style="position:absolute;top:97px;left:108px;white-space:nowrap" class="ft20114">adapt their responses based on the format requested by the client, a technique called</p>
<p style="position:absolute;top:117px;left:108px;white-space:nowrap" class="ft20110"><i>content negotiation</i></p>
<p style="position:absolute;top:116px;left:228px;white-space:nowrap" class="ft20114"><a href="Flask.html#201">.&#160;Example 14-4</a>&#160;shows an improved 404 error handler that responds</p>
<p style="position:absolute;top:135px;left:108px;white-space:nowrap" class="ft20114">with JSON to web service clients and with HTML to others. The 500 error handler is</p>
<p style="position:absolute;top:154px;left:108px;white-space:nowrap" class="ft20114">written in a similar way.</p>
<p style="position:absolute;top:186px;left:108px;white-space:nowrap" class="ft20140"><i>Example 14-4. app/main/errors.py: Error handlers with HTTP content negotiation<br/></i>@main.app_errorhandler(404)<br/><b>def</b>&#160;page_not_found(e):<br/>&#160; &#160;&#160;<b>if</b>&#160;request.accept_mimetypes.accept_json&#160;<b>and</b>&#160;\<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>not</b>&#160;request.accept_mimetypes.accept_html:<br/>&#160; &#160; &#160; &#160;&#160;response&#160;=&#160;jsonify({'error':&#160;'not found'})<br/>&#160; &#160; &#160; &#160;&#160;response.status_code&#160;=&#160;404<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;response<br/>&#160; &#160;&#160;<b>return</b>&#160;render_template('404.html'),&#160;404</p>
<p style="position:absolute;top:348px;left:108px;white-space:nowrap" class="ft20114">This new version of the error handler checks the&#160;Accept&#160;request header, which Werk‐</p>
<p style="position:absolute;top:368px;left:108px;white-space:nowrap" class="ft20114">zeug decodes into&#160;request.accept_mimetypes, to determine what format the client</p>
<p style="position:absolute;top:387px;left:108px;white-space:nowrap" class="ft20114">wants the response in. Browsers generally do not specify any restrictions on response</p>
<p style="position:absolute;top:406px;left:108px;white-space:nowrap" class="ft20114">formats, so the JSON response is generated only for clients that accept JSON and do not</p>
<p style="position:absolute;top:425px;left:108px;white-space:nowrap" class="ft20115">accept HTML.<br/>The remaining status codes are generated explicitly by the web service, so they can be</p>
<p style="position:absolute;top:471px;left:108px;white-space:nowrap" class="ft20114">implemented as helper functions inside the blueprint in the&#160;<i>errors.py</i>&#160;module.</p>
<p style="position:absolute;top:490px;left:108px;white-space:nowrap" class="ft20117"><a href="Flask.html#201">Example 14-5&#160;shows the im</a>plementation of the 403 error; the others are similar.</p>
<p style="position:absolute;top:522px;left:108px;white-space:nowrap" class="ft20176"><i>Example 14-5. app/api/errors.py: API error handler for status code 403<br/></i><b>def</b>&#160;forbidden(message):<br/>&#160; &#160;&#160;response&#160;=&#160;jsonify({'error':&#160;'forbidden',&#160;'message':&#160;message})<br/>&#160; &#160;&#160;response.status_code&#160;=&#160;403<br/>&#160; &#160;&#160;<b>return</b>&#160;response</p>
<p style="position:absolute;top:622px;left:108px;white-space:nowrap" class="ft20114">Now view functions in the web service can invoke these auxiliary functions to generate</p>
<p style="position:absolute;top:641px;left:108px;white-space:nowrap" class="ft20114">error responses.</p>
<p style="position:absolute;top:678px;left:108px;white-space:nowrap" class="ft20152"><b>User Authentication with Flask-HTTPAuth&#160;<br/></b>Web services, like regular web applications, need to protect information and ensure that</p>
<p style="position:absolute;top:731px;left:108px;white-space:nowrap" class="ft20114">it is not given to unauthorized parties. For this reason, RIAs must ask their users for</p>
<p style="position:absolute;top:750px;left:108px;white-space:nowrap" class="ft20115">login credentials and pass them to the server for verification.<br/>It was mentioned earlier that one of the characteristics of RESTful web services is that</p>
<p style="position:absolute;top:797px;left:108px;white-space:nowrap" class="ft20114">they are&#160;<i>stateless</i>, which means that the server is not allowed to “remember” anything</p>
<p style="position:absolute;top:816px;left:108px;white-space:nowrap" class="ft20114">about the client between requests. Clients need to provide all the information necessary</p>
<p style="position:absolute;top:835px;left:108px;white-space:nowrap" class="ft20114">to carry out a request in the request itself, so all requests must include user credentials.</p>
<p style="position:absolute;top:915px;left:459px;white-space:nowrap" class="ft2015"><b>RESTful Web Services with Flask &#160;&#160;|&#160;&#160;181</b></p>
</div>
<!-- Page 202 -->
<a name="202"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page202-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask202.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft20214">The current login functionality implemented with the help of Flask-Login stores data</p>
<p style="position:absolute;top:97px;left:108px;white-space:nowrap" class="ft20214">in the user session, which Flask stores by default in a client-side cookie, so the server</p>
<p style="position:absolute;top:116px;left:108px;white-space:nowrap" class="ft20214">does not store any user-related information; it asks the client to store it instead. It would</p>
<p style="position:absolute;top:135px;left:108px;white-space:nowrap" class="ft20214">appear that this implementation complies with the stateless requirement of REST, but</p>
<p style="position:absolute;top:154px;left:108px;white-space:nowrap" class="ft20214">the use of cookies in RESTful web services falls into a gray area, as it can be cumbersome</p>
<p style="position:absolute;top:173px;left:108px;white-space:nowrap" class="ft20214">for clients that are not web browsers to implement them. For that reason, it is generally</p>
<p style="position:absolute;top:192px;left:108px;white-space:nowrap" class="ft20214">seen as a bad design choice to use them.</p>
<p style="position:absolute;top:231px;left:198px;white-space:nowrap" class="ft20225">The&#160;stateless&#160;requirement&#160;of&#160;REST&#160;may&#160;seem&#160;overly&#160;strict,&#160;but&#160;it&#160;is</p>
<p style="position:absolute;top:248px;left:198px;white-space:nowrap" class="ft20225">not&#160;arbitrary.&#160;Stateless&#160;servers&#160;can&#160;<i>scale</i>&#160;very&#160;easily.&#160;When&#160;servers&#160;store</p>
<p style="position:absolute;top:266px;left:198px;white-space:nowrap" class="ft20225">information&#160;about&#160;clients,&#160;it&#160;is&#160;necessary&#160;to&#160;have&#160;a&#160;shared&#160;cache&#160;ac‐</p>
<p style="position:absolute;top:283px;left:198px;white-space:nowrap" class="ft20225">cessible&#160;to&#160;all&#160;servers&#160;to&#160;ensure&#160;that&#160;the&#160;same&#160;server&#160;always&#160;gets&#160;re‐</p>
<p style="position:absolute;top:300px;left:198px;white-space:nowrap" class="ft20225">quests&#160;from&#160;a&#160;given&#160;client.&#160;Both&#160;are&#160;complex&#160;problems&#160;to&#160;solve.</p>
<p style="position:absolute;top:346px;left:108px;white-space:nowrap" class="ft20214">Because the RESTful architecture is based on the HTTP protocol,&#160;<i>HTTP authentica‐</i></p>
<p style="position:absolute;top:366px;left:108px;white-space:nowrap" class="ft20210"><i>tion</i></p>
<p style="position:absolute;top:365px;left:133px;white-space:nowrap" class="ft20214">&#160;is the preferred method used to send credentials, either in its Basic or Digest flavors.</p>
<p style="position:absolute;top:385px;left:108px;white-space:nowrap" class="ft20214">With HTTP authentication, user credentials are included in an&#160;Authorization&#160;header</p>
<p style="position:absolute;top:404px;left:108px;white-space:nowrap" class="ft20215">with all requests.<br/>The HTTP authentication protocol is simple enough that it can be implemented directly,</p>
<p style="position:absolute;top:450px;left:108px;white-space:nowrap" class="ft20214">but the Flask-HTTPAuth extension provides a convenient wrapper that hides the pro‐</p>
<p style="position:absolute;top:470px;left:108px;white-space:nowrap" class="ft20215">tocol details in a decorator similar to Flask-Login’s&#160;login_required.<br/>Flask-HTTPAuth is installed with pip:</p>
<p style="position:absolute;top:530px;left:133px;white-space:nowrap" class="ft20233">(venv)&#160;$&#160;pip install flask-httpauth</p>
<p style="position:absolute;top:550px;left:108px;white-space:nowrap" class="ft20246">To initialize the extension for HTTP Basic authentication, an object of class<br/>HTTPBasicAuth</p>
<p style="position:absolute;top:570px;left:205px;white-space:nowrap" class="ft20214">&#160;must be created. Like Flask-Login, Flask-HTTPAuth makes no as‐</p>
<p style="position:absolute;top:589px;left:108px;white-space:nowrap" class="ft20214">sumptions about the procedure required to verify user credentials, so this information</p>
<p style="position:absolute;top:608px;left:108px;white-space:nowrap" class="ft20214">is given in a callback function.&#160;<a href="Flask.html#202">Example 14-6</a>&#160;shows how the extension is initialized and</p>
<p style="position:absolute;top:627px;left:108px;white-space:nowrap" class="ft20214">provided with a verification callback.</p>
<p style="position:absolute;top:659px;left:108px;white-space:nowrap" class="ft20240"><i>Example 14-6. app/api_1_0/authentication.py: Flask-HTTPAuth initialization<br/></i><b>from</b>&#160;<b>flask.ext.httpauth</b>&#160;<b>import</b>&#160;HTTPBasicAuth<br/>auth&#160;=&#160;HTTPBasicAuth()</p>
<p style="position:absolute;top:732px;left:108px;white-space:nowrap" class="ft20240">@auth.verify_password<br/><b>def</b>&#160;verify_password(email,&#160;password):<br/>&#160; &#160;&#160;<b>if</b>&#160;email&#160;==&#160;'':<br/>&#160; &#160; &#160; &#160;&#160;g.current_user&#160;=&#160;AnonymousUser()<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;True<br/>&#160; &#160;&#160;user&#160;=&#160;User.query.filter_by(email&#160;=&#160;email).first()<br/>&#160; &#160;&#160;<b>if</b>&#160;<b>not</b>&#160;user:<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;False<br/>&#160; &#160;&#160;g.current_user&#160;=&#160;user<br/>&#160; &#160;&#160;<b>return</b>&#160;user.verify_password(password)</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft2025"><b>182&#160;&#160;|&#160;&#160;Chapter 14: Application Programming Interfaces</b></p>
</div>
<!-- Page 203 -->
<a name="203"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page203-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask203.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft20314">Because this type of user authentication will be used only in the API blueprint, the Flask-</p>
<p style="position:absolute;top:97px;left:108px;white-space:nowrap" class="ft20314">HTTPAuth extension is initialized in the blueprint package, and not in the application</p>
<p style="position:absolute;top:116px;left:108px;white-space:nowrap" class="ft20348">package like other extensions.<br/>The email and password are verified using the existing support in the&#160;User&#160;model. The</p>
<p style="position:absolute;top:165px;left:108px;white-space:nowrap" class="ft20314">verification callback returns&#160;True&#160;when the login is valid or&#160;False&#160;otherwise. Anony‐</p>
<p style="position:absolute;top:184px;left:108px;white-space:nowrap" class="ft20348">mous logins are supported, for which the client must send a blank email field.<br/>The authentication callback saves the authenticated user in Flask’s&#160;g&#160;global object so that</p>
<p style="position:absolute;top:232px;left:108px;white-space:nowrap" class="ft20314">the view function can access it later. Note that when an anonymous login is received,</p>
<p style="position:absolute;top:251px;left:108px;white-space:nowrap" class="ft20314">the function returns&#160;True&#160;and saves an instance of the&#160;AnonymousUser&#160;class used with</p>
<p style="position:absolute;top:271px;left:108px;white-space:nowrap" class="ft20314">Flask-Login into&#160;g.current_user.</p>
<p style="position:absolute;top:311px;left:204px;white-space:nowrap" class="ft20325">Because&#160;user&#160;credentials&#160;are&#160;being&#160;exchanged&#160;with&#160;every&#160;request,&#160;it</p>
<p style="position:absolute;top:328px;left:204px;white-space:nowrap" class="ft20325">is&#160;extremely&#160;important&#160;that&#160;the&#160;API&#160;routes&#160;are&#160;exposed&#160;over&#160;secure</p>
<p style="position:absolute;top:345px;left:204px;white-space:nowrap" class="ft20325">HTTP&#160;so&#160;that&#160;all&#160;requests&#160;and&#160;responses&#160;are&#160;encrypted.</p>
<p style="position:absolute;top:411px;left:108px;white-space:nowrap" class="ft20314">When the authentication credentials are invalid, the server returns a 401 error to the</p>
<p style="position:absolute;top:430px;left:108px;white-space:nowrap" class="ft20314">client. Flask-HTTPAuth generates a response with this status code by default, but to</p>
<p style="position:absolute;top:449px;left:108px;white-space:nowrap" class="ft20314">ensure that the response is consistent with other errors returned by the API, the error</p>
<p style="position:absolute;top:468px;left:108px;white-space:nowrap" class="ft20314"><a href="Flask.html#203">response can be customized as shown in&#160;Example 14-7.</a></p>
<p style="position:absolute;top:500px;left:108px;white-space:nowrap" class="ft20347"><i>Example 14-7. _app/api_1_0/authentication.py: Flask-HTTPAuth error handler<br/></i>@auth.error_handler<br/><b>def</b>&#160;auth_error():<br/>&#160; &#160;&#160;<b>return</b>&#160;unauthorized('Invalid credentials')</p>
<p style="position:absolute;top:586px;left:108px;white-space:nowrap" class="ft20314">To protect a route, the&#160;auth.login_required&#160;decorator is used:</p>
<p style="position:absolute;top:617px;left:133px;white-space:nowrap" class="ft20347">@api.route('/posts/')<br/>@auth.login_required<br/><b>def</b>&#160;get_posts():<br/>&#160; &#160;&#160;<b>pass</b></p>
<p style="position:absolute;top:684px;left:108px;white-space:nowrap" class="ft20346">But since all the routes in the blueprint need to be protected in the same way, the<br/>login_required</p>
<p style="position:absolute;top:704px;left:213px;white-space:nowrap" class="ft20314">&#160;decorator can be included once in a&#160;before_request&#160;handler for the</p>
<p style="position:absolute;top:722px;left:108px;white-space:nowrap" class="ft20314">blueprint, as shown in&#160;<a href="Flask.html#203">Example 14-8</a>.</p>
<p style="position:absolute;top:754px;left:108px;white-space:nowrap" class="ft20350"><i>Example 14-8.&#160;app/api_1_0/authentication.py: before_request handler with authenti‐<br/>cation<br/></i><b>from</b>&#160;<b>.errors</b>&#160;<b>import</b>&#160;forbidden_error</p>
<p style="position:absolute;top:832px;left:108px;white-space:nowrap" class="ft20377">@api.before_request<br/>@auth.login_required<br/><b>def</b>&#160;before_request():</p>
<p style="position:absolute;top:915px;left:459px;white-space:nowrap" class="ft2035"><b>RESTful Web Services with Flask &#160;&#160;|&#160;&#160;183</b></p>
</div>
<!-- Page 204 -->
<a name="204"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page204-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask204.png" alt="background image"/>
<p style="position:absolute;top:82px;left:108px;white-space:nowrap" class="ft20447">&#160; &#160;&#160;<b>if</b>&#160;<b>not</b>&#160;g.current_user.is_anonymous&#160;<b>and</b>&#160;\<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>not</b>&#160;g.current_user.confirmed:<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;forbidden('Unconfirmed account')</p>
<p style="position:absolute;top:139px;left:108px;white-space:nowrap" class="ft20414">Now the authentication checks will be done automatically for all the routes in the blue‐</p>
<p style="position:absolute;top:159px;left:108px;white-space:nowrap" class="ft20414">print. As an additional check, the&#160;before_request&#160;handler also rejects authenticated</p>
<p style="position:absolute;top:178px;left:108px;white-space:nowrap" class="ft20414">users who have not confirmed their accounts.</p>
<p style="position:absolute;top:214px;left:108px;white-space:nowrap" class="ft20452"><b>Token-Based Authentication&#160;<br/></b>Clients must send authentication credentials with every request. To avoid having to</p>
<p style="position:absolute;top:268px;left:108px;white-space:nowrap" class="ft20414">constantly transfer sensitive information, a token-based authentication solution can be</p>
<p style="position:absolute;top:287px;left:108px;white-space:nowrap" class="ft20415">offered.<br/>In token-based authentication, the client sends the login credentials to a special URL</p>
<p style="position:absolute;top:334px;left:108px;white-space:nowrap" class="ft20414">that generates authentication tokens. Once the client has a token it can use it in place</p>
<p style="position:absolute;top:353px;left:108px;white-space:nowrap" class="ft20414">of the login credentials to authenticate requests. For security reasons, tokens are issued</p>
<p style="position:absolute;top:372px;left:108px;white-space:nowrap" class="ft20414">with an associated expiration. When a token expires, the client must reauthenticate to</p>
<p style="position:absolute;top:391px;left:108px;white-space:nowrap" class="ft20414">get a new one. The risk of a token getting in the wrong hands is limited due to its short</p>
<p style="position:absolute;top:410px;left:108px;white-space:nowrap" class="ft20414"><a href="Flask.html#204">lifespan.&#160;Example 14-9&#160;</a>shows the two new methods added to the&#160;User&#160;model that sup‐</p>
<p style="position:absolute;top:429px;left:108px;white-space:nowrap" class="ft20414">port generation and verification of authentication tokens using itsdangerous.</p>
<p style="position:absolute;top:461px;left:108px;white-space:nowrap" class="ft20447"><i>Example 14-9. app/models.py: Token-based authentication support<br/></i><b>class</b>&#160;<b>User</b>(db.Model):<br/>&#160; &#160;&#160;<i># ...<br/></i>&#160; &#160;&#160;<b>def</b>&#160;generate_auth_token(self,&#160;expiration):<br/>&#160; &#160; &#160; &#160;&#160;s&#160;=&#160;Serializer(current_app.config['SECRET_KEY'],<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;expires_in=expiration)<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;s.dumps({'id':&#160;self.id})</p>
<p style="position:absolute;top:596px;left:108px;white-space:nowrap" class="ft20463">&#160; &#160;&#160;@staticmethod<br/>&#160; &#160;&#160;<b>def</b>&#160;verify_auth_token(token):<br/>&#160; &#160; &#160; &#160;&#160;s&#160;=&#160;Serializer(current_app.config['SECRET_KEY'])<br/>&#160; &#160; &#160; &#160;&#160;<b>try</b>:<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;data&#160;=&#160;s.loads(token)<br/>&#160; &#160; &#160; &#160;&#160;<b>except</b>:<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;None<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;User.query.get(data['id'])</p>
<p style="position:absolute;top:731px;left:108px;white-space:nowrap" class="ft20414">The&#160;generate_auth_token()&#160;method returns a signed token that encodes the user’s&#160;id</p>
<p style="position:absolute;top:750px;left:108px;white-space:nowrap" class="ft20414">field. An expiration time given in seconds is also used. The&#160;verify_auth_token()</p>
<p style="position:absolute;top:769px;left:108px;white-space:nowrap" class="ft20414">method takes a token and, if found valid, it returns the user stored in it. This is a static</p>
<p style="position:absolute;top:788px;left:108px;white-space:nowrap" class="ft20448">method, as the user will be known only after the token is decoded.<br/>To authenticate requests that come with a token, the&#160;verify_password&#160;callback for</p>
<p style="position:absolute;top:836px;left:108px;white-space:nowrap" class="ft20414">Flask-HTTPAuth must be modified to accept tokens as well as regular credentials. The</p>
<p style="position:absolute;top:855px;left:108px;white-space:nowrap" class="ft20414">updated callback is shown in&#160;<a href="Flask.html#204">Example 14-10.</a></p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft2045"><b>184&#160;&#160;|&#160;&#160;Chapter 14: Application Programming Interfaces</b></p>
</div>
<!-- Page 205 -->
<a name="205"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page205-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask205.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft20563"><i>Example 14-10.&#160;app/api_1_0/authentication.py: Improved authentication verification<br/>with token support<br/></i>@auth.verify_password<br/><b>def</b>&#160;verify_password(email_or_token,&#160;password):<br/>&#160; &#160;&#160;<b>if</b>&#160;email_or_token&#160;==&#160;'':<br/>&#160; &#160; &#160; &#160;&#160;g.current_user&#160;=&#160;AnonymousUser()<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;True<br/>&#160; &#160;&#160;<b>if</b>&#160;password&#160;==&#160;'':<br/>&#160; &#160; &#160; &#160;&#160;g.current_user&#160;=&#160;User.verify_auth_token(email_or_token)<br/>&#160; &#160; &#160; &#160;&#160;g.token_used&#160;=&#160;True<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;g.current_user&#160;<b>is</b>&#160;<b>not</b>&#160;None<br/>&#160; &#160;&#160;user&#160;=&#160;User.query.filter_by(email=email_or_token).first()<br/>&#160; &#160;&#160;<b>if</b>&#160;<b>not</b>&#160;user:<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;False<br/>&#160; &#160;&#160;g.current_user&#160;=&#160;user<br/>&#160; &#160;&#160;g.token_used&#160;=&#160;False<br/>&#160; &#160;&#160;<b>return</b>&#160;user.verify_password(password)</p>
<p style="position:absolute;top:367px;left:108px;white-space:nowrap" class="ft20514">In this new version, the first authentication argument can be the email address or an</p>
<p style="position:absolute;top:386px;left:108px;white-space:nowrap" class="ft20514">authentication token. If this field is blank, an anonymous user is assumed, as before. If</p>
<p style="position:absolute;top:405px;left:108px;white-space:nowrap" class="ft20514">the password is blank, then the&#160;email_or_token&#160;field is assumed to be a token and</p>
<p style="position:absolute;top:424px;left:108px;white-space:nowrap" class="ft20514">validated as such. If both fields are nonempty then regular email and password authen‐</p>
<p style="position:absolute;top:443px;left:108px;white-space:nowrap" class="ft20514">tication is assumed. With this implementation, token-based authentication is optional;</p>
<p style="position:absolute;top:462px;left:108px;white-space:nowrap" class="ft20514">it is up to each client to use it or not. To give view functions the ability to distinguish</p>
<p style="position:absolute;top:482px;left:108px;white-space:nowrap" class="ft20515">between the two authentication methods a&#160;g.token_used&#160;variable is added.<br/>The route that returns authentication tokens to the client is also added to the API blue‐</p>
<p style="position:absolute;top:529px;left:108px;white-space:nowrap" class="ft20514">print. The implementation is shown in&#160;<a href="Flask.html#205">Example 14-11.</a></p>
<p style="position:absolute;top:561px;left:108px;white-space:nowrap" class="ft20547"><i>Example 14-11. app/api_1_0/authentication.py: Authentication token generation<br/></i>@api.route('/token')<br/><b>def</b>&#160;get_token():<br/>&#160; &#160;&#160;<b>if</b>&#160;g.current_user.is_anonymous()&#160;<b>or</b>&#160;g.token_used:<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;unauthorized('Invalid credentials')<br/>&#160; &#160;&#160;<b>return</b>&#160;jsonify({'token':&#160;g.current_user.generate_auth_token(<br/>&#160; &#160; &#160; &#160;&#160;expiration=3600),&#160;'expiration':&#160;3600})</p>
<p style="position:absolute;top:691px;left:108px;white-space:nowrap" class="ft20546">Since this route is in the blueprint, the authentication mechanisms added to the<br/>before_request</p>
<p style="position:absolute;top:711px;left:213px;white-space:nowrap" class="ft20514">&#160;handler also apply to it. To prevent clients from using an old token to</p>
<p style="position:absolute;top:731px;left:108px;white-space:nowrap" class="ft20514">request a new one, the&#160;g.token_used&#160;variable is checked, and in that way requests</p>
<p style="position:absolute;top:750px;left:108px;white-space:nowrap" class="ft20514">authenticated with a token can be rejected. The function returns a token in the JSON</p>
<p style="position:absolute;top:769px;left:108px;white-space:nowrap" class="ft20514">response with a validity period of one hour. The period is also included in the JSON</p>
<p style="position:absolute;top:788px;left:108px;white-space:nowrap" class="ft20514">response.</p>
<p style="position:absolute;top:915px;left:459px;white-space:nowrap" class="ft2055"><b>RESTful Web Services with Flask &#160;&#160;|&#160;&#160;185</b></p>
</div>
<!-- Page 206 -->
<a name="206"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page206-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask206.png" alt="background image"/>
<p style="position:absolute;top:76px;left:108px;white-space:nowrap" class="ft20652"><b>Serializing Resources to and from JSON&#160;<br/></b>A frequent need when writing a web service is to convert internal representation of</p>
<p style="position:absolute;top:130px;left:108px;white-space:nowrap" class="ft20614">resources to and from JSON, which is the transport format used in HTTP requests and</p>
<p style="position:absolute;top:150px;left:108px;white-space:nowrap" class="ft20614">responses.&#160;<a href="Flask.html#206">Example 14-12&#160;shows a new&#160;</a>to_json()&#160;method added to the&#160;Post&#160;class.</p>
<p style="position:absolute;top:182px;left:108px;white-space:nowrap" class="ft20647"><i>Example 14-12. app/models.py: Convert a post to a JSON serializable dictionary<br/></i><b>class</b>&#160;<b>Post</b>(db.Model):<br/>&#160; &#160;&#160;<i># ...<br/></i>&#160; &#160;&#160;<b>def</b>&#160;to_json(self):<br/>&#160; &#160; &#160; &#160;&#160;json_post&#160;=&#160;{<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;'url':&#160;url_for('api.get_post',&#160;id=self.id,&#160;_external=True),<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;'body':&#160;self.body,<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;'body_html':&#160;self.body_html,<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;'timestamp':&#160;self.timestamp,<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;'author':&#160;url_for('api.get_user',&#160;id=self.author_id,<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;_external=True),<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;'comments':&#160;url_for('api.get_post_comments',&#160;id=self.id,<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;_external=True)<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;'comment_count':&#160;self.comments.count()<br/>&#160; &#160; &#160; &#160;&#160;}<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;json_post</p>
<p style="position:absolute;top:451px;left:108px;white-space:nowrap" class="ft20614">The&#160;url,&#160;author, and&#160;comments&#160;fields need to return the URLs for the respective re‐</p>
<p style="position:absolute;top:471px;left:108px;white-space:nowrap" class="ft20614">sources, so these are generated with&#160;url_for()&#160;calls to routes that will be defined in the</p>
<p style="position:absolute;top:491px;left:108px;white-space:nowrap" class="ft20614">API blueprint. Note that&#160;_external=True&#160;is added to all&#160;url_for()&#160;calls so that fully</p>
<p style="position:absolute;top:510px;left:108px;white-space:nowrap" class="ft20614">qualified URLs are returned instead of the relative URLs that are typically used within</p>
<p style="position:absolute;top:529px;left:108px;white-space:nowrap" class="ft20615">the context of a traditional web application.<br/>This example also shows how it is possible to return “made-up” attributes in the rep‐</p>
<p style="position:absolute;top:576px;left:108px;white-space:nowrap" class="ft20614">resentation of a resource. The&#160;comment_count&#160;field returns the number of comments</p>
<p style="position:absolute;top:595px;left:108px;white-space:nowrap" class="ft20614">that exist for the blog post. Although this is not a real attribute of the model, it is included</p>
<p style="position:absolute;top:614px;left:108px;white-space:nowrap" class="ft20648">in the resource representation as a convenience to the client.<br/>The&#160;to_json()&#160;method for&#160;User&#160;models can be constructed in a similar way to&#160;Post.</p>
<p style="position:absolute;top:662px;left:108px;white-space:nowrap" class="ft20614">This method is shown in&#160;<a href="Flask.html#206">Example 14-13.</a></p>
<p style="position:absolute;top:694px;left:108px;white-space:nowrap" class="ft20647"><i>Example 14-13. app/models.py: Convert a user to a JSON serializable dictionary<br/></i><b>class</b>&#160;<b>User</b>(UserMixin,&#160;db.Model):<br/>&#160; &#160;&#160;<i># ...<br/></i>&#160; &#160;&#160;<b>def</b>&#160;to_json(self):<br/>&#160; &#160; &#160; &#160;&#160;json_user&#160;=&#160;{<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;'url':&#160;url_for('api.get_post',&#160;id=self.id,&#160;_external=True),<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;'username':&#160;self.username,<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;'member_since':&#160;self.member_since,<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;'last_seen':&#160;self.last_seen,<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;'posts':&#160;url_for('api.get_user_posts',&#160;id=self.id,&#160;_external=True),<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;'followed_posts':&#160;url_for('api.get_user_followed_posts',<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;id=self.id,&#160;_external=True),</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft2065"><b>186&#160;&#160;|&#160;&#160;Chapter 14: Application Programming Interfaces</b></p>
</div>
<!-- Page 207 -->
<a name="207"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page207-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask207.png" alt="background image"/>
<p style="position:absolute;top:82px;left:108px;white-space:nowrap" class="ft20747">&#160; &#160; &#160; &#160; &#160; &#160;&#160;'post_count':&#160;self.posts.count()<br/>&#160; &#160; &#160; &#160;&#160;}<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;json_user</p>
<p style="position:absolute;top:140px;left:108px;white-space:nowrap" class="ft20714">Note how in this method some of the attributes of the user, such as&#160;email&#160;and&#160;role, are</p>
<p style="position:absolute;top:159px;left:108px;white-space:nowrap" class="ft20714">omitted from the response for privacy reasons. This example again demonstrates that</p>
<p style="position:absolute;top:178px;left:108px;white-space:nowrap" class="ft20714">the representation of a resource offered to clients does not need to be identical to the</p>
<p style="position:absolute;top:197px;left:108px;white-space:nowrap" class="ft20715">internal representation of the corresponding database model.<br/>Converting a JSON structure to a model presents the challenge that some of the data</p>
<p style="position:absolute;top:244px;left:108px;white-space:nowrap" class="ft20714">coming from the client might be invalid, wrong, or unnecessary.&#160;<a href="Flask.html#207">Example 14-14&#160;</a>shows</p>
<p style="position:absolute;top:264px;left:108px;white-space:nowrap" class="ft20714">the method that creates a&#160;Post&#160;model from JSON.</p>
<p style="position:absolute;top:295px;left:108px;white-space:nowrap" class="ft20750"><i>Example 14-14. app/models.py: Create a blog post from JSON<br/></i><b>from</b>&#160;<b>app.exceptions</b>&#160;<b>import</b>&#160;ValidationError</p>
<p style="position:absolute;top:354px;left:108px;white-space:nowrap" class="ft20747"><b>class</b>&#160;<b>Post</b>(db.Model):<br/>&#160; &#160;&#160;<i># ...<br/></i>&#160; &#160;&#160;@staticmethod<br/>&#160; &#160;&#160;<b>def</b>&#160;from_json(json_post):<br/>&#160; &#160; &#160; &#160;&#160;body&#160;=&#160;json_post.get('body')<br/>&#160; &#160; &#160; &#160;&#160;<b>if</b>&#160;body&#160;<b>is</b>&#160;None&#160;<b>or</b>&#160;body&#160;==&#160;'':<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>raise</b>&#160;ValidationError('post does not have a body')<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;Post(body=body)</p>
<p style="position:absolute;top:488px;left:108px;white-space:nowrap" class="ft20714">As you can see, this implementation chooses to only use the&#160;body&#160;attribute from the</p>
<p style="position:absolute;top:508px;left:108px;white-space:nowrap" class="ft20714">JSON dictionary. The&#160;body_html&#160;attribute is ignored since the server-side Markdown</p>
<p style="position:absolute;top:528px;left:108px;white-space:nowrap" class="ft20714">rendering is automatically triggered by a SQLAlchemy event whenever the&#160;body&#160;at‐</p>
<p style="position:absolute;top:548px;left:108px;white-space:nowrap" class="ft20714">tribute is modified. The&#160;timestamp&#160;attribute does not need to be given, unless the client</p>
<p style="position:absolute;top:568px;left:108px;white-space:nowrap" class="ft20714">is allowed to backdate posts, which is not a feature of this application. The&#160;author&#160;field</p>
<p style="position:absolute;top:587px;left:108px;white-space:nowrap" class="ft20714">is not used because the client has no authority to select the author of a blog post; the</p>
<p style="position:absolute;top:606px;left:108px;white-space:nowrap" class="ft20714">only possible value for the&#160;author&#160;field is that of the authenticated user. The&#160;comments</p>
<p style="position:absolute;top:626px;left:108px;white-space:nowrap" class="ft20714">and&#160;comment_count&#160;attributes are automatically generated from a database relationship,</p>
<p style="position:absolute;top:645px;left:108px;white-space:nowrap" class="ft20746">so there is no useful information in them that is needed to create a model. Finally, the<br/>url</p>
<p style="position:absolute;top:665px;left:131px;white-space:nowrap" class="ft20714">&#160;field is ignored because in this implementation the resource URLs are defined by</p>
<p style="position:absolute;top:684px;left:108px;white-space:nowrap" class="ft20746">the server, not the client.<br/>Note how error checking is done. If the&#160;body&#160;field is missing or empty then a<br/>ValidationError</p>
<p style="position:absolute;top:732px;left:220px;white-space:nowrap" class="ft20714">&#160;exception is raised. Throwing an exception is in this case the appro‐</p>
<p style="position:absolute;top:751px;left:108px;white-space:nowrap" class="ft20714">priate way to deal with the error because this method does not have enough knowledge</p>
<p style="position:absolute;top:770px;left:108px;white-space:nowrap" class="ft20714">to properly handle the condition. The exception effectively passes the error up to the</p>
<p style="position:absolute;top:790px;left:108px;white-space:nowrap" class="ft20714">caller, enabling higher level code to do the error handling. The&#160;ValidationError&#160;class</p>
<p style="position:absolute;top:810px;left:108px;white-space:nowrap" class="ft20714">is implemented as a simple subclass of Python’s&#160;ValueError. This implementation is</p>
<p style="position:absolute;top:829px;left:108px;white-space:nowrap" class="ft20714">shown in&#160;<a href="Flask.html#207">Example 14-15.</a></p>
<p style="position:absolute;top:915px;left:459px;white-space:nowrap" class="ft2075"><b>RESTful Web Services with Flask &#160;&#160;|&#160;&#160;187</b></p>
</div>
<!-- Page 208 -->
<a name="208"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page208-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask208.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft20847"><i>Example 14-15. app/exceptions.py: ValidationError exception<br/></i><b>class</b>&#160;<b>ValidationError</b>(<b>ValueError</b>):<br/>&#160; &#160;&#160;<b>pass</b></p>
<p style="position:absolute;top:149px;left:108px;white-space:nowrap" class="ft20814">The application now needs to handle this exception by providing the appropriate re‐</p>
<p style="position:absolute;top:168px;left:108px;white-space:nowrap" class="ft20814">sponse to the client. To avoid having to add exception catching code in view functions,</p>
<p style="position:absolute;top:188px;left:108px;white-space:nowrap" class="ft20814">a global exception handler can be installed. A handler for the&#160;ValidationError&#160;excep‐</p>
<p style="position:absolute;top:207px;left:108px;white-space:nowrap" class="ft20814"><a href="Flask.html#208">tion is shown in&#160;Example 14-16.</a></p>
<p style="position:absolute;top:238px;left:108px;white-space:nowrap" class="ft20810"><i>Example 14-16.&#160;app/api_1_0/errors.py: API error handler for ValidationError excep‐</i></p>
<p style="position:absolute;top:257px;left:108px;white-space:nowrap" class="ft20847"><i>tions<br/></i>@api.errorhandler(ValidationError)<br/><b>def</b>&#160;validation_error(e):<br/>&#160; &#160;&#160;<b>return</b>&#160;bad_request(e.args[0])</p>
<p style="position:absolute;top:343px;left:108px;white-space:nowrap" class="ft20814">The&#160;errorhandler&#160;decorator is the same one that is used to register handlers for HTTP</p>
<p style="position:absolute;top:363px;left:108px;white-space:nowrap" class="ft20814">status codes, but in this usage it takes an&#160;Exception&#160;class as argument. The decorated</p>
<p style="position:absolute;top:382px;left:108px;white-space:nowrap" class="ft20814">function will be invoked any time an exception of the given class is raised. Note that the</p>
<p style="position:absolute;top:401px;left:108px;white-space:nowrap" class="ft20814">decorator is obtained from the API blueprint, so this handler will be invoked only when</p>
<p style="position:absolute;top:420px;left:108px;white-space:nowrap" class="ft20815">the exception is raised while a route from the blueprint is being processed.<br/>Using this technique, the code in view functions can be written very cleanly and con‐</p>
<p style="position:absolute;top:466px;left:108px;white-space:nowrap" class="ft20814">cisely, without the need to include error checking. For example:</p>
<p style="position:absolute;top:498px;left:133px;white-space:nowrap" class="ft20847">@api.route('/posts/',&#160;methods=['POST'])<br/><b>def</b>&#160;new_post():<br/>&#160; &#160;&#160;post&#160;=&#160;Post.from_json(request.json)<br/>&#160; &#160;&#160;post.author&#160;=&#160;g.current_user<br/>&#160; &#160;&#160;db.session.add(post)<br/>&#160; &#160;&#160;db.session.commit()<br/>&#160; &#160;&#160;<b>return</b>&#160;jsonify(post.to_json())</p>
<p style="position:absolute;top:619px;left:108px;white-space:nowrap" class="ft20865"><b>Implementing Resource Endpoints&#160;<br/></b>What remains is to implement the routes that handle the different resources. The&#160;GET</p>
<p style="position:absolute;top:674px;left:108px;white-space:nowrap" class="ft20814">requests are typically the easiest because they just return information and don’t need to</p>
<p style="position:absolute;top:693px;left:108px;white-space:nowrap" class="ft20814">make an<a href="Flask.html#208">y changes.&#160;Example 14-17&#160;shows the two&#160;</a>GET&#160;handlers for blog posts.</p>
<p style="position:absolute;top:725px;left:108px;white-space:nowrap" class="ft20847"><i>Example 14-17. app/api_1_0/posts.py: GET resource handlers for posts<br/></i>@api.route('/posts/')<br/>@auth.login_required<br/><b>def</b>&#160;get_posts():<br/>&#160; &#160;&#160;posts&#160;=&#160;Post.query.all()<br/>&#160; &#160;&#160;<b>return</b>&#160;jsonify({&#160;'posts':&#160;[post.to_json()&#160;<b>for</b>&#160;post&#160;<b>in</b>&#160;posts]&#160;})</p>
<p style="position:absolute;top:845px;left:108px;white-space:nowrap" class="ft20847">@api.route('/posts/&lt;int:id&gt;')<br/>@auth.login_required</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft2085"><b>188&#160;&#160;|&#160;&#160;Chapter 14: Application Programming Interfaces</b></p>
</div>
<!-- Page 209 -->
<a name="209"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page209-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask209.png" alt="background image"/>
<p style="position:absolute;top:82px;left:108px;white-space:nowrap" class="ft20947"><b>def</b>&#160;get_post(id):<br/>&#160; &#160;&#160;post&#160;=&#160;Post.query.get_or_404(id)<br/>&#160; &#160;&#160;<b>return</b>&#160;jsonify(post.to_json())</p>
<p style="position:absolute;top:139px;left:108px;white-space:nowrap" class="ft20914">The first route handles the request of the collection of posts. This function uses a list</p>
<p style="position:absolute;top:158px;left:108px;white-space:nowrap" class="ft20914">comprehension to generate the JSON version of all the posts. The second route returns</p>
<p style="position:absolute;top:178px;left:108px;white-space:nowrap" class="ft20914">a single blog post and responds with a code 404 error when the given&#160;id&#160;is not found</p>
<p style="position:absolute;top:197px;left:108px;white-space:nowrap" class="ft20914">in the database.</p>
<p style="position:absolute;top:236px;left:198px;white-space:nowrap" class="ft20925">The&#160;handler&#160;for&#160;404&#160;errors&#160;is&#160;at&#160;the&#160;application&#160;level,&#160;but&#160;it&#160;will&#160;pro‐</p>
<p style="position:absolute;top:254px;left:198px;white-space:nowrap" class="ft20925">vide&#160;a&#160;JSON&#160;response&#160;if&#160;the&#160;client&#160;requests&#160;that&#160;format.&#160;If&#160;a&#160;response</p>
<p style="position:absolute;top:271px;left:198px;white-space:nowrap" class="ft20925">customized&#160;to&#160;the&#160;web&#160;service&#160;is&#160;desired,&#160;the&#160;404&#160;error&#160;handler&#160;can</p>
<p style="position:absolute;top:288px;left:198px;white-space:nowrap" class="ft20925">be&#160;overridden&#160;in&#160;the&#160;blueprint.</p>
<p style="position:absolute;top:342px;left:108px;white-space:nowrap" class="ft20914">The&#160;POST&#160;handler for blog post resources inserts a new blog post in the database. This</p>
<p style="position:absolute;top:361px;left:108px;white-space:nowrap" class="ft20914">route is shown in&#160;<a href="Flask.html#209">Example 14-18.</a></p>
<p style="position:absolute;top:393px;left:108px;white-space:nowrap" class="ft20923"><i>Example 14-18. app/api_1_0/posts.py: POST resource handler for posts<br/></i>@api.route('/posts/',&#160;methods=['POST'])<br/>@permission_required(Permission.WRITE_ARTICLES)<br/><b>def</b>&#160;new_post():<br/>&#160; &#160;&#160;post&#160;=&#160;Post.from_json(request.json)<br/>&#160; &#160;&#160;post.author&#160;=&#160;g.current_user<br/>&#160; &#160;&#160;db.session.add(post)<br/>&#160; &#160;&#160;db.session.commit()<br/>&#160; &#160;&#160;<b>return</b>&#160;jsonify(post.to_json()),&#160;201,&#160;\<br/>&#160; &#160; &#160; &#160; &#160; &#160;{'Location':&#160;url_for('api.get_post',&#160;id=post.id,&#160;_external=True)}</p>
<p style="position:absolute;top:570px;left:108px;white-space:nowrap" class="ft20914">This view function is wrapped in a&#160;permission_required&#160;decorator (shown in an up‐</p>
<p style="position:absolute;top:589px;left:108px;white-space:nowrap" class="ft20914">coming example) that ensures that the authenticated user has the permission to write</p>
<p style="position:absolute;top:608px;left:108px;white-space:nowrap" class="ft20914">blog posts. The actual creation of the blog post is straightforward due to the error han‐</p>
<p style="position:absolute;top:627px;left:108px;white-space:nowrap" class="ft20914">dling support that was implemented previously. A blog post is created from the JSON</p>
<p style="position:absolute;top:646px;left:108px;white-space:nowrap" class="ft20914">data and its author is explicitly assigned as the authenticated user. After the model is</p>
<p style="position:absolute;top:666px;left:108px;white-space:nowrap" class="ft20914">written to the database, a 201 status code is returned and a&#160;Location&#160;header is added</p>
<p style="position:absolute;top:685px;left:108px;white-space:nowrap" class="ft20915">with the URL of the newly created resource.<br/>Note that for convenience to the client, the body of the response includes the new re‐</p>
<p style="position:absolute;top:732px;left:108px;white-space:nowrap" class="ft20914">source. This will save the client from having to issue a&#160;GET&#160;resource for it immediately</p>
<p style="position:absolute;top:751px;left:108px;white-space:nowrap" class="ft20948">after creating the resource.<br/>The&#160;permission_required&#160;decorator used to prevent unauthorized users from creating</p>
<p style="position:absolute;top:799px;left:108px;white-space:nowrap" class="ft20914">new blog posts is similar to the one used in the application but is customized for the</p>
<p style="position:absolute;top:818px;left:108px;white-space:nowrap" class="ft20914">API blueprint. The implementa<a href="Flask.html#209">tion is shown in&#160;Example 14-19.</a></p>
<p style="position:absolute;top:915px;left:459px;white-space:nowrap" class="ft2095"><b>RESTful Web Services with Flask &#160;&#160;|&#160;&#160;189</b></p>
</div>
<!-- Page 210 -->
<a name="210"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page210-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask210.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft21040"><i>Example 14-19. app/api_1_0/decorators.py: permission_required decorator<br/></i><b>def</b>&#160;permission_required(permission):<br/>&#160; &#160;&#160;<b>def</b>&#160;decorator(f):<br/>&#160; &#160; &#160; &#160;&#160;@wraps(f)<br/>&#160; &#160; &#160; &#160;&#160;<b>def</b>&#160;decorated_function(*args,&#160;**kwargs):<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>if</b>&#160;<b>not</b>&#160;g.current_user.can(permission):<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;forbidden('Insufficient permissions')<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;f(*args,&#160;**kwargs)<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;decorated_function<br/>&#160; &#160;&#160;<b>return</b>&#160;decorator</p>
<p style="position:absolute;top:257px;left:108px;white-space:nowrap" class="ft21014">The&#160;PUT&#160;handler for blog posts, used for editing existing resources, is shown in</p>
<p style="position:absolute;top:276px;left:108px;white-space:nowrap" class="ft21017"><a href="Flask.html#210">Example 14-20</a>.</p>
<p style="position:absolute;top:308px;left:108px;white-space:nowrap" class="ft21047"><i>Example 14-20. app/api_1_0/posts.py: PUT resource handler for posts<br/></i>@api.route('/posts/&lt;int:id&gt;',&#160;methods=['PUT'])<br/>@permission_required(Permission.WRITE_ARTICLES)<br/><b>def</b>&#160;edit_post(id):<br/>&#160; &#160;&#160;post&#160;=&#160;Post.query.get_or_404(id)<br/>&#160; &#160;&#160;<b>if</b>&#160;g.current_user&#160;!=&#160;post.author&#160;<b>and</b>&#160;\<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>not</b>&#160;g.current_user.can(Permission.ADMINISTER):<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;forbidden('Insufficient permissions')<br/>&#160; &#160;&#160;post.body&#160;=&#160;request.json.get('body',&#160;post.body)<br/>&#160; &#160;&#160;db.session.add(post)<br/>&#160; &#160;&#160;<b>return</b>&#160;jsonify(post.to_json())</p>
<p style="position:absolute;top:500px;left:108px;white-space:nowrap" class="ft21014">The permission checks are more complex in this case. The standard check for permis‐</p>
<p style="position:absolute;top:519px;left:108px;white-space:nowrap" class="ft21014">sion to write blog posts is done with the decorator, but to allow a user to edit a blog post</p>
<p style="position:absolute;top:537px;left:108px;white-space:nowrap" class="ft21014">the function must also ensure that the user is the author of the post or else is an ad‐</p>
<p style="position:absolute;top:556px;left:108px;white-space:nowrap" class="ft21014">ministrator. This check is added explicitly to the view function. If this check had to be</p>
<p style="position:absolute;top:575px;left:108px;white-space:nowrap" class="ft21014">added in many view functions, building a decorator for it would be a good way to avoid</p>
<p style="position:absolute;top:594px;left:108px;white-space:nowrap" class="ft21048">code repetition.<br/>Since the application does not allow deletion of posts, the handler for the&#160;DELETE&#160;request</p>
<p style="position:absolute;top:642px;left:108px;white-space:nowrap" class="ft21015">method does not need to be implemented.<br/>The resource handlers for users and comments are implemented in a similar way.</p>
<p style="position:absolute;top:689px;left:108px;white-space:nowrap" class="ft21017"><a href="Flask.html#210">Table 14-3</a>&#160;lists the set of resources implemented for this application. The complete</p>
<p style="position:absolute;top:708px;left:108px;white-space:nowrap" class="ft21048">implementation is available for you to study in the&#160;<a href="http://bit.ly/flasky-git">GitHub repository.<br/></a><i>Table 14-3. Flasky API resources</i></p>
<p style="position:absolute;top:764px;left:113px;white-space:nowrap" class="ft21053"><b>Resource&#160;URL</b></p>
<p style="position:absolute;top:764px;left:239px;white-space:nowrap" class="ft21053"><b>Methods</b></p>
<p style="position:absolute;top:764px;left:308px;white-space:nowrap" class="ft21053"><b>Description</b></p>
<p style="position:absolute;top:786px;left:113px;white-space:nowrap" class="ft21073"><i>/users/&lt;int:id&gt;</i></p>
<p style="position:absolute;top:789px;left:239px;white-space:nowrap" class="ft21014">GET</p>
<p style="position:absolute;top:786px;left:308px;white-space:nowrap" class="ft21030">A&#160;user</p>
<p style="position:absolute;top:810px;left:113px;white-space:nowrap" class="ft21073"><i>/users/&lt;int:id&gt;/posts/</i></p>
<p style="position:absolute;top:813px;left:239px;white-space:nowrap" class="ft21014">GET</p>
<p style="position:absolute;top:810px;left:308px;white-space:nowrap" class="ft21030">The&#160;blog&#160;posts&#160;written&#160;by&#160;a&#160;user</p>
<p style="position:absolute;top:834px;left:113px;white-space:nowrap" class="ft21073"><i>/users/&lt;int:id&gt;/timeline/</i></p>
<p style="position:absolute;top:837px;left:239px;white-space:nowrap" class="ft21014">GET</p>
<p style="position:absolute;top:834px;left:308px;white-space:nowrap" class="ft21030">The&#160;blog&#160;posts&#160;followed&#160;by&#160;a&#160;user</p>
<p style="position:absolute;top:858px;left:113px;white-space:nowrap" class="ft21073"><i>/posts/</i></p>
<p style="position:absolute;top:861px;left:239px;white-space:nowrap" class="ft21014">GET</p>
<p style="position:absolute;top:861px;left:262px;white-space:nowrap" class="ft21030">,&#160;POST&#160;All&#160;the&#160;blog&#160;posts</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft2105"><b>190&#160;&#160;|&#160;&#160;Chapter 14: Application Programming Interfaces</b></p>
</div>
<!-- Page 211 -->
<a name="211"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft21185{font-size:11px;line-height:24px;font-family:Times;color:#231f20;}
-->
</style>
<div id="page211-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask211.png" alt="background image"/>
<p style="position:absolute;top:82px;left:113px;white-space:nowrap" class="ft21153"><b>Resource&#160;URL</b></p>
<p style="position:absolute;top:82px;left:239px;white-space:nowrap" class="ft21153"><b>Methods</b></p>
<p style="position:absolute;top:82px;left:308px;white-space:nowrap" class="ft21153"><b>Description</b></p>
<p style="position:absolute;top:104px;left:113px;white-space:nowrap" class="ft21173"><i>/posts/&lt;int:id&gt;</i></p>
<p style="position:absolute;top:107px;left:239px;white-space:nowrap" class="ft21114">GET</p>
<p style="position:absolute;top:107px;left:262px;white-space:nowrap" class="ft21130">,&#160;PUT</p>
<p style="position:absolute;top:104px;left:308px;white-space:nowrap" class="ft21130">A&#160;blog&#160;post</p>
<p style="position:absolute;top:128px;left:113px;white-space:nowrap" class="ft21185"><i>/posts/&lt;int:id/&gt;comments/&#160;</i>GET,&#160;POST&#160;The&#160;comments&#160;on&#160;a&#160;blog&#160;post<br/><i>/comments/</i></p>
<p style="position:absolute;top:155px;left:239px;white-space:nowrap" class="ft21114">GET</p>
<p style="position:absolute;top:152px;left:308px;white-space:nowrap" class="ft21130">All&#160;the&#160;comments</p>
<p style="position:absolute;top:176px;left:113px;white-space:nowrap" class="ft21173"><i>/comments/&lt;int:id&gt;</i></p>
<p style="position:absolute;top:179px;left:239px;white-space:nowrap" class="ft21114">GET</p>
<p style="position:absolute;top:176px;left:308px;white-space:nowrap" class="ft21130">A&#160;comment</p>
<p style="position:absolute;top:212px;left:108px;white-space:nowrap" class="ft21114">Note that the resources that were implemented enable a client to offer a subset of the</p>
<p style="position:absolute;top:231px;left:108px;white-space:nowrap" class="ft21114">functionality that is available through the web application. The list of supported re‐</p>
<p style="position:absolute;top:250px;left:108px;white-space:nowrap" class="ft21114">sources could be expanded if necessary, such as to expose followers, to enable comment</p>
<p style="position:absolute;top:268px;left:108px;white-space:nowrap" class="ft21114">moderation, and to implement any other features that a client might need.</p>
<p style="position:absolute;top:305px;left:108px;white-space:nowrap" class="ft21165"><b>Pagination of Large Resource Collections&#160;<br/></b>The&#160;GET&#160;requests that return a collection of resources can be extremely expensive and</p>
<p style="position:absolute;top:359px;left:108px;white-space:nowrap" class="ft21114">difficult to manage for very large collections. Like web applications, web services can</p>
<p style="position:absolute;top:378px;left:108px;white-space:nowrap" class="ft21115">choose to paginate collections.<br/><a href="Flask.html#211">Example 14-21&#160;shows a possible im</a>plementation of pagination for the list of blog posts.</p>
<p style="position:absolute;top:438px;left:108px;white-space:nowrap" class="ft21140"><i>Example 14-21. app/api_1_0/posts.py: Post pagination<br/></i>@api.route('/posts/')<br/><b>def</b>&#160;get_posts():<br/>&#160; &#160;&#160;page&#160;=&#160;request.args.get('page',&#160;1,&#160;type=int)<br/>&#160; &#160;&#160;pagination&#160;=&#160;Post.query.paginate(<br/>&#160; &#160; &#160; &#160;&#160;page,&#160;per_page=current_app.config['FLASKY_POSTS_PER_PAGE'],<br/>&#160; &#160; &#160; &#160;&#160;error_out=False)<br/>&#160; &#160;&#160;posts&#160;=&#160;pagination.items<br/>&#160; &#160;&#160;prev&#160;=&#160;None<br/>&#160; &#160;&#160;<b>if</b>&#160;pagination.has_prev:<br/>&#160; &#160; &#160; &#160;&#160;prev&#160;=&#160;url_for('api.get_posts',&#160;page=page-1,&#160;_external=True)<br/>&#160; &#160;&#160;next&#160;=&#160;None<br/>&#160; &#160;&#160;<b>if</b>&#160;pagination.has_next:<br/>&#160; &#160; &#160; &#160;&#160;next&#160;=&#160;url_for('api.get_posts',&#160;page=page+1,&#160;_external=True)<br/>&#160; &#160;&#160;<b>return</b>&#160;jsonify({<br/>&#160; &#160; &#160; &#160;&#160;'posts':&#160;[post.to_json()&#160;<b>for</b>&#160;post&#160;<b>in</b>&#160;posts],<br/>&#160; &#160; &#160; &#160;&#160;'prev':&#160;prev,<br/>&#160; &#160; &#160; &#160;&#160;'next':&#160;next,<br/>&#160; &#160; &#160; &#160;&#160;'count':&#160;pagination.total<br/>&#160; &#160;&#160;})</p>
<p style="position:absolute;top:769px;left:108px;white-space:nowrap" class="ft21114">The&#160;posts&#160;field in the JSON response contains the data items as before, but now it is</p>
<p style="position:absolute;top:788px;left:108px;white-space:nowrap" class="ft21114">just a portion of the complete set. The&#160;prev&#160;and&#160;next&#160;items contain the resource URLs</p>
<p style="position:absolute;top:808px;left:108px;white-space:nowrap" class="ft21114">for the previous and following pages, when available. The&#160;count&#160;value is the total number</p>
<p style="position:absolute;top:827px;left:108px;white-space:nowrap" class="ft21115">of items in the collection.<br/>This technique can be applied to all the routes that return collections.</p>
<p style="position:absolute;top:915px;left:459px;white-space:nowrap" class="ft2115"><b>RESTful Web Services with Flask &#160;&#160;|&#160;&#160;191</b></p>
</div>
<!-- Page 212 -->
<a name="212"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft21286{font-size:10px;font-family:Times;color:#cc3300;}
	.ft21287{font-size:10px;line-height:15px;font-family:Times;color:#cc3300;}
-->
</style>
<div id="page212-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask212.png" alt="background image"/>
<p style="position:absolute;top:85px;left:198px;white-space:nowrap" class="ft21225">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:103px;left:198px;white-space:nowrap" class="ft21225">run&#160;git&#160;checkout&#160;14a&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:122px;left:198px;white-space:nowrap" class="ft21280">To&#160;ensure&#160;that&#160;you&#160;have&#160;all&#160;the&#160;dependencies&#160;installed,&#160;also&#160;run&#160;pip<br/>install&#160;-r&#160;requirements/dev.txt</p>
<p style="position:absolute;top:140px;left:410px;white-space:nowrap" class="ft21225">.</p>
<p style="position:absolute;top:189px;left:108px;white-space:nowrap" class="ft21252"><b>Testing Web Services with HTTPie&#160;<br/></b>To test a web service, an HTTP client must be used. The two most used clients for testing</p>
<p style="position:absolute;top:243px;left:108px;white-space:nowrap" class="ft21214">web services from the command line are&#160;<i>curl</i>&#160;and&#160;<i>HTTPie</i>. The latter has a much more</p>
<p style="position:absolute;top:262px;left:108px;white-space:nowrap" class="ft21214">concise and readable command line. HTTPie is installed with pip:</p>
<p style="position:absolute;top:294px;left:134px;white-space:nowrap" class="ft21233">(venv)&#160;$&#160;pip install httpie</p>
<p style="position:absolute;top:315px;left:108px;white-space:nowrap" class="ft21214">A&#160;GET&#160;request can be issued as follows:</p>
<p style="position:absolute;top:347px;left:133px;white-space:nowrap" class="ft21223">(venv)&#160;$&#160;http --json --auth &lt;email&gt;:&lt;password&gt; GET&#160;<b>\<br/></b>&gt; http://127.0.0.1:5000/api/v1.0/posts<br/>HTTP/1.0 200 OK<br/>Content-Length: 7018<br/>Content-Type: application/json<br/>Date: Sun, 22 Dec 2013 08:11:24 GMT<br/>Server: Werkzeug/0.9.4 Python/2.7.3</p>
<p style="position:absolute;top:469px;left:133px;white-space:nowrap" class="ft21223">{<br/>&#160; &#160;&#160;&#34;posts&#34;:&#160;[<br/>&#160; &#160; &#160; &#160; ...<br/>&#160; &#160;&#160;],<br/>&#160; &#160;&#160;&#34;prev&#34;: null<br/>&#160; &#160;&#160;&#34;next&#34;:&#160;&#34;http://127.0.0.1:5000/api/v1.0/posts/?page=2&#34;,<br/>&#160; &#160;&#160;&#34;count&#34;: 150<br/>}</p>
<p style="position:absolute;top:597px;left:108px;white-space:nowrap" class="ft21214">Note the pagination links included in the response. Since this is the first page, a previous</p>
<p style="position:absolute;top:616px;left:108px;white-space:nowrap" class="ft21215">page is not defined, but a URL to obtain the next page and a total count were returned.<br/>The same request can be issued by an anonymous user by sending an empty email and</p>
<p style="position:absolute;top:663px;left:108px;white-space:nowrap" class="ft21214">password:</p>
<p style="position:absolute;top:694px;left:133px;white-space:nowrap" class="ft21233">(venv)&#160;$&#160;http --json --auth : GET http://127.0.0.1:5000/api/v1.0/posts/</p>
<p style="position:absolute;top:716px;left:108px;white-space:nowrap" class="ft21214">The following command sends a&#160;POST&#160;request to add a new blog post:</p>
<p style="position:absolute;top:747px;left:133px;white-space:nowrap" class="ft21223">(venv)&#160;$&#160;http --auth &lt;email&gt;:&lt;password&gt; --json POST&#160;<b>\<br/></b>&gt; http://127.0.0.1:5000/api/v1.0/posts/&#160;<b>\<br/></b>&gt;&#160;&#34;body=I'm adding a post from the *command line*.&#34;<br/>HTTP/1.0 201 CREATED<br/>Content-Length: 360<br/>Content-Type: application/json<br/>Date: Sun, 22 Dec 2013 08:30:27 GMT<br/>Location: http://127.0.0.1:5000/api/v1.0/posts/111<br/>Server: Werkzeug/0.9.4 Python/2.7.3</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft2125"><b>192&#160;&#160;|&#160;&#160;Chapter 14: Application Programming Interfaces</b></p>
</div>
<!-- Page 213 -->
<a name="213"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page213-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask213.png" alt="background image"/>
<p style="position:absolute;top:98px;left:134px;white-space:nowrap" class="ft21357">{<br/>&#160; &#160;&#160;&#34;author&#34;:&#160;&#34;http://127.0.0.1:5000/api/v1.0/users/1&#34;,<br/>&#160; &#160;&#160;&#34;body&#34;:&#160;&#34;I'm adding a post from the *command line*.&#34;,<br/>&#160; &#160;&#160;&#34;body_html&#34;:&#160;&#34;&lt;p&gt;I'm adding a post from the &lt;em&gt;command line&lt;/em&gt;.&lt;/p&gt;&#34;,<br/>&#160; &#160;&#160;&#34;comments&#34;:&#160;&#34;http://127.0.0.1:5000/api/v1.0/posts/111/comments&#34;,<br/>&#160; &#160;&#160;&#34;comment_count&#34;: 0,<br/>&#160; &#160;&#160;&#34;timestamp&#34;:&#160;&#34;Sun, 22 Dec 2013 08:30:27 GMT&#34;,<br/>&#160; &#160;&#160;&#34;url&#34;:&#160;&#34;http://127.0.0.1:5000/api/v1.0/posts/111&#34;<br/>}</p>
<p style="position:absolute;top:240px;left:108px;white-space:nowrap" class="ft21314">To use authentication tokens, a request to&#160;<i>/api/v1.0/token</i>&#160;is sent:</p>
<p style="position:absolute;top:272px;left:134px;white-space:nowrap" class="ft21323">(venv)&#160;$&#160;http --auth &lt;email&gt;:&lt;password&gt; --json GET&#160;<b>\<br/></b>&gt; http://127.0.0.1:5000/api/v1.0/token<br/>HTTP/1.0 200 OK<br/>Content-Length: 162<br/>Content-Type: application/json<br/>Date: Sat, 04 Jan 2014 08:38:47 GMT<br/>Server: Werkzeug/0.9.4 Python/3.3.3</p>
<p style="position:absolute;top:395px;left:134px;white-space:nowrap" class="ft21357">{<br/>&#160; &#160;&#160;&#34;expiration&#34;: 3600,<br/>&#160; &#160;&#160;&#34;token&#34;:&#160;&#34;eyJpYXQiOjEzODg4MjQ3MjcsImV4cCI6MTM4ODgyODMyNywiYWxnIjoiSFMy...&#34;<br/>}</p>
<p style="position:absolute;top:461px;left:108px;white-space:nowrap" class="ft21314">And now the returned token can be used to make calls into the API for the next hour</p>
<p style="position:absolute;top:480px;left:108px;white-space:nowrap" class="ft21314">by passing it along with an empty password field:</p>
<p style="position:absolute;top:512px;left:134px;white-space:nowrap" class="ft21333">(venv)&#160;$&#160;http --json --auth eyJpYXQ...: GET http://127.0.0.1:5000/api/v1.0/posts/</p>
<p style="position:absolute;top:532px;left:108px;white-space:nowrap" class="ft21314">When the token expires, requests will be returned with a code 401 error, indicating that</p>
<p style="position:absolute;top:551px;left:108px;white-space:nowrap" class="ft21315">a new token needs to be obtained.<br/>Congratulations! This chapter completes Part II, and with that the feature development</p>
<p style="position:absolute;top:598px;left:108px;white-space:nowrap" class="ft21314">phase of Flasky is complete. The next step is obviously to deploy it, and that brings a</p>
<p style="position:absolute;top:617px;left:108px;white-space:nowrap" class="ft21314">new set of challenges that are the subject of Part III.</p>
<p style="position:absolute;top:915px;left:459px;white-space:nowrap" class="ft2135"><b>RESTful Web Services with Flask &#160;&#160;|&#160;&#160;193</b></p>
</div>
<!-- Page 214 -->
<a name="214"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page214-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask214.png" alt="background image"/>
</div>
<!-- Page 215 -->
<a name="215"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page215-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask215.png" alt="background image"/>
<p style="position:absolute;top:103px;left:578px;white-space:nowrap" class="ft21516"><b>PART III</b></p>
<p style="position:absolute;top:133px;left:465px;white-space:nowrap" class="ft21527"><b>The Last Mile</b></p>
</div>
<!-- Page 216 -->
<a name="216"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page216-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask216.png" alt="background image"/>
</div>
<!-- Page 217 -->
<a name="217"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page217-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask217.png" alt="background image"/>
<p style="position:absolute;top:104px;left:549px;white-space:nowrap" class="ft21728"><b>CHAPTER 15</b></p>
<p style="position:absolute;top:131px;left:558px;white-space:nowrap" class="ft21711"><b>Testing</b></p>
<p style="position:absolute;top:345px;left:108px;white-space:nowrap" class="ft21714">There are two very good reasons for writing unit tests. When implementing new func‐</p>
<p style="position:absolute;top:364px;left:108px;white-space:nowrap" class="ft21714">tionality, unit tests are used to confirm that the new code is working in the expected</p>
<p style="position:absolute;top:383px;left:108px;white-space:nowrap" class="ft21714">way. The same result can be obtained by testing manually, but of course automated tests</p>
<p style="position:absolute;top:402px;left:108px;white-space:nowrap" class="ft21715">save time and effort.<br/>A second, more important reason is that each time the application is modified, all the</p>
<p style="position:absolute;top:449px;left:108px;white-space:nowrap" class="ft21714">unit tests built around it can be executed to ensure that there are no&#160;<i>regressions</i>&#160;in the</p>
<p style="position:absolute;top:468px;left:108px;white-space:nowrap" class="ft21714">existing code; in other words, that the new changes did not affect the way the older code</p>
<p style="position:absolute;top:487px;left:108px;white-space:nowrap" class="ft21715">works.<br/>Unit tests have been a part of Flasky since the very beginning, with tests designed to</p>
<p style="position:absolute;top:533px;left:108px;white-space:nowrap" class="ft21714">exercise specific features of the application implemented in the database model classes.</p>
<p style="position:absolute;top:552px;left:108px;white-space:nowrap" class="ft21714">These classes are easy to test outside of the context of a running application, so given</p>
<p style="position:absolute;top:571px;left:108px;white-space:nowrap" class="ft21714">that it takes little effort, implementing unit tests for all the features implemented in the</p>
<p style="position:absolute;top:590px;left:108px;white-space:nowrap" class="ft21714">database models is the best way to ensure at least that part of the application starts robust</p>
<p style="position:absolute;top:609px;left:108px;white-space:nowrap" class="ft21715">and stays that way.<br/>This chapter discusses ways to improve and extend unit testing.</p>
<p style="position:absolute;top:674px;left:108px;white-space:nowrap" class="ft21722"><b>Obtaining Code Coverage Reports&#160;<br/></b>Having a test suite is important, but it is equally important to know how good or bad it</p>
<p style="position:absolute;top:734px;left:108px;white-space:nowrap" class="ft21714">is. Code coverage tools measure how much of the application is exercised by unit tests</p>
<p style="position:absolute;top:753px;left:108px;white-space:nowrap" class="ft21714">and can provide a detailed report that indicates which parts of the application code are</p>
<p style="position:absolute;top:772px;left:108px;white-space:nowrap" class="ft21714">not being tested. This information is invaluable, because it can be used to direct the</p>
<p style="position:absolute;top:791px;left:108px;white-space:nowrap" class="ft21715">effort of writing new tests to the areas that need it most.<br/>Python has an excellent code coverage tool appropriately called&#160;<i>coverage</i>. You can install</p>
<p style="position:absolute;top:838px;left:108px;white-space:nowrap" class="ft21714">it with pip:</p>
<p style="position:absolute;top:870px;left:134px;white-space:nowrap" class="ft21733">(venv)&#160;$&#160;pip install coverage</p>
<p style="position:absolute;top:915px;left:631px;white-space:nowrap" class="ft2175"><b>197</b></p>
</div>
<!-- Page 218 -->
<a name="218"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page218-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask218.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft21814">This tool comes as a command-line script that can launch any Python application with</p>
<p style="position:absolute;top:97px;left:108px;white-space:nowrap" class="ft21814">code coverage enabled, but it also provides more convenient scripting access to start</p>
<p style="position:absolute;top:116px;left:108px;white-space:nowrap" class="ft21814">the coverage engine programmatically. To have coverage metrics nicely integrated into</p>
<p style="position:absolute;top:136px;left:108px;white-space:nowrap" class="ft21814">the&#160;<i>manage.py</i>&#160;launcher script, the custom&#160;test&#160;command added in&#160;<a href="Flask.html#95">Chapter 7</a>&#160;can be</p>
<p style="position:absolute;top:156px;left:108px;white-space:nowrap" class="ft21814">expanded with a&#160;--coverage&#160;optional argument. The implementation of this option is</p>
<p style="position:absolute;top:175px;left:108px;white-space:nowrap" class="ft21814">shown in&#160;<a href="Flask.html#218">Example 15-1</a>.</p>
<p style="position:absolute;top:207px;left:108px;white-space:nowrap" class="ft21847"><i>Example 15-1. manage.py: Coverage metrics<br/>#!/usr/bin/env python<br/></i><b>import</b>&#160;<b>os<br/></b>COV&#160;=&#160;None<br/><b>if</b>&#160;os.environ.get('FLASK_COVERAGE'):<br/>&#160; &#160;&#160;<b>import</b>&#160;<b>coverage<br/></b>&#160; &#160;&#160;COV&#160;=&#160;coverage.coverage(branch=True,&#160;include='app/*')<br/>&#160; &#160;&#160;COV.start()</p>
<p style="position:absolute;top:357px;left:108px;white-space:nowrap" class="ft21862"><i># ...</i></p>
<p style="position:absolute;top:387px;left:108px;white-space:nowrap" class="ft21847">@manager.command<br/><b>def</b>&#160;test(coverage=False):<br/>&#160; &#160;&#160;<i>&#34;&#34;&#34;Run the unit tests.&#34;&#34;&#34;<br/></i>&#160; &#160;&#160;<b>if</b>&#160;coverage&#160;<b>and</b>&#160;<b>not</b>&#160;os.environ.get('FLASK_COVERAGE'):<br/>&#160; &#160; &#160; &#160;&#160;<b>import</b>&#160;<b>sys<br/></b>&#160; &#160; &#160; &#160;&#160;os.environ['FLASK_COVERAGE']&#160;=&#160;'1'<br/>&#160; &#160; &#160; &#160;&#160;os.execvp(sys.executable,&#160;[sys.executable]&#160;+&#160;sys.argv)<br/>&#160; &#160;&#160;<b>import</b>&#160;<b>unittest<br/></b>&#160; &#160;&#160;tests&#160;=&#160;unittest.TestLoader().discover('tests')<br/>&#160; &#160;&#160;unittest.TextTestRunner(verbosity=2).run(tests)<br/>&#160; &#160;&#160;<b>if</b>&#160;COV:<br/>&#160; &#160; &#160; &#160;&#160;COV.stop()<br/>&#160; &#160; &#160; &#160;&#160;COV.save()<br/>&#160; &#160; &#160; &#160;&#160;<b>print</b>('Coverage Summary:')<br/>&#160; &#160; &#160; &#160;&#160;COV.report()<br/>&#160; &#160; &#160; &#160;&#160;basedir&#160;=&#160;os.path.abspath(os.path.dirname(__file__))<br/>&#160; &#160; &#160; &#160;&#160;covdir&#160;=&#160;os.path.join(basedir,&#160;'tmp/coverage')<br/>&#160; &#160; &#160; &#160;&#160;COV.html_report(directory=covdir)<br/>&#160; &#160; &#160; &#160;&#160;<b>print</b>('HTML version: file://%s/index.html'&#160;%&#160;covdir)<br/>&#160; &#160; &#160; &#160;&#160;COV.erase()</p>
<p style="position:absolute;top:709px;left:108px;white-space:nowrap" class="ft21862"><i># ...</i></p>
<p style="position:absolute;top:735px;left:108px;white-space:nowrap" class="ft21814">Flask-Script makes it very easy to define custom commands. To add a Boolean option</p>
<p style="position:absolute;top:755px;left:108px;white-space:nowrap" class="ft21814">to the&#160;test&#160;command, add a Boolean argument to the&#160;test()&#160;function. Flask-Script</p>
<p style="position:absolute;top:775px;left:108px;white-space:nowrap" class="ft21814">derives the name of the option from the argument name and passes&#160;True&#160;or&#160;False&#160;to</p>
<p style="position:absolute;top:794px;left:108px;white-space:nowrap" class="ft21815">the function accordingly.<br/>But integrating code coverage with the&#160;<i>manage.py</i>&#160;script presents a small problem. By</p>
<p style="position:absolute;top:841px;left:108px;white-space:nowrap" class="ft21814">the time the&#160;--coverage&#160;option is received in the&#160;test()&#160;function, it is already too late</p>
<p style="position:absolute;top:860px;left:108px;white-space:nowrap" class="ft21814">to turn on coverage metrics; by that time all the code in the global scope has already</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft2185"><b>198&#160;&#160;|&#160;&#160;Chapter 15: Testing</b></p>
</div>
<!-- Page 219 -->
<a name="219"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page219-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask219.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft21946">executed. To get accurate metrics, the script restarts itself after setting the<br/>FLASK_COVERAGE</p>
<p style="position:absolute;top:98px;left:213px;white-space:nowrap" class="ft21914">&#160;environment variable. In the second run, the top of the script finds</p>
<p style="position:absolute;top:117px;left:108px;white-space:nowrap" class="ft21948">that the environment variable is set and turns on coverage from the start.<br/>The&#160;coverage.coverage()&#160;function starts the coverage engine. The&#160;branch=True&#160;op‐</p>
<p style="position:absolute;top:165px;left:108px;white-space:nowrap" class="ft21914">tion enables branch coverage analysis, which, in addition to tracking which lines of code</p>
<p style="position:absolute;top:185px;left:108px;white-space:nowrap" class="ft21914">execute, checks whether for every conditional both the&#160;True&#160;and&#160;False&#160;cases have ex‐</p>
<p style="position:absolute;top:205px;left:108px;white-space:nowrap" class="ft21914">ecuted. The&#160;include&#160;option is used to limit coverage analysis to the files that are inside</p>
<p style="position:absolute;top:223px;left:108px;white-space:nowrap" class="ft21946">the application package, which is the only code that needs to be measured. Without the<br/>include</p>
<p style="position:absolute;top:243px;left:160px;white-space:nowrap" class="ft21914">&#160;option, all the extensions installed in the virtual environment and the code for</p>
<p style="position:absolute;top:262px;left:108px;white-space:nowrap" class="ft21914">the tests itself would be included in the coverage reports—and that would add a lot of</p>
<p style="position:absolute;top:281px;left:108px;white-space:nowrap" class="ft21948">noise to the report.<br/>After all the tests have executed, the&#160;text()&#160;function writes a report to the console and</p>
<p style="position:absolute;top:329px;left:108px;white-space:nowrap" class="ft21914">also writes a nicer HTML report to disk. The HTML version is very good for displaying</p>
<p style="position:absolute;top:348px;left:108px;white-space:nowrap" class="ft21914">coverage visually because it shows the source code lines color-coded according to their</p>
<p style="position:absolute;top:367px;left:108px;white-space:nowrap" class="ft21914">use.</p>
<p style="position:absolute;top:408px;left:198px;white-space:nowrap" class="ft21925">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:426px;left:198px;white-space:nowrap" class="ft21925">run&#160;git&#160;checkout&#160;15a&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:444px;left:198px;white-space:nowrap" class="ft21980">To&#160;ensure&#160;that&#160;you&#160;have&#160;all&#160;the&#160;dependencies&#160;installed,&#160;also&#160;run&#160;pip<br/>install&#160;-r&#160;requirements/dev.txt</p>
<p style="position:absolute;top:462px;left:410px;white-space:nowrap" class="ft21925">.</p>
<p style="position:absolute;top:514px;left:108px;white-space:nowrap" class="ft21914">An example of the text-based report follows:</p>
<p style="position:absolute;top:546px;left:133px;white-space:nowrap" class="ft21947">(venv) $ python manage.py test --coverage<br/>...<br/>.----------------------------------------------------------------------<br/>Ran 19 tests in 50.609s</p>
<p style="position:absolute;top:623px;left:133px;white-space:nowrap" class="ft21947">OK<br/>Coverage Summary:<br/>Name &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; Stmts &#160; Miss Branch BrMiss &#160;Cover &#160; Missing<br/>...<br/>.-----------------------------------------------------------------------<br/>app/__init__ &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;33 &#160; &#160; &#160;0 &#160; &#160; &#160;0 &#160; &#160; &#160;0 &#160; 100%<br/>app/api_1_0/__init__ &#160; &#160; &#160; &#160; &#160; &#160; 3 &#160; &#160; &#160;0 &#160; &#160; &#160;0 &#160; &#160; &#160;0 &#160; 100%<br/>app/api_1_0/authentication &#160; &#160; &#160;30 &#160; &#160; 19 &#160; &#160; 11 &#160; &#160; 11 &#160; &#160;27%<br/>app/api_1_0/comments &#160; &#160; &#160; &#160; &#160; &#160;40 &#160; &#160; 30 &#160; &#160; 12 &#160; &#160; 12 &#160; &#160;19%<br/>app/api_1_0/decorators &#160; &#160; &#160; &#160; &#160;11 &#160; &#160; &#160;3 &#160; &#160; &#160;2 &#160; &#160; &#160;2 &#160; &#160;62%<br/>app/api_1_0/errors &#160; &#160; &#160; &#160; &#160; &#160; &#160;17 &#160; &#160; 10 &#160; &#160; &#160;0 &#160; &#160; &#160;0 &#160; &#160;41%<br/>app/api_1_0/posts &#160; &#160; &#160; &#160; &#160; &#160; &#160; 35 &#160; &#160; 23 &#160; &#160; &#160;9 &#160; &#160; &#160;9 &#160; &#160;27%<br/>app/api_1_0/users &#160; &#160; &#160; &#160; &#160; &#160; &#160; 30 &#160; &#160; 24 &#160; &#160; 12 &#160; &#160; 12 &#160; &#160;14%<br/>app/auth/__init__ &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;3 &#160; &#160; &#160;0 &#160; &#160; &#160;0 &#160; &#160; &#160;0 &#160; 100%<br/>app/auth/forms &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;45 &#160; &#160; &#160;8 &#160; &#160; &#160;8 &#160; &#160; &#160;8 &#160; &#160;70%<br/>app/auth/views &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; 109 &#160; &#160; 84 &#160; &#160; 41 &#160; &#160; 41 &#160; &#160;17%<br/>app/decorators &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;14 &#160; &#160; &#160;3 &#160; &#160; &#160;2 &#160; &#160; &#160;2 &#160; &#160;69%</p>
<p style="position:absolute;top:915px;left:452px;white-space:nowrap" class="ft2195"><b>Obtaining Code Coverage Reports &#160;&#160;|&#160;&#160;199</b></p>
</div>
<!-- Page 220 -->
<a name="220"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page220-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask220.png" alt="background image"/>
<p style="position:absolute;top:82px;left:134px;white-space:nowrap" class="ft22047">app/email &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; 15 &#160; &#160; &#160;9 &#160; &#160; &#160;0 &#160; &#160; &#160;0 &#160; &#160;40%<br/>app/exceptions &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; 2 &#160; &#160; &#160;0 &#160; &#160; &#160;0 &#160; &#160; &#160;0 &#160; 100%<br/>app/main/__init__ &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;6 &#160; &#160; &#160;1 &#160; &#160; &#160;0 &#160; &#160; &#160;0 &#160; &#160;83%<br/>app/main/errors &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; 20 &#160; &#160; 15 &#160; &#160; &#160;9 &#160; &#160; &#160;9 &#160; &#160;17%<br/>app/main/forms &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;39 &#160; &#160; &#160;7 &#160; &#160; &#160;8 &#160; &#160; &#160;8 &#160; &#160;68%<br/>app/main/views &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; 169 &#160; &#160;131 &#160; &#160; 36 &#160; &#160; 36 &#160; &#160;19%<br/>app/models &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; 243 &#160; &#160; 62 &#160; &#160; 44 &#160; &#160; 17 &#160; &#160;72%<br/>.-----------------------------------------------------------------------<br/>TOTAL &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;864 &#160; &#160;429 &#160; &#160;194 &#160; &#160;167 &#160; &#160;44%<br/>HTML version: file:///home/flask/flasky/tmp/coverage/index.html</p>
<p style="position:absolute;top:240px;left:108px;white-space:nowrap" class="ft22014">The report shows an overall coverage of 44%, which is not terrible, but isn’t very good</p>
<p style="position:absolute;top:259px;left:108px;white-space:nowrap" class="ft22014">either. The model classes, which have received all the unit testing attention so far, con‐</p>
<p style="position:absolute;top:278px;left:108px;white-space:nowrap" class="ft22014">stitute a total of 243 statements, of which 72% are covered in tests. Obviously the&#160;<i>views.py</i></p>
<p style="position:absolute;top:298px;left:108px;white-space:nowrap" class="ft22014">files in the&#160;main&#160;and&#160;auth&#160;blueprints and the routes in the&#160;api_1_0&#160;blueprint all have</p>
<p style="position:absolute;top:317px;left:108px;white-space:nowrap" class="ft22015">very low coverage, since these are not exercised in any of the existing unit tests.<br/>Armed with this report, it is easy to determine which tests need to be added to the test</p>
<p style="position:absolute;top:364px;left:108px;white-space:nowrap" class="ft22014">suite to improve coverage, but unfortunately not all parts of the application can be tested</p>
<p style="position:absolute;top:383px;left:108px;white-space:nowrap" class="ft22014">as easily as the database models. The next two sections discuss more advanced testing</p>
<p style="position:absolute;top:402px;left:108px;white-space:nowrap" class="ft22015">strategies that can be applied to view functions, forms, and templates.<br/>Note that the contents of the&#160;<i>Missing</i>&#160;column have been omitted in the example report</p>
<p style="position:absolute;top:448px;left:108px;white-space:nowrap" class="ft22014">to improve the formatting. This column indicates the source code lines that were missed</p>
<p style="position:absolute;top:467px;left:108px;white-space:nowrap" class="ft22014">by the tests as a long list of line number ranges.</p>
<p style="position:absolute;top:504px;left:108px;white-space:nowrap" class="ft22022"><b>The Flask Test Client&#160;<br/></b>Some portions of the application code rely heavily on the environment that is created</p>
<p style="position:absolute;top:565px;left:108px;white-space:nowrap" class="ft22014">by a running application. For example, you can’t simply invoke the code in a view func‐</p>
<p style="position:absolute;top:585px;left:108px;white-space:nowrap" class="ft22014">tion to test it, as the function may need to access Flask context globals such as&#160;request</p>
<p style="position:absolute;top:605px;left:108px;white-space:nowrap" class="ft22014">or&#160;session, it may be expecting form data in a&#160;POST&#160;request, and some view functions</p>
<p style="position:absolute;top:623px;left:108px;white-space:nowrap" class="ft22014">may also require a logged-in user. In short, view functions can run only within the</p>
<p style="position:absolute;top:642px;left:108px;white-space:nowrap" class="ft22015">context of a request and a running application.<br/>Flask comes equipped with a&#160;<i>test client</i>&#160;to try to address this problem, at least partially.</p>
<p style="position:absolute;top:689px;left:108px;white-space:nowrap" class="ft22014">The test client replicates the environment that exists when an application is running</p>
<p style="position:absolute;top:708px;left:108px;white-space:nowrap" class="ft22015">inside a web server, allowing tests to act as clients and send requests.<br/>The view functions do not see any major differences when executed under the test client;</p>
<p style="position:absolute;top:755px;left:108px;white-space:nowrap" class="ft22014">requests are received and routed to the appropriate view functions, from which re‐</p>
<p style="position:absolute;top:774px;left:108px;white-space:nowrap" class="ft22014">sponses are generated and returned. After a view function executes, its response is</p>
<p style="position:absolute;top:793px;left:108px;white-space:nowrap" class="ft22014">passed to the test, which can check it for correctness.</p>
<p style="position:absolute;top:829px;left:108px;white-space:nowrap" class="ft22052"><b>Testing Web Applications&#160;<br/></b><a href="Flask.html#221">Example 15-2&#160;shows a unit testing framework tha</a>t uses the test client.</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft2205"><b>200&#160;&#160;|&#160;&#160;Chapter 15: Testing</b></p>
</div>
<!-- Page 221 -->
<a name="221"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page221-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask221.png" alt="background image"/>
<p style="position:absolute;top:94px;left:108px;white-space:nowrap" class="ft22140"><i>Example 15-2. tests/test_client.py: Framework for tests using the Flask test client<br/></i><b>import</b>&#160;<b>unittest<br/>from</b>&#160;<b>app</b>&#160;<b>import</b>&#160;create_app,&#160;db<br/><b>from</b>&#160;<b>app.models</b>&#160;<b>import</b>&#160;User,&#160;Role</p>
<p style="position:absolute;top:183px;left:108px;white-space:nowrap" class="ft22147"><b>class</b>&#160;<b>FlaskClientTestCase</b>(unittest.TestCase):<br/>&#160; &#160;&#160;<b>def</b>&#160;setUp(self):<br/>&#160; &#160; &#160; &#160;&#160;self.app&#160;=&#160;create_app('testing')<br/>&#160; &#160; &#160; &#160;&#160;self.app_context&#160;=&#160;self.app.app_context()<br/>&#160; &#160; &#160; &#160;&#160;self.app_context.push()<br/>&#160; &#160; &#160; &#160;&#160;db.create_all()<br/>&#160; &#160; &#160; &#160;&#160;Role.insert_roles()<br/>&#160; &#160; &#160; &#160;&#160;self.client&#160;=&#160;self.app.test_client(use_cookies=True)</p>
<p style="position:absolute;top:321px;left:108px;white-space:nowrap" class="ft22147">&#160; &#160;&#160;<b>def</b>&#160;tearDown(self):<br/>&#160; &#160; &#160; &#160;&#160;db.session.remove()<br/>&#160; &#160; &#160; &#160;&#160;db.drop_all()<br/>&#160; &#160; &#160; &#160;&#160;self.app_context.pop()</p>
<p style="position:absolute;top:398px;left:108px;white-space:nowrap" class="ft22147">&#160; &#160;&#160;<b>def</b>&#160;test_home_page(self):<br/>&#160; &#160; &#160; &#160;&#160;response&#160;=&#160;self.client.get(url_for('main.index'))<br/>&#160; &#160; &#160; &#160;&#160;self.assertTrue('Stranger'&#160;<b>in</b>&#160;response.get_data(as_text=True))</p>
<p style="position:absolute;top:456px;left:108px;white-space:nowrap" class="ft22114">The&#160;self.client&#160;instance variable added to the test case is the Flask test client object.</p>
<p style="position:absolute;top:474px;left:108px;white-space:nowrap" class="ft22114">This object exposes methods that issue requests into the application. When the test client</p>
<p style="position:absolute;top:494px;left:108px;white-space:nowrap" class="ft22114">is created with the&#160;use_cookies&#160;option enabled, it will accept and send cookies in the</p>
<p style="position:absolute;top:513px;left:108px;white-space:nowrap" class="ft22114">same way browsers do, so functionality that relies on cookies to recall context between</p>
<p style="position:absolute;top:532px;left:108px;white-space:nowrap" class="ft22114">requests can be used. In particular, this approach enables the use of user sessions, so it</p>
<p style="position:absolute;top:551px;left:108px;white-space:nowrap" class="ft22148">is necessary to log users in and out.<br/>The&#160;test_home_page()&#160;test is a simple example of what the test client can do. In this</p>
<p style="position:absolute;top:600px;left:108px;white-space:nowrap" class="ft22114">example, a request for the home page is issued. The return value of the&#160;get()&#160;method</p>
<p style="position:absolute;top:619px;left:108px;white-space:nowrap" class="ft22114">of the test client is a Flask&#160;Response&#160;object, containing the response returned by the</p>
<p style="position:absolute;top:638px;left:108px;white-space:nowrap" class="ft22114">invoked view function. To check whether the test was successful, the body of the re‐</p>
<p style="position:absolute;top:658px;left:108px;white-space:nowrap" class="ft22114">sponse, obtained from&#160;response.get_data(), is searched for the word&#160;&#34;Stranger&#34;,</p>
<p style="position:absolute;top:677px;left:108px;white-space:nowrap" class="ft22146">which is part of the “Hello, Stranger!” greeting shown to anonymous users. Note that<br/>get_data()</p>
<p style="position:absolute;top:697px;left:183px;white-space:nowrap" class="ft22114">&#160;returns the response body as a byte array by default; passing&#160;as_text=True</p>
<p style="position:absolute;top:716px;left:108px;white-space:nowrap" class="ft22148">returns a Unicode string that is much easier to work with.<br/>The test client can also send&#160;POST&#160;requests that include form data using the&#160;post()</p>
<p style="position:absolute;top:764px;left:108px;white-space:nowrap" class="ft22114">method, but submitting forms presents a small complication. The forms generated by</p>
<p style="position:absolute;top:782px;left:108px;white-space:nowrap" class="ft22114">Flask-WTF have a hidden field with a CSRF token that needs to be submitted along</p>
<p style="position:absolute;top:801px;left:108px;white-space:nowrap" class="ft22114">with the form. To replicate this functionality, a test would need to request the page that</p>
<p style="position:absolute;top:820px;left:108px;white-space:nowrap" class="ft22114">includes the form, then parse the HTML text returned in the response and extract the</p>
<p style="position:absolute;top:839px;left:108px;white-space:nowrap" class="ft22114">token so that it can then send the token with the form data. To avoid the hassle of dealing</p>
<p style="position:absolute;top:915px;left:510px;white-space:nowrap" class="ft2215"><b>The Flask Test Client &#160;&#160;|&#160;&#160;201</b></p>
</div>
<!-- Page 222 -->
<a name="222"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page222-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask222.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft22214">with CSRF tokens in tests, it is better to disable CSRF protection in the testing config‐</p>
<p style="position:absolute;top:97px;left:108px;white-space:nowrap" class="ft22214">uration. This is as shown in&#160;<a href="Flask.html#222">Example 15-3.</a></p>
<p style="position:absolute;top:129px;left:108px;white-space:nowrap" class="ft22268"><i>Example 15-3. config.py: Disable CSRF protection in the testing configuration<br/></i><b>class</b>&#160;<b>TestingConfig</b>(Config):<br/>&#160; &#160;&#160;<i>#...<br/></i>&#160; &#160;&#160;WTF_CSRF_ENABLED&#160;=&#160;False</p>
<p style="position:absolute;top:214px;left:108px;white-space:nowrap" class="ft22217"><a href="Flask.html#222">Example 15-4</a>&#160;shows a more advanced unit test that simulates a new user registering an</p>
<p style="position:absolute;top:233px;left:108px;white-space:nowrap" class="ft22214">account, logging in, confirming the account with a confirmation token, and finally log‐</p>
<p style="position:absolute;top:252px;left:108px;white-space:nowrap" class="ft22214">ging out.</p>
<p style="position:absolute;top:284px;left:108px;white-space:nowrap" class="ft22247"><i>Example 15-4.&#160;tests/test_client.py: Simulation of a new user workflow with the Flask<br/>test client<br/></i><b>class</b>&#160;<b>FlaskClientTestCase</b>(unittest.TestCase):<br/>&#160; &#160;&#160;<i># ...<br/></i>&#160; &#160;&#160;<b>def</b>&#160;test_register_and_login(self):<br/>&#160; &#160; &#160; &#160;&#160;<i># register a new account<br/></i>&#160; &#160; &#160; &#160;&#160;response&#160;=&#160;self.client.post(url_for('auth.register'),&#160;data={<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;'email':&#160;'john@example.com',<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;'username':&#160;'john',<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;'password':&#160;'cat',<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;'password2':&#160;'cat'<br/>&#160; &#160; &#160; &#160;&#160;})<br/>&#160; &#160; &#160; &#160;&#160;self.assertTrue(response.status_code&#160;==&#160;302)</p>
<p style="position:absolute;top:514px;left:108px;white-space:nowrap" class="ft22247">&#160; &#160; &#160; &#160;&#160;<i># login with the new account<br/></i>&#160; &#160; &#160; &#160;&#160;response&#160;=&#160;self.client.post(url_for('auth.login'),&#160;data={<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;'email':&#160;'john@example.com',<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;'password':&#160;'cat'<br/>&#160; &#160; &#160; &#160;&#160;},&#160;follow_redirects=True)<br/>&#160; &#160; &#160; &#160;&#160;data&#160;=&#160;response.get_data(as_text=True)<br/>&#160; &#160; &#160; &#160;&#160;self.assertTrue(re.search('Hello,\s+john!',&#160;data))<br/>&#160; &#160; &#160; &#160;&#160;self.assertTrue('You have not confirmed your account yet'&#160;<b>in</b>&#160;data)</p>
<p style="position:absolute;top:652px;left:108px;white-space:nowrap" class="ft22247">&#160; &#160; &#160; &#160;&#160;<i># send a confirmation token<br/></i>&#160; &#160; &#160; &#160;&#160;user&#160;=&#160;User.query.filter_by(email='john@example.com').first()<br/>&#160; &#160; &#160; &#160;&#160;token&#160;=&#160;user.generate_confirmation_token()<br/>&#160; &#160; &#160; &#160;&#160;response&#160;=&#160;self.client.get(url_for('auth.confirm',&#160;token=token),<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;follow_redirects=True)<br/>&#160; &#160; &#160; &#160;&#160;data&#160;=&#160;response.get_data(as_text=True)<br/>&#160; &#160; &#160; &#160;&#160;self.assertTrue('You have confirmed your account'&#160;<b>in</b>&#160;data)</p>
<p style="position:absolute;top:774px;left:108px;white-space:nowrap" class="ft22247">&#160; &#160; &#160; &#160;&#160;<i># log out<br/></i>&#160; &#160; &#160; &#160;&#160;response&#160;=&#160;self.client.get(url_for('auth.logout'),<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;follow_redirects=True)<br/>&#160; &#160; &#160; &#160;&#160;data&#160;=&#160;response.get_data(as_text=True)<br/>&#160; &#160; &#160; &#160;&#160;self.assertTrue('You have been logged out'&#160;<b>in</b>&#160;data)</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft2225"><b>202&#160;&#160;|&#160;&#160;Chapter 15: Testing</b></p>
</div>
<!-- Page 223 -->
<a name="223"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page223-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask223.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft22346">The test begins with a form submission to the registration route. The&#160;data&#160;argument to<br/>post()</p>
<p style="position:absolute;top:99px;left:153px;white-space:nowrap" class="ft22314">&#160;is a dictionary with the form fields, which must exactly match the field names</p>
<p style="position:absolute;top:118px;left:108px;white-space:nowrap" class="ft22314">defined in the form. Since CSRF protection is now disabled in the testing configuration,</p>
<p style="position:absolute;top:137px;left:108px;white-space:nowrap" class="ft22315">there is no need to send the CSRF token with the form.<br/>The&#160;<i>/auth/register</i>&#160;route can respond in two ways. If the registration data is valid, a</p>
<p style="position:absolute;top:184px;left:108px;white-space:nowrap" class="ft22314">redirect sends the user to the login page. In the case of an invalid registration, the re‐</p>
<p style="position:absolute;top:203px;left:108px;white-space:nowrap" class="ft22314">sponse renders the page with the registration form again, including any appropriate</p>
<p style="position:absolute;top:222px;left:108px;white-space:nowrap" class="ft22314">error messages. To validate that the registration was accepted, the test checks that the</p>
<p style="position:absolute;top:240px;left:108px;white-space:nowrap" class="ft22315">status code of the response is 302, which is the code for a redirect.<br/>The second section of the test issues a login to the application using the email and</p>
<p style="position:absolute;top:288px;left:108px;white-space:nowrap" class="ft22314">password just registered. This is done with a&#160;POST&#160;request to the&#160;<i>/auth/login</i>&#160;route. This</p>
<p style="position:absolute;top:308px;left:108px;white-space:nowrap" class="ft22314">time a&#160;follow_redirects=True&#160;argument is included in the&#160;post()&#160;call to make the</p>
<p style="position:absolute;top:328px;left:108px;white-space:nowrap" class="ft22314">test client work like a browser and automatically issue a&#160;GET&#160;request for the redirected</p>
<p style="position:absolute;top:347px;left:108px;white-space:nowrap" class="ft22314">URL. With this option, status code 302 will not be returned; instead, the response from</p>
<p style="position:absolute;top:366px;left:108px;white-space:nowrap" class="ft22315">the redirected URL is returned.<br/>A successful response to the login submission would now have a page that greets the</p>
<p style="position:absolute;top:412px;left:108px;white-space:nowrap" class="ft22314">user by the username and then indicates that the account needs to be confirmed to gain</p>
<p style="position:absolute;top:431px;left:108px;white-space:nowrap" class="ft22314">access. Two assert statements verify that this is the page, and here it is interesting to note</p>
<p style="position:absolute;top:451px;left:108px;white-space:nowrap" class="ft22314">that a search for the string&#160;'Hello, john!'&#160;would not work because this string is as‐</p>
<p style="position:absolute;top:470px;left:108px;white-space:nowrap" class="ft22314">sembled from static and dynamic portions, with extra whitespace in between the parts.</p>
<p style="position:absolute;top:489px;left:108px;white-space:nowrap" class="ft22314">To avoid an error in this test due to the whitespace, a more flexible regular expression</p>
<p style="position:absolute;top:508px;left:108px;white-space:nowrap" class="ft22315">is used.<br/>The next step is to confirm the account, which presents another small obstacle. The</p>
<p style="position:absolute;top:555px;left:108px;white-space:nowrap" class="ft22314">confirmation URL is sent to the user by email during registration, so there is no easy</p>
<p style="position:absolute;top:574px;left:108px;white-space:nowrap" class="ft22314">way to access it from the test. The solution presented in the example bypasses the token</p>
<p style="position:absolute;top:592px;left:108px;white-space:nowrap" class="ft22314">that was generated as part of the registration and generates another one directly from</p>
<p style="position:absolute;top:612px;left:108px;white-space:nowrap" class="ft22314">the&#160;User&#160;instance. Another possibility would have been to extract the token by parsing</p>
<p style="position:absolute;top:631px;left:108px;white-space:nowrap" class="ft22315">the email body, which Flask-Mail saves when running in a testing configuration.<br/>With the token at hand, the third part of the test is to simulate the user clicking the</p>
<p style="position:absolute;top:679px;left:108px;white-space:nowrap" class="ft22314">confirmation token URL. This is achieved by sending a&#160;GET&#160;request to the confirmation</p>
<p style="position:absolute;top:698px;left:108px;white-space:nowrap" class="ft22314">URL with the token attached. The response to this request is a redirect to the home</p>
<p style="position:absolute;top:718px;left:108px;white-space:nowrap" class="ft22314">page, but once again&#160;follow_redirects=True&#160;was specified, so the test client requests</p>
<p style="position:absolute;top:737px;left:108px;white-space:nowrap" class="ft22314">the redirected page automatically. The response is checked for the greeting and a flashed</p>
<p style="position:absolute;top:755px;left:108px;white-space:nowrap" class="ft22348">message that informs the user that the confirmation was successful.<br/>The final step in this test is to send a&#160;GET&#160;request to the logout route; to confirm that</p>
<p style="position:absolute;top:803px;left:108px;white-space:nowrap" class="ft22314">this has worked, the test searches for a flashed message in the response.</p>
<p style="position:absolute;top:915px;left:510px;white-space:nowrap" class="ft2235"><b>The Flask Test Client &#160;&#160;|&#160;&#160;203</b></p>
</div>
<!-- Page 224 -->
<a name="224"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page224-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask224.png" alt="background image"/>
<p style="position:absolute;top:85px;left:198px;white-space:nowrap" class="ft22425">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:103px;left:198px;white-space:nowrap" class="ft22425">run&#160;git&#160;checkout&#160;15b&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:189px;left:108px;white-space:nowrap" class="ft22452"><b>Testing Web Services&#160;<br/></b>The Flask test client can also be used to test RESTful web services.&#160;<a href="Flask.html#224">Example 15-5</a>&#160;shows</p>
<p style="position:absolute;top:243px;left:108px;white-space:nowrap" class="ft22414">an example unit test class with two tests.</p>
<p style="position:absolute;top:275px;left:108px;white-space:nowrap" class="ft22457"><i>Example 15-5. tests/test_api.py: RESTful API testing with the Flask test client<br/></i><b>class</b>&#160;<b>APITestCase</b>(unittest.TestCase):<br/>&#160; &#160;&#160;<i># ...<br/></i>&#160; &#160;&#160;<b>def</b>&#160;get_api_headers(self,&#160;username,&#160;password):<br/>&#160; &#160; &#160; &#160;&#160;<b>return</b>&#160;{<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;'Authorization':<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;'Basic '&#160;+&#160;b64encode(<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;(username&#160;+&#160;':'&#160;+&#160;password).encode('utf-8')).decode('utf-8'),<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;'Accept':&#160;'application/json',<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;'Content-Type':&#160;'application/json'<br/>&#160; &#160; &#160; &#160;&#160;}</p>
<p style="position:absolute;top:471px;left:108px;white-space:nowrap" class="ft22447">&#160; &#160;&#160;<b>def</b>&#160;test_no_auth(self):<br/>&#160; &#160; &#160; &#160;&#160;response&#160;=&#160;self.client.get(url_for('api.get_posts'),<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;content_type='application/json')<br/>&#160; &#160; &#160; &#160;&#160;self.assertTrue(response.status_code&#160;==&#160;401)</p>
<p style="position:absolute;top:548px;left:108px;white-space:nowrap" class="ft22447">&#160; &#160;&#160;<b>def</b>&#160;test_posts(self):<br/>&#160; &#160; &#160; &#160;&#160;<i># add a user<br/></i>&#160; &#160; &#160; &#160;&#160;r&#160;=&#160;Role.query.filter_by(name='User').first()<br/>&#160; &#160; &#160; &#160;&#160;self.assertIsNotNone(r)<br/>&#160; &#160; &#160; &#160;&#160;u&#160;=&#160;User(email='john@example.com',&#160;password='cat',&#160;confirmed=True,<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;role=r)<br/>&#160; &#160; &#160; &#160;&#160;db.session.add(u)<br/>&#160; &#160; &#160; &#160;&#160;db.session.commit()</p>
<p style="position:absolute;top:685px;left:108px;white-space:nowrap" class="ft22447">&#160; &#160; &#160; &#160;&#160;<i># write a post<br/></i>&#160; &#160; &#160; &#160;&#160;response&#160;=&#160;self.client.post(<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;url_for('api.new_post'),<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;headers=self.get_auth_header('john@example.com',&#160;'cat'),<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;data=json.dumps({'body':&#160;'body of the blog post'}))<br/>&#160; &#160; &#160; &#160;&#160;self.assertTrue(response.status_code&#160;==&#160;201)<br/>&#160; &#160; &#160; &#160;&#160;url&#160;=&#160;response.headers.get('Location')<br/>&#160; &#160; &#160; &#160;&#160;self.assertIsNotNone(url)</p>
<p style="position:absolute;top:823px;left:108px;white-space:nowrap" class="ft22447">&#160; &#160; &#160; &#160;&#160;<i># get the new post<br/></i>&#160; &#160; &#160; &#160;&#160;response&#160;=&#160;self.client.get(<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;url,<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;headers=self.get_auth_header('john@example.com',&#160;'cat'))</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft2245"><b>204&#160;&#160;|&#160;&#160;Chapter 15: Testing</b></p>
</div>
<!-- Page 225 -->
<a name="225"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page225-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask225.png" alt="background image"/>
<p style="position:absolute;top:82px;left:108px;white-space:nowrap" class="ft22556">&#160; &#160; &#160; &#160;&#160;self.assertTrue(response.status_code&#160;==&#160;200)<br/>&#160; &#160; &#160; &#160;&#160;json_response&#160;=&#160;json.loads(response.data.decode('utf-8'))<br/>&#160; &#160; &#160; &#160;&#160;self.assertTrue(json_response['url']&#160;==&#160;url)<br/>&#160; &#160; &#160; &#160;&#160;self.assertTrue(json_response['body']&#160;==&#160;'body of the *blog* post')<br/>&#160; &#160; &#160; &#160;&#160;self.assertTrue(json_response['body_html']&#160;==<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;'&lt;p&gt;body of the &lt;em&gt;blog&lt;/em&gt; post&lt;/p&gt;')</p>
<p style="position:absolute;top:186px;left:108px;white-space:nowrap" class="ft22514">The&#160;setUp()&#160;and&#160;tearDown()&#160;methods for testing the API are the same as for the regular</p>
<p style="position:absolute;top:205px;left:108px;white-space:nowrap" class="ft22514">application, but the cookie support does not need to be configured because the API does</p>
<p style="position:absolute;top:225px;left:108px;white-space:nowrap" class="ft22514">not use it. The&#160;get_api_headers()&#160;method is a helper method that returns the common</p>
<p style="position:absolute;top:244px;left:108px;white-space:nowrap" class="ft22514">headers that need to be sent with all requests. These include the authentication creden‐</p>
<p style="position:absolute;top:263px;left:108px;white-space:nowrap" class="ft22548">tials and the MIME-type related headers. Most of the tests need to send these headers.<br/>The&#160;test_no_auth()&#160;test is a simple test that ensures that a request that does not include</p>
<p style="position:absolute;top:311px;left:108px;white-space:nowrap" class="ft22514">authentication credentials is rejected with error code 401. The&#160;test_posts()&#160;test adds</p>
<p style="position:absolute;top:330px;left:108px;white-space:nowrap" class="ft22514">a user to the database and then uses the RESTful API to insert a blog post and then read</p>
<p style="position:absolute;top:350px;left:108px;white-space:nowrap" class="ft22514">it back. Any requests that send data in the body must encode it with&#160;json.dumps(),</p>
<p style="position:absolute;top:369px;left:108px;white-space:nowrap" class="ft22514">because the Flask test client does not automatically encode to JSON. Likewise, response</p>
<p style="position:absolute;top:389px;left:108px;white-space:nowrap" class="ft22514">bodies are also returned in JSON format and must be decoded with&#160;json.loads()&#160;before</p>
<p style="position:absolute;top:408px;left:108px;white-space:nowrap" class="ft22514">they can be inspected.</p>
<p style="position:absolute;top:449px;left:198px;white-space:nowrap" class="ft22525">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:467px;left:198px;white-space:nowrap" class="ft22525">run&#160;git&#160;checkout&#160;15c&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:552px;left:108px;white-space:nowrap" class="ft22522"><b>End-to-End Testing with Selenium&#160;<br/></b>The Flask test client cannot fully emulate the environment of a running application. For</p>
<p style="position:absolute;top:613px;left:108px;white-space:nowrap" class="ft22514">example, any application that relies on JavaScript code running in the client browser</p>
<p style="position:absolute;top:632px;left:108px;white-space:nowrap" class="ft22514">will not work, as the JavaScript code included in the responses returned to the test will</p>
<p style="position:absolute;top:651px;left:108px;white-space:nowrap" class="ft22515">not be executed as they would be in a real web browser client.<br/>When tests require the complete environment, there is no other choice than to use a</p>
<p style="position:absolute;top:698px;left:108px;white-space:nowrap" class="ft22514">real web browser connected to the application running under a real web server. Fortu‐</p>
<p style="position:absolute;top:716px;left:108px;white-space:nowrap" class="ft22514">nately, most web browsers can be automated.&#160;<a href="http://www.seleniumhq.org/">Selenium&#160;is a web browser a</a>utomation</p>
<p style="position:absolute;top:735px;left:108px;white-space:nowrap" class="ft22515">tool that supports the most popular web browsers in the three major operating systems.<br/>The Python interface for Selenium is installed with pip:</p>
<p style="position:absolute;top:795px;left:134px;white-space:nowrap" class="ft22533">(venv)&#160;$&#160;pip install selenium</p>
<p style="position:absolute;top:815px;left:108px;white-space:nowrap" class="ft22514">Testing with Selenium requires the application to be running inside a web server that</p>
<p style="position:absolute;top:834px;left:108px;white-space:nowrap" class="ft22514">is listening for real HTTP requests. The method that will be shown in this section starts</p>
<p style="position:absolute;top:853px;left:108px;white-space:nowrap" class="ft22514">the application with the development server in a background thread while the tests run</p>
<p style="position:absolute;top:915px;left:448px;white-space:nowrap" class="ft2255"><b>End-to-End Testing with Selenium &#160;&#160;|&#160;&#160;205</b></p>
</div>
<!-- Page 226 -->
<a name="226"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page226-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask226.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft22614">on the main thread. Under the control of the tests, Selenium launches a web browser</p>
<p style="position:absolute;top:97px;left:108px;white-space:nowrap" class="ft22615">and makes it connect to the application to perform the required operations<br/>A problem with this approach is that after all the tests have completed, the Flask server</p>
<p style="position:absolute;top:144px;left:108px;white-space:nowrap" class="ft22614">needs to be stopped, ideally in a graceful way, so that background tasks such as the code</p>
<p style="position:absolute;top:163px;left:108px;white-space:nowrap" class="ft22614">coverage engine can cleanly complete their work. The Werkzeug web server has a shut‐</p>
<p style="position:absolute;top:182px;left:108px;white-space:nowrap" class="ft22614">down option, but because the server is running isolated in its own thread, the only way</p>
<p style="position:absolute;top:201px;left:108px;white-space:nowrap" class="ft22614">to ask the server to shut down is by sending a regular HT<a href="Flask.html#226">TP request.&#160;Example 15-6</a></p>
<p style="position:absolute;top:220px;left:108px;white-space:nowrap" class="ft22614">shows the implementation of a server shutdown route.</p>
<p style="position:absolute;top:252px;left:108px;white-space:nowrap" class="ft22647"><i>Example 15-6. _app/main/views.py: Server shutdown route<br/></i>@main.route('/shutdown')<br/><b>def</b>&#160;server_shutdown():<br/>&#160; &#160;&#160;<b>if</b>&#160;<b>not</b>&#160;current_app.testing:<br/>&#160; &#160; &#160; &#160;&#160;abort(404)<br/>&#160; &#160;&#160;shutdown&#160;=&#160;request.environ.get('werkzeug.server.shutdown')<br/>&#160; &#160;&#160;<b>if</b>&#160;<b>not</b>&#160;shutdown:<br/>&#160; &#160; &#160; &#160;&#160;abort(500)<br/>&#160; &#160;&#160;shutdown()<br/>&#160; &#160;&#160;<b>return</b>&#160;'Shutting down...'</p>
<p style="position:absolute;top:428px;left:108px;white-space:nowrap" class="ft22614">The shutdown route will work only when the application is running in testing mode;</p>
<p style="position:absolute;top:447px;left:108px;white-space:nowrap" class="ft22614">invoking it in other configurations will fail. The actual shutdown procedure involves</p>
<p style="position:absolute;top:466px;left:108px;white-space:nowrap" class="ft22614">calling a shutdown function that Werkzeug exposes in the environment. After calling</p>
<p style="position:absolute;top:485px;left:108px;white-space:nowrap" class="ft22614">this function and returning from the request, the development web server will know</p>
<p style="position:absolute;top:504px;left:108px;white-space:nowrap" class="ft22615">that it needs to exit gracefully.<br/><a href="Flask.html#226">Example 15-7</a>&#160;shows the layout of a test case that is configured to run tests with Selenium.</p>
<p style="position:absolute;top:564px;left:108px;white-space:nowrap" class="ft22650"><i>Example 15-7. tests/test_selenium.py: Framework for tests using Selenium<br/></i><b>from</b>&#160;<b>selenium</b>&#160;<b>import</b>&#160;webdriver</p>
<p style="position:absolute;top:622px;left:108px;white-space:nowrap" class="ft22647"><b>class</b>&#160;<b>SeleniumTestCase</b>(unittest.TestCase):<br/>&#160; &#160;&#160;client&#160;=&#160;None</p>
<p style="position:absolute;top:668px;left:108px;white-space:nowrap" class="ft22647">&#160; &#160;&#160;@classmethod<br/>&#160; &#160;&#160;<b>def</b>&#160;setUpClass(cls):<br/>&#160; &#160; &#160; &#160;&#160;<i># start Firefox<br/></i>&#160; &#160; &#160; &#160;&#160;<b>try</b>:<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;cls.client&#160;=&#160;webdriver.Firefox()<br/>&#160; &#160; &#160; &#160;&#160;<b>except</b>:<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>pass</b></p>
<p style="position:absolute;top:790px;left:108px;white-space:nowrap" class="ft22647">&#160; &#160; &#160; &#160;&#160;<i># skip these tests if the browser could not be started<br/></i>&#160; &#160; &#160; &#160;&#160;<b>if</b>&#160;cls.client:<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<i># create the application<br/></i>&#160; &#160; &#160; &#160; &#160; &#160;&#160;cls.app&#160;=&#160;create_app('testing')<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;cls.app_context&#160;=&#160;cls.app.app_context()<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;cls.app_context.push()</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft2265"><b>206&#160;&#160;|&#160;&#160;Chapter 15: Testing</b></p>
</div>
<!-- Page 227 -->
<a name="227"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page227-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask227.png" alt="background image"/>
<p style="position:absolute;top:98px;left:108px;white-space:nowrap" class="ft22747">&#160; &#160; &#160; &#160; &#160; &#160;&#160;<i># suppress logging to keep unittest output clean<br/></i>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>import</b>&#160;<b>logging<br/></b>&#160; &#160; &#160; &#160; &#160; &#160;&#160;logger&#160;=&#160;logging.getLogger('werkzeug')<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;logger.setLevel(&#34;ERROR&#34;)</p>
<p style="position:absolute;top:174px;left:108px;white-space:nowrap" class="ft22747">&#160; &#160; &#160; &#160; &#160; &#160;&#160;<i># create the database and populate with some fake data<br/></i>&#160; &#160; &#160; &#160; &#160; &#160;&#160;db.create_all()<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;Role.insert_roles()<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;User.generate_fake(10)<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;Post.generate_fake(10)</p>
<p style="position:absolute;top:266px;left:108px;white-space:nowrap" class="ft22747">&#160; &#160; &#160; &#160; &#160; &#160;&#160;<i># add an administrator user<br/></i>&#160; &#160; &#160; &#160; &#160; &#160;&#160;admin_role&#160;=&#160;Role.query.filter_by(permissions=0xff).first()<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;admin&#160;=&#160;User(email='john@example.com',<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;username='john',&#160;password='cat',<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;role=admin_role,&#160;confirmed=True)<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;db.session.add(admin)<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;db.session.commit()</p>
<p style="position:absolute;top:388px;left:108px;white-space:nowrap" class="ft22768">&#160; &#160; &#160; &#160; &#160; &#160;&#160;<i># start the Flask server in a thread<br/></i>&#160; &#160; &#160; &#160; &#160; &#160;&#160;threading.Thread(target=cls.app.run).start()</p>
<p style="position:absolute;top:434px;left:108px;white-space:nowrap" class="ft22747">&#160; &#160;&#160;@classmethod<br/>&#160; &#160;&#160;<b>def</b>&#160;tearDownClass(cls):<br/>&#160; &#160; &#160; &#160;&#160;<b>if</b>&#160;cls.client:<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;<i># stop the flask server and the browser<br/></i>&#160; &#160; &#160; &#160; &#160; &#160;&#160;cls.client.get('http://localhost:5000/shutdown')<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;cls.client.close()</p>
<p style="position:absolute;top:541px;left:108px;white-space:nowrap" class="ft22747">&#160; &#160; &#160; &#160; &#160; &#160;&#160;<i># destroy database<br/></i>&#160; &#160; &#160; &#160; &#160; &#160;&#160;db.drop_all()<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;db.session.remove()</p>
<p style="position:absolute;top:602px;left:108px;white-space:nowrap" class="ft22768">&#160; &#160; &#160; &#160; &#160; &#160;&#160;<i># remove application context<br/></i>&#160; &#160; &#160; &#160; &#160; &#160;&#160;cls.app_context.pop()</p>
<p style="position:absolute;top:648px;left:108px;white-space:nowrap" class="ft22747">&#160; &#160;&#160;<b>def</b>&#160;setUp(self):<br/>&#160; &#160; &#160; &#160;&#160;<b>if</b>&#160;<b>not</b>&#160;self.client:<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;self.skipTest('Web browser not available')</p>
<p style="position:absolute;top:710px;left:108px;white-space:nowrap" class="ft22747">&#160; &#160;&#160;<b>def</b>&#160;tearDown(self):<br/>&#160; &#160; &#160; &#160;&#160;<b>pass</b></p>
<p style="position:absolute;top:752px;left:108px;white-space:nowrap" class="ft22714">The&#160;setUpClass()&#160;and&#160;tearDownClass()&#160;class methods are invoked before and after</p>
<p style="position:absolute;top:771px;left:108px;white-space:nowrap" class="ft22714">the tests in this class execute. The setup involves starting an instance of Firefox through</p>
<p style="position:absolute;top:791px;left:108px;white-space:nowrap" class="ft22714">Selenium’s&#160;webdriver&#160;API and creating an application and a database with some initial</p>
<p style="position:absolute;top:811px;left:108px;white-space:nowrap" class="ft22714">data for tests to use. The application is started in a thread using the standard&#160;app.run()</p>
<p style="position:absolute;top:830px;left:108px;white-space:nowrap" class="ft22714">method. At the end the application receives a request to&#160;<i>/shutdown</i>, which causes the</p>
<p style="position:absolute;top:849px;left:108px;white-space:nowrap" class="ft22714">background thread to end. The browser is then closed and the test database removed.</p>
<p style="position:absolute;top:915px;left:448px;white-space:nowrap" class="ft2275"><b>End-to-End Testing with Selenium &#160;&#160;|&#160;&#160;207</b></p>
</div>
<!-- Page 228 -->
<a name="228"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page228-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask228.png" alt="background image"/>
<p style="position:absolute;top:83px;left:198px;white-space:nowrap" class="ft22825">Selenium&#160;supports&#160;many&#160;other&#160;web&#160;browsers&#160;besides&#160;Firefox.&#160;Con‐</p>
<p style="position:absolute;top:100px;left:198px;white-space:nowrap" class="ft22825">sult&#160;the&#160;<a href="http://bit.ly/sel-docs">Selenium&#160;documentation</a>&#160;if&#160;you&#160;wish&#160;to&#160;use&#160;a&#160;different&#160;web</p>
<p style="position:absolute;top:118px;left:198px;white-space:nowrap" class="ft22825">browser.</p>
<p style="position:absolute;top:189px;left:108px;white-space:nowrap" class="ft22814">The&#160;setUp()&#160;method that runs before each test skips tests if Selenium cannot start the</p>
<p style="position:absolute;top:209px;left:108px;white-space:nowrap" class="ft22814">web browser in the&#160;startUpClass()&#160;<a href="Flask.html#228">method. In&#160;Example 15-8</a>&#160;you can see an example</p>
<p style="position:absolute;top:228px;left:108px;white-space:nowrap" class="ft22814">test built with Selenium.</p>
<p style="position:absolute;top:260px;left:108px;white-space:nowrap" class="ft22847"><i>Example 15-8. tests/test_selenium.py: Example Selenium unit test<br/></i><b>class</b>&#160;<b>SeleniumTestCase</b>(unittest.TestCase):<br/>&#160; &#160;&#160;<i># ...</i></p>
<p style="position:absolute;top:333px;left:108px;white-space:nowrap" class="ft22847">&#160; &#160;&#160;<b>def</b>&#160;test_admin_home_page(self):<br/>&#160; &#160; &#160; &#160;&#160;<i># navigate to home page<br/></i>&#160; &#160; &#160; &#160;&#160;self.client.get('http://localhost:5000/')<br/>&#160; &#160; &#160; &#160;&#160;self.assertTrue(re.search('Hello,\s+Stranger!',<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;self.client.page_source))</p>
<p style="position:absolute;top:425px;left:108px;white-space:nowrap" class="ft22847">&#160; &#160; &#160; &#160;&#160;<i># navigate to login page<br/></i>&#160; &#160; &#160; &#160;&#160;self.client.find_element_by_link_text('Log In').click()<br/>&#160; &#160; &#160; &#160;&#160;self.assertTrue('&lt;h1&gt;Login&lt;/h1&gt;'&#160;<b>in</b>&#160;self.client.page_source)</p>
<p style="position:absolute;top:486px;left:108px;white-space:nowrap" class="ft22847">&#160; &#160; &#160; &#160;&#160;<i># login<br/></i>&#160; &#160; &#160; &#160;&#160;self.client.find_element_by_name('email').\<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;send_keys('john@example.com')<br/>&#160; &#160; &#160; &#160;&#160;self.client.find_element_by_name('password').send_keys('cat')<br/>&#160; &#160; &#160; &#160;&#160;self.client.find_element_by_name('submit').click()<br/>&#160; &#160; &#160; &#160;&#160;self.assertTrue(re.search('Hello,\s+john!',&#160;self.client.page_source))</p>
<p style="position:absolute;top:593px;left:108px;white-space:nowrap" class="ft22847">&#160; &#160; &#160; &#160;&#160;<i># navigate to the user's profile page<br/></i>&#160; &#160; &#160; &#160;&#160;self.client.find_element_by_link_text('Profile').click()<br/>&#160; &#160; &#160; &#160;&#160;self.assertTrue('&lt;h1&gt;john&lt;/h1&gt;'&#160;<b>in</b>&#160;self.client.page_source)</p>
<p style="position:absolute;top:650px;left:108px;white-space:nowrap" class="ft22846">This test logs in to the application using the administrator account that was created in<br/>setUpClass()</p>
<p style="position:absolute;top:670px;left:198px;white-space:nowrap" class="ft22814">&#160;and then opens the profile page. Note how different the testing meth‐</p>
<p style="position:absolute;top:689px;left:108px;white-space:nowrap" class="ft22814">odology is from the Flask test client. When testing with Selenium, tests send commands</p>
<p style="position:absolute;top:708px;left:108px;white-space:nowrap" class="ft22814">to the web browser and never interact with the application directly. The commands</p>
<p style="position:absolute;top:727px;left:108px;white-space:nowrap" class="ft22848">closely match the actions that a real user would perform with mouse or keyboard.<br/>The test begins with a call to&#160;get()&#160;with the home page of the application. In the browser,</p>
<p style="position:absolute;top:775px;left:108px;white-space:nowrap" class="ft22814">this causes the URL to be entered in the address bar. To verify this step, the page source</p>
<p style="position:absolute;top:793px;left:108px;white-space:nowrap" class="ft22846">is checked for the “Hello, Stranger!” greeting.<br/>To go to the sign-in page, the test looks for the “Log In” link using<br/>find_element_by_link_text()</p>
<p style="position:absolute;top:841px;left:311px;white-space:nowrap" class="ft22814">&#160;and then calls&#160;click()&#160;on it to trigger a real click in</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft2285"><b>208&#160;&#160;|&#160;&#160;Chapter 15: Testing</b></p>
</div>
<!-- Page 229 -->
<a name="229"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page229-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask229.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft22914">the browser. Selenium provides several&#160;find_element_by...()&#160;convenience methods</p>
<p style="position:absolute;top:98px;left:108px;white-space:nowrap" class="ft22915">that can search for elements in different ways.<br/>To log in to the application, the test locates the email and password form fields by their</p>
<p style="position:absolute;top:146px;left:108px;white-space:nowrap" class="ft22946">names using&#160;find_element_by_name()&#160;and then writes text into them with<br/>send_keys()</p>
<p style="position:absolute;top:166px;left:191px;white-space:nowrap" class="ft22914">. The form is submitted by calling&#160;click()&#160;on the submit button. The</p>
<p style="position:absolute;top:185px;left:108px;white-space:nowrap" class="ft22914">personalized greeting is checked to ensure that the login was successful and the browser</p>
<p style="position:absolute;top:204px;left:108px;white-space:nowrap" class="ft22915">is now on the home page.<br/>The final part of the test locates the “Profile” link in the navigation bar and clicks it. To</p>
<p style="position:absolute;top:250px;left:108px;white-space:nowrap" class="ft22914">verify that the profile page was loaded, the heading with the username is searched in</p>
<p style="position:absolute;top:269px;left:108px;white-space:nowrap" class="ft22914">the page source.</p>
<p style="position:absolute;top:311px;left:198px;white-space:nowrap" class="ft22925">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:329px;left:198px;white-space:nowrap" class="ft22925">run&#160;git&#160;checkout&#160;15d&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:346px;left:198px;white-space:nowrap" class="ft22931">This&#160;update&#160;contains&#160;a&#160;database&#160;migration,&#160;so&#160;remember&#160;to&#160;run<br/>python&#160;manage.py&#160;db&#160;upgrade</p>
<p style="position:absolute;top:364px;left:390px;white-space:nowrap" class="ft22925">&#160;after&#160;you&#160;check&#160;out&#160;the&#160;code.&#160;To</p>
<p style="position:absolute;top:382px;left:198px;white-space:nowrap" class="ft22980">ensure&#160;that&#160;you&#160;have&#160;all&#160;the&#160;dependencies&#160;installed,&#160;also&#160;run&#160;pip<br/>install&#160;-r&#160;requirements/dev.txt</p>
<p style="position:absolute;top:400px;left:410px;white-space:nowrap" class="ft22925">.</p>
<p style="position:absolute;top:442px;left:108px;white-space:nowrap" class="ft22918"><b>Is It Worth It?<br/></b>By now you may be asking if testing using the Flask test client or Selenium is really</p>
<p style="position:absolute;top:501px;left:108px;white-space:nowrap" class="ft22915">worth the trouble. It is a valid question, and it does not have a simple answer.<br/>Whether you like it or not, your application will be tested. If you don’t test it yourself,</p>
<p style="position:absolute;top:548px;left:108px;white-space:nowrap" class="ft22914">then your users will become the unwilling testers that will be finding the bugs, and then</p>
<p style="position:absolute;top:567px;left:108px;white-space:nowrap" class="ft22914">you will have to fix bugs under pressure. Simple and focused tests like the ones that</p>
<p style="position:absolute;top:586px;left:108px;white-space:nowrap" class="ft22914">exercise database models and other parts of the application that can be executed outside</p>
<p style="position:absolute;top:605px;left:108px;white-space:nowrap" class="ft22914">of the context of an application should always be used, as they have a very low cost and</p>
<p style="position:absolute;top:624px;left:108px;white-space:nowrap" class="ft22915">ensure the proper functioning of the core pieces of application logic.<br/>End-to-end tests of the type that the Flask test client and Selenium can carry out are</p>
<p style="position:absolute;top:670px;left:108px;white-space:nowrap" class="ft22914">sometimes necessary, but due to the increased complexity to write them, they should</p>
<p style="position:absolute;top:689px;left:108px;white-space:nowrap" class="ft22914">be used only for functionality that cannot be tested in isolation. The application code</p>
<p style="position:absolute;top:708px;left:108px;white-space:nowrap" class="ft22914">should be organized so that it is possible to push as much of the business logic as possible</p>
<p style="position:absolute;top:727px;left:108px;white-space:nowrap" class="ft22914">into database models or other auxiliary classes that are independent of the context of</p>
<p style="position:absolute;top:746px;left:108px;white-space:nowrap" class="ft22914">the application and thus can be tested easily. The code that exists in view functions</p>
<p style="position:absolute;top:765px;left:108px;white-space:nowrap" class="ft22914">should be simple and just act as a thin layer that accepts requests and invokes the cor‐</p>
<p style="position:absolute;top:784px;left:108px;white-space:nowrap" class="ft22915">responding actions in other classes or functions that encapsulate the application logic.<br/>So yes, testing is absolutely worth it. But it is important to design an efficient testing</p>
<p style="position:absolute;top:831px;left:108px;white-space:nowrap" class="ft22914">strategy and write code that can take advantage of it.</p>
<p style="position:absolute;top:915px;left:542px;white-space:nowrap" class="ft2295"><b>Is It Worth It?&#160;&#160;|&#160;&#160;209</b></p>
</div>
<!-- Page 230 -->
<a name="230"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page230-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask230.png" alt="background image"/>
</div>
<!-- Page 231 -->
<a name="231"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page231-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask231.png" alt="background image"/>
<p style="position:absolute;top:104px;left:549px;white-space:nowrap" class="ft23128"><b>CHAPTER 16</b></p>
<p style="position:absolute;top:131px;left:488px;white-space:nowrap" class="ft23111"><b>Performance</b></p>
<p style="position:absolute;top:345px;left:108px;white-space:nowrap" class="ft23114">Nobody likes slow applications. Long waits for pages to load frustrate users, so it is</p>
<p style="position:absolute;top:364px;left:108px;white-space:nowrap" class="ft23114">important to detect and correct performance problems as soon as they appear. In this</p>
<p style="position:absolute;top:383px;left:108px;white-space:nowrap" class="ft23114">chapter, two important performance aspects of web applications are considered.</p>
<p style="position:absolute;top:420px;left:108px;white-space:nowrap" class="ft23122"><b>Logging Slow Database Performance&#160;<br/></b>When application performance slowly degenerates with time, it is likely due to slow</p>
<p style="position:absolute;top:481px;left:108px;white-space:nowrap" class="ft23114">database queries, which get worse as the size of the database grows. Optimizing database</p>
<p style="position:absolute;top:500px;left:108px;white-space:nowrap" class="ft23114">queries can be as simple as adding more indexes or as complex as adding a cache between</p>
<p style="position:absolute;top:519px;left:108px;white-space:nowrap" class="ft23114">the application and the database. The&#160;explain&#160;statement, available in most database</p>
<p style="position:absolute;top:538px;left:108px;white-space:nowrap" class="ft23114">query languages, shows the steps the database takes to execute a given query, often</p>
<p style="position:absolute;top:557px;left:108px;white-space:nowrap" class="ft23115">exposing inefficiencies in database or index design.<br/>But before starting to optimize queries, it is necessary to determine which queries are</p>
<p style="position:absolute;top:604px;left:108px;white-space:nowrap" class="ft23114">the ones that are worth optimizing. During a typical request several database queries</p>
<p style="position:absolute;top:623px;left:108px;white-space:nowrap" class="ft23114">may be issued, so it is often hard to identify which of all the queries are the slow ones.</p>
<p style="position:absolute;top:642px;left:108px;white-space:nowrap" class="ft23114">Flask-SQLAlchemy has an option to record statistics about database queries issued</p>
<p style="position:absolute;top:661px;left:108px;white-space:nowrap" class="ft23114"><a href="Flask.html#231">during a request. In&#160;Example 16-1&#160;you can see how this fea</a>ture can be used to&#160;<i>log</i>&#160;queries</p>
<p style="position:absolute;top:680px;left:108px;white-space:nowrap" class="ft23114">that are slower than a configured threshold.&#160;</p>
<p style="position:absolute;top:711px;left:108px;white-space:nowrap" class="ft23150"><i>Example 16-1. app/main/views.py: Report slow database queries<br/></i><b>from</b>&#160;<b>flask.ext.sqlalchemy</b>&#160;<b>import</b>&#160;get_debug_queries</p>
<p style="position:absolute;top:770px;left:108px;white-space:nowrap" class="ft23156">@main.after_app_request<br/><b>def</b>&#160;after_request(response):<br/>&#160; &#160;&#160;<b>for</b>&#160;query&#160;<b>in</b>&#160;get_debug_queries():<br/>&#160; &#160; &#160; &#160;&#160;<b>if</b>&#160;query.duration&#160;&gt;=&#160;current_app.config['FLASKY_SLOW_DB_QUERY_TIME']:<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;current_app.logger.warning(<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;'Slow query:&#160;%s<b>\n</b>Parameters:&#160;%s<b>\n</b>Duration:&#160;%fs<b>\n</b>Context:&#160;%s<b>\n</b>'&#160;%<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;(query.statement,&#160;query.parameters,&#160;query.duration,</p>
<p style="position:absolute;top:915px;left:631px;white-space:nowrap" class="ft2315"><b>211</b></p>
</div>
<!-- Page 232 -->
<a name="232"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page232-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask232.png" alt="background image"/>
<p style="position:absolute;top:82px;left:108px;white-space:nowrap" class="ft23247">&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;query.context))<br/>&#160; &#160;&#160;<b>return</b>&#160;response</p>
<p style="position:absolute;top:125px;left:108px;white-space:nowrap" class="ft23214">This functionality is attached to an&#160;after_app_request&#160;handler, which works in a sim‐</p>
<p style="position:absolute;top:145px;left:108px;white-space:nowrap" class="ft23214">ilar way to the&#160;before_app_request&#160;handler, but is invoked after the view function that</p>
<p style="position:absolute;top:165px;left:108px;white-space:nowrap" class="ft23214">handles the request returns. Flask passes the response object to the&#160;after_app_request</p>
<p style="position:absolute;top:184px;left:108px;white-space:nowrap" class="ft23248">handler in case it needs to be modified.<br/>In this case, the&#160;after_app_request&#160;handler does not modify the response; it just gets</p>
<p style="position:absolute;top:231px;left:108px;white-space:nowrap" class="ft23248">the query timings recorded by Flask-SQLAlchemy and logs any of the slow ones.<br/>The&#160;get_debug_queries()&#160;function returns the queries issued during the request as a</p>
<p style="position:absolute;top:279px;left:108px;white-space:nowrap" class="ft23248">list. The information provided for each query is shown in&#160;<a href="Flask.html#232">Table 16-1.<br/></a><i>Table 16-1. Query statistics recorded by Flask-SQLAlchemy</i></p>
<p style="position:absolute;top:336px;left:113px;white-space:nowrap" class="ft23253"><b>Name</b></p>
<p style="position:absolute;top:336px;left:199px;white-space:nowrap" class="ft23253"><b>Description</b></p>
<p style="position:absolute;top:360px;left:113px;white-space:nowrap" class="ft23214">statement</p>
<p style="position:absolute;top:357px;left:199px;white-space:nowrap" class="ft23230">The&#160;SQL&#160;statement</p>
<p style="position:absolute;top:384px;left:113px;white-space:nowrap" class="ft23214">parameters&#160;The&#160;parameters&#160;used&#160;with&#160;the&#160;SQL&#160;statement</p>
<p style="position:absolute;top:408px;left:113px;white-space:nowrap" class="ft23214">start_time&#160;The&#160;time&#160;the&#160;query&#160;was&#160;issued</p>
<p style="position:absolute;top:432px;left:113px;white-space:nowrap" class="ft23214">end_time</p>
<p style="position:absolute;top:430px;left:199px;white-space:nowrap" class="ft23230">The&#160;time&#160;the&#160;query&#160;returned</p>
<p style="position:absolute;top:456px;left:113px;white-space:nowrap" class="ft23214">duration</p>
<p style="position:absolute;top:454px;left:199px;white-space:nowrap" class="ft23230">The&#160;duration&#160;of&#160;the&#160;query&#160;in&#160;seconds</p>
<p style="position:absolute;top:480px;left:113px;white-space:nowrap" class="ft23214">context</p>
<p style="position:absolute;top:478px;left:199px;white-space:nowrap" class="ft23230">A&#160;string&#160;that&#160;indicates&#160;the&#160;source&#160;code&#160;location&#160;where&#160;the&#160;query&#160;was&#160;issued</p>
<p style="position:absolute;top:514px;left:108px;white-space:nowrap" class="ft23214">The&#160;after_app_request&#160;handler walks the list and logs any queries that lasted longer</p>
<p style="position:absolute;top:533px;left:108px;white-space:nowrap" class="ft23214">than a threshold given in the configuration. The logging is issued at the warning level.</p>
<p style="position:absolute;top:552px;left:108px;white-space:nowrap" class="ft23214">Changing the level to “error” would cause all slow query occurrences to be emailed as</p>
<p style="position:absolute;top:571px;left:108px;white-space:nowrap" class="ft23248">well.<br/>The&#160;get_debug_queries()&#160;function is enabled only in debug mode by default. Un‐</p>
<p style="position:absolute;top:619px;left:108px;white-space:nowrap" class="ft23214">fortunately, database performance problems rarely show up during development be‐</p>
<p style="position:absolute;top:637px;left:108px;white-space:nowrap" class="ft23214">cause much smaller databases are used. For this reason, it is useful to use this option in</p>
<p style="position:absolute;top:656px;left:108px;white-space:nowrap" class="ft23214"><a href="Flask.html#232">production.&#160;Example 16-2</a>&#160;shows the configuration changes that are necessary to enable</p>
<p style="position:absolute;top:675px;left:108px;white-space:nowrap" class="ft23214">database query performance in production mode.</p>
<p style="position:absolute;top:707px;left:108px;white-space:nowrap" class="ft23276"><i>Example 16-2. config.py: Configuration for slow query reporting<br/></i><b>class</b>&#160;<b>Config</b>:<br/>&#160; &#160;&#160;<i># ...<br/></i>&#160; &#160;&#160;SQLALCHEMY_RECORD_QUERIES&#160;=&#160;True<br/>&#160; &#160;&#160;FLASKY_DB_QUERY_TIMEOUT&#160;=&#160;0.5<br/>&#160; &#160;&#160;<i># ...</i></p>
<p style="position:absolute;top:827px;left:108px;white-space:nowrap" class="ft23214">SQLALCHEMY_RECORD_QUERIES</p>
<p style="position:absolute;top:823px;left:295px;white-space:nowrap" class="ft23214">&#160;tells Flask-SQLAlchemy to enable the recording of query</p>
<p style="position:absolute;top:842px;left:108px;white-space:nowrap" class="ft23214">statistics. The slow query threshold is set to half a second. Both configuration variables</p>
<p style="position:absolute;top:862px;left:108px;white-space:nowrap" class="ft23214">were included in the base&#160;Config&#160;class, so they will be enabled for all configurations.</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft2325"><b>212&#160;&#160;|&#160;&#160;Chapter 16: Performance</b></p>
</div>
<!-- Page 233 -->
<a name="233"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page233-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask233.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft23314">Whenever a slow query is detected, an entry will be written to Flask’s application logger.</p>
<p style="position:absolute;top:97px;left:108px;white-space:nowrap" class="ft23314">To be able to store these log entries, the logger must be configured. The logging con‐</p>
<p style="position:absolute;top:116px;left:108px;white-space:nowrap" class="ft23314">figuration largely depends on the platform that hosts the application. Some examples</p>
<p style="position:absolute;top:135px;left:108px;white-space:nowrap" class="ft23314">are shown in&#160;<a href="Flask.html#235">Chapter 17</a>.</p>
<p style="position:absolute;top:177px;left:198px;white-space:nowrap" class="ft23325">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:195px;left:198px;white-space:nowrap" class="ft23325">run&#160;git&#160;checkout&#160;16a&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:280px;left:108px;white-space:nowrap" class="ft23322"><b>Source Code Profiling&#160;<br/></b>Another possible source of performance problems is high CPU consumption, caused</p>
<p style="position:absolute;top:340px;left:108px;white-space:nowrap" class="ft23314">by functions that perform heavy computing. Source code profilers are useful in finding</p>
<p style="position:absolute;top:359px;left:108px;white-space:nowrap" class="ft23314">the slowest parts of an application. A profiler watches a running application and records</p>
<p style="position:absolute;top:378px;left:108px;white-space:nowrap" class="ft23314">the functions that are called and how long each takes to run. It then produces a detailed</p>
<p style="position:absolute;top:397px;left:108px;white-space:nowrap" class="ft23314">report showing the slowest functions.</p>
<p style="position:absolute;top:436px;left:198px;white-space:nowrap" class="ft23325">Profiling&#160;is&#160;typically&#160;done&#160;in&#160;a&#160;development&#160;environment.&#160;A&#160;source</p>
<p style="position:absolute;top:454px;left:198px;white-space:nowrap" class="ft23325">code&#160;profiler&#160;makes&#160;the&#160;application&#160;run&#160;slower&#160;because&#160;it&#160;has&#160;to&#160;ob‐</p>
<p style="position:absolute;top:471px;left:198px;white-space:nowrap" class="ft23325">serve&#160;and&#160;take&#160;notes&#160;of&#160;all&#160;that&#160;is&#160;happening.&#160;Profiling&#160;on&#160;a&#160;produc‐</p>
<p style="position:absolute;top:488px;left:198px;white-space:nowrap" class="ft23325">tion&#160;system&#160;is&#160;not&#160;recommended,&#160;unless&#160;a&#160;lightweight&#160;profiler&#160;specif‐</p>
<p style="position:absolute;top:506px;left:198px;white-space:nowrap" class="ft23325">ically&#160;designed&#160;to&#160;run&#160;on&#160;a&#160;production&#160;environment&#160;is&#160;used.</p>
<p style="position:absolute;top:551px;left:108px;white-space:nowrap" class="ft23314">Flask’s development web server, which comes from Werkzeug, can optionally enable</p>
<p style="position:absolute;top:570px;left:108px;white-space:nowrap" class="ft23314">the Python profiler for each request.&#160;<a href="Flask.html#233">Example 16-3&#160;</a>adds a new command-line option</p>
<p style="position:absolute;top:589px;left:108px;white-space:nowrap" class="ft23314">to the application that starts the profiler.</p>
<p style="position:absolute;top:621px;left:108px;white-space:nowrap" class="ft23347"><i>Example 16-3. manage.py: Run the application under the request profiler<br/></i>@manager.command<br/><b>def</b>&#160;profile(length=25,&#160;profile_dir=None):<br/>&#160; &#160;&#160;<i>&#34;&#34;&#34;Start the application under the code profiler.&#34;&#34;&#34;<br/></i>&#160; &#160;&#160;<b>from</b>&#160;<b>werkzeug.contrib.profiler</b>&#160;<b>import</b>&#160;ProfilerMiddleware<br/>&#160; &#160;&#160;app.wsgi_app&#160;=&#160;ProfilerMiddleware(app.wsgi_app,&#160;restrictions=[length],<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;profile_dir=profile_dir)<br/>&#160; &#160;&#160;app.run()</p>
<p style="position:absolute;top:775px;left:198px;white-space:nowrap" class="ft23325">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:793px;left:198px;white-space:nowrap" class="ft23325">run&#160;git&#160;checkout&#160;16b&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:915px;left:505px;white-space:nowrap" class="ft2335"><b>Source Code Profiling &#160;&#160;|&#160;&#160;213</b></p>
</div>
<!-- Page 234 -->
<a name="234"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page234-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask234.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft23414">When the application is started with&#160;python manage.py profile, the console will show</p>
<p style="position:absolute;top:98px;left:108px;white-space:nowrap" class="ft23446">the profiler statistics for each request, which will include the slowest 25 functions. The<br/>--length</p>
<p style="position:absolute;top:118px;left:168px;white-space:nowrap" class="ft23414">&#160;option can be used to change the number of functions shown in the report.</p>
<p style="position:absolute;top:138px;left:108px;white-space:nowrap" class="ft23414">If the&#160;--profile-dir&#160;option is given, the profile data for each request will be saved to</p>
<p style="position:absolute;top:157px;left:108px;white-space:nowrap" class="ft23414">a file in the given directory. The profiler data files can be used to generate more detailed</p>
<p style="position:absolute;top:176px;left:108px;white-space:nowrap" class="ft23414">reports that include a&#160;<i>call graph</i>. For more information on the Python profiler, consult</p>
<p style="position:absolute;top:195px;left:108px;white-space:nowrap" class="ft23415"><a href="http://bit.ly/py-profile">the&#160;official documentation.<br/></a>The preparations for deployment are complete. The next chapter will give you an over‐</p>
<p style="position:absolute;top:241px;left:108px;white-space:nowrap" class="ft23414">view of what to expect when deploying your application.</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft2345"><b>214&#160;&#160;|&#160;&#160;Chapter 16: Performance</b></p>
</div>
<!-- Page 235 -->
<a name="235"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page235-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask235.png" alt="background image"/>
<p style="position:absolute;top:104px;left:549px;white-space:nowrap" class="ft23528"><b>CHAPTER 17</b></p>
<p style="position:absolute;top:131px;left:495px;white-space:nowrap" class="ft23511"><b>Deployment</b></p>
<p style="position:absolute;top:345px;left:108px;white-space:nowrap" class="ft23514">The web development server that comes bundled with Flask is not robust, secure, or</p>
<p style="position:absolute;top:364px;left:108px;white-space:nowrap" class="ft23514">efficient enough to work in a production environment. In this chapter, deployment</p>
<p style="position:absolute;top:383px;left:108px;white-space:nowrap" class="ft23514">options for Flask applications are examined.</p>
<p style="position:absolute;top:420px;left:108px;white-space:nowrap" class="ft23522"><b>Deployment Workflow&#160;<br/></b>Regardless of the hosting method used, there are a series of tasks that must be carried</p>
<p style="position:absolute;top:481px;left:108px;white-space:nowrap" class="ft23514">out when the application is installed on a production server. The best example is the</p>
<p style="position:absolute;top:500px;left:108px;white-space:nowrap" class="ft23515">creation or update of the database tables.<br/>Having to run these tasks manually each time the application is installed or upgraded</p>
<p style="position:absolute;top:546px;left:108px;white-space:nowrap" class="ft23514">is error prone and time consuming, so instead a command that performs all the required</p>
<p style="position:absolute;top:565px;left:108px;white-space:nowrap" class="ft23548">tasks can be added to&#160;<i>manage.py</i>.<br/><a href="Flask.html#235">Example 17-1</a>&#160;shows a&#160;deploy&#160;command implementation that is appropriate for Flasky.</p>
<p style="position:absolute;top:626px;left:108px;white-space:nowrap" class="ft23523"><i>Example 17-1. manage.py: deploy command<br/></i>@manager.command<br/>def deploy():<br/>&#160; &#160; &#34;&#34;&#34;Run deployment tasks.&#34;&#34;&#34;<br/>&#160; &#160; from flask.ext.migrate import upgrade<br/>&#160; &#160; from app.models import Role, User</p>
<p style="position:absolute;top:746px;left:108px;white-space:nowrap" class="ft23523">&#160; &#160; # migrate database to latest revision<br/>&#160; &#160; upgrade()</p>
<p style="position:absolute;top:791px;left:108px;white-space:nowrap" class="ft23523">&#160; &#160; # create user roles<br/>&#160; &#160; Role.insert_roles()</p>
<p style="position:absolute;top:837px;left:108px;white-space:nowrap" class="ft23523">&#160; &#160; # create self-follows for all users<br/>&#160; &#160; User.add_self_follows()</p>
<p style="position:absolute;top:915px;left:631px;white-space:nowrap" class="ft2355"><b>215</b></p>
</div>
<!-- Page 236 -->
<a name="236"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page236-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask236.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft23614">The functions invoked by this command were all created before; they are just invoked</p>
<p style="position:absolute;top:97px;left:108px;white-space:nowrap" class="ft23614">all together.</p>
<p style="position:absolute;top:139px;left:198px;white-space:nowrap" class="ft23625">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:157px;left:198px;white-space:nowrap" class="ft23625">run&#160;git&#160;checkout&#160;17a&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:245px;left:108px;white-space:nowrap" class="ft23614">These functions are all designed in a way that causes no problems if they are executed</p>
<p style="position:absolute;top:264px;left:108px;white-space:nowrap" class="ft23646">multiple times. Designing update functions in this way makes it possible to run just this<br/>deploy</p>
<p style="position:absolute;top:284px;left:153px;white-space:nowrap" class="ft23614">&#160;command every time an installation or upgrade is done.</p>
<p style="position:absolute;top:321px;left:108px;white-space:nowrap" class="ft23622"><b>Logging of Errors During Production&#160;<br/></b>When the application is running in debug mode, Werkzeug’s interactive debugger ap‐</p>
<p style="position:absolute;top:381px;left:108px;white-space:nowrap" class="ft23614">pears whenever an error occurs. The&#160;<i>stack trace</i>&#160;of the error is displayed on the web</p>
<p style="position:absolute;top:400px;left:108px;white-space:nowrap" class="ft23614">page and it is possible to look at the source code and even evaluate expressions in the</p>
<p style="position:absolute;top:419px;left:108px;white-space:nowrap" class="ft23615">context of each stack frame using Flask’s interactive web-based debugger.<br/>The debugger is an excellent tool to debug application problems during development,</p>
<p style="position:absolute;top:466px;left:108px;white-space:nowrap" class="ft23614">but obviously it cannot be used in a production deployment. Errors that occur in pro‐</p>
<p style="position:absolute;top:485px;left:108px;white-space:nowrap" class="ft23614">duction are silenced and instead the user receives a code 500 error page. But luckily, the</p>
<p style="position:absolute;top:504px;left:108px;white-space:nowrap" class="ft23648">stack traces of these errors are not completely lost, as Flask writes them to a&#160;<i>log file</i>.<br/>During startup, Flask creates an instance of Python’s&#160;logging.Logger&#160;class and attaches</p>
<p style="position:absolute;top:553px;left:108px;white-space:nowrap" class="ft23614">it to the application instance as&#160;app.logger. In debug mode, this logger writes to the</p>
<p style="position:absolute;top:571px;left:108px;white-space:nowrap" class="ft23614">console, but in production mode there are no handlers configured for it by default, so</p>
<p style="position:absolute;top:590px;left:108px;white-space:nowrap" class="ft23614">unless a handler is added logs are not stored. The changes in&#160;<a href="Flask.html#236">Example 17-2</a>&#160;configure a</p>
<p style="position:absolute;top:609px;left:108px;white-space:nowrap" class="ft23614">logging handler that sends the errors that occur while running in production mode to</p>
<p style="position:absolute;top:629px;left:108px;white-space:nowrap" class="ft23614">the list administrator emails configured in the&#160;FLASKY_ADMIN&#160;setting.</p>
<p style="position:absolute;top:661px;left:108px;white-space:nowrap" class="ft23647"><i>Example 17-2. config.py: Send email for application errors<br/></i><b>class</b>&#160;<b>ProductionConfig</b>(Config):<br/>&#160; &#160;&#160;<i># ...<br/></i>&#160; &#160;&#160;@classmethod<br/>&#160; &#160;&#160;<b>def</b>&#160;init_app(cls,&#160;app):<br/>&#160; &#160; &#160; &#160;&#160;Config.init_app(app)</p>
<p style="position:absolute;top:780px;left:108px;white-space:nowrap" class="ft23647">&#160; &#160; &#160; &#160;&#160;<i># email errors to the administrators<br/></i>&#160; &#160; &#160; &#160;&#160;<b>import</b>&#160;<b>logging<br/></b>&#160; &#160; &#160; &#160;&#160;<b>from</b>&#160;<b>logging.handlers</b>&#160;<b>import</b>&#160;SMTPHandler<br/>&#160; &#160; &#160; &#160;&#160;credentials&#160;=&#160;None<br/>&#160; &#160; &#160; &#160;&#160;secure&#160;=&#160;None<br/>&#160; &#160; &#160; &#160;&#160;<b>if</b>&#160;getattr(cls,&#160;'MAIL_USERNAME',&#160;None)&#160;<b>is</b>&#160;<b>not</b>&#160;None:<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;credentials&#160;=&#160;(cls.MAIL_USERNAME,&#160;cls.MAIL_PASSWORD)</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft2365"><b>216&#160;&#160;|&#160;&#160;Chapter 17: Deployment</b></p>
</div>
<!-- Page 237 -->
<a name="237"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page237-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask237.png" alt="background image"/>
<p style="position:absolute;top:82px;left:108px;white-space:nowrap" class="ft23747">&#160; &#160; &#160; &#160; &#160; &#160;&#160;<b>if</b>&#160;getattr(cls,&#160;'MAIL_USE_TLS',&#160;None):<br/>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;secure&#160;=&#160;()<br/>&#160; &#160; &#160; &#160;&#160;mail_handler&#160;=&#160;SMTPHandler(<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;mailhost=(cls.MAIL_SERVER,&#160;cls.MAIL_PORT),<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;fromaddr=cls.FLASKY_MAIL_SENDER,<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;toaddrs=[cls.FLASKY_ADMIN],<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;subject=cls.FLASKY_MAIL_SUBJECT_PREFIX&#160;+&#160;' Application Error',<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;credentials=credentials,<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;secure=secure)<br/>&#160; &#160; &#160; &#160;&#160;mail_handler.setLevel(logging.ERROR)<br/>&#160; &#160; &#160; &#160;&#160;app.logger.addHandler(mail_handler)</p>
<p style="position:absolute;top:263px;left:108px;white-space:nowrap" class="ft23714">Recall that all configuration instances have a&#160;init_app()&#160;static method that is invoked</p>
<p style="position:absolute;top:282px;left:108px;white-space:nowrap" class="ft23714">by&#160;create_app(). In the implementation of this method for the&#160;ProductionConfig</p>
<p style="position:absolute;top:301px;left:108px;white-space:nowrap" class="ft23748">class, the application logger is configured to log errors to an email logger.<br/>The logging level of the email logger is set to&#160;logging.ERROR, so only severe problems</p>
<p style="position:absolute;top:349px;left:108px;white-space:nowrap" class="ft23714">are sent by email. Messages logged on lesser levels can be logged to a file, syslog, or any</p>
<p style="position:absolute;top:368px;left:108px;white-space:nowrap" class="ft23714">other supported method by adding the proper logging handlers. The logging method</p>
<p style="position:absolute;top:387px;left:108px;white-space:nowrap" class="ft23714">to use for these messages largely depends on the hosting platform.</p>
<p style="position:absolute;top:429px;left:198px;white-space:nowrap" class="ft23725">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:447px;left:198px;white-space:nowrap" class="ft23725">run&#160;git&#160;checkout&#160;17b&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:532px;left:108px;white-space:nowrap" class="ft23722"><b>Cloud Deployment&#160;<br/></b>The latest trend in application hosting is to host in the “cloud.” This technology, which</p>
<p style="position:absolute;top:592px;left:108px;white-space:nowrap" class="ft23714">is formally known as Platform as a Service (PaaS), frees the application developer from</p>
<p style="position:absolute;top:611px;left:108px;white-space:nowrap" class="ft23714">the mundane tasks of installing and maintaining the hardware and software platforms</p>
<p style="position:absolute;top:630px;left:108px;white-space:nowrap" class="ft23714">on which the application runs. In the PaaS model, a service provider offers a fully man‐</p>
<p style="position:absolute;top:649px;left:108px;white-space:nowrap" class="ft23714">aged platform in which applications can run. The application developer uses tools and</p>
<p style="position:absolute;top:668px;left:108px;white-space:nowrap" class="ft23714">libraries from the provider to integrate the application with the platform. The applica‐</p>
<p style="position:absolute;top:687px;left:108px;white-space:nowrap" class="ft23714">tion is then uploaded to the servers maintained by the provider and usually is deployed</p>
<p style="position:absolute;top:706px;left:108px;white-space:nowrap" class="ft23714">within seconds. Most PaaS providers offer ways to dynamically “scale” the application</p>
<p style="position:absolute;top:724px;left:108px;white-space:nowrap" class="ft23714">by adding or removing servers as necessary to keep up with the number of requests</p>
<p style="position:absolute;top:743px;left:108px;white-space:nowrap" class="ft23715">received.<br/>Cloud deployments offer great flexibility and are relatively simple to set up, but of course</p>
<p style="position:absolute;top:790px;left:108px;white-space:nowrap" class="ft23714">all that goodness comes at a price. Heroku, one of the most popular PaaS providers that</p>
<p style="position:absolute;top:809px;left:108px;white-space:nowrap" class="ft23714">offers very good support for Python, is studied in detail in the following section.</p>
<p style="position:absolute;top:915px;left:518px;white-space:nowrap" class="ft2375"><b>Cloud Deployment &#160;&#160;|&#160;&#160;217</b></p>
</div>
<!-- Page 238 -->
<a name="238"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft23888{font-size:15px;font-family:Times;color:#231f20;}
	.ft23889{font-size:15px;line-height:26px;font-family:Times;color:#231f20;}
-->
</style>
<div id="page238-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask238.png" alt="background image"/>
<p style="position:absolute;top:75px;left:108px;white-space:nowrap" class="ft23822"><b>The Heroku Platform&#160;<br/></b>Heroku was one of the first PaaS providers, having been in business since 2007. The</p>
<p style="position:absolute;top:136px;left:108px;white-space:nowrap" class="ft23814">Heroku platform is very flexible and supports a long list of programming languages. To</p>
<p style="position:absolute;top:155px;left:108px;white-space:nowrap" class="ft23814">deploy an application to Heroku, the developer uses Git to push the application to</p>
<p style="position:absolute;top:175px;left:108px;white-space:nowrap" class="ft23814">Heroku’s own Git server. On the server the&#160;git push&#160;command automatically triggers</p>
<p style="position:absolute;top:193px;left:108px;white-space:nowrap" class="ft23815">the installation, configuration, and deployment.<br/>Heroku uses units of computing called&#160;<i>dynos</i>&#160;to measure usage and charge for the ser‐</p>
<p style="position:absolute;top:240px;left:108px;white-space:nowrap" class="ft23814">vice. The most common type of dyno is the&#160;<i>web dyno</i>, which represents a web server</p>
<p style="position:absolute;top:259px;left:108px;white-space:nowrap" class="ft23814">instance. An application can increase its request handling capacity by using more web</p>
<p style="position:absolute;top:278px;left:108px;white-space:nowrap" class="ft23814">dynos. The other type of dyno is the&#160;<i>worker dyno</i>, which is used to perform background</p>
<p style="position:absolute;top:297px;left:108px;white-space:nowrap" class="ft23815">jobs or other support tasks.<br/>The platform provides a large number of plug-ins and add-ons for databases, email</p>
<p style="position:absolute;top:344px;left:108px;white-space:nowrap" class="ft23814">support, and many other services. The following sections expand on some of the details</p>
<p style="position:absolute;top:363px;left:108px;white-space:nowrap" class="ft23814">involved in deploying Flasky to Heroku.</p>
<p style="position:absolute;top:398px;left:108px;white-space:nowrap" class="ft23858"><b>Preparing the Application<br/></b>To work with Heroku, the application must be hosted in a Git repository. If you are</p>
<p style="position:absolute;top:451px;left:108px;white-space:nowrap" class="ft23814">working with an application that is hosted on a remote Git server such as GitHub or</p>
<p style="position:absolute;top:470px;left:108px;white-space:nowrap" class="ft23814">BitBucket, cloning the application will create a local Git repository that is perfect to use</p>
<p style="position:absolute;top:489px;left:108px;white-space:nowrap" class="ft23814">with Heroku. If the application isn’t already hosted on a Git repository, one must be</p>
<p style="position:absolute;top:508px;left:108px;white-space:nowrap" class="ft23814">created for it on your development machine.</p>
<p style="position:absolute;top:549px;left:198px;white-space:nowrap" class="ft23825">If&#160;you&#160;plan&#160;on&#160;hosting&#160;your&#160;application&#160;on&#160;Heroku,&#160;it&#160;is&#160;a&#160;good&#160;idea</p>
<p style="position:absolute;top:566px;left:198px;white-space:nowrap" class="ft23825">to&#160;start&#160;using&#160;Git&#160;from&#160;the&#160;very&#160;beginning.&#160;GitHub&#160;has&#160;installation</p>
<p style="position:absolute;top:584px;left:198px;white-space:nowrap" class="ft23825">and&#160;setup&#160;guides&#160;for&#160;the&#160;three&#160;major&#160;operating&#160;systems&#160;in&#160;their&#160;<a href="http://help.github.com">help</a></p>
<p style="position:absolute;top:601px;left:198px;white-space:nowrap" class="ft23835"><a href="http://help.github.com">guide.</a></p>
<p style="position:absolute;top:654px;left:108px;white-space:nowrap" class="ft23889"><b>Creating a Heroku account<br/></b><a href="http://heroku.com">You must create an account with Heroku&#160;</a>before you can use the service. You can sign</p>
<p style="position:absolute;top:699px;left:108px;white-space:nowrap" class="ft23814">up and host applications at the lowest service tier at no cost, so this is a great platform</p>
<p style="position:absolute;top:718px;left:108px;white-space:nowrap" class="ft23814">to experiment with.</p>
<p style="position:absolute;top:755px;left:108px;white-space:nowrap" class="ft23889"><b>Installing the Heroku Toolbelt&#160;<br/></b>The most convenient way to manage your Heroku applications is through the Heroku</p>
<p style="position:absolute;top:801px;left:108px;white-space:nowrap" class="ft23817"><a href="https://toolbelt.heroku.com/">Toolbelt&#160;command-line utilities. The T</a>oolbelt is composed of two Heroku applications:</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft2385"><b>218&#160;&#160;|&#160;&#160;Chapter 17: Deployment</b></p>
</div>
<!-- Page 239 -->
<a name="239"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page239-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask239.png" alt="background image"/>
<p style="position:absolute;top:85px;left:121px;white-space:nowrap" class="ft23960">•&#160;heroku: The Heroku client, used to create and manage applications<br/>•&#160;foreman: A tool that can simulate the Heroku environment on your own computer</p>
<p style="position:absolute;top:130px;left:135px;white-space:nowrap" class="ft23914">for testing</p>
<p style="position:absolute;top:164px;left:108px;white-space:nowrap" class="ft23914">Note that if you don’t have a Git client installed already, the Toolbelt installer also installs</p>
<p style="position:absolute;top:183px;left:108px;white-space:nowrap" class="ft23915">Git for you.<br/>The Heroku client utility has to have your Heroku account credentials before it connect</p>
<p style="position:absolute;top:231px;left:108px;white-space:nowrap" class="ft23914">to the service. The&#160;heroku login&#160;command takes care of this:</p>
<p style="position:absolute;top:262px;left:133px;white-space:nowrap" class="ft23923">$&#160;heroku login<br/>Enter your Heroku credentials.<br/>Email: &lt;your-email-address&gt;<br/>Password&#160;(typing will be hidden): &lt;your-password&gt;<br/>Uploading ssh public key .../id_rsa.pub</p>
<p style="position:absolute;top:355px;left:198px;white-space:nowrap" class="ft23925">It&#160;is&#160;important&#160;that&#160;your&#160;SSH&#160;public&#160;key&#160;is&#160;uploaded&#160;to&#160;Heroku,&#160;as</p>
<p style="position:absolute;top:374px;left:198px;white-space:nowrap" class="ft23925">this&#160;is&#160;what&#160;enables&#160;the&#160;git&#160;push&#160;command.&#160;Normally&#160;the&#160;login</p>
<p style="position:absolute;top:391px;left:198px;white-space:nowrap" class="ft23925">command&#160;creates&#160;and&#160;uploads&#160;a&#160;SSH&#160;public&#160;key&#160;automatically,&#160;but</p>
<p style="position:absolute;top:409px;left:198px;white-space:nowrap" class="ft23925">the&#160;heroku&#160;keys:add&#160;command&#160;can&#160;be&#160;used&#160;to&#160;upload&#160;your&#160;public</p>
<p style="position:absolute;top:426px;left:198px;white-space:nowrap" class="ft23925">key&#160;separately&#160;from&#160;the&#160;login&#160;command&#160;or&#160;if&#160;you&#160;need&#160;to&#160;upload</p>
<p style="position:absolute;top:443px;left:198px;white-space:nowrap" class="ft23925">additional&#160;keys.</p>
<p style="position:absolute;top:487px;left:108px;white-space:nowrap" class="ft23989"><b>Creating an application<br/></b>The next step is to create an application using the Heroku client. To do this, first make</p>
<p style="position:absolute;top:533px;left:108px;white-space:nowrap" class="ft23914">sure your application is under Git source control and then run the following command</p>
<p style="position:absolute;top:551px;left:108px;white-space:nowrap" class="ft23914">from the top-level directory:</p>
<p style="position:absolute;top:583px;left:134px;white-space:nowrap" class="ft23923">$&#160;heroku create &lt;appname&gt;<br/>Creating &lt;appname&gt;...&#160;<b>done</b>, stack is cedar<br/>http://&lt;appname&gt;.herokuapp.com/ | git@heroku.com:&lt;appname&gt;.git<br/>Git remote heroku added</p>
<p style="position:absolute;top:650px;left:108px;white-space:nowrap" class="ft23914">Heroku application names must be unique, so find a name that is not taken by any other</p>
<p style="position:absolute;top:669px;left:108px;white-space:nowrap" class="ft23914">application. As indicated by the output of the&#160;create&#160;command, once deployed the</p>
<p style="position:absolute;top:688px;left:108px;white-space:nowrap" class="ft23914">application will be available at&#160;<i>http://&lt;appname&gt;.herokuapp.com</i>. Custom domain</p>
<p style="position:absolute;top:707px;left:108px;white-space:nowrap" class="ft23915">names can also be attached to the application.<br/>As part of the application creation, Heroku allocates a Git server:&#160;<i>git@heroku.com:&lt;app‐</i></p>
<p style="position:absolute;top:756px;left:108px;white-space:nowrap" class="ft23910"><i>name&gt;.git</i></p>
<p style="position:absolute;top:755px;left:172px;white-space:nowrap" class="ft23914">. The&#160;create&#160;command adds this server to your local Git repository as a&#160;git</p>
<p style="position:absolute;top:778px;left:108px;white-space:nowrap" class="ft23914">remote</p>
<p style="position:absolute;top:775px;left:153px;white-space:nowrap" class="ft23914">&#160;with the name&#160;heroku.</p>
<p style="position:absolute;top:811px;left:108px;white-space:nowrap" class="ft23989"><b>Provisioning a database<br/></b>Heroku supports Postgres databases as an add-on. A small database of up to 10,000 rows</p>
<p style="position:absolute;top:856px;left:108px;white-space:nowrap" class="ft23914">can be added to an application at no cost:</p>
<p style="position:absolute;top:915px;left:507px;white-space:nowrap" class="ft2395"><b>The Heroku Platform &#160;&#160;|&#160;&#160;219</b></p>
</div>
<!-- Page 240 -->
<a name="240"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page240-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask240.png" alt="background image"/>
<p style="position:absolute;top:82px;left:134px;white-space:nowrap" class="ft24023">$&#160;heroku addons:add heroku-postgresql:dev<br/>Adding heroku-postgresql:dev on &lt;appname&gt;...&#160;<b>done</b>, v3&#160;(free)<br/>Attached as HEROKU_POSTGRESQL_BROWN_URL<br/>Database has been created and is available<br/>&#160;! This database is empty. If upgrading, you can transfer<br/>&#160;! data from another database with pgbackups:restore.<br/>Use&#160;`heroku addons:docs heroku-postgresql:dev`&#160;to view documentation.</p>
<p style="position:absolute;top:195px;left:108px;white-space:nowrap" class="ft24014">The&#160;HEROKU_POSTGRESQL_BROWN_URL&#160;reference is for the name of the environment vari‐</p>
<p style="position:absolute;top:214px;left:108px;white-space:nowrap" class="ft24014">able that has the database URL. Note that when you try this, you may get a color other</p>
<p style="position:absolute;top:233px;left:108px;white-space:nowrap" class="ft24014">than brown. Heroku supports multiple databases per application, with each getting a</p>
<p style="position:absolute;top:252px;left:108px;white-space:nowrap" class="ft24046">different color in the URL. A database can be promoted and that exposes its URL in a<br/>DATABASE_URL</p>
<p style="position:absolute;top:272px;left:198px;white-space:nowrap" class="ft24014">&#160;environment variable. The following command promotes the brown</p>
<p style="position:absolute;top:291px;left:108px;white-space:nowrap" class="ft24014">database created previously to primary:</p>
<p style="position:absolute;top:323px;left:134px;white-space:nowrap" class="ft24023">$&#160;heroku pg:promote HEROKU_POSTGRESQL_BROWN_URL<br/>Promoting HEROKU_POSTGRESQL_BROWN_URL to DATABASE_URL...&#160;<b>done</b></p>
<p style="position:absolute;top:359px;left:108px;white-space:nowrap" class="ft24014">The format of the&#160;DATABASE_URL&#160;environment variable is exactly what SQLAlchemy</p>
<p style="position:absolute;top:379px;left:108px;white-space:nowrap" class="ft24014">expects. Recall that the&#160;<i>config.py</i>&#160;script uses the value of&#160;DATABASE_URL&#160;if it is defined,</p>
<p style="position:absolute;top:398px;left:108px;white-space:nowrap" class="ft24014">so the connection to the Postgres database will now work automatically.</p>
<p style="position:absolute;top:436px;left:108px;white-space:nowrap" class="ft24089"><b>Configuring logging&#160;<br/></b>Logging of fatal errors by email was added earlier, but in addition to that it is very</p>
<p style="position:absolute;top:481px;left:108px;white-space:nowrap" class="ft24014">important to configure logging of lesser message categories. A good example of this type</p>
<p style="position:absolute;top:500px;left:108px;white-space:nowrap" class="ft24048">of message are the warnings for slow database queries added in&#160;<a href="Flask.html#231">Chapter 16.<br/></a>With Heroku, logs must be written to&#160;stdout&#160;or&#160;stderr. The logging output is captured</p>
<p style="position:absolute;top:549px;left:108px;white-space:nowrap" class="ft24046">and made accessible through the Heroku client with the&#160;heroku logs&#160;command.<br/>The logging configuration can be added to the&#160;ProductionConfig&#160;class in its<br/>init_app()</p>
<p style="position:absolute;top:597px;left:183px;white-space:nowrap" class="ft24014">&#160;static method, but since this type of logging is specific to Heroku, a new</p>
<p style="position:absolute;top:617px;left:108px;white-space:nowrap" class="ft24014">configuration can be created specifically for that platform, leaving&#160;ProductionConfig</p>
<p style="position:absolute;top:636px;left:108px;white-space:nowrap" class="ft24046">as a baseline configuration for different types of production platforms. The<br/>HerokuConfig</p>
<p style="position:absolute;top:656px;left:198px;white-space:nowrap" class="ft24014"><a href="Flask.html#240">&#160;class is shown in&#160;Example 17-3</a>.</p>
<p style="position:absolute;top:688px;left:108px;white-space:nowrap" class="ft24047"><i>Example 17-3. config.py: Heroku configuration<br/></i><b>class</b>&#160;<b>HerokuConfig</b>(ProductionConfig):<br/>&#160; &#160;&#160;@classmethod<br/>&#160; &#160;&#160;<b>def</b>&#160;init_app(cls,&#160;app):<br/>&#160; &#160; &#160; &#160;&#160;ProductionConfig.init_app(app)</p>
<p style="position:absolute;top:792px;left:108px;white-space:nowrap" class="ft24047">&#160; &#160; &#160; &#160;&#160;<i># log to stderr<br/></i>&#160; &#160; &#160; &#160;&#160;<b>import</b>&#160;<b>logging<br/></b>&#160; &#160; &#160; &#160;&#160;<b>from</b>&#160;<b>logging</b>&#160;<b>import</b>&#160;StreamHandler<br/>&#160; &#160; &#160; &#160;&#160;file_handler&#160;=&#160;StreamHandler()<br/>&#160; &#160; &#160; &#160;&#160;file_handler.setLevel(logging.WARNING)<br/>&#160; &#160; &#160; &#160;&#160;app.logger.addHandler(file_handler)</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft2405"><b>220&#160;&#160;|&#160;&#160;Chapter 17: Deployment</b></p>
</div>
<!-- Page 241 -->
<a name="241"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page241-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask241.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft24114">When the application is executed by Heroku, it needs to know that this is the configu‐</p>
<p style="position:absolute;top:97px;left:108px;white-space:nowrap" class="ft24146">ration that needs to be used. The application instance created in&#160;<i>manage.py</i>&#160;uses the<br/>FLASK_CONFIG</p>
<p style="position:absolute;top:117px;left:198px;white-space:nowrap" class="ft24114">&#160;environment variable to know what configuration to use, so this variable</p>
<p style="position:absolute;top:136px;left:108px;white-space:nowrap" class="ft24114">needs to be set in the Heroku environment. Environment variables are set using the</p>
<p style="position:absolute;top:156px;left:108px;white-space:nowrap" class="ft24114">Heroku client’s&#160;config:set&#160;command:</p>
<p style="position:absolute;top:188px;left:134px;white-space:nowrap" class="ft24123">$&#160;heroku config:set&#160;FLASK_CONFIG=heroku<br/>Setting config vars and restarting &lt;appname&gt;...&#160;<b>done</b>, v4<br/>FLASK_CONFIG: heroku</p>
<p style="position:absolute;top:248px;left:108px;white-space:nowrap" class="ft24189"><b>Configuring email&#160;<br/></b>Heroku does not provide a SMTP server, so an external server must be configured.</p>
<p style="position:absolute;top:294px;left:108px;white-space:nowrap" class="ft24114">There are several third-party add-ons that integrate production-ready email sending</p>
<p style="position:absolute;top:313px;left:108px;white-space:nowrap" class="ft24114">support with Heroku, but for testing and evaluation purposes it is sufficient to use the</p>
<p style="position:absolute;top:333px;left:108px;white-space:nowrap" class="ft24115">default Gmail configuration inherited from the base&#160;Config&#160;class.<br/>Because it can be a security risk to embed login credentials directly in the script, the</p>
<p style="position:absolute;top:380px;left:108px;white-space:nowrap" class="ft24114">username and password to access the Gmail SMTP server are provided as environment</p>
<p style="position:absolute;top:398px;left:108px;white-space:nowrap" class="ft24114">variables:</p>
<p style="position:absolute;top:430px;left:134px;white-space:nowrap" class="ft24123">$&#160;heroku config:set&#160;MAIL_USERNAME=&lt;your-gmail-username&gt;<br/>$&#160;heroku config:set&#160;MAIL_PASSWORD=&lt;your-gmail-password&gt;</p>
<p style="position:absolute;top:475px;left:108px;white-space:nowrap" class="ft24189"><b>Running a production web server&#160;<br/></b>Heroku does not provide a web server for the applications it hosts. Instead, it expects</p>
<p style="position:absolute;top:521px;left:108px;white-space:nowrap" class="ft24114">applications to start their own servers and listen on the port number set in environment</p>
<p style="position:absolute;top:541px;left:108px;white-space:nowrap" class="ft24115">variable&#160;PORT.<br/>The development web server that comes with Flask will perform very poorly because it</p>
<p style="position:absolute;top:588px;left:108px;white-space:nowrap" class="ft24114">was not designed to run in a production environment. Two production-ready web</p>
<p style="position:absolute;top:607px;left:108px;white-space:nowrap" class="ft24115">servers that work well with Flask applica<a href="http://gunicorn.org/">tions are&#160;Gunicorn&#160;and&#160;</a><a href="http://bit.ly/uwsgi-proj">uWSGI.<br/></a>To test the Heroku configuration locally, it is a good idea to install the web server in the</p>
<p style="position:absolute;top:654px;left:108px;white-space:nowrap" class="ft24114">virtual environment. For example, Gunicorn is installed as follows:</p>
<p style="position:absolute;top:685px;left:134px;white-space:nowrap" class="ft24133">(venv)&#160;$&#160;pip install gunicorn</p>
<p style="position:absolute;top:706px;left:108px;white-space:nowrap" class="ft24114">To run the application under Gunicorn, use the following command:</p>
<p style="position:absolute;top:737px;left:133px;white-space:nowrap" class="ft24123">(venv)&#160;$&#160;gunicorn manage:app<br/>2013-12-03 09:52:10&#160;[14363]&#160;[INFO]&#160;Starting gunicorn 18.0<br/>2013-12-03 09:52:10&#160;[14363]&#160;[INFO]&#160;Listening at: http://127.0.0.1:8000&#160;(14363)<br/>2013-12-03 09:52:10&#160;[14363]&#160;[INFO]&#160;Using worker: sync<br/>2013-12-03 09:52:10&#160;[14368]&#160;[INFO]&#160;Booting worker with pid: 14368</p>
<p style="position:absolute;top:820px;left:108px;white-space:nowrap" class="ft24114">The&#160;manage:app&#160;argument indicates the package or module that defines the application</p>
<p style="position:absolute;top:839px;left:108px;white-space:nowrap" class="ft24114">to the left of the colon and the name of the application instance inside that package on</p>
<p style="position:absolute;top:858px;left:108px;white-space:nowrap" class="ft24114">the right. Note that Gunicorn uses port 8000 by default, not 5000 like Flask.</p>
<p style="position:absolute;top:915px;left:507px;white-space:nowrap" class="ft2415"><b>The Heroku Platform &#160;&#160;|&#160;&#160;221</b></p>
</div>
<!-- Page 242 -->
<a name="242"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page242-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask242.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft24289"><b>Adding a requirements file&#160;<br/></b>Heroku loads package dependencies from a&#160;<i>requirements.txt</i>&#160;file stored in the top-level</p>
<p style="position:absolute;top:123px;left:108px;white-space:nowrap" class="ft24214">folder. All the dependencies in this file will be imported into a virtual environment</p>
<p style="position:absolute;top:142px;left:108px;white-space:nowrap" class="ft24215">created by Heroku as part of the deployment.<br/>The Heroku requirements file must include all the common requirements for the pro‐</p>
<p style="position:absolute;top:189px;left:108px;white-space:nowrap" class="ft24214">duction version of the application, the&#160;<i>psycopg2</i>&#160;package to enable Postgres database</p>
<p style="position:absolute;top:208px;left:108px;white-space:nowrap" class="ft24215">support, and the Gunicorn web server.<br/><a href="Flask.html#242">Example 17-4&#160;shows an exam</a>ple requirements file.</p>
<p style="position:absolute;top:268px;left:108px;white-space:nowrap" class="ft24247"><i>Example 17-4. requirements.txt: Heroku requirements file<br/></i>-r requirements/prod.txt<br/>gunicorn==18.0<br/>psycopg2==2.5.1</p>
<p style="position:absolute;top:356px;left:108px;white-space:nowrap" class="ft24289"><b>Adding a Procfile&#160;<br/></b>Heroku needs to know what command to use to start the application. This command</p>
<p style="position:absolute;top:402px;left:108px;white-space:nowrap" class="ft24214">is given in a special file called the&#160;<i>Procfile</i>. This file must be included in the top-level</p>
<p style="position:absolute;top:421px;left:108px;white-space:nowrap" class="ft24215">folder of the application.<br/><a href="Flask.html#242">Example 17-5&#160;shows the con</a>tents of this file.</p>
<p style="position:absolute;top:480px;left:108px;white-space:nowrap" class="ft24250"><i>Example 17-5. Procfile: Heroku Procfile<br/></i>web: gunicorn manage:app</p>
<p style="position:absolute;top:535px;left:108px;white-space:nowrap" class="ft24214">The format for the Procfile is very simple: in each line a task name is given, followed by</p>
<p style="position:absolute;top:555px;left:108px;white-space:nowrap" class="ft24214">a colon and then the command that runs the task. The task name&#160;web&#160;is special; it is</p>
<p style="position:absolute;top:573px;left:108px;white-space:nowrap" class="ft24214">recognized by Heroku as the task that starts the web server. Heroku will give this task</p>
<p style="position:absolute;top:593px;left:108px;white-space:nowrap" class="ft24214">a&#160;PORT&#160;environment variable set to the port on which the application needs to listen for</p>
<p style="position:absolute;top:613px;left:108px;white-space:nowrap" class="ft24214">requests. Gunicorn by default honors the&#160;PORT&#160;variable if it is set, so there is no need to</p>
<p style="position:absolute;top:632px;left:108px;white-space:nowrap" class="ft24214">include it in the startup command.</p>
<p style="position:absolute;top:674px;left:198px;white-space:nowrap" class="ft24225">Applications&#160;can&#160;declare&#160;additional&#160;tasks&#160;with&#160;names&#160;other&#160;than&#160;web</p>
<p style="position:absolute;top:692px;left:198px;white-space:nowrap" class="ft24225">in&#160;the&#160;Procfile.&#160;These&#160;can&#160;be&#160;other&#160;services&#160;needed&#160;by&#160;the&#160;applica‐</p>
<p style="position:absolute;top:709px;left:198px;white-space:nowrap" class="ft24225">tion.&#160;Heroku&#160;launches&#160;all&#160;the&#160;tasks&#160;listed&#160;in&#160;the&#160;Procfile&#160;when&#160;the</p>
<p style="position:absolute;top:726px;left:198px;white-space:nowrap" class="ft24225">application&#160;is&#160;deployed.</p>
<p style="position:absolute;top:778px;left:108px;white-space:nowrap" class="ft24252"><b>Testing with Foreman&#160;<br/></b>The Heroku Toolbelt includes a second utility called&#160;<i>Foreman</i>, used to run the appli‐</p>
<p style="position:absolute;top:831px;left:108px;white-space:nowrap" class="ft24214">cation locally through the Procfile for testing purposes. The environment variables such</p>
<p style="position:absolute;top:851px;left:108px;white-space:nowrap" class="ft24214">as&#160;FLASK_CONFIG&#160;that are set through the Heroku client are available only on the Heroku</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft2425"><b>222&#160;&#160;|&#160;&#160;Chapter 17: Deployment</b></p>
</div>
<!-- Page 243 -->
<a name="243"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page243-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask243.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft24314">servers, so they also must be defined locally so that the testing environment under</p>
<p style="position:absolute;top:97px;left:108px;white-space:nowrap" class="ft24314">Foreman is similar. Foreman looks for these environment variables in a file</p>
<p style="position:absolute;top:116px;left:108px;white-space:nowrap" class="ft24314">named&#160;<i>.env</i>&#160;in the top-level directory of the application. For example, the&#160;<i>.env</i>&#160;file can</p>
<p style="position:absolute;top:135px;left:108px;white-space:nowrap" class="ft24314">contain the following variables:</p>
<p style="position:absolute;top:167px;left:133px;white-space:nowrap" class="ft24323">FLASK_CONFIG=heroku<br/>MAIL_USERNAME=&lt;your-username&gt;<br/>MAIL_PASSWORD=&lt;your-password&gt;</p>
<p style="position:absolute;top:229px;left:198px;white-space:nowrap" class="ft24325">Because&#160;the&#160;<i>.env</i>&#160;file&#160;contains&#160;passwords&#160;and&#160;other&#160;sensitive&#160;account</p>
<p style="position:absolute;top:247px;left:198px;white-space:nowrap" class="ft24325">information,&#160;it&#160;should&#160;never&#160;be&#160;added&#160;to&#160;the&#160;Git&#160;repository.</p>
<p style="position:absolute;top:335px;left:108px;white-space:nowrap" class="ft24314">Foreman has several options, but the main two are&#160;foreman run&#160;and&#160;foreman start.</p>
<p style="position:absolute;top:355px;left:108px;white-space:nowrap" class="ft24314">The&#160;run&#160;command can be used to run arbitrary commands under the environment of</p>
<p style="position:absolute;top:375px;left:108px;white-space:nowrap" class="ft24314">the application and is perfect to run the&#160;deploy&#160;command that the application uses to</p>
<p style="position:absolute;top:394px;left:108px;white-space:nowrap" class="ft24314">create the database:</p>
<p style="position:absolute;top:425px;left:134px;white-space:nowrap" class="ft24333">(venv)&#160;$&#160;foreman run python manage.py deploy</p>
<p style="position:absolute;top:447px;left:108px;white-space:nowrap" class="ft24314">The&#160;start&#160;command reads the Procfile and executes all the tasks in it:</p>
<p style="position:absolute;top:479px;left:134px;white-space:nowrap" class="ft24323">(venv)&#160;$&#160;foreman start<br/>22:55:08 web.1 &#160;| started with pid 4246<br/>22:55:08 web.1 &#160;| 2013-12-03 22:55:08&#160;[4249]&#160;[INFO]&#160;Starting gunicorn 18.0<br/>22:55:08 web.1 &#160;| 2013-12-03 22:55:08&#160;[4249]&#160;[INFO]&#160;Listening at: http://...<br/>22:55:08 web.1 &#160;| 2013-12-03 22:55:08&#160;[4249]&#160;[INFO]&#160;Using worker: sync<br/>22:55:08 web.1 &#160;| 2013-12-03 22:55:08&#160;[4254]&#160;[INFO]&#160;Booting worker with pid: 4254</p>
<p style="position:absolute;top:576px;left:108px;white-space:nowrap" class="ft24314">Foreman consolidates the logging output of all the tasks started and dumps it to the</p>
<p style="position:absolute;top:594px;left:108px;white-space:nowrap" class="ft24348">console, with each line prefixed with a timestamp and the task name.<br/>It is possible to simulate multiple dynos using the&#160;-c&#160;option. For example, the following</p>
<p style="position:absolute;top:642px;left:108px;white-space:nowrap" class="ft24314">command starts three web workers, each listening on a different port:</p>
<p style="position:absolute;top:674px;left:134px;white-space:nowrap" class="ft24333">(venv)&#160;$&#160;foreman start -c&#160;web=3</p>
<p style="position:absolute;top:703px;left:108px;white-space:nowrap" class="ft24352"><b>Enabling Secure HTTP with Flask-SSLify&#160;<br/></b>When the user logs in to the application by submitting a username and a password in</p>
<p style="position:absolute;top:757px;left:108px;white-space:nowrap" class="ft24314">a web form, these values can be intercepted during travel by a third party, as discussed</p>
<p style="position:absolute;top:775px;left:108px;white-space:nowrap" class="ft24314">several times before. To prevent user credentials from being stolen in this way, it is</p>
<p style="position:absolute;top:794px;left:108px;white-space:nowrap" class="ft24314">necessary to use secure HTTP, which encrypts all the communications between clients</p>
<p style="position:absolute;top:813px;left:108px;white-space:nowrap" class="ft24315">and the server using public key cryptography.<br/>Heroku makes all applications that are accessed on the&#160;<i>herokuapp.com</i>&#160;domain available</p>
<p style="position:absolute;top:860px;left:108px;white-space:nowrap" class="ft24314">on both&#160;<i>http://</i>&#160;and&#160;<i>https://</i>&#160;without any configuration using Heroku’s own SSL certifi‐</p>
<p style="position:absolute;top:915px;left:507px;white-space:nowrap" class="ft2435"><b>The Heroku Platform &#160;&#160;|&#160;&#160;223</b></p>
</div>
<!-- Page 244 -->
<a name="244"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page244-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask244.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft24414">cate. The only necessary action is for the application to intercept any requests sent to</p>
<p style="position:absolute;top:97px;left:108px;white-space:nowrap" class="ft24414">the&#160;<i>http://</i>&#160;interface and redirect them to&#160;<i>https://</i>, and this is what the extension Flask-</p>
<p style="position:absolute;top:116px;left:108px;white-space:nowrap" class="ft24415">SSLify does.<br/>The extension needs to be added to the&#160;<i>requirements.txt</i>&#160;file. The code in&#160;<a href="Flask.html#244">Example 17-6</a></p>
<p style="position:absolute;top:163px;left:108px;white-space:nowrap" class="ft24414">is used to activate the extension.</p>
<p style="position:absolute;top:195px;left:108px;white-space:nowrap" class="ft24447"><i>Example 17-6. app/__init__.py: Redirect all requests to secure HTTP<br/></i><b>def</b>&#160;create_app(config_name):<br/>&#160; &#160;&#160;<i># ...<br/></i>&#160; &#160;&#160;<b>if</b>&#160;<b>not</b>&#160;app.debug&#160;<b>and</b>&#160;<b>not</b>&#160;app.testing&#160;<b>and</b>&#160;<b>not</b>&#160;app.config['SSL_DISABLE']:<br/>&#160; &#160; &#160; &#160;&#160;<b>from</b>&#160;<b>flask.ext.sslify</b>&#160;<b>import</b>&#160;SSLify<br/>&#160; &#160; &#160; &#160;&#160;sslify&#160;=&#160;SSLify(app)<br/>&#160; &#160;&#160;<i># ...</i></p>
<p style="position:absolute;top:326px;left:108px;white-space:nowrap" class="ft24414">Support for SSL needs to be enabled only in production mode, and only when the</p>
<p style="position:absolute;top:345px;left:108px;white-space:nowrap" class="ft24414">platform supports it. To make it easy to switch SSL on and off, a new configuration</p>
<p style="position:absolute;top:364px;left:108px;white-space:nowrap" class="ft24414">variable called&#160;SSL_DISABLE&#160;is added. The base&#160;Config&#160;class sets it to&#160;True, so that SSL</p>
<p style="position:absolute;top:384px;left:108px;white-space:nowrap" class="ft24414">is not used by default, and the class&#160;HerokuConfig&#160;overrides it. The implementation of</p>
<p style="position:absolute;top:403px;left:108px;white-space:nowrap" class="ft24414">this configura<a href="Flask.html#244">tion variable is shown in&#160;Example 17-7.</a></p>
<p style="position:absolute;top:435px;left:108px;white-space:nowrap" class="ft24468"><i>Example 17-7. config.py: Configure the use of SSL<br/></i><b>class</b>&#160;<b>Config</b>:<br/>&#160; &#160;&#160;<i># ...<br/></i>&#160; &#160;&#160;SSL_DISABLE&#160;=&#160;True</p>
<p style="position:absolute;top:524px;left:108px;white-space:nowrap" class="ft24468"><b>class</b>&#160;<b>HerokuConfig</b>(ProductionConfig):<br/>&#160; &#160;&#160;<i># ...<br/></i>&#160; &#160;&#160;SSL_DISABLE&#160;=&#160;bool(os.environ.get('SSL_DISABLE'))</p>
<p style="position:absolute;top:582px;left:108px;white-space:nowrap" class="ft24414">The value of&#160;SSL_DISABLE&#160;in&#160;HerokuConfig&#160;is taken from an environment variable of</p>
<p style="position:absolute;top:601px;left:108px;white-space:nowrap" class="ft24414">the same name. If the environment variable is set to anything other than an empty string,</p>
<p style="position:absolute;top:621px;left:108px;white-space:nowrap" class="ft24414">the conversion to Boolean will return&#160;True, disabling SSL. If the environment variable</p>
<p style="position:absolute;top:640px;left:108px;white-space:nowrap" class="ft24414">does not exist or is set to an empty string, the conversion to Boolean will give a&#160;False</p>
<p style="position:absolute;top:659px;left:108px;white-space:nowrap" class="ft24446">value. To prevent SSL from being enabled when using Foreman, it is necessary to add<br/>SSL_DISABLE=1</p>
<p style="position:absolute;top:679px;left:206px;white-space:nowrap" class="ft24414">&#160;to the&#160;<i>.env</i>&#160;file.</p>
<p style="position:absolute;top:707px;left:108px;white-space:nowrap" class="ft24414">With these changes, the users will be forced to use the SSL server, but there is one more</p>
<p style="position:absolute;top:726px;left:108px;white-space:nowrap" class="ft24414">detail that needs to be handled to make the support complete. When using Heroku,</p>
<p style="position:absolute;top:745px;left:108px;white-space:nowrap" class="ft24414">clients do not connect to hosted applications directly but to a&#160;<i>reverse proxy server</i>&#160;that</p>
<p style="position:absolute;top:764px;left:108px;white-space:nowrap" class="ft24414">redirects requests into the applications. In this type of setup, only the proxy server runs</p>
<p style="position:absolute;top:783px;left:108px;white-space:nowrap" class="ft24414">in SSL mode; the applications receive all requests from the proxy server without SSL</p>
<p style="position:absolute;top:802px;left:108px;white-space:nowrap" class="ft24414">because there is no need to use strong security for requests that are internal to the Heroku</p>
<p style="position:absolute;top:820px;left:108px;white-space:nowrap" class="ft24414">network. This is a problem when the application needs to generate absolute URLs that</p>
<p style="position:absolute;top:840px;left:108px;white-space:nowrap" class="ft24414">match the security of the request, because&#160;request.is_secure&#160;will always be&#160;False</p>
<p style="position:absolute;top:859px;left:108px;white-space:nowrap" class="ft24414">when a reverse proxy server is used.</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft2445"><b>224&#160;&#160;|&#160;&#160;Chapter 17: Deployment</b></p>
</div>
<!-- Page 245 -->
<a name="245"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page245-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask245.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft24514">An example of when this becomes a problem is the generation of avatar URLs. If you</p>
<p style="position:absolute;top:98px;left:108px;white-space:nowrap" class="ft24514">recall from&#160;<a href="Flask.html#139">Chapter 10</a>, the&#160;gravatar()&#160;method of the&#160;User&#160;model that generates the</p>
<p style="position:absolute;top:118px;left:108px;white-space:nowrap" class="ft24514">Gravatar URLs checks&#160;request.is_secure&#160;to generate the secure or nonsecure version</p>
<p style="position:absolute;top:137px;left:108px;white-space:nowrap" class="ft24514">of the URL. Generating a nonsecure avatar when the page was requested over SSL would</p>
<p style="position:absolute;top:156px;left:108px;white-space:nowrap" class="ft24514">cause some browsers to display a security warning to the user, so all components of a</p>
<p style="position:absolute;top:175px;left:108px;white-space:nowrap" class="ft24515">page must have matching security.<br/>Proxy servers pass information that describes the original request from the client to the</p>
<p style="position:absolute;top:222px;left:108px;white-space:nowrap" class="ft24514">redirected web servers through custom HTTP headers, so it is possible to determine</p>
<p style="position:absolute;top:240px;left:108px;white-space:nowrap" class="ft24514">whether the user is communicating with the application over SSL by looking at these.</p>
<p style="position:absolute;top:259px;left:108px;white-space:nowrap" class="ft24514">Werkzeug provides a WSGI&#160;<i>middleware</i>&#160;that checks the custom headers from the proxy</p>
<p style="position:absolute;top:278px;left:108px;white-space:nowrap" class="ft24546">server and updates the request object accordingly so that, for example,<br/>request.is_secure</p>
<p style="position:absolute;top:298px;left:236px;white-space:nowrap" class="ft24514">&#160;reflects the security of the request that the client sent to the reverse</p>
<p style="position:absolute;top:317px;left:108px;white-space:nowrap" class="ft24514">proxy server and not the request that the proxy server sent to the application.</p>
<p style="position:absolute;top:337px;left:108px;white-space:nowrap" class="ft24517"><a href="Flask.html#245">Example 17-8&#160;shows how to add the&#160;</a>ProxyFix&#160;middleware to the application.&#160;</p>
<p style="position:absolute;top:369px;left:108px;white-space:nowrap" class="ft24547"><i>Example 17-8. config.py: Support for proxy servers<br/></i><b>class</b>&#160;<b>HerokuConfig</b>(ProductionConfig):<br/>&#160; &#160;&#160;<i># ...<br/></i>&#160; &#160;&#160;@classmethod<br/>&#160; &#160;&#160;<b>def</b>&#160;init_app(cls,&#160;app):<br/>&#160; &#160; &#160; &#160;&#160;<i># ...</i></p>
<p style="position:absolute;top:488px;left:108px;white-space:nowrap" class="ft24540">&#160; &#160; &#160; &#160;&#160;<i># handle proxy server headers<br/></i>&#160; &#160; &#160; &#160;&#160;<b>from</b>&#160;<b>werkzeug.contrib.fixers</b>&#160;<b>import</b>&#160;ProxyFix<br/>&#160; &#160; &#160; &#160;&#160;app.wsgi_app&#160;=&#160;ProxyFix(app.wsgi_app)</p>
<p style="position:absolute;top:545px;left:108px;white-space:nowrap" class="ft24514">The middleware is added in the initialization method for the Heroku configuration.</p>
<p style="position:absolute;top:565px;left:108px;white-space:nowrap" class="ft24514">WSGI middlewares such as&#160;ProxyFix&#160;are added by wrapping the WSGI application.</p>
<p style="position:absolute;top:584px;left:108px;white-space:nowrap" class="ft24514">When a request comes, the middlewares get a chance to inspect the environment and</p>
<p style="position:absolute;top:604px;left:108px;white-space:nowrap" class="ft24514">make changes before the request is processed. The&#160;ProxyFix&#160;middleware is necessary</p>
<p style="position:absolute;top:623px;left:108px;white-space:nowrap" class="ft24514">not only for Heroku but in any deployment that uses a reverse proxy server.</p>
<p style="position:absolute;top:664px;left:198px;white-space:nowrap" class="ft24525">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:682px;left:198px;white-space:nowrap" class="ft24525">run&#160;git&#160;checkout&#160;17c&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:701px;left:198px;white-space:nowrap" class="ft24580">To&#160;ensure&#160;that&#160;you&#160;have&#160;all&#160;the&#160;dependencies&#160;installed,&#160;also&#160;run&#160;pip<br/>install&#160;-r&#160;requirements.txt</p>
<p style="position:absolute;top:719px;left:383px;white-space:nowrap" class="ft24525">.</p>
<p style="position:absolute;top:768px;left:108px;white-space:nowrap" class="ft24552"><b>Deploying with git push&#160;<br/></b>The final step in the process is to upload the application to the Heroku servers. Make</p>
<p style="position:absolute;top:823px;left:108px;white-space:nowrap" class="ft24546">sure that all the changes are commited to the local Git repository and then use&#160;git push<br/>heroku master</p>
<p style="position:absolute;top:843px;left:206px;white-space:nowrap" class="ft24514">&#160;to upload the application to the&#160;heroku&#160;remote:</p>
<p style="position:absolute;top:915px;left:507px;white-space:nowrap" class="ft2455"><b>The Heroku Platform &#160;&#160;|&#160;&#160;225</b></p>
</div>
<!-- Page 246 -->
<a name="246"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page246-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask246.png" alt="background image"/>
<p style="position:absolute;top:82px;left:134px;white-space:nowrap" class="ft24623">$&#160;git push heroku master<br/>Counting objects: 645,&#160;<b>done</b>.<br/>Delta compression using up to 8 threads.<br/>Compressing objects: 100%&#160;(315/315),&#160;<b>done</b>.<br/>Writing objects: 100%&#160;(645/645), 95.52 KiB,&#160;<b>done</b>.<br/>Total 645&#160;(delta 369), reused 457&#160;(delta 288)</p>
<p style="position:absolute;top:189px;left:134px;white-space:nowrap" class="ft24623">.---&gt; Python app detected<br/>.----&gt; No runtime.txt provided; assuming python-2.7.4.<br/>.----&gt; Preparing Python runtime&#160;(python-2.7.4)<br/>...<br/>-----&gt; Compiled slug size: 32.8MB<br/>-----&gt; Launching...&#160;<b>done</b>, v8<br/>&#160; &#160; &#160; &#160;http://&lt;appname&gt;.herokuapp.com deployed to Heroku</p>
<p style="position:absolute;top:312px;left:134px;white-space:nowrap" class="ft24623">To git@heroku.com:&lt;appname&gt;.git<br/>&#160;*&#160;[new branch]&#160; &#160; &#160; master -&gt; master</p>
<p style="position:absolute;top:348px;left:108px;white-space:nowrap" class="ft24614">The application is now deployed and running, but it is not going to work correctly</p>
<p style="position:absolute;top:367px;left:108px;white-space:nowrap" class="ft24614">because the&#160;deploy&#160;command was not executed. The Heroku client can run this com‐</p>
<p style="position:absolute;top:386px;left:108px;white-space:nowrap" class="ft24614">mand as follows:</p>
<p style="position:absolute;top:418px;left:133px;white-space:nowrap" class="ft24623">$&#160;heroku run python manage.py deploy<br/>Running&#160;`python manage.py predeploy`&#160;attached to terminal... up, run.8449<br/>INFO &#160;[alembic.migration]&#160;Context impl PostgresqlImpl.<br/>INFO &#160;[alembic.migration]&#160;Will assume transactional DDL.<br/>...</p>
<p style="position:absolute;top:500px;left:108px;white-space:nowrap" class="ft24614">After the database tables are created and configured, the application can be restarted so</p>
<p style="position:absolute;top:519px;left:108px;white-space:nowrap" class="ft24614">that it starts cleanly:</p>
<p style="position:absolute;top:550px;left:134px;white-space:nowrap" class="ft24623">$&#160;heroku restart<br/>Restarting dynos...&#160;<b>done</b></p>
<p style="position:absolute;top:586px;left:108px;white-space:nowrap" class="ft24614">The application shoud now be fully deployed and online at&#160;<i>https://&lt;appname&gt;.hero‐</i></p>
<p style="position:absolute;top:606px;left:108px;white-space:nowrap" class="ft24610"><i>kuapp.com</i></p>
<p style="position:absolute;top:605px;left:176px;white-space:nowrap" class="ft24614">.</p>
<p style="position:absolute;top:641px;left:108px;white-space:nowrap" class="ft24652"><b>Reviewing Logs&#160;<br/></b>The logging output generated by the application is captured by Heroku. To view the</p>
<p style="position:absolute;top:696px;left:108px;white-space:nowrap" class="ft24614">contents of the log, use the&#160;logs&#160;command:</p>
<p style="position:absolute;top:728px;left:133px;white-space:nowrap" class="ft24621">$&#160;heroku logs</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft2465"><b>226&#160;&#160;|&#160;&#160;Chapter 17: Deployment</b></p>
</div>
<!-- Page 247 -->
<a name="247"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page247-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask247.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft24714">During testing it can also be convenient to tail the log file, which can be done as follows:</p>
<p style="position:absolute;top:110px;left:133px;white-space:nowrap" class="ft24721">$&#160;heroku logs -t</p>
<p style="position:absolute;top:138px;left:108px;white-space:nowrap" class="ft24758"><b>Deploying an Upgrade<br/></b>When a Heroku application needs to be upgraded the same process needs to be repeated.</p>
<p style="position:absolute;top:191px;left:108px;white-space:nowrap" class="ft24714">After all the changes have been committed to the Git repository, the following com‐</p>
<p style="position:absolute;top:210px;left:108px;white-space:nowrap" class="ft24714">mands perform an upgrade:</p>
<p style="position:absolute;top:242px;left:133px;white-space:nowrap" class="ft24723">$&#160;heroku maintenance:on<br/>$&#160;git push heroku master<br/>$&#160;heroku run python manage.py deploy<br/>$&#160;heroku restart<br/>$&#160;heroku maintenance:off</p>
<p style="position:absolute;top:324px;left:108px;white-space:nowrap" class="ft24714">The&#160;maintenance&#160;option available on the Heroku client will take the application offline</p>
<p style="position:absolute;top:343px;left:108px;white-space:nowrap" class="ft24714">during the upgrade and will show a static page that informs users that the site will be</p>
<p style="position:absolute;top:362px;left:108px;white-space:nowrap" class="ft24714">coming back soon.</p>
<p style="position:absolute;top:398px;left:108px;white-space:nowrap" class="ft24718"><b>Traditional Hosting<br/></b>The traditional hosting option involves buying or renting a server, either physical or</p>
<p style="position:absolute;top:457px;left:108px;white-space:nowrap" class="ft24714">virtual, and setting up all the required components on it yourself. This is typically less</p>
<p style="position:absolute;top:476px;left:108px;white-space:nowrap" class="ft24714">expensive than hosting in the cloud, but obviously much more laborious. The following</p>
<p style="position:absolute;top:495px;left:108px;white-space:nowrap" class="ft24714">sections will give you an idea of the work involved.</p>
<p style="position:absolute;top:531px;left:108px;white-space:nowrap" class="ft24758"><b>Server Setup<br/></b>There are several administration tasks that must be performed on the server before it</p>
<p style="position:absolute;top:583px;left:108px;white-space:nowrap" class="ft24714">can host applications:</p>
<p style="position:absolute;top:617px;left:121px;white-space:nowrap" class="ft24714">•&#160;Install a database server such as&#160;<i>MySQL</i>&#160;or&#160;<i>Postgres</i>. Using a&#160;<i>SQLite</i>&#160;database is also</p>
<p style="position:absolute;top:636px;left:135px;white-space:nowrap" class="ft24714">possible but is not recommended for a production server due to its many limita‐</p>
<p style="position:absolute;top:655px;left:135px;white-space:nowrap" class="ft24714">tions.</p>
<p style="position:absolute;top:680px;left:121px;white-space:nowrap" class="ft24719">•&#160;Install a Mail Transport Agent (MTA) such as&#160;<i>Sendmail</i>&#160;to send email out to users.<br/>•&#160;Install a production-ready web server such as&#160;<i>Gunicorn</i>&#160;or&#160;<i>uWSGI</i>.<br/>•&#160;Purchase, install, and configure a SSL certificate to enable secure HTTP.<br/>•&#160;(Optional but highly recommended) Install a front-end reverse proxy web server</p>
<p style="position:absolute;top:773px;left:135px;white-space:nowrap" class="ft24714">such as&#160;<i>nginx</i>&#160;or&#160;<i>Apache</i>. This process will serve static files directly and will forward</p>
<p style="position:absolute;top:792px;left:135px;white-space:nowrap" class="ft24714">any other requests into the application’s web server listening on a private port on</p>
<p style="position:absolute;top:812px;left:135px;white-space:nowrap" class="ft24710"><i>localhost</i></p>
<p style="position:absolute;top:811px;left:190px;white-space:nowrap" class="ft24714">.</p>
<p style="position:absolute;top:915px;left:516px;white-space:nowrap" class="ft2475"><b>Traditional Hosting&#160;&#160;|&#160;&#160;227</b></p>
</div>
<!-- Page 248 -->
<a name="248"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page248-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask248.png" alt="background image"/>
<p style="position:absolute;top:78px;left:121px;white-space:nowrap" class="ft24814">•&#160;Server hardening. This groups several tasks that have the goal of reducing vulner‐</p>
<p style="position:absolute;top:97px;left:135px;white-space:nowrap" class="ft24814">abilities in the server such as installing firewalls, removing unused software and</p>
<p style="position:absolute;top:116px;left:135px;white-space:nowrap" class="ft24814">services, and so on.</p>
<p style="position:absolute;top:168px;left:108px;white-space:nowrap" class="ft24852"><b>Importing Environment Variables&#160;<br/></b>Similarly to Heroku, an application running on a standalone server relies on certain</p>
<p style="position:absolute;top:221px;left:108px;white-space:nowrap" class="ft24814">settings such as database URL, email server credentials, and configuration name. These</p>
<p style="position:absolute;top:240px;left:108px;white-space:nowrap" class="ft24815">are stored in environment variables that must be imported before the application starts.<br/>Because there is no Heroku or Foreman to import these variables, this task needs to be</p>
<p style="position:absolute;top:287px;left:108px;white-space:nowrap" class="ft24814">done by the application itself during startup. The short code block in&#160;<a href="Flask.html#248">Example 17-9</a></p>
<p style="position:absolute;top:306px;left:108px;white-space:nowrap" class="ft24814">loads and parses a&#160;<i>.env</i>&#160;file similar to the one used with Foreman. This code can be added</p>
<p style="position:absolute;top:325px;left:108px;white-space:nowrap" class="ft24814">to the&#160;<i>manage.py</i>&#160;launch script before the application instance is created.</p>
<p style="position:absolute;top:357px;left:108px;white-space:nowrap" class="ft24847"><i>Example 17-9. manage.py: Import environment from .env file<br/></i><b>if</b>&#160;os.path.exists('.env'):<br/>&#160; &#160;&#160;<b>print</b>('Importing environment from .env...')<br/>&#160; &#160;&#160;<b>for</b>&#160;line&#160;<b>in</b>&#160;open('.env'):<br/>&#160; &#160; &#160; &#160;&#160;var&#160;=&#160;line.strip().split('=')<br/>&#160; &#160; &#160; &#160;&#160;<b>if</b>&#160;len(var)&#160;==&#160;2:<br/>&#160; &#160; &#160; &#160; &#160; &#160;&#160;os.environ[var[0]]&#160;=&#160;var[1]</p>
<p style="position:absolute;top:488px;left:108px;white-space:nowrap" class="ft24814">The&#160;<i>.env</i>&#160;file must contain at least the&#160;FLASK_CONFIG&#160;variable that selects the configu‐</p>
<p style="position:absolute;top:507px;left:108px;white-space:nowrap" class="ft24814">ration to use.</p>
<p style="position:absolute;top:544px;left:108px;white-space:nowrap" class="ft24852"><b>Setting Up Logging&#160;<br/></b>For Unix-based servers, logging can be sent the&#160;<i>syslog</i>&#160;daemon. A new configuration</p>
<p style="position:absolute;top:598px;left:108px;white-space:nowrap" class="ft24814">specific for Unix can be created as a subclass of&#160;ProductionConfig, as shown in</p>
<p style="position:absolute;top:617px;left:108px;white-space:nowrap" class="ft24817"><a href="Flask.html#248">Example 17-10</a>.</p>
<p style="position:absolute;top:649px;left:108px;white-space:nowrap" class="ft24847"><i>Example 17-10. config.py: Unix example configuration<br/></i><b>class</b>&#160;<b>UnixConfig</b>(ProductionConfig):<br/>&#160; &#160;&#160;@classmethod<br/>&#160; &#160;&#160;<b>def</b>&#160;init_app(cls,&#160;app):<br/>&#160; &#160; &#160; &#160;&#160;ProductionConfig.init_app(app)</p>
<p style="position:absolute;top:753px;left:108px;white-space:nowrap" class="ft24847">&#160; &#160; &#160; &#160;&#160;<i># log to syslog<br/></i>&#160; &#160; &#160; &#160;&#160;<b>import</b>&#160;<b>logging<br/></b>&#160; &#160; &#160; &#160;&#160;<b>from</b>&#160;<b>logging.handlers</b>&#160;<b>import</b>&#160;SysLogHandler<br/>&#160; &#160; &#160; &#160;&#160;syslog_handler&#160;=&#160;SysLogHandler()<br/>&#160; &#160; &#160; &#160;&#160;syslog_handler.setLevel(logging.WARNING)<br/>&#160; &#160; &#160; &#160;&#160;app.logger.addHandler(syslog_handler)</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft2485"><b>228&#160;&#160;|&#160;&#160;Chapter 17: Deployment</b></p>
</div>
<!-- Page 249 -->
<a name="249"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page249-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask249.png" alt="background image"/>
<p style="position:absolute;top:78px;left:108px;white-space:nowrap" class="ft24914">With this configuration, application logs will be written to&#160;<i>/var/log/messages</i>. The syslog</p>
<p style="position:absolute;top:97px;left:108px;white-space:nowrap" class="ft24914">service can be configured to write a separate log file or to send the logs to a different</p>
<p style="position:absolute;top:116px;left:108px;white-space:nowrap" class="ft24914">machine if necessary.</p>
<p style="position:absolute;top:158px;left:198px;white-space:nowrap" class="ft24925">If&#160;you&#160;have&#160;cloned&#160;the&#160;application’s&#160;Git&#160;repository&#160;on&#160;GitHub,&#160;you&#160;can</p>
<p style="position:absolute;top:176px;left:198px;white-space:nowrap" class="ft24925">run&#160;git&#160;checkout&#160;17d&#160;to&#160;check&#160;out&#160;this&#160;version&#160;of&#160;the&#160;application.</p>
<p style="position:absolute;top:915px;left:516px;white-space:nowrap" class="ft2495"><b>Traditional Hosting&#160;&#160;|&#160;&#160;229</b></p>
</div>
<!-- Page 250 -->
<a name="250"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page250-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask250.png" alt="background image"/>
</div>
<!-- Page 251 -->
<a name="251"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page251-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask251.png" alt="background image"/>
<p style="position:absolute;top:104px;left:549px;white-space:nowrap" class="ft25128"><b>CHAPTER 18</b></p>
<p style="position:absolute;top:131px;left:389px;white-space:nowrap" class="ft25111"><b>Additional Resources</b></p>
<p style="position:absolute;top:345px;left:108px;white-space:nowrap" class="ft25114">You are pretty much done with this book. Congratulations! I hope the topics that I have</p>
<p style="position:absolute;top:364px;left:108px;white-space:nowrap" class="ft25114">covered have given you a solid base to begin building your own applications with Flask.</p>
<p style="position:absolute;top:383px;left:108px;white-space:nowrap" class="ft25114">The code examples are open source and have a permissive license, so you are welcome</p>
<p style="position:absolute;top:402px;left:108px;white-space:nowrap" class="ft25114">to use as much of my code as you want to seed your projects, even if they are of a</p>
<p style="position:absolute;top:421px;left:108px;white-space:nowrap" class="ft25114">commercial nature. In this short final chapter, I want to give you a list of additional tips</p>
<p style="position:absolute;top:440px;left:108px;white-space:nowrap" class="ft25114">and resources that might be useful as you continue working with Flask.</p>
<p style="position:absolute;top:477px;left:108px;white-space:nowrap" class="ft25122"><b>Using an Integrated Development Environment (IDE)&#160;<br/></b>Developing Flask applications in an integrated development environment (IDE) can be</p>
<p style="position:absolute;top:537px;left:108px;white-space:nowrap" class="ft25114">very convenient, since features such as code completion and an interactive debugger</p>
<p style="position:absolute;top:556px;left:108px;white-space:nowrap" class="ft25114">can speed up the coding process considerably. Some of the IDEs that work well with</p>
<p style="position:absolute;top:575px;left:108px;white-space:nowrap" class="ft25114">Flask are listed here:</p>
<p style="position:absolute;top:609px;left:121px;white-space:nowrap" class="ft25114">•&#160;<a href="http://bit.ly/py-charm">PyCharm: Commercial IDE from J</a>etBrains with Community (free) and Professio‐</p>
<p style="position:absolute;top:628px;left:135px;white-space:nowrap" class="ft25114">nal (paid) editions, both compatible with Flask applications. Available on Linux,</p>
<p style="position:absolute;top:647px;left:135px;white-space:nowrap" class="ft25114">Mac OS X, and Windows.</p>
<p style="position:absolute;top:672px;left:121px;white-space:nowrap" class="ft25114">•&#160;<a href="http://pydev.org">PyDev: Open source IDE based on Eclipse. A</a>vailable on Linux, Mac OS X, and</p>
<p style="position:absolute;top:691px;left:135px;white-space:nowrap" class="ft25114">Windows.</p>
<p style="position:absolute;top:716px;left:121px;white-space:nowrap" class="ft25114">•&#160;<a href="http://pytools.codeplex.com/">Python Tools for Visual Studio: Free IDE built as an extension to Microsoft</a>’s Visual</p>
<p style="position:absolute;top:734px;left:135px;white-space:nowrap" class="ft25114">Studio environment. For Microsoft Windows only.</p>
<p style="position:absolute;top:915px;left:631px;white-space:nowrap" class="ft2515"><b>231</b></p>
</div>
<!-- Page 252 -->
<a name="252"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page252-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask252.png" alt="background image"/>
<p style="position:absolute;top:85px;left:198px;white-space:nowrap" class="ft25225">When&#160;configuring&#160;a&#160;Flask&#160;application&#160;to&#160;start&#160;under&#160;a&#160;debugger,&#160;add</p>
<p style="position:absolute;top:103px;left:198px;white-space:nowrap" class="ft25225">the&#160;--passthrough-errors&#160;--no-reload&#160;options&#160;to&#160;the&#160;runserver</p>
<p style="position:absolute;top:121px;left:198px;white-space:nowrap" class="ft25225">command.&#160;The&#160;first&#160;option&#160;disables&#160;the&#160;catching&#160;of&#160;errors&#160;by&#160;Flask&#160;so</p>
<p style="position:absolute;top:138px;left:198px;white-space:nowrap" class="ft25225">that&#160;exceptions&#160;thrown&#160;while&#160;a&#160;request&#160;is&#160;handled&#160;are&#160;sent&#160;all&#160;the&#160;way</p>
<p style="position:absolute;top:155px;left:198px;white-space:nowrap" class="ft25225">up&#160;to&#160;the&#160;debugger.&#160;The&#160;second&#160;disables&#160;the&#160;reloader&#160;module,&#160;which</p>
<p style="position:absolute;top:173px;left:198px;white-space:nowrap" class="ft25225">confuses&#160;some&#160;debuggers.</p>
<p style="position:absolute;top:214px;left:108px;white-space:nowrap" class="ft25218"><b>Finding Flask Extensions<br/></b>The examples in this book rely on several extensions and packages, but there are many</p>
<p style="position:absolute;top:273px;left:108px;white-space:nowrap" class="ft25214">more that are also useful and were not discussed. Following is a short list of some ad‐</p>
<p style="position:absolute;top:292px;left:108px;white-space:nowrap" class="ft25214">ditional packages that are worth exploring:</p>
<p style="position:absolute;top:326px;left:121px;white-space:nowrap" class="ft25219">•&#160;<a href="http://bit.ly/fl-babel">Flask-Babel</a>: Internationalization and localization support<br/>•&#160;<a href="http://bit.ly/fl-rest">Flask-RESTful</a>: Tools for building RESTful APIs<br/>•&#160;<a href="http://bit.ly/celery-doc">Celery</a>: Task queue for processing background jobs<br/>•&#160;<a href="http://bit.ly/flask-frozen">Frozen-Flask: Con</a>version of a Flask application to a static website<br/>•&#160;<a href="http://bit.ly/flask-debug">Flask-DebugToolbar</a>: In-browser debugging tools<br/>•&#160;<a href="http://bit.ly/fl-assets">Flask-Assets</a>: Merging, minifying, and compiling of CSS and JavaScript assets<br/>•&#160;<a href="http://bit.ly/fl-oauth">Flask-OAuth</a>: Authentication against OAuth providers<br/>•&#160;<a href="http://bit.ly/fl-opID">Flask-OpenID: A</a>uthentication against OpenID providers<br/>•&#160;<a href="http://bit.ly/fl-whoosh">Flask-WhooshAlchemy: F</a>ull-text search for Flask-SQLAlchemy models based on</p>
<p style="position:absolute;top:544px;left:135px;white-space:nowrap" class="ft25217"><a href="http://pythonhosted.org//Whoosh/">Whoosh</a></p>
<p style="position:absolute;top:569px;left:121px;white-space:nowrap" class="ft25214">•&#160;<a href="http://bit.ly/fl-kvses">Flask-KVsession</a>: Alternative implementation of user sessions that use server-side</p>
<p style="position:absolute;top:588px;left:135px;white-space:nowrap" class="ft25214">storage</p>
<p style="position:absolute;top:622px;left:108px;white-space:nowrap" class="ft25214">If the functionality that you need for your project is not covered by any of the extensions</p>
<p style="position:absolute;top:641px;left:108px;white-space:nowrap" class="ft25214">and packages mentioned in this book, then your first destination to look for additional</p>
<p style="position:absolute;top:660px;left:108px;white-space:nowrap" class="ft25214"><a href="http://bit.ly/fl-exreg">extensions should be the official&#160;Flask Extension Registry</a>. Other good places to search</p>
<p style="position:absolute;top:679px;left:108px;white-space:nowrap" class="ft25214">are the&#160;<a href="http://pypi.python.org">Python Package Index,&#160;</a><a href="http://github.com">GitHub</a>, and&#160;<a href="http://bitbucket.org">BitBucket.</a></p>
<p style="position:absolute;top:715px;left:108px;white-space:nowrap" class="ft25218"><b>Getting Involved with Flask<br/></b>Flask would not be as awesome without the work done by its community of developers.</p>
<p style="position:absolute;top:774px;left:108px;white-space:nowrap" class="ft25214">As you are now becoming part of this community and benefiting from the work of so</p>
<p style="position:absolute;top:793px;left:108px;white-space:nowrap" class="ft25214">many volunteers, you should consider finding a way to give something back. Here are</p>
<p style="position:absolute;top:812px;left:108px;white-space:nowrap" class="ft25214">some ideas to help you get started:</p>
<p style="position:absolute;top:846px;left:121px;white-space:nowrap" class="ft25214">•&#160;Review the documentation for Flask or your favorite related project and submit</p>
<p style="position:absolute;top:865px;left:135px;white-space:nowrap" class="ft25214">corrections or improvements.</p>
<p style="position:absolute;top:915px;left:108px;white-space:nowrap" class="ft2525"><b>232&#160;&#160;|&#160;&#160;Chapter 18: Additional Resources</b></p>
</div>
<!-- Page 253 -->
<a name="253"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page253-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask253.png" alt="background image"/>
<p style="position:absolute;top:78px;left:121px;white-space:nowrap" class="ft25319">•&#160;Translate the documentation to a new language.<br/>•&#160;Answer questions on Q&amp;A sites such as&#160;<a href="http://stackoverflow.com">Stack Overflow</a>.<br/>•&#160;Talk about your work with your peers at user group meetings or conferences.<br/>•&#160;Contribute bug fixes or improvements to packages that you use.<br/>•&#160;Write new Flask extensions and release them as open source.<br/>•&#160;Release your applications as open source.</p>
<p style="position:absolute;top:237px;left:108px;white-space:nowrap" class="ft25314">I hope you decide to volunteer in one of these ways or any others that are meaningful</p>
<p style="position:absolute;top:256px;left:108px;white-space:nowrap" class="ft25314">to you. If you do, thank you!</p>
<p style="position:absolute;top:915px;left:480px;white-space:nowrap" class="ft2535"><b>Getting Involved with Flask&#160;&#160;|&#160;&#160;233</b></p>
</div>
<!-- Page 254 -->
<a name="254"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page254-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask254.png" alt="background image"/>
</div>
<!-- Page 255 -->
<a name="255"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page255-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask255.png" alt="background image"/>
<p style="position:absolute;top:869px;left:108px;white-space:nowrap" class="ft2554"><i>We’d like to hear your suggestions for improving our indexes. Send email to index@oreilly.com.</i></p>
<p style="position:absolute;top:107px;left:578px;white-space:nowrap" class="ft25511"><b>Index</b></p>
<p style="position:absolute;top:365px;left:108px;white-space:nowrap" class="ft25513"><b>Symbols</b></p>
<p style="position:absolute;top:390px;left:108px;white-space:nowrap" class="ft25530">.en<a href="Flask.html#242">v file,&#160;222,&#160;</a><a href="Flask.html#248">228</a></p>
<p style="position:absolute;top:424px;left:108px;white-space:nowrap" class="ft25513"><b>A</b></p>
<p style="position:absolute;top:449px;left:108px;white-space:nowrap" class="ft25530">application programming interfaces (APIs)</p>
<p style="position:absolute;top:465px;left:126px;white-space:nowrap" class="ft25530">resources,&#160;<a href="Flask.html#208">188</a></p>
<p style="position:absolute;top:481px;left:126px;white-space:nowrap" class="ft25530">versioning,&#160;<a href="Flask.html#198">178</a></p>
<p style="position:absolute;top:498px;left:108px;white-space:nowrap" class="ft25530">authentica<a href="Flask.html#201">tion,&#160;181,&#160;</a><a href="Flask.html#204">184</a></p>
<p style="position:absolute;top:531px;left:108px;white-space:nowrap" class="ft25513"><b>C</b></p>
<p style="position:absolute;top:556px;left:108px;white-space:nowrap" class="ft25530"><a href="Flask.html#237">cloud,&#160;217</a></p>
<p style="position:absolute;top:573px;left:108px;white-space:nowrap" class="ft25530"><a href="Flask.html#217">code coverage,&#160;197</a></p>
<p style="position:absolute;top:589px;left:108px;white-space:nowrap" class="ft25530">configuration,&#160;<a href="Flask.html#231">211</a><a href="Flask.html#236">,&#160;216,&#160;</a><a href="Flask.html#248">228</a></p>
<p style="position:absolute;top:623px;left:108px;white-space:nowrap" class="ft25513"><b>D</b></p>
<p style="position:absolute;top:648px;left:108px;white-space:nowrap" class="ft25530">database</p>
<p style="position:absolute;top:664px;left:126px;white-space:nowrap" class="ft25530">associa<a href="Flask.html#170">tion table,&#160;150</a></p>
<p style="position:absolute;top:680px;left:126px;white-space:nowrap" class="ft25530">filter_by query filter,&#160;<a href="Flask.html#179">159</a></p>
<p style="position:absolute;top:696px;left:126px;white-space:nowrap" class="ft25530">join query filter<a href="Flask.html#179">,&#160;159</a></p>
<p style="position:absolute;top:712px;left:126px;white-space:nowrap" class="ft25530">joins,&#160;<a href="Flask.html#178">158</a></p>
<p style="position:absolute;top:729px;left:126px;white-space:nowrap" class="ft25530">migra<a href="Flask.html#84">tions,&#160;64</a></p>
<p style="position:absolute;top:745px;left:126px;white-space:nowrap" class="ft25530">NoSQL,&#160;<a href="Flask.html#70">50</a></p>
<p style="position:absolute;top:761px;left:126px;white-space:nowrap" class="ft25530"><a href="Flask.html#231">performance,&#160;211</a></p>
<p style="position:absolute;top:777px;left:126px;white-space:nowrap" class="ft25530">relational model,&#160;<a href="Flask.html#69">49</a></p>
<p style="position:absolute;top:793px;left:126px;white-space:nowrap" class="ft25530">rela<a href="Flask.html#76">tionships,&#160;56</a><a href="Flask.html#81">,&#160;61</a><a href="Flask.html#169">,&#160;149,&#160;</a><a href="Flask.html#186">166</a></p>
<p style="position:absolute;top:810px;left:126px;white-space:nowrap" class="ft25530"><a href="Flask.html#69">SQL,&#160;49</a></p>
<p style="position:absolute;top:826px;left:108px;white-space:nowrap" class="ft25530">debugging,&#160;<a href="Flask.html#236">216</a></p>
<p style="position:absolute;top:365px;left:386px;white-space:nowrap" class="ft25530">decorators,&#160;<a href="Flask.html#135">115</a></p>
<p style="position:absolute;top:399px;left:386px;white-space:nowrap" class="ft25513"><b>E</b></p>
<p style="position:absolute;top:424px;left:386px;white-space:nowrap" class="ft25530"><a href="Flask.html#241">email,&#160;221</a></p>
<p style="position:absolute;top:440px;left:386px;white-space:nowrap" class="ft25530">error handling,&#160;<a href="Flask.html#200">180</a></p>
<p style="position:absolute;top:474px;left:386px;white-space:nowrap" class="ft25513"><b>F</b></p>
<p style="position:absolute;top:499px;left:386px;white-space:nowrap" class="ft25530">Flask,&#160;<a href="Flask.html#23">3</a></p>
<p style="position:absolute;top:515px;left:405px;white-space:nowrap" class="ft25530"><a href="Flask.html#36">abort function,&#160;16</a><a href="Flask.html#200">,&#160;180</a></p>
<p style="position:absolute;top:531px;left:405px;white-space:nowrap" class="ft25530"><a href="Flask.html#34">add_url_route function,&#160;14</a></p>
<p style="position:absolute;top:547px;left:405px;white-space:nowrap" class="ft25530">after_a<a href="Flask.html#231">pp_request hook,&#160;211</a></p>
<p style="position:absolute;top:564px;left:405px;white-space:nowrap" class="ft25530">application factory function,&#160;<a href="Flask.html#98">78</a></p>
<p style="position:absolute;top:580px;left:405px;white-space:nowrap" class="ft25530">app_errorhandler decorator<a href="Flask.html#100">,&#160;80</a><a href="Flask.html#200">,&#160;180</a></p>
<p style="position:absolute;top:596px;left:405px;white-space:nowrap" class="ft25530">before_app_request hook,&#160;<a href="Flask.html#127">107</a></p>
<p style="position:absolute;top:612px;left:405px;white-space:nowrap" class="ft25530"><a href="Flask.html#35">before_request hook,&#160;15</a><a href="Flask.html#203">,&#160;183</a></p>
<p style="position:absolute;top:628px;left:405px;white-space:nowrap" class="ft25530">blueprin<a href="Flask.html#99">ts,&#160;79,&#160;</a><a href="Flask.html#112">92</a><a href="Flask.html#199">,&#160;179</a></p>
<p style="position:absolute;top:645px;left:405px;white-space:nowrap" class="ft25530">configuration object,&#160;<a href="Flask.html#98">78</a></p>
<p style="position:absolute;top:661px;left:405px;white-space:nowrap" class="ft25530">con<a href="Flask.html#83">text processors,&#160;63</a><a href="Flask.html#136">,&#160;116</a></p>
<p style="position:absolute;top:677px;left:405px;white-space:nowrap" class="ft25530">contexts,&#160;<a href="Flask.html#32">12,&#160;</a><a href="Flask.html#104">84</a></p>
<p style="position:absolute;top:693px;left:405px;white-space:nowrap" class="ft25530"><a href="Flask.html#181">cookies,&#160;161</a></p>
<p style="position:absolute;top:709px;left:405px;white-space:nowrap" class="ft25530">current_app con<a href="Flask.html#33">text variable,&#160;13</a><a href="Flask.html#104">,&#160;84</a></p>
<p style="position:absolute;top:726px;left:405px;white-space:nowrap" class="ft25530">debug argument,&#160;<a href="Flask.html#29">9</a></p>
<p style="position:absolute;top:742px;left:405px;white-space:nowrap" class="ft25530">dynamic routes,&#160;<a href="Flask.html#28">8</a></p>
<p style="position:absolute;top:758px;left:405px;white-space:nowrap" class="ft25530">errorhandler decorator,&#160;<a href="Flask.html#49">29,&#160;</a><a href="Flask.html#99">79,&#160;</a><a href="Flask.html#100">80,&#160;</a><a href="Flask.html#208">188</a></p>
<p style="position:absolute;top:774px;left:405px;white-space:nowrap" class="ft25530">extension registry,&#160;<a href="Flask.html#252">232</a></p>
<p style="position:absolute;top:790px;left:405px;white-space:nowrap" class="ft25530">flash function,&#160;<a href="Flask.html#66">46</a></p>
<p style="position:absolute;top:807px;left:405px;white-space:nowrap" class="ft25530"><a href="Flask.html#27">Flask class,&#160;7</a></p>
<p style="position:absolute;top:823px;left:405px;white-space:nowrap" class="ft25530">flask.ext namespace,&#160;<a href="Flask.html#37">17,&#160;</a><a href="Flask.html#46">26</a></p>
<p style="position:absolute;top:919px;left:631px;white-space:nowrap" class="ft2555"><b>235</b></p>
</div>
<!-- Page 256 -->
<a name="256"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page256-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask256.png" alt="background image"/>
<p style="position:absolute;top:79px;left:126px;white-space:nowrap" class="ft25630">g context variable,&#160;<a href="Flask.html#33">13,&#160;</a><a href="Flask.html#35">15</a></p>
<p style="position:absolute;top:95px;left:126px;white-space:nowrap" class="ft25630">get_flashed_messages templa<a href="Flask.html#67">te function,&#160;47</a></p>
<p style="position:absolute;top:111px;left:126px;white-space:nowrap" class="ft25630">jsonify function,&#160;<a href="Flask.html#199">179</a></p>
<p style="position:absolute;top:127px;left:126px;white-space:nowrap" class="ft25630">make_response function,&#160;<a href="Flask.html#36">16,&#160;</a><a href="Flask.html#181">161</a></p>
<p style="position:absolute;top:144px;left:126px;white-space:nowrap" class="ft25630">methods argumen<a href="Flask.html#62">t,&#160;42</a></p>
<p style="position:absolute;top:160px;left:126px;white-space:nowrap" class="ft25630">redirect function,&#160;<a href="Flask.html#36">16,&#160;</a><a href="Flask.html#65">45</a></p>
<p style="position:absolute;top:176px;left:126px;white-space:nowrap" class="ft25630">render_templa<a href="Flask.html#42">te function,&#160;22</a><a href="Flask.html#66">,&#160;46</a></p>
<p style="position:absolute;top:192px;left:126px;white-space:nowrap" class="ft25630">request con<a href="Flask.html#32">text variable,&#160;12</a><a href="Flask.html#33">,&#160;13</a></p>
<p style="position:absolute;top:208px;left:126px;white-space:nowrap" class="ft25630">Response class,&#160;<a href="Flask.html#36">16</a></p>
<p style="position:absolute;top:225px;left:126px;white-space:nowrap" class="ft25630">route decorator,&#160;<a href="Flask.html#28">8</a><a href="Flask.html#34">,&#160;14</a>,&#160;<a href="Flask.html#99">79</a></p>
<p style="position:absolute;top:241px;left:126px;white-space:nowrap" class="ft25630"><a href="Flask.html#29">run method,&#160;9</a></p>
<p style="position:absolute;top:257px;left:126px;white-space:nowrap" class="ft25630">SECRET_KEY configuration,&#160;<a href="Flask.html#96">76</a></p>
<p style="position:absolute;top:273px;left:126px;white-space:nowrap" class="ft25630">server sh<a href="Flask.html#226">utdown,&#160;206</a></p>
<p style="position:absolute;top:289px;left:126px;white-space:nowrap" class="ft25630">session context variable,&#160;<a href="Flask.html#33">13,&#160;</a><a href="Flask.html#65">45</a></p>
<p style="position:absolute;top:306px;left:126px;white-space:nowrap" class="ft25630">set_cookie method,&#160;<a href="Flask.html#36">16</a></p>
<p style="position:absolute;top:322px;left:126px;white-space:nowrap" class="ft25630">sta<a href="Flask.html#52">tic files,&#160;32</a></p>
<p style="position:absolute;top:338px;left:126px;white-space:nowrap" class="ft25630">static folder<a href="Flask.html#53">,&#160;33</a></p>
<p style="position:absolute;top:354px;left:126px;white-space:nowrap" class="ft25630">templates folder,&#160;<a href="Flask.html#42">22</a></p>
<p style="position:absolute;top:370px;left:126px;white-space:nowrap" class="ft25630">test clien<a href="Flask.html#220">t,&#160;200</a></p>
<p style="position:absolute;top:387px;left:126px;white-space:nowrap" class="ft25630">URL map,&#160;<a href="Flask.html#34">14</a></p>
<p style="position:absolute;top:403px;left:126px;white-space:nowrap" class="ft25630"><a href="Flask.html#52">url_for function,&#160;32</a><a href="Flask.html#65">,&#160;45</a><a href="Flask.html#101">,&#160;81</a><a href="Flask.html#126">,&#160;106</a></p>
<p style="position:absolute;top:419px;left:126px;white-space:nowrap" class="ft25630">url_prefix argumen<a href="Flask.html#113">t,&#160;93</a></p>
<p style="position:absolute;top:435px;left:108px;white-space:nowrap" class="ft25630">Flask-Bootstrap,&#160;<a href="Flask.html#46">26</a></p>
<p style="position:absolute;top:451px;left:126px;white-space:nowrap" class="ft25630"><a href="Flask.html#48">blocks,&#160;28</a></p>
<p style="position:absolute;top:468px;left:126px;white-space:nowrap" class="ft25630">quick_form macro,&#160;<a href="Flask.html#60">40</a></p>
<p style="position:absolute;top:484px;left:108px;white-space:nowrap" class="ft25630">Flask-HTTPA<a href="Flask.html#201">uth,&#160;181</a></p>
<p style="position:absolute;top:500px;left:108px;white-space:nowrap" class="ft25630">Flask-Login,&#160;<a href="Flask.html#114">94</a></p>
<p style="position:absolute;top:516px;left:126px;white-space:nowrap" class="ft25630">AnonymousU<a href="Flask.html#135">serMixin class,&#160;115</a></p>
<p style="position:absolute;top:532px;left:126px;white-space:nowrap" class="ft25630">current_user context variable,&#160;<a href="Flask.html#116">96</a></p>
<p style="position:absolute;top:549px;left:126px;white-space:nowrap" class="ft25630">LoginM<a href="Flask.html#115">anager class,&#160;95</a></p>
<p style="position:absolute;top:565px;left:126px;white-space:nowrap" class="ft25630">login_required decorator,&#160;<a href="Flask.html#115">95,&#160;</a><a href="Flask.html#127">107</a></p>
<p style="position:absolute;top:581px;left:126px;white-space:nowrap" class="ft25630"><a href="Flask.html#118">login_user function,&#160;98</a></p>
<p style="position:absolute;top:597px;left:126px;white-space:nowrap" class="ft25630"><a href="Flask.html#119">logout_user function,&#160;99</a></p>
<p style="position:absolute;top:613px;left:126px;white-space:nowrap" class="ft25630">U<a href="Flask.html#114">serMixin class,&#160;94</a></p>
<p style="position:absolute;top:630px;left:126px;white-space:nowrap" class="ft25630">user_loader decorator,&#160;<a href="Flask.html#115">95</a></p>
<p style="position:absolute;top:646px;left:108px;white-space:nowrap" class="ft25630">Flask-Mail,&#160;<a href="Flask.html#89">69</a></p>
<p style="position:absolute;top:662px;left:126px;white-space:nowrap" class="ft25630">asynchronous sending,&#160;<a href="Flask.html#92">72</a></p>
<p style="position:absolute;top:678px;left:126px;white-space:nowrap" class="ft25630">Gmail configura<a href="Flask.html#89">tion,&#160;69</a></p>
<p style="position:absolute;top:694px;left:108px;white-space:nowrap" class="ft25630">Flask-Migrate,&#160;<a href="Flask.html#84">64</a></p>
<p style="position:absolute;top:711px;left:108px;white-space:nowrap" class="ft25630">Flask-Moment,&#160;<a href="Flask.html#53">33</a></p>
<p style="position:absolute;top:727px;left:126px;white-space:nowrap" class="ft25630">forma<a href="Flask.html#54">t method,&#160;34</a></p>
<p style="position:absolute;top:743px;left:126px;white-space:nowrap" class="ft25630">fromN<a href="Flask.html#54">ow method,&#160;34</a></p>
<p style="position:absolute;top:759px;left:126px;white-space:nowrap" class="ft25630">lang method,&#160;<a href="Flask.html#55">35</a></p>
<p style="position:absolute;top:775px;left:108px;white-space:nowrap" class="ft25630"><a href="Flask.html#37">Flask-Script,&#160;17</a></p>
<p style="position:absolute;top:792px;left:108px;white-space:nowrap" class="ft25630">Flask-SQLAlchemy<a href="Flask.html#72">,&#160;52</a></p>
<p style="position:absolute;top:808px;left:126px;white-space:nowrap" class="ft25630"><a href="Flask.html#78">add session method,&#160;58</a>,&#160;<a href="Flask.html#80">60</a></p>
<p style="position:absolute;top:824px;left:126px;white-space:nowrap" class="ft25630"><a href="Flask.html#75">column options,&#160;55</a></p>
<p style="position:absolute;top:840px;left:126px;white-space:nowrap" class="ft25630"><a href="Flask.html#74">column types,&#160;54</a></p>
<p style="position:absolute;top:856px;left:126px;white-space:nowrap" class="ft25630">crea<a href="Flask.html#78">te_all method,&#160;58</a></p>
<p style="position:absolute;top:79px;left:405px;white-space:nowrap" class="ft25630">delete session method,&#160;<a href="Flask.html#80">60</a></p>
<p style="position:absolute;top:95px;left:405px;white-space:nowrap" class="ft25630">drop_all method,&#160;<a href="Flask.html#78">58</a></p>
<p style="position:absolute;top:111px;left:405px;white-space:nowrap" class="ft25630">filter_by query filter<a href="Flask.html#83">,&#160;63</a></p>
<p style="position:absolute;top:127px;left:405px;white-space:nowrap" class="ft25630"><a href="Flask.html#231">get_debug_queries function,&#160;211</a></p>
<p style="position:absolute;top:144px;left:405px;white-space:nowrap" class="ft25630"><a href="Flask.html#74">models,&#160;54</a></p>
<p style="position:absolute;top:160px;left:405px;white-space:nowrap" class="ft25630">MySQL configura<a href="Flask.html#72">tion,&#160;52</a></p>
<p style="position:absolute;top:176px;left:405px;white-space:nowrap" class="ft25630">paginate quer<a href="Flask.html#211">y method,&#160;191</a></p>
<p style="position:absolute;top:192px;left:405px;white-space:nowrap" class="ft25630">Postgres configuration,&#160;<a href="Flask.html#72">52</a></p>
<p style="position:absolute;top:208px;left:405px;white-space:nowrap" class="ft25630">quer<a href="Flask.html#81">y executors,&#160;61</a></p>
<p style="position:absolute;top:225px;left:405px;white-space:nowrap" class="ft25630">quer<a href="Flask.html#81">y filters,&#160;61</a></p>
<p style="position:absolute;top:241px;left:405px;white-space:nowrap" class="ft25630">quer<a href="Flask.html#80">y object,&#160;60</a></p>
<p style="position:absolute;top:257px;left:405px;white-space:nowrap" class="ft25630">SQLALCHEMY_COMMIT_ON_TEAR‐</p>
<p style="position:absolute;top:273px;left:423px;white-space:nowrap" class="ft25630">DOWN configura<a href="Flask.html#73">tion,&#160;53</a></p>
<p style="position:absolute;top:289px;left:405px;white-space:nowrap" class="ft25630">SQLALCHEMY_DATABASE_URI configu‐</p>
<p style="position:absolute;top:306px;left:423px;white-space:nowrap" class="ft25630">ration,&#160;<a href="Flask.html#73">53,&#160;</a><a href="Flask.html#96">76</a></p>
<p style="position:absolute;top:322px;left:405px;white-space:nowrap" class="ft25630">SQLite configuration,&#160;<a href="Flask.html#72">52</a></p>
<p style="position:absolute;top:338px;left:386px;white-space:nowrap" class="ft25630">Flask-SSLify,&#160;<a href="Flask.html#243">223</a></p>
<p style="position:absolute;top:354px;left:386px;white-space:nowrap" class="ft25630">Flask-WTF,&#160;<a href="Flask.html#57">37</a></p>
<p style="position:absolute;top:370px;left:405px;white-space:nowrap" class="ft25630">B<a href="Flask.html#116">ooleanField class,&#160;96</a></p>
<p style="position:absolute;top:387px;left:405px;white-space:nowrap" class="ft25630">Cross-Site Request Forger<a href="Flask.html#57">y (CSRF),&#160;37</a></p>
<p style="position:absolute;top:403px;left:405px;white-space:nowrap" class="ft25630">custom validators,&#160;<a href="Flask.html#121">101</a></p>
<p style="position:absolute;top:419px;left:405px;white-space:nowrap" class="ft25630">Email validator,&#160;<a href="Flask.html#116">96</a></p>
<p style="position:absolute;top:435px;left:405px;white-space:nowrap" class="ft25630">EqualTo validator<a href="Flask.html#121">,&#160;101</a></p>
<p style="position:absolute;top:451px;left:405px;white-space:nowrap" class="ft25630">Form class,&#160;<a href="Flask.html#58">38</a></p>
<p style="position:absolute;top:468px;left:405px;white-space:nowrap" class="ft25630">form fields,&#160;<a href="Flask.html#59">39</a></p>
<p style="position:absolute;top:484px;left:405px;white-space:nowrap" class="ft25630">P<a href="Flask.html#116">asswordField class,&#160;96</a></p>
<p style="position:absolute;top:500px;left:405px;white-space:nowrap" class="ft25630">Regexp validator,&#160;<a href="Flask.html#121">101</a></p>
<p style="position:absolute;top:516px;left:405px;white-space:nowrap" class="ft25630"><a href="Flask.html#60">rendering,&#160;40</a></p>
<p style="position:absolute;top:532px;left:405px;white-space:nowrap" class="ft25630">Required validator,&#160;<a href="Flask.html#58">38</a></p>
<p style="position:absolute;top:549px;left:405px;white-space:nowrap" class="ft25630">StringField class,&#160;<a href="Flask.html#58">38</a></p>
<p style="position:absolute;top:565px;left:405px;white-space:nowrap" class="ft25630"><a href="Flask.html#58">SubmitField class,&#160;38</a></p>
<p style="position:absolute;top:581px;left:405px;white-space:nowrap" class="ft25630">validate_on_submit function,&#160;<a href="Flask.html#118">98</a></p>
<p style="position:absolute;top:597px;left:405px;white-space:nowrap" class="ft25630">validate_on_submit method,&#160;<a href="Flask.html#62">42</a></p>
<p style="position:absolute;top:613px;left:405px;white-space:nowrap" class="ft25630">validators,&#160;<a href="Flask.html#58">38,&#160;</a><a href="Flask.html#59">39</a></p>
<p style="position:absolute;top:630px;left:386px;white-space:nowrap" class="ft25630">F<a href="Flask.html#238">oreman,&#160;218,&#160;</a><a href="Flask.html#242">222</a></p>
<p style="position:absolute;top:663px;left:386px;white-space:nowrap" class="ft25613"><b>G</b></p>
<p style="position:absolute;top:688px;left:386px;white-space:nowrap" class="ft25630">Git,&#160;<a href="Flask.html#15">xiii</a><a href="Flask.html#238">,&#160;218,&#160;</a><a href="Flask.html#245">225</a></p>
<p style="position:absolute;top:705px;left:386px;white-space:nowrap" class="ft25630"><a href="Flask.html#241">Gunicorn,&#160;221,&#160;</a><a href="Flask.html#242">222</a></p>
<p style="position:absolute;top:738px;left:386px;white-space:nowrap" class="ft25613"><b>H</b></p>
<p style="position:absolute;top:763px;left:386px;white-space:nowrap" class="ft25630">H<a href="Flask.html#238">eroku,&#160;218</a></p>
<p style="position:absolute;top:780px;left:386px;white-space:nowrap" class="ft25630">Heroku client,&#160;<a href="Flask.html#238">218</a></p>
<p style="position:absolute;top:796px;left:386px;white-space:nowrap" class="ft25630">Heroku toolbelt,&#160;<a href="Flask.html#238">218</a></p>
<p style="position:absolute;top:812px;left:386px;white-space:nowrap" class="ft25630">HTTP sta<a href="Flask.html#200">tus codes,&#160;180</a></p>
<p style="position:absolute;top:828px;left:386px;white-space:nowrap" class="ft25630">HTTPie,&#160;<a href="Flask.html#212">192</a></p>
<p style="position:absolute;top:919px;left:108px;white-space:nowrap" class="ft2565"><b>236&#160;&#160;|&#160;&#160;Index</b></p>
</div>
<!-- Page 257 -->
<a name="257"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page257-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask257.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft25713"><b>I</b></p>
<p style="position:absolute;top:104px;left:108px;white-space:nowrap" class="ft25730">integrated development environments (IDEs),</p>
<p style="position:absolute;top:120px;left:126px;white-space:nowrap" class="ft25770"><a href="Flask.html#251">231</a></p>
<p style="position:absolute;top:136px;left:108px;white-space:nowrap" class="ft25730"><a href="Flask.html#124">itsdangerous,&#160;104,&#160;</a><a href="Flask.html#204">184</a></p>
<p style="position:absolute;top:170px;left:108px;white-space:nowrap" class="ft25713"><b>J</b></p>
<p style="position:absolute;top:195px;left:108px;white-space:nowrap" class="ft25730">JavaScript Object Notation (<a href="Flask.html#197">JSON),&#160;177</a></p>
<p style="position:absolute;top:211px;left:126px;white-space:nowrap" class="ft25730">serializa<a href="Flask.html#206">tion,&#160;186</a></p>
<p style="position:absolute;top:228px;left:108px;white-space:nowrap" class="ft25730">Jinja2,&#160;<a href="Flask.html#23">3</a><a href="Flask.html#42">,&#160;22</a></p>
<p style="position:absolute;top:244px;left:126px;white-space:nowrap" class="ft25730"><a href="Flask.html#45">block directive,&#160;25</a><a href="Flask.html#47">,&#160;27</a></p>
<p style="position:absolute;top:260px;left:126px;white-space:nowrap" class="ft25730">extends directive,&#160;<a href="Flask.html#45">25,&#160;</a><a href="Flask.html#47">27</a></p>
<p style="position:absolute;top:276px;left:126px;white-space:nowrap" class="ft25730"><a href="Flask.html#43">filters,&#160;23</a></p>
<p style="position:absolute;top:292px;left:126px;white-space:nowrap" class="ft25730"><a href="Flask.html#44">for directive,&#160;24</a></p>
<p style="position:absolute;top:309px;left:126px;white-space:nowrap" class="ft25730"><a href="Flask.html#44">if directive,&#160;24</a><a href="Flask.html#61">,&#160;41</a></p>
<p style="position:absolute;top:325px;left:126px;white-space:nowrap" class="ft25730">im<a href="Flask.html#44">port directive,&#160;24,&#160;</a><a href="Flask.html#61">41</a></p>
<p style="position:absolute;top:341px;left:126px;white-space:nowrap" class="ft25730">include directive,&#160;<a href="Flask.html#45">25</a></p>
<p style="position:absolute;top:357px;left:126px;white-space:nowrap" class="ft25730"><a href="Flask.html#44">macro directive,&#160;24</a></p>
<p style="position:absolute;top:373px;left:126px;white-space:nowrap" class="ft25730">safe filter<a href="Flask.html#44">,&#160;24</a></p>
<p style="position:absolute;top:390px;left:126px;white-space:nowrap" class="ft25730"><a href="Flask.html#190">set directive,&#160;170</a></p>
<p style="position:absolute;top:406px;left:126px;white-space:nowrap" class="ft25730">super macro,&#160;<a href="Flask.html#45">25</a></p>
<p style="position:absolute;top:422px;left:126px;white-space:nowrap" class="ft25730">template inheritance,&#160;<a href="Flask.html#45">25</a></p>
<p style="position:absolute;top:438px;left:126px;white-space:nowrap" class="ft25730"><a href="Flask.html#43">variables,&#160;23</a></p>
<p style="position:absolute;top:472px;left:108px;white-space:nowrap" class="ft25713"><b>L</b></p>
<p style="position:absolute;top:497px;left:108px;white-space:nowrap" class="ft25730"><a href="Flask.html#231">logging,&#160;211,&#160;211</a>,&#160;<a href="Flask.html#236">216</a><a href="Flask.html#240">,&#160;220,&#160;</a><a href="Flask.html#246">226</a><a href="Flask.html#248">,&#160;228</a></p>
<p style="position:absolute;top:531px;left:108px;white-space:nowrap" class="ft25713"><b>M</b></p>
<p style="position:absolute;top:556px;left:108px;white-space:nowrap" class="ft25730">manage.py,&#160;<a href="Flask.html#96">76,&#160;</a><a href="Flask.html#101">81,&#160;</a><a href="Flask.html#248">228</a></p>
<p style="position:absolute;top:572px;left:126px;white-space:nowrap" class="ft25730"><a href="Flask.html#217">coverage command,&#160;197</a></p>
<p style="position:absolute;top:588px;left:126px;white-space:nowrap" class="ft25730">db command,&#160;<a href="Flask.html#84">64</a></p>
<p style="position:absolute;top:605px;left:126px;white-space:nowrap" class="ft25730"><a href="Flask.html#235">deploy command,&#160;215,&#160;</a><a href="Flask.html#242">222</a></p>
<p style="position:absolute;top:621px;left:126px;white-space:nowrap" class="ft25730"><a href="Flask.html#233">profile command,&#160;213</a></p>
<p style="position:absolute;top:637px;left:126px;white-space:nowrap" class="ft25730">runser<a href="Flask.html#38">ver command,&#160;18</a></p>
<p style="position:absolute;top:653px;left:126px;white-space:nowrap" class="ft25730"><a href="Flask.html#38">shell command,&#160;18</a>,&#160;<a href="Flask.html#83">63</a></p>
<p style="position:absolute;top:669px;left:126px;white-space:nowrap" class="ft25730">test command,&#160;<a href="Flask.html#104">84</a></p>
<p style="position:absolute;top:703px;left:108px;white-space:nowrap" class="ft25713"><b>P</b></p>
<p style="position:absolute;top:728px;left:108px;white-space:nowrap" class="ft25730">pagina<a href="Flask.html#211">tion,&#160;191</a></p>
<p style="position:absolute;top:744px;left:108px;white-space:nowrap" class="ft25730">password security, hashing,&#160;<a href="Flask.html#110">90</a></p>
<p style="position:absolute;top:761px;left:108px;white-space:nowrap" class="ft25730">performance,&#160;<a href="Flask.html#233">213</a></p>
<p style="position:absolute;top:777px;left:108px;white-space:nowrap" class="ft25730"><a href="Flask.html#132">permissions,&#160;112</a></p>
<p style="position:absolute;top:79px;left:386px;white-space:nowrap" class="ft25730">pip,&#160;<a href="Flask.html#26">6</a></p>
<p style="position:absolute;top:95px;left:386px;white-space:nowrap" class="ft25730">platform as a service (P<a href="Flask.html#237">aaS),&#160;217</a></p>
<p style="position:absolute;top:111px;left:386px;white-space:nowrap" class="ft25730">post/redirect/get pattern,&#160;<a href="Flask.html#64">44</a></p>
<p style="position:absolute;top:127px;left:386px;white-space:nowrap" class="ft25730">Procfile,&#160;<a href="Flask.html#242">222</a></p>
<p style="position:absolute;top:144px;left:386px;white-space:nowrap" class="ft25730">profiling source code,&#160;<a href="Flask.html#233">213</a></p>
<p style="position:absolute;top:160px;left:386px;white-space:nowrap" class="ft25730">proxy ser<a href="Flask.html#245">vers,&#160;225</a></p>
<p style="position:absolute;top:194px;left:386px;white-space:nowrap" class="ft25713"><b>R</b></p>
<p style="position:absolute;top:219px;left:386px;white-space:nowrap" class="ft25730">Representational State T<a href="Flask.html#195">ransfer (REST),&#160;175</a></p>
<p style="position:absolute;top:235px;left:386px;white-space:nowrap" class="ft25730">requirements file,&#160;<a href="Flask.html#96">76,&#160;</a><a href="Flask.html#102">82,&#160;</a><a href="Flask.html#242">222</a></p>
<p style="position:absolute;top:251px;left:386px;white-space:nowrap" class="ft25730">Rich Internet Applications (RIAs),&#160;<a href="Flask.html#195">175</a></p>
<p style="position:absolute;top:285px;left:386px;white-space:nowrap" class="ft25713"><b>S</b></p>
<p style="position:absolute;top:310px;left:386px;white-space:nowrap" class="ft25730">secure HTTP<a href="Flask.html#243">,&#160;223</a></p>
<p style="position:absolute;top:326px;left:386px;white-space:nowrap" class="ft25730"><a href="Flask.html#225">Selenium,&#160;205</a></p>
<p style="position:absolute;top:342px;left:386px;white-space:nowrap" class="ft25730">source code profiler,&#160;<a href="Flask.html#233">213</a></p>
<p style="position:absolute;top:358px;left:386px;white-space:nowrap" class="ft25730"><a href="Flask.html#248">syslog,&#160;228</a></p>
<p style="position:absolute;top:392px;left:386px;white-space:nowrap" class="ft25713"><b>T</b></p>
<p style="position:absolute;top:417px;left:386px;white-space:nowrap" class="ft25730">testing,&#160;<a href="Flask.html#212">192</a><a href="Flask.html#217">,&#160;197</a></p>
<p style="position:absolute;top:434px;left:405px;white-space:nowrap" class="ft25730"><a href="Flask.html#103">unit tests,&#160;83</a><a href="Flask.html#112">,&#160;92</a><a href="Flask.html#136">,&#160;116</a></p>
<p style="position:absolute;top:450px;left:405px;white-space:nowrap" class="ft25730">web applica<a href="Flask.html#220">tions,&#160;200</a></p>
<p style="position:absolute;top:466px;left:405px;white-space:nowrap" class="ft25730">web ser<a href="Flask.html#224">vices,&#160;204</a></p>
<p style="position:absolute;top:482px;left:386px;white-space:nowrap" class="ft25730">Twitter Bootstrap<a href="Flask.html#46">,&#160;26</a></p>
<p style="position:absolute;top:516px;left:386px;white-space:nowrap" class="ft25713"><b>U</b></p>
<p style="position:absolute;top:541px;left:386px;white-space:nowrap" class="ft25730">unittest,&#160;<a href="Flask.html#103">83</a></p>
<p style="position:absolute;top:557px;left:386px;white-space:nowrap" class="ft25730">URL fragment,&#160;<a href="Flask.html#188">168</a></p>
<p style="position:absolute;top:573px;left:386px;white-space:nowrap" class="ft25730">user roles,&#160;<a href="Flask.html#131">111</a></p>
<p style="position:absolute;top:590px;left:386px;white-space:nowrap" class="ft25730">uW<a href="Flask.html#241">SGI,&#160;221</a></p>
<p style="position:absolute;top:623px;left:386px;white-space:nowrap" class="ft25713"><b>V</b></p>
<p style="position:absolute;top:648px;left:386px;white-space:nowrap" class="ft25730">virtualenv<a href="Flask.html#24">,&#160;4</a></p>
<p style="position:absolute;top:665px;left:405px;white-space:nowrap" class="ft25730">activa<a href="Flask.html#25">te command,&#160;5</a></p>
<p style="position:absolute;top:681px;left:405px;white-space:nowrap" class="ft25730">deactiva<a href="Flask.html#26">te command,&#160;6</a></p>
<p style="position:absolute;top:715px;left:386px;white-space:nowrap" class="ft25713"><b>W</b></p>
<p style="position:absolute;top:740px;left:386px;white-space:nowrap" class="ft25730">Web Server Gateway Interface (WSGI),&#160;<a href="Flask.html#27">7</a></p>
<p style="position:absolute;top:756px;left:386px;white-space:nowrap" class="ft25730">Werkzeug,&#160;<a href="Flask.html#23">3</a><a href="Flask.html#110">,&#160;90</a><a href="Flask.html#233">,&#160;213,&#160;</a><a href="Flask.html#236">216</a></p>
<p style="position:absolute;top:772px;left:405px;white-space:nowrap" class="ft25730">ProxyFix WSGI middleware,&#160;<a href="Flask.html#245">225</a></p>
<p style="position:absolute;top:919px;left:577px;white-space:nowrap" class="ft2575"><b>Index&#160;&#160;|&#160;&#160;237</b></p>
</div>
<!-- Page 258 -->
<a name="258"></a>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}-->
</style>
<div id="page258-div" style="position:relative;width:756px;height:992px;">
<img width="756" height="992" src="Flask258.png" alt="background image"/>
<p style="position:absolute;top:79px;left:108px;white-space:nowrap" class="ft25852"><b>About the Author<br/></b>Miguel Grinberg has over 25 years of experience as a software engineer. At work, he</p>
<p style="position:absolute;top:132px;left:108px;white-space:nowrap" class="ft25814">leads a team of engineers that develop video software for the broadcast industry. He has</p>
<p style="position:absolute;top:151px;left:108px;white-space:nowrap" class="ft25814">a blog (<i>http://blog.miguelgrinberg.com</i>) where he writes about a variety of topics in‐</p>
<p style="position:absolute;top:170px;left:108px;white-space:nowrap" class="ft25814">cluding web development, robotics, photography, and the occasional movie review. He</p>
<p style="position:absolute;top:189px;left:108px;white-space:nowrap" class="ft25852">lives in Portland, Oregon with his wife, four kids, two dogs, and a cat.<br/><b>Colophon<br/></b>The animal on the cover of&#160;<i>Flask Web Development</i>&#160;is a Pyrenean Mastiff (a breed of</p>
<p style="position:absolute;top:271px;left:108px;white-space:nowrap" class="ft25810"><i>Canis lupus familiaris</i></p>
<p style="position:absolute;top:270px;left:245px;white-space:nowrap" class="ft25814">). These giant Spanish dogs are descended from an ancient live‐</p>
<p style="position:absolute;top:289px;left:108px;white-space:nowrap" class="ft25814">stock guardian dog called the Molossus, which was bred by the Greeks and Romans and</p>
<p style="position:absolute;top:308px;left:108px;white-space:nowrap" class="ft25814">is now extinct. However, this ancestor is known to have played a role in the creation of</p>
<p style="position:absolute;top:327px;left:108px;white-space:nowrap" class="ft25814">many breeds that are common today, such as the Rottweiler, Great Dane, Newfound‐</p>
<p style="position:absolute;top:346px;left:108px;white-space:nowrap" class="ft25814">land, and Cane Corso. Pyrenean Mastiffs have only been recognized as a pure breed</p>
<p style="position:absolute;top:365px;left:108px;white-space:nowrap" class="ft25814">since 1977, and the Pyrenean Mastiff Club of America is working to promote these dogs</p>
<p style="position:absolute;top:384px;left:108px;white-space:nowrap" class="ft25815">as pets in the United States.<br/>After the Spanish Civil War, the population of Pyrenean Mastiffs in their native home‐</p>
<p style="position:absolute;top:430px;left:108px;white-space:nowrap" class="ft25814">land plummeted, and the breed only survived due to the dedicated work of a few scat‐</p>
<p style="position:absolute;top:449px;left:108px;white-space:nowrap" class="ft25814">tered breeders throughout the country. The modern gene pool for Pyreneans stems</p>
<p style="position:absolute;top:468px;left:108px;white-space:nowrap" class="ft25814">from this postwar population, making them prone to genetic diseases like hip dysplasia.</p>
<p style="position:absolute;top:487px;left:108px;white-space:nowrap" class="ft25814">Today, responsible owners make sure their dogs are tested for diseases and x-rayed to</p>
<p style="position:absolute;top:506px;left:108px;white-space:nowrap" class="ft25815">look for hip abnormalities before being bred.<br/>Adult male Pyrenean Mastiffs can reach upwards of 200 pounds when fully grown, so</p>
<p style="position:absolute;top:553px;left:108px;white-space:nowrap" class="ft25814">owning this dog requires a commitment to good training and plenty of outdoors time.</p>
<p style="position:absolute;top:572px;left:108px;white-space:nowrap" class="ft25814">Despite their size and history as hunters of bears and wolves, the Pyrenean has a very</p>
<p style="position:absolute;top:591px;left:108px;white-space:nowrap" class="ft25814">calm temperament and is an excellent family dog. They can be relied upon to take care</p>
<p style="position:absolute;top:610px;left:108px;white-space:nowrap" class="ft25814">of children and protect the home, while at the same time being docile with other dogs.</p>
<p style="position:absolute;top:628px;left:108px;white-space:nowrap" class="ft25814">With proper socialization and strong leadership, Pyrenean Mastiffs thrive in a home</p>
<p style="position:absolute;top:647px;left:108px;white-space:nowrap" class="ft25815">environment and will provide an excellent guardian and companion.<br/>The cover image is from Wood’s&#160;<i>Animate Creation</i>. The cover fonts are URW Typewriter</p>
<p style="position:absolute;top:694px;left:108px;white-space:nowrap" class="ft25814">and Guardian Sans. The text font is Adobe Minion Pro; the heading font is Adobe</p>
<p style="position:absolute;top:713px;left:108px;white-space:nowrap" class="ft25814">Myriad Condensed; and the code font is Dalton Maag’s Ubuntu Mono.</p>
</div>
<a name="outline"></a><h1>Document Outline</h1>
<ul>
<li><a href="Flask.html#4">Copyright</a></li>
<li><a href="Flask.html#7">Table of Contents</a></li>
<li><a href="Flask.html#13">Preface</a>
<ul>
<li><a href="Flask.html#14">Who This Book Is For</a></li>
<li><a href="Flask.html#14">How This Book Is Organized</a></li>
<li><a href="Flask.html#15">How to Work with the Example Code</a></li>
<li><a href="Flask.html#17">Using Code Examples</a></li>
<li><a href="Flask.html#17">Conventions Used in This Book</a></li>
<li><a href="Flask.html#18">Safari® Books Online</a></li>
<li><a href="Flask.html#19">How to Contact Us</a></li>
<li><a href="Flask.html#19">Acknowledgments</a></li>
</ul>
</li>
<li><a href="Flask.html#21">Part I. Introduction to Flask</a>
<ul>
<li><a href="Flask.html#23">Chapter 1. Installation</a>
<ul>
<li><a href="Flask.html#24">Using Virtual Environments</a></li>
<li><a href="Flask.html#26">Installing Python Packages with pip</a></li>
</ul>
</li>
<li><a href="Flask.html#27">Chapter 2. Basic Application Structure</a>
<ul>
<li><a href="Flask.html#27">Initialization</a></li>
<li><a href="Flask.html#28">Routes and View Functions</a></li>
<li><a href="Flask.html#29">Server Startup</a></li>
<li><a href="Flask.html#29">A Complete Application</a></li>
<li><a href="Flask.html#32">The Request-Response Cycle</a>
<ul>
<li><a href="Flask.html#32">Application and Request Contexts</a></li>
<li><a href="Flask.html#34">Request Dispatching</a></li>
<li><a href="Flask.html#34">Request Hooks</a></li>
<li><a href="Flask.html#35">Responses</a></li>
</ul>
</li>
<li><a href="Flask.html#36">Flask Extensions</a>
<ul>
<li><a href="Flask.html#37">Command-Line Options with Flask-Script</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="Flask.html#41">Chapter 3. Templates</a>
<ul>
<li><a href="Flask.html#42">The Jinja2 Template Engine</a>
<ul>
<li><a href="Flask.html#42">Rendering Templates</a></li>
<li><a href="Flask.html#43">Variables</a></li>
<li><a href="Flask.html#44">Control Structures</a></li>
</ul>
</li>
<li><a href="Flask.html#46">Twitter Bootstrap Integration with Flask-Bootstrap</a></li>
<li><a href="Flask.html#49">Custom Error Pages</a></li>
<li><a href="Flask.html#51">Links</a></li>
<li><a href="Flask.html#52">Static Files</a></li>
<li><a href="Flask.html#53">Localization of Dates and Times with Flask-Moment</a></li>
</ul>
</li>
<li><a href="Flask.html#57">Chapter 4. Web Forms</a>
<ul>
<li><a href="Flask.html#57">Cross-Site Request Forgery (CSRF) Protection</a></li>
<li><a href="Flask.html#58">Form Classes</a></li>
<li><a href="Flask.html#60">HTML Rendering of Forms</a></li>
<li><a href="Flask.html#61">Form Handling in View Functions</a></li>
<li><a href="Flask.html#64">Redirects and User Sessions</a></li>
<li><a href="Flask.html#66">Message Flashing</a></li>
</ul>
</li>
<li><a href="Flask.html#69">Chapter 5. Databases</a>
<ul>
<li><a href="Flask.html#69">SQL Databases</a></li>
<li><a href="Flask.html#70">NoSQL Databases</a></li>
<li><a href="Flask.html#71">SQL or NoSQL?</a></li>
<li><a href="Flask.html#71">Python Database Frameworks</a></li>
<li><a href="Flask.html#72">Database Management with Flask-SQLAlchemy</a></li>
<li><a href="Flask.html#74">Model Definition</a></li>
<li><a href="Flask.html#76">Relationships</a></li>
<li><a href="Flask.html#77">Database Operations</a>
<ul>
<li><a href="Flask.html#78">Creating the Tables</a></li>
<li><a href="Flask.html#78">Inserting Rows</a></li>
<li><a href="Flask.html#80">Modifying Rows</a></li>
<li><a href="Flask.html#80">Deleting Rows</a></li>
<li><a href="Flask.html#80">Querying Rows</a></li>
</ul>
</li>
<li><a href="Flask.html#82">Database Use in View Functions</a></li>
<li><a href="Flask.html#83">Integration with the Python Shell</a></li>
<li><a href="Flask.html#84">Database Migrations with Flask-Migrate</a>
<ul>
<li><a href="Flask.html#84">Creating a Migration Repository</a></li>
<li><a href="Flask.html#85">Creating a Migration Script</a></li>
<li><a href="Flask.html#86">Upgrading the Database</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="Flask.html#89">Chapter 6. Email</a>
<ul>
<li><a href="Flask.html#89">Email Support with Flask-Mail</a>
<ul>
<li><a href="Flask.html#90">Sending Email from the Python Shell</a></li>
<li><a href="Flask.html#91">Integrating Emails with the Application</a></li>
<li><a href="Flask.html#92">Sending Asynchronous Email</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="Flask.html#95">Chapter 7. Large Application Structure</a>
<ul>
<li><a href="Flask.html#95">Project Structure</a></li>
<li><a href="Flask.html#96">Configuration Options</a></li>
<li><a href="Flask.html#98">Application Package</a>
<ul>
<li><a href="Flask.html#98">Using an Application Factory</a></li>
<li><a href="Flask.html#99">Implementing Application Functionality in a Blueprint</a></li>
</ul>
</li>
<li><a href="Flask.html#101">Launch Script</a></li>
<li><a href="Flask.html#102">Requirements File</a></li>
<li><a href="Flask.html#103">Unit Tests</a></li>
<li><a href="Flask.html#105">Database Setup</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="Flask.html#107">Part II. Example: A Social Blogging Application</a>
<ul>
<li><a href="Flask.html#109">Chapter 8. User Authentication</a>
<ul>
<li><a href="Flask.html#109">Authentication Extensions for Flask</a></li>
<li><a href="Flask.html#110">Password Security</a>
<ul>
<li><a href="Flask.html#110">Hashing Passwords with Werkzeug</a></li>
</ul>
</li>
<li><a href="Flask.html#112">Creating an Authentication Blueprint</a></li>
<li><a href="Flask.html#114">User Authentication with Flask-Login</a>
<ul>
<li><a href="Flask.html#114">Preparing the User Model for Logins</a></li>
<li><a href="Flask.html#115">Protecting Routes</a></li>
<li><a href="Flask.html#116">Adding a Login Form</a></li>
<li><a href="Flask.html#117">Signing Users In</a></li>
<li><a href="Flask.html#119">Signing Users Out</a></li>
<li><a href="Flask.html#119">Testing Logins</a></li>
</ul>
</li>
<li><a href="Flask.html#120">New User Registration</a>
<ul>
<li><a href="Flask.html#120">Adding a User Registration Form</a></li>
<li><a href="Flask.html#122">Registering New Users</a></li>
</ul>
</li>
<li><a href="Flask.html#123">Account Confirmation</a>
<ul>
<li><a href="Flask.html#123">Generating Confirmation Tokens with itsdangerous</a></li>
<li><a href="Flask.html#125">Sending Confirmation Emails</a></li>
</ul>
</li>
<li><a href="Flask.html#129">Account Management</a></li>
</ul>
</li>
<li><a href="Flask.html#131">Chapter 9. User Roles</a>
<ul>
<li><a href="Flask.html#131">Database Representation of Roles</a></li>
<li><a href="Flask.html#133">Role Assignment</a></li>
<li><a href="Flask.html#134">Role Verification</a></li>
</ul>
</li>
<li><a href="Flask.html#139">Chapter 10. User Profiles</a>
<ul>
<li><a href="Flask.html#139">Profile Information</a></li>
<li><a href="Flask.html#140">User Profile Page</a></li>
<li><a href="Flask.html#142">Profile Editor</a>
<ul>
<li><a href="Flask.html#142">User-Level Profile Editor</a></li>
<li><a href="Flask.html#144">Administrator-Level Profile Editor</a></li>
</ul>
</li>
<li><a href="Flask.html#147">User Avatars</a></li>
</ul>
</li>
<li><a href="Flask.html#151">Chapter 11. Blog Posts</a>
<ul>
<li><a href="Flask.html#151">Blog Post Submission and Display</a></li>
<li><a href="Flask.html#154">Blog Posts on Profile Pages</a></li>
<li><a href="Flask.html#155">Paginating Long Blog Post Lists</a>
<ul>
<li><a href="Flask.html#155">Creating Fake Blog Post Data</a></li>
<li><a href="Flask.html#157">Rendering Data on Pages</a></li>
<li><a href="Flask.html#158">Adding a Pagination Widget</a></li>
</ul>
</li>
<li><a href="Flask.html#161">Rich-Text Posts with Markdown and Flask-PageDown</a>
<ul>
<li><a href="Flask.html#161">Using Flask-PageDown</a></li>
<li><a href="Flask.html#163">Handling Rich Text on the Server</a></li>
</ul>
</li>
<li><a href="Flask.html#165">Permanent Links to Blog Posts</a></li>
<li><a href="Flask.html#166">Blog Post Editor</a></li>
</ul>
</li>
<li><a href="Flask.html#169">Chapter 12. Followers</a>
<ul>
<li><a href="Flask.html#169">Database Relationships Revisited</a>
<ul>
<li><a href="Flask.html#170">Many-to-Many Relationships</a></li>
<li><a href="Flask.html#171">Self-Referential Relationships</a></li>
<li><a href="Flask.html#172">Advanced Many-to-Many Relationships</a></li>
</ul>
</li>
<li><a href="Flask.html#175">Followers on the Profile Page</a></li>
<li><a href="Flask.html#178">Query Followed Posts Using a Database Join</a></li>
<li><a href="Flask.html#180">Show Followed Posts on the Home Page</a></li>
</ul>
</li>
<li><a href="Flask.html#185">Chapter 13. User Comments</a>
<ul>
<li><a href="Flask.html#185">Database Representation of Comments</a></li>
<li><a href="Flask.html#187">Comment Submission and Display</a></li>
<li><a href="Flask.html#189">Comment Moderation</a></li>
</ul>
</li>
<li><a href="Flask.html#195">Chapter 14. Application Programming Interfaces</a>
<ul>
<li><a href="Flask.html#195">Introduction to REST</a>
<ul>
<li><a href="Flask.html#196">Resources Are Everything</a></li>
<li><a href="Flask.html#197">Request Methods</a></li>
<li><a href="Flask.html#197">Request and Response Bodies</a></li>
<li><a href="Flask.html#198">Versioning</a></li>
</ul>
</li>
<li><a href="Flask.html#199">RESTful Web Services with Flask</a>
<ul>
<li><a href="Flask.html#199">Creating an API Blueprint</a></li>
<li><a href="Flask.html#200">Error Handling</a></li>
<li><a href="Flask.html#201">User Authentication with Flask-HTTPAuth</a></li>
<li><a href="Flask.html#204">Token-Based Authentication</a></li>
<li><a href="Flask.html#206">Serializing Resources to and from JSON</a></li>
<li><a href="Flask.html#208">Implementing Resource Endpoints</a></li>
<li><a href="Flask.html#211">Pagination of Large Resource Collections</a></li>
<li><a href="Flask.html#212">Testing Web Services with HTTPie</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="Flask.html#215">Part III. The Last Mile</a>
<ul>
<li><a href="Flask.html#217">Chapter 15. Testing</a>
<ul>
<li><a href="Flask.html#217">Obtaining Code Coverage Reports</a></li>
<li><a href="Flask.html#220">The Flask Test Client</a>
<ul>
<li><a href="Flask.html#220">Testing Web Applications</a></li>
<li><a href="Flask.html#224">Testing Web Services</a></li>
</ul>
</li>
<li><a href="Flask.html#225">End-to-End Testing with Selenium</a></li>
<li><a href="Flask.html#229">Is It Worth It?</a></li>
</ul>
</li>
<li><a href="Flask.html#231">Chapter 16. Performance</a>
<ul>
<li><a href="Flask.html#231">Logging Slow Database Performance</a></li>
<li><a href="Flask.html#233">Source Code Profiling</a></li>
</ul>
</li>
<li><a href="Flask.html#235">Chapter 17. Deployment</a>
<ul>
<li><a href="Flask.html#235">Deployment Workflow</a></li>
<li><a href="Flask.html#236">Logging of Errors During Production</a></li>
<li><a href="Flask.html#237">Cloud Deployment</a></li>
<li><a href="Flask.html#238">The Heroku Platform</a>
<ul>
<li><a href="Flask.html#238">Preparing the Application</a></li>
<li><a href="Flask.html#242">Testing with Foreman</a></li>
<li><a href="Flask.html#243">Enabling Secure HTTP with Flask-SSLify</a></li>
<li><a href="Flask.html#245">Deploying with git push</a></li>
<li><a href="Flask.html#246">Reviewing Logs</a></li>
<li><a href="Flask.html#247">Deploying an Upgrade</a></li>
</ul>
</li>
<li><a href="Flask.html#247">Traditional Hosting</a>
<ul>
<li><a href="Flask.html#247">Server Setup</a></li>
<li><a href="Flask.html#248">Importing Environment Variables</a></li>
<li><a href="Flask.html#248">Setting Up Logging</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="Flask.html#251">Chapter 18. Additional Resources</a>
<ul>
<li><a href="Flask.html#251">Using an Integrated Development Environment (IDE)</a></li>
<li><a href="Flask.html#252">Finding Flask Extensions</a></li>
<li><a href="Flask.html#252">Getting Involved with Flask</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="Flask.html#255">Index</a></li>
<li><a href="Flask.html#258">About the Author</a></li>
</ul>
<hr/>
</body>
</html>
